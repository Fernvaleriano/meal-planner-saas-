<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Meal Planner - Full Featured</title>
    <!-- Prevent caching to avoid stale data on back navigation -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            -webkit-overflow-scrolling: touch !important;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0d9488 0%, #0284c7 100%);
            min-height: 100vh;
            overflow-y: auto !important;
        }

        .app-container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 0.5rem;
        }

        .card {
            background-color: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #0d9488;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #5568d3;
        }

        .btn-secondary {
            background-color: #E3E9F5;
            color: #0d9488;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #D3DBF0;
        }

        .hidden {
            display: none;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }

        .radio-label, .checkbox-label {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="radio"]:checked + .radio-label,
        input[type="checkbox"]:checked + .checkbox-label {
            background-color: #E3E9F5;
            border-color: #0d9488;
        }

        .loader {
            width: 80px;
            height: 80px;
            margin: 2rem auto;
            position: relative;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d9488;
            border-radius: 50%;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .meal-card {
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }

        .day-divider {
            background: linear-gradient(135deg, #0d9488 0%, #0284c7 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            font-size: 1.25rem;
            text-align: center;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .prose h3 { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; }
    </style>
</head>
<body>
<div class="app-container">


    <!-- DIET PLAN VIEW -->
    <div id="diet-plan-view">
        <div class="card">
            <a href="dashboard.html" class="text-blue-600 hover:text-blue-800 mb-6 inline-block">&larr; Back to Dashboard</a>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Full Diet Plan Generator</h2>

            <!-- Unit System Toggle -->
            <div class="flex justify-center items-center gap-3 mb-6 p-3 bg-gray-50 rounded-lg">
                <span class="text-sm font-semibold text-gray-700">Unit System:</span>
                <div class="flex gap-2">
                    <button id="unit-imperial" class="btn btn-primary text-sm py-1 px-3">Imperial (lbs/ft)</button>
                    <button id="unit-metric" class="btn btn-secondary text-sm py-1 px-3">Metric (kg/cm)</button>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Client Selector Section -->
                <div class="p-4 bg-teal-50 border-2 border-teal-400 rounded-lg">
                    <label class="font-bold text-teal-900 block mb-2">üë§ Select Client</label>
                    <div class="grid grid-cols-1 gap-3">
                        <select id="dp_client_selector" class="input-field border-2 border-teal-500" required>
                            <option value="">Loading clients...</option>
                        </select>
                        <div id="new_client_form" class="hidden">
                            <input type="text" id="dp_new_client_name" class="input-field border-2 border-teal-500" placeholder="Enter new client name" required>
                            <input type="hidden" id="dp_selected_client_id">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="dp_age" class="font-semibold text-gray-700">Age</label><input type="number" id="dp_age" class="input-field" placeholder="30" required></div>
                    <div><label for="dp_gender" class="font-semibold text-gray-700">Gender</label><select id="dp_gender" class="input-field"><option value="male">Male</option><option value="female">Female</option></select></div>
                    <div><label for="dp_weight" class="font-semibold text-gray-700">Weight (lbs)</label><input type="number" id="dp_weight" class="input-field" placeholder="155" required></div>
                    <div><label for="dp_height_ft" class="font-semibold text-gray-700">Height (ft)</label><input type="number" id="dp_height_ft" class="input-field" placeholder="5" required></div>
                    <div><label for="dp_height_in" class="font-semibold text-gray-700">Height (in)</label><input type="number" id="dp_height_in" class="input-field" placeholder="10" required></div>
                    <div><label for="dp_activity" class="font-semibold text-gray-700">Activity</label><select id="dp_activity" class="input-field"><option value="1.2">Sedentary</option><option value="1.55" selected>Moderate</option><option value="1.725">Very Active</option></select></div>
                </div>

                <div class="p-4 bg-blue-50 border-2 border-blue-400 rounded-lg">
                    <label class="font-bold text-blue-900 block mb-2">üìÖ Number of Days</label>
                    <select id="dp_days" class="input-field border-2 border-blue-500">
                        <option value="1">1 Day</option>
                        <option value="2">2 Days</option>
                        <option value="3" selected>3 Days</option>
                        <option value="4">4 Days</option>
                        <option value="5">5 Days</option>
                        <option value="6">6 Days</option>
                        <option value="7">7 Days (Full Week)</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="font-semibold text-gray-700">Goal</label><select id="dp_goal" class="input-field"><option value="lose weight">Lose Weight</option><option value="maintain weight" selected>Maintain</option><option value="gain muscle">Gain Muscle</option></select></div>
                    <div><label class="font-semibold text-gray-700">Calorie Adjustment</label><select id="dp_calorie_adjustment" class="input-field"><option value="0" selected>Standard (Recommended)</option><option value="-250">Slightly Aggressive (-250 cals)</option><option value="-500">Aggressive (-500 cals)</option><option value="-750">Most Aggressive (-750 cals)</option><option value="250">Slight Surplus (+250 cals)</option><option value="500">Moderate Surplus (+500 cals)</option></select></div>
                    <div><label class="font-semibold text-gray-700">Diet Type</label><select id="dp_preference" class="input-field"><option value="omnivore" selected>Omnivore</option><option value="vegetarian">Vegetarian</option><option value="vegan">Vegan</option><option value="keto">Keto</option></select></div>
                    <div><label class="font-semibold text-gray-700">Macronutrient Preference</label><select id="dp_macro_preference" class="input-field"><option value="balanced" selected>Balanced (Default)</option><option value="lower-carb">Lower Carb</option><option value="higher-carb">Higher Carb / Lower Fat</option></select></div>
                    <div><label for="dp_allergies" class="font-semibold text-gray-700">Allergies</label><input type="text" id="dp_allergies" class="input-field" placeholder="e.g., dairy, nuts"></div>
                    <div><label for="dp_disliked_foods" class="font-semibold text-gray-700">Disliked Foods</label><input type="text" id="dp_disliked_foods" class="input-field" placeholder="e.g., mushrooms, olives"></div>
                    <div><label for="dp_preferred_foods" class="font-semibold text-gray-700">Preferred Foods or Cuisines</label><input type="text" id="dp_preferred_foods" class="input-field" placeholder="e.g., Italian, Mexican"></div>
                    <div><label for="dp_budget" class="font-semibold text-gray-700">Budget (Optional)</label><input type="text" id="dp_budget" class="input-field" placeholder="e.g., $50/week"></div>
                    <div><label class="font-semibold text-gray-700">Meals Per Day</label><select id="dp_meals" class="input-field"><option value="3 meals">3 Meals</option><option value="3 meals, 1 snack" selected>3 Meals + 1 Snack</option><option value="3 meals, 2 snacks">3 Meals + 2 Snacks</option><option value="3 meals, 3 snacks">3 Meals + 3 Snacks</option></select></div>
                </div>

                <!-- Cooking Equipment -->
                <div class="p-4 bg-teal-50 border-2 border-teal-400 rounded-lg">
                    <label class="font-bold text-teal-900 block mb-2">üç≥ Available Cooking Equipment</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <label class="flex items-center"><input type="checkbox" id="equip_stove" value="Stove" class="mr-2 h-4 w-4" checked> Stove</label>
                        <label class="flex items-center"><input type="checkbox" id="equip_oven" value="Oven" class="mr-2 h-4 w-4" checked> Oven</label>
                        <label class="flex items-center"><input type="checkbox" id="equip_microwave" value="Microwave" class="mr-2 h-4 w-4" checked> Microwave</label>
                        <label class="flex items-center"><input type="checkbox" id="equip_airfryer" value="Air Fryer" class="mr-2 h-4 w-4"> Air Fryer</label>
                        <label class="flex items-center"><input type="checkbox" id="equip_grill" value="Grill" class="mr-2 h-4 w-4"> Grill</label>
                        <label class="flex items-center"><input type="checkbox" id="equip_blender" value="Blender" class="mr-2 h-4 w-4" checked> Blender</label>
                    </div>
                </div>

                <!-- Protein Powder Integration -->
                <div class="p-4 bg-teal-50 border-2 border-teal-400 rounded-lg">
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="dp_use_protein" class="mr-2 h-5 w-5">
                        <label for="dp_use_protein" class="font-bold text-teal-900">Add Protein Powder (Optional)</label>
                    </div>
                    <div id="protein-powder-fields" class="hidden grid grid-cols-2 gap-2 mt-2">
                        <input type="text" id="dp_protein_brand" class="input-field" placeholder="Brand/Name">
                        <input type="number" id="dp_protein_cals" class="input-field" placeholder="Calories">
                        <input type="number" id="dp_protein_protein" class="input-field" placeholder="Protein (g)">
                        <input type="number" id="dp_protein_carbs" class="input-field" placeholder="Carbs (g)">
                        <input type="number" id="dp_protein_fat" class="input-field" placeholder="Fat (g)">
                    </div>
                </div>

                <button data-action="generate-plan" id="generate-plan-btn" class="btn btn-primary w-full text-lg">‚ú® Create Diet Plan</button>
            </div>
        </div>
        <div id="diet-plan-result"></div>
    </div>

    <!-- RECIPE MODAL -->
    <div id="recipe-modal" class="modal-overlay hidden">
        <div class="card w-11/12 md:max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="recipe-title" class="text-2xl font-bold">Recipe</h3>
                <button data-action="close-modal" class="text-2xl font-bold">&times;</button>
            </div>
            <div id="recipe-content" class="text-gray-700 space-y-4 prose"></div>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="share-modal" class="modal-overlay hidden">
        <div class="card w-11/12 md:max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-blue-600">üîó Share Meal Plan</h3>
                <button data-action="close-share-modal" class="text-2xl font-bold">&times;</button>
            </div>
            <p class="text-gray-600 mb-4">Share this link with your client. They'll be able to view, change, and revise meals.</p>
            <div class="bg-blue-50 p-4 rounded-lg mb-4 break-all">
                <div id="share-link-text" class="text-blue-600 font-semibold">Generating link...</div>
            </div>
            <button data-action="copy-share-link" class="btn btn-primary w-full mb-2">üìã Copy Link</button>
            <button data-action="close-share-modal" class="btn btn-secondary w-full">Close</button>
        </div>
    </div>

    <!-- MEAL PREP GUIDE MODAL -->
    <div id="meal-prep-modal" class="modal-overlay hidden">
        <div class="card w-11/12 md:max-w-4xl max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-3xl font-bold text-gray-800">üìã Meal Prep Guide</h3>
                <button data-action="close-meal-prep-modal" class="text-2xl font-bold">&times;</button>
            </div>
            <div id="meal-prep-content" class="text-gray-700 space-y-6">
                <div class="flex items-center justify-center py-12">
                    <div class="loader"><div class="loader-spinner"></div></div>
                    <p class="ml-4 text-gray-600">Generating your comprehensive meal prep guide...</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button data-action="close-meal-prep-modal" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Initialize Supabase client
const SUPABASE_URL = 'https://qewqcjzlfqamqwbccapr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFld3FjanpsZnFhbXF3YmNjYXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2OTg0NzAsImV4cCI6MjA3OTI3NDQ3MH0.mQnMC33O88oLkLLGWD2oG-oaSHGI-NfHmtQCZxnxSLs';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const API_ENDPOINT = '/.netlify/functions/generate-meal-plan';
const SAVE_PLAN_ENDPOINT = '/.netlify/functions/save-shared-plan';
const SAVE_COACH_PLAN_ENDPOINT = '/.netlify/functions/save-coach-plan';
let lastMealQuery = {};
let lastPlanQuery = {};
let currentShareUrl = '';
let currentCoach = null;
let clientsList = [];

// Load clients from database
async function loadClients() {
    try {
        if (!currentCoach) return;

        const response = await fetch(`/.netlify/functions/get-clients?coachId=${currentCoach.id}`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to load clients');
        }

        clientsList = data.clients || [];

        // Populate dropdown
        const clientSelector = document.getElementById('dp_client_selector');
        clientSelector.innerHTML = '<option value="">-- Select a Client --</option>';

        clientsList.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = client.client_name;
            clientSelector.appendChild(option);
        });

        console.log(`‚úÖ Loaded ${clientsList.length} clients`);

        // Check for clientId URL parameter and auto-select
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('clientId');
        if (clientId) {
            clientSelector.value = clientId;
            // Trigger change event to auto-populate fields
            clientSelector.dispatchEvent(new Event('change'));
            console.log(`‚úÖ Auto-selected client from URL: ${clientId}`);
        }

    } catch (error) {
        console.error('Error loading clients:', error);
        const clientSelector = document.getElementById('dp_client_selector');
        clientSelector.innerHTML = '<option value="new">Enter Client Name</option>';
        document.getElementById('new_client_form').classList.remove('hidden');
    }
}

// Handle client selection
document.addEventListener('DOMContentLoaded', () => {
    const clientSelector = document.getElementById('dp_client_selector');
    const newClientForm = document.getElementById('new_client_form');
    const newClientNameInput = document.getElementById('dp_new_client_name');
    const selectedClientIdInput = document.getElementById('dp_selected_client_id');

    clientSelector.addEventListener('change', (e) => {
        const selectedValue = e.target.value;

        if (selectedValue === '') {
            // No selection
            selectedClientIdInput.value = '';
        } else {
            // Client selected
            selectedClientIdInput.value = selectedValue;

            // Find the selected client and auto-populate ALL fields
            const client = clientsList.find(c => c.id === parseInt(selectedValue));
            if (client) {
                console.log('‚úÖ Auto-filling data for client:', client.client_name);

                // Physical stats
                if (client.age) document.getElementById('dp_age').value = client.age;
                if (client.gender) document.getElementById('dp_gender').value = client.gender;
                if (client.weight) document.getElementById('dp_weight').value = client.weight;
                if (client.height_ft) document.getElementById('dp_height_ft').value = client.height_ft;
                if (client.height_in) document.getElementById('dp_height_in').value = client.height_in;
                if (client.activity_level) document.getElementById('dp_activity').value = client.activity_level;

                // Goals & nutrition
                if (client.default_goal) {
                    const goalMap = {
                        'lose_weight': 'lose weight',
                        'maintain': 'maintain weight',
                        'gain_muscle': 'gain muscle'
                    };
                    const goalValue = goalMap[client.default_goal];
                    if (goalValue) document.getElementById('dp_goal').value = goalValue;
                }

                if (client.calorie_adjustment) document.getElementById('dp_calorie_adjustment').value = client.calorie_adjustment;
                if (client.diet_type) document.getElementById('dp_preference').value = client.diet_type;
                if (client.macro_preference) document.getElementById('dp_macro_preference').value = client.macro_preference;
                if (client.meal_count) document.getElementById('dp_meals').value = client.meal_count;

                // Food preferences
                if (client.allergies) document.getElementById('dp_allergies').value = client.allergies;
                if (client.disliked_foods) document.getElementById('dp_disliked_foods').value = client.disliked_foods;
                if (client.preferred_foods) document.getElementById('dp_preferred_foods').value = client.preferred_foods;
                if (client.budget) document.getElementById('dp_budget').value = client.budget;

                // Cooking equipment
                if (client.cooking_equipment && Array.isArray(client.cooking_equipment)) {
                    // Uncheck all first
                    document.querySelectorAll('input[id^="equip_"]').forEach(cb => cb.checked = false);
                    // Check the ones from client profile
                    client.cooking_equipment.forEach(equip => {
                        const equipId = 'equip_' + equip.toLowerCase().replace(/\s+/g, '');
                        const checkbox = document.getElementById(equipId);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                // Protein powder
                if (client.use_protein_powder) {
                    document.getElementById('dp_use_protein').checked = true;
                    document.getElementById('protein-powder-fields').style.display = 'grid';
                    if (client.protein_powder_brand) document.getElementById('dp_protein_brand').value = client.protein_powder_brand;
                    if (client.protein_powder_calories) document.getElementById('dp_protein_cals').value = client.protein_powder_calories;
                    if (client.protein_powder_protein) document.getElementById('dp_protein_protein').value = client.protein_powder_protein;
                    if (client.protein_powder_carbs) document.getElementById('dp_protein_carbs').value = client.protein_powder_carbs;
                    if (client.protein_powder_fat) document.getElementById('dp_protein_fat').value = client.protein_powder_fat;
                } else {
                    document.getElementById('dp_use_protein').checked = false;
                    document.getElementById('protein-powder-fields').style.display = 'none';
                }

                console.log('‚úÖ All fields auto-populated from client profile');
            }
        }
    });
});

// Listen for auth state changes to handle session expiration
supabaseClient.auth.onAuthStateChange((event, session) => {
    console.log('Auth state changed:', event, session ? 'Session exists' : 'No session');

    if (event === 'SIGNED_OUT') {
        console.log('User signed out, clearing current coach');
        currentCoach = null;
    } else if (event === 'TOKEN_REFRESHED' && currentCoach) {
        console.log('Token refreshed for existing coach');
        // Reload clients if we have a coach
        loadClients();
    }
});

// Detect if page was loaded from back/forward cache and force reload
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        // Page was loaded from bfcache (back/forward cache)
        console.log('Page loaded from cache, forcing reload...');
        window.location.reload();
    }
});

// Check authentication on page load
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Try to refresh the session to get a fresh token
        const { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();

        let session = null;

        // If refresh succeeded and we have a valid session with access token, use it
        if (!refreshError && refreshData?.session?.access_token) {
            session = refreshData.session;
            console.log('Session refreshed successfully');
        } else {
            // If refresh failed, session is likely expired
            console.warn('Session refresh failed or returned invalid session:', refreshError);
            session = null;
        }

        if (session) {
            currentCoach = session.user;
            console.log("Coach logged in:", currentCoach.email);

            // Load clients for the dropdown
            await loadClients();
        } else {
            console.warn("No active session - plans will not be saved to history");
            // If no session, just show a simple text input
            const clientSelector = document.getElementById('dp_client_selector');
            clientSelector.innerHTML = '<option value="new">Enter Client Name</option>';
            document.getElementById('new_client_form').classList.remove('hidden');
        }
    } catch (error) {
        console.error("Auth error:", error);
        currentCoach = null;
    }
});

// DIRECT NETLIFY FUNCTION CALL (replaces Velo callGemini)
async function callGemini(prompt, isJson = true) {
    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
        });

        if (!response.ok) {
            throw new Error('API request failed');
        }

        const data = await response.json();
        let text = data.candidates[0].content.parts[0].text;

        // Clean response - remove markdown code blocks
        text = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
        text = text.replace(/:\s*NaN/g, ': null');
        text = text.replace(/,\s*\.\.\./g, '');

        if (isJson) {
            // Extract JSON array or object
            const jsonMatch = text.match(/[\[{][\s\S]*[\]}]/);
            if (jsonMatch) text = jsonMatch[0];

            // Try to parse - if it fails, try to fix common issues
            try {
                return JSON.parse(text);
            } catch (parseError) {
                console.warn('First parse failed, attempting to fix JSON:', parseError.message);

                // Try to fix unescaped quotes in string values
                // This is a simple fix - replace quotes inside string values
                text = text.replace(/"instructions":\s*"([^"]*(?:"[^"]*)*)"}/g, (match, content) => {
                    const fixed = content.replace(/"/g, "'");
                    return `"instructions": "${fixed}"}`;
                });

                // Remove trailing commas
                text = text.replace(/,(\s*[}\]])/g, '$1');

                try {
                    return JSON.parse(text);
                } catch (secondError) {
                    console.error('JSON Parse Error:', secondError.message);
                    console.error('Attempted to parse:', text.substring(0, 500));
                    throw new Error('Invalid JSON from AI: ' + secondError.message);
                }
            }
        }
        return text;
    } catch (error) {
        console.error('AI Error:', error);
        return { error: error.message };
    }
}

// MEAL VALIDATION FUNCTION
function validateMeal(meal, mealType) {
    const issues = [];

    // Validation 1: Macro math check - TIGHTENED to 5%
    const calculatedCalories = (meal.protein * 4) + (meal.carbs * 4) + (meal.fat * 9);
    const calorieDifference = Math.abs(meal.calories - calculatedCalories);
    const percentOff = calorieDifference / meal.calories;

    if (percentOff > 0.05) { // More than 5% off - MUCH STRICTER
        issues.push(`Macro math error: ${meal.calories} cal listed but macros calculate to ${Math.round(calculatedCalories)} cal (${Math.round(percentOff*100)}% error)`);
    }

    // Validation 2: Reasonable calorie ranges by meal type
    const reasonableRanges = {
        'breakfast': { min: 250, max: 700 },
        'lunch': { min: 350, max: 800 },
        'dinner': { min: 350, max: 900 },
        'snack': { min: 50, max: 400 }
    };

    const range = reasonableRanges[mealType] || reasonableRanges['snack'];
    if (meal.calories < range.min || meal.calories > range.max) {
        issues.push(`${mealType} calories (${meal.calories}) outside reasonable range ${range.min}-${range.max}`);
    }

    // Validation 3: Protein shake specific check
    const isShake = meal.name.toLowerCase().includes('shake') ||
                   meal.name.toLowerCase().includes('protein powder') ||
                   meal.name.toLowerCase().includes('smoothie');
    if (isShake && meal.calories > 450) {
        issues.push(`Protein shake/smoothie too high: ${meal.calories} cal (should be under 450)`);
    }

    // Validation 4: Sanity check on macros
    if (meal.protein < 0 || meal.carbs < 0 || meal.fat < 0) {
        issues.push('Negative macro values detected');
    }

    if (meal.protein > 100 || meal.carbs > 150 || meal.fat > 80) {
        issues.push('Unrealistically high macro values in single meal');
    }

    // Validation 5: Maximum meal size check
    const maxCaloriesByType = {
        'breakfast': 750,
        'lunch': 750,
        'dinner': 800,
        'snack': 400
    };
    const maxCals = maxCaloriesByType[mealType] || 750;
    if (meal.calories > maxCals) {
        issues.push(`${mealType} too high: ${meal.calories} cal (max ${maxCals} cal per serving)`);
    }

    // Validation 6: Realistic portion sizes for common high-calorie foods
    const mealNameLower = meal.name.toLowerCase();
    const calorieFloorChecks = [
        { keywords: ['burrito', 'wrap with'], minCal: 400, name: 'Burrito/Large wrap' },
        { keywords: ['pizza', 'slice'], minCal: 250, name: 'Pizza' },
        { keywords: ['burger', 'cheeseburger'], minCal: 400, name: 'Burger' },
        { keywords: ['pasta', 'spaghetti', 'fettuccine', 'penne'], minCal: 350, name: 'Pasta dish' },
        { keywords: ['fried'], minCal: 300, name: 'Fried food' },
        { keywords: ['quesadilla'], minCal: 400, name: 'Quesadilla' },
        { keywords: ['sandwich with'], minCal: 350, name: 'Large sandwich' },
        { keywords: ['steak', 'ribeye', 'sirloin'], minCal: 300, name: 'Steak meal' },
        { keywords: ['bacon'], minCal: 200, name: 'Meal with bacon' }
    ];

    for (const check of calorieFloorChecks) {
        if (check.keywords.some(kw => mealNameLower.includes(kw))) {
            if (meal.calories < check.minCal) {
                issues.push(`${check.name} is unrealistically low: ${meal.calories} cal (minimum ${check.minCal} cal expected)`);
            }
        }
    }

    return {
        valid: issues.length === 0,
        issues: issues,
        meal: meal
    };
}

// VALIDATE ENTIRE DAY'S TOTALS
function validateDayTotals(dayData) {
    const targets = dayData.targets;
    const plan = dayData.plan;

    // Calculate actual totals
    const actualCals = plan.reduce((sum, meal) => sum + meal.calories, 0);
    const actualProtein = plan.reduce((sum, meal) => sum + meal.protein, 0);
    const actualCarbs = plan.reduce((sum, meal) => sum + meal.carbs, 0);
    const actualFat = plan.reduce((sum, meal) => sum + meal.fat, 0);

    const issues = [];

    // Check if totals are within 10% of targets
    const calDiff = Math.abs(actualCals - targets.calories) / targets.calories;
    const proteinDiff = Math.abs(actualProtein - targets.protein) / targets.protein;
    const carbsDiff = Math.abs(actualCarbs - targets.carbs) / targets.carbs;
    const fatDiff = Math.abs(actualFat - targets.fat) / targets.fat;

    if (calDiff > 0.10) {
        issues.push(`Daily calories off by ${Math.round(calDiff * 100)}%: ${actualCals} vs target ${targets.calories}`);
    }
    if (proteinDiff > 0.15) {
        issues.push(`Daily protein off by ${Math.round(proteinDiff * 100)}%: ${actualProtein}g vs target ${targets.protein}g`);
    }
    if (carbsDiff > 0.15) {
        issues.push(`Daily carbs off by ${Math.round(carbsDiff * 100)}%: ${actualCarbs}g vs target ${targets.carbs}g`);
    }
    if (fatDiff > 0.15) {
        issues.push(`Daily fat off by ${Math.round(fatDiff * 100)}%: ${actualFat}g vs target ${targets.fat}g`);
    }

    return {
        valid: issues.length === 0,
        issues: issues,
        totals: { calories: actualCals, protein: actualProtein, carbs: actualCarbs, fat: actualFat }
    };
}

// MULTI-DAY DIET PLAN GENERATOR
async function generateDietPlan() {
    const resultDiv = document.getElementById('diet-plan-result');
    const button = document.getElementById('generate-plan-btn');

    const age = document.getElementById('dp_age').value;
    const weight = document.getElementById('dp_weight').value;
    const heightFt = document.getElementById('dp_height_ft').value;
    const heightIn = document.getElementById('dp_height_in').value;

    if (!age || !weight || !heightFt) {
        alert('Please fill in all required fields');
        return;
    }

    resultDiv.innerHTML = '<div class="card"><div class="loader"><div class="loader-spinner"></div></div><p class="text-center text-gray-600">Creating your diet plan...</p></div>';
    button.disabled = true;

    // Get client from selector
    let clientName = 'Client';
    let clientId = null;
    const clientSelector = document.getElementById('dp_client_selector');
    const selectedValue = clientSelector.value;

    if (!selectedValue || selectedValue === "") {
        // No client selected
        alert('‚ö†Ô∏è Please select a client from the dropdown before generating a plan.');
        button.disabled = false;
        resultDiv.innerHTML = '';
        return;
    }

    // Parse and validate client ID
    clientId = parseInt(selectedValue);
    if (isNaN(clientId) || clientId <= 0) {
        alert('‚ö†Ô∏è Invalid client selection. Please select a valid client from the dropdown.');
        button.disabled = false;
        resultDiv.innerHTML = '';
        return;
    }

    // Ensure client exists in the list
    const client = clientsList.find(c => c.id === clientId);
    if (!client) {
        alert('‚ö†Ô∏è Selected client not found. Please refresh the page and try again.');
        button.disabled = false;
        resultDiv.innerHTML = '';
        return;
    }

    clientName = client.client_name;

    const gender = document.getElementById('dp_gender').value;
    const activity = parseFloat(document.getElementById('dp_activity').value);
    const goal = document.getElementById('dp_goal').value;
    const calorieAdjustment = parseInt(document.getElementById('dp_calorie_adjustment').value);
    const preference = document.getElementById('dp_preference').value;
    const macroPreference = document.getElementById('dp_macro_preference').value;
    const allergies = document.getElementById('dp_allergies').value || 'none';
    const dislikedFoods = document.getElementById('dp_disliked_foods').value || 'none';
    const preferredFoods = document.getElementById('dp_preferred_foods').value || 'none';
    const budget = document.getElementById('dp_budget').value || 'none';
    const meals = document.getElementById('dp_meals').value;
    const numDays = parseInt(document.getElementById('dp_days').value);

    // Get cooking equipment
    const equipment = [];
    if (document.getElementById('equip_stove').checked) equipment.push('Stove');
    if (document.getElementById('equip_oven').checked) equipment.push('Oven');
    if (document.getElementById('equip_microwave').checked) equipment.push('Microwave');
    if (document.getElementById('equip_airfryer').checked) equipment.push('Air Fryer');
    if (document.getElementById('equip_grill').checked) equipment.push('Grill');
    if (document.getElementById('equip_blender').checked) equipment.push('Blender');
    const equipmentStr = equipment.length > 0 ? equipment.join(', ') : 'basic kitchen tools';

    // Calculate nutrition (Mifflin-St Jeor)
    let weightKg, heightCm;
    if (currentUnitSystem === 'imperial') {
        weightKg = parseFloat(weight) * 0.453592;
        heightCm = (parseInt(heightFt) * 30.48) + (parseInt(heightIn || 0) * 2.54);
    } else {
        weightKg = parseFloat(weight);
        heightCm = parseFloat(heightFt);
    }

    let bmr;
    if (gender === 'male') {
        bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * parseInt(age)) + 5;
    } else {
        bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * parseInt(age)) - 161;
    }

    let tdee = bmr * activity;
    if (goal === 'lose weight') tdee -= 500;
    if (goal === 'gain muscle') tdee += 300;

    // Apply calorie adjustment
    tdee += calorieAdjustment;

    let calories = Math.round(tdee);

    // Calculate macros based on macro preference
    let proteinRatio, carbRatio, fatRatio;
    if (macroPreference === 'lower-carb') {
        proteinRatio = 0.35;
        carbRatio = 0.25;
        fatRatio = 0.40;
    } else if (macroPreference === 'higher-carb') {
        proteinRatio = 0.25;
        carbRatio = 0.50;
        fatRatio = 0.25;
    } else { // balanced
        proteinRatio = 0.30;
        carbRatio = 0.40;
        fatRatio = 0.30;
    }

    let protein = Math.round((calories * proteinRatio) / 4);
    let carbs = Math.round((calories * carbRatio) / 4);
    let fat = Math.round((calories * fatRatio) / 9);

    // Add protein powder if selected
    let proteinPowderNote = '';
    if (document.getElementById('dp_use_protein').checked) {
        const proteinCals = parseInt(document.getElementById('dp_protein_cals').value) || 0;
        const proteinProtein = parseInt(document.getElementById('dp_protein_protein').value) || 0;
        const proteinCarbs = parseInt(document.getElementById('dp_protein_carbs').value) || 0;
        const proteinFat = parseInt(document.getElementById('dp_protein_fat').value) || 0;
        const proteinBrand = document.getElementById('dp_protein_brand').value || 'Protein Powder';

        calories -= proteinCals;
        protein -= proteinProtein;
        carbs -= proteinCarbs;
        fat -= proteinFat;

        proteinPowderNote = `\n\nIMPORTANT: Client uses ${proteinBrand} (${proteinCals} cal, ${proteinProtein}g protein, ${proteinCarbs}g carbs, ${proteinFat}g fat). This is ALREADY included in daily totals, so DO NOT add extra protein shakes to the plan.`;
    }

    lastPlanQuery = {
        clientName,
        clientId,
        calories: Math.round(tdee),
        protein,
        carbs,
        fat,
        preference,
        macroPreference,
        allergies,
        dislikedFoods,
        preferredFoods,
        budget,
        equipmentStr,
        meals,
        proteinPowderNote
    };

    // Generate each day separately
    const allDays = [];
    for (let day = 1; day <= numDays; day++) {
        // Build a list of previously used meals to ensure variety
        let previousMealsText = '';
        if (allDays.length > 0) {
            const previousMeals = [];
            allDays.forEach(dayData => {
                dayData.plan.forEach(meal => {
                    previousMeals.push(meal.name);
                });
            });
            previousMealsText = `\n\nPREVIOUS DAYS MEALS (DO NOT REPEAT):\n${previousMeals.join('\n')}\n\nIMPORTANT: Create COMPLETELY DIFFERENT meals from the previous days listed above. Provide variety in proteins, cuisines, and cooking methods.`;
        }

        // Parse meal structure to be explicit
        let mealStructure = '';
        let expectedMealTypes = [];

        if (meals === '3 meals') {
            mealStructure = 'EXACTLY 3 meals: breakfast, lunch, dinner';
            expectedMealTypes = ['breakfast', 'lunch', 'dinner'];
        } else if (meals === '3 meals, 1 snack') {
            mealStructure = 'EXACTLY 4 items: breakfast, lunch, dinner, and 1 snack';
            expectedMealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
        } else if (meals === '3 meals, 2 snacks') {
            mealStructure = 'EXACTLY 5 items: breakfast, lunch, dinner, and 2 snacks';
            expectedMealTypes = ['breakfast', 'lunch', 'dinner', 'snack', 'snack'];
        } else if (meals === '3 meals, 3 snacks') {
            mealStructure = 'EXACTLY 6 items: breakfast, lunch, dinner, and 3 snacks';
            expectedMealTypes = ['breakfast', 'lunch', 'dinner', 'snack', 'snack', 'snack'];
        } else {
            // Default fallback if meals value is invalid
            console.warn(`Invalid meals value: "${meals}". Defaulting to 3 meals + 1 snack`);
            mealStructure = 'EXACTLY 4 items: breakfast, lunch, dinner, and 1 snack';
            expectedMealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
        }

        const dayPrompt = `Create 1-day meal plan for Day ${day} of ${numDays}.
Stats: ${age}yo ${gender}, ${weightKg.toFixed(0)}kg, ${heightCm.toFixed(0)}cm
Goal: ${goal}, Diet: ${preference}
Macro Preference: ${macroPreference}
Avoid: ${allergies}
Disliked Foods: ${dislikedFoods}
Preferred Foods/Cuisines: ${preferredFoods}
Budget: ${budget}
Available Equipment: ${equipmentStr}${proteinPowderNote}${previousMealsText}

Daily targets: ${calories} cal, ${protein}g protein, ${carbs}g carbs, ${fat}g fat

CRITICAL VARIETY REQUIREMENT:
Create UNIQUE and CREATIVE meals. DO NOT default to common patterns like eggs/toast/avocado.
Vary your meal choices across:
- Different protein sources (chicken, beef, fish, turkey, tofu, eggs, legumes)
- Different cuisines (Italian, Mexican, Asian, Mediterranean, American)
- Different cooking styles (grilled, baked, stir-fried, slow-cooked)
- Different carb sources (rice, pasta, quinoa, sweet potato, bread, oats)
Think creatively and provide interesting variety!

CRITICAL MEAL STRUCTURE:
Generate ${mealStructure}. DO NOT generate more or fewer items.
${expectedMealTypes.length === 4 ? 'The array should have EXACTLY 4 objects.' : ''}
${expectedMealTypes.length === 5 ? 'The array should have EXACTLY 5 objects.' : ''}
${expectedMealTypes.length === 6 ? 'The array should have EXACTLY 6 objects.' : ''}

CRITICAL CALORIE ACCURACY RULES:
- VERIFY macro math: (protein grams √ó 4) + (carbs grams √ó 4) + (fat grams √ó 9) MUST equal total calories EXACTLY (¬±5%)
- Maximum calories per meal: Breakfast/Lunch=750cal, Dinner=800cal, Snack=400cal
- Use REALISTIC portion sizes based on actual food database values
- Common food MINIMUM calories (DO NOT go below these):
  * Burrito with protein/cheese/toppings = 400-800 cal
  * Burger with bun and toppings = 400-700 cal
  * Pizza (2 slices) = 500-600 cal
  * Pasta dish with sauce/protein = 350-600 cal
  * Quesadilla with cheese/protein = 400-600 cal
  * Sandwich with multiple ingredients = 350-500 cal
  * Steak (6-8oz) with sides = 500-700 cal
- ACCURATE PROTEIN PORTIONS:
  * 4oz chicken breast = 185 cal, 35g protein
  * 4oz ground beef (90% lean) = 200 cal, 24g protein, 11g fat
  * 6oz salmon = 280 cal, 34g protein, 17g fat
  * 3 large eggs = 210 cal, 18g protein, 15g fat
- ACCURATE CARB PORTIONS:
  * 1 cup cooked rice = 200 cal, 45g carbs
  * 1 cup cooked pasta = 220 cal, 43g carbs
  * 1 medium sweet potato = 115 cal, 27g carbs
  * 2 slices whole wheat bread = 160 cal, 28g carbs
- Protein shake = 120-250 calories MAX (1 scoop protein + liquid)
- Snacks = 100-400 calories
- BE CONSERVATIVE: When in doubt, estimate HIGHER not lower
- DAILY TOTALS MUST HIT TARGETS: Your meals must add up to the daily targets within 10%

CRITICAL NAMING RULES:
- Name meals with SPECIFIC QUANTITIES and ingredients (e.g., "6oz sirloin steak, 1 cup brown rice, 100g roasted vegetables")
- DO NOT use generic names like "Steak with Roasted Vegetables"
- NEVER use adjectives like "hearty", "delicious", "tasty", "nutritious" in meal names
- Be direct and specific with measurements

IMPORTANT: Only use recipes that can be made with the available equipment.
Consider the budget constraint and preferred foods when planning meals.
${day > 1 ? 'ENSURE VARIETY: This is Day ' + day + ', so make sure meals are different from previous days.' : ''}

CRITICAL: Return ONLY valid JSON with NO special characters, NO quotes in text, NO newlines in strings.
Use only alphanumeric characters and basic punctuation (periods, commas) in text fields.
Replace all quotes with apostrophes. Keep instructions simple and brief.
Include detailed ingredients list and full cooking instructions.

EXAMPLE (use this as reference for accuracy):
{"day":${day},"targets":{"calories":${calories},"protein":${protein},"carbs":${carbs},"fat":${fat}},"plan":[{"type":"breakfast","name":"3 large eggs scrambled, 2 slices whole wheat toast, 1/2 medium avocado","calories":470,"protein":23,"carbs":32,"fat":28,"ingredients":["3 large eggs","2 slices whole wheat bread","1 tbsp butter for cooking","1/2 avocado"],"instructions":"Scramble 3 eggs in 1 tbsp butter. Toast bread. Serve with sliced avocado."}]}

CALCULATION CHECK: (23√ó4) + (32√ó4) + (28√ó9) = 92 + 128 + 252 = 472 ‚âà 470 ‚úì`;

        const dayData = await callGemini(dayPrompt, true);
        if (dayData.error) {
            resultDiv.innerHTML = `<div class="card text-red-600">Error generating Day ${day}: ${dayData.error}</div>`;
            button.disabled = false;
            return;
        }

        // Validate meal count
        if (dayData.plan && Array.isArray(dayData.plan)) {
            if (dayData.plan.length !== expectedMealTypes.length) {
                console.warn(`‚ö†Ô∏è Wrong meal count: Got ${dayData.plan.length} meals but expected ${expectedMealTypes.length}`);
                // Trim or pad the plan to match expected count
                if (dayData.plan.length > expectedMealTypes.length) {
                    console.log('Trimming excess meals...');
                    dayData.plan = dayData.plan.slice(0, expectedMealTypes.length);
                }
            }
        }

        // Validate each meal and regenerate if needed
        if (dayData.plan && Array.isArray(dayData.plan)) {
            for (let mealIndex = 0; mealIndex < dayData.plan.length; mealIndex++) {
                const meal = dayData.plan[mealIndex];
                const validation = validateMeal(meal, meal.type);

                if (!validation.valid) {
                    console.warn(`‚ö†Ô∏è Validation failed for ${meal.type} on Day ${day}:`, validation.issues);
                    console.log('üîÑ Regenerating meal...');

                    // Regenerate this specific meal (max 2 attempts)
                    let retryCount = 0;
                    let validMeal = null;

                    while (retryCount < 2 && !validMeal) {
                        const regeneratePrompt = `Generate a single ${meal.type} meal.
Diet: ${preference}
Avoid: ${allergies}
Target: ${meal.calories} calories (but be ACCURATE with portions)
Target macros: ${meal.protein}g protein, ${meal.carbs}g carbs, ${meal.fat}g fat

CRITICAL CALORIE ACCURACY:
- VERIFY: (protein √ó 4) + (carbs √ó 4) + (fat √ó 9) = total calories EXACTLY (¬±5%)
- Maximum: ${meal.type === 'snack' ? '400 cal' : meal.type === 'dinner' ? '800 cal' : '750 cal'}
- Use realistic portion sizes: 4oz chicken=185cal/35gP, 1cup rice=200cal/45gC
- ${meal.type === 'snack' ? 'Snacks should be 100-400 calories' : 'Meals should be 400-700 calories'}
- Common foods: Burrito=400-800cal, Burger=400-700cal, Pasta=350-600cal
- BE CONSERVATIVE: When in doubt, estimate HIGHER not lower
- Double-check your math and portions!

Return ONLY valid JSON. Example with ACCURATE macros:
{"type":"${meal.type}","name":"4oz grilled chicken breast, 1 cup brown rice, 100g steamed broccoli","calories":430,"protein":40,"carbs":50,"fat":6,"ingredients":["4oz chicken breast","1 cup brown rice","100g broccoli","cooking spray"],"instructions":"Grill chicken with cooking spray. Cook rice. Steam broccoli."}

MATH CHECK: (40√ó4) + (50√ó4) + (6√ó9) = 160 + 200 + 54 = 414 ‚âà 430 ‚úì`;

                        const newMeal = await callGemini(regeneratePrompt, true);
                        if (!newMeal.error) {
                            const newValidation = validateMeal(newMeal, meal.type);
                            if (newValidation.valid) {
                                validMeal = newMeal;
                                console.log('‚úÖ Regenerated meal passed validation');
                            } else {
                                console.warn(`Retry ${retryCount + 1} still has issues:`, newValidation.issues);
                            }
                        }
                        retryCount++;
                    }

                    // Use regenerated meal if valid, otherwise keep original
                    if (validMeal) {
                        dayData.plan[mealIndex] = validMeal;
                    } else {
                        console.warn('‚ö†Ô∏è Could not generate valid meal after retries, keeping original');
                    }
                }
            }
        }

        // Validate day's total macros against targets
        const dayValidation = validateDayTotals(dayData);
        if (!dayValidation.valid) {
            console.warn(`‚ö†Ô∏è Day ${day} totals don't match targets:`, dayValidation.issues);
            console.log(`Actual totals: ${dayValidation.totals.calories} cal, ${dayValidation.totals.protein}g protein, ${dayValidation.totals.carbs}g carbs, ${dayValidation.totals.fat}g fat`);
        } else {
            console.log(`‚úÖ Day ${day} totals validated successfully`);
        }

        allDays.push(dayData);
    }

    lastPlanQuery.currentPlan = allDays;
    displayDietPlan(allDays);

    // Save plan to coach's history
    saveCoachPlan(lastPlanQuery, lastPlanQuery.clientName);

    button.disabled = false;
}

function displayDietPlan(multiDayData) {
    const resultDiv = document.getElementById('diet-plan-result');
    const targets = multiDayData[0].targets;

    let planHTML = `
        <div class="card">
            <h3 class="text-xl font-bold mb-4">Your ${multiDayData.length}-Day Plan</h3>
            <div class="grid grid-cols-4 gap-2 p-4 bg-blue-50 rounded-lg mb-4">
                <div class="text-center"><p class="text-sm text-gray-600">Calories</p><span class="font-bold text-blue-600">${targets.calories}</span></div>
                <div class="text-center"><p class="text-sm text-gray-600">Protein</p><span class="font-bold text-blue-600">${targets.protein}g</span></div>
                <div class="text-center"><p class="text-sm text-gray-600">Carbs</p><span class="font-bold text-blue-600">${targets.carbs}g</span></div>
                <div class="text-center"><p class="text-sm text-gray-600">Fat</p><span class="font-bold text-blue-600">${targets.fat}g</span></div>
            </div>
    `;

    multiDayData.forEach((dayData, dayIndex) => {
        planHTML += `<div class="day-divider">Day ${dayData.day}</div>`;
        dayData.plan.forEach((meal, mealIndex) => {
            planHTML += `
                <div class="meal-card">
                    <h4 class="font-bold text-lg capitalize">${meal.type}</h4>
                    <p class="text-blue-700">${meal.name}</p>
                    <div class="grid grid-cols-4 gap-1 text-xs text-gray-600 my-2">
                        <span>${meal.calories} cal</span>
                        <span>${meal.protein}g P</span>
                        <span>${meal.carbs}g C</span>
                        <span>${meal.fat}g F</span>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button data-action="change-meal" data-day-index="${dayIndex}" data-meal-index="${mealIndex}" class="btn btn-secondary text-xs flex-1">üîÑ Change</button>
                        <button data-action="revise-meal" data-day-index="${dayIndex}" data-meal-index="${mealIndex}" class="btn btn-secondary text-xs flex-1">‚úèÔ∏è Revise</button>
                        <button data-action="get-recipe" data-meal-name="${meal.name}" class="btn btn-secondary text-xs flex-1">üìñ Recipe</button>
                    </div>
                </div>`;
        });
    });

    planHTML += `
        <div class="flex gap-2 mt-4">
            <button data-action="show-meal-prep-guide" class="btn btn-primary w-full" style="background:#ff6b6b;">üìã Meal Prep Guide</button>
            <button data-action="show-grocery-list" class="btn btn-secondary w-full">üìù Grocery List</button>
            <button data-action="download-pdf" class="btn btn-primary w-full">üì• Download PDF</button>
            <button data-action="share-plan" class="btn btn-primary w-full" style="background:#28a745;">üîó Share Plan Link</button>
        </div>
    </div>`;
    resultDiv.innerHTML = planHTML;
}

// SAVE COACH PLAN TO DATABASE
async function saveCoachPlan(planData, clientName) {
    if (!currentCoach) {
        console.warn('No coach session - plan not saved to history');
        return;
    }

    // Validate that clientId exists and is valid
    if (!planData.clientId || isNaN(planData.clientId) || planData.clientId <= 0) {
        console.error('‚ùå Cannot save plan: Invalid or missing clientId', planData.clientId);
        alert('‚ö†Ô∏è Error: Cannot save plan without a valid client selection. Please select a client and try again.');
        return;
    }

    try {
        console.log('Saving plan to coach history...');

        const payload = {
            coachId: currentCoach.id,
            clientName: clientName,
            planData: planData,
            clientId: planData.clientId  // Always include clientId (validated above)
        };

        const response = await fetch(SAVE_COACH_PLAN_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error('Failed to save plan');
        }

        const data = await response.json();
        console.log('Plan saved to history with ID:', data.planId);

        // Store the planId in lastPlanQuery so it can be used when sharing
        if (lastPlanQuery) {
            lastPlanQuery.planId = data.planId;
            console.log('‚úÖ Plan ID stored for sharing:', data.planId);
        }

        return data.planId; // Return the planId in case caller needs it

    } catch (error) {
        console.error('Error saving plan:', error);
        // Don't show error to user - saving to history is not critical
    }
}

// RECIPE GENERATOR
async function getAIRecipe(mealName) {
    const modal = document.getElementById('recipe-modal');
    const content = document.getElementById('recipe-content');

    document.getElementById('recipe-title').innerText = mealName;
    modal.classList.remove('hidden');
    content.innerHTML = '<div class="loader"><div class="loader-spinner"></div></div>';

    const prompt = `Recipe for "${mealName}". Use markdown with ### Ingredients and ### Instructions headings.`;
    const recipe = await callGemini(prompt, false);

    if (recipe.error) {
        content.innerHTML = `<p class="text-red-500">${recipe.error}</p>`;
    } else {
        let html = recipe
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^\* (.*$)/gim, '<li>$1</li>')
            .replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>')
            .replace(/<\/li>\n<li>/g, '</li><li>');

        html = html.replace(/(<li>.*<\/li>)/gs, (match) => {
            if(match.toLowerCase().includes('ingredient')) return `<ul>${match}</ul>`;
            return `<ol>${match}</ol>`;
        });

        content.innerHTML = html;
    }
}

// CHANGE MEAL - Generate a completely different meal
async function changeMeal(dayIndex, mealIndex) {
    const meal = lastPlanQuery.currentPlan[dayIndex].plan[mealIndex];

    // Show loading
    displayDietPlan(lastPlanQuery.currentPlan);
    const mealCards = document.querySelectorAll('.meal-card');
    let cardIndex = 0;
    for (let d = 0; d < dayIndex; d++) {
        cardIndex += lastPlanQuery.currentPlan[d].plan.length;
    }
    cardIndex += mealIndex;
    const targetCard = mealCards[cardIndex];
    if (targetCard) {
        targetCard.innerHTML = '<div class="loader"><div class="loader-spinner"></div></div><p class="text-center">Generating different meal...</p>';
    }

    const aiPrompt = `Generate a COMPLETELY DIFFERENT ${meal.type} meal (NOT "${meal.name}").
Diet: ${lastPlanQuery.preference}
Macro Preference: ${lastPlanQuery.macroPreference}
Avoid: ${lastPlanQuery.allergies}
Disliked Foods: ${lastPlanQuery.dislikedFoods}
Preferred Foods: ${lastPlanQuery.preferredFoods}
Budget: ${lastPlanQuery.budget}
Available Equipment: ${lastPlanQuery.equipmentStr}
Target macros: ${meal.calories} cal, ${meal.protein}g protein, ${meal.carbs}g carbs, ${meal.fat}g fat

CRITICAL NAMING RULES:
- Name meals with SPECIFIC QUANTITIES and ingredients (e.g., "6oz grilled salmon, 150g quinoa, 100g steamed broccoli")
- DO NOT use generic names like "Salmon with Quinoa"
- NEVER use adjectives like "hearty", "delicious", "tasty", "nutritious" in meal names
- Be direct and specific with measurements

CRITICAL: Return ONLY valid JSON. NO quotes in text - use apostrophes. Keep it brief.
Include detailed ingredients list and full cooking instructions.

{"type":"${meal.type}","name":"6oz chicken breast, 1 cup brown rice, 100g steamed vegetables","calories":${meal.calories},"protein":${meal.protein},"carbs":${meal.carbs},"fat":${meal.fat},"ingredients":["6oz chicken breast","1 cup brown rice","100g mixed vegetables"],"instructions":"Grill chicken, cook rice, steam vegetables."}`;

    const newMeal = await callGemini(aiPrompt, true);

    if (!newMeal.error) {
        // Sanitize the meal data
        newMeal.calories = parseInt(newMeal.calories) || meal.calories;
        newMeal.protein = parseInt(newMeal.protein) || meal.protein;
        newMeal.carbs = parseInt(newMeal.carbs) || meal.carbs;
        newMeal.fat = parseInt(newMeal.fat) || meal.fat;

        lastPlanQuery.currentPlan[dayIndex].plan[mealIndex] = newMeal;
        displayDietPlan(lastPlanQuery.currentPlan);
    } else {
        alert('Error changing meal: ' + newMeal.error);
        displayDietPlan(lastPlanQuery.currentPlan);
    }
}

// REVISE MEAL - Custom user modifications
async function reviseMeal(dayIndex, mealIndex) {
    const meal = lastPlanQuery.currentPlan[dayIndex].plan[mealIndex];
    const userRequest = window.prompt(`Revise "${meal.name}"?\n\nEnter your specific request (e.g., "make it vegetarian", "swap rice for sweet potato", "add more protein"):`, '');

    if (!userRequest || !userRequest.trim()) return;

    // Show loading
    displayDietPlan(lastPlanQuery.currentPlan);
    const mealCards = document.querySelectorAll('.meal-card');
    let cardIndex = 0;
    for (let d = 0; d < dayIndex; d++) {
        cardIndex += lastPlanQuery.currentPlan[d].plan.length;
    }
    cardIndex += mealIndex;
    const targetCard = mealCards[cardIndex];
    if (targetCard) {
        targetCard.innerHTML = '<div class="loader"><div class="loader-spinner"></div></div><p class="text-center">Revising meal...</p>';
    }

    const aiPrompt = `Revise this meal based on user request: "${meal.name}" (${meal.type})

USER REQUEST: ${userRequest}

Current meal details:
- Calories: ${meal.calories}
- Protein: ${meal.protein}g
- Carbs: ${meal.carbs}g
- Fat: ${meal.fat}g
- Ingredients: ${meal.ingredients ? meal.ingredients.join(', ') : 'N/A'}

Diet: ${lastPlanQuery.preference}
Macro Preference: ${lastPlanQuery.macroPreference}
Avoid: ${lastPlanQuery.allergies}
Disliked Foods: ${lastPlanQuery.dislikedFoods}
Preferred Foods: ${lastPlanQuery.preferredFoods}
Budget: ${lastPlanQuery.budget}
Available Equipment: ${lastPlanQuery.equipmentStr}

CRITICAL NAMING RULES:
- Name meals with SPECIFIC QUANTITIES and ingredients (e.g., "6oz grilled salmon, 150g quinoa, 100g steamed broccoli")
- DO NOT use generic names like "Salmon with Quinoa"
- NEVER use adjectives like "hearty", "delicious", "tasty", "nutritious" in meal names
- Be direct and specific with measurements

Keep macros similar unless user specifically requests changes.

CRITICAL: Return ONLY valid JSON. NO quotes in text - use apostrophes.
Include detailed ingredients list and full cooking instructions.

{"type":"${meal.type}","name":"6oz turkey breast, 150g sweet potato, 100g green beans","calories":${meal.calories},"protein":${meal.protein},"carbs":${meal.carbs},"fat":${meal.fat},"ingredients":["6oz turkey breast","150g sweet potato","100g green beans","1 tsp olive oil"],"instructions":"Bake turkey at 375F for 25 mins. Roast sweet potato. Steam green beans."}`;

    const revisedMeal = await callGemini(aiPrompt, true);

    if (!revisedMeal.error) {
        // Sanitize the meal data
        revisedMeal.calories = parseInt(revisedMeal.calories) || meal.calories;
        revisedMeal.protein = parseInt(revisedMeal.protein) || meal.protein;
        revisedMeal.carbs = parseInt(revisedMeal.carbs) || meal.carbs;
        revisedMeal.fat = parseInt(revisedMeal.fat) || meal.fat;

        lastPlanQuery.currentPlan[dayIndex].plan[mealIndex] = revisedMeal;
        displayDietPlan(lastPlanQuery.currentPlan);
    } else {
        alert('Error revising meal: ' + revisedMeal.error);
        displayDietPlan(lastPlanQuery.currentPlan);
    }
}

// GROCERY LIST AGGREGATION
function parseIngredient(ingredientStr) {
    const patterns = [
        /(\d+\.?\d*)\s*(oz|ounces?|pounds?|lbs?|g|grams?|kg|cups?|tbsp|tsp|pieces?)\s+(.+)/i,
        /(\d+\.?\d*)\s+(.+)/i
    ];

    for (const pattern of patterns) {
        const match = ingredientStr.match(pattern);
        if (match) {
            return {
                quantity: parseFloat(match[1]) || 0,
                unit: (match[2] || 'unit').toLowerCase(),
                name: (match[3] || match[2] || ingredientStr).toLowerCase().trim()
            };
        }
    }
    return { quantity: 1, unit: 'unit', name: ingredientStr.toLowerCase().trim() };
}

function normalizeUnit(quantity, unit) {
    const conversions = {
        'oz': 1, 'ounce': 1, 'ounces': 1,
        'lb': 16, 'lbs': 16, 'pound': 16, 'pounds': 16,
        'g': 0.035274, 'gram': 0.035274, 'grams': 0.035274,
        'kg': 35.274,
        'cup': 1, 'cups': 1,
        'tbsp': 1, 'tsp': 0.333,
        'piece': 1, 'pieces': 1, 'unit': 1
    };

    const normalized = conversions[unit] || 1;
    return { quantity: quantity * normalized, unit: unit in conversions ? (normalized > 10 ? 'oz' : unit) : unit };
}

function aggregateGroceryList(multiDayPlan) {
    const aggregated = {};

    multiDayPlan.forEach(dayData => {
        dayData.plan.forEach(meal => {
            if (!meal.ingredients || !Array.isArray(meal.ingredients)) return;

            meal.ingredients.forEach(ingredient => {
                const parsed = parseIngredient(ingredient);
                const normalized = normalizeUnit(parsed.quantity, parsed.unit);

                const key = `${parsed.name}|${normalized.unit}`;
                if (aggregated[key]) {
                    aggregated[key].quantity += normalized.quantity;
                } else {
                    aggregated[key] = {
                        name: parsed.name,
                        quantity: normalized.quantity,
                        unit: normalized.unit
                    };
                }
            });
        });
    });

    return Object.values(aggregated).sort((a, b) => a.name.localeCompare(b.name));
}

function showGroceryList() {
    if (!lastPlanQuery.currentPlan) {
        alert('No plan available');
        return;
    }

    const groceryList = aggregateGroceryList(lastPlanQuery.currentPlan);

    let listHTML = `
        <div class="card mt-4">
            <h3 class="text-2xl font-bold mb-4">üìù Grocery List</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">`;

    groceryList.forEach(item => {
        listHTML += `<div class="p-2 bg-gray-50 rounded">
            <span class="font-semibold">${item.quantity.toFixed(1)} ${item.unit}</span> ${item.name}
        </div>`;
    });

    listHTML += `</div>
        <button data-action="close-grocery-list" class="btn btn-secondary w-full mt-4">Close</button>
    </div>`;

    const resultDiv = document.getElementById('diet-plan-result');
    resultDiv.innerHTML += listHTML;
    resultDiv.lastElementChild.scrollIntoView({ behavior: 'smooth' });
}

// PDF EXPORT
function downloadPlanAsPDF() {
    const { jsPDF } = window.jspdf;
    if (!lastPlanQuery.currentPlan) {
        alert('No plan to download');
        return;
    }

    const pdf = new jsPDF();
    const margin = 15;
    const pageWidth = pdf.internal.pageSize.getWidth();
    const maxWidth = pageWidth - (margin * 2);
    let y = 20;

    // Title
    pdf.setFontSize(24);
    pdf.setTextColor(102, 126, 234);
    pdf.text('Personalized Meal Plan', margin, y);
    y += 10;

    // Client Name
    if (lastPlanQuery.clientName) {
        pdf.setFontSize(16);
        pdf.setTextColor(0, 0, 0);
        pdf.text(`For: ${lastPlanQuery.clientName}`, margin, y);
        y += 12;
    }

    // Daily Nutrition Summary
    pdf.setFontSize(14);
    pdf.setTextColor(0, 0, 0);
    pdf.text('Daily Nutrition Targets:', margin, y);
    y += 8;
    pdf.setFontSize(11);
    pdf.text(`Calories: ${lastPlanQuery.calories} | Protein: ${lastPlanQuery.protein}g | Carbs: ${lastPlanQuery.carbs}g | Fat: ${lastPlanQuery.fat}g`, margin, y);
    y += 8;
    pdf.text(`Macro Split: ${lastPlanQuery.macroPreference}`, margin, y);
    y += 15;

    // Supplement Protocol Section
    if (lastPlanQuery.proteinPowderNote && lastPlanQuery.proteinPowderNote.trim()) {
        if (y > 240) {
            pdf.addPage();
            y = 20;
        }
        pdf.setFontSize(16);
        pdf.setTextColor(102, 126, 234);
        pdf.text('Supplement Protocol', margin, y);
        y += 8;
        pdf.setFontSize(10);
        pdf.setTextColor(0, 0, 0);
        const supplementLines = pdf.splitTextToSize(lastPlanQuery.proteinPowderNote.replace(/\n/g, ' ').trim(), maxWidth);
        pdf.text(supplementLines, margin, y);
        y += supplementLines.length * 5 + 10;
    }

    // Meal Plans by Day
    lastPlanQuery.currentPlan.forEach(dayData => {
        if (y > 250) {
            pdf.addPage();
            y = 20;
        }

        // Day Header
        pdf.setFontSize(18);
        pdf.setTextColor(118, 75, 162);
        pdf.text(`Day ${dayData.day}`, margin, y);
        y += 10;

        dayData.plan.forEach(meal => {
            if (y > 230) {
                pdf.addPage();
                y = 20;
            }

            // Meal Name
            pdf.setFontSize(14);
            pdf.setTextColor(102, 126, 234);
            const mealNameLines = pdf.splitTextToSize(`${meal.type.toUpperCase()}: ${meal.name}`, maxWidth);
            pdf.text(mealNameLines, margin, y);
            y += mealNameLines.length * 6;

            // Macros
            pdf.setFontSize(10);
            pdf.setTextColor(100, 100, 100);
            pdf.text(`${meal.calories} cal | ${meal.protein}g protein | ${meal.carbs}g carbs | ${meal.fat}g fat`, margin + 5, y);
            y += 7;

            // Ingredients
            if (meal.ingredients && Array.isArray(meal.ingredients) && meal.ingredients.length > 0) {
                pdf.setFontSize(11);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont(undefined, 'bold');
                pdf.text('Ingredients:', margin + 5, y);
                y += 5;
                pdf.setFont(undefined, 'normal');
                pdf.setFontSize(9);
                meal.ingredients.forEach(ingredient => {
                    if (y > 270) {
                        pdf.addPage();
                        y = 20;
                    }
                    const ingredientLines = pdf.splitTextToSize(`‚Ä¢ ${ingredient}`, maxWidth - 10);
                    pdf.text(ingredientLines, margin + 10, y);
                    y += ingredientLines.length * 4;
                });
                y += 3;
            }

            // Full Cooking Instructions
            if (meal.instructions) {
                if (y > 260) {
                    pdf.addPage();
                    y = 20;
                }
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('Cooking Instructions:', margin + 5, y);
                y += 5;
                pdf.setFont(undefined, 'normal');
                pdf.setFontSize(9);
                const instructionLines = pdf.splitTextToSize(meal.instructions, maxWidth - 10);
                pdf.text(instructionLines, margin + 10, y);
                y += instructionLines.length * 4 + 8;
            }

            y += 5; // Space between meals
        });
        y += 10; // Space between days
    });

    // Grocery List
    pdf.addPage();
    y = 20;
    pdf.setFontSize(20);
    pdf.setTextColor(102, 126, 234);
    pdf.text('Shopping List', margin, y);
    y += 12;

    const groceryList = aggregateGroceryList(lastPlanQuery.currentPlan);
    pdf.setFontSize(10);
    pdf.setTextColor(0, 0, 0);
    groceryList.forEach(item => {
        if (y > 270) {
            pdf.addPage();
            y = 20;
        }
        const itemText = `- ${item.quantity.toFixed(1)} ${item.unit} ${item.name}`;
        pdf.text(itemText, margin, y);
        y += 6;
    });

    // Footer on last page
    y += 10;
    if (y > 260) {
        pdf.addPage();
        y = 20;
    }
    pdf.setFontSize(8);
    pdf.setTextColor(150, 150, 150);
    pdf.text(`Generated on ${new Date().toLocaleDateString()}`, margin, y);

    pdf.save('meal-plan.pdf');
}

// SHARE PLAN FUNCTIONALITY
async function sharePlan() {
    if (!lastPlanQuery.currentPlan) {
        alert('No plan to share. Please generate a plan first.');
        return;
    }

    // Prepare the plan data for sharing
    const shareData = {
        clientName: lastPlanQuery.clientName || 'Client',
        nutrition: {
            calories: lastPlanQuery.calories,
            protein: lastPlanQuery.protein,
            carbs: lastPlanQuery.carbs,
            fat: lastPlanQuery.fat
        },
        meals: [],
        preferences: {
            goal: document.getElementById('dp_goal')?.value || 'maintain',
            dietType: lastPlanQuery.preference || 'omnivore',
            allergies: lastPlanQuery.allergies || 'none',
            mealsPerDay: lastPlanQuery.currentPlan.length > 0 ? lastPlanQuery.currentPlan[0].plan.length : 3
        },
        generatedAt: new Date().toISOString()
    };

    // Flatten multi-day plan into single meals array
    lastPlanQuery.currentPlan.forEach(dayData => {
        dayData.plan.forEach(meal => {
            shareData.meals.push(meal);
        });
    });

    // Show modal with loading state
    const modal = document.getElementById('share-modal');
    const linkText = document.getElementById('share-link-text');
    linkText.textContent = 'Generating share link...';
    modal.classList.remove('hidden');

    try {
        console.log('Saving plan for sharing...');

        // Prepare request body
        const requestBody = { planData: shareData };

        // If this plan was saved to history (has planId), include it
        // This links the shared plan to the coach plan for cascade deletion
        if (lastPlanQuery.planId) {
            requestBody.coachPlanId = lastPlanQuery.planId;
            console.log('Linking shared plan to coach plan:', lastPlanQuery.planId);
        }

        const response = await fetch(SAVE_PLAN_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error('Failed to generate share link');
        }

        const data = await response.json();
        currentShareUrl = data.shareUrl;

        console.log('Share link generated:', currentShareUrl);

        linkText.textContent = currentShareUrl;

    } catch (error) {
        console.error('Error generating share link:', error);
        linkText.textContent = 'Failed to generate link. Please try again.';
        alert('Failed to generate share link. Please try again.');
    }
}

async function copyShareLink() {
    if (!currentShareUrl) {
        alert('No share link available');
        return;
    }

    try {
        await navigator.clipboard.writeText(currentShareUrl);

        // Update button text temporarily
        const copyBtn = event.target;
        const originalText = copyBtn.textContent;
        copyBtn.textContent = '‚úÖ Copied!';
        copyBtn.style.background = '#28a745';

        setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.style.background = '';
        }, 2000);

    } catch (error) {
        console.error('Copy error:', error);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = currentShareUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Link copied to clipboard!');
    }
}

function closeShareModal() {
    const modal = document.getElementById('share-modal');
    modal.classList.add('hidden');
}

// MEAL PREP GUIDE GENERATOR
async function showMealPrepGuide() {
    const modal = document.getElementById('meal-prep-modal');
    const content = document.getElementById('meal-prep-content');

    // Show modal with loading state
    modal.classList.remove('hidden');
    content.innerHTML = `
        <div class="flex items-center justify-center py-12">
            <div class="loader"><div class="loader-spinner"></div></div>
            <p class="ml-4 text-gray-600">Generating your comprehensive meal prep guide...</p>
        </div>
    `;

    try {
        // Collect all meals from the plan
        const allMeals = [];
        if (lastPlanQuery.currentPlan && Array.isArray(lastPlanQuery.currentPlan)) {
            lastPlanQuery.currentPlan.forEach(dayData => {
                if (dayData.plan && Array.isArray(dayData.plan)) {
                    dayData.plan.forEach(meal => {
                        allMeals.push({
                            day: dayData.day,
                            type: meal.type,
                            name: meal.name,
                            calories: meal.calories,
                            protein: meal.protein,
                            carbs: meal.carbs,
                            fat: meal.fat
                        });
                    });
                }
            });
        }

        if (allMeals.length === 0) {
            content.innerHTML = '<p class="text-center text-gray-600">No meal plan found. Please generate a meal plan first.</p>';
            return;
        }

        const numDays = lastPlanQuery.currentPlan.length;
        const mealsList = allMeals.map(m => `Day ${m.day} ${m.type}: ${m.name}`).join('\n');

        const prompt = `You are a professional meal prep consultant. Create a comprehensive meal prep guide for the following ${numDays}-day meal plan:

${mealsList}

Create a detailed, actionable meal prep guide with the following sections:

## üìù Shopping List
Group all ingredients by category (Proteins, Vegetables, Fruits, Grains/Carbs, Dairy, Pantry Items, etc.)
Combine quantities where meals share ingredients
Be specific with quantities and measurements

## ‚è∞ Meal Prep Timeline
Provide a day-by-day prep schedule (e.g., "Sunday: Cook all proteins", "Monday: Prep vegetables")
Include which meals to batch cook together
Suggest which components can be prepared ahead
Include estimated time for each prep session

## ü•° Storage Instructions
For EACH meal, specify:
- How long it keeps in the refrigerator (be specific: 3-4 days, 5-6 days, etc.)
- Whether it can be frozen and for how long
- Best storage containers (airtight, glass, etc.)
- Any special storage notes

## üî• Reheating Instructions
For EACH meal type (not every individual meal, but each unique recipe), provide:
- Microwave instructions (time and power level)
- Oven/stovetop instructions if better quality
- Tips to maintain texture and flavor

## üí° Time-Saving Tips
- Batch cooking strategies (cook all chicken at once, prep all vegetables together, etc.)
- Make-ahead components (cook rice/grains in bulk, pre-chop vegetables, etc.)
- Kitchen shortcuts and efficiency tips
- Which meals taste better fresh vs reheated

Format the response in clean, readable markdown with clear headings and bullet points.
Be specific, practical, and actionable. Focus on making meal prep as easy and efficient as possible.`;

        const response = await callGemini(prompt, false);

        // Format the response nicely
        content.innerHTML = `
            <div class="prose prose-sm max-w-none">
                ${formatMarkdown(response)}
            </div>
        `;

    } catch (error) {
        console.error('Error generating meal prep guide:', error);
        content.innerHTML = `
            <div class="text-center text-red-600 py-8">
                <p class="font-semibold">Error generating meal prep guide</p>
                <p class="text-sm mt-2">${error.message}</p>
            </div>
        `;
    }
}

// Simple markdown formatter
function formatMarkdown(text) {
    return text
        .replace(/^## (.+)$/gm, '<h2 class="text-2xl font-bold mt-6 mb-4 text-gray-800">$1</h2>')
        .replace(/^### (.+)$/gm, '<h3 class="text-xl font-semibold mt-4 mb-3 text-gray-700">$1</h3>')
        .replace(/^\* (.+)$/gm, '<li class="ml-4">$1</li>')
        .replace(/^- (.+)$/gm, '<li class="ml-4">$1</li>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p class="mb-3">')
        .replace(/^(?!<[hl]|<li)/gm, '<p class="mb-3">')
        .replace(/<\/li>\n<li/g, '</li><li');
}

// UNIT SYSTEM STATE
let currentUnitSystem = 'imperial';

function toggleUnitSystem(system) {
    currentUnitSystem = system;
    document.getElementById('unit-imperial').className = system === 'imperial' ? 'btn btn-primary text-sm py-1 px-3' : 'btn btn-secondary text-sm py-1 px-3';
    document.getElementById('unit-metric').className = system === 'metric' ? 'btn btn-primary text-sm py-1 px-3' : 'btn btn-secondary text-sm py-1 px-3';

    // Update labels
    const weightLabel = system === 'imperial' ? 'Weight (lbs)' : 'Weight (kg)';
    const heightLabel1 = system === 'imperial' ? 'Height (ft)' : 'Height (cm)';
    const heightLabel2 = system === 'imperial' ? 'Height (in)' : '';

    document.querySelector('label[for="dp_weight"]').textContent = weightLabel;
    document.querySelector('label[for="dp_height_ft"]').textContent = heightLabel1;
    document.querySelector('label[for="dp_height_in"]').textContent = heightLabel2;
    document.getElementById('dp_height_in').style.display = system === 'imperial' ? 'block' : 'none';
}

// EVENT HANDLERS
document.addEventListener('click', function(event) {
    const actionTarget = event.target.closest('[data-action]');
    if (!actionTarget) return;

    const actions = {
        'generate-plan': generateDietPlan,
        'close-modal': () => document.getElementById('recipe-modal').classList.add('hidden'),
        'get-recipe': () => {
            const mealName = event.target.closest('[data-meal-name]').dataset.mealName;
            if(mealName) getAIRecipe(mealName);
        },
        'change-meal': () => {
            const target = event.target.closest('[data-day-index]');
            const dayIndex = parseInt(target.dataset.dayIndex);
            const mealIndex = parseInt(target.dataset.mealIndex);
            changeMeal(dayIndex, mealIndex);
        },
        'revise-meal': () => {
            const target = event.target.closest('[data-day-index]');
            const dayIndex = parseInt(target.dataset.dayIndex);
            const mealIndex = parseInt(target.dataset.mealIndex);
            reviseMeal(dayIndex, mealIndex);
        },
        'show-grocery-list': showGroceryList,
        'close-grocery-list': () => {
            event.target.closest('.card').remove();
        },
        'show-meal-prep-guide': showMealPrepGuide,
        'close-meal-prep-modal': () => document.getElementById('meal-prep-modal').classList.add('hidden'),
        'download-pdf': downloadPlanAsPDF,
        'share-plan': sharePlan,
        'copy-share-link': copyShareLink,
        'close-share-modal': closeShareModal
    };

    if (actions[actionTarget.dataset.action]) actions[actionTarget.dataset.action]();
});

// Unit system toggle
document.getElementById('unit-imperial').addEventListener('click', () => toggleUnitSystem('imperial'));
document.getElementById('unit-metric').addEventListener('click', () => toggleUnitSystem('metric'));

// Protein powder checkbox toggle
document.getElementById('dp_use_protein').addEventListener('change', function() {
    const fields = document.getElementById('protein-powder-fields');
    if (this.checked) {
        fields.style.display = 'grid';  // Use grid to match the class
    } else {
        fields.style.display = 'none';
    }
});
</script>
</body>
</html>
