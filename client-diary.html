<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/icons/logo.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Diary - Zique Fitness Nutrition</title>
    <script src="/js/theme.js"></script>
    <script src="/js/branding.js" defer></script>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" as="script">
    <link rel="preload" href="https://unpkg.com/lucide@0.312.0/dist/umd/lucide.min.js" as="script">
    <link rel="preconnect" href="https://qewqcjzlfqamqwbccapr.supabase.co" crossorigin>
    <link rel="dns-prefetch" href="https://qewqcjzlfqamqwbccapr.supabase.co">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-primary: #0d9488;
            --brand-primary-dark: #0f766e;
            --brand-secondary: #0284c7;
            --brand-gradient: linear-gradient(135deg, #0d9488 0%, #0284c7 100%);
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --gray-50: #0f172a;
            --gray-100: #1e293b;
            --gray-200: #334155;
            --gray-300: #475569;
            --gray-400: #64748b;
            --gray-500: #94a3b8;
            --gray-600: #cbd5e1;
            --gray-700: #e2e8f0;
            --gray-800: #f1f5f9;
            --gray-900: #f8fafc;
            --brand-primary: #14b8a6;
        }

        /* Skeleton Loading Animation */
        @keyframes skeleton-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
            background-size: 200% 100%;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }

        .skeleton-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
        }

        .skeleton-entry {
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
        }

        /* Optimistic entry style */
        .entry-item.saving {
            opacity: 0.7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-50);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        [data-theme="dark"] body {
            background: #0f172a;
        }

        /* Top Navigation */
        .top-nav {
            background: var(--brand-gradient);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
        }

        .nav-logo-img {
            height: 50px;
            width: auto;
            object-fit: contain;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Main Content */
        .main-content {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Date Navigation */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 16px 0;
            margin-bottom: 8px;
        }

        .date-nav-btn {
            background: var(--gray-100);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--gray-600);
            transition: all 0.2s;
        }

        .date-nav-btn:hover {
            background: var(--gray-200);
        }

        [data-theme="dark"] .date-nav-btn {
            background: #334155;
            color: #94a3b8;
        }

        .date-display {
            text-align: center;
            cursor: pointer;
        }

        .date-display-main {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        [data-theme="dark"] .date-display-main {
            color: #f1f5f9;
        }

        .date-display-sub {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        /* Summary Card */
        .summary-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-100);
        }

        [data-theme="dark"] .summary-card {
            background: #1e293b;
            border-color: #334155;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .summary-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        [data-theme="dark"] .summary-title {
            color: #f1f5f9;
        }

        .calorie-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .calorie-ring {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto 12px;
        }

        .calorie-ring svg {
            transform: rotate(-90deg);
            width: 140px;
            height: 140px;
        }

        .calorie-ring-bg {
            fill: none;
            stroke: var(--gray-200);
            stroke-width: 10;
        }

        [data-theme="dark"] .calorie-ring-bg {
            stroke: #334155;
        }

        .calorie-ring-progress {
            fill: none;
            stroke: var(--brand-primary);
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .calorie-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .calorie-remaining {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--gray-900);
            line-height: 1;
        }

        [data-theme="dark"] .calorie-remaining {
            color: #f1f5f9;
        }

        .calorie-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 4px;
        }

        .calorie-equation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 20px;
        }

        [data-theme="dark"] .calorie-equation {
            color: #94a3b8;
        }

        .calorie-equation span {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .calorie-equation .value {
            font-weight: 700;
            font-size: 1rem;
            color: var(--gray-900);
        }

        [data-theme="dark"] .calorie-equation .value {
            color: #f1f5f9;
        }

        /* Compact inline macro bars */
        .macro-bars {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        .macro-bar {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 0;
        }

        .macro-bar-header {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .macro-bar-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--gray-600);
        }

        .macro-bar-label.protein { color: #3b82f6; }
        .macro-bar-label.carbs { color: #f59e0b; }
        .macro-bar-label.fat { color: #ef4444; }

        [data-theme="dark"] .macro-bar-label {
            color: #94a3b8;
        }
        [data-theme="dark"] .macro-bar-label.protein { color: #60a5fa; }
        [data-theme="dark"] .macro-bar-label.carbs { color: #fbbf24; }
        [data-theme="dark"] .macro-bar-label.fat { color: #f87171; }

        .macro-bar-value {
            font-size: 0.65rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        [data-theme="dark"] .macro-bar-value {
            color: #94a3b8;
        }

        .macro-bar-track {
            flex: 1;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
            min-width: 30px;
        }

        [data-theme="dark"] .macro-bar-track {
            background: #334155;
        }

        .macro-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .macro-bar-fill.protein { background: #3b82f6; }
        .macro-bar-fill.carbs { background: #f59e0b; }
        .macro-bar-fill.fat { background: #ef4444; }

        /* Skeleton Loading States */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton {
            background: linear-gradient(90deg,
                var(--gray-200) 25%,
                var(--gray-100) 50%,
                var(--gray-200) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg,
                #334155 25%,
                #475569 50%,
                #334155 75%
            );
            background-size: 200% 100%;
        }

        .skeleton-ring {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            margin: 0 auto 12px;
        }

        .skeleton-text-lg {
            height: 32px;
            width: 80px;
            margin: 0 auto 8px;
        }

        .skeleton-text-sm {
            height: 14px;
            width: 60px;
            margin: 0 auto;
        }

        .skeleton-equation {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 16px;
        }

        .skeleton-equation-item {
            text-align: center;
        }

        .skeleton-equation-item .skeleton-num {
            height: 24px;
            width: 50px;
            margin-bottom: 4px;
        }

        .skeleton-equation-item .skeleton-label {
            height: 12px;
            width: 40px;
        }

        .skeleton-macro-bars {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .skeleton-macro-bar {
            flex: 1;
            height: 24px;
            border-radius: 6px;
        }

        .skeleton-food-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            gap: 12px;
            border-bottom: 1px solid var(--gray-100);
        }

        [data-theme="dark"] .skeleton-food-item {
            border-bottom-color: #334155;
        }

        .skeleton-food-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .skeleton-food-content {
            flex: 1;
        }

        .skeleton-food-name {
            height: 16px;
            width: 70%;
            margin-bottom: 6px;
        }

        .skeleton-food-meta {
            height: 12px;
            width: 50%;
        }

        .skeleton-food-cal {
            width: 40px;
            height: 18px;
            flex-shrink: 0;
        }

        /* Loading state visibility */
        .loading-skeleton {
            display: block;
        }

        .loading-content {
            display: none;
        }

        .loaded .loading-skeleton {
            display: none;
        }

        .loaded .loading-content {
            display: block;
        }

        /* Smooth fade transition */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Meal Sections */
        .meal-section {
            background: white;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            overflow: hidden;
        }

        [data-theme="dark"] .meal-section {
            background: #1e293b;
            border-color: #334155;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .meal-header:hover {
            background: var(--gray-50);
        }

        [data-theme="dark"] .meal-header:hover {
            background: #334155;
        }

        .meal-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .meal-icon {
            font-size: 1.25rem;
        }

        .meal-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        [data-theme="dark"] .meal-name {
            color: #f1f5f9;
        }

        .meal-calories {
            font-size: 0.875rem;
            color: var(--gray-500);
            font-weight: 600;
        }

        .meal-entries {
            border-top: 1px solid var(--gray-100);
        }

        [data-theme="dark"] .meal-entries {
            border-color: #334155;
        }

        .food-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: background 0.2s;
        }

        .food-entry:last-child {
            border-bottom: none;
        }

        .food-entry:hover {
            background: var(--gray-50);
        }

        [data-theme="dark"] .food-entry {
            border-color: #334155;
        }

        [data-theme="dark"] .food-entry:hover {
            background: #334155;
        }

        .food-info {
            flex: 1;
        }

        .food-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-800);
            margin-bottom: 2px;
        }

        [data-theme="dark"] .food-name {
            color: #e2e8f0;
        }

        .food-details {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .food-calories {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        [data-theme="dark"] .food-calories {
            color: #cbd5e1;
        }

        /* Swipe to delete styles */
        .swipe-container {
            position: relative;
            overflow: hidden;
        }

        .swipe-content {
            position: relative;
            z-index: 2;
            background: white;
            transition: transform 0.2s ease-out;
        }

        [data-theme="dark"] .swipe-content {
            background: var(--gray-100);
        }

        .swipe-content.swiping {
            transition: none;
        }

        .delete-action {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 80px;
            background: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            z-index: 1;
        }

        .delete-action svg {
            width: 20px;
            height: 20px;
        }

        .add-food-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            color: var(--brand-primary);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
            border-top: 1px solid var(--gray-100);
        }

        .add-food-btn:hover {
            background: var(--gray-50);
        }

        [data-theme="dark"] .add-food-btn {
            border-color: #334155;
        }

        [data-theme="dark"] .add-food-btn:hover {
            background: #334155;
        }

        .meal-actions {
            display: flex;
            gap: 8px;
            border-top: 1px solid var(--gray-100);
        }

        .meal-actions .add-food-btn {
            flex: 1;
            border-top: none;
        }

        .save-meal-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px 16px;
            color: #dc2626;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-left: 1px solid var(--gray-100);
        }

        .save-meal-btn:hover {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }

        [data-theme="dark"] .meal-actions {
            border-color: #334155;
        }

        [data-theme="dark"] .save-meal-btn {
            background: linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%);
            color: #fca5a5;
            border-color: #334155;
        }

        [data-theme="dark"] .save-meal-btn:hover {
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
        }

        /* Settings/Goals Button */
        .goals-btn {
            background: none;
            border: none;
            color: var(--brand-primary);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Food Search Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gray-50);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        [data-theme="dark"] .modal-content {
            background: #0f172a;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border-bottom: 1px solid var(--gray-200);
        }

        [data-theme="dark"] .modal-header {
            background: #1e293b;
            border-color: #334155;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-500);
            cursor: pointer;
            padding: 4px;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px;
            border: none;
            background: var(--gray-100);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            color: var(--gray-900);
        }

        .search-input:focus {
            outline: none;
            background: var(--gray-200);
        }

        [data-theme="dark"] .search-input {
            background: #334155;
            color: #f1f5f9;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .search-results {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-result {
            background: white;
            padding: 14px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--gray-100);
        }

        .search-result:hover {
            background: var(--gray-50);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        [data-theme="dark"] .search-result {
            background: #1e293b;
            border-color: #334155;
        }

        [data-theme="dark"] .search-result:hover {
            background: #334155;
        }

        .search-result-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        [data-theme="dark"] .search-result-name {
            color: #f1f5f9;
        }

        .search-result-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .search-result-source {
            display: inline-block;
            padding: 2px 6px;
            background: var(--gray-100);
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        [data-theme="dark"] .search-result-source {
            background: #334155;
        }

        /* Quick Add Section */
        .quick-add-section {
            margin-top: 20px;
            padding-top: 20px;
            padding-bottom: 100px;
            border-top: 1px solid var(--gray-200);
        }

        [data-theme="dark"] .quick-add-section {
            border-color: #334155;
        }

        .quick-add-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 12px;
        }

        .quick-add-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 14px 16px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-add-btn:hover {
            background: var(--gray-50);
            border-color: var(--brand-primary);
        }

        [data-theme="dark"] .quick-add-btn {
            background: #1e293b;
            border-color: #334155;
        }

        .quick-add-icon {
            width: 40px;
            height: 40px;
            background: var(--brand-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .quick-add-text {
            text-align: left;
        }

        .quick-add-text-main {
            font-weight: 600;
            color: var(--gray-900);
        }

        [data-theme="dark"] .quick-add-text-main {
            color: #f1f5f9;
        }

        .quick-add-text-sub {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        /* Quick Add Modal */
        .quick-add-modal {
            max-width: 500px;
            margin: auto;
            background: white;
            border-radius: 20px;
            padding: 24px;
            position: relative;
        }

        [data-theme="dark"] .quick-add-modal {
            background: #1e293b;
        }

        .quick-add-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        [data-theme="dark"] .form-group label {
            color: #cbd5e1;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        [data-theme="dark"] .form-group input,
        [data-theme="dark"] .form-group select {
            background: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        .btn {
            padding: 14px 24px;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--brand-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        [data-theme="dark"] .btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }

        /* Goals Modal */
        .goals-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] .bottom-nav {
            background: #1e293b;
            border-color: #334155;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray-500);
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.2s;
            min-width: 64px;
        }

        .bottom-nav-item.active {
            color: var(--brand-primary);
        }

        .bottom-nav-item.active .nav-icon {
            background: rgba(13, 148, 136, 0.1);
        }

        [data-theme="dark"] .bottom-nav-item {
            color: #94a3b8;
        }

        [data-theme="dark"] .bottom-nav-item.active {
            color: #14b8a6;
        }

        .nav-icon {
            width: 48px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray-500);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--brand-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 24px;
            color: var(--gray-500);
        }

        .empty-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        /* Edit Entry Modal */
        .edit-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-900);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        [data-theme="dark"] .toast {
            background: #334155;
        }

        /* Desktop Responsive */
        @media (min-width: 768px) {
            .bottom-nav {
                display: none;
            }
            .main-content {
                padding-bottom: 32px;
            }
        }

        /* ========================================
           PHASE 1 FEATURES STYLES
           ======================================== */

        /* Streak Badge */
        .streak-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .streak-badge.no-streak {
            background: var(--gray-300);
            color: var(--gray-600);
        }

        /* Quick Actions Bar */
        .quick-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .quick-actions::-webkit-scrollbar {
            display: none;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--gray-100);
            border: none;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: var(--gray-200);
        }

        .quick-action-btn svg {
            width: 16px;
            height: 16px;
        }

        [data-theme="dark"] .quick-action-btn {
            background: #334155;
            color: #e2e8f0;
        }

        /* Water Tracking Card */
        .water-card {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-radius: 16px;
            padding: 16px;
            margin: 0 16px 16px;
            color: white;
        }

        .water-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .water-title {
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .water-goal-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 4px 10px;
            border-radius: 12px;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .water-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .water-glasses {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .water-glass {
            width: 28px;
            height: 36px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px 4px 8px 8px;
            position: relative;
            overflow: hidden;
        }

        .water-glass.filled {
            background: rgba(255,255,255,0.9);
        }

        .water-glass.filled::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: #0ea5e9;
            border-radius: 0 0 6px 6px;
        }

        .water-stats {
            text-align: right;
        }

        .water-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .water-target {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .water-buttons {
            display: flex;
            gap: 8px;
        }

        .water-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .water-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .water-btn.primary {
            background: white;
            color: #0284c7;
        }

        /* Daily Report Modal */
        .report-content {
            padding: 20px;
        }

        .report-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .report-date {
            font-size: 0.9rem;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .report-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .report-score {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .score-circle.excellent {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .score-circle.good {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
        }

        .score-circle.fair {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .score-circle.poor {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .score-value {
            font-size: 2.5rem;
        }

        .score-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .report-stat {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
        }

        .report-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .report-stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .report-meals {
            margin-top: 20px;
        }

        .report-meals-title {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        .report-meal-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .report-meal-item:last-child {
            border-bottom: none;
        }

        .report-insights {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }

        [data-theme="dark"] .report-insights {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
        }

        .report-insights-title {
            font-weight: 600;
            color: #059669;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        [data-theme="dark"] .report-insights-title {
            color: #34d399;
        }

        .report-insight {
            font-size: 0.9rem;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        [data-theme="dark"] .report-insight {
            color: #d1fae5;
        }

        /* Daily Report dark mode fixes */
        [data-theme="dark"] .report-stat {
            background: #334155;
        }

        [data-theme="dark"] .report-stat-value {
            color: #f1f5f9;
        }

        [data-theme="dark"] .report-stat-label {
            color: #94a3b8;
        }

        [data-theme="dark"] .report-meals-title {
            color: #e2e8f0;
        }

        [data-theme="dark"] .report-meal-item {
            color: #e2e8f0;
            border-bottom-color: #475569;
        }

        /* Copy Day Modal */
        .copy-day-options {
            padding: 20px;
        }

        .copy-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--gray-100);
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .copy-option:hover {
            border-color: var(--brand-primary);
        }

        .copy-option-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .copy-option-icon.yesterday {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .copy-option-icon.pick-date {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        }

        .copy-option-icon.to-date {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .copy-option-text {
            flex: 1;
        }

        .copy-option-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 2px;
        }

        .copy-option-desc {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        /* ========================================
           PHASE 2 FEATURES STYLES
           ======================================== */

        /* AI Photo Recognition */
        .photo-upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .photo-upload-area:hover {
            border-color: var(--brand-primary);
            background: var(--gray-50);
        }

        .photo-upload-area.has-image {
            border-style: solid;
            border-color: var(--brand-primary);
            padding: 0;
            overflow: hidden;
        }

        .photo-upload-area img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
        }

        .photo-upload-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .photo-upload-text {
            color: var(--gray-600);
            font-size: 0.95rem;
        }

        .photo-upload-hint {
            color: var(--gray-400);
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .ai-analyzing {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
        }

        .ai-analyzing-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--brand-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ai-analyzing-text {
            margin-top: 16px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .ai-results {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        [data-theme="dark"] .ai-results {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
        }

        .ai-results-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #059669;
        }

        .ai-food-item {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
        }

        [data-theme="dark"] .ai-food-item {
            background: var(--gray-100);
        }

        .ai-food-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .ai-food-macros {
            display: flex;
            gap: 12px;
            font-size: 0.85rem;
        }

        /* Weight Tracking */
        .weight-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin: 0 16px 16px;
            box-shadow: var(--shadow-sm);
        }

        [data-theme="dark"] .weight-card {
            background: var(--gray-100);
        }

        .weight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .weight-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .weight-current {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 12px;
        }

        .weight-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .weight-unit {
            color: var(--gray-500);
            font-size: 1rem;
        }

        .weight-change {
            font-size: 0.85rem;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .weight-change.down {
            background: #dcfce7;
            color: #16a34a;
        }

        .weight-change.up {
            background: #fee2e2;
            color: #dc2626;
        }

        .weight-change.same {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .weight-chart {
            height: 120px;
            margin: 12px 0;
            position: relative;
        }

        .weight-chart-canvas {
            width: 100%;
            height: 100%;
        }

        .weight-stats {
            display: flex;
            justify-content: space-around;
            padding-top: 12px;
            border-top: 1px solid var(--gray-100);
        }

        .weight-stat {
            text-align: center;
        }

        .weight-stat-value {
            font-weight: 600;
            color: var(--gray-900);
        }

        .weight-stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Weekly Summary */
        .weekly-chart-container {
            padding: 20px;
        }

        .weekly-chart {
            height: 200px;
            position: relative;
            margin-bottom: 20px;
        }

        .weekly-bars {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 160px;
            padding: 0 10px;
        }

        .weekly-bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .weekly-bar {
            width: 30px;
            background: linear-gradient(180deg, var(--brand-primary) 0%, #0284c7 100%);
            border-radius: 4px 4px 0 0;
            transition: height 0.3s ease;
            min-height: 4px;
        }

        .weekly-bar.under {
            background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
        }

        .weekly-bar.over {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
        }

        .weekly-bar-label {
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .weekly-bar-value {
            font-size: 0.7rem;
            color: var(--gray-600);
            margin-top: 4px;
        }

        .weekly-summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .weekly-stat {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
        }

        .weekly-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .weekly-stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Coach Comments */
        .coach-comment {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid #3b82f6;
            border-radius: 0 12px 12px 0;
            padding: 12px 16px;
            margin: 8px 16px;
        }

        [data-theme="dark"] .coach-comment {
            background: linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%);
        }

        .coach-comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.8rem;
            color: #3b82f6;
            font-weight: 600;
        }

        .coach-comment-text {
            font-size: 0.9rem;
            color: var(--gray-700);
        }

        [data-theme="dark"] .coach-comment-text {
            color: #bfdbfe;
        }

        .entry-comment-indicator {
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
            margin-left: 8px;
        }

        /* AI Assistant Styles */
        .ai-assistant-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 20px;
            margin-top: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .ai-assistant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .ai-assistant-title {
            color: white;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-expand-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-expand-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Expanded AI Assistant */
        .ai-assistant-card.expanded {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            margin: 0;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 100%;
        }

        .ai-assistant-card.expanded .ai-assistant-header {
            flex-shrink: 0;
        }

        .ai-assistant-card.expanded .ai-suggestions-bar {
            flex-shrink: 0;
        }

        .ai-assistant-card.expanded .ai-quick-actions {
            flex-shrink: 0;
        }

        .ai-assistant-card.expanded .ai-chat-messages {
            flex: 1;
            max-height: none;
            min-height: 200px;
            overflow-y: auto;
        }

        .ai-assistant-card.expanded .ai-input-container {
            flex-shrink: 0;
            margin-top: 12px;
        }

        .ai-assistant-card.expanded .ai-loading {
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .ai-assistant-card.expanded {
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 700px;
                height: 80vh;
                border-radius: 16px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            }
        }

        .ai-expanded-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
        }

        .ai-expanded-overlay.visible {
            display: block;
        }

        .ai-suggestions-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .ai-suggestion-chip {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #e2e8f0;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-suggestion-chip:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .ai-suggestion-chip.protein {
            border-color: #34d399;
            color: #34d399;
        }

        .ai-suggestion-chip.carbs {
            border-color: #60a5fa;
            color: #60a5fa;
        }

        .ai-suggestion-chip.fat {
            border-color: #f472b6;
            color: #f472b6;
        }

        .ai-suggestion-chip.ingredients {
            border-color: #fbbf24;
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .ai-chat-messages {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            display: none;
        }

        .ai-chat-messages.has-messages {
            display: block;
        }

        .ai-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .ai-message.user {
            background: var(--brand-primary);
            color: white;
            margin-left: 20%;
            border-bottom-right-radius: 4px;
        }

        .ai-message.assistant {
            background: rgba(255,255,255,0.1);
            color: #e2e8f0;
            margin-right: 20%;
            border-bottom-left-radius: 4px;
        }

        .ai-message.assistant.food-log {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            border: 1px solid #34d399;
        }

        .ai-food-log-preview {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
        }

        .ai-food-log-preview .food-name {
            font-weight: 600;
            color: #34d399;
            margin-bottom: 4px;
        }

        .ai-food-log-preview .food-macros {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .ai-food-log-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .ai-food-log-actions button {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-food-log-actions .confirm-btn {
            background: #34d399;
            color: #065f46;
            border: none;
        }

        .ai-food-log-actions .confirm-btn:hover {
            background: #6ee7b7;
        }

        .ai-food-log-actions .cancel-btn {
            background: transparent;
            color: #94a3b8;
            border: 1px solid #475569;
        }

        .ai-food-log-actions .cancel-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .ai-input-container {
            display: flex;
            gap: 8px;
        }

        .ai-input-container input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 0.95rem;
        }

        .ai-input-container input::placeholder {
            color: #64748b;
        }

        .ai-input-container input:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }

        .ai-send-btn {
            padding: 12px 20px;
            background: var(--brand-primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-send-btn:hover {
            background: #0f766e;
            transform: translateY(-1px);
        }

        .ai-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .ai-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #94a3b8;
            font-size: 0.9rem;
            padding: 12px;
        }

        .ai-loading-dots {
            display: flex;
            gap: 4px;
        }

        .ai-loading-dots span {
            width: 6px;
            height: 6px;
            background: var(--brand-primary);
            border-radius: 50%;
            animation: aiDotPulse 1.4s infinite ease-in-out both;
        }

        .ai-loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .ai-loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        .ai-loading-dots span:nth-child(3) { animation-delay: 0; }

        @keyframes aiDotPulse {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .ai-quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .ai-quick-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #94a3b8;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-quick-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* ===== ADD FOOD SECTION STYLES ===== */
        .add-food-section {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .add-food-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 12px;
        }

        .add-food-header svg {
            color: var(--brand-primary);
        }

        .add-food-options {
            display: flex;
            gap: 8px;
        }

        .add-food-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #94a3b8;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-food-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .add-food-btn:active {
            transform: scale(0.97);
        }

        .add-food-btn svg {
            opacity: 0.8;
        }

        .add-food-btn:hover svg {
            opacity: 1;
        }

        /* AI Parsing Result Card */
        .ai-parse-result {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            border: 2px solid #34d399;
            border-radius: 16px;
            padding: 16px;
            margin-top: 16px;
            animation: slideUp 0.3s ease;
            position: relative;
        }

        .ai-parse-result-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: #34d399;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .ai-parse-result-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .ai-parse-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .ai-parse-item-name {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .ai-parse-item-qty {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .ai-parse-item-cals {
            color: #34d399;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .ai-parse-totals {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 16px;
            text-align: center;
        }

        .ai-parse-total-item {
            color: white;
        }

        .ai-parse-total-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .ai-parse-total-label {
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .ai-parse-actions {
            display: flex;
            gap: 10px;
        }

        .ai-parse-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-parse-confirm-btn {
            background: #34d399;
            color: #065f46;
            border: none;
        }

        .ai-parse-confirm-btn:hover {
            background: #6ee7b7;
        }

        .ai-parse-edit-btn {
            background: transparent;
            color: #94a3b8;
            border: 1px solid #475569;
        }

        .ai-parse-edit-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* AI Hero Loading State */
        .ai-hero-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            color: #94a3b8;
        }

        .ai-hero-loading .loading-dots {
            display: flex;
            gap: 4px;
        }

        .ai-hero-loading .loading-dots span {
            width: 8px;
            height: 8px;
            background: var(--brand-primary);
            border-radius: 50%;
            animation: aiDotPulse 1.4s infinite ease-in-out both;
        }

        .ai-hero-loading .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .ai-hero-loading .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        .ai-hero-loading .loading-dots span:nth-child(3) { animation-delay: 0; }

        /* Enhanced Summary Dashboard */
        .enhanced-summary {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-100);
        }

        [data-theme="dark"] .enhanced-summary {
            background: #1e293b;
            border-color: #334155;
        }

        .summary-calories-display {
            text-align: center;
            margin-bottom: 24px;
        }

        .calories-big-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--gray-900);
            line-height: 1;
        }

        [data-theme="dark"] .calories-big-number {
            color: #f1f5f9;
        }

        .calories-goal-text {
            font-size: 1.1rem;
            color: var(--gray-400);
            font-weight: 500;
        }

        .calories-progress-bar {
            height: 12px;
            background: var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
            margin: 16px 0;
        }

        [data-theme="dark"] .calories-progress-bar {
            background: #334155;
        }

        .calories-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--brand-primary) 0%, #0284c7 100%);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .calories-progress-fill.over {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .calories-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .calories-status.on-track {
            color: #10b981;
        }

        .calories-status.over {
            color: #ef4444;
        }

        /* Macro Bars Enhanced */
        .macro-bars-enhanced {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 20px;
        }

        .macro-bar-vertical {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .macro-bar-vertical-track {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        [data-theme="dark"] .macro-bar-vertical-track {
            background: #334155;
        }

        .macro-bar-vertical-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .macro-bar-vertical-fill.protein { background: #3b82f6; }
        .macro-bar-vertical-fill.carbs { background: #f59e0b; }
        .macro-bar-vertical-fill.fat { background: #ef4444; }

        .macro-bar-vertical-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        [data-theme="dark"] .macro-bar-vertical-value {
            color: #f1f5f9;
        }

        .macro-bar-vertical-value.protein { color: #3b82f6; }
        .macro-bar-vertical-value.carbs { color: #f59e0b; }
        .macro-bar-vertical-value.fat { color: #ef4444; }

        .macro-bar-vertical-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 600;
            text-transform: uppercase;
        }

        .macro-bar-vertical-goal {
            font-size: 0.7rem;
            color: var(--gray-400);
        }

        /* Meal Timeline Styles */
        .meal-timeline {
            position: relative;
        }

        .meal-timeline-section {
            background: white;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            overflow: hidden;
            transition: all 0.2s;
        }

        [data-theme="dark"] .meal-timeline-section {
            background: #1e293b;
            border-color: #334155;
        }

        .meal-timeline-section.empty {
            border-style: dashed;
            border-color: var(--gray-200);
        }

        [data-theme="dark"] .meal-timeline-section.empty {
            border-color: #475569;
        }

        .meal-timeline-header {
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 12px;
        }

        .meal-timeline-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .meal-timeline-icon.breakfast { background: rgba(245, 158, 11, 0.15); }
        .meal-timeline-icon.lunch { background: rgba(234, 179, 8, 0.15); }
        .meal-timeline-icon.dinner { background: rgba(139, 92, 246, 0.15); }
        .meal-timeline-icon.snack { background: rgba(239, 68, 68, 0.15); }

        .meal-timeline-info {
            flex: 1;
        }

        .meal-timeline-title {
            font-weight: 700;
            color: var(--gray-900);
            font-size: 1rem;
        }

        [data-theme="dark"] .meal-timeline-title {
            color: #f1f5f9;
        }

        .meal-timeline-summary {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .meal-timeline-cals {
            font-weight: 700;
            color: var(--gray-700);
            font-size: 1rem;
        }

        [data-theme="dark"] .meal-timeline-cals {
            color: #cbd5e1;
        }

        .meal-timeline-add {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            color: var(--brand-primary);
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .meal-timeline-add:hover {
            background: var(--gray-50);
        }

        [data-theme="dark"] .meal-timeline-add:hover {
            background: #334155;
        }

        .meal-timeline-entries {
            border-top: 1px solid var(--gray-100);
        }

        [data-theme="dark"] .meal-timeline-entries {
            border-color: #334155;
        }

        /* ===== SKELETON LOADING STYLES ===== */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton {
            background: linear-gradient(90deg,
                #e2e8f0 25%,
                #f1f5f9 50%,
                #e2e8f0 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg,
                #334155 25%,
                #475569 50%,
                #334155 75%
            );
            background-size: 200% 100%;
        }

        .skeleton-search-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] .skeleton-search-result {
            background: #1e293b;
        }

        .skeleton-search-info {
            flex: 1;
        }

        .skeleton-search-name {
            height: 18px;
            width: 150px;
            margin-bottom: 8px;
        }

        .skeleton-search-meta {
            height: 14px;
            width: 100px;
        }

        .skeleton-search-btn {
            height: 36px;
            width: 70px;
            border-radius: 20px;
        }
    </style>
    <script src="https://unpkg.com/lucide@0.312.0/dist/umd/lucide.min.js" onload="lucide.createIcons()"></script>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <a href="client-dashboard.html" class="nav-brand">
            <img src="https://qewqcjzlfqamqwbccapr.supabase.co/storage/v1/object/public/assets/Untitled%20design%20(7).svg" alt="Zique Fitness" class="nav-logo-img">
        </a>
        <div class="nav-actions">
            <div class="streak-badge" id="streakBadge" title="Logging streak">
                <span><i data-lucide="flame" width="18" height="18" style="color: white;"></i></span>
                <span id="streakCount">0</span>
                <span>day streak</span>
            </div>
            <button class="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode"></button>
        </div>
    </nav>

    <div class="main-content">
        <!-- Date Navigation -->
        <div class="date-nav">
            <button class="date-nav-btn" onclick="changeDate(-1)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
            </button>
            <div class="date-display" onclick="showDatePicker()">
                <div class="date-display-main" id="dateMain">Today</div>
                <div class="date-display-sub" id="dateSub">Loading...</div>
            </div>
            <button class="date-nav-btn" onclick="changeDate(1)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </button>
        </div>

        <!-- Quick Actions Bar -->
        <div class="quick-actions">
            <button class="quick-action-btn" onclick="openCopyDayModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                </svg>
                Copy Day
            </button>
            <button class="quick-action-btn" onclick="copyFromYesterday()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12h18M3 12l6-6M3 12l6 6"/>
                </svg>
                Copy Yesterday
            </button>
            <button class="quick-action-btn" onclick="openDailyReport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                </svg>
                Daily Report
            </button>
            <button class="quick-action-btn" onclick="openWeeklySummary()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 20V10M12 20V4M6 20v-6"/>
                </svg>
                Weekly Summary
            </button>
        </div>

        <!-- Add Food Options -->
        <div class="add-food-section">
            <div class="add-food-header">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="16"/>
                    <line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
                <span>Add Food</span>
            </div>
            <div class="add-food-options">
                <button class="add-food-btn" onclick="openAITextModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 3l1.5 4.5H18l-3.5 2.5 1.5 4.5-4-3-4 3 1.5-4.5L6 7.5h4.5L12 3z"/>
                    </svg>
                    <span>AI Log</span>
                </button>
                <button class="add-food-btn" onclick="openAIPhotoModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                    <span>Photo</span>
                </button>
                <button class="add-food-btn" onclick="openFoodSearch('snack')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <span>Search</span>
                </button>
                <button class="add-food-btn" onclick="openFavoritesPicker()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <span>Favorites</span>
                </button>
            </div>
        </div>

        <!-- Summary Card -->
        <div class="summary-card">
            <div class="summary-header">
                <div class="summary-title">Calories</div>
                <button class="goals-btn" id="goalsBtn" onclick="openGoalsModal()" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                    Goals
                </button>
            </div>

            <!-- Skeleton Loading State -->
            <div class="calorie-display loading-skeleton" id="calorieSkeleton">
                <div class="skeleton skeleton-ring"></div>
                <div class="skeleton skeleton-text-lg" style="width: 60px;"></div>
                <div class="skeleton skeleton-text-sm" style="width: 70px;"></div>
                <div class="skeleton-equation">
                    <div class="skeleton-equation-item">
                        <div class="skeleton skeleton-num"></div>
                        <div class="skeleton skeleton-label"></div>
                    </div>
                    <div style="color: var(--gray-300); font-size: 1.2rem;">-</div>
                    <div class="skeleton-equation-item">
                        <div class="skeleton skeleton-num"></div>
                        <div class="skeleton skeleton-label"></div>
                    </div>
                    <div style="color: var(--gray-300); font-size: 1.2rem;">=</div>
                    <div class="skeleton-equation-item">
                        <div class="skeleton skeleton-num"></div>
                        <div class="skeleton skeleton-label"></div>
                    </div>
                </div>
                <div class="skeleton-macro-bars">
                    <div class="skeleton skeleton-macro-bar"></div>
                    <div class="skeleton skeleton-macro-bar"></div>
                    <div class="skeleton skeleton-macro-bar"></div>
                </div>
            </div>

            <!-- Actual Content (hidden until loaded) -->
            <div class="calorie-display loading-content" id="calorieContent">
                <div class="calorie-ring">
                    <svg viewBox="0 0 100 100">
                        <circle class="calorie-ring-bg" cx="50" cy="50" r="40"/>
                        <circle class="calorie-ring-progress" id="calorieRing" cx="50" cy="50" r="40"
                            stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
                    </svg>
                    <div class="calorie-ring-text">
                        <div class="calorie-remaining" id="caloriesRemaining">--</div>
                        <div class="calorie-label">Remaining</div>
                    </div>
                </div>

                <div class="calorie-equation">
                    <span>
                        <div class="value" id="calorieGoalDisplay">--</div>
                        <div>Goal</div>
                    </span>
                    <span>-</span>
                    <span>
                        <div class="value" id="caloriesConsumed">--</div>
                        <div>Food</div>
                    </span>
                    <span>=</span>
                    <span>
                        <div class="value" id="caloriesRemainingEq">--</div>
                        <div>Left</div>
                    </span>
                </div>
            </div>

            <div class="macro-bars loading-content">
                <div class="macro-bar">
                    <div class="macro-bar-header">
                        <span class="macro-bar-label protein">P:</span>
                        <span class="macro-bar-value" id="proteinValue">0/0g</span>
                    </div>
                    <div class="macro-bar-track">
                        <div class="macro-bar-fill protein" id="proteinBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="macro-bar">
                    <div class="macro-bar-header">
                        <span class="macro-bar-label carbs">C:</span>
                        <span class="macro-bar-value" id="carbsValue">0/0g</span>
                    </div>
                    <div class="macro-bar-track">
                        <div class="macro-bar-fill carbs" id="carbsBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="macro-bar">
                    <div class="macro-bar-header">
                        <span class="macro-bar-label fat">F:</span>
                        <span class="macro-bar-value" id="fatValue">0/0g</span>
                    </div>
                    <div class="macro-bar-track">
                        <div class="macro-bar-fill fat" id="fatBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Meal Sections -->
        <div id="mealSections">
            <!-- Breakfast -->
            <div class="meal-section" data-meal="breakfast">
                <div class="meal-header" onclick="toggleMeal('breakfast')">
                    <div class="meal-title">
                        <span class="meal-icon"><i data-lucide="sunrise" width="20" height="20" style="color: #f59e0b;"></i></span>
                        <span class="meal-name">Breakfast</span>
                    </div>
                    <span class="meal-calories" id="breakfastCals">0</span>
                </div>
                <div class="meal-entries" id="breakfastEntries">
                    <!-- Skeleton food items (shown during loading) -->
                    <div class="skeleton-food-items" id="breakfastSkeleton">
                        <div class="skeleton-food-item">
                            <div class="skeleton skeleton-food-icon"></div>
                            <div class="skeleton-food-content">
                                <div class="skeleton skeleton-food-name"></div>
                                <div class="skeleton skeleton-food-meta"></div>
                            </div>
                            <div class="skeleton skeleton-food-cal"></div>
                        </div>
                        <div class="skeleton-food-item">
                            <div class="skeleton skeleton-food-icon"></div>
                            <div class="skeleton-food-content">
                                <div class="skeleton skeleton-food-name" style="width: 55%;"></div>
                                <div class="skeleton skeleton-food-meta" style="width: 40%;"></div>
                            </div>
                            <div class="skeleton skeleton-food-cal"></div>
                        </div>
                    </div>
                </div>
                <div class="meal-actions">
                    <div class="add-food-btn" onclick="openFoodSearch('breakfast')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Add Food
                    </div>
                    <div class="save-meal-btn" id="saveBreakfastBtn" onclick="openSaveMealModal('breakfast')" style="display: none;">
                        <i data-lucide="heart" width="16" height="16" style="color: #ef4444;"></i> Save Meal
                    </div>
                </div>
            </div>

            <!-- Lunch -->
            <div class="meal-section" data-meal="lunch">
                <div class="meal-header" onclick="toggleMeal('lunch')">
                    <div class="meal-title">
                        <span class="meal-icon"><i data-lucide="sun" width="20" height="20" style="color: #eab308;"></i></span>
                        <span class="meal-name">Lunch</span>
                    </div>
                    <span class="meal-calories" id="lunchCals">0</span>
                </div>
                <div class="meal-entries" id="lunchEntries">
                    <div class="skeleton-food-items" id="lunchSkeleton">
                        <div class="skeleton-food-item">
                            <div class="skeleton skeleton-food-icon"></div>
                            <div class="skeleton-food-content">
                                <div class="skeleton skeleton-food-name" style="width: 65%;"></div>
                                <div class="skeleton skeleton-food-meta" style="width: 45%;"></div>
                            </div>
                            <div class="skeleton skeleton-food-cal"></div>
                        </div>
                        <div class="skeleton-food-item">
                            <div class="skeleton skeleton-food-icon"></div>
                            <div class="skeleton-food-content">
                                <div class="skeleton skeleton-food-name" style="width: 60%;"></div>
                                <div class="skeleton skeleton-food-meta" style="width: 35%;"></div>
                            </div>
                            <div class="skeleton skeleton-food-cal"></div>
                        </div>
                    </div>
                </div>
                <div class="meal-actions">
                    <div class="add-food-btn" onclick="openFoodSearch('lunch')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Add Food
                    </div>
                    <div class="save-meal-btn" id="saveLunchBtn" onclick="openSaveMealModal('lunch')" style="display: none;">
                        <i data-lucide="heart" width="16" height="16" style="color: #ef4444;"></i> Save Meal
                    </div>
                </div>
            </div>

            <!-- Dinner -->
            <div class="meal-section" data-meal="dinner">
                <div class="meal-header" onclick="toggleMeal('dinner')">
                    <div class="meal-title">
                        <span class="meal-icon"><i data-lucide="moon" width="20" height="20" style="color: #8b5cf6;"></i></span>
                        <span class="meal-name">Dinner</span>
                    </div>
                    <span class="meal-calories" id="dinnerCals">0</span>
                </div>
                <div class="meal-entries" id="dinnerEntries">
                    <div class="skeleton-food-items" id="dinnerSkeleton">
                        <div class="skeleton-food-item">
                            <div class="skeleton skeleton-food-icon"></div>
                            <div class="skeleton-food-content">
                                <div class="skeleton skeleton-food-name" style="width: 75%;"></div>
                                <div class="skeleton skeleton-food-meta" style="width: 50%;"></div>
                            </div>
                            <div class="skeleton skeleton-food-cal"></div>
                        </div>
                        <div class="skeleton-food-item">
                            <div class="skeleton skeleton-food-icon"></div>
                            <div class="skeleton-food-content">
                                <div class="skeleton skeleton-food-name" style="width: 50%;"></div>
                                <div class="skeleton skeleton-food-meta" style="width: 40%;"></div>
                            </div>
                            <div class="skeleton skeleton-food-cal"></div>
                        </div>
                    </div>
                </div>
                <div class="meal-actions">
                    <div class="add-food-btn" onclick="openFoodSearch('dinner')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Add Food
                    </div>
                    <div class="save-meal-btn" id="saveDinnerBtn" onclick="openSaveMealModal('dinner')" style="display: none;">
                        <i data-lucide="heart" width="16" height="16" style="color: #ef4444;"></i> Save Meal
                    </div>
                </div>
            </div>

            <!-- Snacks -->
            <div class="meal-section" data-meal="snack">
                <div class="meal-header" onclick="toggleMeal('snack')">
                    <div class="meal-title">
                        <span class="meal-icon"><i data-lucide="apple" width="20" height="20" style="color: #ef4444;"></i></span>
                        <span class="meal-name">Snacks</span>
                    </div>
                    <span class="meal-calories" id="snackCals">0</span>
                </div>
                <div class="meal-entries" id="snackEntries">
                    <div class="skeleton-food-items" id="snackSkeleton">
                        <div class="skeleton-food-item">
                            <div class="skeleton skeleton-food-icon"></div>
                            <div class="skeleton-food-content">
                                <div class="skeleton skeleton-food-name" style="width: 55%;"></div>
                                <div class="skeleton skeleton-food-meta" style="width: 35%;"></div>
                            </div>
                            <div class="skeleton skeleton-food-cal"></div>
                        </div>
                    </div>
                </div>
                <div class="meal-actions">
                    <div class="add-food-btn" onclick="openFoodSearch('snack')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Add Food
                    </div>
                    <div class="save-meal-btn" id="saveSnackBtn" onclick="openSaveMealModal('snack')" style="display: none;">
                        <i data-lucide="heart" width="16" height="16" style="color: #ef4444;"></i> Save Meal
                    </div>
                </div>
            </div>
        </div>

        <!-- Water Tracking Card -->
        <div class="water-card" style="margin-top: 16px;">
            <div class="water-header">
                <div class="water-title">
                    <i data-lucide="droplets" width="20" height="20" style="color: #06b6d4;"></i>
                    Water Intake
                </div>
                <button class="water-goal-btn" onclick="openWaterGoalModal()">Goal: <span id="waterGoalDisplay">8</span> glasses</button>
            </div>
            <div class="water-progress">
                <div class="water-glasses" id="waterGlasses">
                    <!-- Glasses rendered by JS -->
                </div>
                <div class="water-stats">
                    <div class="water-amount"><span id="waterCurrent">0</span>/<span id="waterGoalAmount">8</span></div>
                    <div class="water-target">glasses today</div>
                </div>
            </div>
            <div class="water-buttons">
                <button class="water-btn" onclick="addWater(1)">+1 Glass</button>
                <button class="water-btn" onclick="addWater(2)">+2 Glasses</button>
                <button class="water-btn" onclick="removeWater(1)">-1</button>
                <button class="water-btn primary" onclick="completeWaterGoal()">Complete Goal</button>
            </div>
        </div>

        <!-- AI Assistant Overlay (for expanded mode) -->
        <div class="ai-expanded-overlay" id="aiExpandedOverlay" onclick="toggleAIExpand()"></div>

        <!-- AI Nutrition Assistant -->
        <div class="ai-assistant-card" id="aiAssistantCard">
            <div class="ai-assistant-header">
                <div class="ai-assistant-title">
                    <span></span>
                    AI Nutrition Assistant
                </div>
                <button class="ai-expand-btn" onclick="toggleAIExpand()" id="aiExpandBtn">
                    <span id="aiExpandIcon"></span>
                    <span id="aiExpandText">Expand</span>
                </button>
            </div>

            <!-- Smart Suggestions based on macro gaps -->
            <div class="ai-suggestions-bar" id="aiSuggestions">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Quick Action Buttons -->
            <div class="ai-quick-actions">
                <button class="ai-quick-btn" onclick="askAI('What should I eat to hit my protein goal?')"><i data-lucide="dumbbell" width="14" height="14" style="color: #ef4444;"></i> Need protein</button>
                <button class="ai-quick-btn" onclick="askAI('Give me a healthy snack idea')"><i data-lucide="apple" width="14" height="14" style="color: #ef4444;"></i> Snack ideas</button>
                <button class="ai-quick-btn" onclick="askAI('How am I doing today?')"><i data-lucide="bar-chart-3" width="14" height="14" style="color: #10b981;"></i> My progress</button>
                <button class="ai-quick-btn" onclick="askAI('What can I eat for dinner?')"><i data-lucide="utensils" width="14" height="14" style="color: #8b5cf6;"></i> Dinner ideas</button>
            </div>

            <!-- Chat Messages -->
            <div class="ai-chat-messages" id="aiChatMessages">
                <!-- Messages populated by JavaScript -->
            </div>

            <!-- Loading State -->
            <div class="ai-loading" id="aiLoading" style="display: none;">
                <div class="ai-loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span>Thinking...</span>
            </div>

            <!-- Input -->
            <div class="ai-input-container">
                <input type="text" id="aiInput" placeholder="Ask me anything or log food... (e.g., 'log 2 eggs and toast')" onkeydown="handleAIKeydown(event)">
                <button class="ai-send-btn" onclick="sendAIMessage()" id="aiSendBtn">
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- Food Search Modal -->
    <div class="modal-overlay" id="searchModal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="modal-close" onclick="closeFoodSearch()">&times;</button>
                <div class="search-input-wrapper">
                    <input type="text" class="search-input" id="foodSearchInput"
                        placeholder="Search for food..." autocomplete="off">
                </div>
            </div>
            <div class="modal-body">
                <div class="search-results" id="searchResults">
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <p>Type to search for foods</p>
                    </div>
                </div>

                <div class="quick-add-section">
                    <div class="quick-add-title">Or try these options</div>
                    <button class="quick-add-btn" onclick="openAIPhotoModal()" style="margin-bottom: 10px;">
                        <div class="quick-add-icon" style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);">
                            <i data-lucide="camera" width="24" height="24"></i>
                        </div>
                        <div class="quick-add-text">
                            <div class="quick-add-text-main">AI Photo Log</div>
                            <div class="quick-add-text-sub">Snap a pic, AI estimates calories</div>
                        </div>
                    </button>
                    <button class="quick-add-btn" onclick="openAITextModal()" style="margin-bottom: 10px;">
                        <div class="quick-add-icon" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                            <i data-lucide="mic" width="24" height="24"></i>
                        </div>
                        <div class="quick-add-text">
                            <div class="quick-add-text-main">AI Voice/Text Log</div>
                            <div class="quick-add-text-sub">Speak or type what you ate</div>
                        </div>
                    </button>
                    <button class="quick-add-btn" onclick="openBarcodeScanner()" style="margin-bottom: 10px;">
                        <div class="quick-add-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);">
                            <i data-lucide="scan-barcode" width="24" height="24"></i>
                        </div>
                        <div class="quick-add-text">
                            <div class="quick-add-text-main">Scan Barcode</div>
                            <div class="quick-add-text-sub">Use camera to scan product</div>
                        </div>
                    </button>
                    <button class="quick-add-btn" onclick="openQuickAdd()">
                        <div class="quick-add-icon"><i data-lucide="plus" width="24" height="24"></i></div>
                        <div class="quick-add-text">
                            <div class="quick-add-text-main">Quick Add</div>
                            <div class="quick-add-text-sub">Enter calories & macros manually</div>
                        </div>
                    </button>
                    <button class="quick-add-btn" onclick="openMealPlanPicker()" style="margin-top: 10px;">
                        <div class="quick-add-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <i data-lucide="clipboard-list" width="24" height="24"></i>
                        </div>
                        <div class="quick-add-text">
                            <div class="quick-add-text-main">From Meal Plan</div>
                            <div class="quick-add-text-sub">Add meals from your diet plans</div>
                        </div>
                    </button>
                    <button class="quick-add-btn" onclick="openFavoritesPicker()" style="margin-top: 10px;">
                        <div class="quick-add-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                            <i data-lucide="heart" width="24" height="24"></i>
                        </div>
                        <div class="quick-add-text">
                            <div class="quick-add-text-main">From Favorites</div>
                            <div class="quick-add-text-sub">Add your saved favorite meals</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div class="modal-overlay" id="barcodeModal">
        <div class="modal-content" style="background: #000;">
            <div class="modal-header" style="background: #000; border-bottom: 1px solid #333;">
                <button class="modal-close" onclick="closeBarcodeScanner()" style="color: white;">&times;</button>
                <span style="color: white; font-weight: 600;">Scan Barcode</span>
            </div>
            <div class="modal-body" style="padding: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px;">
                <div id="barcode-scanner" style="width: 100%; max-width: 500px;"></div>
                <div id="barcode-status" style="color: white; text-align: center; padding: 20px;">
                    <p>Point camera at barcode</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Barcode Result Modal -->
    <div class="modal-overlay" id="barcodeResultModal">
        <div class="quick-add-modal">
            <h2 style="margin-bottom: 16px; color: var(--gray-900);">Product Found</h2>
            <div id="barcodeProductInfo">
                <div class="product-image" id="productImage" style="text-align: center; margin-bottom: 16px;"></div>
                <div class="product-name" id="productName" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;"></div>
                <div class="product-brand" id="productBrand" style="font-size: 0.9rem; color: var(--gray-500); margin-bottom: 16px;"></div>
                <div class="product-nutrition" style="background: var(--gray-100); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700;" id="prodCalories">--</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">Calories</div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #3b82f6;" id="prodProtein">--</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">Protein</div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #f59e0b;" id="prodCarbs">--</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">Carbs</div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #ef4444;" id="prodFat">--</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">Fat</div>
                        </div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--gray-500); text-align: center; margin-top: 8px;" id="prodServing">per 100g</div>
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Servings</label>
                    <input type="number" id="barcodeServings" value="1" step="0.5" min="0.5" style="width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem;">
                </div>
            </div>
            <div class="form-row">
                <button type="button" class="btn btn-secondary" onclick="closeBarcodeResult()" style="flex:1">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addBarcodeFood()" style="flex:1">Add Food</button>
            </div>
        </div>
    </div>

    <!-- Food Selection Modal (for search results) -->
    <div class="modal-overlay" id="foodSelectModal">
        <div class="quick-add-modal">
            <h2 style="margin-bottom: 16px; color: var(--gray-900);">Add Food</h2>
            <div id="foodSelectInfo">
                <div class="product-name" id="selectFoodName" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 4px;"></div>
                <div class="product-brand" id="selectFoodBrand" style="font-size: 0.9rem; color: var(--gray-500); margin-bottom: 16px;"></div>
                <div class="product-nutrition" style="background: var(--gray-100); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700;" id="selectCalories">--</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">Calories</div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #3b82f6;" id="selectProtein">--</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">Protein</div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #f59e0b;" id="selectCarbs">--</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">Carbs</div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #ef4444;" id="selectFat">--</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">Fat</div>
                        </div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--gray-500); text-align: center; margin-top: 8px;" id="selectServingInfo">per serving</div>
                </div>
                <div class="form-row" style="margin-bottom: 16px; gap: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label style="font-weight: 600; margin-bottom: 6px; display: block;">Amount</label>
                        <input type="number" id="selectServings" value="1" step="0.5" min="0.5" style="width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem;" oninput="updateFoodSelectPreview()">
                    </div>
                    <div class="form-group" style="flex: 1.5;">
                        <label style="font-weight: 600; margin-bottom: 6px; display: block;">Serving Type</label>
                        <select id="selectServingType" style="width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem; background: white; color: #333; -webkit-appearance: menulist;" onchange="updateServingType()">
                            <option value="100|g">100g</option>
                        </select>
                    </div>
                </div>
                <div id="selectTotalPreview" style="background: var(--primary-100); border-radius: 12px; padding: 12px; margin-bottom: 16px; text-align: center;">
                    <div style="font-size: 0.85rem; color: var(--gray-600); margin-bottom: 4px;">Total to add:</div>
                    <div style="font-weight: 700; color: var(--primary-600);">
                        <span id="selectTotalCals">0</span> cal |
                        P: <span id="selectTotalProtein">0</span>g |
                        C: <span id="selectTotalCarbs">0</span>g |
                        F: <span id="selectTotalFat">0</span>g
                    </div>
                </div>
            </div>
            <div class="form-row">
                <button type="button" class="btn btn-secondary" onclick="closeFoodSelect()" style="flex:1">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addSelectedFood()" style="flex:1">Add Food</button>
            </div>
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div class="modal-overlay" id="quickAddModal">
        <div class="quick-add-modal">
            <h2 style="margin-bottom: 20px; color: var(--gray-900);">Quick Add</h2>
            <form class="quick-add-form" onsubmit="submitQuickAdd(event)">
                <div class="form-group">
                    <label>Food Name</label>
                    <input type="text" id="quickFoodName" placeholder="e.g., Homemade salad" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Calories</label>
                        <input type="number" id="quickCalories" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label>Servings</label>
                        <input type="number" id="quickServings" value="1" step="0.5" min="0.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Protein (g)</label>
                        <input type="number" id="quickProtein" placeholder="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Carbs (g)</label>
                        <input type="number" id="quickCarbs" placeholder="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Fat (g)</label>
                        <input type="number" id="quickFat" placeholder="0" step="0.1">
                    </div>
                </div>
                <div class="form-row">
                    <button type="button" class="btn btn-secondary" onclick="closeQuickAdd()" style="flex:1">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1">Add Food</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Goals Modal -->
    <div class="modal-overlay" id="goalsModal">
        <div class="quick-add-modal">
            <h2 style="margin-bottom: 20px; color: var(--gray-900);">Daily Goals</h2>
            <form class="goals-form" onsubmit="saveGoals(event)">
                <div class="form-group">
                    <label>Calorie Goal</label>
                    <input type="number" id="goalCalories" placeholder="2000" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Protein (g)</label>
                        <input type="number" id="goalProtein" placeholder="150" step="1">
                    </div>
                    <div class="form-group">
                        <label>Carbs (g)</label>
                        <input type="number" id="goalCarbs" placeholder="200" step="1">
                    </div>
                    <div class="form-group">
                        <label>Fat (g)</label>
                        <input type="number" id="goalFat" placeholder="65" step="1">
                    </div>
                </div>
                <div class="form-row">
                    <button type="button" class="btn btn-secondary" onclick="closeGoalsModal()" style="flex:1">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1">Save Goals</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Entry Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="quick-add-modal">
            <h2 style="margin-bottom: 20px; color: var(--gray-900);">Edit Entry</h2>
            <form class="quick-add-form" onsubmit="saveEditEntry(event)">
                <input type="hidden" id="editEntryId">
                <div class="form-group">
                    <label>Food Name</label>
                    <input type="text" id="editFoodName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Servings</label>
                        <input type="number" id="editServings" step="0.5" min="0.5" required oninput="recalculateEditMacros()">
                    </div>
                    <div class="form-group">
                        <label>Calories</label>
                        <input type="number" id="editCalories" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Protein (g)</label>
                        <input type="number" id="editProtein" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Carbs (g)</label>
                        <input type="number" id="editCarbs" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Fat (g)</label>
                        <input type="number" id="editFat" step="0.1">
                    </div>
                </div>
                <div class="edit-actions">
                    <button type="button" class="btn btn-danger" onclick="deleteEntry()" style="flex:1">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()" style="flex:1">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Copy Day Modal -->
    <div class="modal-overlay" id="copyDayModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <button class="modal-close" onclick="closeCopyDayModal()">&times;</button>
                <span style="font-weight: 600; color: var(--gray-900);">Copy Day</span>
            </div>
            <div class="copy-day-options">
                <div class="copy-option" onclick="copyFromYesterday(); closeCopyDayModal();">
                    <div class="copy-option-icon yesterday"></div>
                    <div class="copy-option-text">
                        <div class="copy-option-title">Copy from Yesterday</div>
                        <div class="copy-option-desc">Add all of yesterday's meals to today</div>
                    </div>
                </div>
                <div class="copy-option" onclick="openCopyFromDatePicker()">
                    <div class="copy-option-icon pick-date"></div>
                    <div class="copy-option-text">
                        <div class="copy-option-title">Copy from Another Date</div>
                        <div class="copy-option-desc">Choose a specific date to copy meals from</div>
                    </div>
                </div>
                <div class="copy-option" onclick="openCopyToDatePicker()">
                    <div class="copy-option-icon to-date"></div>
                    <div class="copy-option-text">
                        <div class="copy-option-title">Copy Today to Another Date</div>
                        <div class="copy-option-desc">Duplicate today's meals to a future date</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Date Picker Modal -->
    <div class="modal-overlay" id="copyDatePickerModal">
        <div class="quick-add-modal">
            <h2 style="margin-bottom: 16px; color: var(--gray-900);" id="copyDatePickerTitle">Select Date</h2>
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="font-weight: 500; margin-bottom: 8px; display: block;">Date</label>
                <input type="date" id="copyDateInput" style="width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem;">
            </div>
            <div class="form-row">
                <button type="button" class="btn btn-secondary" onclick="closeCopyDatePicker()" style="flex:1">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeCopyDate()" style="flex:1">Copy</button>
            </div>
        </div>
    </div>

    <!-- Daily Report Modal -->
    <div class="modal-overlay" id="dailyReportModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <button class="modal-close" onclick="closeDailyReport()">&times;</button>
                <span style="font-weight: 600; color: var(--gray-900);">Daily Report</span>
            </div>
            <div class="report-content" id="reportContent">
                <!-- Report content populated by JS -->
            </div>
        </div>
    </div>

    <!-- Water Goal Modal -->
    <div class="modal-overlay" id="waterGoalModal">
        <div class="quick-add-modal">
            <h2 style="margin-bottom: 16px; color: var(--gray-900);">Water Goal</h2>
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="font-weight: 500; margin-bottom: 8px; display: block;">Daily water goal (glasses)</label>
                <input type="number" id="waterGoalInput" min="1" max="20" value="8" style="width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem;">
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-top: 8px;">1 glass = 8 oz (240ml)</p>
            </div>
            <div class="form-row">
                <button type="button" class="btn btn-secondary" onclick="closeWaterGoalModal()" style="flex:1">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWaterGoal()" style="flex:1">Save</button>
            </div>
        </div>
    </div>

    <!-- AI Photo Modal -->
    <div class="modal-overlay" id="aiPhotoModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <button class="modal-close" onclick="closeAIPhotoModal()">&times;</button>
                <span style="font-weight: 600; color: var(--gray-900);"> AI Photo Log</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div id="aiPhotoUpload">
                    <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
                        <div class="photo-upload-icon"></div>
                        <div class="photo-upload-text">Tap to take a photo or upload</div>
                        <div class="photo-upload-hint">AI will analyze your food and estimate calories</div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoSelect(event)">
                </div>

                <!-- Optional food details input - shown after photo is selected -->
                <div id="photoDetailsSection" style="display: none; margin-top: 16px;">
                    <label style="font-weight: 500; color: var(--gray-700); font-size: 0.9rem; display: block; margin-bottom: 8px;">
                        Add details (optional)
                    </label>
                    <input type="text" id="photoFoodDetails"
                        placeholder="e.g., black tea unsweetened, turkey sandwich..."
                        onkeypress="if(event.key === 'Enter') analyzePhotoWithAI()"
                        style="width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 0.95rem; box-sizing: border-box;">
                    <p style="font-size: 0.8rem; color: var(--gray-500); margin-top: 6px;">
                        Help AI identify drinks or specific ingredients
                    </p>
                    <button type="button" class="btn btn-primary" onclick="analyzePhotoWithAI()" style="width: 100%; margin-top: 12px;">
                        Analyze Photo
                    </button>
                    <button type="button" onclick="analyzePhotoWithAI()" style="width: 100%; margin-top: 8px; background: none; border: none; color: var(--gray-500); font-size: 0.85rem; cursor: pointer; text-decoration: underline;">
                        Skip details, analyze now
                    </button>
                </div>

                <div id="aiAnalyzing" style="display: none;">
                    <div class="ai-analyzing">
                        <div class="ai-analyzing-spinner"></div>
                        <div class="ai-analyzing-text">Analyzing your food...</div>
                        <p style="color: var(--gray-500); font-size: 0.85rem; margin-top: 8px;">This may take a few seconds</p>
                    </div>
                </div>

                <div id="aiResults" style="display: none;">
                    <div class="ai-results">
                        <div class="ai-results-header">
                            <span></span>
                            AI Detection Results
                        </div>
                        <div id="aiDetectedItems">
                            <!-- Items will be rendered here -->
                        </div>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 16px; text-align: center;">
                         AI estimates may vary. Feel free to adjust values before adding.
                    </p>
                    <div class="form-row">
                        <button type="button" class="btn btn-secondary" onclick="resetAIPhoto()" style="flex:1">Try Another</button>
                        <button type="button" class="btn btn-primary" onclick="addAIDetectedFoods()" style="flex:1">Add All to Diary</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Text/Voice Log Modal -->
    <div class="modal-overlay" id="aiTextModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <button class="modal-close" onclick="closeAITextModal()">&times;</button>
                <span style="font-weight: 600; color: var(--gray-900); display: flex; align-items: center; gap: 8px;"><i data-lucide="mic" width="20" height="20"></i> AI Voice/Text Log</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div id="aiTextInput">
                    <p style="color: var(--gray-600); margin-bottom: 16px; font-size: 0.95rem;">
                        Describe what you ate and AI will estimate the calories and macros.
                    </p>

                    <!-- Text input with mic button -->
                    <div style="position: relative;">
                        <textarea id="foodDescriptionInput"
                            placeholder="e.g., 2 scrambled eggs with toast and black coffee..."
                            rows="3"
                            style="width: 100%; padding: 12px; padding-right: 50px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem; resize: none; box-sizing: border-box;"></textarea>
                        <button type="button" id="voiceInputBtn" onclick="toggleVoiceInput()"
                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                            <i data-lucide="mic" width="20" height="20" style="color: white;"></i>
                        </button>
                    </div>

                    <!-- Voice status -->
                    <div id="voiceStatus" style="display: none; margin-top: 8px; padding: 8px 12px; background: #f0fdf4; border-radius: 8px; color: #166534; font-size: 0.85rem;">
                        <span id="voiceStatusText" style="display: flex; align-items: center; gap: 6px;"><i data-lucide="mic" width="16" height="16"></i> Listening...</span>
                    </div>

                    <!-- Browser support warning -->
                    <div id="voiceNotSupported" style="display: none; margin-top: 8px; padding: 8px 12px; background: #fef3c7; border-radius: 8px; color: #92400e; font-size: 0.85rem;">
                         Voice input not supported in this browser. Please type instead.
                    </div>

                    <button type="button" class="btn btn-primary" onclick="analyzeTextWithAI()" style="width: 100%; margin-top: 16px;">
                        Analyze Food
                    </button>
                </div>

                <div id="aiTextAnalyzing" style="display: none;">
                    <div class="ai-analyzing">
                        <div class="ai-analyzing-spinner"></div>
                        <div class="ai-analyzing-text">Analyzing your food...</div>
                        <p style="color: var(--gray-500); font-size: 0.85rem; margin-top: 8px;">This may take a few seconds</p>
                    </div>
                </div>

                <div id="aiTextResults" style="display: none;">
                    <div class="ai-results">
                        <div class="ai-results-header">
                            <span></span>
                            AI Detection Results
                        </div>
                        <div id="aiTextDetectedItems">
                            <!-- Items will be rendered here -->
                        </div>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 16px; text-align: center;">
                         AI estimates may vary. Feel free to adjust values before adding.
                    </p>
                    <div class="form-row">
                        <button type="button" class="btn btn-secondary" onclick="resetAIText()" style="flex:1">Try Again</button>
                        <button type="button" class="btn btn-primary" onclick="addAITextFoods()" style="flex:1">Add All to Diary</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weight Log Modal -->
    <div class="modal-overlay" id="weightLogModal">
        <div class="quick-add-modal">
            <h2 style="margin-bottom: 16px; color: var(--gray-900);">Log Weight</h2>
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="font-weight: 500; margin-bottom: 8px; display: block;">Weight (lbs)</label>
                <input type="number" id="weightInput" step="0.1" placeholder="e.g., 165.5" style="width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem;">
            </div>
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="font-weight: 500; margin-bottom: 8px; display: block;">Date</label>
                <input type="date" id="weightDateInput" style="width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem;">
            </div>
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="font-weight: 500; margin-bottom: 8px; display: block;">Notes (optional)</label>
                <input type="text" id="weightNotesInput" placeholder="e.g., After morning workout" style="width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem;">
            </div>
            <div class="form-row">
                <button type="button" class="btn btn-secondary" onclick="closeWeightLogModal()" style="flex:1">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWeight()" style="flex:1">Save</button>
            </div>
        </div>
    </div>

    <!-- Weekly Summary Modal -->
    <div class="modal-overlay" id="weeklySummaryModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <button class="modal-close" onclick="closeWeeklySummary()">&times;</button>
                <span style="font-weight: 600; color: var(--gray-900);"> Weekly Summary</span>
            </div>
            <div class="weekly-chart-container" id="weeklySummaryContent">
                <!-- Content populated by JS -->
            </div>
        </div>
    </div>

    <!-- Meal Plan Picker Modal -->
    <div class="modal-overlay" id="mealPlanPickerModal">
        <div class="modal-content" style="max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <button class="modal-close" onclick="closeMealPlanPicker()">&times;</button>
                <span style="font-weight: 600; color: var(--gray-900);">Add from Meal Plan</span>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 0;">
                <!-- Plan Selection View -->
                <div id="planSelectionView">
                    <div style="padding: 16px;">
                        <p style="color: var(--gray-500); font-size: 0.9rem; margin-bottom: 16px;">Select a meal plan to add meals from:</p>
                    </div>
                    <div id="mealPlansList" style="padding: 0 16px 16px;">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <p>Loading meal plans...</p>
                        </div>
                    </div>
                </div>

                <!-- Meals View (shown after selecting a plan) -->
                <div id="mealsSelectionView" style="display: none;">
                    <div style="padding: 16px; border-bottom: 1px solid var(--gray-200);">
                        <button onclick="showPlanSelection()" style="background: none; border: none; color: var(--brand-primary); font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 18l-6-6 6-6"/>
                            </svg>
                            Back to plans
                        </button>
                        <h3 id="selectedPlanName" style="margin-top: 12px; color: var(--gray-900);"></h3>
                    </div>
                    <div id="planMealsList" style="padding: 16px;">
                        <!-- Meals will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Favorites Picker Modal -->
    <div class="modal-overlay" id="favoritesPickerModal">
        <div class="modal-content" style="max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <button class="modal-close" onclick="closeFavoritesPicker()">&times;</button>
                <span style="font-weight: 600; color: var(--gray-900); display: flex; align-items: center; gap: 8px;"><i data-lucide="heart" width="18" height="18" style="color: #ef4444;"></i> Add from Favorites</span>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 16px;">
                <p style="color: var(--gray-500); font-size: 0.9rem; margin-bottom: 16px;">Tap a favorite meal to add it to your diary:</p>
                <div id="favoritesList">
                    <div class="empty-state">
                        <div class="empty-icon"><i data-lucide="heart" width="32" height="32" style="color: #ef4444;"></i></div>
                        <p>Loading favorites...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Meal to Favorites Modal -->
    <div class="modal-overlay" id="saveMealModal">
        <div class="quick-add-modal">
            <h2 style="margin-bottom: 16px; color: var(--gray-900); display: flex; align-items: center; gap: 8px;"><i data-lucide="heart" width="24" height="24" style="color: #ef4444;"></i> Save Meal to Favorites</h2>
            <p style="color: var(--gray-500); font-size: 0.9rem; margin-bottom: 16px;">
                Save all items in this meal as one favorite for quick logging later.
            </p>
            <input type="hidden" id="saveMealType">
            <div class="form-group" style="margin-bottom: 16px;">
                <label style="font-weight: 600; margin-bottom: 6px; display: block;">Meal Name</label>
                <input type="text" id="saveMealName" placeholder="e.g., My Morning Breakfast" style="width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem;">
            </div>
            <div id="saveMealPreview" style="background: var(--gray-100); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <!-- Items preview will be shown here -->
            </div>
            <div class="form-row">
                <button type="button" class="btn btn-secondary" onclick="closeSaveMealModal()" style="flex:1">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMealToFavorites()" style="flex:1; background: #dc2626; display: flex; align-items: center; justify-content: center; gap: 6px;"><i data-lucide="heart" width="16" height="16"></i> Save</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Hidden date input -->
    <input type="date" id="datePicker" style="display: none;">

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="client-dashboard.html" class="bottom-nav-item">
            <div class="nav-icon">
                <i data-lucide="home" width="24" height="24"></i>
            </div>
            <span class="nav-label">Home</span>
        </a>
        <a href="client-diary.html" class="bottom-nav-item active">
            <div class="nav-icon">
                <i data-lucide="notebook-pen" width="24" height="24"></i>
            </div>
            <span class="nav-label">Diary</span>
        </a>
        <a href="client-plans.html" class="bottom-nav-item">
            <div class="nav-icon">
                <i data-lucide="utensils" width="24" height="24"></i>
            </div>
            <span class="nav-label">Meal Plans</span>
        </a>
        <a href="client-settings.html" class="bottom-nav-item">
            <div class="nav-icon">
                <i data-lucide="user" width="24" height="24"></i>
            </div>
            <span class="nav-label">Profile</span>
        </a>
    </nav>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- API Helper for authenticated calls -->
    <script src="/js/api-helper.js"></script>
    <!-- Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://qewqcjzlfqamqwbccapr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFld3FjanpsZnFhbXF3YmNjYXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2OTg0NzAsImV4cCI6MjA3OTI3NDQ3MH0.mQnMC33O88oLkLLGWD2oG-oaSHGI-NfHmtQCZxnxSLs';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let clientId = null;
        let coachId = null;
        let clientFirstName = null;
        let currentDate = new Date();
        let currentMealType = 'breakfast';
        let goals = { calorie_goal: 2000, protein_goal: 150, carbs_goal: 200, fat_goal: 65 };
        let entries = [];
        let searchTimeout = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('=== Food Diary v2.4 Initializing ===');

            // Update UI immediately (doesn't need auth)
            setupSearchListener();
            updateDateDisplay();

            // Run auth check
            await checkAuth();
            console.log('After checkAuth - clientId:', clientId);

            // Check if clientId is set (more reliable than return value)
            if (!clientId) {
                console.log('No clientId set, stopping initialization');
                document.getElementById('dateSub').textContent = 'Please log in';
                return;
            }

            // Auth succeeded - load data
            console.log('clientId is set, loading data...');

            try {
                await loadDiaryEntries();
                // Goals are already loaded by loadDiaryEntries() from the food-diary endpoint
                console.log('Initial data loaded successfully');

                // Check for action query parameter (from dashboard redirects)
                const urlParams = new URLSearchParams(window.location.search);
                const action = urlParams.get('action');
                if (action) {
                    // Clear the URL parameter
                    window.history.replaceState({}, document.title, window.location.pathname);

                    // Open the corresponding modal after a short delay
                    setTimeout(() => {
                        switch (action) {
                            case 'photo':
                                openAIPhotoModal();
                                break;
                            case 'favorites':
                                openFavoritesPicker();
                                break;
                            case 'barcode':
                                openBarcodeScanner();
                                break;
                            case 'search':
                                openFoodSearch('snack');
                                break;
                        }
                    }, 300);
                }
            } catch (err) {
                console.error('Error loading initial data:', err);
                showToast('Failed to load data');
            }
        });

        // Auth check
        async function checkAuth() {
            console.log('checkAuth: Starting...');
            try {
                // Try to get existing session first (faster than refresh)
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                console.log('checkAuth: Got session:', !!session, 'Error:', sessionError);

                if (!session) {
                    console.log('No session, redirecting to login');
                    window.location.href = 'client-login.html';
                    return false;
                }

                // Refresh session in background (don't block on it)
                supabaseClient.auth.refreshSession().catch(err => {
                    console.warn('Background session refresh failed:', err);
                });

                // Get client info (single query for all needed fields)
                console.log('checkAuth: Getting client info for user:', session.user.id);
                const { data: client, error: clientError } = await supabaseClient
                    .from('clients')
                    .select('id, coach_id, can_edit_goals, client_name')
                    .eq('user_id', session.user.id)
                    .single();

                if (clientError || !client) {
                    console.error('Client not found for user:', session.user.id, clientError);
                    // User might be a coach, not a client - redirect to dashboard
                    showToast('Client profile not found');
                    return false;
                }

                console.log('checkAuth: Success, clientId:', client.id);
                clientId = client.id;
                coachId = client.coach_id;

                // Initialize coach branding
                if (window.ZiqueBranding && coachId) {
                    window.ZiqueBranding.init(coachId);
                }

                // Extract first name from client_name (e.g., "John Smith" -> "John")
                clientFirstName = client.client_name?.split(' ')[0] || null;

                // Show goals button if client has permission
                const goalsBtn = document.getElementById('goalsBtn');
                if (goalsBtn && client.can_edit_goals) {
                    goalsBtn.style.display = 'flex';
                }

                return true;
            } catch (err) {
                console.error('Auth check error:', err);
                return false;
            }
        }

        // Date functions
        function updateDateDisplay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selected = new Date(currentDate);
            selected.setHours(0, 0, 0, 0);

            const diffDays = Math.round((selected - today) / (1000 * 60 * 60 * 24));

            let mainText = '';
            if (diffDays === 0) mainText = 'Today';
            else if (diffDays === -1) mainText = 'Yesterday';
            else if (diffDays === 1) mainText = 'Tomorrow';
            else mainText = currentDate.toLocaleDateString('en-US', { weekday: 'long' });

            document.getElementById('dateMain').textContent = mainText;
            document.getElementById('dateSub').textContent = currentDate.toLocaleDateString('en-US', {
                month: 'long', day: 'numeric', year: 'numeric'
            });

            // Update date picker
            document.getElementById('datePicker').value = formatDate(currentDate);
        }

        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateDateDisplay();
            loadDiaryEntries();
        }

        function showDatePicker() {
            const picker = document.getElementById('datePicker');
            picker.showPicker();
            picker.onchange = (e) => {
                currentDate = new Date(e.target.value + 'T12:00:00');
                updateDateDisplay();
                loadDiaryEntries();
            };
        }

        function formatDate(date) {
            // Use local date components to avoid UTC conversion issues
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Load goals
        async function loadGoals() {
            if (!clientId) return;

            try {
                // Use authenticated API call
                const data = await apiGet(`/.netlify/functions/calorie-goals?clientId=${clientId}`);
                if (data.goals) {
                    // Merge with defaults to avoid null/undefined values
                    goals = {
                        calorie_goal: data.goals.calorie_goal || 2000,
                        protein_goal: data.goals.protein_goal || 150,
                        carbs_goal: data.goals.carbs_goal || 200,
                        fat_goal: data.goals.fat_goal || 65
                    };
                    document.getElementById('goalCalories').value = goals.calorie_goal;
                    document.getElementById('goalProtein').value = goals.protein_goal;
                    document.getElementById('goalCarbs').value = goals.carbs_goal;
                    document.getElementById('goalFat').value = goals.fat_goal;
                }
            } catch (err) {
                console.error('Error loading goals:', err);
            }
        }

        // Loading state functions for skeleton UI
        function showLoadingState() {
            // Show skeleton placeholders
            document.getElementById('calorieSkeleton').style.display = 'block';
            document.getElementById('calorieContent').style.display = 'none';
            document.querySelectorAll('.macro-bars').forEach(el => el.style.display = 'none');

            // Show food item skeletons
            ['breakfast', 'lunch', 'dinner', 'snack'].forEach(meal => {
                const skeleton = document.getElementById(`${meal}Skeleton`);
                if (skeleton) skeleton.style.display = 'block';
            });
        }

        function hideLoadingState() {
            // Hide skeleton, show real content with fade-in animation
            document.getElementById('calorieSkeleton').style.display = 'none';
            const calorieContent = document.getElementById('calorieContent');
            calorieContent.style.display = 'block';
            calorieContent.classList.add('fade-in');

            document.querySelectorAll('.macro-bars').forEach(el => {
                el.style.display = 'flex';
                el.classList.add('fade-in');
            });

            // Hide food item skeletons
            ['breakfast', 'lunch', 'dinner', 'snack'].forEach(meal => {
                const skeleton = document.getElementById(`${meal}Skeleton`);
                if (skeleton) skeleton.style.display = 'none';
            });
        }

        // Load diary entries
        async function loadDiaryEntries() {
            if (!clientId) {
                console.log('loadDiaryEntries: No clientId, skipping');
                return;
            }

            // Show loading skeletons
            showLoadingState();

            try {
                const date = formatDate(currentDate);
                const timestamp = Date.now(); // Cache buster
                console.log('loadDiaryEntries: Fetching for clientId:', clientId, 'date:', date);
                // Use authenticated API call
                const data = await apiGet(`/.netlify/functions/food-diary?clientId=${clientId}&date=${date}&_t=${timestamp}`);
                console.log('loadDiaryEntries: Response data:', data);

                entries = data.entries || [];
                console.log('loadDiaryEntries: Loaded', entries.length, 'entries');

                // Properly merge goals with defaults to avoid undefined values
                if (data.goals && Object.keys(data.goals).length > 0) {
                    goals = {
                        calorie_goal: data.goals.calorie_goal || 2000,
                        protein_goal: data.goals.protein_goal || 150,
                        carbs_goal: data.goals.carbs_goal || 200,
                        fat_goal: data.goals.fat_goal || 65
                    };
                }
                console.log('loadDiaryEntries: Goals set to:', goals);

                // Update UI
                updateSummary(data.totals || { calories: 0, protein: 0, carbs: 0, fat: 0 });
                renderMealEntries(data.mealGroups || {});

                // Hide skeletons, show real content
                hideLoadingState();
            } catch (err) {
                console.error('Error loading diary:', err);
                showToast('Failed to load diary entries');
                // Still hide skeletons on error
                hideLoadingState();
            }
        }

        // Update summary display
        // Store current totals globally for AI assistant
        let currentTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };

        // Helper function to update remaining calories with proper styling
        function updateRemainingCaloriesDisplay(remaining) {
            const remainingEl = document.getElementById('caloriesRemaining');
            const remainingEqEl = document.getElementById('caloriesRemainingEq');
            const ring = document.getElementById('calorieRing');

            remainingEl.textContent = remaining;
            remainingEqEl.textContent = remaining;

            // Red styling when over goal (negative remaining)
            if (remaining < 0) {
                ring.style.stroke = '#ef4444';
                remainingEl.style.color = '#ef4444';
                remainingEqEl.style.color = '#ef4444';
            } else {
                ring.style.stroke = '';
                remainingEl.style.color = '';
                remainingEqEl.style.color = '';
            }
        }

        function updateSummary(totals) {
            // Store totals globally for AI assistant
            currentTotals = totals || { calories: 0, protein: 0, carbs: 0, fat: 0 };

            const consumed = totals.calories || 0;
            const calorieGoal = goals.calorie_goal || 2000;
            const remaining = calorieGoal - consumed;
            const percentage = Math.min(100, (consumed / calorieGoal) * 100) || 0;

            // Update calorie ring
            const ring = document.getElementById('calorieRing');
            const circumference = 251.2; // 2 * PI * 40
            const offset = circumference - (percentage / 100) * circumference;
            ring.style.strokeDashoffset = offset;

            // Update numbers with proper styling
            document.getElementById('calorieGoalDisplay').textContent = calorieGoal;
            document.getElementById('caloriesConsumed').textContent = consumed;
            updateRemainingCaloriesDisplay(remaining);

            // Update macro bars
            updateMacroBar('protein', totals.protein || 0, goals.protein_goal || 150);
            updateMacroBar('carbs', totals.carbs || 0, goals.carbs_goal || 200);
            updateMacroBar('fat', totals.fat || 0, goals.fat_goal || 65);

            // Update AI suggestions (wrapped in try-catch to not break diary)
            try {
                if (typeof updateAISuggestions === 'function') {
                    updateAISuggestions();
                }
            } catch (e) {
                console.warn('AI suggestions update failed:', e);
            }
        }

        function updateMacroBar(macro, current, goal) {
            const percentage = Math.min(100, (current / goal) * 100);
            document.getElementById(`${macro}Bar`).style.width = `${percentage}%`;
            document.getElementById(`${macro}Value`).textContent = `${Math.round(current)}/${goal}g`;
        }

        // Render meal entries
        function renderMealEntries(mealGroups) {
            const meals = ['breakfast', 'lunch', 'dinner', 'snack'];

            meals.forEach(meal => {
                const container = document.getElementById(`${meal}Entries`);
                const mealEntries = mealGroups[meal] || [];
                const totalCals = mealEntries.reduce((sum, e) => sum + (e.calories || 0), 0);

                document.getElementById(`${meal}Cals`).textContent = totalCals;

                if (mealEntries.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = mealEntries.map(entry => {
                    // Format serving display
                    const servingNum = entry.number_of_servings || 1;
                    const servingSize = entry.serving_size || 1;
                    const servingUnit = entry.serving_unit || 'serving';
                    const servingDisplay = servingSize === 1
                        ? `${servingNum} ${servingUnit}${servingNum !== 1 ? 's' : ''}`
                        : `${servingNum} x ${servingSize}${servingUnit}`;

                    return `
                    <div class="swipe-container" id="entry-${entry.id}">
                        <div class="delete-action" onclick="swipeDeleteEntry(${entry.id}, '${meal}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                            </svg>
                        </div>
                        <div class="swipe-content food-entry" onclick="openEditModal(${entry.id})" data-entry-id="${entry.id}">
                            <div class="food-info">
                                <div class="food-name">${entry.food_name}</div>
                                <div class="food-details">${servingDisplay}</div>
                            </div>
                            <div class="food-calories">${entry.calories}</div>
                        </div>
                    </div>
                `}).join('');

                // Initialize swipe handlers for this container
                initSwipeHandlers(container);
            });

            // Update save meal button visibility
            updateSaveMealButtons();
        }

        // Food search
        function openFoodSearch(mealType) {
            currentMealType = mealType;
            document.getElementById('searchModal').classList.add('active');
            document.getElementById('foodSearchInput').value = '';
            document.getElementById('foodSearchInput').focus();
            document.getElementById('searchResults').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon"></div>
                    <p>Type to search for foods</p>
                </div>
            `;
        }

        function closeFoodSearch() {
            document.getElementById('searchModal').classList.remove('active');
        }

        function setupSearchListener() {
            const input = document.getElementById('foodSearchInput');
            if (!input) {
                console.error('Food search input not found!');
                return;
            }
            console.log('Search listener setup on:', input);
            input.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                console.log('Search input event - query:', query);

                if (query.length < 2) {
                    document.getElementById('searchResults').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <p>Type to search for foods</p>
                        </div>
                    `;
                    return;
                }

                document.getElementById('searchResults').innerHTML = `
                    <div class="skeleton-search-result">
                        <div class="skeleton-search-info">
                            <div class="skeleton skeleton-search-name"></div>
                            <div class="skeleton skeleton-search-meta"></div>
                        </div>
                        <div class="skeleton skeleton-search-btn"></div>
                    </div>
                    <div class="skeleton-search-result">
                        <div class="skeleton-search-info">
                            <div class="skeleton skeleton-search-name"></div>
                            <div class="skeleton skeleton-search-meta"></div>
                        </div>
                        <div class="skeleton skeleton-search-btn"></div>
                    </div>
                    <div class="skeleton-search-result">
                        <div class="skeleton-search-info">
                            <div class="skeleton skeleton-search-name"></div>
                            <div class="skeleton skeleton-search-meta"></div>
                        </div>
                        <div class="skeleton skeleton-search-btn"></div>
                    </div>
                `;

                searchTimeout = setTimeout(() => searchFood(query), 300);
            });
        }

        async function searchFood(query) {
            console.log('searchFood called with:', query, 'clientId:', clientId);
            try {
                const url = `/.netlify/functions/food-search?query=${encodeURIComponent(query)}&clientId=${clientId}`;
                console.log('Fetching URL:', url);

                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);

                // Use authenticated API call with timeout signal
                const response = await authenticatedFetch(url, { method: 'GET', signal: controller.signal });
                clearTimeout(timeoutId);

                console.log('Response status:', response.status, response.ok);
                const data = await response.json();
                console.log('Response data:', data);

                const results = data.results || [];
                console.log('Parsed results count:', results.length);
                const container = document.getElementById('searchResults');

                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <p>No foods found. Try a different search or use Quick Add.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = results.map((food, index) => {
                    // Format serving display
                    const servingSize = food.servingSize || 1;
                    const servingUnit = food.servingUnit || 'serving';
                    const servingText = servingSize === 1 ? `1 ${servingUnit}` : `${servingSize}${servingUnit}`;

                    return `
                    <div class="search-result" onclick="selectFood(${index})">
                        <div class="search-result-name">${food.name}${food.brand ? ` (${food.brand})` : ''}</div>
                        <div class="search-result-meta">
                            <span>${food.calories} cal | P: ${food.protein}g | C: ${food.carbs}g | F: ${food.fat}g</span>
                            <span class="search-result-source">per ${servingText}</span>
                        </div>
                    </div>
                `}).join('');

                // Store results for selection
                window.searchResults = results;
            } catch (err) {
                console.error('Search error:', err);
                const isTimeout = err.name === 'AbortError';
                document.getElementById('searchResults').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <p>${isTimeout ? 'Search timed out. Please try again.' : 'Search failed. Please try again.'}</p>
                        <p style="font-size: 0.8em; color: #888; margin-top: 8px;">${err.message || 'Unknown error'}</p>
                    </div>
                `;
            }
        }

        // Currently selected food for the modal
        let selectedFood = null;
        // Current serving size and unit based on selected measure
        let currentServingWeight = 100;
        let currentServingUnit = 'g';

        // Open food selection modal instead of auto-adding
        function selectFood(index) {
            const food = window.searchResults[index];
            if (!food) return;

            console.log('selectFood called with:', food);
            selectedFood = food;

            // Populate the modal
            document.getElementById('selectFoodName').textContent = food.name;
            document.getElementById('selectFoodBrand').textContent = food.brand || '';

            // Populate serving type dropdown with available measures
            const servingTypeSelect = document.getElementById('selectServingType');
            servingTypeSelect.innerHTML = '';

            // Build measure options - use API measures if available, otherwise create defaults
            const measures = food.measures || [];
            if (measures.length > 0) {
                measures.forEach((measure, idx) => {
                    const option = document.createElement('option');
                    option.value = `${measure.weight}|${measure.label}`;
                    option.textContent = measure.label === 'Gram' ? 'Grams (1g)' :
                                         measure.label === 'Ounce' ? 'Ounce (28g)' :
                                         measure.label;
                    // Select "Serving" by default if available
                    if (measure.label === 'Serving' || (idx === 0 && !measures.find(m => m.label === 'Serving'))) {
                        option.selected = true;
                    }
                    servingTypeSelect.appendChild(option);
                });
            } else {
                // Fallback options for common foods or when no measures available
                const defaultMeasures = [
                    { weight: food.servingSize || 100, label: food.servingUnit || 'serving' },
                    { weight: 100, label: 'g (100g)' },
                    { weight: 28, label: 'oz' }
                ];
                defaultMeasures.forEach((measure, idx) => {
                    const option = document.createElement('option');
                    option.value = `${measure.weight}|${measure.label}`;
                    option.textContent = measure.label;
                    if (idx === 0) option.selected = true;
                    servingTypeSelect.appendChild(option);
                });
            }

            // Set initial serving weight and unit from selected option
            updateServingType();

            // Reset servings to 1
            document.getElementById('selectServings').value = 1;

            // Update preview
            updateFoodSelectPreview();

            // Close search and show modal
            closeFoodSearch();
            document.getElementById('foodSelectModal').classList.add('active');
        }

        // Update when serving type changes
        function updateServingType() {
            const select = document.getElementById('selectServingType');
            const [weight, unit] = select.value.split('|');
            currentServingWeight = parseFloat(weight) || 100;
            currentServingUnit = unit || 'serving';

            // Update the "per serving" info display
            const unitDisplay = currentServingUnit === 'Gram' ? 'g' : currentServingUnit.toLowerCase();
            document.getElementById('selectServingInfo').textContent = `per 1 ${unitDisplay} (${Math.round(currentServingWeight)}g)`;

            // Recalculate displayed nutrition values per serving
            if (selectedFood) {
                const baseCals = selectedFood.caloriesPer100g || selectedFood.calories || 0;
                const baseProtein = selectedFood.proteinPer100g || selectedFood.protein || 0;
                const baseCarbs = selectedFood.carbsPer100g || selectedFood.carbs || 0;
                const baseFat = selectedFood.fatPer100g || selectedFood.fat || 0;

                const multiplier = currentServingWeight / 100;

                document.getElementById('selectCalories').textContent = Math.round(baseCals * multiplier);
                document.getElementById('selectProtein').textContent = Math.round(baseProtein * multiplier * 10) / 10;
                document.getElementById('selectCarbs').textContent = Math.round(baseCarbs * multiplier * 10) / 10;
                document.getElementById('selectFat').textContent = Math.round(baseFat * multiplier * 10) / 10;
            }

            // Update total preview
            updateFoodSelectPreview();
        }

        // Update the preview when servings change
        function updateFoodSelectPreview() {
            if (!selectedFood) return;

            const servings = parseFloat(document.getElementById('selectServings').value) || 1;

            // Get base values per 100g
            const baseCals = selectedFood.caloriesPer100g || selectedFood.calories || 0;
            const baseProtein = selectedFood.proteinPer100g || selectedFood.protein || 0;
            const baseCarbs = selectedFood.carbsPer100g || selectedFood.carbs || 0;
            const baseFat = selectedFood.fatPer100g || selectedFood.fat || 0;

            // Calculate based on serving weight and number of servings
            const multiplier = (currentServingWeight / 100) * servings;

            const totalCals = Math.round(baseCals * multiplier);
            const totalProtein = Math.round(baseProtein * multiplier * 10) / 10;
            const totalCarbs = Math.round(baseCarbs * multiplier * 10) / 10;
            const totalFat = Math.round(baseFat * multiplier * 10) / 10;

            // Update preview display
            document.getElementById('selectTotalCals').textContent = totalCals;
            document.getElementById('selectTotalProtein').textContent = totalProtein;
            document.getElementById('selectTotalCarbs').textContent = totalCarbs;
            document.getElementById('selectTotalFat').textContent = totalFat;
        }

        // Close food selection modal
        function closeFoodSelect() {
            document.getElementById('foodSelectModal').classList.remove('active');
            selectedFood = null;
        }

        // Add the selected food with proper scaling
        async function addSelectedFood() {
            if (!selectedFood) return;

            const servings = parseFloat(document.getElementById('selectServings').value) || 1;

            // Get base values per 100g
            const baseCals = selectedFood.caloriesPer100g || selectedFood.calories || 0;
            const baseProtein = selectedFood.proteinPer100g || selectedFood.protein || 0;
            const baseCarbs = selectedFood.carbsPer100g || selectedFood.carbs || 0;
            const baseFat = selectedFood.fatPer100g || selectedFood.fat || 0;

            // Calculate final values based on serving weight and number of servings
            const multiplier = (currentServingWeight / 100) * servings;
            const scaledCalories = Math.round(baseCals * multiplier);
            const scaledProtein = Math.round(baseProtein * multiplier * 10) / 10;
            const scaledCarbs = Math.round(baseCarbs * multiplier * 10) / 10;
            const scaledFat = Math.round(baseFat * multiplier * 10) / 10;

            console.log('addSelectedFood with servings:', servings);
            console.log('Scaled values - cal:', scaledCalories, 'P:', scaledProtein, 'C:', scaledCarbs, 'F:', scaledFat);

            // Create optimistic entry with scaled values
            // Use the user-selected serving type
            const tempId = 'temp-' + Date.now();

            // Store food data before closing modal (closeFoodSelect sets selectedFood to null)
            const foodName = selectedFood.name;
            const foodBrand = selectedFood.brand;
            const foodFiber = selectedFood.fiber;
            const foodExternalId = selectedFood.externalId;
            const foodSource = selectedFood.source;

            const optimisticEntry = {
                id: tempId,
                food_name: foodName,
                number_of_servings: servings,
                serving_size: Math.round(currentServingWeight),
                serving_unit: currentServingUnit.toLowerCase(),
                calories: scaledCalories,
                protein: scaledProtein,
                carbs: scaledCarbs,
                fat: scaledFat
            };

            // Add to UI and close modal
            addOptimisticEntry(currentMealType, optimisticEntry);
            closeFoodSelect();
            showToast('Adding...');

            try {
                const payload = {
                    clientId,
                    coachId,
                    entryDate: formatDate(currentDate),
                    mealType: currentMealType,
                    foodName: foodName,
                    brand: foodBrand,
                    servingSize: Math.round(currentServingWeight),
                    servingUnit: currentServingUnit.toLowerCase(),
                    numberOfServings: servings,
                    calories: scaledCalories,
                    protein: scaledProtein,
                    carbs: scaledCarbs,
                    fat: scaledFat,
                    fiber: foodFiber,
                    externalId: foodExternalId,
                    foodSource: foodSource
                };
                console.log('POST payload:', payload);

                // Use authenticated API call
                const data = await apiPost('/.netlify/functions/food-diary', payload);
                console.log('POST response data:', data);

                // Update optimistic entry with real ID from server
                if (data.entry) {
                    updateOptimisticEntryWithRealId(tempId, data.entry, currentMealType);
                    entries.push(data.entry);
                }

                showToast('Food added!');
            } catch (err) {
                console.error('Error adding food:', err);
                removeOptimisticEntry(tempId);
                showToast('Failed to add food');
            }
        }

        // Update optimistic entry with real ID after server confirms
        function updateOptimisticEntryWithRealId(tempId, entry, mealType) {
            const tempEl = document.getElementById(`entry-${tempId}`);
            if (tempEl) {
                tempEl.id = `entry-${entry.id}`;
                tempEl.classList.remove('saving');

                // Update delete action
                const deleteAction = tempEl.querySelector('.delete-action');
                if (deleteAction) {
                    deleteAction.setAttribute('onclick', `swipeDeleteEntry(${entry.id}, '${mealType}')`);
                }

                // Update swipe content
                const swipeContent = tempEl.querySelector('.swipe-content');
                if (swipeContent) {
                    swipeContent.setAttribute('onclick', `openEditModal(${entry.id})`);
                    swipeContent.setAttribute('data-entry-id', entry.id);
                }
            }
        }

        // Add entry optimistically to UI
        function addOptimisticEntry(mealType, entry) {
            const container = document.getElementById(`${mealType}Entries`);

            // Format serving display
            const servingNum = entry.number_of_servings || 1;
            const servingSize = entry.serving_size || 1;
            const servingUnit = entry.serving_unit || 'serving';
            const servingDisplay = servingSize === 1
                ? `${servingNum} ${servingUnit}${servingNum !== 1 ? 's' : ''}`
                : `${servingNum} x ${servingSize}${servingUnit}`;

            const entryHtml = `
                <div class="swipe-container saving" id="entry-${entry.id}">
                    <div class="delete-action">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                        </svg>
                    </div>
                    <div class="swipe-content food-entry" data-entry-id="${entry.id}">
                        <div class="food-info">
                            <div class="food-name">${entry.food_name}</div>
                            <div class="food-details">${servingDisplay}</div>
                        </div>
                        <div class="food-calories">${entry.calories || 0}</div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', entryHtml);

            // Initialize swipe on new entry
            const newEntry = container.lastElementChild;
            initSwipeOnElement(newEntry);

            // Update calorie display for meal
            const calsEl = document.getElementById(`${mealType}Cals`);
            const currentMealCals = parseInt(calsEl.textContent) || 0;
            calsEl.textContent = currentMealCals + (entry.calories || 0);

            // Update total summary
            const consumedEl = document.getElementById('caloriesConsumed');
            const currentConsumed = parseInt(consumedEl.textContent) || 0;
            const newConsumed = currentConsumed + (entry.calories || 0);
            const calorieGoal = goals.calorie_goal || 2000;
            consumedEl.textContent = newConsumed;

            // Update calorie ring
            const ring = document.getElementById('calorieRing');
            const percentage = Math.min(100, (newConsumed / calorieGoal) * 100) || 0;
            const circumference = 251.2;
            const offset = circumference - (percentage / 100) * circumference;
            ring.style.strokeDashoffset = offset;

            // Update remaining with proper styling (allows negative)
            updateRemainingCaloriesDisplay(calorieGoal - newConsumed);

            // Update macro bars
            const currentProtein = parseFloat(document.getElementById('proteinValue').textContent) || 0;
            const currentCarbs = parseFloat(document.getElementById('carbsValue').textContent) || 0;
            const currentFat = parseFloat(document.getElementById('fatValue').textContent) || 0;

            updateMacroBar('protein', currentProtein + (entry.protein || 0), goals.protein_goal || 150);
            updateMacroBar('carbs', currentCarbs + (entry.carbs || 0), goals.carbs_goal || 200);
            updateMacroBar('fat', currentFat + (entry.fat || 0), goals.fat_goal || 65);
        }

        // Remove optimistic entry on failure
        function removeOptimisticEntry(tempId) {
            const el = document.getElementById(`entry-${tempId}`);
            if (el) el.remove();
            // Refresh to get correct totals
            loadDiaryEntries();
        }

        // Quick Add
        function openQuickAdd() {
            closeFoodSearch();
            document.getElementById('quickAddModal').classList.add('active');
            document.getElementById('quickFoodName').value = '';
            document.getElementById('quickCalories').value = '';
            document.getElementById('quickServings').value = '1';
            document.getElementById('quickProtein').value = '';
            document.getElementById('quickCarbs').value = '';
            document.getElementById('quickFat').value = '';
            document.getElementById('quickFoodName').focus();
        }

        function closeQuickAdd() {
            document.getElementById('quickAddModal').classList.remove('active');
        }

        async function submitQuickAdd(e) {
            e.preventDefault();

            const servings = parseFloat(document.getElementById('quickServings').value) || 1;
            const foodName = document.getElementById('quickFoodName').value;
            const calories = parseInt(document.getElementById('quickCalories').value) || 0;

            // Create optimistic entry
            const tempId = 'temp-' + Date.now();
            const optimisticEntry = {
                id: tempId,
                food_name: foodName,
                number_of_servings: servings,
                serving_unit: 'serving',
                calories: calories
            };

            // Immediately add to UI (optimistic)
            addOptimisticEntry(currentMealType, optimisticEntry);
            closeQuickAdd();
            showToast('Adding...');

            try {
                // Use authenticated API call
                const data = await apiPost('/.netlify/functions/food-diary', {
                    clientId,
                    coachId,
                    entryDate: formatDate(currentDate),
                    mealType: currentMealType,
                    foodName: foodName,
                    numberOfServings: servings,
                    calories: calories,
                    protein: parseFloat(document.getElementById('quickProtein').value) || 0,
                    carbs: parseFloat(document.getElementById('quickCarbs').value) || 0,
                    fat: parseFloat(document.getElementById('quickFat').value) || 0,
                    isQuickAdd: true,
                    foodSource: 'custom'
                });

                // Update optimistic entry with real ID from server
                if (data.entry) {
                    updateOptimisticEntryWithRealId(tempId, data.entry, currentMealType);
                    entries.push(data.entry);
                }

                showToast('Food added!');
            } catch (err) {
                console.error('Error adding food:', err);
                removeOptimisticEntry(tempId);
                showToast('Failed to add food');
            }
        }

        // Goals Modal
        function openGoalsModal() {
            document.getElementById('goalsModal').classList.add('active');
            document.getElementById('goalCalories').value = goals.calorie_goal || 2000;
            document.getElementById('goalProtein').value = goals.protein_goal || 150;
            document.getElementById('goalCarbs').value = goals.carbs_goal || 200;
            document.getElementById('goalFat').value = goals.fat_goal || 65;
        }

        function closeGoalsModal() {
            document.getElementById('goalsModal').classList.remove('active');
        }

        async function saveGoals(e) {
            e.preventDefault();

            try {
                // Use authenticated API call
                const data = await apiPost('/.netlify/functions/calorie-goals', {
                    clientId,
                    coachId,
                    calorieGoal: parseInt(document.getElementById('goalCalories').value) || 2000,
                    proteinGoal: parseInt(document.getElementById('goalProtein').value) || 150,
                    carbsGoal: parseInt(document.getElementById('goalCarbs').value) || 200,
                    fatGoal: parseInt(document.getElementById('goalFat').value) || 65
                });
                goals = data.goals;

                closeGoalsModal();
                showToast('Goals saved!');
                await loadDiaryEntries();
            } catch (err) {
                console.error('Error saving goals:', err);
                showToast('Failed to save goals');
            }
        }

        // Edit Entry Modal
        // Store base macros per serving for edit modal recalculation
        let editBaseValues = null;

        function openEditModal(entryId) {
            const entry = entries.find(e => e.id === entryId);
            if (!entry) return;

            const servings = entry.number_of_servings || 1;

            // Calculate base values per serving (divide total by servings)
            editBaseValues = {
                calories: Math.round((entry.calories || 0) / servings),
                protein: Math.round((entry.protein || 0) / servings * 10) / 10,
                carbs: Math.round((entry.carbs || 0) / servings * 10) / 10,
                fat: Math.round((entry.fat || 0) / servings * 10) / 10
            };

            document.getElementById('editModal').classList.add('active');
            document.getElementById('editEntryId').value = entryId;
            document.getElementById('editFoodName').value = entry.food_name;
            document.getElementById('editServings').value = servings;
            document.getElementById('editCalories').value = entry.calories;
            document.getElementById('editProtein').value = entry.protein || '';
            document.getElementById('editCarbs').value = entry.carbs || '';
            document.getElementById('editFat').value = entry.fat || '';
        }

        // Recalculate macros when servings change in edit modal
        function recalculateEditMacros() {
            if (!editBaseValues) return;

            const servings = parseFloat(document.getElementById('editServings').value) || 1;

            document.getElementById('editCalories').value = Math.round(editBaseValues.calories * servings);
            document.getElementById('editProtein').value = Math.round(editBaseValues.protein * servings * 10) / 10;
            document.getElementById('editCarbs').value = Math.round(editBaseValues.carbs * servings * 10) / 10;
            document.getElementById('editFat').value = Math.round(editBaseValues.fat * servings * 10) / 10;
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        async function saveEditEntry(e) {
            e.preventDefault();

            const entryId = document.getElementById('editEntryId').value;
            const oldEntry = entries.find(en => en.id == entryId);
            const mealType = oldEntry?.meal_type || 'snack';

            const newData = {
                food_name: document.getElementById('editFoodName').value,
                number_of_servings: parseFloat(document.getElementById('editServings').value) || 1,
                calories: parseInt(document.getElementById('editCalories').value) || 0,
                protein: parseFloat(document.getElementById('editProtein').value) || 0,
                carbs: parseFloat(document.getElementById('editCarbs').value) || 0,
                fat: parseFloat(document.getElementById('editFat').value) || 0
            };

            try {
                // Use authenticated API call
                await apiPut('/.netlify/functions/food-diary', {
                    entryId: parseInt(entryId),
                    foodName: newData.food_name,
                    numberOfServings: newData.number_of_servings,
                    calories: newData.calories,
                    protein: newData.protein,
                    carbs: newData.carbs,
                    fat: newData.fat
                });

                closeEditModal();

                // Update DOM element
                const entryEl = document.getElementById(`entry-${entryId}`);
                if (entryEl) {
                    entryEl.querySelector('.food-name').textContent = newData.food_name;
                    entryEl.querySelector('.food-details').textContent = `${newData.number_of_servings} serving${newData.number_of_servings != 1 ? 's' : ''}`;
                    entryEl.querySelector('.food-calories').textContent = newData.calories;
                }

                // Calculate calorie difference and update totals
                if (oldEntry) {
                    const calDiff = newData.calories - (oldEntry.calories || 0);
                    const proteinDiff = newData.protein - (oldEntry.protein || 0);
                    const carbsDiff = newData.carbs - (oldEntry.carbs || 0);
                    const fatDiff = newData.fat - (oldEntry.fat || 0);

                    // Update meal calories
                    const mealCalsEl = document.getElementById(`${mealType}Cals`);
                    if (mealCalsEl) {
                        mealCalsEl.textContent = Math.max(0, parseInt(mealCalsEl.textContent || 0) + calDiff);
                    }

                    // Update total summary
                    const consumedEl = document.getElementById('caloriesConsumed');
                    const newConsumed = Math.max(0, parseInt(consumedEl.textContent || 0) + calDiff);
                    const calorieGoal = goals.calorie_goal || 2000;
                    consumedEl.textContent = newConsumed;

                    // Update calorie ring
                    const ring = document.getElementById('calorieRing');
                    const percentage = Math.min(100, (newConsumed / calorieGoal) * 100) || 0;
                    const circumference = 251.2;
                    const offset = circumference - (percentage / 100) * circumference;
                    ring.style.strokeDashoffset = offset;

                    // Update remaining with proper styling (allows negative)
                    updateRemainingCaloriesDisplay(calorieGoal - newConsumed);

                    // Update macro bars
                    const currentProtein = parseFloat(document.getElementById('proteinValue').textContent) || 0;
                    const currentCarbs = parseFloat(document.getElementById('carbsValue').textContent) || 0;
                    const currentFat = parseFloat(document.getElementById('fatValue').textContent) || 0;

                    updateMacroBar('protein', currentProtein + proteinDiff, goals.protein_goal || 150);
                    updateMacroBar('carbs', currentCarbs + carbsDiff, goals.carbs_goal || 200);
                    updateMacroBar('fat', currentFat + fatDiff, goals.fat_goal || 65);

                    // Update local entries array
                    Object.assign(oldEntry, newData);
                }

                showToast('Entry updated!');
            } catch (err) {
                console.error('Error updating entry:', err);
                showToast('Failed to update entry');
            }
        }

        async function deleteEntry() {
            const entryId = document.getElementById('editEntryId').value;
            if (!confirm('Delete this entry?')) return;

            // Find the entry before deleting to get its data for UI update
            const entry = entries.find(e => e.id == entryId);
            const mealType = entry?.meal_type || 'snack';

            try {
                // Use authenticated DELETE call
                await authenticatedFetch(`/.netlify/functions/food-diary?entryId=${entryId}`, {
                    method: 'DELETE'
                });

                closeEditModal();

                // Remove from DOM
                const entryEl = document.getElementById(`entry-${entryId}`);
                if (entryEl) {
                    entryEl.remove();
                }

                // Remove from local entries array
                entries = entries.filter(e => e.id != entryId);

                // Update calorie displays
                if (entry) {
                    // Update meal calories
                    const mealCalsEl = document.getElementById(`${mealType}Cals`);
                    if (mealCalsEl) {
                        mealCalsEl.textContent = Math.max(0, parseInt(mealCalsEl.textContent || 0) - (entry.calories || 0));
                    }

                    // Update total summary
                    const consumedEl = document.getElementById('caloriesConsumed');
                    const newConsumed = Math.max(0, parseInt(consumedEl.textContent || 0) - (entry.calories || 0));
                    const calorieGoal = goals.calorie_goal || 2000;
                    consumedEl.textContent = newConsumed;

                    // Update calorie ring
                    const ring = document.getElementById('calorieRing');
                    const percentage = Math.min(100, (newConsumed / calorieGoal) * 100) || 0;
                    const circumference = 251.2;
                    const offset = circumference - (percentage / 100) * circumference;
                    ring.style.strokeDashoffset = offset;

                    // Update remaining with proper styling (allows negative)
                    updateRemainingCaloriesDisplay(calorieGoal - newConsumed);

                    // Update macro bars
                    updateMacroBar('protein',
                        Math.max(0, parseFloat(document.getElementById('proteinValue').textContent) - (entry.protein || 0)),
                        goals.protein_goal || 150);
                    updateMacroBar('carbs',
                        Math.max(0, parseFloat(document.getElementById('carbsValue').textContent) - (entry.carbs || 0)),
                        goals.carbs_goal || 200);
                    updateMacroBar('fat',
                        Math.max(0, parseFloat(document.getElementById('fatValue').textContent) - (entry.fat || 0)),
                        goals.fat_goal || 65);
                }

                // Update save meal button visibility
                updateSaveMealButtons();

                showToast('Entry deleted');
            } catch (err) {
                console.error('Error deleting entry:', err);
                showToast('Failed to delete entry');
            }
        }

        // Utility
        function toggleMeal(meal) {
            // Could expand/collapse meal section if needed
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Navigate to meal plan
        function goToMealPlan() {
            window.location.href = 'client-plans.html';
        }

        // ==========================================
        // Barcode Scanner Functions
        // ==========================================
        let html5QrCode = null;
        let scannedProduct = null;

        function openBarcodeScanner() {
            closeFoodSearch();
            document.getElementById('barcodeModal').classList.add('active');
            document.getElementById('barcode-status').innerHTML = '<p>Starting camera...</p>';

            // Initialize scanner
            html5QrCode = new Html5Qrcode("barcode-scanner");

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 150 },
                aspectRatio: 1.777,
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39
                ]
            };

            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onBarcodeScanned,
                (errorMessage) => {
                    // Ignore scan errors (no barcode found in frame)
                }
            ).then(() => {
                document.getElementById('barcode-status').innerHTML = '<p>Point camera at barcode</p>';
            }).catch((err) => {
                console.error('Camera error:', err);
                document.getElementById('barcode-status').innerHTML = `
                    <p style="color: #ef4444;">Camera access denied</p>
                    <p style="font-size: 0.875rem; margin-top: 8px;">Please allow camera access to scan barcodes</p>
                `;
            });
        }

        function closeBarcodeScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                }).catch(err => console.log('Scanner stop error:', err));
            }
            document.getElementById('barcodeModal').classList.remove('active');
        }

        async function onBarcodeScanned(decodedText, decodedResult) {
            // Stop scanning
            if (html5QrCode) {
                await html5QrCode.stop();
            }

            document.getElementById('barcode-status').innerHTML = '<p>Looking up product...</p>';

            // Lookup product in Open Food Facts
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${decodedText}.json`);
                const data = await response.json();

                if (data.status === 1 && data.product) {
                    const product = data.product;
                    scannedProduct = {
                        barcode: decodedText,
                        name: product.product_name || product.product_name_en || 'Unknown Product',
                        brand: product.brands || '',
                        image: product.image_small_url || product.image_url || null,
                        calories: Math.round(product.nutriments?.['energy-kcal_100g'] || product.nutriments?.['energy-kcal'] || 0),
                        protein: Math.round((product.nutriments?.proteins_100g || 0) * 10) / 10,
                        carbs: Math.round((product.nutriments?.carbohydrates_100g || 0) * 10) / 10,
                        fat: Math.round((product.nutriments?.fat_100g || 0) * 10) / 10,
                        servingSize: product.serving_size || '100g'
                    };

                    showBarcodeResult();
                } else {
                    showToast('Product not found in database');
                    document.getElementById('barcode-status').innerHTML = `
                        <p style="color: #f59e0b;">Product not found</p>
                        <p style="font-size: 0.875rem; margin-top: 8px;">Barcode: ${decodedText}</p>
                        <button onclick="restartScanner()" style="margin-top: 16px; padding: 10px 20px; background: var(--brand-primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Scan Another
                        </button>
                    `;
                }
            } catch (err) {
                console.error('Lookup error:', err);
                showToast('Error looking up product');
                document.getElementById('barcode-status').innerHTML = `
                    <p style="color: #ef4444;">Lookup failed</p>
                    <button onclick="restartScanner()" style="margin-top: 16px; padding: 10px 20px; background: var(--brand-primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Try Again
                    </button>
                `;
            }
        }

        function restartScanner() {
            closeBarcodeScanner();
            setTimeout(() => openBarcodeScanner(), 300);
        }

        function showBarcodeResult() {
            closeBarcodeScanner();

            // Populate result modal
            document.getElementById('productName').textContent = scannedProduct.name;
            document.getElementById('productBrand').textContent = scannedProduct.brand;
            document.getElementById('prodCalories').textContent = scannedProduct.calories;
            document.getElementById('prodProtein').textContent = scannedProduct.protein + 'g';
            document.getElementById('prodCarbs').textContent = scannedProduct.carbs + 'g';
            document.getElementById('prodFat').textContent = scannedProduct.fat + 'g';
            document.getElementById('prodServing').textContent = `per ${scannedProduct.servingSize}`;
            document.getElementById('barcodeServings').value = 1;

            // Show product image if available
            const imageContainer = document.getElementById('productImage');
            if (scannedProduct.image) {
                imageContainer.innerHTML = `<img src="${scannedProduct.image}" alt="${scannedProduct.name}" loading="lazy" style="max-width: 120px; max-height: 120px; border-radius: 8px;">`;
            } else {
                imageContainer.innerHTML = '<div style="font-size: 3rem;"></div>';
            }

            document.getElementById('barcodeResultModal').classList.add('active');
        }

        function closeBarcodeResult() {
            document.getElementById('barcodeResultModal').classList.remove('active');
            scannedProduct = null;
        }

        async function addBarcodeFood() {
            if (!scannedProduct) return;

            const servings = parseFloat(document.getElementById('barcodeServings').value) || 1;

            try {
                // Use authenticated API call
                const data = await apiPost('/.netlify/functions/food-diary', {
                    clientId,
                    coachId,
                    entryDate: formatDate(currentDate),
                    mealType: currentMealType,
                    foodName: scannedProduct.name,
                    brand: scannedProduct.brand,
                    servingSize: 100,
                    servingUnit: 'g',
                    numberOfServings: servings,
                    calories: Math.round(scannedProduct.calories * servings),
                    protein: Math.round(scannedProduct.protein * servings * 10) / 10,
                    carbs: Math.round(scannedProduct.carbs * servings * 10) / 10,
                    fat: Math.round(scannedProduct.fat * servings * 10) / 10,
                    externalId: scannedProduct.barcode,
                    foodSource: 'barcode'
                });

                closeBarcodeResult();
                showToast('Food added!');

                // Add entry directly to UI using returned data
                if (data.entry) {
                    addOptimisticEntry(currentMealType, data.entry);
                    entries.push(data.entry);
                }
            } catch (err) {
                console.error('Error adding barcode food:', err);
                showToast('Failed to add food');
            }
        }

        // ==========================================
        // Meal Plan Picker Functions
        // ==========================================
        let clientMealPlans = [];
        let selectedPlanData = null;

        async function openMealPlanPicker() {
            closeFoodSearch();
            document.getElementById('mealPlanPickerModal').classList.add('active');
            document.getElementById('planSelectionView').style.display = 'block';
            document.getElementById('mealsSelectionView').style.display = 'none';

            // Load meal plans
            await loadClientMealPlans();
        }

        function closeMealPlanPicker() {
            document.getElementById('mealPlanPickerModal').classList.remove('active');
            selectedPlanData = null;
        }

        function showPlanSelection() {
            document.getElementById('planSelectionView').style.display = 'block';
            document.getElementById('mealsSelectionView').style.display = 'none';
            selectedPlanData = null;
        }

        async function loadClientMealPlans() {
            const container = document.getElementById('mealPlansList');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon"></div>
                    <p>Loading meal plans...</p>
                </div>
            `;

            try {
                const { data: plans, error } = await supabaseClient
                    .from('coach_meal_plans')
                    .select('id, client_name, plan_data, client_modified_data, created_at, status')
                    .eq('client_id', clientId)
                    .eq('status', 'published')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                clientMealPlans = plans || [];

                if (clientMealPlans.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <p>No meal plans available</p>
                            <p style="font-size: 0.85rem; color: var(--gray-400); margin-top: 8px;">Ask your coach to create a meal plan for you</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = clientMealPlans.map((plan, index) => {
                    const planData = plan.client_modified_data || plan.plan_data;
                    const planName = planData?.clientName || plan.client_name || 'Meal Plan';
                    const calories = planData?.calories || planData?.nutrition?.calories || '--';
                    const protein = planData?.protein || planData?.nutrition?.protein || '--';
                    const mealCount = getMealCount(planData);
                    const dayCount = getDayCount(planData);
                    const createdDate = new Date(plan.created_at).toLocaleDateString();

                    return `
                        <div class="meal-plan-card" onclick="selectMealPlan(${index})" style="
                            background: var(--gray-100);
                            border-radius: 12px;
                            padding: 16px;
                            margin-bottom: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                            border: 2px solid transparent;
                        " onmouseover="this.style.borderColor='var(--brand-primary)'" onmouseout="this.style.borderColor='transparent'">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">${planName}</div>
                                    <div style="font-size: 0.85rem; color: var(--gray-500);">${dayCount} day${dayCount !== 1 ? 's' : ''}  ${mealCount} meals</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.85rem; font-weight: 600; color: var(--brand-primary);">${calories} cal</div>
                                    <div style="font-size: 0.75rem; color: var(--gray-400);">${createdDate}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Error loading meal plans:', err);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <p>Failed to load meal plans</p>
                    </div>
                `;
            }
        }

        function getMealCount(planData) {
            if (!planData) return 0;
            if (planData.currentPlan && Array.isArray(planData.currentPlan)) {
                return planData.currentPlan.reduce((sum, day) => sum + (day.plan?.length || 0), 0);
            }
            if (planData.meals && Array.isArray(planData.meals)) {
                return planData.meals.length;
            }
            return 0;
        }

        function getDayCount(planData) {
            if (!planData) return 0;
            if (planData.currentPlan && Array.isArray(planData.currentPlan)) {
                return planData.currentPlan.length;
            }
            return 1;
        }

        function selectMealPlan(index) {
            const plan = clientMealPlans[index];
            if (!plan) return;

            selectedPlanData = plan.client_modified_data || plan.plan_data;
            const planName = selectedPlanData?.clientName || plan.client_name || 'Meal Plan';

            document.getElementById('selectedPlanName').textContent = planName;
            document.getElementById('planSelectionView').style.display = 'none';
            document.getElementById('mealsSelectionView').style.display = 'block';

            renderPlanMeals();
        }

        function renderPlanMeals() {
            const container = document.getElementById('planMealsList');

            if (!selectedPlanData) {
                container.innerHTML = '<p>No meals found</p>';
                return;
            }

            let mealsHtml = '';
            const mealTypeIcons = {
                breakfast: '<i data-lucide="sunrise" width="18" height="18" style="color: #f59e0b;"></i>',
                lunch: '<i data-lucide="sun" width="18" height="18" style="color: #eab308;"></i>',
                dinner: '<i data-lucide="moon" width="18" height="18" style="color: #8b5cf6;"></i>',
                snack: '<i data-lucide="apple" width="18" height="18" style="color: #ef4444;"></i>'
            };

            // Handle multi-day plans
            if (selectedPlanData.currentPlan && Array.isArray(selectedPlanData.currentPlan)) {
                selectedPlanData.currentPlan.forEach((day, dayIndex) => {
                    mealsHtml += `
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--gray-200);">
                                Day ${day.day || dayIndex + 1}
                            </div>
                    `;

                    if (day.plan && Array.isArray(day.plan)) {
                        day.plan.forEach((meal, mealIndex) => {
                            mealsHtml += createMealPickerCard(meal, dayIndex, mealIndex, mealTypeIcons);
                        });
                    }

                    mealsHtml += '</div>';
                });
            }
            // Handle single-day plans
            else if (selectedPlanData.meals && Array.isArray(selectedPlanData.meals)) {
                selectedPlanData.meals.forEach((meal, mealIndex) => {
                    mealsHtml += createMealPickerCard(meal, 0, mealIndex, mealTypeIcons);
                });
            }

            if (!mealsHtml) {
                mealsHtml = `
                    <div class="empty-state">
                        <div class="empty-icon"><i data-lucide="utensils" width="32" height="32"></i></div>
                        <p>No meals found in this plan</p>
                    </div>
                `;
            }

            container.innerHTML = mealsHtml;
            lucide.createIcons();
        }

        function createMealPickerCard(meal, dayIndex, mealIndex, icons) {
            const mealType = (meal.type || 'snack').toLowerCase();
            const icon = icons[mealType] || '<i data-lucide="utensils" width="18" height="18"></i>';
            const calories = meal.calories || 0;
            const protein = meal.protein || 0;
            const carbs = meal.carbs || 0;
            const fat = meal.fat || 0;

            return `
                <div class="meal-picker-item" onclick="addMealFromPlan(${dayIndex}, ${mealIndex})" style="
                    background: var(--gray-100);
                    border-radius: 12px;
                    padding: 14px;
                    margin-bottom: 10px;
                    cursor: pointer;
                    transition: all 0.2s;
                    border: 2px solid transparent;
                " onmouseover="this.style.borderColor='var(--brand-primary)'; this.style.background='var(--gray-50)'"
                   onmouseout="this.style.borderColor='transparent'; this.style.background='var(--gray-100)'">
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <div style="font-size: 1.5rem;">${icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">${meal.name || 'Unnamed Meal'}</div>
                            <div style="font-size: 0.8rem; color: var(--gray-500); text-transform: capitalize; margin-bottom: 6px;">${mealType}</div>
                            <div style="display: flex; gap: 12px; font-size: 0.8rem;">
                                <span style="color: var(--gray-600);">${calories} cal</span>
                                <span style="color: #3b82f6;">${protein}g P</span>
                                <span style="color: #f59e0b;">${carbs}g C</span>
                                <span style="color: #ef4444;">${fat}g F</span>
                            </div>
                        </div>
                        <div style="color: var(--brand-primary); font-size: 1.2rem;">+</div>
                    </div>
                </div>
            `;
        }

        async function addMealFromPlan(dayIndex, mealIndex) {
            let meal;

            // Get the meal from the correct location
            if (selectedPlanData.currentPlan && Array.isArray(selectedPlanData.currentPlan)) {
                meal = selectedPlanData.currentPlan[dayIndex]?.plan?.[mealIndex];
            } else if (selectedPlanData.meals && Array.isArray(selectedPlanData.meals)) {
                meal = selectedPlanData.meals[mealIndex];
            }

            if (!meal) {
                showToast('Could not find meal');
                return;
            }

            // Create optimistic entry
            const tempId = 'temp-' + Date.now();
            const mealType = (meal.type || 'snack').toLowerCase();
            const optimisticEntry = {
                id: tempId,
                food_name: meal.name,
                number_of_servings: 1,
                serving_unit: 'serving',
                calories: meal.calories || 0,
                protein: meal.protein || 0,
                carbs: meal.carbs || 0,
                fat: meal.fat || 0
            };

            // Add to UI immediately
            addOptimisticEntry(currentMealType, optimisticEntry);
            closeMealPlanPicker();
            showToast('Adding...');

            try {
                // Use authenticated API call
                const data = await apiPost('/.netlify/functions/food-diary', {
                    clientId,
                    coachId,
                    entryDate: formatDate(currentDate),
                    mealType: currentMealType,
                    foodName: meal.name,
                    servingSize: 1,
                    servingUnit: 'serving',
                    numberOfServings: 1,
                    calories: meal.calories || 0,
                    protein: meal.protein || 0,
                    carbs: meal.carbs || 0,
                    fat: meal.fat || 0,
                    foodSource: 'meal_plan',
                    notes: `From meal plan (${mealType})`
                });

                // Update optimistic entry with real ID
                if (data.entry) {
                    updateOptimisticEntryWithRealId(tempId, data.entry, currentMealType);
                    entries.push(data.entry);
                }

                showToast('Meal added from plan!');
            } catch (err) {
                console.error('Error adding meal from plan:', err);
                removeOptimisticEntry(tempId);
                showToast('Failed to add meal');
            }
        }

        // ==========================================
        // Favorites Picker Functions
        // ==========================================
        let clientFavorites = [];

        async function openFavoritesPicker() {
            closeFoodSearch();
            document.getElementById('favoritesPickerModal').classList.add('active');
            await loadClientFavorites();
        }

        function closeFavoritesPicker() {
            document.getElementById('favoritesPickerModal').classList.remove('active');
        }

        async function loadClientFavorites() {
            const container = document.getElementById('favoritesList');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon"></div>
                    <p>Loading favorites...</p>
                </div>
            `;

            try {
                // Use authenticated API call
                const data = await apiGet(`/.netlify/functions/toggle-favorite?clientId=${clientId}`);
                clientFavorites = data.favorites || [];

                if (clientFavorites.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <p>No favorites yet</p>
                            <p style="font-size: 0.85rem; color: var(--gray-400); margin-top: 8px;">
                                Favorite meals from your meal plans to see them here
                            </p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = clientFavorites.map((fav, index) => {
                    const icon = getMealTypeIcon(fav.meal_type);
                    return `
                        <div class="favorite-item" onclick="addFavoriteToDay(${index})" style="
                            background: var(--gray-100);
                            border-radius: 12px;
                            padding: 14px;
                            margin-bottom: 10px;
                            cursor: pointer;
                            transition: all 0.2s;
                            border: 2px solid transparent;
                        " onmouseover="this.style.borderColor='var(--brand-primary)'; this.style.background='var(--gray-50)'"
                           onmouseout="this.style.borderColor='transparent'; this.style.background='var(--gray-100)'">
                            <div style="display: flex; gap: 12px; align-items: start;">
                                <div style="font-size: 1.5rem;">${icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">${fav.meal_name || 'Unnamed Meal'}</div>
                                    <div style="font-size: 0.8rem; color: var(--gray-500); text-transform: capitalize; margin-bottom: 6px;">${fav.meal_type || 'meal'}</div>
                                    <div style="display: flex; gap: 12px; font-size: 0.8rem;">
                                        <span style="color: var(--gray-600);">${fav.calories || 0} cal</span>
                                        <span style="color: #3b82f6;">${fav.protein || 0}g P</span>
                                        <span style="color: #f59e0b;">${fav.carbs || 0}g C</span>
                                        <span style="color: #ef4444;">${fav.fat || 0}g F</span>
                                    </div>
                                </div>
                                <div style="color: var(--brand-primary); font-size: 1.2rem;">+</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Error loading favorites:', err);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <p>Failed to load favorites</p>
                    </div>
                `;
            }
        }

        function getMealTypeIcon(mealType) {
            const type = (mealType || '').toLowerCase();
            if (type === 'breakfast') return '<i data-lucide="sunrise" width="18" height="18" style="color: #f59e0b;"></i>';
            if (type === 'lunch') return '<i data-lucide="sun" width="18" height="18" style="color: #eab308;"></i>';
            if (type === 'dinner') return '<i data-lucide="moon" width="18" height="18" style="color: #8b5cf6;"></i>';
            if (type === 'snack') return '<i data-lucide="apple" width="18" height="18" style="color: #ef4444;"></i>';
            return '<i data-lucide="utensils" width="18" height="18" style="color: #64748b;"></i>';
        }

        async function addFavoriteToDay(index) {
            const fav = clientFavorites[index];
            if (!fav) {
                showToast('Could not find favorite');
                return;
            }

            // Create optimistic entry
            const tempId = 'temp-' + Date.now();
            const optimisticEntry = {
                id: tempId,
                food_name: fav.meal_name,
                number_of_servings: 1,
                serving_unit: 'serving',
                calories: fav.calories || 0,
                protein: fav.protein || 0,
                carbs: fav.carbs || 0,
                fat: fav.fat || 0
            };

            // Add to UI immediately
            addOptimisticEntry(currentMealType, optimisticEntry);
            closeFavoritesPicker();
            showToast('Adding...');

            try {
                // Use authenticated API call
                const data = await apiPost('/.netlify/functions/food-diary', {
                    clientId,
                    coachId,
                    entryDate: formatDate(currentDate),
                    mealType: currentMealType,
                    foodName: fav.meal_name,
                    servingSize: 1,
                    servingUnit: 'serving',
                    numberOfServings: 1,
                    calories: fav.calories || 0,
                    protein: fav.protein || 0,
                    carbs: fav.carbs || 0,
                    fat: fav.fat || 0,
                    foodSource: 'favorite',
                    notes: `From favorites (${fav.meal_type || 'meal'})`
                });

                // Update optimistic entry with real ID
                if (data.entry) {
                    updateOptimisticEntryWithRealId(tempId, data.entry, currentMealType);
                    entries.push(data.entry);
                }

                showToast('Favorite added!');
            } catch (err) {
                console.error('Error adding favorite:', err);
                removeOptimisticEntry(tempId);
                showToast('Failed to add favorite');
            }
        }

        // ==========================================
        // Save Entire Meal to Favorites
        // ==========================================
        let saveMealData = null;

        function openSaveMealModal(mealType) {
            // Get all entries for this meal type
            const mealEntries = entries.filter(e => e.meal_type === mealType);

            if (mealEntries.length === 0) {
                showToast('No items to save');
                return;
            }

            // Calculate totals
            const totals = mealEntries.reduce((acc, e) => ({
                calories: acc.calories + (e.calories || 0),
                protein: acc.protein + (e.protein || 0),
                carbs: acc.carbs + (e.carbs || 0),
                fat: acc.fat + (e.fat || 0)
            }), { calories: 0, protein: 0, carbs: 0, fat: 0 });

            // Build the preview
            const itemsList = mealEntries.map(e => ` ${e.food_name}`).join('<br>');
            const preview = `
                <div style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 12px;">
                    ${itemsList}
                </div>
                <div style="display: flex; gap: 12px; font-size: 0.85rem; font-weight: 600;">
                    <span style="color: var(--gray-700);">${Math.round(totals.calories)} cal</span>
                    <span style="color: #3b82f6;">${Math.round(totals.protein)}g P</span>
                    <span style="color: #f59e0b;">${Math.round(totals.carbs)}g C</span>
                    <span style="color: #ef4444;">${Math.round(totals.fat)}g F</span>
                </div>
            `;

            // Store data for saving
            saveMealData = {
                mealType: mealType,
                entries: mealEntries,
                totals: totals
            };

            // Generate default name
            const mealLabel = mealType.charAt(0).toUpperCase() + mealType.slice(1);
            const defaultName = mealEntries.length === 1
                ? mealEntries[0].food_name
                : `My ${mealLabel} (${mealEntries.length} items)`;

            document.getElementById('saveMealType').value = mealType;
            document.getElementById('saveMealName').value = defaultName;
            document.getElementById('saveMealPreview').innerHTML = preview;
            document.getElementById('saveMealModal').classList.add('active');
        }

        function closeSaveMealModal() {
            document.getElementById('saveMealModal').classList.remove('active');
            saveMealData = null;
        }

        async function saveMealToFavorites() {
            if (!saveMealData) {
                showToast('No meal data to save');
                return;
            }

            const mealName = document.getElementById('saveMealName').value.trim();
            if (!mealName) {
                showToast('Please enter a name for this meal');
                return;
            }

            try {
                // Build the combined meal name with all items
                const itemNames = saveMealData.entries.map(e => e.food_name).join(' + ');

                // Use authenticated API call
                const data = await apiPost('/.netlify/functions/toggle-favorite', {
                    clientId: clientId,
                    mealName: mealName,
                    mealType: saveMealData.mealType,
                    calories: Math.round(saveMealData.totals.calories),
                    protein: Math.round(saveMealData.totals.protein * 10) / 10,
                    carbs: Math.round(saveMealData.totals.carbs * 10) / 10,
                    fat: Math.round(saveMealData.totals.fat * 10) / 10,
                    notes: `Items: ${itemNames}`
                });

                if (data.action === 'added') {
                    showToast('Meal saved to favorites! ');
                } else if (data.action === 'removed') {
                    showToast('Meal removed from favorites');
                }

                closeSaveMealModal();

            } catch (err) {
                console.error('Error saving meal to favorites:', err);
                showToast('Failed to save meal');
            }
        }

        // Update save meal button visibility when entries change
        function updateSaveMealButtons() {
            const mealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
            mealTypes.forEach(mealType => {
                const mealEntries = entries.filter(e => e.meal_type === mealType);
                const saveBtn = document.getElementById(`save${mealType.charAt(0).toUpperCase() + mealType.slice(1)}Btn`);
                if (saveBtn) {
                    saveBtn.style.display = mealEntries.length > 0 ? 'flex' : 'none';
                }
            });
        }

        // ==========================================
        // Swipe to Delete Functions
        // ==========================================

        function initSwipeHandlers(container) {
            const swipeItems = container.querySelectorAll('.swipe-container');
            swipeItems.forEach(item => initSwipeOnElement(item));
        }

        function initSwipeOnElement(element) {
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            const swipeContent = element.querySelector('.swipe-content');

            if (!swipeContent) return;

            swipeContent.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isDragging = true;
                swipeContent.classList.add('swiping');
            }, { passive: true });

            swipeContent.addEventListener('touchmove', (e) => {
                if (!isDragging) return;

                currentX = e.touches[0].clientX;
                const diff = startX - currentX;

                // Only allow left swipe (positive diff), max 80px
                if (diff > 0) {
                    const translateX = Math.min(diff, 80);
                    swipeContent.style.transform = `translateX(-${translateX}px)`;
                } else {
                    swipeContent.style.transform = 'translateX(0)';
                }
            }, { passive: true });

            swipeContent.addEventListener('touchend', () => {
                isDragging = false;
                swipeContent.classList.remove('swiping');

                const diff = startX - currentX;

                // If swiped more than 40px, keep it open
                if (diff > 40) {
                    swipeContent.style.transform = 'translateX(-80px)';
                    element.classList.add('swiped-open');
                } else {
                    swipeContent.style.transform = 'translateX(0)';
                    element.classList.remove('swiped-open');
                }
            });

            // Close on tap elsewhere
            document.addEventListener('touchstart', (e) => {
                if (!element.contains(e.target) && element.classList.contains('swiped-open')) {
                    swipeContent.style.transform = 'translateX(0)';
                    element.classList.remove('swiped-open');
                }
            }, { passive: true });
        }

        async function swipeDeleteEntry(entryId, mealType) {
            const entry = entries.find(e => e.id == entryId);
            console.log('DELETE - Attempting to delete entryId:', entryId);

            try {
                // Use authenticated DELETE call
                const response = await authenticatedFetch(`/.netlify/functions/food-diary?entryId=${entryId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                console.log('DELETE - Response:', response.status, data);

                if (!response.ok) throw new Error(data.error || 'Failed to delete entry');

                // Remove from DOM
                const entryEl = document.getElementById(`entry-${entryId}`);
                if (entryEl) {
                    entryEl.style.transform = 'translateX(-100%)';
                    entryEl.style.opacity = '0';
                    entryEl.style.transition = 'all 0.3s ease-out';
                    setTimeout(() => entryEl.remove(), 300);
                }

                // Remove from local entries array
                entries = entries.filter(e => e.id != entryId);

                // Update calorie displays
                if (entry) {
                    const mealCalsEl = document.getElementById(`${mealType}Cals`);
                    if (mealCalsEl) {
                        mealCalsEl.textContent = Math.max(0, parseInt(mealCalsEl.textContent || 0) - (entry.calories || 0));
                    }

                    const consumedEl = document.getElementById('caloriesConsumed');
                    const newConsumed = Math.max(0, parseInt(consumedEl.textContent || 0) - (entry.calories || 0));
                    const calorieGoal = goals.calorie_goal || 2000;
                    consumedEl.textContent = newConsumed;

                    // Update calorie ring
                    const ring = document.getElementById('calorieRing');
                    const percentage = Math.min(100, (newConsumed / calorieGoal) * 100) || 0;
                    const circumference = 251.2;
                    const offset = circumference - (percentage / 100) * circumference;
                    ring.style.strokeDashoffset = offset;

                    // Update remaining with proper styling (allows negative)
                    updateRemainingCaloriesDisplay(calorieGoal - newConsumed);

                    // Update macro bars
                    updateMacroBar('protein',
                        Math.max(0, parseFloat(document.getElementById('proteinValue').textContent) - (entry.protein || 0)),
                        goals.protein_goal || 150);
                    updateMacroBar('carbs',
                        Math.max(0, parseFloat(document.getElementById('carbsValue').textContent) - (entry.carbs || 0)),
                        goals.carbs_goal || 200);
                    updateMacroBar('fat',
                        Math.max(0, parseFloat(document.getElementById('fatValue').textContent) - (entry.fat || 0)),
                        goals.fat_goal || 65);
                }

                // Update save meal button visibility
                updateSaveMealButtons();

                showToast('Entry deleted');
            } catch (err) {
                console.error('Error deleting entry:', err);
                showToast('Failed to delete entry');
            }
        }

        // ==========================================
        // PHASE 1: Copy Day Functions
        // ==========================================
        let copyMode = 'from'; // 'from' or 'to'

        function openCopyDayModal() {
            document.getElementById('copyDayModal').classList.add('active');
        }

        function closeCopyDayModal() {
            document.getElementById('copyDayModal').classList.remove('active');
        }

        function openCopyFromDatePicker() {
            closeCopyDayModal();
            copyMode = 'from';
            document.getElementById('copyDatePickerTitle').textContent = 'Copy From Date';
            document.getElementById('copyDateInput').value = '';
            document.getElementById('copyDatePickerModal').classList.add('active');
        }

        function openCopyToDatePicker() {
            closeCopyDayModal();
            copyMode = 'to';
            document.getElementById('copyDatePickerTitle').textContent = 'Copy To Date';
            document.getElementById('copyDateInput').value = '';
            document.getElementById('copyDatePickerModal').classList.add('active');
        }

        function closeCopyDatePicker() {
            document.getElementById('copyDatePickerModal').classList.remove('active');
        }

        async function executeCopyDate() {
            const selectedDate = document.getElementById('copyDateInput').value;
            if (!selectedDate) {
                showToast('Please select a date');
                return;
            }

            closeCopyDatePicker();

            if (copyMode === 'from') {
                await copyEntriesFromDate(selectedDate, formatDate(currentDate));
            } else {
                await copyEntriesFromDate(formatDate(currentDate), selectedDate);
            }
        }

        async function copyFromYesterday() {
            const yesterday = new Date(currentDate);
            yesterday.setDate(yesterday.getDate() - 1);
            await copyEntriesFromDate(formatDate(yesterday), formatDate(currentDate));
        }

        async function copyEntriesFromDate(fromDate, toDate) {
            showToast('Copying entries...');

            try {
                // Fetch entries from source date (use authenticated call)
                const data = await apiGet(`/.netlify/functions/food-diary?clientId=${clientId}&date=${fromDate}`);

                if (!data.entries || data.entries.length === 0) {
                    showToast('No entries to copy from that date');
                    return;
                }

                // Copy each entry to target date
                let copiedCount = 0;
                for (const entry of data.entries) {
                    try {
                        // Use authenticated API call
                        await apiPost('/.netlify/functions/food-diary', {
                            clientId,
                            coachId,
                            entryDate: toDate,
                            mealType: entry.meal_type,
                            foodName: entry.food_name,
                            brand: entry.brand,
                            servingSize: entry.serving_size,
                            servingUnit: entry.serving_unit,
                            numberOfServings: entry.number_of_servings,
                            calories: entry.calories,
                            protein: entry.protein,
                            carbs: entry.carbs,
                            fat: entry.fat,
                            fiber: entry.fiber,
                            foodSource: 'copied'
                        });
                        copiedCount++;
                    } catch (e) { /* ignore individual failures */ }
                }

                showToast(`Copied ${copiedCount} entries!`);

                // Reload if we copied to current date
                if (toDate === formatDate(currentDate)) {
                    await loadDiaryEntries();
                }
            } catch (err) {
                console.error('Error copying entries:', err);
                showToast('Failed to copy entries');
            }
        }

        // ==========================================
        // PHASE 1: Water Tracking Functions
        // ==========================================
        let waterIntake = 0;
        let waterGoal = 8;

        function renderWaterGlasses() {
            const container = document.getElementById('waterGlasses');
            let html = '';
            for (let i = 0; i < waterGoal; i++) {
                html += `<div class="water-glass ${i < waterIntake ? 'filled' : ''}"></div>`;
            }
            container.innerHTML = html;
            document.getElementById('waterCurrent').textContent = waterIntake;
            document.getElementById('waterGoalAmount').textContent = waterGoal;
            document.getElementById('waterGoalDisplay').textContent = waterGoal;
        }

        async function addWater(glasses) {
            waterIntake = Math.min(waterIntake + glasses, 20);
            renderWaterGlasses();
            await saveWaterIntake();
            if (waterIntake >= waterGoal) {
                showToast(' Water goal reached!');
            }
        }

        async function removeWater(glasses) {
            waterIntake = Math.max(0, waterIntake - glasses);
            renderWaterGlasses();
            await saveWaterIntake();
        }

        function completeWaterGoal() {
            waterIntake = waterGoal;
            renderWaterGlasses();
            saveWaterIntake();
            showToast(' Water goal completed!');
        }

        function openWaterGoalModal() {
            document.getElementById('waterGoalInput').value = waterGoal;
            document.getElementById('waterGoalModal').classList.add('active');
        }

        function closeWaterGoalModal() {
            document.getElementById('waterGoalModal').classList.remove('active');
        }

        async function saveWaterGoal() {
            waterGoal = parseInt(document.getElementById('waterGoalInput').value) || 8;
            waterGoal = Math.max(1, Math.min(20, waterGoal));
            closeWaterGoalModal();
            renderWaterGlasses();
            await saveWaterIntake();
            showToast('Water goal updated!');
        }

        async function loadWaterIntake() {
            try {
                const date = formatDate(currentDate);
                const { data, error } = await supabaseClient
                    .from('water_intake')
                    .select('*')
                    .eq('client_id', clientId)
                    .eq('date', date)
                    .single();

                if (data) {
                    waterIntake = data.glasses || 0;
                    waterGoal = data.goal || 8;
                } else {
                    waterIntake = 0;
                }
                renderWaterGlasses();
            } catch (err) {
                // Table might not exist or no data, that's okay
                waterIntake = 0;
                renderWaterGlasses();
            }
        }

        async function saveWaterIntake() {
            try {
                const date = formatDate(currentDate);
                await supabaseClient
                    .from('water_intake')
                    .upsert({
                        client_id: clientId,
                        date: date,
                        glasses: waterIntake,
                        goal: waterGoal
                    }, { onConflict: 'client_id,date' });
            } catch (err) {
                console.error('Error saving water intake:', err);
            }
        }

        // ==========================================
        // PHASE 1: Daily Report Functions
        // ==========================================
        function openDailyReport() {
            generateDailyReport();
            document.getElementById('dailyReportModal').classList.add('active');
        }

        function closeDailyReport() {
            document.getElementById('dailyReportModal').classList.remove('active');
        }

        function generateDailyReport() {
            const consumed = parseInt(document.getElementById('caloriesConsumed').textContent) || 0;
            const calorieGoal = goals.calorie_goal || 2000;
            const proteinCurrent = parseFloat(document.getElementById('proteinValue').textContent) || 0;
            const carbsCurrent = parseFloat(document.getElementById('carbsValue').textContent) || 0;
            const fatCurrent = parseFloat(document.getElementById('fatValue').textContent) || 0;

            // Calculate score (0-100)
            const calorieAccuracy = 100 - Math.abs((consumed - calorieGoal) / calorieGoal * 100);
            const proteinScore = Math.min(100, (proteinCurrent / goals.protein_goal) * 100);
            const carbsScore = Math.min(100, (carbsCurrent / goals.carbs_goal) * 100);
            const fatScore = Math.min(100, (fatCurrent / goals.fat_goal) * 100);
            const score = Math.round((calorieAccuracy * 0.4 + proteinScore * 0.3 + carbsScore * 0.15 + fatScore * 0.15));
            const clampedScore = Math.max(0, Math.min(100, score));

            // Determine grade
            let grade, gradeClass;
            if (clampedScore >= 85) { grade = 'Excellent'; gradeClass = 'excellent'; }
            else if (clampedScore >= 70) { grade = 'Good'; gradeClass = 'good'; }
            else if (clampedScore >= 50) { grade = 'Fair'; gradeClass = 'fair'; }
            else { grade = 'Needs Work'; gradeClass = 'poor'; }

            // Get meal totals
            const breakfastCals = parseInt(document.getElementById('breakfastCals').textContent) || 0;
            const lunchCals = parseInt(document.getElementById('lunchCals').textContent) || 0;
            const dinnerCals = parseInt(document.getElementById('dinnerCals').textContent) || 0;
            const snackCals = parseInt(document.getElementById('snackCals').textContent) || 0;

            // Generate insights
            const insights = [];
            if (consumed < calorieGoal * 0.8) insights.push(' You\'re under your calorie goal. Make sure you\'re eating enough!');
            if (consumed > calorieGoal * 1.1) insights.push(' You\'re over your calorie goal. Consider lighter options tomorrow.');
            if (proteinCurrent < goals.protein_goal * 0.8) insights.push(' Try to get more protein to support your goals.');
            if (proteinCurrent >= goals.protein_goal) insights.push(' Great job hitting your protein target!');
            if (waterIntake >= waterGoal) insights.push(' Excellent hydration today!');
            if (waterIntake < waterGoal / 2) insights.push(' Remember to drink more water!');
            if (entries.length >= 4) insights.push(' Good job logging all your meals!');
            if (insights.length === 0) insights.push(' You\'re on track! Keep up the good work.');

            const dateStr = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

            const reportHtml = `
                <div class="report-header">
                    <div class="report-date">${dateStr}</div>
                    <div class="report-title">Daily Summary</div>
                </div>

                <div class="report-score">
                    <div class="score-circle ${gradeClass}">
                        <div class="score-value">${clampedScore}</div>
                        <div class="score-label">${grade}</div>
                    </div>
                </div>

                <div class="report-stats">
                    <div class="report-stat">
                        <div class="report-stat-value">${consumed}</div>
                        <div class="report-stat-label">Calories</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-stat-value">${Math.round(proteinCurrent)}g</div>
                        <div class="report-stat-label">Protein</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-stat-value">${Math.round(carbsCurrent)}g</div>
                        <div class="report-stat-label">Carbs</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-stat-value">${Math.round(fatCurrent)}g</div>
                        <div class="report-stat-label">Fat</div>
                    </div>
                </div>

                <div class="report-meals">
                    <div class="report-meals-title">Meals Breakdown</div>
                    <div class="report-meal-item">
                        <span style="display: flex; align-items: center; gap: 6px;"><i data-lucide="sunrise" width="16" height="16" style="color: #f59e0b;"></i> Breakfast</span>
                        <span>${breakfastCals} cal</span>
                    </div>
                    <div class="report-meal-item">
                        <span style="display: flex; align-items: center; gap: 6px;"><i data-lucide="sun" width="16" height="16" style="color: #eab308;"></i> Lunch</span>
                        <span>${lunchCals} cal</span>
                    </div>
                    <div class="report-meal-item">
                        <span style="display: flex; align-items: center; gap: 6px;"><i data-lucide="moon" width="16" height="16" style="color: #8b5cf6;"></i> Dinner</span>
                        <span>${dinnerCals} cal</span>
                    </div>
                    <div class="report-meal-item">
                        <span style="display: flex; align-items: center; gap: 6px;"><i data-lucide="apple" width="16" height="16" style="color: #ef4444;"></i> Snacks</span>
                        <span>${snackCals} cal</span>
                    </div>
                    <div class="report-meal-item">
                        <span style="display: flex; align-items: center; gap: 6px;"><i data-lucide="droplets" width="16" height="16" style="color: #06b6d4;"></i> Water</span>
                        <span>${waterIntake}/${waterGoal} glasses</span>
                    </div>
                </div>

                <div class="report-insights">
                    <div class="report-insights-title" style="display: flex; align-items: center; gap: 6px;"><i data-lucide="lightbulb" width="16" height="16" style="color: #f59e0b;"></i> Insights</div>
                    ${insights.map(i => `<div class="report-insight">${i}</div>`).join('')}
                </div>
            `;

            document.getElementById('reportContent').innerHTML = reportHtml;
            lucide.createIcons();
        }

        // ==========================================
        // PHASE 1: Streak Functions
        // ==========================================
        let currentStreak = 0;

        async function loadStreak() {
            try {
                // Get entries for last 30 days to calculate streak
                const today = new Date();
                const dates = [];

                for (let i = 0; i < 30; i++) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    dates.push(formatDate(d));
                }

                const { data, error } = await supabaseClient
                    .from('food_diary_entries')
                    .select('entry_date')
                    .eq('client_id', clientId)
                    .in('entry_date', dates);

                if (error) throw error;

                // Get unique dates with entries
                const datesWithEntries = new Set(data.map(e => e.entry_date));

                // Calculate streak (consecutive days from today/yesterday)
                let streak = 0;
                for (let i = 0; i < 30; i++) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    const dateStr = formatDate(d);

                    if (datesWithEntries.has(dateStr)) {
                        streak++;
                    } else if (i > 0) {
                        // Allow today to not have entries yet
                        break;
                    }
                }

                currentStreak = streak;
                updateStreakDisplay();
            } catch (err) {
                console.error('Error loading streak:', err);
            }
        }

        function updateStreakDisplay() {
            const badge = document.getElementById('streakBadge');
            const count = document.getElementById('streakCount');

            count.textContent = currentStreak;

            if (currentStreak === 0) {
                badge.classList.add('no-streak');
                badge.innerHTML = '<span><i data-lucide="flame" width="18" height="18" style="color: #f97316;"></i></span><span>Start your streak!</span>';
                lucide.createIcons();
            } else {
                badge.classList.remove('no-streak');
                badge.innerHTML = `<span><i data-lucide="flame" width="18" height="18" style="color: white;"></i></span><span id="streakCount">${currentStreak}</span><span>day${currentStreak !== 1 ? 's' : ''}</span>`;
                lucide.createIcons();
            }
        }

        // ==========================================
        // Update page load to include new features
        // ==========================================
        const originalCheckAuth = checkAuth;
        checkAuth = async function() {
            await originalCheckAuth.apply(this, arguments);
            // Load Phase 1 features after auth
            if (clientId) {
                await Promise.all([
                    loadWaterIntake(),
                    loadStreak()
                ]);
            }
        };

        // Also load water when date changes
        const originalLoadDiaryEntries = loadDiaryEntries;
        loadDiaryEntries = async function() {
            await originalLoadDiaryEntries.apply(this, arguments);
            if (clientId) {
                await loadWaterIntake();
            }
        };

        // ==========================================
        // PHASE 2: AI Photo Recognition
        // ==========================================
        let aiDetectedFoods = [];
        let currentPhotoBase64 = null;

        function openAIPhotoModal() {
            closeFoodSearch();
            document.getElementById('aiPhotoModal').classList.add('active');
            resetAIPhoto();
        }

        function closeAIPhotoModal() {
            document.getElementById('aiPhotoModal').classList.remove('active');
            resetAIPhoto();
        }

        function resetAIPhoto() {
            document.getElementById('aiPhotoUpload').style.display = 'block';
            document.getElementById('aiAnalyzing').style.display = 'none';
            document.getElementById('aiResults').style.display = 'none';
            document.getElementById('photoDetailsSection').style.display = 'none';
            document.getElementById('photoFoodDetails').value = '';
            document.getElementById('photoUploadArea').classList.remove('has-image');
            document.getElementById('photoUploadArea').innerHTML = `
                <div class="photo-upload-icon"></div>
                <div class="photo-upload-text">Tap to take a photo or upload</div>
                <div class="photo-upload-hint">AI will analyze your food and estimate calories</div>
            `;
            document.getElementById('photoInput').value = '';
            aiDetectedFoods = [];
            currentPhotoBase64 = null;
        }

        async function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show preview
            const reader = new FileReader();
            reader.onload = async (e) => {
                currentPhotoBase64 = e.target.result;
                const uploadArea = document.getElementById('photoUploadArea');
                uploadArea.classList.add('has-image');
                uploadArea.innerHTML = `<img src="${currentPhotoBase64}" alt="Food photo" style="cursor: pointer;" onclick="document.getElementById('photoInput').click()">`;

                // Show the details section so user can optionally add context
                document.getElementById('photoDetailsSection').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function analyzePhotoWithAI() {
            document.getElementById('aiPhotoUpload').style.display = 'none';
            document.getElementById('photoDetailsSection').style.display = 'none';
            document.getElementById('aiAnalyzing').style.display = 'block';

            // Get optional food details from user
            const foodDetails = document.getElementById('photoFoodDetails').value.trim();

            try {
                // Use authenticated API call
                const data = await apiPost('/.netlify/functions/analyze-food-photo', {
                    image: currentPhotoBase64,
                    details: foodDetails || null
                });
                console.log('AI Photo response:', data);

                aiDetectedFoods = data.foods || [];

                if (aiDetectedFoods.length === 0) {
                    showToast('Could not detect any food items');
                    resetAIPhoto();
                    return;
                }

                renderAIResults();
            } catch (err) {
                console.error('Error analyzing photo:', err);
                showToast('Failed to analyze photo. Try again.');
                resetAIPhoto();
            }
        }

        function renderAIResults() {
            console.log('renderAIResults: Rendering', aiDetectedFoods.length, 'items');
            document.getElementById('aiAnalyzing').style.display = 'none';
            document.getElementById('aiResults').style.display = 'block';

            const container = document.getElementById('aiDetectedItems');
            container.innerHTML = aiDetectedFoods.map((food, idx) => `
                <div class="ai-food-item" id="ai-food-${idx}" style="position: relative; padding-right: 40px;">
                    <button onclick="removeAIFood(${idx})" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center;"></button>
                    <div class="ai-food-name">${food.name}</div>
                    <div class="ai-food-macros" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <input type="number" value="${food.calories}" onchange="updateAIFood(${idx}, 'calories', this.value)" style="width: 50px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;"> cal
                        <input type="number" value="${food.protein}" onchange="updateAIFood(${idx}, 'protein', this.value)" style="width: 40px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">g P
                        <input type="number" value="${food.carbs}" onchange="updateAIFood(${idx}, 'carbs', this.value)" style="width: 40px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">g C
                        <input type="number" value="${food.fat}" onchange="updateAIFood(${idx}, 'fat', this.value)" style="width: 40px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">g F
                    </div>
                </div>
            `).join('');
        }

        // Remove an AI detected food item
        function removeAIFood(idx) {
            aiDetectedFoods.splice(idx, 1);
            renderAIResults();
            if (aiDetectedFoods.length === 0) {
                showToast('No items left. Try another photo.');
                resetAIPhoto();
            }
        }

        // Update an AI detected food item's value
        function updateAIFood(idx, field, value) {
            aiDetectedFoods[idx][field] = parseInt(value) || 0;
            console.log('Updated AI food:', idx, field, value);
        }

        async function addAIDetectedFoods() {
            console.log('addAIDetectedFoods: Starting, foods:', aiDetectedFoods);
            console.log('addAIDetectedFoods: clientId:', clientId, 'mealType:', currentMealType);

            if (!clientId) {
                showToast('Error: Not logged in');
                return;
            }

            if (aiDetectedFoods.length === 0) {
                showToast('No foods to add');
                return;
            }

            // Store foods BEFORE closing modal (closeAIPhotoModal clears aiDetectedFoods!)
            const foodsToAdd = [...aiDetectedFoods];
            console.log('addAIDetectedFoods: Copied', foodsToAdd.length, 'foods to add');

            closeAIPhotoModal();
            showToast('Adding foods...');

            let addedCount = 0;
            let errors = [];

            for (const food of foodsToAdd) {
                try {
                    const payload = {
                        clientId,
                        coachId,
                        entryDate: formatDate(currentDate),
                        mealType: currentMealType,
                        foodName: food.name,
                        numberOfServings: 1,
                        servingSize: 1,
                        servingUnit: 'serving',
                        calories: food.calories,
                        protein: food.protein,
                        carbs: food.carbs,
                        fat: food.fat,
                        foodSource: 'ai_photo'
                    };
                    console.log('addAIDetectedFoods: Adding food:', payload);

                    // Use authenticated API call
                    const data = await apiPost('/.netlify/functions/food-diary', payload);
                    console.log('addAIDetectedFoods: Response:', data);
                    addedCount++;
                } catch (err) {
                    console.error('Error adding food:', err);
                    errors.push(err.message);
                }
            }

            await loadDiaryEntries();

            if (errors.length > 0) {
                showToast(`Added ${addedCount}/${foodsToAdd.length} items. Errors: ${errors.join(', ')}`);
            } else {
                showToast(`Added ${addedCount} items from photo!`);
            }
        }

        // ==========================================
        // AI Text/Voice Food Logging
        // ==========================================
        let aiTextDetectedFoods = [];
        let speechRecognition = null;
        let isListening = false;

        function openAITextModal() {
            closeFoodSearch();
            document.getElementById('aiTextModal').classList.add('active');
            resetAIText();
            // Check for speech recognition support
            checkVoiceSupport();
        }

        function closeAITextModal() {
            document.getElementById('aiTextModal').classList.remove('active');
            stopVoiceInput();
            resetAIText();
        }

        function resetAIText() {
            document.getElementById('aiTextInput').style.display = 'block';
            document.getElementById('aiTextAnalyzing').style.display = 'none';
            document.getElementById('aiTextResults').style.display = 'none';
            document.getElementById('foodDescriptionInput').value = '';
            document.getElementById('voiceStatus').style.display = 'none';
            aiTextDetectedFoods = [];
            stopVoiceInput();
        }

        function checkVoiceSupport() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                document.getElementById('voiceNotSupported').style.display = 'block';
                document.getElementById('voiceInputBtn').style.opacity = '0.5';
                document.getElementById('voiceInputBtn').style.cursor = 'not-allowed';
            } else {
                document.getElementById('voiceNotSupported').style.display = 'none';
            }
        }

        function toggleVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showToast('Voice input not supported in this browser');
                return;
            }

            if (isListening) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }

        function startVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            const voiceBtn = document.getElementById('voiceInputBtn');
            const voiceStatus = document.getElementById('voiceStatus');
            const voiceStatusText = document.getElementById('voiceStatusText');
            const textInput = document.getElementById('foodDescriptionInput');

            // Clean up any existing recognition first
            if (speechRecognition) {
                try { speechRecognition.abort(); } catch(e) {}
                speechRecognition = null;
            }

            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = false;  // Single result, then stop
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';
            speechRecognition.maxAlternatives = 1;

            speechRecognition.onstart = () => {
                isListening = true;
                voiceBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                voiceBtn.innerHTML = '<i data-lucide="square" width="20" height="20" style="color: white;"></i>';
                lucide.createIcons();
                voiceStatus.style.display = 'block';
                voiceStatusText.innerHTML = '<i data-lucide="mic" width="14" height="14" style="display: inline-block; vertical-align: middle; margin-right: 4px;"></i> Listening... Speak now';
                lucide.createIcons();
            };

            speechRecognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Show interim results while speaking
                if (interimTranscript) {
                    voiceStatusText.innerHTML = '<i data-lucide="mic" width="14" height="14" style="display: inline-block; vertical-align: middle; margin-right: 4px;"></i> "' + interimTranscript + '"';
                    lucide.createIcons();
                }

                // Append final results to text input
                if (finalTranscript) {
                    const currentText = textInput.value.trim();
                    textInput.value = currentText ? currentText + ' ' + finalTranscript : finalTranscript;
                    voiceStatusText.textContent = ' Got it!';
                    // Stop after getting final result since continuous is false
                    stopVoiceInput();
                }
            };

            speechRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    voiceStatusText.textContent = ' No speech detected. Try again.';
                } else if (event.error === 'not-allowed') {
                    voiceStatusText.textContent = ' Microphone access denied';
                } else if (event.error === 'aborted') {
                    // This is expected when we call abort(), not an error
                    console.log('Speech recognition was aborted');
                } else {
                    voiceStatusText.textContent = ' Error: ' + event.error;
                }
                // Don't call stopVoiceInput here for 'aborted' since we already are stopping
                if (event.error !== 'aborted') {
                    setTimeout(() => stopVoiceInput(), 1000);
                }
            };

            speechRecognition.onend = () => {
                console.log(' Speech recognition ended naturally');
                // Always clean up state when recognition ends
                isListening = false;
                speechRecognition = null;

                // Reset UI
                if (voiceBtn) {
                    voiceBtn.style.background = 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)';
                    voiceBtn.innerHTML = '<i data-lucide="mic" width="20" height="20" style="color: white;"></i>';
                    lucide.createIcons();
                }
                setTimeout(() => {
                    if (voiceStatus && !isListening) {
                        voiceStatus.style.display = 'none';
                    }
                }, 1500);
            };

            try {
                speechRecognition.start();
                console.log('Mic: Speech recognition started');
            } catch (err) {
                console.error('Failed to start speech recognition:', err);
                isListening = false;
                speechRecognition = null;
            }
        }

        function stopVoiceInput() {
            console.log(' Stopping voice input...');

            const voiceBtn = document.getElementById('voiceInputBtn');
            const voiceStatus = document.getElementById('voiceStatus');

            // Set flag first to prevent re-entry
            isListening = false;

            if (speechRecognition) {
                // Clear handlers FIRST to prevent onend from firing after abort
                const sr = speechRecognition;
                speechRecognition = null;

                sr.onstart = null;
                sr.onresult = null;
                sr.onerror = null;
                sr.onend = null;

                try {
                    sr.abort();
                    console.log('Speech recognition aborted');
                } catch (e) {
                    console.log('Speech recognition abort error:', e);
                }
            }

            // Reset UI immediately
            if (voiceBtn) {
                voiceBtn.style.background = 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)';
                voiceBtn.innerHTML = '<i data-lucide="mic" width="20" height="20" style="color: white;"></i>';
                lucide.createIcons();
            }

            setTimeout(() => {
                if (voiceStatus && !isListening) {
                    voiceStatus.style.display = 'none';
                }
            }, 1000);

            console.log(' Voice input stopped');
        }

        async function analyzeTextWithAI() {
            // Stop voice input immediately when analyzing
            stopVoiceInput();

            const text = document.getElementById('foodDescriptionInput').value.trim();

            if (!text) {
                showToast('Please describe what you ate');
                return;
            }

            document.getElementById('aiTextInput').style.display = 'none';
            document.getElementById('aiTextAnalyzing').style.display = 'block';

            try {
                // Use authenticated API call
                const data = await apiPost('/.netlify/functions/analyze-food-text', { text });
                console.log('AI Text response:', data);

                aiTextDetectedFoods = data.foods || [];

                if (aiTextDetectedFoods.length === 0) {
                    showToast('Could not identify any food items');
                    resetAIText();
                    return;
                }

                renderAITextResults();
            } catch (err) {
                console.error('Error analyzing text:', err);
                showToast('Failed to analyze. Try again.');
                resetAIText();
            }
        }

        function renderAITextResults() {
            document.getElementById('aiTextAnalyzing').style.display = 'none';
            document.getElementById('aiTextResults').style.display = 'block';

            const container = document.getElementById('aiTextDetectedItems');
            container.innerHTML = aiTextDetectedFoods.map((food, idx) => `
                <div class="ai-food-item" id="ai-text-food-${idx}" style="position: relative; padding-right: 40px;">
                    <button onclick="removeAITextFood(${idx})" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center;"></button>
                    <div class="ai-food-name">${food.name}</div>
                    <div class="ai-food-macros" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <input type="number" value="${food.calories}" onchange="updateAITextFood(${idx}, 'calories', this.value)" style="width: 50px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;"> cal
                        <input type="number" value="${food.protein}" onchange="updateAITextFood(${idx}, 'protein', this.value)" style="width: 40px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">g P
                        <input type="number" value="${food.carbs}" onchange="updateAITextFood(${idx}, 'carbs', this.value)" style="width: 40px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">g C
                        <input type="number" value="${food.fat}" onchange="updateAITextFood(${idx}, 'fat', this.value)" style="width: 40px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">g F
                    </div>
                </div>
            `).join('');
        }

        function removeAITextFood(idx) {
            aiTextDetectedFoods.splice(idx, 1);
            renderAITextResults();
            if (aiTextDetectedFoods.length === 0) {
                showToast('No items left. Try again.');
                resetAIText();
            }
        }

        function updateAITextFood(idx, field, value) {
            aiTextDetectedFoods[idx][field] = parseInt(value) || 0;
        }

        async function addAITextFoods() {
            // Stop microphone immediately - CRITICAL
            stopVoiceInput();

            if (!clientId) {
                showToast('Error: Not logged in');
                return;
            }

            if (aiTextDetectedFoods.length === 0) {
                showToast('No foods to add');
                return;
            }

            const foodsToAdd = [...aiTextDetectedFoods];
            closeAITextModal();
            showToast('Adding foods...');

            let addedCount = 0;
            let errors = [];

            for (const food of foodsToAdd) {
                try {
                    const payload = {
                        clientId,
                        coachId,
                        entryDate: formatDate(currentDate),
                        mealType: currentMealType,
                        foodName: food.name,
                        numberOfServings: 1,
                        servingSize: 1,
                        servingUnit: 'serving',
                        calories: food.calories,
                        protein: food.protein,
                        carbs: food.carbs,
                        fat: food.fat,
                        foodSource: 'ai_text'
                    };

                    // Use authenticated API call
                    const data = await apiPost('/.netlify/functions/food-diary', payload);
                    addedCount++;
                } catch (err) {
                    console.error('Error adding food:', err);
                    errors.push(err.message);
                }
            }

            await loadDiaryEntries();

            if (errors.length > 0) {
                showToast(`Added ${addedCount}/${foodsToAdd.length} items. Errors: ${errors.join(', ')}`);
            } else {
                showToast(`Added ${addedCount} items!`);
            }
        }

        // ==========================================
        // PHASE 2: Weight Tracking
        // ==========================================
        let weightData = [];

        function openWeightLogModal() {
            document.getElementById('weightLogModal').classList.add('active');
            document.getElementById('weightInput').value = '';
            document.getElementById('weightDateInput').value = formatDate(new Date());
            document.getElementById('weightNotesInput').value = '';
        }

        function closeWeightLogModal() {
            document.getElementById('weightLogModal').classList.remove('active');
        }

        async function saveWeight() {
            const weight = parseFloat(document.getElementById('weightInput').value);
            const date = document.getElementById('weightDateInput').value;
            const notes = document.getElementById('weightNotesInput').value;

            if (!weight || weight <= 0) {
                showToast('Please enter a valid weight');
                return;
            }

            try {
                await supabaseClient
                    .from('weight_logs')
                    .upsert({
                        client_id: clientId,
                        date: date,
                        weight: weight,
                        notes: notes
                    }, { onConflict: 'client_id,date' });

                closeWeightLogModal();
                showToast('Weight logged!');
                await loadWeightData();
            } catch (err) {
                console.error('Error saving weight:', err);
                showToast('Failed to save weight');
            }
        }

        async function loadWeightData() {
            try {
                const { data, error } = await supabaseClient
                    .from('weight_logs')
                    .select('*')
                    .eq('client_id', clientId)
                    .order('date', { ascending: false })
                    .limit(30);

                if (error) throw error;

                weightData = data || [];
                renderWeightCard();
            } catch (err) {
                console.error('Error loading weight data:', err);
                // Table might not exist yet
                weightData = [];
                renderWeightCard();
            }
        }

        function renderWeightCard() {
            const currentWeightEl = document.getElementById('currentWeight');
            const weightChangeEl = document.getElementById('weightChange');
            const weightStartEl = document.getElementById('weightStart');
            const weightLowestEl = document.getElementById('weightLowest');
            const weightHighestEl = document.getElementById('weightHighest');
            const weightTotalEl = document.getElementById('weightTotal');

            if (weightData.length === 0) {
                currentWeightEl.textContent = '--';
                weightChangeEl.textContent = '';
                weightStartEl.textContent = '--';
                weightLowestEl.textContent = '--';
                weightHighestEl.textContent = '--';
                weightTotalEl.textContent = '--';
                return;
            }

            const current = weightData[0].weight;
            const previous = weightData[1]?.weight;
            const oldest = weightData[weightData.length - 1].weight;
            const lowest = Math.min(...weightData.map(w => w.weight));
            const highest = Math.max(...weightData.map(w => w.weight));
            const totalChange = current - oldest;

            currentWeightEl.textContent = current.toFixed(1);
            weightStartEl.textContent = oldest.toFixed(1);
            weightLowestEl.textContent = lowest.toFixed(1);
            weightHighestEl.textContent = highest.toFixed(1);

            if (totalChange > 0) {
                weightTotalEl.textContent = `+${totalChange.toFixed(1)}`;
            } else if (totalChange < 0) {
                weightTotalEl.textContent = totalChange.toFixed(1);
            } else {
                weightTotalEl.textContent = '0';
            }

            if (previous) {
                const change = current - previous;
                if (change < 0) {
                    weightChangeEl.textContent = ` ${Math.abs(change).toFixed(1)} lbs`;
                    weightChangeEl.className = 'weight-change down';
                } else if (change > 0) {
                    weightChangeEl.textContent = ` ${change.toFixed(1)} lbs`;
                    weightChangeEl.className = 'weight-change up';
                } else {
                    weightChangeEl.textContent = 'No change';
                    weightChangeEl.className = 'weight-change same';
                }
            }

            // Draw mini chart
            drawWeightChart();
        }

        function drawWeightChart() {
            const canvas = document.getElementById('weightChartCanvas');
            if (!canvas || weightData.length < 2) return;

            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);

            const width = rect.width;
            const height = rect.height;
            const padding = 10;

            const weights = weightData.slice(0, 14).reverse().map(w => w.weight);
            const min = Math.min(...weights) - 2;
            const max = Math.max(...weights) + 2;
            const range = max - min || 1;

            ctx.clearRect(0, 0, width, height);

            // Draw line
            ctx.beginPath();
            ctx.strokeStyle = '#0ea5e9';
            ctx.lineWidth = 2;

            weights.forEach((w, i) => {
                const x = padding + (i / (weights.length - 1)) * (width - padding * 2);
                const y = height - padding - ((w - min) / range) * (height - padding * 2);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // Draw points
            ctx.fillStyle = '#0ea5e9';
            weights.forEach((w, i) => {
                const x = padding + (i / (weights.length - 1)) * (width - padding * 2);
                const y = height - padding - ((w - min) / range) * (height - padding * 2);
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // ==========================================
        // PHASE 2: Weekly Summary
        // ==========================================
        function openWeeklySummary() {
            generateWeeklySummary();
            document.getElementById('weeklySummaryModal').classList.add('active');
        }

        function closeWeeklySummary() {
            document.getElementById('weeklySummaryModal').classList.remove('active');
        }

        async function generateWeeklySummary() {
            const container = document.getElementById('weeklySummaryContent');
            container.innerHTML = '<div class="ai-analyzing"><div class="ai-analyzing-spinner"></div><div class="ai-analyzing-text">Loading weekly data...</div></div>';

            try {
                // Get last 7 days of data
                const days = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    days.push(formatDate(d));
                }

                const { data, error } = await supabaseClient
                    .from('food_diary_entries')
                    .select('entry_date, calories, protein, carbs, fat')
                    .eq('client_id', clientId)
                    .in('entry_date', days);

                if (error) throw error;

                // Aggregate by day
                const dayData = {};
                days.forEach(d => {
                    dayData[d] = { calories: 0, protein: 0, carbs: 0, fat: 0, entries: 0 };
                });

                (data || []).forEach(entry => {
                    if (dayData[entry.entry_date]) {
                        dayData[entry.entry_date].calories += entry.calories || 0;
                        dayData[entry.entry_date].protein += entry.protein || 0;
                        dayData[entry.entry_date].carbs += entry.carbs || 0;
                        dayData[entry.entry_date].fat += entry.fat || 0;
                        dayData[entry.entry_date].entries++;
                    }
                });

                // Calculate stats
                const dayValues = Object.values(dayData);
                const daysLogged = dayValues.filter(d => d.entries > 0).length;
                const totalCalories = dayValues.reduce((sum, d) => sum + d.calories, 0);
                const avgCalories = daysLogged > 0 ? Math.round(totalCalories / daysLogged) : 0;
                const totalProtein = dayValues.reduce((sum, d) => sum + d.protein, 0);
                const avgProtein = daysLogged > 0 ? Math.round(totalProtein / daysLogged) : 0;
                const calorieGoal = goals.calorie_goal || 2000;
                const proteinGoal = goals.protein_goal || 150;

                // Find max for chart scaling
                const maxCals = Math.max(...dayValues.map(d => d.calories), calorieGoal);

                // Generate bar chart HTML
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const barsHtml = days.map(dateStr => {
                    const d = new Date(dateStr + 'T12:00:00');
                    const dayName = dayNames[d.getDay()];
                    const dayInfo = dayData[dateStr];
                    const height = maxCals > 0 ? (dayInfo.calories / maxCals) * 140 : 0;
                    let barClass = '';
                    if (dayInfo.calories > 0 && dayInfo.calories < calorieGoal * 0.8) barClass = 'under';
                    if (dayInfo.calories > calorieGoal * 1.1) barClass = 'over';

                    return `
                        <div class="weekly-bar-item">
                            <div class="weekly-bar ${barClass}" style="height: ${height}px;"></div>
                            <div class="weekly-bar-label">${dayName}</div>
                            <div class="weekly-bar-value">${dayInfo.calories > 0 ? dayInfo.calories : '-'}</div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: var(--gray-900);">Last 7 Days</h3>

                    <div class="weekly-chart">
                        <div style="position: absolute; left: 0; top: 0; width: 100%; border-bottom: 1px dashed var(--gray-300); color: var(--gray-400); font-size: 0.7rem;">Goal: ${calorieGoal}</div>
                        <div class="weekly-bars">
                            ${barsHtml}
                        </div>
                    </div>

                    <div class="weekly-summary-stats">
                        <div class="weekly-stat">
                            <div class="weekly-stat-value">${daysLogged}/7</div>
                            <div class="weekly-stat-label">Days Logged</div>
                        </div>
                        <div class="weekly-stat">
                            <div class="weekly-stat-value">${avgCalories}</div>
                            <div class="weekly-stat-label">Avg Calories</div>
                        </div>
                        <div class="weekly-stat">
                            <div class="weekly-stat-value">${totalCalories.toLocaleString()}</div>
                            <div class="weekly-stat-label">Total Calories</div>
                        </div>
                        <div class="weekly-stat">
                            <div class="weekly-stat-value">${avgProtein}g</div>
                            <div class="weekly-stat-label">Avg Protein</div>
                        </div>
                    </div>

                    ${daysLogged >= 5 ? `
                        <div class="report-insights" style="margin-top: 20px;">
                            <div class="report-insights-title"> Weekly Insights</div>
                            ${avgCalories < calorieGoal * 0.9 ? '<div class="report-insight"> Your average intake is below your goal. Make sure you\'re eating enough!</div>' : ''}
                            ${avgCalories > calorieGoal * 1.1 ? '<div class="report-insight"> You\'re averaging above your calorie goal this week.</div>' : ''}
                            ${avgProtein >= proteinGoal ? '<div class="report-insight"> Great job hitting your protein targets!</div>' : ''}
                            ${daysLogged === 7 ? '<div class="report-insight"> Perfect week! You logged every single day!</div>' : ''}
                        </div>
                    ` : ''}
                `;
            } catch (err) {
                console.error('Error generating weekly summary:', err);
                container.innerHTML = '<p style="text-align: center; color: var(--gray-500);">Failed to load weekly data</p>';
            }
        }

        // ==========================================
        // AI NUTRITION ASSISTANT FUNCTIONS
        // ==========================================

        let aiChatHistory = [];
        let pendingFoodLog = null;
        let aiExpanded = false;

        // Toggle AI assistant expand/collapse
        function toggleAIExpand() {
            aiExpanded = !aiExpanded;
            const card = document.getElementById('aiAssistantCard');
            const overlay = document.getElementById('aiExpandedOverlay');
            const expandIcon = document.getElementById('aiExpandIcon');
            const expandText = document.getElementById('aiExpandText');

            if (aiExpanded) {
                card.classList.add('expanded');
                overlay.classList.add('visible');
                expandIcon.textContent = '';
                expandText.textContent = 'Close';
                document.body.style.overflow = 'hidden';
                // Focus the input when expanded
                setTimeout(() => {
                    document.getElementById('aiInput').focus();
                }, 100);
            } else {
                card.classList.remove('expanded');
                overlay.classList.remove('visible');
                expandIcon.textContent = '';
                expandText.textContent = 'Expand';
                document.body.style.overflow = '';
            }
        }

        // Close expanded view with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && aiExpanded) {
                toggleAIExpand();
            }
        });

        // Update AI suggestions based on remaining macros
        function updateAISuggestions() {
            // Use the goals object that's already defined in the page
            if (!goals || !goals.calorie_goal) return;
            if (!currentTotals) return;

            const calorieGoal = goals.calorie_goal || 2000;
            const proteinGoal = goals.protein_goal || 150;
            const carbsGoal = goals.carbs_goal || 200;
            const fatGoal = goals.fat_goal || 65;

            const totalCals = currentTotals.calories || 0;
            const totalProt = currentTotals.protein || 0;
            const totalCarb = currentTotals.carbs || 0;
            const totalFats = currentTotals.fat || 0;

            const remaining = {
                calories: calorieGoal - totalCals,
                protein: proteinGoal - totalProt,
                carbs: carbsGoal - totalCarb,
                fat: fatGoal - totalFats
            };

            const suggestions = [];

            // Check what's most needed
            const proteinPct = (totalProt / proteinGoal) * 100;
            const carbsPct = (totalCarb / carbsGoal) * 100;
            const fatPct = (totalFats / fatGoal) * 100;

            if (remaining.protein > 30 && proteinPct < 70) {
                suggestions.push({
                    type: 'protein',
                    text: `Need ${Math.round(remaining.protein)}g more protein`,
                    action: 'What high protein foods should I eat?'
                });
            }

            if (remaining.carbs > 50 && carbsPct < 60) {
                suggestions.push({
                    type: 'carbs',
                    text: `${Math.round(remaining.carbs)}g carbs remaining`,
                    action: 'What healthy carb options do I have?'
                });
            }

            if (remaining.fat > 20 && fatPct < 50) {
                suggestions.push({
                    type: 'fat',
                    text: `${Math.round(remaining.fat)}g fat to go`,
                    action: 'What healthy fats should I add?'
                });
            }

            if (remaining.calories > 500) {
                suggestions.push({
                    type: '',
                    text: `${remaining.calories} cal remaining`,
                    action: 'What should I eat with ' + remaining.calories + ' calories left?'
                });
            }

            // Always add the "what's in my fridge" option as a helpful feature
            suggestions.push({
                type: 'ingredients',
                text: '<i data-lucide="chef-hat" width="14" height="14"></i> What can I make?',
                action: 'I have some ingredients - help me make a meal'
            });

            const container = document.getElementById('aiSuggestions');
            if (!container) return;

            if (suggestions.length === 0) {
                container.innerHTML = '<div class="ai-suggestion-chip"><i data-lucide="sparkles" width="14" height="14"></i> You\'re on track today!</div>';
                lucide.createIcons();
                return;
            }

            container.innerHTML = suggestions.map(s => `
                <div class="ai-suggestion-chip ${s.type}" onclick="askAI('${s.action}')">
                    ${s.text}
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Send message to AI
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();

            if (!message) return;

            // Clear input
            input.value = '';

            // Add user message to chat
            addChatMessage(message, 'user');

            // Show loading
            document.getElementById('aiLoading').style.display = 'flex';
            document.getElementById('aiSendBtn').disabled = true;

            try {
                // Use authenticated API call
                const data = await apiPost('/.netlify/functions/client-diary-ai', {
                    clientId: clientId,
                    clientFirstName: clientFirstName,
                    message: message,
                    todayEntries: entries || [],
                    goals: goals || {},
                    totals: currentTotals || { calories: 0, protein: 0, carbs: 0, fat: 0 }
                });

                // Hide loading
                document.getElementById('aiLoading').style.display = 'none';
                document.getElementById('aiSendBtn').disabled = false;

                if (data.error) {
                    addChatMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                    return;
                }

                // Check if AI wants to log food
                if (data.parsed && data.parsed.action === 'log_food') {
                    pendingFoodLog = data.parsed;
                    showFoodLogPreview(data.parsed);
                } else {
                    // Regular text response
                    addChatMessage(data.response, 'assistant');
                }

            } catch (err) {
                console.error('AI error:', err);
                document.getElementById('aiLoading').style.display = 'none';
                document.getElementById('aiSendBtn').disabled = false;
                addChatMessage('Sorry, I couldn\'t connect to the AI. Please try again.', 'assistant');
            }
        }

        // Quick ask AI function
        function askAI(question) {
            document.getElementById('aiInput').value = question;
            sendAIMessage();
        }

        // Handle Enter key in input
        function handleAIKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAIMessage();
            }
        }

        // Add message to chat
        function addChatMessage(text, type) {
            const container = document.getElementById('aiChatMessages');
            container.classList.add('has-messages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${type}`;
            messageDiv.textContent = text;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            aiChatHistory.push({ text, type });
        }

        // Show food log preview from AI
        function showFoodLogPreview(foodData) {
            const container = document.getElementById('aiChatMessages');
            container.classList.add('has-messages');

            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message assistant food-log';
            messageDiv.innerHTML = `
                ${foodData.confirmation || 'Ready to log this food:'}
                <div class="ai-food-log-preview">
                    <div class="food-name">${foodData.food_name}</div>
                    <div class="food-macros">
                        ${foodData.calories} cal  ${foodData.protein}g P  ${foodData.carbs}g C  ${foodData.fat}g F
                    </div>
                </div>
                <div class="ai-food-log-actions">
                    <button class="confirm-btn" onclick="confirmAIFoodLog()"> Add to ${foodData.meal_type || 'diary'}</button>
                    <button class="cancel-btn" onclick="cancelAIFoodLog()">Cancel</button>
                </div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Confirm and add food from AI
        async function confirmAIFoodLog() {
            if (!pendingFoodLog) return;

            const food = pendingFoodLog;

            // Determine meal type or use current time to guess
            let mealType = food.meal_type || 'snack';
            const hour = new Date().getHours();
            if (!food.meal_type) {
                if (hour >= 5 && hour < 11) mealType = 'breakfast';
                else if (hour >= 11 && hour < 15) mealType = 'lunch';
                else if (hour >= 15 && hour < 21) mealType = 'dinner';
                else mealType = 'snack';
            }

            try {
                // Use authenticated API call
                await apiPost('/.netlify/functions/food-diary', {
                    clientId,
                    foodName: food.food_name,
                    calories: food.calories,
                    protein: food.protein,
                    carbs: food.carbs,
                    fat: food.fat,
                    mealType: mealType,
                    date: formatDate(currentDate),
                    servingSize: '1 serving'
                });

                // Clear pending and show success FIRST
                pendingFoodLog = null;
                addChatMessage(`Added "${food.food_name}" to your ${mealType}!`, 'assistant');

                // Refresh diary (errors here won't affect the success message)
                try {
                    await loadDiaryEntries();
                    updateSummary();
                    updateAISuggestions();
                } catch (refreshErr) {
                    console.error('Error refreshing diary:', refreshErr);
                }

            } catch (err) {
                console.error('Error adding food:', err);
                addChatMessage('Sorry, I couldn\'t add that food. Please try manually.', 'assistant');
            }
        }

        // Cancel food log from AI
        function cancelAIFoodLog() {
            pendingFoodLog = null;
            addChatMessage('No problem! Let me know if you want to log something else.', 'assistant');
        }

        // Initialize AI suggestions when diary loads
        function initAIAssistant() {
            setTimeout(() => {
                updateAISuggestions();
            }, 500);
        }

        // Call init when diary is ready (add to existing init chain)
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for diary to load then init AI
            const checkDiaryLoaded = setInterval(() => {
                if (typeof calorieGoal !== 'undefined' && calorieGoal > 0) {
                    clearInterval(checkDiaryLoaded);
                    initAIAssistant();
                }
            }, 500);
        });
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
    <!-- Fallback for Safari PWA cached script -->
    <script>if(typeof lucide !== 'undefined') lucide.createIcons();</script>
</body>
</html>
