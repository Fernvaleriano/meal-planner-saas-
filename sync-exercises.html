<!DOCTYPE html>
<html>
<head>
  <title>Sync Exercises</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; }
    #log { background: #1e1e1e; color: #0f0; padding: 20px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    .error { color: #f66; }
    .success { color: #6f6; }
    select { padding: 10px; font-size: 16px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Exercise Sync Tool</h1>
  <p>This runs in your browser - calls Netlify function for DB writes (no RLS issues!)</p>

  <div>
    <button onclick="loadFolders()">1. Load Folders</button>
    <select id="folderSelect"><option>-- Load folders first --</option></select>
  </div>

  <div style="margin-top: 20px;">
    <button onclick="syncFolder()">2. Sync Selected Folder</button>
    <button onclick="syncAllFolders()">3. Sync ALL Folders</button>
    <button onclick="stopSync()" style="background:#f66">Stop</button>
  </div>

  <div id="log"></div>

  <script>
    const SUPABASE_URL = 'https://qewqcjzlfqamqwbccapr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFld3FjanpsZnFhbXF3YmNjYXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2OTg0NzAsImV4cCI6MjA3OTI3NDQ3MH0.mQnMC33O88oLkLLGWD2oG-oaSHGI-NfHmtQCZxnxSLs';
    const BUCKET = 'exercise-videos';

    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let shouldStop = false;
    let allSubfolders = [];

    function log(msg, type = '') {
      const el = document.getElementById('log');
      el.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
      el.scrollTop = el.scrollHeight;
    }

    async function loadFolders() {
      log('Loading folders from storage...');
      allSubfolders = [];

      const { data: topLevel } = await db.storage.from(BUCKET).list('', { limit: 100 });
      const mainFolders = (topLevel || []).filter(f => f.id === null);

      for (const folder of mainFolders) {
        const { data: subs } = await db.storage.from(BUCKET).list(folder.name, { limit: 100 });
        const subfolders = (subs || []).filter(s => s.id === null);

        if (subfolders.length > 0) {
          for (const sub of subfolders) {
            allSubfolders.push(`${folder.name}/${sub.name}`);
          }
        } else {
          allSubfolders.push(folder.name);
        }
      }

      const select = document.getElementById('folderSelect');
      select.innerHTML = allSubfolders.map(f => `<option value="${f}">${f}</option>`).join('');
      log(`Found ${allSubfolders.length} folders to sync`, 'success');
    }

    async function syncFolder(folderPath) {
      const folder = folderPath || document.getElementById('folderSelect').value;
      log(`Syncing: ${folder}`);

      let start = 0;
      let total = 0;
      let hasMore = true;

      // Call Netlify function in batches until done
      while (hasMore && !shouldStop) {
        try {
          const url = `/.netlify/functions/sync-exercises-from-videos?folder=${encodeURIComponent(folder)}&start=${start}`;
          log(`Fetching batch at offset ${start}...`);

          const response = await fetch(url);
          const result = await response.json();

          if (!response.ok) {
            log(`Error: ${result.error || 'Unknown error'}`, 'error');
            break;
          }

          if (result.created > 0) {
            total += result.created;
            log(`Added ${result.created} exercises: ${result.exercises.slice(0, 3).join(', ')}${result.exercises.length > 3 ? '...' : ''}`);
          }

          if (result.errors && result.errors.length > 0) {
            log(`Errors: ${result.errors.join(', ')}`, 'error');
          }

          hasMore = result.batch?.hasMore || false;
          start += 15; // Match the batch size in the function

          // Small delay to avoid hammering the server
          if (hasMore) await new Promise(r => setTimeout(r, 200));

        } catch (err) {
          log(`Network error: ${err.message}`, 'error');
          break;
        }
      }

      log(`Folder complete: ${folder} - ${total} exercises`, 'success');
      return total;
    }

    async function syncAllFolders() {
      shouldStop = false;
      log('Starting sync of ALL folders...');
      let grandTotal = 0;

      for (let i = 0; i < allSubfolders.length; i++) {
        if (shouldStop) {
          log('Stopped by user', 'error');
          break;
        }
        log(`[${i+1}/${allSubfolders.length}] ${allSubfolders[i]}`);
        const count = await syncFolder(allSubfolders[i]);
        grandTotal += count;
      }

      log(`ALL DONE! Total exercises synced: ${grandTotal}`, 'success');
    }

    function stopSync() {
      shouldStop = true;
      log('Stopping...', 'error');
    }
  </script>
</body>
</html>
