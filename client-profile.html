<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/icons/logo.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0d9488">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zique Fitness">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/logo.png">
    <script src="/js/theme.js"></script>
    <title>Client Profile - Zique Fitness Nutrition</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" as="script">
    <link rel="preload" href="https://unpkg.com/lucide@0.312.0/dist/umd/lucide.min.js" as="script">
    <link rel="preconnect" href="https://qewqcjzlfqamqwbccapr.supabase.co" crossorigin>
    <link rel="dns-prefetch" href="https://qewqcjzlfqamqwbccapr.supabase.co">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/coach-layout.css">
    <style>
        :root {
            --brand-primary: #0d9488;
            --brand-secondary: #0284c7;
            --brand-gradient: linear-gradient(135deg, #0d9488 0%, #0284c7 100%);
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .page-container {
            padding: 32px;
            max-width: 1200px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Client Info Card */
        .client-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-100);
            margin-bottom: 24px;
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 28px;
        }

        .client-header-info {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }

        .client-profile-avatar {
            width: 72px;
            height: 72px;
            min-width: 72px;
            background: linear-gradient(135deg, #0d9488 0%, #0284c7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
            color: white;
            overflow: hidden;
        }

        .client-profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .client-name {
            font-size: 2rem;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 12px;
            letter-spacing: -0.025em;
        }

        .client-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: var(--gray-600);
            font-size: 14px;
        }

        .client-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .client-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--brand-gradient);
            color: white;
            box-shadow: 0 4px 14px rgba(13, 148, 136, 0.25);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.35);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-edit {
            background: var(--brand-primary);
            color: white;
        }

        .btn-back {
            background: var(--gray-100);
            color: var(--gray-700);
        }


        .client-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            padding: 24px;
            background: var(--gray-50);
            border-radius: 14px;
            border: 1px solid var(--gray-100);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--brand-primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--gray-500);
            text-transform: uppercase;
            margin-top: 6px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Reminder Status */
        .reminder-status-section {
            margin-top: 24px;
            padding: 20px 24px;
            background: var(--gray-50);
            border-radius: 14px;
            border: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .reminder-status-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .reminder-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .reminder-status-badge.enabled {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .reminder-status-badge.disabled {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .reminder-status-badge.no-prefs {
            background: var(--gray-100);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
        }

        .reminder-last-sent {
            font-size: 13px;
            color: var(--gray-500);
        }

        .reminder-toggle-btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .reminder-toggle-btn.enable {
            background: var(--brand-primary);
            color: white;
        }

        .reminder-toggle-btn.enable:hover {
            background: #0f766e;
            transform: translateY(-1px);
        }

        .reminder-toggle-btn.disable {
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .reminder-toggle-btn.disable:hover {
            background: var(--gray-300);
        }

        /* Plans Section */
        .plans-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Protocols Section */
        .protocols-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .protocol-card {
            background: #f8f9ff;
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .protocol-card:hover {
            border-color: #0d9488;
        }

        .protocol-name {
            font-weight: 700;
            color: #0d9488;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .protocol-timing {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .protocol-schedule {
            margin: 10px 0;
            padding-left: 20px;
        }

        .protocol-schedule li {
            color: #7c3aed;
            margin-bottom: 4px;
        }

        .protocol-notes {
            margin-top: 12px;
            padding: 12px;
            background: #f0fdf4;
            border-radius: 8px;
            color: #166534;
            font-size: 0.9em;
        }

        .protocol-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e7ff;
        }

        .protocol-btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            border: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .protocol-btn-edit {
            background: #0d9488;
            color: white;
        }

        .protocol-btn-edit:hover {
            background: #0f766e;
        }

        .protocol-btn-delete {
            background: #ef4444;
            color: white;
        }

        .protocol-btn-delete:hover {
            background: #dc2626;
        }

        /* Protocol Edit Modal */
        .protocol-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .protocol-modal.active {
            display: flex;
        }

        .protocol-modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .protocol-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .protocol-modal-header h2 {
            color: #0d9488;
            font-size: 20px;
            margin: 0;
        }

        .protocol-modal-body {
            padding: 24px;
        }

        .protocol-form-group {
            margin-bottom: 16px;
        }

        .protocol-form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .protocol-form-group input,
        .protocol-form-group select,
        .protocol-form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .protocol-form-group input:focus,
        .protocol-form-group select:focus,
        .protocol-form-group textarea:focus {
            outline: none;
            border-color: #0d9488;
        }

        .protocol-form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .protocol-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .no-protocols {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .collapsible-header {
            padding: 8px;
            margin: -8px -8px 20px -8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .collapsible-header:hover {
            background: rgba(0,0,0,0.03);
        }

        [data-theme="dark"] .collapsible-header:hover {
            background: rgba(255,255,255,0.05);
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .plan-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #0d9488;
        }

        .plan-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .plan-date {
            font-size: 14px;
            color: #999;
        }

        .plan-actions {
            display: flex;
            gap: 5px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: #f0f0f0;
        }

        /* Bulk Selection Styles */
        .bulk-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .bulk-actions-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .select-all-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #0d9488;
        }

        .select-all-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            user-select: none;
        }

        .selected-count {
            font-size: 14px;
            color: #666;
            padding: 4px 12px;
            background: #f0f0f0;
            border-radius: 20px;
        }

        .btn-delete-selected {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .btn-delete-selected:hover {
            background: #dc2626;
        }

        .btn-delete-selected.visible {
            display: flex;
        }

        /* Plan card checkbox */
        .plan-card-checkbox {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #0d9488;
            z-index: 10;
        }

        .plan-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            padding-left: 50px;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            cursor: pointer;
            position: relative;
        }

        .plan-card.selected {
            border-color: #0d9488;
            background: #f0fdf9;
        }

        .view-btn {
            width: 100%;
            background: linear-gradient(135deg, #0d9488 0%, #0284c7 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .view-btn:hover {
            opacity: 0.9;
        }

        .plan-status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .plan-status-badge.draft {
            background: #fef3c7;
            color: #d97706;
        }

        .plan-status-badge.published {
            background: #d1fae5;
            color: #059669;
        }

        .publish-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            width: 100%;
        }

        .publish-btn:hover {
            background: #059669;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 20px;
            color: #333;
            margin-bottom: 10px;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        /* Food Diary Section */
        .diary-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .diary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .diary-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .diary-date-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .diary-nav-btn {
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            font-size: 18px;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
        }

        .diary-nav-btn:hover {
            background: #e2e8f0;
            color: #334155;
        }

        #diaryDatePicker {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            color: #334155;
        }

        .diary-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .diary-summary-item {
            text-align: center;
        }

        .diary-summary-value {
            display: block;
            font-size: 24px;
            font-weight: 700;
            color: #166534;
        }

        .diary-summary-label {
            font-size: 12px;
            color: #4ade80;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .diary-meal-group {
            margin-bottom: 16px;
        }

        .diary-meal-title {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .diary-food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .diary-food-name {
            font-weight: 500;
            color: #334155;
            flex: 1;
        }

        .diary-food-macros {
            display: flex;
            gap: 12px;
            font-size: 13px;
            color: #64748b;
        }

        .diary-food-macros span {
            min-width: 50px;
            text-align: right;
        }

        .diary-empty {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .diary-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        @media (max-width: 600px) {
            .diary-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            .diary-food-macros {
                flex-wrap: wrap;
                gap: 6px;
            }
        }

        /* AI Coach Assistant Section */
        .ai-assistant-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ai-assistant-header {
            margin-bottom: 8px;
        }

        .ai-assistant-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .ai-assistant-description {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .ai-quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .ai-quick-btn {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            color: #0369a1;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-quick-btn:hover {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            transform: translateY(-1px);
        }

        .ai-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        #aiCoachQuestion {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }

        #aiCoachQuestion:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .ai-ask-btn {
            padding: 12px 24px;
            white-space: nowrap;
        }

        .ai-response-container {
            margin-top: 20px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #bbf7d0;
        }

        .ai-response-header {
            font-weight: 600;
            color: #166534;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .ai-response-text {
            color: #1e3a2f;
            line-height: 1.6;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .ai-loading {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            color: #64748b;
            justify-content: center;
        }

        .ai-loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .ai-input-container {
                flex-direction: column;
            }
            .ai-ask-btn {
                width: 100%;
            }
            .ai-quick-questions {
                justify-content: center;
            }
        }

        /* Workout Progress Section */
        /* ============ ACTIVITY CALENDAR SECTION ============ */
        .activity-calendar-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .ac-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
            margin-top: 16px;
        }

        .ac-calendar-container {
            min-width: 0;
        }

        .ac-month-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .ac-month-nav button {
            background: none;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 18px;
            color: #0369a1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .ac-month-nav button:hover {
            background: #f0f9ff;
            border-color: #0369a1;
        }

        .ac-month-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .ac-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .ac-day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            padding: 8px 4px;
            text-transform: uppercase;
        }

        .ac-day-cell {
            min-height: 70px;
            border: 1px solid #f1f5f9;
            border-radius: 8px;
            padding: 4px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .ac-day-cell:hover {
            background: #f0f9ff;
            border-color: #93c5fd;
        }

        .ac-day-cell.selected {
            background: #eff6ff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }

        .ac-day-cell.today .ac-day-number {
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ac-day-cell.other-month {
            opacity: 0.35;
        }

        .ac-day-cell.has-workout::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #22c55e;
        }

        .ac-day-cell.has-logged::after {
            background: #3b82f6;
        }

        .ac-day-number {
            font-size: 13px;
            font-weight: 600;
            color: #334155;
            padding: 2px 4px;
            display: inline-flex;
        }

        .ac-day-icons {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 2px;
        }

        .ac-day-icon {
            font-size: 14px;
            line-height: 1;
        }

        /* Day Detail Panel */
        .ac-detail-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .ac-detail-header {
            padding: 16px 20px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 700;
            font-size: 16px;
            color: #1e293b;
        }

        .ac-detail-body {
            padding: 16px;
        }

        .ac-detail-workout-name {
            font-size: 14px;
            font-weight: 600;
            color: #0369a1;
            text-align: center;
            padding: 8px;
            background: #eff6ff;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .ac-detail-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .ac-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            background: white;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ac-action-btn:hover {
            background: #f0f9ff;
            border-color: #93c5fd;
            color: #0369a1;
        }

        .ac-action-btn.danger:hover {
            background: #fef2f2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        /* Exercise list in detail panel */
        .ac-exercise-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            position: relative;
        }

        .ac-exercise-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .ac-exercise-thumb {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            object-fit: cover;
            background: #f1f5f9;
            flex-shrink: 0;
        }

        .ac-exercise-info {
            flex: 1;
            min-width: 0;
        }

        .ac-exercise-name {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ac-exercise-meta {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }

        .ac-exercise-actions {
            display: flex;
            gap: 4px;
        }

        .ac-ex-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            color: #94a3b8;
            font-size: 16px;
            transition: all 0.15s;
        }

        .ac-ex-btn:hover {
            background: #f1f5f9;
            color: #475569;
        }

        .ac-ex-btn.delete:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Sets editing */
        .ac-sets-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .ac-set-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            color: #334155;
        }

        .ac-set-pill.completed {
            background: #dcfce7;
            border-color: #86efac;
            color: #166534;
        }

        /* Set editor inline */
        .ac-set-editor {
            margin-top: 10px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
        }

        .ac-set-row {
            display: grid;
            grid-template-columns: 40px 1fr 1fr 30px;
            gap: 8px;
            align-items: center;
            margin-bottom: 6px;
        }

        .ac-set-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
        }

        .ac-set-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
            background: white;
        }

        .ac-set-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
        }

        .ac-set-remove {
            background: none;
            border: none;
            cursor: pointer;
            color: #ef4444;
            font-size: 16px;
            padding: 2px;
        }

        .ac-set-add-btn {
            width: 100%;
            padding: 6px;
            border: 1px dashed #cbd5e1;
            border-radius: 6px;
            background: transparent;
            color: #64748b;
            font-size: 12px;
            cursor: pointer;
            margin-top: 6px;
        }

        .ac-set-add-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        .ac-set-save-btn {
            width: 100%;
            padding: 8px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }

        .ac-set-save-btn:hover { background: #2563eb; }
        .ac-set-save-btn:disabled { opacity: 0.5; cursor: default; }

        /* Empty state for detail panel */
        .ac-detail-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #94a3b8;
            text-align: center;
            gap: 12px;
        }

        .ac-detail-empty svg {
            width: 48px;
            height: 48px;
            stroke: #cbd5e1;
        }

        /* Exercise search modal */
        .ac-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .ac-modal-overlay.active {
            display: flex;
        }

        .ac-modal {
            background: #ffffff;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .ac-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ac-modal-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
        }

        .ac-modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #94a3b8;
            padding: 4px;
        }

        .ac-modal-body {
            padding: 16px 20px;
            overflow-y: auto;
            flex: 1;
        }

        .ac-modal-search {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .ac-modal-search:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .ac-modal-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .ac-filter-chip {
            padding: 5px 12px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            background: white;
            font-size: 12px;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.15s;
        }

        .ac-filter-chip.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .ac-exercise-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .ac-exercise-option:hover {
            background: #f0f9ff;
        }

        .ac-exercise-option.selected {
            background: #eff6ff;
            border: 1px solid #93c5fd;
            margin: -1px;
        }

        .ac-exercise-option .ac-modal-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid #cbd5e1;
            flex-shrink: 0;
            accent-color: #3b82f6;
            cursor: pointer;
        }

        .ac-modal-footer {
            padding: 12px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .ac-modal-footer .ac-add-selected-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }

        .ac-modal-footer .ac-add-selected-btn:hover {
            background: #2563eb;
        }

        .ac-modal-footer .ac-add-selected-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .ac-exercise-option img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            background: #f1f5f9;
        }

        .ac-exercise-option-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .ac-exercise-option-info span {
            font-size: 12px;
            color: #64748b;
        }

        /* Checkbox for multi-select */
        .ac-exercise-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid #cbd5e1;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: #3b82f6;
        }

        .ac-exercise-item.checked {
            background: #eff6ff;
            border-color: #93c5fd;
        }

        /* Bulk action bar */
        .ac-bulk-bar {
            display: none;
            background: #1e293b;
            border-radius: 10px;
            padding: 10px 14px;
            margin-bottom: 12px;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .ac-bulk-bar.visible {
            display: flex;
        }

        .ac-bulk-count {
            color: white;
            font-size: 13px;
            font-weight: 600;
            margin-right: 4px;
        }

        .ac-bulk-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .ac-bulk-btn:hover { background: rgba(255,255,255,0.2); }
        .ac-bulk-btn.danger:hover { background: rgba(239,68,68,0.3); color: #fca5a5; }

        /* 3-dot menu */
        .ac-dot-menu-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            color: #94a3b8;
            font-size: 18px;
            line-height: 1;
            letter-spacing: 1px;
        }

        .ac-dot-menu-btn:hover { background: #f1f5f9; color: #475569; }

        .ac-dot-menu {
            display: none;
            position: absolute;
            right: 8px;
            top: 40px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            z-index: 100;
            min-width: 180px;
            overflow: hidden;
        }

        .ac-dot-menu.open { display: block; }

        .ac-dot-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 500;
            color: #334155;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: background 0.1s;
        }

        .ac-dot-menu-item:hover { background: #f1f5f9; }
        .ac-dot-menu-item.danger { color: #dc2626; }
        .ac-dot-menu-item.danger:hover { background: #fef2f2; }

        /* Add Workout modal (program picker) */
        .ac-add-workout-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 16px;
        }

        .ac-add-workout-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .ac-add-workout-option:hover { border-color: #3b82f6; background: #f0f9ff; }

        .ac-add-workout-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .ac-add-workout-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .ac-add-workout-info span {
            font-size: 12px;
            color: #64748b;
        }

        .ac-program-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .ac-program-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.15s;
        }

        .ac-program-item:hover { background: #f0f9ff; }

        .ac-program-item img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
        }

        .ac-program-item-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .ac-program-item-info span {
            font-size: 12px;
            color: #64748b;
        }

        .ac-program-day-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 12px;
        }

        .ac-day-pick-btn {
            padding: 8px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .ac-day-pick-btn:hover { border-color: #3b82f6; background: #f0f9ff; }

        /* Exercise detail modal */
        .ac-exercise-detail-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .ac-exercise-detail-modal.active { display: flex; }

        .ac-exercise-detail-content {
            background: #ffffff;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .ac-exd-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .ac-exd-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .ac-exd-video-area {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: #f8fafc;
        }

        .ac-exd-video-area img {
            max-height: 220px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .ac-exd-tracking-toggle {
            display: flex;
            gap: 16px;
            padding: 0 24px 16px;
            align-items: center;
        }

        .ac-exd-tracking-toggle label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #334155;
            cursor: pointer;
        }

        .ac-exd-sets-area {
            padding: 0 24px 20px;
        }

        .ac-exd-set-header, .ac-exd-set-row {
            display: grid;
            grid-template-columns: 50px repeat(auto-fill, minmax(70px, 1fr)) 40px;
            gap: 6px;
            align-items: center;
            margin-bottom: 6px;
        }

        .ac-exd-set-header span {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-align: center;
        }

        .ac-exd-set-input {
            width: 100%;
            padding: 8px 6px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            background: white;
        }

        .ac-exd-set-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.15);
        }

        .ac-exd-calories {
            padding: 0 24px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ac-exd-calories label {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }

        .ac-exd-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            padding: 0 24px;
            gap: 24px;
        }

        .ac-exd-tab {
            padding: 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #94a3b8;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
        }

        .ac-exd-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .ac-exd-tab-content {
            padding: 16px 24px;
            min-height: 120px;
        }

        .ac-exd-history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
        }

        .ac-exd-actions {
            display: flex;
            gap: 10px;
            padding: 16px 24px;
            border-top: 1px solid #e2e8f0;
        }

        /* Move/Copy date picker */
        .ac-date-picker-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .ac-date-picker-modal.active { display: flex; }

        .ac-date-picker-content {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 340px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .ac-date-picker-content h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1e293b;
        }

        .ac-dp-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .ac-dp-nav button {
            background: none;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 16px;
            color: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ac-dp-nav button:hover { background: #f1f5f9; }

        .ac-dp-nav span {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .ac-dp-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 4px;
        }

        .ac-dp-weekdays span {
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            padding: 4px 0;
        }

        .ac-dp-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .ac-dp-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            border-radius: 8px;
            cursor: pointer;
            color: #334155;
            border: 2px solid transparent;
            background: none;
            font-weight: 500;
        }

        .ac-dp-day:hover { background: #f1f5f9; }
        .ac-dp-day.other-month { color: #cbd5e1; }
        .ac-dp-day.today { font-weight: 700; color: #3b82f6; }
        .ac-dp-day.selected { background: #3b82f6; color: #fff; border-color: #3b82f6; }

        .ac-date-picker-btns {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            justify-content: flex-end;
        }

        /* Loading spinner */
        .ac-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .ac-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: ac-spin 0.6s linear infinite;
        }

        @keyframes ac-spin {
            to { transform: rotate(360deg); }
        }

        /* Dark theme */
        [data-theme="dark"] .activity-calendar-section {
            background: var(--bg-secondary, #1e293b);
        }

        [data-theme="dark"] .ac-month-title { color: var(--text-primary, #f1f5f9); }
        [data-theme="dark"] .ac-month-nav button { border-color: var(--border-color, #334155); color: #60a5fa; }
        [data-theme="dark"] .ac-month-nav button:hover { background: rgba(96,165,250,0.1); }
        [data-theme="dark"] .ac-day-header { color: var(--text-secondary, #94a3b8); }
        [data-theme="dark"] .ac-day-cell { border-color: var(--border-color, #334155); }
        [data-theme="dark"] .ac-day-cell:hover { background: rgba(96,165,250,0.1); border-color: #60a5fa; }
        [data-theme="dark"] .ac-day-cell.selected { background: rgba(59,130,246,0.15); border-color: #3b82f6; }
        [data-theme="dark"] .ac-day-number { color: var(--text-primary, #f1f5f9); }
        [data-theme="dark"] .ac-detail-panel { background: var(--bg-tertiary, #334155); border-color: var(--border-color, #475569); }
        [data-theme="dark"] .ac-detail-header { background: var(--bg-secondary, #1e293b); border-color: var(--border-color, #475569); color: var(--text-primary); }
        [data-theme="dark"] .ac-detail-workout-name { background: rgba(59,130,246,0.15); color: #60a5fa; }
        [data-theme="dark"] .ac-action-btn { background: var(--bg-secondary, #1e293b); border-color: var(--border-color, #475569); color: var(--text-secondary); }
        [data-theme="dark"] .ac-action-btn:hover { background: rgba(96,165,250,0.1); color: #60a5fa; border-color: #60a5fa; }
        [data-theme="dark"] .ac-exercise-item { background: var(--bg-secondary, #1e293b); border-color: var(--border-color, #475569); }
        [data-theme="dark"] .ac-exercise-name { color: var(--text-primary); }
        [data-theme="dark"] .ac-exercise-meta { color: var(--text-secondary); }
        [data-theme="dark"] .ac-set-pill { background: var(--bg-tertiary, #334155); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .ac-set-editor { background: var(--bg-secondary, #1e293b); border-color: var(--border-color); }
        [data-theme="dark"] .ac-set-input { background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .ac-modal { background: var(--bg-secondary, #1e293b); }
        [data-theme="dark"] .ac-modal-header { border-color: var(--border-color); }
        [data-theme="dark"] .ac-modal-header h3 { color: var(--text-primary); }
        [data-theme="dark"] .ac-modal-search { background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .ac-exercise-option:hover { background: rgba(96,165,250,0.1); }
        [data-theme="dark"] .ac-exercise-option.selected { background: rgba(59,130,246,0.15); border-color: #3b82f6; }
        [data-theme="dark"] .ac-modal-footer { border-color: var(--border-color); }
        [data-theme="dark"] .ac-exercise-option-info h4 { color: var(--text-primary); }
        [data-theme="dark"] .ac-dot-menu { background: var(--bg-secondary); border-color: var(--border-color); box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
        [data-theme="dark"] .ac-dot-menu-item { color: var(--text-primary); }
        [data-theme="dark"] .ac-dot-menu-item:hover { background: var(--bg-tertiary); }
        [data-theme="dark"] .ac-dot-menu-item.danger { color: #f87171; }
        [data-theme="dark"] .ac-exercise-item.checked { background: rgba(59,130,246,0.15); border-color: #3b82f6; }
        [data-theme="dark"] .ac-bulk-bar { background: #0f172a; }
        [data-theme="dark"] .ac-add-workout-option { border-color: var(--border-color); }
        [data-theme="dark"] .ac-add-workout-option:hover { background: rgba(96,165,250,0.1); border-color: #60a5fa; }
        [data-theme="dark"] .ac-add-workout-info h4 { color: var(--text-primary); }
        [data-theme="dark"] #acCustomWorkoutName { background: var(--bg-tertiary, #334155) !important; border-color: var(--border-color, #475569) !important; color: var(--text-primary, #e2e8f0) !important; }
        [data-theme="dark"] .ac-program-item:hover { background: rgba(96,165,250,0.1); }
        [data-theme="dark"] .ac-program-item-info h4 { color: var(--text-primary); }
        [data-theme="dark"] .ac-exercise-detail-content { background: var(--bg-secondary, #1e293b); }
        [data-theme="dark"] .ac-exd-header { border-color: var(--border-color); }
        [data-theme="dark"] .ac-exd-title { color: var(--text-primary); }
        [data-theme="dark"] .ac-exd-video-area { background: var(--bg-tertiary); }
        [data-theme="dark"] .ac-exd-set-input { background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .ac-exd-tabs { border-color: var(--border-color); }
        [data-theme="dark"] .ac-exd-tab { color: var(--text-secondary); }
        [data-theme="dark"] .ac-exd-tab.active { color: #60a5fa; border-color: #60a5fa; }
        [data-theme="dark"] .ac-date-picker-content { background: var(--bg-secondary, #1e293b); }
        [data-theme="dark"] .ac-date-picker-content h3 { color: var(--text-primary); }
        [data-theme="dark"] .ac-dp-nav span { color: var(--text-primary); }
        [data-theme="dark"] .ac-dp-nav button { border-color: var(--border-color, #475569); color: var(--text-secondary); }
        [data-theme="dark"] .ac-dp-nav button:hover { background: var(--bg-tertiary, #334155); }
        [data-theme="dark"] .ac-dp-weekdays span { color: var(--text-secondary, #94a3b8); }
        [data-theme="dark"] .ac-dp-day { color: var(--text-primary, #e2e8f0); }
        [data-theme="dark"] .ac-dp-day:hover { background: var(--bg-tertiary, #334155); }
        [data-theme="dark"] .ac-dp-day.other-month { color: var(--text-secondary, #64748b); }
        [data-theme="dark"] .ac-dp-day.today { color: #60a5fa; }
        [data-theme="dark"] .ac-dp-day.selected { background: #3b82f6; color: #fff; }
        [data-theme="dark"] .ac-day-pick-btn { background: var(--bg-tertiary, #334155); border-color: var(--border-color, #475569); color: var(--text-primary); }

        /* Responsive */
        @media (max-width: 900px) {
            .ac-layout {
                grid-template-columns: 1fr;
            }

            .ac-detail-panel {
                position: static;
                max-height: none;
            }

            .ac-day-cell {
                min-height: 50px;
            }
        }

        .workout-progress-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .workout-subsection-title {
            font-size: 16px;
            font-weight: 600;
            color: #334155;
            margin-bottom: 12px;
        }

        .workout-ai-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .workout-ai-quick-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .workout-date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .workout-nav-btn {
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
        }

        .workout-nav-btn:hover {
            background: #f1f5f9;
            color: #334155;
            border-color: #cbd5e1;
        }

        .workout-date-label {
            font-weight: 600;
            font-size: 14px;
            color: #334155;
            min-width: 160px;
            text-align: center;
        }

        /* Weekly Summary Banner */
        .wp-weekly-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            border: 1px solid #bae6fd;
        }

        .wp-summary-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .wp-summary-value {
            font-size: 20px;
            font-weight: 700;
            color: #0369a1;
        }

        .wp-summary-label {
            font-size: 11px;
            font-weight: 500;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .wp-summary-value.good { color: #16a34a; }
        .wp-summary-value.warning { color: #d97706; }
        .wp-summary-value.danger { color: #dc2626; }

        /* Streak indicator */
        .wp-streak-dots {
            display: flex;
            gap: 3px;
            justify-content: center;
            margin-top: 2px;
        }

        .wp-streak-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e2e8f0;
        }

        .wp-streak-dot.active { background: #22c55e; }
        .wp-streak-dot.missed { background: #ef4444; }

        /* Fatigue alert */
        .wp-fatigue-alert {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 13px;
            font-weight: 500;
        }

        .wp-fatigue-alert.fresh {
            background: #dcfce7;
            border: 1px solid #86efac;
            color: #166534;
        }

        .wp-fatigue-alert.moderate {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            color: #92400e;
        }

        .wp-fatigue-alert.high {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
        }

        /* Missed workout alert */
        .wp-missed-workouts {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 16px;
        }

        .wp-missed-day {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            font-size: 13px;
            color: #991b1b;
        }

        /* RPE badge in card header */
        .wp-avg-rpe {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .wp-avg-rpe.low { background: #dcfce7; color: #166534; }
        .wp-avg-rpe.moderate { background: #fef3c7; color: #92400e; }
        .wp-avg-rpe.high { background: #fee2e2; color: #991b1b; }

        /* Exercise comparison */
        .wp-exercise-comparison {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .wp-compare-up { color: #16a34a; font-weight: 600; }
        .wp-compare-down { color: #dc2626; font-weight: 600; }
        .wp-compare-same { color: #64748b; }

        /* Adherence bar */
        .wp-adherence-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            width: 60px;
            margin-top: 4px;
        }

        .wp-adherence-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .wp-adherence-fill.good { background: #22c55e; }
        .wp-adherence-fill.ok { background: #eab308; }
        .wp-adherence-fill.low { background: #ef4444; }

        .workout-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
        }

        /* Workout Cards */
        .wp-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .wp-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .wp-card-date {
            font-weight: 700;
            font-size: 15px;
            color: #1e293b;
        }

        .wp-card-stats {
            display: flex;
            gap: 12px;
            font-size: 13px;
            color: #64748b;
        }

        .wp-has-notes {
            color: #7c3aed;
            font-weight: 600;
        }

        .wp-improvements {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .improvement-positive {
            background: #dcfce7;
            color: #166534;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .improvement-negative {
            background: #fef2f2;
            color: #991b1b;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .wp-exercises {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .wp-exercise {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
        }

        .wp-exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 6px;
        }

        .wp-exercise-name {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
        }

        .wp-exercise-badges {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .wp-max-weight {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }

        .wp-pr-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
        }

        .wp-sets {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 6px;
        }

        .wp-set-pill {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            padding: 3px 10px;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .wp-rpe {
            color: #6366f1;
            font-size: 11px;
            font-weight: 600;
        }

        .wp-client-note {
            background: #f5f3ff;
            border-left: 3px solid #7c3aed;
            padding: 8px 12px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            color: #4c1d95;
            margin-top: 6px;
            line-height: 1.5;
        }

        .wp-voice-note {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            font-size: 13px;
            color: #64748b;
        }

        #workoutAiQuestion {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }

        #workoutAiQuestion:focus {
            outline: none;
            border-color: #3b82f6;
        }

        /* Dark Mode - Workout Progress */
        [data-theme="dark"] .workout-progress-section {
            background: #1e293b;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        [data-theme="dark"] .workout-subsection-title {
            color: #e2e8f0;
        }

        [data-theme="dark"] .workout-ai-section {
            border-bottom-color: #334155;
        }

        [data-theme="dark"] .workout-nav-btn {
            background: transparent;
            border-color: #475569;
            color: #94a3b8;
        }

        [data-theme="dark"] .workout-nav-btn:hover {
            background: #334155;
            color: #e2e8f0;
            border-color: #64748b;
        }

        [data-theme="dark"] .workout-date-label {
            color: #e2e8f0;
        }

        [data-theme="dark"] .wp-weekly-summary {
            background: linear-gradient(135deg, #0c2d48 0%, #0f3460 100%);
            border-color: #1e40af;
        }

        [data-theme="dark"] .wp-summary-value { color: #38bdf8; }
        [data-theme="dark"] .wp-summary-label { color: #94a3b8; }
        [data-theme="dark"] .wp-summary-value.good { color: #4ade80; }
        [data-theme="dark"] .wp-summary-value.warning { color: #fbbf24; }
        [data-theme="dark"] .wp-summary-value.danger { color: #f87171; }
        [data-theme="dark"] .wp-streak-dot { background: #334155; }

        [data-theme="dark"] .wp-fatigue-alert.fresh { background: #14532d; border-color: #166534; color: #86efac; }
        [data-theme="dark"] .wp-fatigue-alert.moderate { background: #451a03; border-color: #92400e; color: #fcd34d; }
        [data-theme="dark"] .wp-fatigue-alert.high { background: #450a0a; border-color: #991b1b; color: #fca5a5; }

        [data-theme="dark"] .wp-missed-day { background: #450a0a; border-color: #7f1d1d; color: #fca5a5; }
        [data-theme="dark"] .wp-avg-rpe.low { background: #14532d; color: #86efac; }
        [data-theme="dark"] .wp-avg-rpe.moderate { background: #451a03; color: #fcd34d; }
        [data-theme="dark"] .wp-avg-rpe.high { background: #450a0a; color: #fca5a5; }
        [data-theme="dark"] .wp-exercise-comparison { color: #94a3b8; }
        [data-theme="dark"] .wp-adherence-bar { background: #334155; }

        [data-theme="dark"] .wp-card {
            background: #0f172a;
            border-color: #334155;
        }

        [data-theme="dark"] .wp-card-date {
            color: #f1f5f9;
        }

        [data-theme="dark"] .wp-card-stats {
            color: #94a3b8;
        }

        [data-theme="dark"] .wp-exercise {
            background: #1e293b;
            border-color: #334155;
        }

        [data-theme="dark"] .wp-exercise-name {
            color: #f1f5f9;
        }

        [data-theme="dark"] .wp-max-weight {
            color: #94a3b8;
        }

        [data-theme="dark"] .wp-set-pill {
            background: #1e3a5f;
            border-color: #3b82f6;
            color: #93c5fd;
        }

        [data-theme="dark"] .wp-client-note {
            background: #2e1065;
            border-left-color: #a78bfa;
            color: #c4b5fd;
        }

        [data-theme="dark"] .improvement-positive {
            background: #14532d;
            color: #86efac;
        }

        [data-theme="dark"] .improvement-negative {
            background: #450a0a;
            color: #fca5a5;
        }

        [data-theme="dark"] #workoutAiQuestion {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }

        @media (max-width: 600px) {
            .workout-progress-section {
                padding: 16px;
            }
            .wp-card-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .wp-exercise-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* ========== Workout Calendar Section ========== */
        .workout-calendar-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .wc-month-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .wc-month-label {
            font-weight: 700;
            font-size: 16px;
            color: #1e293b;
            min-width: 160px;
            text-align: center;
        }

        .wc-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .wc-day-header {
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            padding: 6px 0;
        }

        .wc-day {
            position: relative;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
            min-height: 48px;
            gap: 2px;
        }

        .wc-day:hover { background: #f1f5f9; }
        .wc-day.empty { cursor: default; }
        .wc-day.empty:hover { background: transparent; }
        .wc-day.today { border-color: #3b82f6; background: #eff6ff; }
        .wc-day.selected { background: #3b82f6; color: white; }
        .wc-day.selected:hover { background: #2563eb; }

        .wc-day-num {
            font-size: 13px;
            font-weight: 500;
            color: #334155;
        }

        .wc-day.other-month .wc-day-num { color: #cbd5e1; }
        .wc-day.selected .wc-day-num { color: white; }

        .wc-day-indicators {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .wc-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .wc-indicator.completed { background: #22c55e; }
        .wc-indicator.scheduled { background: #3b82f6; }
        .wc-indicator.missed { background: #ef4444; }
        .wc-indicator.in-progress { background: #f59e0b; }

        .wc-day-detail {
            margin-top: 16px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .wc-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .wc-detail-date {
            font-weight: 700;
            font-size: 15px;
            color: #1e293b;
        }

        .wc-detail-status {
            font-size: 12px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 20px;
        }

        .wc-detail-status.completed { background: #dcfce7; color: #166534; }
        .wc-detail-status.scheduled { background: #dbeafe; color: #1e40af; }
        .wc-detail-status.missed { background: #fee2e2; color: #991b1b; }
        .wc-detail-status.rest { background: #f1f5f9; color: #64748b; }

        .wc-detail-exercises {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .wc-detail-exercise {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 13px;
        }

        .wc-detail-ex-name {
            font-weight: 600;
            color: #334155;
        }

        .wc-detail-ex-info {
            color: #64748b;
            font-size: 12px;
        }

        .wc-detail-empty {
            text-align: center;
            color: #94a3b8;
            font-size: 13px;
            padding: 20px;
        }

        .wc-legend {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .wc-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #64748b;
        }

        /* ========== Workout Programs Section ========== */
        .workout-programs-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .wpr-header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .wpr-btn {
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.15s;
            background: white;
            color: #475569;
        }

        .wpr-btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .wpr-btn.primary { background: #3b82f6; color: white; border-color: #3b82f6; }
        .wpr-btn.primary:hover { background: #2563eb; }
        .wpr-btn.danger { color: #dc2626; border-color: #fecaca; }
        .wpr-btn.danger:hover { background: #fef2f2; }

        .wpr-active-assignment {
            padding: 16px;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #6ee7b7;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .wpr-active-badge {
            display: inline-block;
            background: #059669;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .wpr-active-name {
            font-size: 16px;
            font-weight: 700;
            color: #065f46;
            margin-bottom: 4px;
        }

        .wpr-active-meta {
            font-size: 13px;
            color: #047857;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .wpr-active-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .wpr-active-days {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .wpr-day-chip {
            padding: 6px 12px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.15s;
        }

        .wpr-day-chip:hover { background: #f3f4f6; }
        .wpr-day-chip.expanded { background: #3b82f6; color: white; border-color: #3b82f6; }

        .wpr-day-exercises {
            margin-top: 8px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .wpr-day-exercises.show { display: block; }

        .wpr-exercise-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
        }

        .wpr-exercise-row:last-child { border-bottom: none; }

        .wpr-ex-name { font-weight: 500; color: #334155; flex: 1; }
        .wpr-ex-detail { color: #64748b; font-size: 12px; }
        .wpr-ex-actions { display: flex; gap: 4px; margin-left: 8px; }

        .wpr-ex-btn {
            padding: 2px 6px;
            font-size: 11px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #94a3b8;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .wpr-ex-btn:hover { background: #f1f5f9; color: #475569; }
        .wpr-ex-btn.delete:hover { background: #fef2f2; color: #dc2626; }

        .wpr-programs-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .wpr-program-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            transition: all 0.15s;
        }

        .wpr-program-card:hover { border-color: #cbd5e1; }

        .wpr-program-info {
            flex: 1;
        }

        .wpr-program-name {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .wpr-program-meta {
            font-size: 12px;
            color: #64748b;
        }

        .wpr-program-actions {
            display: flex;
            gap: 6px;
        }

        .wpr-no-programs {
            text-align: center;
            color: #94a3b8;
            font-size: 14px;
            padding: 30px;
        }

        /* Edit Exercise Modal */
        .wpr-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .wpr-modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .wpr-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
        }

        .wpr-form-group {
            margin-bottom: 14px;
        }

        .wpr-form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .wpr-form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            color: #1e293b;
            box-sizing: border-box;
        }

        .wpr-form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.15);
        }

        .wpr-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .wpr-modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Exercise Search in Modal */
        .wpr-exercise-search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 8px;
        }

        .wpr-search-result {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.1s;
        }

        .wpr-search-result:hover { background: #f1f5f9; }
        .wpr-search-result:last-child { border-bottom: none; }

        .wpr-search-result-name { font-weight: 600; color: #1e293b; }
        .wpr-search-result-meta { font-size: 11px; color: #94a3b8; }

        /* Assign Program Modal */
        .wpr-assign-programs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .wpr-assign-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .wpr-assign-card:hover { background: #f8fafc; border-color: #3b82f6; }

        .wpr-schedule-days {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .wpr-schedule-day {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.15s;
        }

        .wpr-schedule-day.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Dark Mode - Calendar */
        [data-theme="dark"] .workout-calendar-section {
            background: #1e293b;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        [data-theme="dark"] .wc-month-label { color: #e2e8f0; }
        [data-theme="dark"] .wc-day-header { color: #64748b; }
        [data-theme="dark"] .wc-day-num { color: #cbd5e1; }
        [data-theme="dark"] .wc-day:hover { background: #334155; }
        [data-theme="dark"] .wc-day.today { border-color: #3b82f6; background: #1e3a5f; }
        [data-theme="dark"] .wc-day.selected { background: #3b82f6; }
        [data-theme="dark"] .wc-day.other-month .wc-day-num { color: #475569; }
        [data-theme="dark"] .wc-day-detail { background: #0f172a; border-color: #334155; }
        [data-theme="dark"] .wc-detail-date { color: #e2e8f0; }
        [data-theme="dark"] .wc-detail-exercise { background: #1e293b; border-color: #334155; }
        [data-theme="dark"] .wc-detail-ex-name { color: #e2e8f0; }
        [data-theme="dark"] .wc-detail-ex-info { color: #94a3b8; }
        [data-theme="dark"] .wc-legend-item { color: #94a3b8; }

        /* Dark Mode - Programs */
        [data-theme="dark"] .workout-programs-section {
            background: #1e293b;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        [data-theme="dark"] .wpr-btn {
            background: #334155;
            border-color: #475569;
            color: #cbd5e1;
        }
        [data-theme="dark"] .wpr-btn:hover { background: #475569; }
        [data-theme="dark"] .wpr-btn.primary { background: #3b82f6; color: white; border-color: #3b82f6; }
        [data-theme="dark"] .wpr-btn.danger { color: #f87171; border-color: #7f1d1d; }
        [data-theme="dark"] .wpr-btn.danger:hover { background: #450a0a; }

        [data-theme="dark"] .wpr-active-assignment {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            border-color: #059669;
        }
        [data-theme="dark"] .wpr-active-name { color: #a7f3d0; }
        [data-theme="dark"] .wpr-active-meta { color: #6ee7b7; }

        [data-theme="dark"] .wpr-day-chip { background: #334155; border-color: #475569; color: #cbd5e1; }
        [data-theme="dark"] .wpr-day-chip:hover { background: #475569; }
        [data-theme="dark"] .wpr-day-chip.expanded { background: #3b82f6; color: white; }
        [data-theme="dark"] .wpr-day-exercises { background: #0f172a; border-color: #334155; }
        [data-theme="dark"] .wpr-exercise-row { border-color: #1e293b; }
        [data-theme="dark"] .wpr-ex-name { color: #e2e8f0; }

        [data-theme="dark"] .wpr-program-card { background: #0f172a; border-color: #334155; }
        [data-theme="dark"] .wpr-program-name { color: #e2e8f0; }
        [data-theme="dark"] .wpr-program-meta { color: #94a3b8; }

        [data-theme="dark"] .wpr-modal { background: #1e293b; }
        [data-theme="dark"] .wpr-modal-title { color: #e2e8f0; }
        [data-theme="dark"] .wpr-form-label { color: #94a3b8; }
        [data-theme="dark"] .wpr-form-input { background: #334155; border-color: #475569; color: #e2e8f0; }
        [data-theme="dark"] .wpr-search-result:hover { background: #334155; }
        [data-theme="dark"] .wpr-search-result-name { color: #e2e8f0; }
        [data-theme="dark"] .wpr-assign-card { border-color: #334155; }
        [data-theme="dark"] .wpr-assign-card:hover { background: #334155; }
        [data-theme="dark"] .wpr-schedule-day { border-color: #475569; color: #94a3b8; }

        @media (max-width: 600px) {
            .wc-day { min-height: 36px; }
            .wc-day-num { font-size: 11px; }
            .wc-indicator { width: 4px; height: 4px; }
            .wpr-program-card { flex-direction: column; align-items: flex-start; gap: 10px; }
        }

        /* Progress Photos Section */
        .photos-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .photos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .photos-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .photo-carousel-wrapper {
            position: relative;
            padding: 0 25px;
        }

        .photo-carousel {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 10px 0;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }

        .photo-carousel::-webkit-scrollbar {
            height: 6px;
        }

        .photo-carousel::-webkit-scrollbar-track {
            background: transparent;
        }

        .photo-carousel::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .photo-card {
            position: relative;
            flex: 0 0 160px;
            height: 200px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .photo-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .photo-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 10px 10px;
            background: linear-gradient(transparent, rgba(0,0,0,0.75));
            color: white;
        }

        .photo-type {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .photo-date {
            font-size: 12px;
            font-weight: 500;
        }

        .photo-notes-text {
            font-size: 10px;
            opacity: 0.85;
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .photo-delete {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .photo-card:hover .photo-delete {
            opacity: 1;
        }

        .photo-delete:hover {
            background: #dc2626;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #4a5568;
            z-index: 10;
            transition: all 0.2s;
        }

        .carousel-nav:hover {
            background: #f7fafc;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }

        .carousel-nav.prev {
            left: -5px;
        }

        .carousel-nav.next {
            right: -5px;
        }

        /* Upload Modal */
        .photo-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .photo-modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .photo-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .photo-modal-header h2 {
            font-size: 20px;
            color: #333;
        }

        .photo-preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            background: #f5f5f5;
            margin-bottom: 15px;
            display: none;
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #0d9488;
            background: #f0fdfa;
        }

        .upload-area.dragging {
            border-color: #0d9488;
            background: #ccfbf1;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #64748b;
            font-size: 14px;
        }

        /* Lightbox for viewing full image */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }

        .empty-photos {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Measurements Section */
        .measurements-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .measurements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .measurements-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .charts-section {
            background: var(--gray-50);
            border-radius: 14px;
            padding: 20px;
            border: 1px solid var(--gray-100);
            margin-bottom: 20px;
        }

        .chart-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        .chart-tab {
            padding: 8px 16px;
            border: 1px solid var(--gray-200);
            background: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .chart-tab:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        .chart-tab.active {
            background: var(--brand-gradient);
            color: white;
            border-color: transparent;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--gray-100);
        }

        .chart-container h4 {
            margin: 0 0 12px 0;
            color: var(--gray-700);
            font-size: 14px;
            font-weight: 600;
        }

        .chart-canvas {
            width: 100%;
            height: 200px;
        }

        .weight-chart-container {
            height: 250px;
            margin-bottom: 20px;
            position: relative;
        }

        .measurements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .measurement-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .measurement-value {
            font-size: 24px;
            font-weight: 700;
            color: #0d9488;
        }

        .measurement-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .measurement-change {
            font-size: 11px;
            margin-top: 4px;
            font-weight: 600;
        }

        .measurement-change.positive {
            color: #dc2626;
        }

        .measurement-change.negative {
            color: #16a34a;
        }

        .measurements-history {
            margin-top: 20px;
        }

        .history-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .history-date {
            font-weight: 600;
            color: #333;
        }

        .history-title {
            color: #333;
            margin: 0;
        }

        .history-values {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #666;
        }

        .history-value {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Check-ins Section */
        .checkins-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .checkins-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .checkins-header:hover {
            background: rgba(0,0,0,0.03);
        }

        [data-theme="dark"] .checkins-header:hover {
            background: rgba(255,255,255,0.05);
        }

        .section-toggle-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .section-toggle-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        [data-theme="dark"] .section-toggle-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .toggle-icon {
            font-size: 14px;
            color: #64748b;
            transition: transform 0.3s ease;
        }

        [data-theme="dark"] .toggle-icon {
            color: #94a3b8;
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 2000px;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .checkins-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .checkin-card {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #0d9488;
        }

        .checkin-card.needs-response {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .checkin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .checkin-date {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }

        .checkin-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .checkin-badge.adherence {
            background: #d1fae5;
            color: #065f46;
        }

        .checkin-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .checkin-ratings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }

        .checkin-rating-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .checkin-rating-value {
            font-size: 18px;
            font-weight: 700;
            color: #0d9488;
        }

        .checkin-rating-label {
            font-size: 11px;
            color: #718096;
            text-transform: uppercase;
        }

        .checkin-feedback {
            margin-top: 12px;
        }

        .checkin-feedback-item {
            margin-bottom: 10px;
        }

        .checkin-feedback-label {
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 4px;
        }

        .checkin-feedback-text {
            font-size: 14px;
            color: #2d3748;
            background: white;
            padding: 10px;
            border-radius: 6px;
        }

        .coach-response-form {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .coach-response-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            min-height: 80px;
            margin-bottom: 10px;
            font-size: 14px;
            resize: vertical;
        }

        .coach-existing-response {
            background: #e0f2fe;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .coach-existing-response-label {
            font-size: 12px;
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 4px;
        }

        .coach-existing-response-text {
            font-size: 14px;
            color: #334155;
        }

        /* Favorites Section */
        .favorites-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .favorites-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .favorites-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .favorites-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .favorites-stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .favorites-stat-icon {
            font-size: 20px;
        }

        .favorites-stat-text {
            font-size: 14px;
            color: #4a5568;
        }

        .favorites-stat-text strong {
            color: #2d3748;
        }

        .favorites-filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .favorites-filter-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .favorites-filter-btn:hover {
            border-color: #0d9488;
            color: #0d9488;
        }

        .favorites-filter-btn.active {
            background: #0d9488;
            border-color: #0d9488;
            color: white;
        }

        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .favorite-card {
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s;
        }

        .favorite-card:hover {
            border-color: #e53e3e;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.15);
        }

        .favorite-meal-type-badge {
            display: inline-block;
            background: linear-gradient(135deg, #0d9488 0%, #0284c7 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .favorite-meal-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 15px;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .favorite-macros-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            background: #f7fafc;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .favorite-macro-item {
            text-align: center;
        }

        .favorite-macro-label {
            font-size: 9px;
            color: #718096;
            text-transform: uppercase;
            font-weight: 600;
        }

        .favorite-macro-value {
            font-size: 13px;
            font-weight: 700;
            color: #2d3748;
        }

        .favorite-macro-value.calories { color: #dd6b20; }
        .favorite-macro-value.protein { color: #38a169; }
        .favorite-macro-value.carbs { color: #3182ce; }
        .favorite-macro-value.fat { color: #805ad5; }

        .favorite-date {
            font-size: 11px;
            color: #a0aec0;
        }

        .empty-favorites {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-favorites-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* Measurement Modal */
        .measurement-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .measurement-modal-content {
            background-color: white;
            margin: 30px auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .measurement-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .client-header {
                flex-direction: column;
                gap: 20px;
            }

            .plans-grid {
                grid-template-columns: 1fr;
            }

            .client-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        /* Footer */
        .site-footer {
            background: var(--gray-900);
            color: white;
            padding: 32px 24px;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer-logo {
            width: 32px;
            height: 32px;
            background: var(--brand-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.9rem;
        }

        .footer-text {
            font-size: 0.875rem;
            color: var(--gray-400);
        }

        @media (max-width: 768px) {
            .top-nav {
                padding: 12px 16px;
            }

            .nav-title {
                display: none;
            }

            .main-content {
                padding: 20px 16px;
            }

            .client-header {
                flex-direction: column;
                gap: 20px;
            }

            .footer-content {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .site-footer {
                display: none;
            }
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] .bottom-nav {
            background: #1e293b;
            border-color: #334155;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: #64748b;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.2s ease;
            min-width: 64px;
            -webkit-tap-highlight-color: transparent;
        }

        .bottom-nav-item:active {
            transform: scale(0.95);
        }

        .bottom-nav-item.active {
            color: #0d9488;
        }

        .bottom-nav-item.active .nav-icon {
            background: rgba(13, 148, 136, 0.1);
        }

        [data-theme="dark"] .bottom-nav-item {
            color: #94a3b8;
        }

        [data-theme="dark"] .bottom-nav-item.active {
            color: #14b8a6;
        }

        .nav-icon {
            width: 48px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
        }

        .main-content {
            padding-bottom: 100px;
        }

        /* ===== DARK MODE STYLES ===== */
        [data-theme="dark"] .main-content {
            background: #0f172a;
        }

        [data-theme="dark"] .main-container {
            background: #0f172a;
        }

        [data-theme="dark"] .section-card,
        [data-theme="dark"] .card,
        [data-theme="dark"] .client-header,
        [data-theme="dark"] .reminders-card,
        [data-theme="dark"] .plans-section,
        [data-theme="dark"] .checkins-section,
        [data-theme="dark"] .favorites-section,
        [data-theme="dark"] .protocols-section,
        [data-theme="dark"] .measurements-section,
        [data-theme="dark"] .photos-section,
        [data-theme="dark"] .diary-section,
        [data-theme="dark"] .ai-assistant-section {
            background: #1e293b !important;
            border-color: #334155 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
        }

        [data-theme="dark"] .stats-card {
            background: #334155 !important;
        }

        [data-theme="dark"] .stats-value {
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] .stats-label {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .reminder-status {
            background: #334155 !important;
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .checkin-card {
            background: #334155 !important;
            border-color: #475569 !important;
        }

        [data-theme="dark"] .checkin-feedback-item {
            background: #1e293b !important;
        }

        [data-theme="dark"] .checkin-feedback-label {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .checkin-feedback-text {
            color: #1e293b !important;
            background: #e2e8f0 !important;
        }

        [data-theme="dark"] .checkin-rating-item {
            background: #1e293b !important;
            border: 1px solid #475569 !important;
        }

        [data-theme="dark"] .checkin-rating-value {
            color: #5eead4 !important;
        }

        [data-theme="dark"] .checkin-rating-label {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .coach-response-form textarea {
            background: #1e293b !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .coach-existing-response {
            background: #334155 !important;
            border-color: #475569 !important;
        }

        [data-theme="dark"] .favorite-card {
            background: #334155 !important;
            border-color: #475569 !important;
        }

        [data-theme="dark"] .favorite-name {
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] .favorite-meal-name {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .favorite-macros {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .favorites-stats {
            background: #334155 !important;
        }

        [data-theme="dark"] .favorites-stat-text {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .favorites-stat-text strong {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .favorites-filter-btn {
            background: #1e293b !important;
            border-color: #475569 !important;
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .favorites-filter-btn:hover,
        [data-theme="dark"] .favorites-filter-btn.active {
            background: #0d9488 !important;
            border-color: #0d9488 !important;
            color: white !important;
        }

        [data-theme="dark"] .measurement-card {
            background: #334155 !important;
            border-color: #475569 !important;
        }

        [data-theme="dark"] .measurement-value {
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] .measurement-label {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .client-card {
            background: #1e293b !important;
            border-color: #334155 !important;
        }

        [data-theme="dark"] .client-stats {
            background: #334155 !important;
            border-color: #475569 !important;
        }

        [data-theme="dark"] .stat-item {
            background: #1e293b !important;
        }

        [data-theme="dark"] .stat-value {
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] .stat-label {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .reminder-status-section {
            background: #334155 !important;
            border-color: #475569 !important;
        }

        [data-theme="dark"] .reminder-status-info span {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .reminder-status-badge.no-prefs {
            background: #475569 !important;
            color: #e2e8f0 !important;
            border-color: #64748b !important;
        }

        [data-theme="dark"] .reminder-status-badge.enabled {
            background: #166534 !important;
            color: #dcfce7 !important;
            border-color: #22c55e !important;
        }

        [data-theme="dark"] .reminder-status-badge.disabled {
            background: #7f1d1d !important;
            color: #fecaca !important;
            border-color: #ef4444 !important;
        }

        [data-theme="dark"] .charts-section {
            background: #334155 !important;
            border-color: #475569 !important;
        }

        [data-theme="dark"] .chart-container {
            background: #1e293b !important;
            border-color: #475569 !important;
        }

        [data-theme="dark"] .chart-container h4 {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .chart-tab {
            background: #1e293b !important;
            border-color: #475569 !important;
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .chart-tab:hover {
            background: #334155 !important;
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .chart-tab.active {
            background: #0d9488 !important;
            border-color: #0d9488 !important;
            color: white !important;
        }

        [data-theme="dark"] .measurements-grid {
            background: transparent !important;
        }

        [data-theme="dark"] .measurements-history {
            background: transparent !important;
        }

        [data-theme="dark"] .measurements-history h4 {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .history-entry {
            background: #334155 !important;
        }

        [data-theme="dark"] .history-date {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .history-value {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .history-title {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .diary-summary {
            background: linear-gradient(135deg, #1e3a2f 0%, #14532d 100%);
        }

        [data-theme="dark"] .diary-summary-value {
            color: #f0fdf4 !important;
        }

        [data-theme="dark"] .diary-summary-label {
            color: #86efac !important;
        }

        [data-theme="dark"] .diary-food-item {
            background: #334155;
        }

        [data-theme="dark"] .diary-food-name {
            color: #e2e8f0;
        }

        [data-theme="dark"] .diary-meal-title {
            color: #94a3b8;
            border-color: #475569;
        }

        [data-theme="dark"] .diary-nav-btn {
            background: #334155;
            color: #94a3b8;
        }

        [data-theme="dark"] .diary-nav-btn:hover {
            background: #475569;
            color: #e2e8f0;
        }

        [data-theme="dark"] #diaryDatePicker {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }

        [data-theme="dark"] .ai-assistant-section {
            background: #1e293b;
        }

        [data-theme="dark"] .ai-assistant-title {
            color: #e2e8f0;
        }

        [data-theme="dark"] .ai-assistant-description {
            color: #94a3b8;
        }

        [data-theme="dark"] .ai-quick-btn {
            background: linear-gradient(135deg, #1e3a5f 0%, #1e3a8a 100%);
            border-color: #3b82f6;
            color: #93c5fd;
        }

        [data-theme="dark"] .ai-quick-btn:hover {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        }

        [data-theme="dark"] #aiCoachQuestion {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }

        [data-theme="dark"] .ai-response-container {
            background: linear-gradient(135deg, #1e3a2f 0%, #14532d 100%);
            border-color: #166534;
        }

        [data-theme="dark"] .ai-response-text {
            color: #bbf7d0;
        }

        [data-theme="dark"] .section-title,
        [data-theme="dark"] .section-header h3,
        [data-theme="dark"] h2, [data-theme="dark"] h3 {
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] .client-name {
            color: #f1f5f9;
        }

        [data-theme="dark"] .client-email,
        [data-theme="dark"] .client-meta {
            color: #94a3b8;
        }

        [data-theme="dark"] .plan-card {
            background: #334155 !important;
            border-color: #475569 !important;
        }

        [data-theme="dark"] .plan-card:hover {
            border-color: #0d9488 !important;
        }

        [data-theme="dark"] .plan-title,
        [data-theme="dark"] .plan-card-title {
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] .plan-meta,
        [data-theme="dark"] .plan-details,
        [data-theme="dark"] .plan-card-meta {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .checkin-card,
        [data-theme="dark"] .favorite-card,
        [data-theme="dark"] .protocol-card,
        [data-theme="dark"] .measurement-card,
        [data-theme="dark"] .photo-card {
            background: #334155 !important;
            border-color: #475569 !important;
        }

        [data-theme="dark"] .checkin-date,
        [data-theme="dark"] .checkin-title {
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] .checkin-notes,
        [data-theme="dark"] .checkin-meta {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .empty-state {
            color: #64748b;
        }

        [data-theme="dark"] .info-label {
            color: #94a3b8;
        }

        [data-theme="dark"] .info-value {
            color: #f1f5f9;
        }

        [data-theme="dark"] .modal-content {
            background: #1e293b;
            border-color: #334155;
        }

        [data-theme="dark"] .modal-header {
            border-color: #334155;
            color: #f1f5f9;
        }

        [data-theme="dark"] .modal-body {
            color: #cbd5e1;
        }

        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background: #0f172a !important;
            border-color: #475569 !important;
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: #64748b !important;
        }

        [data-theme="dark"] .btn-secondary {
            background: #334155;
            color: #f1f5f9;
            border-color: #475569;
        }

        [data-theme="dark"] .selection-bar {
            background: #1e293b;
            border-color: #334155;
        }

        [data-theme="dark"] .selection-bar span {
            color: #94a3b8;
        }

        [data-theme="dark"] label {
            color: #cbd5e1;
        }

        /* Goals Section Styles */
        .goals-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-100);
            margin-bottom: 24px;
        }

        .goals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .goals-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .goals-mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-600);
        }

        .goals-mode-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--brand-primary);
        }

        /* Calories Input */
        .calories-input-section {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .calories-input-section label {
            display: block;
            color: #94a3b8;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .calories-input-section input {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 24px;
            font-weight: 700;
            background: rgba(0,0,0,0.3);
            color: white;
        }

        .calories-input-section input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.3);
        }

        /* Macro Cards Grid */
        .macro-cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .macro-card {
            border-radius: 12px;
            padding: 16px;
            border: 2px solid;
        }

        .macro-card.protein {
            background: #f0fff4;
            border-color: #9ae6b4;
        }

        .macro-card.carbs {
            background: #ebf8ff;
            border-color: #90cdf4;
        }

        .macro-card.fat {
            background: #fffaf0;
            border-color: #fbd38d;
        }

        .macro-card-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .macro-card.protein .macro-card-label { color: #276749; }
        .macro-card.carbs .macro-card-label { color: #2b6cb0; }
        .macro-card.fat .macro-card-label { color: #c05621; }

        .macro-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .macro-input-row input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            background: rgba(0,0,0,0.1);
        }

        .macro-card.protein .macro-input-row input {
            background: #1e293b;
            color: white;
        }
        .macro-card.carbs .macro-input-row input {
            background: #1e293b;
            color: white;
        }
        .macro-card.fat .macro-input-row input {
            background: #1e293b;
            color: white;
        }

        .macro-input-row input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.3);
        }

        .macro-input-row .unit {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
        }

        .macro-calculated {
            text-align: center;
        }

        .macro-grams {
            font-size: 20px;
            font-weight: 700;
        }

        .macro-card.protein .macro-grams { color: #276749; }
        .macro-card.carbs .macro-grams { color: #2b6cb0; }
        .macro-card.fat .macro-grams { color: #c05621; }

        .macro-cals {
            font-size: 12px;
            color: var(--gray-500);
        }

        /* Percentage Total Bar */
        .percentage-total-bar {
            background: var(--gray-100);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .percentage-total-text {
            font-size: 14px;
            color: var(--gray-600);
        }

        .percentage-total-text.valid { color: #38a169; }
        .percentage-total-text.invalid { color: #e53e3e; }

        .percentage-progress {
            flex: 1;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            margin: 0 16px;
            overflow: hidden;
        }

        .percentage-progress-fill {
            height: 100%;
            background: var(--brand-primary);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .percentage-progress-fill.valid { background: #38a169; }
        .percentage-progress-fill.over { background: #e53e3e; }

        /* Custom/Manual Mode */
        .custom-mode-section {
            display: none;
        }

        .custom-mode-section.active {
            display: block;
        }

        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .goal-item {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--gray-100);
        }

        .goal-item label {
            display: block;
            font-size: 12px;
            color: var(--gray-500);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .goal-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            color: var(--gray-900);
            background: white;
        }

        .goal-item input:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .goal-item.calories input { color: #dd6b20; }
        .goal-item.protein input { color: #38a169; }
        .goal-item.carbs input { color: #3182ce; }
        .goal-item.fat input { color: #805ad5; }

        .goals-tip {
            font-size: 13px;
            color: var(--gray-500);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Goals Mode Tabs */
        .goals-mode-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--gray-100);
            padding: 4px;
            border-radius: 10px;
        }

        .goals-mode-tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .goals-mode-tab:hover {
            color: var(--gray-900);
        }

        .goals-mode-tab.active {
            background: white;
            color: var(--brand-primary);
            box-shadow: var(--shadow-sm);
        }

        /* Calculate Mode */
        .calculate-mode-section {
            display: none;
        }

        .calculate-mode-section.active {
            display: block;
        }

        .client-stats-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfeff 100%);
            border: 2px solid #a7f3d0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .client-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .client-stats-title {
            font-size: 14px;
            font-weight: 700;
            color: #065f46;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .client-stats-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .coach-unit-toggle {
            display: flex;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .coach-unit-toggle .unit-btn {
            padding: 4px 10px;
            border: none;
            background: white;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .coach-unit-toggle .unit-btn:hover {
            background: #f1f5f9;
        }

        .coach-unit-toggle .unit-btn.active {
            background: #0d9488;
            color: white;
        }

        [data-theme="dark"] .coach-unit-toggle {
            border-color: #475569;
        }

        [data-theme="dark"] .coach-unit-toggle .unit-btn {
            background: #1e293b;
            color: #94a3b8;
        }

        [data-theme="dark"] .coach-unit-toggle .unit-btn:hover {
            background: #334155;
        }

        [data-theme="dark"] .coach-unit-toggle .unit-btn.active {
            background: #0d9488;
            color: white;
        }

        .client-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        .client-stat-item {
            text-align: center;
            padding: 12px 8px;
            background: white;
            border-radius: 8px;
        }

        .client-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .client-stat-label {
            font-size: 11px;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .client-stat-missing {
            color: #dc2626;
            font-size: 12px;
        }

        .calculate-result-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .calculate-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calculate-result-title {
            font-size: 14px;
            font-weight: 600;
            color: #94a3b8;
        }

        .calculate-btn {
            padding: 8px 16px;
            background: var(--brand-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .calculate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }

        .calculate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .calculated-values-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .calculated-value-item {
            text-align: center;
            padding: 16px 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .calculated-value-number {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .calculated-value-number.calories { color: #fbbf24; }
        .calculated-value-number.protein { color: #34d399; }
        .calculated-value-number.carbs { color: #60a5fa; }
        .calculated-value-number.fat { color: #f472b6; }

        .calculated-value-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .calculate-formula-info {
            margin-top: 16px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            font-size: 12px;
            color: #94a3b8;
        }

        .calculate-formula-info strong {
            color: #cbd5e1;
        }

        .apply-calculated-btn {
            width: 100%;
            padding: 14px;
            background: var(--brand-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .apply-calculated-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }

        .apply-calculated-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .goals-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid var(--gray-100);
        }

        .permission-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .permission-toggle label {
            font-size: 14px;
            color: var(--gray-700);
            cursor: pointer;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--brand-primary);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .goals-save-btn {
            padding: 10px 24px;
            background: var(--brand-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .goals-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }

        .goals-save-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        [data-theme="dark"] .goals-section {
            background: #1e293b;
            border-color: #334155;
        }

        [data-theme="dark"] .goals-title {
            color: #f1f5f9;
        }

        [data-theme="dark"] .goal-item {
            background: #0f172a;
            border-color: #334155;
        }

        [data-theme="dark"] .goal-item input {
            background: #1e293b;
            border-color: #475569;
            color: #f1f5f9;
        }

        [data-theme="dark"] .goals-footer {
            border-color: #334155;
        }

        [data-theme="dark"] .permission-toggle label {
            color: #cbd5e1;
        }

        [data-theme="dark"] .goals-mode-toggle {
            color: #94a3b8;
        }

        [data-theme="dark"] .macro-card.protein {
            background: #064e3b;
            border-color: #065f46;
        }

        [data-theme="dark"] .macro-card.carbs {
            background: #1e3a5f;
            border-color: #1e40af;
        }

        [data-theme="dark"] .macro-card.fat {
            background: #78350f;
            border-color: #92400e;
        }

        [data-theme="dark"] .macro-card-label {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .macro-grams {
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] .macro-cals {
            color: #94a3b8;
        }

        [data-theme="dark"] .percentage-total-bar {
            background: #1e293b;
        }

        [data-theme="dark"] .percentage-progress {
            background: #334155;
        }

        [data-theme="dark"] .goals-tip {
            color: #94a3b8;
        }

        [data-theme="dark"] .goals-mode-tabs {
            background: #1e293b;
        }

        [data-theme="dark"] .goals-mode-tab {
            color: #94a3b8;
        }

        [data-theme="dark"] .goals-mode-tab:hover {
            color: #f1f5f9;
        }

        [data-theme="dark"] .goals-mode-tab.active {
            background: #334155;
            color: var(--brand-primary);
        }

        [data-theme="dark"] .client-stats-card {
            background: linear-gradient(135deg, #064e3b 0%, #1e3a5f 100%);
            border-color: #065f46;
        }

        [data-theme="dark"] .client-stats-title {
            color: #a7f3d0;
        }

        [data-theme="dark"] .client-stat-item {
            background: rgba(0,0,0,0.3);
        }

        [data-theme="dark"] .client-stat-value {
            color: #f1f5f9;
        }

        [data-theme="dark"] .client-stat-label {
            color: #94a3b8;
        }

        /* ===== COMPREHENSIVE MOBILE STYLES ===== */
        @media (max-width: 768px) {
            /* Page Container */
            .page-container {
                padding: 16px;
            }

            /* Client Card */
            .client-card {
                padding: 20px;
                margin-bottom: 16px;
            }

            .client-header {
                flex-direction: column;
                gap: 16px;
                margin-bottom: 20px;
            }

            .client-header-info {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 12px;
                width: 100%;
            }

            .client-profile-avatar {
                width: 80px;
                height: 80px;
                min-width: 80px;
                font-size: 32px;
            }

            .client-name {
                font-size: 1.5rem;
                margin-bottom: 8px;
                word-break: break-word;
            }

            .client-meta {
                align-items: center;
                font-size: 13px;
            }

            .client-meta-item {
                justify-content: center;
            }

            /* Action Buttons - Stack Vertically */
            .client-actions {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }

            .client-actions .btn {
                width: 100%;
                justify-content: center;
                padding: 14px 20px;
                font-size: 14px;
            }

            /* Client Stats Grid */
            .client-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                padding: 16px;
            }

            .stat-value {
                font-size: 1.4rem;
            }

            .stat-label {
                font-size: 10px;
            }

            /* Reminder Status Section */
            .reminder-status-section {
                flex-direction: column;
                gap: 12px;
                padding: 16px;
                text-align: center;
            }

            .reminder-status-info {
                flex-direction: column;
                gap: 8px;
            }

            .reminder-toggle-btn {
                width: 100%;
            }

            /* Goals Section */
            .goals-section {
                padding: 20px;
                margin-top: 16px;
            }

            .goals-header {
                margin-bottom: 16px;
            }

            .goals-title {
                font-size: 18px;
            }

            /* Goals Mode Tabs */
            .goals-mode-tabs {
                flex-direction: column;
                gap: 4px;
            }

            .goals-mode-tab {
                padding: 12px;
                font-size: 13px;
            }

            /* Client Stats Card in Calculate Mode */
            .client-stats-card {
                padding: 16px;
            }

            .client-stats-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .client-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .client-stat-item {
                padding: 10px 6px;
            }

            .client-stat-value {
                font-size: 16px;
            }

            .client-stat-label {
                font-size: 9px;
            }

            /* Calculate Result Card */
            .calculate-result-card {
                padding: 16px;
            }

            .calculate-result-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .calculate-result-title {
                text-align: center;
            }

            .calculate-btn {
                width: 100%;
                justify-content: center;
            }

            .calculated-values-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .calculated-value-item {
                padding: 12px 6px;
            }

            .calculated-value-number {
                font-size: 22px;
            }

            .calculated-value-label {
                font-size: 10px;
            }

            .calculate-formula-info {
                font-size: 11px;
                padding: 12px;
                margin-top: 12px;
            }

            .apply-calculated-btn {
                width: 100%;
                padding: 14px;
                font-size: 14px;
            }

            /* Macro Cards Grid */
            .macro-cards-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .macro-card {
                padding: 14px;
            }

            /* Goals Grid (Custom Mode) */
            .goals-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .goal-item {
                padding: 12px;
            }

            .goal-item label {
                font-size: 10px;
            }

            .goal-item input {
                font-size: 16px;
                padding: 8px;
            }

            /* Percentage Total Bar */
            .percentage-total-bar {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .percentage-progress {
                width: 100%;
                margin: 0;
            }

            /* Goals Footer */
            .goals-footer {
                flex-direction: column;
                gap: 16px;
            }

            .permission-toggle {
                justify-content: center;
            }

            .goals-save-btn {
                width: 100%;
            }

            /* AI Assistant Section */
            .ai-assistant-section {
                padding: 20px;
                margin-top: 16px;
            }

            .ai-assistant-title {
                font-size: 18px;
            }

            .ai-assistant-description {
                font-size: 13px;
            }

            .ai-quick-questions {
                justify-content: center;
            }

            .ai-quick-btn {
                font-size: 12px;
                padding: 8px 12px;
            }

            .ai-input-container {
                flex-direction: column;
            }

            .ai-ask-btn {
                width: 100%;
            }

            /* Food Diary Section */
            .diary-section {
                padding: 20px;
                margin-top: 16px;
            }

            .diary-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .diary-title {
                font-size: 18px;
                text-align: center;
            }

            .diary-date-nav {
                justify-content: center;
            }

            .diary-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 12px;
            }

            .diary-summary-value {
                font-size: 20px;
            }

            .diary-summary-label {
                font-size: 10px;
            }

            .diary-food-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
                padding: 12px;
            }

            .diary-food-macros {
                width: 100%;
                justify-content: space-between;
                font-size: 12px;
            }

            /* Plans Section */
            .plans-section {
                padding: 20px;
                margin-top: 16px;
            }

            .section-title {
                font-size: 18px;
            }

            .plans-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .plan-card {
                padding: 16px;
                padding-left: 40px;
            }

            .plan-card-checkbox {
                top: 12px;
                left: 12px;
            }

            .bulk-actions {
                flex-direction: column;
                gap: 12px;
                padding: 12px;
            }

            .bulk-actions-left {
                flex-direction: column;
                gap: 8px;
            }

            .btn-delete-selected {
                width: 100%;
                justify-content: center;
            }

            /* Protocols Section */
            .protocols-section {
                padding: 20px;
                margin-top: 16px;
            }

            .protocol-card {
                padding: 16px;
            }

            .protocol-actions {
                flex-direction: column;
                gap: 8px;
            }

            .protocol-btn {
                width: 100%;
                justify-content: center;
            }

            /* Favorites Section */
            .favorites-section {
                padding: 20px;
                margin-top: 16px;
            }

            .favorites-header {
                flex-direction: column;
                gap: 12px;
            }

            .favorites-title {
                font-size: 18px;
            }

            .favorites-stats {
                flex-direction: column;
                gap: 8px;
            }

            .favorites-filter-bar {
                flex-wrap: wrap;
                justify-content: center;
            }

            .favorites-filter-btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            /* Photos Section */
            .photos-section {
                padding: 20px;
                margin-top: 16px;
            }

            .photos-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .photos-title {
                font-size: 18px;
                text-align: center;
            }

            .photos-header > div {
                justify-content: center;
            }

            .photo-carousel-wrapper {
                padding: 0 10px;
            }

            .photo-card {
                flex: 0 0 140px;
                height: 180px;
            }

            /* Measurements Section */
            .measurements-section {
                padding: 20px;
                margin-top: 16px;
            }

            .measurements-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .measurements-title {
                font-size: 18px;
                text-align: center;
            }

            .measurements-header > div {
                justify-content: center;
            }

            .measurement-card {
                padding: 12px;
            }

            .measurement-value {
                font-size: 18px;
            }

            .measurement-label {
                font-size: 10px;
            }

            /* Check-ins Section */
            .checkins-section {
                padding: 20px;
                margin-top: 16px;
            }

            .checkins-header {
                flex-direction: column;
                gap: 12px;
            }

            .checkins-title {
                font-size: 18px;
                text-align: center;
            }

            .checkin-card {
                padding: 16px;
            }

            .checkin-rating-item {
                padding: 10px;
            }

            .checkin-rating-value {
                font-size: 18px;
            }

            /* Collapsible Headers */
            .collapsible-header {
                flex-wrap: wrap;
                gap: 8px;
            }

            .section-header.collapsible-header {
                flex-direction: row;
                justify-content: space-between;
            }

            /* Modals */
            .photo-modal-content,
            .protocol-modal-content {
                margin: 20px auto;
                padding: 20px;
                width: 95%;
            }

            .upload-area {
                padding: 30px 20px;
            }

            /* General Spacing Adjustments */
            .section-header {
                margin-bottom: 16px;
            }

            /* Edit Client Modal */
            .edit-form {
                grid-template-columns: 1fr;
            }

            .form-group {
                margin-bottom: 12px;
            }

            .modal-content {
                margin: 10px;
                padding: 20px;
                max-height: 90vh;
            }

            .modal-footer {
                flex-direction: column;
                gap: 10px;
            }

            .modal-footer .btn {
                width: 100%;
            }
        }

        /* Extra small screens (iPhone SE, etc.) */
        @media (max-width: 375px) {
            .page-container {
                padding: 12px;
            }

            .client-card {
                padding: 16px;
            }

            .client-name {
                font-size: 1.25rem;
            }

            .client-stats {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                padding: 12px;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .goals-mode-tab {
                padding: 10px 8px;
                font-size: 12px;
            }

            .calculated-values-grid {
                gap: 8px;
            }

            .calculated-value-number {
                font-size: 18px;
            }

            .diary-summary {
                gap: 8px;
            }

            .diary-summary-value {
                font-size: 18px;
            }

            .ai-quick-btn {
                font-size: 11px;
                padding: 6px 10px;
            }
        }

        /* ===== SKELETON LOADING STYLES ===== */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton {
            background: linear-gradient(90deg,
                #e2e8f0 25%,
                #f1f5f9 50%,
                #e2e8f0 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg,
                #334155 25%,
                #475569 50%,
                #334155 75%
            );
            background-size: 200% 100%;
        }

        /* Skeleton for loading containers */
        .loading.skeleton-loading {
            padding: 0;
            text-align: left;
        }

        /* Skeleton Client Profile Card */
        .skeleton-profile-card {
            padding: 24px;
        }

        .skeleton-profile-header {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
        }

        .skeleton-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .skeleton-profile-info {
            flex: 1;
        }

        .skeleton-name {
            height: 28px;
            width: 180px;
            margin-bottom: 12px;
        }

        .skeleton-meta-item {
            height: 16px;
            width: 140px;
            margin-bottom: 8px;
        }

        .skeleton-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 16px;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 12px;
        }

        [data-theme="dark"] .skeleton-stats-grid {
            background: var(--gray-800);
        }

        .skeleton-stat {
            text-align: center;
        }

        .skeleton-stat-value {
            height: 32px;
            width: 60px;
            margin: 0 auto 8px;
        }

        .skeleton-stat-label {
            height: 12px;
            width: 80px;
            margin: 0 auto;
        }

        /* Skeleton Section */
        .skeleton-section {
            padding: 20px;
        }

        .skeleton-section-title {
            height: 24px;
            width: 150px;
            margin-bottom: 16px;
        }

        /* Skeleton Diary Items */
        .skeleton-diary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        [data-theme="dark"] .skeleton-diary-item {
            background: var(--gray-700);
        }

        .skeleton-food-name {
            height: 16px;
            width: 120px;
        }

        .skeleton-food-macros {
            display: flex;
            gap: 12px;
        }

        .skeleton-macro {
            height: 14px;
            width: 40px;
        }

        /* Skeleton Plan Card */
        .skeleton-plan-card {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
        }

        [data-theme="dark"] .skeleton-plan-card {
            background: var(--gray-700);
        }

        .skeleton-plan-title {
            height: 20px;
            width: 200px;
            margin-bottom: 12px;
        }

        .skeleton-plan-meta {
            height: 14px;
            width: 150px;
            margin-bottom: 8px;
        }

        /* Skeleton Photo Grid */
        .skeleton-photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .skeleton-photo {
            aspect-ratio: 1;
            border-radius: 8px;
        }

        /* Skeleton Checkin Card */
        .skeleton-checkin {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        [data-theme="dark"] .skeleton-checkin {
            background: var(--gray-700);
        }

        .skeleton-checkin-date {
            height: 16px;
            width: 100px;
            margin-bottom: 12px;
        }

        .skeleton-checkin-content {
            height: 40px;
            width: 100%;
        }

        /* Skeleton Measurements */
        .skeleton-measurements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .skeleton-measurement {
            background: var(--gray-50);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        [data-theme="dark"] .skeleton-measurement {
            background: var(--gray-700);
        }

        .skeleton-measurement-value {
            height: 24px;
            width: 50px;
            margin: 0 auto 8px;
        }

        .skeleton-measurement-label {
            height: 12px;
            width: 70px;
            margin: 0 auto;
        }

        @media (max-width: 480px) {
            .skeleton-profile-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .skeleton-profile-info {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .skeleton-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .skeleton-photo-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Client Notes & Voice Notes Section */
        .cn-section {
            margin-top: 12px;
        }
        .cn-empty {
            text-align: center;
            padding: 24px 16px;
            color: #94a3b8;
            font-size: 14px;
        }
        .cn-empty-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }
        .cn-note-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
        }
        .cn-note-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .cn-note-exercise {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
        }
        .cn-note-meta {
            font-size: 12px;
            color: #94a3b8;
        }
        .cn-note-workout {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 8px;
        }
        .cn-text-note {
            background: #f5f3ff;
            border-left: 3px solid #7c3aed;
            padding: 10px 12px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            color: #4c1d95;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        .cn-voice-note {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f7ff;
            border: 1px solid #e9e5f5;
            border-radius: 10px;
            padding: 10px 12px;
        }
        .cn-voice-label {
            font-size: 13px;
            font-weight: 600;
            color: #7c3aed;
            white-space: nowrap;
        }
        .cn-voice-note audio {
            height: 34px;
            width: 100%;
            max-width: 280px;
        }
        .cn-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 20px;
        }
        .cn-badge--voice {
            background: #ede9fe;
            color: #7c3aed;
        }
        .cn-badge--text {
            background: #f0f9ff;
            color: #0369a1;
        }
        [data-theme="dark"] .cn-note-card {
            background: #1e293b;
            border-color: #334155;
        }
        [data-theme="dark"] .cn-note-exercise {
            color: #f1f5f9;
        }
        [data-theme="dark"] .cn-note-workout {
            color: #94a3b8;
        }
        [data-theme="dark"] .cn-text-note {
            background: #1e1033;
            border-color: #7c3aed;
            color: #c4b5fd;
        }
        [data-theme="dark"] .cn-voice-note {
            background: #1e1033;
            border-color: #2d2050;
        }
        [data-theme="dark"] .cn-voice-label {
            color: #a78bfa;
        }
        [data-theme="dark"] .cn-badge--voice {
            background: #2d1b69;
            color: #a78bfa;
        }
        [data-theme="dark"] .cn-badge--text {
            background: #0c2d48;
            color: #7dd3fc;
        }

        /* ===== ACTION BAR ===== */
        .client-action-bar {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            margin-bottom: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .client-action-bar::-webkit-scrollbar { display: none; }
        .action-bar-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 14px;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            background: var(--gray-50);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 80px;
            font-size: 11px;
            font-weight: 500;
            color: var(--gray-600);
        }
        .action-bar-btn:hover {
            background: var(--brand-primary);
            color: #fff;
            border-color: var(--brand-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }
        .action-bar-btn:hover svg { stroke: #fff; }
        .action-bar-btn svg {
            width: 20px;
            height: 20px;
            stroke: var(--gray-500);
            transition: stroke 0.2s;
        }
        .action-bar-btn .action-bar-icon {
            font-size: 18px;
            line-height: 1;
        }

        /* ===== DRAWER SYSTEM ===== */
        /* Hide all drawer sections from normal page flow */
        [data-drawer] {
            display: none !important;
        }

        /* Drawer overlay backdrop */
        .drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }
        .drawer-overlay.active {
            display: block;
        }

        /* Drawer panel (the section when opened) */
        [data-drawer].drawer-open {
            display: block !important;
            position: fixed;
            top: 0;
            right: 0;
            width: 700px;
            max-width: 95vw;
            height: 100vh;
            height: 100dvh;
            z-index: 1001;
            overflow-y: auto;
            overflow-x: hidden;
            background: var(--gray-50);
            padding: 70px 24px 24px;
            box-shadow: -8px 0 30px rgba(0, 0, 0, 0.15);
            animation: drawerSlideIn 0.3s ease forwards;
        }

        @keyframes drawerSlideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Close button (injected via JS) */
        .drawer-close-btn {
            position: fixed;
            top: 14px;
            right: 14px;
            z-index: 1002;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--gray-200);
            color: var(--gray-700);
            font-size: 22px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .drawer-close-btn:hover {
            background: var(--gray-300);
        }

        /* When inside a drawer, disable collapsible behavior and auto-expand */
        [data-drawer].drawer-open .collapsible-header {
            cursor: default;
            pointer-events: none;
        }
        [data-drawer].drawer-open .section-toggle-btn,
        [data-drawer].drawer-open .toggle-icon {
            display: none;
        }
        [data-drawer].drawer-open .collapsible-content {
            display: block !important;
            max-height: none !important;
        }
        [data-drawer].drawer-open .collapsible-content.collapsed {
            display: block !important;
        }

        /* ===== DARK THEME - Action Bar ===== */
        [data-theme="dark"] .client-action-bar {
            background: #1a2332;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        [data-theme="dark"] .action-bar-btn {
            background: #0f1923;
            border-color: #2a3a4e;
            color: #94a3b8;
        }
        [data-theme="dark"] .action-bar-btn svg {
            stroke: #94a3b8;
        }
        [data-theme="dark"] .action-bar-btn:hover {
            background: var(--brand-primary);
            color: #fff;
            border-color: var(--brand-primary);
        }
        [data-theme="dark"] .action-bar-btn:hover svg { stroke: #fff; }

        /* ===== DARK THEME - Drawer ===== */
        [data-theme="dark"] .drawer-overlay {
            background: rgba(0, 0, 0, 0.7);
        }
        [data-theme="dark"] [data-drawer].drawer-open {
            background: #0f1923;
            box-shadow: -8px 0 30px rgba(0, 0, 0, 0.5);
        }
        [data-theme="dark"] .drawer-close-btn {
            background: #2a3a4e;
            color: #e2e8f0;
        }
        [data-theme="dark"] .drawer-close-btn:hover {
            background: #3a4a5e;
        }

        /* ===== RESPONSIVE - Action Bar ===== */
        @media (max-width: 768px) {
            .client-action-bar {
                padding: 12px;
                gap: 6px;
            }
            .action-bar-btn {
                min-width: 68px;
                padding: 8px 10px;
                font-size: 10px;
            }
            .action-bar-btn svg {
                width: 18px;
                height: 18px;
            }
            [data-drawer].drawer-open {
                width: 100vw;
                max-width: 100vw;
                padding: 60px 16px 16px;
            }
        }
    </style>
    <script src="https://unpkg.com/lucide@0.312.0/dist/umd/lucide.min.js" onload="lucide.createIcons()"></script>
    <style>body{-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;overscroll-behavior:none;-webkit-overflow-scrolling:touch;}</style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="sidebar-logo">
                <img src="https://qewqcjzlfqamqwbccapr.supabase.co/storage/v1/object/public/assets/Untitled%20design%20(3).svg" alt="Zique Fitness" class="sidebar-logo-img">
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="sidebar-nav-section" data-section="menu">
                <div class="sidebar-nav-label" onclick="toggleSidebarSection(this)">
                    Menu
                    <svg class="collapse-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="sidebar-nav-items">
                    <a href="dashboard.html" class="sidebar-nav-item">
                        <span class="sidebar-nav-icon"><i data-lucide="layout-dashboard"></i></span>
                        Dashboard
                    </a>
                    <a href="manage-clients.html" class="sidebar-nav-item active">
                        <span class="sidebar-nav-icon"><i data-lucide="users"></i></span>
                        Clients
                    </a>
                    <a href="manage-recipes.html" class="sidebar-nav-item">
                        <span class="sidebar-nav-icon"><i data-lucide="book-open"></i></span>
                        Recipes
                    </a>
                    <a href="planner.html" class="sidebar-nav-item">
                        <span class="sidebar-nav-icon"><i data-lucide="sparkles"></i></span>
                        AI Planner
                    </a>
                </div>
            </div>
            <div class="sidebar-nav-section" data-section="settings">
                <div class="sidebar-nav-label" onclick="toggleSidebarSection(this)">
                    Settings
                    <svg class="collapse-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="sidebar-nav-items">
                    <a href="coach-profile.html" class="sidebar-nav-item">
                        <span class="sidebar-nav-icon"><i data-lucide="user"></i></span>
                        My Profile
                    </a>
                    <a href="supplement-protocols.html" class="sidebar-nav-item">
                        <span class="sidebar-nav-icon"><i data-lucide="pill"></i></span>
                        Supplements
                    </a>
                    <a href="reminder-settings.html" class="sidebar-nav-item">
                        <span class="sidebar-nav-icon"><i data-lucide="bell"></i></span>
                        Reminders
                    </a>
                </div>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="sidebar-user-avatar">C</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="sidebarEmail">Loading...</div>
                    <div class="sidebar-user-role">Coach</div>
                </div>
                <button class="sidebar-logout" onclick="logout()" title="Logout">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </div>
    </aside>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <main class="main-content">
        <header class="main-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            <h1 class="main-header-title"> Client Profile</h1>
            <div class="main-header-actions"></div>
        </header>

        <div class="page-container">
            <!-- Client Info Card -->
        <div class="client-card" id="clientCard" style="display: none;">
            <div class="client-header">
                <div class="client-header-info">
                    <div class="client-profile-avatar" id="clientAvatar">
                        <span id="clientAvatarInitial">?</span>
                    </div>
                    <div>
                        <div class="client-name" id="clientName">Loading...</div>
                        <div class="client-meta" id="clientMeta"></div>
                    </div>
                </div>
                <div class="client-actions">
                    <button class="btn btn-primary" onclick="generateNewPlan()"> Generate New Plan</button>
                    <button class="btn btn-edit" onclick="editClient()"> Edit</button>
                    <button class="btn btn-secondary" onclick="sendPasswordReset()" title="Send password reset email to client"> Reset Password</button>
                    <button class="btn btn-back" onclick="window.location.href='manage-clients.html'"> Back</button>
                </div>
            </div>
            <div class="client-stats" id="clientStats"></div>

            <!-- Reminder Status Section -->
            <div class="reminder-status-section" id="reminderStatusSection" style="display: none;">
                <div class="reminder-status-info">
                    <span>Check-in Reminders:</span>
                    <span class="reminder-status-badge" id="reminderStatusBadge">Loading...</span>
                    <span class="reminder-last-sent" id="reminderLastSent"></span>
                </div>
                <button class="reminder-toggle-btn" id="reminderToggleBtn" onclick="toggleClientReminders()">
                    Toggle Reminders
                </button>
            </div>
        </div>

        <!-- Client Action Bar -->
        <div class="client-action-bar" id="clientActionBar" style="display: none;">
            <button class="action-bar-btn" onclick="openDrawer('goals')">
                <span class="action-bar-icon"></span>
                Goals
            </button>
            <button class="action-bar-btn" onclick="openDrawer('ai-coach')">
                <span class="action-bar-icon"></span>
                AI Coach
            </button>
            <button class="action-bar-btn" onclick="openDrawer('workouts')">
                <span class="action-bar-icon"></span>
                Workouts
            </button>
            <button class="action-bar-btn" onclick="openDrawer('notes')">
                <span class="action-bar-icon"></span>
                Notes
            </button>
            <button class="action-bar-btn" onclick="openDrawer('programs')">
                <span class="action-bar-icon"></span>
                Programs
            </button>
            <button class="action-bar-btn" onclick="openDrawer('diary')">
                <span class="action-bar-icon"></span>
                Diary
            </button>
            <button class="action-bar-btn" onclick="openDrawer('plans')">
                <span class="action-bar-icon"></span>
                Plans
            </button>
            <button class="action-bar-btn" onclick="openDrawer('supplements')">
                <span class="action-bar-icon"></span>
                Supps
            </button>
            <button class="action-bar-btn" onclick="openDrawer('favorites')">
                <span class="action-bar-icon"></span>
                Favorites
            </button>
            <button class="action-bar-btn" onclick="openDrawer('photos')">
                <span class="action-bar-icon"></span>
                Photos
            </button>
            <button class="action-bar-btn" onclick="openDrawer('measurements')">
                <span class="action-bar-icon"></span>
                Measures
            </button>
        </div>

        <!-- Drawer Overlay -->
        <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

        <!-- Client Goals Section -->
        <div class="goals-section" id="goalsSection" data-drawer="goals">
            <div class="goals-header">
                <h2 class="goals-title"> Daily Nutrition Goals</h2>
            </div>

            <!-- Mode Tabs -->
            <div class="goals-mode-tabs">
                <button class="goals-mode-tab active" onclick="setGoalsMode('calculate')" id="tabCalculate">
                     Calculate
                </button>
                <button class="goals-mode-tab" onclick="setGoalsMode('percentage')" id="tabPercentage">
                     Percentage
                </button>
                <button class="goals-mode-tab" onclick="setGoalsMode('custom')" id="tabCustom">
                     Custom
                </button>
            </div>

            <!-- Calculate Mode (AI/Formula based) -->
            <div id="calculateMode" class="calculate-mode-section active">
                <div class="client-stats-card">
                    <div class="client-stats-header">
                        <div class="client-stats-title">
                             Client Stats
                        </div>
                        <div class="client-stats-actions">
                            <div class="coach-unit-toggle" title="Toggle between Imperial and Metric units">
                                <button type="button" class="unit-btn active" data-unit="imperial" onclick="setCoachDisplayUnit('imperial')">lbs</button>
                                <button type="button" class="unit-btn" data-unit="metric" onclick="setCoachDisplayUnit('metric')">kg</button>
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="editClient()" style="font-size: 12px; padding: 6px 12px;">
                                Edit Stats
                            </button>
                        </div>
                    </div>
                    <div class="client-stats-grid" id="clientStatsGrid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="calculate-result-card">
                    <div class="calculate-result-header">
                        <div class="calculate-result-title">Recommended Daily Targets</div>
                        <button class="calculate-btn" onclick="calculateFromStats()" id="calculateBtn">
                             Recalculate
                        </button>
                    </div>
                    <div class="calculated-values-grid">
                        <div class="calculated-value-item">
                            <div class="calculated-value-number calories" id="calcCalories">--</div>
                            <div class="calculated-value-label">Calories</div>
                        </div>
                        <div class="calculated-value-item">
                            <div class="calculated-value-number protein" id="calcProtein">--</div>
                            <div class="calculated-value-label">Protein (g)</div>
                        </div>
                        <div class="calculated-value-item">
                            <div class="calculated-value-number carbs" id="calcCarbs">--</div>
                            <div class="calculated-value-label">Carbs (g)</div>
                        </div>
                        <div class="calculated-value-item">
                            <div class="calculated-value-number fat" id="calcFat">--</div>
                            <div class="calculated-value-label">Fat (g)</div>
                        </div>
                    </div>
                    <div class="calculate-formula-info">
                        <strong>Formula:</strong> Mifflin-St Jeor (BMR)  Activity Level  Goal Adjustment<br>
                        <strong>Macros:</strong> 30% Protein / 40% Carbs / 30% Fat
                    </div>
                </div>

                <button class="apply-calculated-btn" onclick="applyCalculatedGoals()" id="applyCalcBtn" disabled>
                     Apply These Goals
                </button>
            </div>

            <!-- Percentage-based Calculator -->
            <div id="percentageMode" class="calculate-mode-section">
                <div class="calories-input-section">
                    <label>Total Calories</label>
                    <input type="number" id="goalCalories" value="2000" min="500" max="10000" oninput="calculateMacrosFromPercentage()">
                </div>

                <div class="macro-cards-grid">
                    <div class="macro-card protein">
                        <div class="macro-card-label">Protein %</div>
                        <div class="macro-input-row">
                            <input type="number" id="proteinPercent" value="30" min="0" max="100" oninput="handlePercentageInput('protein')">
                            <span class="unit">%</span>
                        </div>
                        <div class="macro-calculated">
                            <div class="macro-grams" id="proteinGramsDisplay">150g</div>
                            <div class="macro-cals">(<span id="proteinCalsDisplay">600</span> cal)</div>
                        </div>
                    </div>

                    <div class="macro-card carbs">
                        <div class="macro-card-label">Carbs %</div>
                        <div class="macro-input-row">
                            <input type="number" id="carbsPercent" value="40" min="0" max="100" oninput="handlePercentageInput('carbs')">
                            <span class="unit">%</span>
                        </div>
                        <div class="macro-calculated">
                            <div class="macro-grams" id="carbsGramsDisplay">200g</div>
                            <div class="macro-cals">(<span id="carbsCalsDisplay">800</span> cal)</div>
                        </div>
                    </div>

                    <div class="macro-card fat">
                        <div class="macro-card-label">Fat %</div>
                        <div class="macro-input-row">
                            <input type="number" id="fatPercent" value="30" min="0" max="100" oninput="handlePercentageInput('fat')">
                            <span class="unit">%</span>
                        </div>
                        <div class="macro-calculated">
                            <div class="macro-grams" id="fatGramsDisplay">67g</div>
                            <div class="macro-cals">(<span id="fatCalsDisplay">600</span> cal)</div>
                        </div>
                    </div>
                </div>

                <div class="percentage-total-bar">
                    <span class="percentage-total-text" id="percentageTotalText">Total: 100%</span>
                    <div class="percentage-progress">
                        <div class="percentage-progress-fill valid" id="percentageProgressFill" style="width: 100%"></div>
                    </div>
                    <span style="font-size: 12px; color: var(--gray-500);">Enter percentages</span>
                </div>

                <div class="goals-tip">
                     Enter calories and any 2 percentages - the 3rd will auto-fill to reach 100%.
                </div>
            </div>

            <!-- Custom/Manual Mode -->
            <div id="customMode" class="calculate-mode-section">
                <div class="goals-grid">
                    <div class="goal-item calories">
                        <label>Calories</label>
                        <input type="number" id="goalCaloriesCustom" value="2000" min="500" max="10000">
                    </div>
                    <div class="goal-item protein">
                        <label>Protein (g)</label>
                        <input type="number" id="goalProtein" value="150" min="0" max="500">
                    </div>
                    <div class="goal-item carbs">
                        <label>Carbs (g)</label>
                        <input type="number" id="goalCarbs" value="200" min="0" max="1000">
                    </div>
                    <div class="goal-item fat">
                        <label>Fat (g)</label>
                        <input type="number" id="goalFat" value="65" min="0" max="500">
                    </div>
                </div>
            </div>

            <div class="goals-footer">
                <div class="permission-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" id="canEditGoalsToggle" onchange="toggleClientGoalPermission()">
                        <span class="toggle-slider"></span>
                    </label>
                    <label for="canEditGoalsToggle">Allow client to edit their own goals</label>
                </div>
                <button class="goals-save-btn" onclick="saveClientGoals()" id="saveGoalsBtn">Save Goals</button>
            </div>
        </div>

        <!-- AI Coach Assistant Section -->
        <div class="ai-assistant-section" data-drawer="ai-coach">
            <div class="ai-assistant-header">
                <h2 class="ai-assistant-title"> AI Coach Assistant</h2>
            </div>
            <p class="ai-assistant-description">
                Ask questions about your client's nutrition data and get instant AI-powered insights.
            </p>

            <!-- Quick Question Buttons -->
            <div class="ai-quick-questions">
                <button class="ai-quick-btn" onclick="askQuickQuestion('How is my client doing with their calorie goals?')">Calorie Progress</button>
                <button class="ai-quick-btn" onclick="askQuickQuestion('Is my client getting enough protein?')">Protein Check</button>
                <button class="ai-quick-btn" onclick="askQuickQuestion('What patterns do you see in their eating habits?')">Eating Patterns</button>
                <button class="ai-quick-btn" onclick="askQuickQuestion('What recommendations do you have for this client?')">Recommendations</button>
            </div>

            <!-- Custom Question Input -->
            <div class="ai-input-container">
                <textarea id="aiCoachQuestion"
                    placeholder="Ask anything about your client's diet... e.g., 'Are they eating enough vegetables?' or 'How can they increase protein?'"
                    rows="2"></textarea>
                <button class="btn btn-primary ai-ask-btn" onclick="askAICoach()" id="aiAskBtn">
                    Ask AI
                </button>
            </div>

            <!-- AI Response Area -->
            <div id="aiResponseContainer" class="ai-response-container" style="display: none;">
                <div class="ai-response-header">
                    <span> AI Insights</span>
                </div>
                <div id="aiResponseText" class="ai-response-text"></div>
            </div>

            <!-- Loading State -->
            <div id="aiLoading" class="ai-loading" style="display: none;">
                <div class="ai-loading-spinner"></div>
                <span>Analyzing client data...</span>
            </div>
        </div>

        <!-- Activity Calendar Section -->
        <div class="activity-calendar-section">
            <div class="section-header collapsible-header" onclick="toggleSection('activityCalendar')" style="cursor: pointer;">
                <h2 class="section-title"> Activity Calendar</h2>
                <button class="section-toggle-btn" type="button">
                    <span class="toggle-icon" id="activityCalendarToggleIcon"></span>
                </button>
            </div>
            <div id="activityCalendarContent" class="collapsible-content">
                <div class="ac-layout">
                    <!-- Calendar Grid -->
                    <div class="ac-calendar-container">
                        <div class="ac-month-nav">
                            <button onclick="acChangeMonth(-1)" title="Previous month">&#8592;</button>
                            <span class="ac-month-title" id="acMonthTitle">January 2026</span>
                            <button onclick="acChangeMonth(1)" title="Next month">&#8594;</button>
                        </div>
                        <div class="ac-grid" id="acCalendarGrid">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Day Detail Panel -->
                    <div class="ac-detail-panel" id="acDetailPanel">
                        <div class="ac-detail-header" id="acDetailDate">Select a day</div>
                        <div class="ac-detail-body" id="acDetailBody">
                            <div class="ac-detail-empty">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <p>Click a day to view workouts</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exercise Selector Modal (for Activity Calendar) -->
        <div class="ac-modal-overlay" id="acExerciseModal">
            <div class="ac-modal">
                <div class="ac-modal-header">
                    <h3 id="acModalTitle">Add Exercise</h3>
                    <button class="ac-modal-close" onclick="acCloseExerciseModal()">&times;</button>
                </div>
                <div class="ac-modal-body">
                    <input type="text" class="ac-modal-search" id="acExerciseSearch" placeholder="Search exercises..." oninput="acSearchExercises()">
                    <div class="ac-modal-filters" id="acMuscleFilters">
                        <button class="ac-filter-chip active" data-muscle="all" onclick="acFilterMuscle('all', this)">All</button>
                        <button class="ac-filter-chip" data-muscle="chest" onclick="acFilterMuscle('chest', this)">Chest</button>
                        <button class="ac-filter-chip" data-muscle="back" onclick="acFilterMuscle('back', this)">Back</button>
                        <button class="ac-filter-chip" data-muscle="shoulders" onclick="acFilterMuscle('shoulders', this)">Shoulders</button>
                        <button class="ac-filter-chip" data-muscle="legs" onclick="acFilterMuscle('legs', this)">Legs</button>
                        <button class="ac-filter-chip" data-muscle="arms" onclick="acFilterMuscle('arms', this)">Arms</button>
                        <button class="ac-filter-chip" data-muscle="core" onclick="acFilterMuscle('core', this)">Core</button>
                    </div>
                    <div id="acExerciseList">
                        <div class="ac-loading"><div class="ac-spinner"></div></div>
                    </div>
                </div>
                <div class="ac-modal-footer" id="acModalFooter" style="display:none;">
                    <button class="ac-add-selected-btn" id="acAddSelectedBtn" onclick="acAddSelectedExercises()" disabled>Add Selected (0)</button>
                </div>
            </div>
        </div>

        <!-- Add Workout Modal (Program Picker) -->
        <div class="ac-modal-overlay" id="acAddWorkoutModal">
            <div class="ac-modal">
                <div class="ac-modal-header">
                    <h3 id="acAddWorkoutTitle">Add Workout</h3>
                    <button class="ac-modal-close" onclick="acCloseAddWorkoutModal()">&times;</button>
                </div>
                <div class="ac-modal-body" id="acAddWorkoutBody">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Exercise Detail Modal -->
        <div class="ac-exercise-detail-modal" id="acExerciseDetailModal">
            <div class="ac-exercise-detail-content">
                <div class="ac-exd-header">
                    <h2 class="ac-exd-title" id="acExdTitle">Exercise</h2>
                    <button class="ac-modal-close" onclick="acCloseExerciseDetail()">&times;</button>
                </div>
                <div id="acExdBody">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Date Picker Modal (for Move/Copy) -->
        <div class="ac-date-picker-modal" id="acDatePickerModal">
            <div class="ac-date-picker-content">
                <h3 id="acDatePickerTitle">Move to date</h3>
                <div class="ac-dp-nav">
                    <button onclick="acDpNavMonth(-1)">&larr;</button>
                    <span id="acDpMonthLabel"></span>
                    <button onclick="acDpNavMonth(1)">&rarr;</button>
                </div>
                <div class="ac-dp-weekdays">
                    <span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span><span>Su</span>
                </div>
                <div class="ac-dp-days" id="acDpDays"></div>
                <div class="ac-date-picker-btns">
                    <button class="ac-action-btn" onclick="acCloseDatePicker()">Cancel</button>
                    <button class="ac-set-save-btn" style="width:auto; margin:0; padding:8px 20px;" onclick="acConfirmDatePicker()">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Workout Progress Section -->
        <div class="workout-progress-section" data-drawer="workouts">
            <div class="section-header collapsible-header" onclick="toggleSection('workouts')" style="cursor: pointer;">
                <h2 class="section-title"> Workout Progress</h2>
                <button class="section-toggle-btn" type="button">
                    <span class="toggle-icon" id="workoutsToggleIcon"></span>
                </button>
            </div>
            <div id="workoutsContent" class="collapsible-content">
                <!-- AI Workout Insights -->
                <div class="workout-ai-section">
                    <h3 class="workout-subsection-title"> AI Workout Insights</h3>
                    <div class="workout-ai-quick-btns">
                        <button class="ai-quick-btn" onclick="askWorkoutQuickQuestion('How is this client progressing overall? Any PRs, plateaus, or concerns?')">Overall Progress</button>
                        <button class="ai-quick-btn" onclick="askWorkoutQuickQuestion('Where is this client plateauing and what changes would you recommend?')">Plateaus</button>
                        <button class="ai-quick-btn" onclick="askWorkoutQuickQuestion('Did this client leave any notes? What are they saying about their training?')">Client Notes</button>
                        <button class="ai-quick-btn" onclick="askWorkoutQuickQuestion('Is this client training consistently? How is their workout frequency and volume trending?')">Consistency</button>
                    </div>
                    <div class="ai-input-container">
                        <textarea id="workoutAiQuestion"
                            placeholder="Ask about this client's workout progress, plateaus, volume trends..."
                            rows="2"></textarea>
                        <button class="btn btn-primary ai-ask-btn" onclick="askWorkoutAI()" id="workoutAiAskBtn">
                            Ask AI
                        </button>
                    </div>
                    <div id="workoutAiResponseContainer" class="ai-response-container" style="display: none;">
                        <div class="ai-response-header"><span> Workout Insights</span></div>
                        <div id="workoutAiResponseText" class="ai-response-text"></div>
                    </div>
                    <div id="workoutAiLoading" class="ai-loading" style="display: none;">
                        <div class="ai-loading-spinner"></div>
                        <span>Analyzing workout data...</span>
                    </div>
                </div>

                <!-- Workout Date Navigation -->
                <div class="workout-date-nav">
                    <button class="workout-nav-btn" onclick="changeWorkoutDateRange(-7)"> Prev Week</button>
                    <span id="workoutDateRange" class="workout-date-label">Last 7 Days</span>
                    <button class="workout-nav-btn" onclick="changeWorkoutDateRange(7)">Next Week </button>
                </div>

                <!-- Weekly Summary Banner (populated by JS) -->
                <div id="workoutWeeklySummary"></div>

                <!-- Fatigue / Readiness Alert (populated by JS) -->
                <div id="workoutFatigueAlert"></div>

                <!-- Missed Workouts (populated by JS) -->
                <div id="workoutMissedDays"></div>

                <!-- Workout Logs Container -->
                <div id="workoutLogsContainer">
                    <div class="loading skeleton-loading">
                        <div class="skeleton" style="height: 80px; margin-bottom: 12px; border-radius: 10px;"></div>
                        <div class="skeleton" style="height: 80px; margin-bottom: 12px; border-radius: 10px;"></div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="workoutEmptyState" class="workout-empty" style="display: none;">
                    <span style="font-size: 32px;"></span>
                    <p>No workout logs for this period</p>
                    <span style="color: #6b7280; font-size: 13px;">When your client logs sets and reps, they'll appear here.</span>
                </div>
            </div>
        </div>

        <!-- Client Notes & Voice Notes Section -->
        <div class="client-notes-section" data-drawer="notes">
            <div class="section-header collapsible-header" onclick="toggleSection('clientNotes')" style="cursor: pointer;">
                <h2 class="section-title"> Client Notes & Voice Notes</h2>
                <button class="section-toggle-btn" type="button">
                    <span class="toggle-icon" id="clientNotesToggleIcon"></span>
                </button>
            </div>
            <div id="clientNotesContent" class="collapsible-content">
                <div id="clientNotesContainer" class="cn-section">
                    <div class="loading skeleton-loading">
                        <div class="skeleton" style="height: 60px; margin-bottom: 10px; border-radius: 10px;"></div>
                        <div class="skeleton" style="height: 60px; margin-bottom: 10px; border-radius: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workout Programs Section -->
        <div class="workout-programs-section" data-drawer="programs">
            <div class="section-header collapsible-header" onclick="toggleSection('workoutPrograms')" style="cursor: pointer;">
                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <h2 class="section-title"> Workout Programs</h2>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="wpr-header-actions">
                            <button class="wpr-btn primary" onclick="event.stopPropagation(); showAssignProgramModal()">+ Assign Program</button>
                        </div>
                        <button class="section-toggle-btn" type="button">
                            <span class="toggle-icon collapsed" id="workoutProgramsToggleIcon"></span>
                        </button>
                    </div>
                </div>
            </div>
            <div id="workoutProgramsContent" class="collapsible-content collapsed">
                <div id="activeAssignmentContainer"></div>
                <h3 style="font-size: 14px; font-weight: 600; color: #64748b; margin: 20px 0 12px; text-transform: uppercase; letter-spacing: 0.5px;">Your Programs</h3>
                <div id="programsListContainer">
                    <div class="loading skeleton-loading">
                        <div class="skeleton" style="height: 60px; margin-bottom: 8px; border-radius: 10px;"></div>
                        <div class="skeleton" style="height: 60px; margin-bottom: 8px; border-radius: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Container for Workout Modals -->
        <div id="workoutModalContainer"></div>

        <!-- Food Diary Section -->
        <div class="diary-section" data-drawer="diary">
            <div class="diary-header">
                <h2 class="diary-title"> Food Diary</h2>
                <div class="diary-date-nav">
                    <button class="diary-nav-btn" onclick="changeDiaryDate(-1)"></button>
                    <input type="date" id="diaryDatePicker" onchange="loadFoodDiary(clientId)">
                    <button class="diary-nav-btn" onclick="changeDiaryDate(1)"></button>
                </div>
            </div>

            <!-- Daily Summary -->
            <div id="diarySummary" class="diary-summary" style="display: none;">
                <div class="diary-summary-item">
                    <span class="diary-summary-value" id="diaryCalories">0</span>
                    <span class="diary-summary-label">Calories</span>
                </div>
                <div class="diary-summary-item">
                    <span class="diary-summary-value" id="diaryProtein">0g</span>
                    <span class="diary-summary-label">Protein</span>
                </div>
                <div class="diary-summary-item">
                    <span class="diary-summary-value" id="diaryCarbs">0g</span>
                    <span class="diary-summary-label">Carbs</span>
                </div>
                <div class="diary-summary-item">
                    <span class="diary-summary-value" id="diaryFat">0g</span>
                    <span class="diary-summary-label">Fat</span>
                </div>
            </div>

            <!-- Meals Container -->
            <div id="diaryContainer">
                <div class="loading skeleton-loading">
                    <div class="skeleton-section">
                        <div class="skeleton skeleton-section-title"></div>
                        <div class="skeleton-diary-item">
                            <div class="skeleton skeleton-food-name"></div>
                            <div class="skeleton-food-macros">
                                <div class="skeleton skeleton-macro"></div>
                                <div class="skeleton skeleton-macro"></div>
                                <div class="skeleton skeleton-macro"></div>
                            </div>
                        </div>
                        <div class="skeleton-diary-item">
                            <div class="skeleton skeleton-food-name"></div>
                            <div class="skeleton-food-macros">
                                <div class="skeleton skeleton-macro"></div>
                                <div class="skeleton skeleton-macro"></div>
                                <div class="skeleton skeleton-macro"></div>
                            </div>
                        </div>
                        <div class="skeleton-diary-item">
                            <div class="skeleton skeleton-food-name"></div>
                            <div class="skeleton-food-macros">
                                <div class="skeleton skeleton-macro"></div>
                                <div class="skeleton skeleton-macro"></div>
                                <div class="skeleton skeleton-macro"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plans Section -->
        <div class="plans-section" data-drawer="plans">
            <div class="section-header collapsible-header" onclick="toggleSection('plans')" style="cursor: pointer;">
                <h2 class="section-title"> Meal Plans</h2>
                <button class="section-toggle-btn" type="button">
                    <span class="toggle-icon collapsed" id="plansToggleIcon"></span>
                </button>
            </div>
            <div id="plansContent" class="collapsible-content collapsed">
                <!-- Bulk Actions Bar -->
                <div class="bulk-actions" id="bulkActionsBar" style="display: none;">
                    <div class="bulk-actions-left">
                        <label class="select-all-container">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            <span class="select-all-label">Select All</span>
                        </label>
                        <span class="selected-count" id="selectedCount">0 selected</span>
                    </div>
                    <button class="btn-delete-selected" id="deleteSelectedBtn" onclick="deleteSelectedPlans()">
                         Delete Selected
                    </button>
                </div>
                <div id="plansContainer">
                    <div class="loading skeleton-loading">
                        <div class="skeleton-plan-card">
                            <div class="skeleton skeleton-plan-title"></div>
                            <div class="skeleton skeleton-plan-meta"></div>
                            <div class="skeleton skeleton-plan-meta" style="width: 100px;"></div>
                        </div>
                        <div class="skeleton-plan-card">
                            <div class="skeleton skeleton-plan-title"></div>
                            <div class="skeleton skeleton-plan-meta"></div>
                            <div class="skeleton skeleton-plan-meta" style="width: 100px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Supplement Protocol Section -->
        <div class="protocols-section" id="protocolsSection" data-drawer="supplements">
            <div class="section-header collapsible-header" onclick="toggleSection('protocols')" style="cursor: pointer;">
                <h2 class="section-title"> Supplement Protocol</h2>
                <button class="section-toggle-btn" type="button">
                    <span class="toggle-icon collapsed" id="protocolsToggleIcon"></span>
                </button>
            </div>
            <div id="protocolsContent" class="collapsible-content collapsed">
                <div id="protocolsContainer">
                    <div class="loading skeleton-loading">
                        <div class="skeleton-plan-card">
                            <div class="skeleton skeleton-plan-title"></div>
                            <div class="skeleton skeleton-plan-meta"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Favorites Section -->
        <div class="favorites-section" data-drawer="favorites">
            <div class="favorites-header collapsible-header" onclick="toggleSection('favorites')" style="cursor: pointer;">
                <h2 class="favorites-title"> Favorite Meals</h2>
                <button class="section-toggle-btn" type="button">
                    <span class="toggle-icon collapsed" id="favoritesToggleIcon"></span>
                </button>
            </div>
            <div id="favoritesContent" class="collapsible-content collapsed">
                <div id="favoritesStatsBar" class="favorites-stats" style="display: none;">
                    <div class="favorites-stat-item">
                        <span class="favorites-stat-icon"></span>
                        <span class="favorites-stat-text"><strong id="favoritesTotalCount">0</strong> favorites</span>
                    </div>
                    <div class="favorites-stat-item">
                        <span class="favorites-stat-icon"></span>
                        <span class="favorites-stat-text"><strong id="favoritesAvgCalories">0</strong> avg calories</span>
                    </div>
                    <div class="favorites-stat-item">
                        <span class="favorites-stat-icon"></span>
                        <span class="favorites-stat-text"><strong id="favoritesAvgProtein">0</strong>g avg protein</span>
                    </div>
                </div>
                <div id="favoritesFilterBar" class="favorites-filter-bar" style="display: none;">
                    <button class="favorites-filter-btn active" data-filter="all" onclick="filterFavorites('all', this)">All</button>
                    <button class="favorites-filter-btn" data-filter="breakfast" onclick="filterFavorites('breakfast', this)">Breakfast</button>
                    <button class="favorites-filter-btn" data-filter="lunch" onclick="filterFavorites('lunch', this)">Lunch</button>
                    <button class="favorites-filter-btn" data-filter="dinner" onclick="filterFavorites('dinner', this)">Dinner</button>
                    <button class="favorites-filter-btn" data-filter="snack" onclick="filterFavorites('snack', this)">Snack</button>
                </div>
                <div id="favoritesContainer">
                    <div class="loading skeleton-loading">
                        <div class="skeleton-plan-card">
                            <div class="skeleton skeleton-plan-title"></div>
                            <div class="skeleton skeleton-plan-meta"></div>
                        </div>
                        <div class="skeleton-plan-card">
                            <div class="skeleton skeleton-plan-title"></div>
                            <div class="skeleton skeleton-plan-meta"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Photos Section -->
        <div class="photos-section" data-drawer="photos">
            <div class="photos-header collapsible-header" onclick="toggleSection('photos')" style="cursor: pointer;">
                <h2 class="photos-title"> Progress Photos</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); openUploadModal()">+ Add Photo</button>
                    <button class="section-toggle-btn" type="button">
                        <span class="toggle-icon collapsed" id="photosToggleIcon"></span>
                    </button>
                </div>
            </div>
            <div id="photosContent" class="collapsible-content collapsed">
                <div id="photosContainer">
                    <div class="loading skeleton-loading">
                        <div class="skeleton-photo-grid">
                            <div class="skeleton skeleton-photo"></div>
                            <div class="skeleton skeleton-photo"></div>
                            <div class="skeleton skeleton-photo"></div>
                            <div class="skeleton skeleton-photo"></div>
                            <div class="skeleton skeleton-photo"></div>
                            <div class="skeleton skeleton-photo"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Measurements Section -->
        <div class="measurements-section" data-drawer="measurements">
            <div class="measurements-header collapsible-header" onclick="toggleSection('measurements')" style="cursor: pointer;">
                <h2 class="measurements-title"> Body Measurements</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); openMeasurementModal()">+ Log Measurement</button>
                    <button class="section-toggle-btn" type="button">
                        <span class="toggle-icon collapsed" id="measurementsToggleIcon"></span>
                    </button>
                </div>
            </div>
            <div id="measurementsContent" class="collapsible-content collapsed">
                <div id="measurementsContainer">
                    <div class="loading skeleton-loading">
                        <div class="skeleton-measurements-grid">
                            <div class="skeleton-measurement">
                                <div class="skeleton skeleton-measurement-value"></div>
                                <div class="skeleton skeleton-measurement-label"></div>
                            </div>
                            <div class="skeleton-measurement">
                                <div class="skeleton skeleton-measurement-value"></div>
                                <div class="skeleton skeleton-measurement-label"></div>
                            </div>
                            <div class="skeleton-measurement">
                                <div class="skeleton skeleton-measurement-value"></div>
                                <div class="skeleton skeleton-measurement-label"></div>
                            </div>
                            <div class="skeleton-measurement">
                                <div class="skeleton skeleton-measurement-value"></div>
                                <div class="skeleton skeleton-measurement-label"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Check-ins Section -->
        <div class="checkins-section">
            <div class="checkins-header collapsible-header" onclick="toggleSection('checkins')" style="cursor: pointer;">
                <h2 class="checkins-title"> Check-ins</h2>
                <button class="section-toggle-btn" type="button">
                    <span class="toggle-icon" id="checkinsToggleIcon"></span>
                </button>
            </div>
            <div id="checkinsContent" class="collapsible-content">
                <div id="checkinsContainer">
                    <div class="loading skeleton-loading">
                        <div class="skeleton-checkin">
                            <div class="skeleton skeleton-checkin-date"></div>
                            <div class="skeleton skeleton-checkin-content"></div>
                        </div>
                        <div class="skeleton-checkin">
                            <div class="skeleton skeleton-checkin-date"></div>
                            <div class="skeleton skeleton-checkin-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Measurement Modal -->
    <div id="measurementModal" class="measurement-modal">
        <div class="measurement-modal-content">
            <div class="photo-modal-header">
                <h2>Log Measurement</h2>
                <button class="close-btn" onclick="closeMeasurementModal()">&times;</button>
            </div>

            <div class="measurement-form-grid">
                <div class="form-group full-width">
                    <label>Date</label>
                    <input type="date" id="measurementDate">
                </div>

                <div class="form-group">
                    <label>Weight</label>
                    <input type="number" id="measurementWeight" step="0.1" placeholder="e.g., 175.5">
                </div>
                <div class="form-group">
                    <label>Unit</label>
                    <select id="weightUnit">
                        <option value="lbs">lbs</option>
                        <option value="kg">kg</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Body Fat %</label>
                    <input type="number" id="measurementBodyFat" step="0.1" placeholder="e.g., 15.5">
                </div>
                <div class="form-group">
                    <label>Waist</label>
                    <input type="number" id="measurementWaist" step="0.1" placeholder="inches">
                </div>

                <div class="form-group">
                    <label>Chest</label>
                    <input type="number" id="measurementChest" step="0.1" placeholder="inches">
                </div>
                <div class="form-group">
                    <label>Hips</label>
                    <input type="number" id="measurementHips" step="0.1" placeholder="inches">
                </div>

                <div class="form-group">
                    <label>Left Arm</label>
                    <input type="number" id="measurementLeftArm" step="0.1" placeholder="inches">
                </div>
                <div class="form-group">
                    <label>Right Arm</label>
                    <input type="number" id="measurementRightArm" step="0.1" placeholder="inches">
                </div>

                <div class="form-group">
                    <label>Left Thigh</label>
                    <input type="number" id="measurementLeftThigh" step="0.1" placeholder="inches">
                </div>
                <div class="form-group">
                    <label>Right Thigh</label>
                    <input type="number" id="measurementRightThigh" step="0.1" placeholder="inches">
                </div>

                <div class="form-group full-width">
                    <label>Notes (optional)</label>
                    <input type="text" id="measurementNotes" placeholder="e.g., After morning workout">
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeMeasurementModal()">Cancel</button>
                <button class="btn btn-primary" id="saveMeasurementBtn" onclick="saveMeasurement()">Save Measurement</button>
            </div>
        </div>
    </div>

    <!-- Photo Upload Modal -->
    <div id="photoUploadModal" class="photo-modal">
        <div class="photo-modal-content">
            <div class="photo-modal-header">
                <h2>Upload Progress Photo</h2>
                <button class="close-btn" onclick="closeUploadModal()">&times;</button>
            </div>
            <img id="photoPreview" class="photo-preview" alt="Preview">
            <div id="uploadArea" class="upload-area" onclick="document.getElementById('photoInput').click()">
                <div class="upload-icon"></div>
                <div class="upload-text">Click to select a photo or drag & drop</div>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display: none" onchange="handleFileSelect(event)">

            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Photo Type</label>
                <select id="photoType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="progress">Progress</option>
                    <option value="front">Front View</option>
                    <option value="side">Side View</option>
                    <option value="back">Back View</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Date Taken</label>
                <input type="date" id="photoDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Notes (optional)</label>
                <input type="text" id="photoNotes" placeholder="e.g., Week 4 check-in" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                <button class="btn btn-primary" id="uploadBtn" onclick="uploadPhoto()" disabled>Upload Photo</button>
            </div>
        </div>
    </div>

    <!-- Protocol Edit Modal -->
    <div id="protocolEditModal" class="protocol-modal">
        <div class="protocol-modal-content">
            <div class="protocol-modal-header">
                <h2>Edit Supplement</h2>
                <button class="close-btn" onclick="closeEditProtocolModal()">&times;</button>
            </div>
            <div class="protocol-modal-body">
                <input type="hidden" id="editProtocolId">

                <div class="protocol-form-group">
                    <label>Supplement Name *</label>
                    <input type="text" id="editProtocolName" placeholder="e.g., Creatine, Fish Oil...">
                </div>

                <div class="protocol-form-group">
                    <label>Timing</label>
                    <select id="editProtocolTiming" onchange="toggleEditCustomTiming()">
                        <option value="morning">Morning</option>
                        <option value="pre_workout">Pre-Workout</option>
                        <option value="post_workout">Post-Workout</option>
                        <option value="bedtime">Before Bed</option>
                        <option value="with_meals">With Meals</option>
                        <option value="custom">Custom...</option>
                    </select>
                </div>

                <div class="protocol-form-group" id="editCustomTimingGroup" style="display: none;">
                    <label>Custom Timing</label>
                    <input type="text" id="editProtocolTimingCustom" placeholder="e.g., 2x per week...">
                </div>

                <div class="protocol-form-group">
                    <label>Dose</label>
                    <input type="text" id="editProtocolDose" placeholder="e.g., 5g, 200mg, 2 capsules...">
                </div>

                <div class="protocol-form-group">
                    <label>Notes</label>
                    <textarea id="editProtocolNotes" placeholder="Any notes or instructions..."></textarea>
                </div>
            </div>
            <div class="protocol-modal-footer">
                <button class="btn btn-secondary" onclick="closeEditProtocolModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProtocolEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Lightbox for full-size image -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img id="lightboxImage" src="" alt="Full size">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Sidebar section collapse functionality
        function toggleSidebarSection(label) {
            const section = label.parentElement;
            section.classList.toggle('collapsed');
            const sectionName = section.dataset.section;
            const collapsedSections = JSON.parse(localStorage.getItem('sidebarCollapsed') || '{}');
            collapsedSections[sectionName] = section.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', JSON.stringify(collapsedSections));
        }

        // Restore sidebar collapsed state on load
        (function restoreSidebarState() {
            const collapsedSections = JSON.parse(localStorage.getItem('sidebarCollapsed') || '{}');
            document.querySelectorAll('.sidebar-nav-section').forEach(section => {
                const sectionName = section.dataset.section;
                if (collapsedSections[sectionName]) {
                    section.classList.add('collapsed');
                }
            });
        })();

        // Unified toggle function for collapsible sections
        function toggleSection(sectionName) {
            const content = document.getElementById(`${sectionName}Content`);
            const icon = document.getElementById(`${sectionName}ToggleIcon`);

            if (content && icon) {
                content.classList.toggle('collapsed');
                icon.classList.toggle('collapsed');

                // Save state to localStorage
                const collapsedSections = JSON.parse(localStorage.getItem('clientProfileCollapsed') || '{}');
                collapsedSections[sectionName] = content.classList.contains('collapsed');
                localStorage.setItem('clientProfileCollapsed', JSON.stringify(collapsedSections));
            }
        }

        // Legacy function for backwards compatibility
        function toggleCheckinsSection() {
            toggleSection('checkins');
        }

        // Restore collapsed states on load
        // Default collapsed sections: plans, protocols, favorites, photos, measurements, checkins
        (function restoreCollapsedStates() {
            const defaultCollapsed = ['plans', 'protocols', 'favorites', 'photos', 'measurements', 'workouts', 'workoutPrograms', 'clientNotes'];
            const savedStates = JSON.parse(localStorage.getItem('clientProfileCollapsed') || '{}');

            defaultCollapsed.forEach(section => {
                const content = document.getElementById(`${section}Content`);
                const icon = document.getElementById(`${section}ToggleIcon`);

                // If no saved state, default to collapsed; otherwise use saved state
                const shouldBeCollapsed = savedStates[section] !== undefined ? savedStates[section] : true;

                if (shouldBeCollapsed) {
                    if (content) content.classList.add('collapsed');
                    if (icon) icon.classList.add('collapsed');
                } else {
                    if (content) content.classList.remove('collapsed');
                    if (icon) icon.classList.remove('collapsed');
                }
            });
        })();

        // ===== DRAWER SYSTEM =====
        function openDrawer(name) {
            closeDrawer();
            const section = document.querySelector(`[data-drawer="${name}"]`);
            if (!section) return;
            section.classList.add('drawer-open');

            // Add close button if not already there
            if (!section.querySelector('.drawer-close-btn')) {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'drawer-close-btn';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = function(e) { e.stopPropagation(); closeDrawer(); };
                section.insertBefore(closeBtn, section.firstChild);
            }

            // Auto-expand any collapsed content within
            section.querySelectorAll('.collapsible-content.collapsed').forEach(el => {
                el.classList.remove('collapsed');
            });
            section.querySelectorAll('.toggle-icon.collapsed').forEach(el => {
                el.classList.remove('collapsed');
            });

            document.getElementById('drawerOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            document.querySelectorAll('.drawer-open').forEach(el => el.classList.remove('drawer-open'));
            const overlay = document.getElementById('drawerOverlay');
            if (overlay) overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close drawer on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeDrawer();
        });

        // Initialize Supabase client
        const SUPABASE_URL = 'https://qewqcjzlfqamqwbccapr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFld3FjanpsZnFhbXF3YmNjYXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2OTg0NzAsImV4cCI6MjA3OTI3NDQ3MH0.mQnMC33O88oLkLLGWD2oG-oaSHGI-NfHmtQCZxnxSLs';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const GET_CLIENT_PLANS_ENDPOINT = '/.netlify/functions/get-client-plans';
        const DELETE_PLAN_ENDPOINT = '/.netlify/functions/delete-coach-plan';
        const PUBLISH_PLAN_ENDPOINT = '/.netlify/functions/publish-plan';
        const UPLOAD_PHOTO_ENDPOINT = '/.netlify/functions/upload-progress-photo';
        const GET_PHOTOS_ENDPOINT = '/.netlify/functions/get-progress-photos';
        const DELETE_PHOTO_ENDPOINT = '/.netlify/functions/delete-progress-photo';
        const SAVE_MEASUREMENT_ENDPOINT = '/.netlify/functions/save-measurement';
        const GET_MEASUREMENTS_ENDPOINT = '/.netlify/functions/get-measurements';
        const CHECKIN_ENDPOINT = '/.netlify/functions/save-checkin';
        const RESPOND_CHECKIN_ENDPOINT = '/.netlify/functions/respond-checkin';
        const FAVORITES_ENDPOINT = '/.netlify/functions/toggle-favorite';
        const CLIENT_PROTOCOLS_ENDPOINT = '/.netlify/functions/client-protocols';

        let currentUser = null;
        let currentClient = null;
        let clientPlans = [];
        let selectedPlans = new Set();
        let selectedPhotoFile = null;
        let clientPhotos = [];
        let clientMeasurements = [];
        let clientCheckins = [];
        let clientFavorites = [];
        let currentFavoritesFilter = 'all';
        let clientProtocols = [];
        let coachDisplayUnit = 'imperial';  // Coach's preferred display unit

        // Unit conversion helper functions
        function lbsToKg(lbs) {
            return Math.round(lbs * 0.453592 * 10) / 10;
        }

        function kgToLbs(kg) {
            return Math.round(kg * 2.20462 * 10) / 10;
        }

        function ftInToCm(ft, inches) {
            const totalInches = (ft * 12) + (inches || 0);
            return Math.round(totalInches * 2.54 * 10) / 10;
        }

        function cmToFtIn(cm) {
            const totalInches = cm / 2.54;
            const feet = Math.floor(totalInches / 12);
            const inches = Math.round(totalInches % 12);
            return { feet, inches };
        }

        // Set coach's display unit preference
        function setCoachDisplayUnit(unit) {
            coachDisplayUnit = unit;
            // Update button states
            document.querySelectorAll('.coach-unit-toggle .unit-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.unit === unit);
            });
            // Re-render stats with new unit
            displayStats();
            // Save preference to localStorage
            localStorage.setItem('coachDisplayUnit', unit);
        }

        // Logout function
        async function logout() {
            try {
                await supabaseClient.auth.signOut({ scope: 'local' });
            } catch (err) {
                console.error('Logout error:', err);
            }
            localStorage.removeItem('supabase.auth.token');
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        // Get clientId from URL
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('clientId');
        const urlHash = window.location.hash;

        // Debug: log URL parameters for notification deep linking
        console.log('Client Profile URL parsed:', {
            fullUrl: window.location.href,
            clientId: clientId,
            clientIdType: typeof clientId,
            hash: urlHash,
            searchParams: window.location.search
        });

        // Detect if page was loaded from back/forward cache and force reload
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // Page was loaded from bfcache (back/forward cache)
                console.log('Page loaded from cache, forcing reload...');
                window.location.reload();
            }
        });

        // Listen for auth state changes to handle session expiration
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event, session ? 'Session exists' : 'No session');

            if (event === 'SIGNED_OUT') {
                console.log('User signed out, redirecting to login');
                window.location.href = 'login.html';
            } else if (event === 'TOKEN_REFRESHED' && currentUser && clientId) {
                console.log('Token refreshed, reloading data');
                refreshAllData();
            }
        });

        // Load client and plans on page load
        document.addEventListener('DOMContentLoaded', async function() {
            if (!clientId) {
                alert('No client specified');
                window.location.href = 'manage-clients.html';
                return;
            }

            // Load coach's saved unit preference
            const savedUnit = localStorage.getItem('coachDisplayUnit');
            if (savedUnit && (savedUnit === 'imperial' || savedUnit === 'metric')) {
                coachDisplayUnit = savedUnit;
                // Update button states
                document.querySelectorAll('.coach-unit-toggle .unit-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.unit === savedUnit);
                });
            }

            try {
                console.log('Starting page load...');

                // Try to refresh the session to get a fresh token
                const { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();

                let session = null;

                // Check if refresh was successful
                if (refreshError) {
                    console.error('Session refresh failed:', refreshError);
                    // If refresh fails, the session is likely expired
                    try {
                        await supabaseClient.auth.signOut({ scope: 'local' });
                    } catch (err) {
                        console.error('Signout error:', err);
                    }
                    localStorage.removeItem('supabase.auth.token');
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                    return;
                }

                // Use the refreshed session
                session = refreshData?.session;

                // Double-check we have a valid session
                if (!session || !session.access_token) {
                    console.error('No valid session after refresh');
                    try {
                        await supabaseClient.auth.signOut({ scope: 'local' });
                    } catch (err) {
                        console.error('Signout error:', err);
                    }
                    localStorage.removeItem('supabase.auth.token');
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = session.user;
                document.getElementById('sidebarEmail').textContent = currentUser.email;
                console.log('User authenticated:', currentUser.id);

                // Load client data and plans
                await refreshAllData();

            } catch (error) {
                console.error('Error loading page:', error);
                alert('Error loading page: ' + error.message);

                // If there's an error, sign out and redirect to be safe
                try {
                    await supabaseClient.auth.signOut({ scope: 'local' });
                } catch (err) {
                    console.error('Signout error:', err);
                }
                localStorage.removeItem('supabase.auth.token');
                sessionStorage.clear();
                window.location.href = 'login.html';
            }
        });

        // Reload data when page becomes visible (e.g., when coming back from editing)
        document.addEventListener('visibilitychange', async function() {
            if (!document.hidden && currentUser && clientId) {
                console.log('Page became visible, refreshing data...');
                await refreshAllData();
            }
        });

        // Also reload when window regains focus
        window.addEventListener('focus', async function() {
            if (currentUser && clientId) {
                console.log('Window focused, refreshing data...');
                await refreshAllData();
            }
        });

        // Refresh all data function
        async function refreshAllData() {
            if (!clientId) return;

            console.log('Refreshing client data...');

            // Force a fresh fetch by adding a timestamp to bypass cache
            const timestamp = new Date().getTime();

            // Set coachUserId for workout feed API calls
            window.coachUserId = currentUser?.id || '';

            // Load all data in parallel for faster refresh
            await Promise.all([
                loadClient(clientId),
                loadPlans(clientId),
                loadProtocols(clientId),
                loadPhotos(clientId),
                loadMeasurements(clientId),
                loadCheckins(clientId),
                loadFavorites(clientId),
                loadFoodDiary(clientId),
                loadWorkoutLogs(clientId),
                loadWorkoutPrograms(clientId),
                loadClientNotes(clientId)
            ]);

            console.log('Data refreshed successfully');
        }

        async function loadClient(clientId) {
            console.log('loadClient called with:', { clientId, clientIdType: typeof clientId, currentUserId: currentUser?.id });
            try {
                // Force fresh data by using maybeSingle() and re-fetching
                const { data, error } = await supabaseClient
                    .from('clients')
                    .select('*')
                    .eq('id', clientId)
                    .eq('coach_id', currentUser.id)
                    .maybeSingle();

                console.log('Client query result:', { data, error, clientId, coachId: currentUser?.id });

                if (error) throw error;
                if (!data) {
                    console.warn('Client not found - redirecting to manage-clients. Query params:', { clientId, coachId: currentUser?.id });
                    alert('Client not found');
                    window.location.href = 'manage-clients.html';
                    return;
                }

                currentClient = data;
                currentClientName = data.name || '';
                displayClient(data);

                console.log('Client data loaded:', data);

            } catch (error) {
                console.error('Error loading client:', error);
                console.warn('loadClient error - redirecting to manage-clients:', { clientId, error: error.message });
                alert('Failed to load client');
                window.location.href = 'manage-clients.html';
            }
        }

        function displayClient(client) {
            document.getElementById('clientName').textContent = client.client_name;

            // Display client avatar
            const avatarEl = document.getElementById('clientAvatar');
            const avatarInitialEl = document.getElementById('clientAvatarInitial');
            const clientInitial = client.client_name ? client.client_name.charAt(0).toUpperCase() : '?';

            if (client.profile_photo_url) {
                avatarInitialEl.style.display = 'none';
                let avatarImg = avatarEl.querySelector('img');
                if (!avatarImg) {
                    avatarImg = document.createElement('img');
                    avatarEl.insertBefore(avatarImg, avatarEl.firstChild);
                }
                avatarImg.src = client.profile_photo_url;
                avatarImg.alt = client.client_name;
            } else {
                avatarInitialEl.textContent = clientInitial;
            }

            // Build meta information
            const metaItems = [];
            if (client.email) metaItems.push(` ${client.email}`);
            if (client.phone) metaItems.push(` ${client.phone}`);
            if (client.default_goal) {
                const goalLabels = {
                    'lose_weight': 'Lose Weight',
                    'maintain': 'Maintain',
                    'gain_muscle': 'Gain Muscle'
                };
                metaItems.push(` ${goalLabels[client.default_goal] || client.default_goal}`);
            }

            document.getElementById('clientMeta').innerHTML = metaItems
                .map(item => `<div class="client-meta-item">${item}</div>`)
                .join('');

            // Show client card and action bar
            document.getElementById('clientCard').style.display = 'block';
            document.getElementById('clientActionBar').style.display = 'flex';

            // Load reminder status
            loadReminderStatus(client.id);

            // Load goals (drawer handles visibility)
            loadClientGoals(client.id);

            // Set the can_edit_goals toggle based on client data
            document.getElementById('canEditGoalsToggle').checked = client.can_edit_goals || false;

            // Display client stats and calculate initial values
            displayClientStats();
            calculateFromStats();
        }

        // Track which percentage inputs the user has manually set
        let manuallySetPercentages = { protein: true, carbs: true, fat: false };
        let currentGoalsMode = 'calculate';
        let calculatedGoals = null;

        // Activity level multipliers
        const activityMultipliers = {
            'sedentary': 1.2,
            'light': 1.375,
            'moderate': 1.55,
            'active': 1.725,
            'very_active': 1.9
        };

        // Set goals mode (calculate, percentage, custom)
        function setGoalsMode(mode) {
            currentGoalsMode = mode;

            // Update tab styles
            document.querySelectorAll('.goals-mode-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');

            // Hide all mode sections
            document.getElementById('calculateMode').classList.remove('active');
            document.getElementById('percentageMode').classList.remove('active');
            document.getElementById('customMode').classList.remove('active');

            // Show selected mode
            if (mode === 'calculate') {
                document.getElementById('calculateMode').classList.add('active');
                displayClientStats();
                calculateFromStats();
            } else if (mode === 'percentage') {
                document.getElementById('percentageMode').classList.add('active');
            } else if (mode === 'custom') {
                document.getElementById('customMode').classList.add('active');
            }
        }

        // Display client stats for calculation
        function displayClientStats() {
            if (!currentClient) return;

            const stats = [];
            const missingStats = [];

            // Check each required stat
            if (currentClient.age) {
                stats.push({ label: 'Age', value: currentClient.age + ' yrs' });
            } else {
                missingStats.push('Age');
            }

            if (currentClient.gender) {
                stats.push({ label: 'Gender', value: currentClient.gender.charAt(0).toUpperCase() + currentClient.gender.slice(1) });
            } else {
                missingStats.push('Gender');
            }

            if (currentClient.weight) {
                // Display weight in coach's preferred unit
                if (coachDisplayUnit === 'metric') {
                    const weightKg = lbsToKg(currentClient.weight);
                    stats.push({ label: 'Weight', value: weightKg + ' kg' });
                } else {
                    stats.push({ label: 'Weight', value: currentClient.weight + ' lbs' });
                }
            } else {
                missingStats.push('Weight');
            }

            if (currentClient.height_ft || currentClient.height_in) {
                const ft = currentClient.height_ft || 0;
                const inches = currentClient.height_in || 0;
                // Display height in coach's preferred unit
                if (coachDisplayUnit === 'metric') {
                    const heightCm = ftInToCm(ft, inches);
                    stats.push({ label: 'Height', value: heightCm + ' cm' });
                } else {
                    stats.push({ label: 'Height', value: `${ft}'${inches}"` });
                }
            } else {
                missingStats.push('Height');
            }

            if (currentClient.activity_level) {
                const activityLabels = {
                    'sedentary': 'Sedentary',
                    'light': 'Light',
                    'moderate': 'Moderate',
                    'active': 'Active',
                    'very_active': 'Very Active'
                };
                stats.push({ label: 'Activity', value: activityLabels[currentClient.activity_level] || currentClient.activity_level });
            } else {
                missingStats.push('Activity');
            }

            if (currentClient.default_goal) {
                const goalLabels = {
                    'lose_weight': 'Lose Weight',
                    'maintain': 'Maintain',
                    'gain_muscle': 'Gain Muscle'
                };
                stats.push({ label: 'Goal', value: goalLabels[currentClient.default_goal] || currentClient.default_goal });
            } else {
                missingStats.push('Goal');
            }

            // Render stats grid
            const grid = document.getElementById('clientStatsGrid');
            let html = '';

            stats.forEach(stat => {
                html += `
                    <div class="client-stat-item">
                        <div class="client-stat-value">${stat.value}</div>
                        <div class="client-stat-label">${stat.label}</div>
                    </div>
                `;
            });

            if (missingStats.length > 0) {
                html += `
                    <div class="client-stat-item" style="grid-column: span 2;">
                        <div class="client-stat-missing"> Missing: ${missingStats.join(', ')}</div>
                        <div class="client-stat-label">Click "Edit Stats" to add</div>
                    </div>
                `;
            }

            grid.innerHTML = html;

            // Enable/disable calculate button
            const requiredFields = ['age', 'gender', 'weight', 'activity_level', 'default_goal'];
            const hasHeight = currentClient.height_ft || currentClient.height_in;
            const hasRequired = requiredFields.every(f => currentClient[f]) && hasHeight;
            document.getElementById('calculateBtn').disabled = !hasRequired;
        }

        // Calculate nutrition using Mifflin-St Jeor formula
        function calculateFromStats() {
            if (!currentClient) return;

            const age = parseInt(currentClient.age);
            const gender = currentClient.gender;
            const weightLbs = parseFloat(currentClient.weight);
            const heightFt = parseInt(currentClient.height_ft) || 0;
            const heightIn = parseInt(currentClient.height_in) || 0;
            const activityLevel = currentClient.activity_level;
            const goal = currentClient.default_goal;

            // Validate required fields
            if (!age || !gender || !weightLbs || !activityLevel || !goal || (!heightFt && !heightIn)) {
                document.getElementById('calcCalories').textContent = '--';
                document.getElementById('calcProtein').textContent = '--';
                document.getElementById('calcCarbs').textContent = '--';
                document.getElementById('calcFat').textContent = '--';
                document.getElementById('applyCalcBtn').disabled = true;
                return;
            }

            // Convert to metric
            const weightKg = weightLbs * 0.453592;
            const totalInches = (heightFt * 12) + heightIn;
            const heightCm = totalInches * 2.54;

            // Mifflin-St Jeor BMR
            let bmr;
            if (gender === 'male') {
                bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
            } else {
                bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
            }

            // Apply activity multiplier
            const multiplier = activityMultipliers[activityLevel] || 1.55;
            let tdee = bmr * multiplier;

            // Apply goal adjustment
            if (goal === 'lose_weight') {
                tdee -= 500;
            } else if (goal === 'gain_muscle') {
                tdee += 300;
            }

            const calories = Math.round(tdee);

            // Calculate macros (30/40/30 split)
            const protein = Math.round((calories * 0.30) / 4);
            const carbs = Math.round((calories * 0.40) / 4);
            const fat = Math.round((calories * 0.30) / 9);

            // Store calculated values
            calculatedGoals = { calories, protein, carbs, fat };

            // Update display
            document.getElementById('calcCalories').textContent = calories;
            document.getElementById('calcProtein').textContent = protein;
            document.getElementById('calcCarbs').textContent = carbs;
            document.getElementById('calcFat').textContent = fat;

            // Enable apply button
            document.getElementById('applyCalcBtn').disabled = false;
        }

        // Apply calculated goals to the actual goal inputs
        function applyCalculatedGoals() {
            if (!calculatedGoals) return;

            // Update all inputs
            document.getElementById('goalCalories').value = calculatedGoals.calories;
            document.getElementById('goalCaloriesCustom').value = calculatedGoals.calories;
            document.getElementById('goalProtein').value = calculatedGoals.protein;
            document.getElementById('goalCarbs').value = calculatedGoals.carbs;
            document.getElementById('goalFat').value = calculatedGoals.fat;

            // Update percentage mode
            calculatePercentagesFromGrams();

            // Save immediately
            saveClientGoals();
        }

        // Calculate grams from percentages
        function calculateMacrosFromPercentage() {
            const calories = parseInt(document.getElementById('goalCalories').value) || 2000;
            const proteinPct = parseInt(document.getElementById('proteinPercent').value) || 0;
            const carbsPct = parseInt(document.getElementById('carbsPercent').value) || 0;
            const fatPct = parseInt(document.getElementById('fatPercent').value) || 0;

            // Calculate calories for each macro
            const proteinCals = Math.round(calories * (proteinPct / 100));
            const carbsCals = Math.round(calories * (carbsPct / 100));
            const fatCals = Math.round(calories * (fatPct / 100));

            // Calculate grams (protein/carbs = 4 cal/g, fat = 9 cal/g)
            const proteinGrams = Math.round(proteinCals / 4);
            const carbsGrams = Math.round(carbsCals / 4);
            const fatGrams = Math.round(fatCals / 9);

            // Update display
            document.getElementById('proteinGramsDisplay').textContent = proteinGrams + 'g';
            document.getElementById('proteinCalsDisplay').textContent = proteinCals;
            document.getElementById('carbsGramsDisplay').textContent = carbsGrams + 'g';
            document.getElementById('carbsCalsDisplay').textContent = carbsCals;
            document.getElementById('fatGramsDisplay').textContent = fatGrams + 'g';
            document.getElementById('fatCalsDisplay').textContent = fatCals;

            // Update custom mode inputs
            document.getElementById('goalProtein').value = proteinGrams;
            document.getElementById('goalCarbs').value = carbsGrams;
            document.getElementById('goalFat').value = fatGrams;

            // Update percentage total bar
            updatePercentageTotal();
        }

        // Handle percentage input and auto-fill the 3rd macro
        function handlePercentageInput(changedMacro) {
            manuallySetPercentages[changedMacro] = true;

            const proteinPct = parseInt(document.getElementById('proteinPercent').value) || 0;
            const carbsPct = parseInt(document.getElementById('carbsPercent').value) || 0;
            const fatPct = parseInt(document.getElementById('fatPercent').value) || 0;

            // Count how many are manually set
            const manualCount = Object.values(manuallySetPercentages).filter(v => v).length;

            // If 2 are set, auto-calculate the 3rd
            if (manualCount >= 2) {
                const total = proteinPct + carbsPct + fatPct;

                // Find which one to auto-fill (the one not manually set, or the last one changed)
                if (!manuallySetPercentages.protein && changedMacro !== 'protein') {
                    document.getElementById('proteinPercent').value = Math.max(0, 100 - carbsPct - fatPct);
                } else if (!manuallySetPercentages.carbs && changedMacro !== 'carbs') {
                    document.getElementById('carbsPercent').value = Math.max(0, 100 - proteinPct - fatPct);
                } else if (!manuallySetPercentages.fat && changedMacro !== 'fat') {
                    document.getElementById('fatPercent').value = Math.max(0, 100 - proteinPct - carbsPct);
                } else {
                    // All three are manually set, auto-adjust the one NOT just changed
                    const remaining = 100 - parseInt(document.getElementById(changedMacro + 'Percent').value);
                    const others = ['protein', 'carbs', 'fat'].filter(m => m !== changedMacro);
                    const other1Val = parseInt(document.getElementById(others[0] + 'Percent').value) || 0;
                    const other2Val = parseInt(document.getElementById(others[1] + 'Percent').value) || 0;

                    // Proportionally adjust the others
                    const otherTotal = other1Val + other2Val;
                    if (otherTotal > 0 && remaining >= 0) {
                        document.getElementById(others[0] + 'Percent').value = Math.round((other1Val / otherTotal) * remaining);
                        document.getElementById(others[1] + 'Percent').value = remaining - Math.round((other1Val / otherTotal) * remaining);
                    }
                }
            }

            calculateMacrosFromPercentage();
        }

        // Calculate percentages from gram values (used when loading existing goals)
        function calculatePercentagesFromGrams() {
            const calories = parseInt(document.getElementById('goalCalories').value) || 2000;
            const proteinGrams = parseInt(document.getElementById('goalProtein').value) || 150;
            const carbsGrams = parseInt(document.getElementById('goalCarbs').value) || 200;
            const fatGrams = parseInt(document.getElementById('goalFat').value) || 65;

            // Calculate calories from grams
            const proteinCals = proteinGrams * 4;
            const carbsCals = carbsGrams * 4;
            const fatCals = fatGrams * 9;

            // Calculate percentages
            const proteinPct = Math.round((proteinCals / calories) * 100);
            const carbsPct = Math.round((carbsCals / calories) * 100);
            const fatPct = Math.round((fatCals / calories) * 100);

            // Update percentage inputs
            document.getElementById('proteinPercent').value = proteinPct;
            document.getElementById('carbsPercent').value = carbsPct;
            document.getElementById('fatPercent').value = fatPct;

            // Update displays
            document.getElementById('proteinGramsDisplay').textContent = proteinGrams + 'g';
            document.getElementById('proteinCalsDisplay').textContent = proteinCals;
            document.getElementById('carbsGramsDisplay').textContent = carbsGrams + 'g';
            document.getElementById('carbsCalsDisplay').textContent = carbsCals;
            document.getElementById('fatGramsDisplay').textContent = fatGrams + 'g';
            document.getElementById('fatCalsDisplay').textContent = fatCals;

            updatePercentageTotal();
        }

        // Update the percentage total bar
        function updatePercentageTotal() {
            const proteinPct = parseInt(document.getElementById('proteinPercent').value) || 0;
            const carbsPct = parseInt(document.getElementById('carbsPercent').value) || 0;
            const fatPct = parseInt(document.getElementById('fatPercent').value) || 0;
            const total = proteinPct + carbsPct + fatPct;

            const textEl = document.getElementById('percentageTotalText');
            const fillEl = document.getElementById('percentageProgressFill');

            textEl.textContent = `Total: ${total}%`;
            fillEl.style.width = Math.min(total, 100) + '%';

            if (total === 100) {
                textEl.className = 'percentage-total-text valid';
                fillEl.className = 'percentage-progress-fill valid';
            } else if (total > 100) {
                textEl.className = 'percentage-total-text invalid';
                fillEl.className = 'percentage-progress-fill over';
            } else {
                textEl.className = 'percentage-total-text';
                fillEl.className = 'percentage-progress-fill';
            }
        }

        // Load client's calorie/macro goals
        async function loadClientGoals(clientId) {
            try {
                const response = await fetch(`/.netlify/functions/calorie-goals?clientId=${clientId}`);
                const data = await response.json();

                if (data.goals) {
                    const calories = data.goals.calorie_goal || 2000;
                    const protein = data.goals.protein_goal || 150;
                    const carbs = data.goals.carbs_goal || 200;
                    const fat = data.goals.fat_goal || 65;

                    // Set values in both modes
                    document.getElementById('goalCalories').value = calories;
                    document.getElementById('goalCaloriesCustom').value = calories;
                    document.getElementById('goalProtein').value = protein;
                    document.getElementById('goalCarbs').value = carbs;
                    document.getElementById('goalFat').value = fat;

                    // Calculate and display percentages
                    calculatePercentagesFromGrams();
                }
            } catch (err) {
                console.error('Error loading client goals:', err);
            }
        }

        // Save client's calorie/macro goals
        async function saveClientGoals() {
            const btn = document.getElementById('saveGoalsBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                // Get values based on current mode
                let calories, protein, carbs, fat;

                if (currentGoalsMode === 'custom') {
                    calories = parseInt(document.getElementById('goalCaloriesCustom').value) || 2000;
                    protein = parseInt(document.getElementById('goalProtein').value) || 150;
                    carbs = parseInt(document.getElementById('goalCarbs').value) || 200;
                    fat = parseInt(document.getElementById('goalFat').value) || 65;
                } else {
                    // For both calculate and percentage modes, use the percentage mode values
                    // (which are synced from calculate mode when Apply is clicked)
                    calories = parseInt(document.getElementById('goalCalories').value) || 2000;
                    protein = parseInt(document.getElementById('goalProtein').value) || 150;
                    carbs = parseInt(document.getElementById('goalCarbs').value) || 200;
                    fat = parseInt(document.getElementById('goalFat').value) || 65;
                }

                const response = await fetch('/.netlify/functions/calorie-goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientId: clientId,
                        coachId: currentUser.id,
                        calorieGoal: calories,
                        proteinGoal: protein,
                        carbsGoal: carbs,
                        fatGoal: fat
                    })
                });

                if (!response.ok) throw new Error('Failed to save goals');

                btn.textContent = 'Saved!';
                setTimeout(() => {
                    btn.textContent = 'Save Goals';
                    btn.disabled = false;
                }, 1500);

            } catch (err) {
                console.error('Error saving goals:', err);
                alert('Failed to save goals');
                btn.textContent = 'Save Goals';
                btn.disabled = false;
            }
        }

        // Toggle whether client can edit their own goals
        async function toggleClientGoalPermission() {
            const canEdit = document.getElementById('canEditGoalsToggle').checked;

            try {
                const { error } = await supabaseClient
                    .from('clients')
                    .update({ can_edit_goals: canEdit })
                    .eq('id', clientId)
                    .eq('coach_id', currentUser.id);

                if (error) throw error;

                // Update local client object
                if (currentClient) {
                    currentClient.can_edit_goals = canEdit;
                }

                console.log('Client goal permission updated:', canEdit);
            } catch (err) {
                console.error('Error updating goal permission:', err);
                // Revert toggle on error
                document.getElementById('canEditGoalsToggle').checked = !canEdit;
                alert('Failed to update permission');
            }
        }

        async function loadPlans(clientId) {
            try {
                // Add cache-busting timestamp to ensure fresh data
                const timestamp = new Date().getTime();
                const response = await fetch(`${GET_CLIENT_PLANS_ENDPOINT}?clientId=${clientId}&coachId=${currentUser.id}&_t=${timestamp}`, {
                    cache: 'no-store' // Disable browser caching
                });

                if (!response.ok) throw new Error('Failed to load plans');

                const data = await response.json();
                clientPlans = data.plans;

                // Update stats
                displayStats();

                // Display plans
                displayPlans();

                console.log('Plans loaded:', clientPlans.length);

            } catch (error) {
                console.error('Error loading plans:', error);
                document.getElementById('plansContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading plans</h3>
                        <p>Please try again</p>
                    </div>
                `;
            }
        }

        function displayStats() {
            const statsContainer = document.getElementById('clientStats');
            const totalPlans = clientPlans.length;

            // Calculate last plan date
            let lastPlanText = 'Never';
            if (totalPlans > 0) {
                const lastPlan = new Date(clientPlans[0].created_at);
                const now = new Date();
                const daysAgo = Math.floor((now - lastPlan) / (1000 * 60 * 60 * 24));

                if (daysAgo === 0) lastPlanText = 'Today';
                else if (daysAgo === 1) lastPlanText = 'Yesterday';
                else if (daysAgo < 7) lastPlanText = `${daysAgo} days ago`;
                else if (daysAgo < 30) lastPlanText = `${Math.floor(daysAgo / 7)} weeks ago`;
                else lastPlanText = `${Math.floor(daysAgo / 30)} months ago`;
            }

            statsContainer.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${totalPlans}</div>
                    <div class="stat-label">Total Plans</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${lastPlanText}</div>
                    <div class="stat-label">Last Plan</div>
                </div>
            `;
        }

        function displayPlans() {
            const container = document.getElementById('plansContainer');
            const bulkActionsBar = document.getElementById('bulkActionsBar');

            // Reset selections when refreshing plans
            selectedPlans.clear();
            updateSelectionUI();

            if (clientPlans.length === 0) {
                bulkActionsBar.style.display = 'none';
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No meal plans yet</h3>
                        <p>Generate the first plan for ${currentClient.client_name}</p>
                        <button class="btn btn-primary" onclick="generateNewPlan()"> Generate Plan</button>
                    </div>
                `;
                return;
            }

            // Show bulk actions bar when there are plans
            bulkActionsBar.style.display = 'flex';

            const plansHTML = clientPlans.map(plan => createPlanCard(plan)).join('');
            container.innerHTML = `<div class="plans-grid">${plansHTML}</div>`;
        }

        function createPlanCard(plan) {
            const createdDate = new Date(plan.created_at);
            const formattedDate = createdDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            const formattedTime = createdDate.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            // Extract plan details from plan_data
            const planData = plan.plan_data || {};
            let planDetails = [];

            // Get number of days
            let numDays = 1;
            let daysArray = [];
            if (planData.currentPlan && Array.isArray(planData.currentPlan)) {
                numDays = planData.currentPlan.length;
                daysArray = planData.currentPlan;
            } else if (planData.days && Array.isArray(planData.days)) {
                numDays = planData.days.length;
                daysArray = planData.days;
            }
            planDetails.push(`${numDays}-Day`);

            // Calculate actual calories from meals (average per day)
            let actualCalories = 0;
            if (daysArray.length > 0) {
                let totalCalories = 0;
                daysArray.forEach(day => {
                    if (day.plan && Array.isArray(day.plan)) {
                        day.plan.forEach(meal => {
                            totalCalories += meal.calories || 0;
                        });
                    }
                });
                // Show average daily calories
                actualCalories = Math.round(totalCalories / daysArray.length);
            }

            if (actualCalories > 0) {
                planDetails.push(`${actualCalories} cal`);
            } else if (planData.calories) {
                // Fallback to target if no meals found
                planDetails.push(`${planData.calories} cal`);
            }

            const planSummary = planDetails.join('  ');

            // Extract additional info for the summary line
            let summaryItems = [];

            // Get diet type
            if (planData.preference) {
                const dietLabels = {
                    'omnivore': 'Omnivore',
                    'vegetarian': 'Vegetarian',
                    'vegan': 'Vegan',
                    'keto': 'Keto',
                    'paleo': 'Paleo'
                };
                summaryItems.push(dietLabels[planData.preference.toLowerCase()] || planData.preference);
            } else if (planData.preferences && planData.preferences.dietType) {
                summaryItems.push(planData.preferences.dietType);
            }

            // Get goal
            if (planData.goal) {
                const goalLabels = {
                    'lose weight': 'Lose Weight',
                    'lose_weight': 'Lose Weight',
                    'maintain weight': 'Maintain',
                    'maintain': 'Maintain',
                    'gain muscle': 'Gain Muscle',
                    'gain_muscle': 'Gain Muscle'
                };
                summaryItems.push(goalLabels[planData.goal.toLowerCase()] || planData.goal);
            }

            // Get meal count
            let mealCount = 0;
            let firstMealName = '';
            if (planData.currentPlan && planData.currentPlan[0] && planData.currentPlan[0].plan) {
                mealCount = planData.currentPlan[0].plan.length;
                firstMealName = planData.currentPlan[0].plan[0]?.name || '';
            } else if (planData.days && planData.days[0] && planData.days[0].plan) {
                mealCount = planData.days[0].plan.length;
                firstMealName = planData.days[0].plan[0]?.name || '';
            } else if (planData.meals && Array.isArray(planData.meals)) {
                mealCount = planData.meals.length;
                firstMealName = planData.meals[0]?.name || '';
            }

            if (mealCount > 0) {
                summaryItems.push(`${mealCount} meals`);
            }

            // Build summary description
            const summaryDescription = summaryItems.length > 0 ? summaryItems.join('  ') : '';

            // Truncate first meal name if too long
            if (firstMealName && firstMealName.length > 35) {
                firstMealName = firstMealName.substring(0, 35) + '...';
            }

            // Get plan status (default to 'draft' for backwards compatibility)
            const planStatus = plan.status || 'draft';
            const isDraft = planStatus === 'draft';
            const statusBadge = isDraft
                ? '<span class="plan-status-badge draft">Draft</span>'
                : '<span class="plan-status-badge published">Published</span>';

            // Publish button only shows for draft plans
            const publishButton = isDraft
                ? `<button class="publish-btn" onclick="publishPlan(${plan.id}, event)"> Submit to Client</button>`
                : '';

            // Coach notes preview (truncate if too long)
            let coachNotesPreview = '';
            if (plan.coach_notes) {
                const truncatedNotes = plan.coach_notes.length > 100
                    ? plan.coach_notes.substring(0, 100) + '...'
                    : plan.coach_notes;
                coachNotesPreview = `
                    <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 10px 12px; border-radius: 8px; margin-top: 8px; border: 1px solid #7dd3fc;">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                            <span style="font-size: 12px;"></span>
                            <span style="font-size: 11px; font-weight: 600; color: #0369a1;">Coach Notes</span>
                        </div>
                        <div style="font-size: 12px; color: #334155; line-height: 1.4;">${truncatedNotes.replace(/\n/g, ' ')}</div>
                    </div>
                `;
            }

            // Use plan_name if available (check both top-level column and inside plan_data), otherwise use planSummary
            const displayName = plan.plan_name || planData.planName || planSummary;

            return `
                <div class="plan-card" id="plan-card-${plan.id}" onclick="viewPlan(${plan.id})">
                    <input type="checkbox" class="plan-card-checkbox"
                           id="checkbox-${plan.id}"
                           onclick="togglePlanSelection(${plan.id}, event)"
                           ${selectedPlans.has(plan.id) ? 'checked' : ''}>
                    <div class="plan-card-header">
                        <div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-weight: 600; color: #0d9488;">${displayName}</span>
                                ${statusBadge}
                            </div>
                            ${(plan.plan_name || planData.planName) ? `<div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">${planSummary}</div>` : ''}
                            ${summaryDescription ? `<div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">${summaryDescription}</div>` : ''}
                            ${firstMealName ? `<div style="font-size: 11px; color: #94a3b8; font-style: italic;"> ${firstMealName}</div>` : ''}
                            <div class="plan-date">${formattedDate} at ${formattedTime}</div>
                            ${coachNotesPreview}
                        </div>
                        <div class="plan-actions">
                            <button class="icon-btn" onclick="deletePlan(${plan.id}, event)" title="Delete plan"></button>
                        </div>
                    </div>
                    <button class="view-btn" onclick="viewPlan(${plan.id})">View Plan</button>
                    ${publishButton}
                </div>
            `;
        }

        function viewPlan(planId) {
            window.location.href = `view-plan.html?planId=${planId}&fromClient=${currentClient.id}`;
        }

        async function deletePlan(planId, event) {
            event.stopPropagation();

            if (!confirm('Are you sure you want to delete this meal plan? This action cannot be undone.')) {
                return;
            }

            try {
                // Get fresh session for authorization
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session?.access_token) {
                    alert('Session expired. Please refresh the page and try again.');
                    return;
                }

                const response = await fetch(`${DELETE_PLAN_ENDPOINT}?planId=${planId}&coachId=${currentUser.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to delete plan');

                console.log('Plan deleted successfully');

                // Reload plans
                await loadPlans(currentClient.id);

            } catch (error) {
                console.error('Error deleting plan:', error);
                alert('Failed to delete plan. Please try again.');
            }
        }

        async function publishPlan(planId, event) {
            event.stopPropagation();

            if (!confirm('Submit this meal plan to the client? They will be able to see it in their dashboard.')) {
                return;
            }

            try {
                const response = await fetch(PUBLISH_PLAN_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        planId: planId,
                        coachId: currentUser.id
                    })
                });

                if (!response.ok) throw new Error('Failed to publish plan');

                console.log('Plan published successfully');
                alert('Meal plan submitted to client successfully!');

                // Reload plans to reflect the status change
                await loadPlans(currentClient.id);

            } catch (error) {
                console.error('Error publishing plan:', error);
                alert('Failed to publish plan. Please try again.');
            }
        }

        function generateNewPlan() {
            // Redirect to planner with client pre-selected
            window.location.href = `planner.html?clientId=${currentClient.id}`;
        }

        function editClient() {
            // Redirect back to manage clients page
            // The manage-clients page will need to handle opening the edit modal
            window.location.href = `manage-clients.html?editClient=${currentClient.id}`;
        }

        async function sendPasswordReset() {
            if (!currentClient) {
                alert('No client loaded');
                return;
            }

            if (!currentClient.email) {
                alert('This client does not have an email address on file. Please add an email first.');
                return;
            }

            if (!currentClient.user_id) {
                alert('This client has not been invited to the portal yet. Send them an invitation first before resetting their password.');
                return;
            }

            const confirmed = confirm(`Send a password reset email to ${currentClient.client_name} at ${currentClient.email}?`);
            if (!confirmed) return;

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session?.access_token) {
                    alert('Session expired. Please refresh the page.');
                    return;
                }

                const response = await fetch('/.netlify/functions/send-client-password-reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        clientId: currentClient.id,
                        coachId: currentUser.id
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || data.error || 'Failed to send password reset');
                }

                alert(` Password reset email sent to ${data.email}!\n\nThe client will receive an email with a link to reset their password.`);

            } catch (error) {
                console.error('Error sending password reset:', error);
                alert('Failed to send password reset email: ' + error.message);
            }
        }

        // ========== BULK SELECTION FUNCTIONS ==========

        function togglePlanSelection(planId, event) {
            event.stopPropagation();

            if (selectedPlans.has(planId)) {
                selectedPlans.delete(planId);
            } else {
                selectedPlans.add(planId);
            }

            updateSelectionUI();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');

            if (selectAllCheckbox.checked) {
                // Select all plans
                clientPlans.forEach(plan => {
                    selectedPlans.add(plan.id);
                });
            } else {
                // Deselect all
                selectedPlans.clear();
            }

            // Update all checkboxes
            clientPlans.forEach(plan => {
                const checkbox = document.getElementById(`checkbox-${plan.id}`);
                const card = document.getElementById(`plan-card-${plan.id}`);
                if (checkbox) {
                    checkbox.checked = selectedPlans.has(plan.id);
                }
                if (card) {
                    if (selectedPlans.has(plan.id)) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                }
            });

            updateSelectionUI();
        }

        function updateSelectionUI() {
            const selectedCount = document.getElementById('selectedCount');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');

            const count = selectedPlans.size;
            selectedCount.textContent = `${count} selected`;

            // Show/hide delete button
            if (count > 0) {
                deleteBtn.classList.add('visible');
            } else {
                deleteBtn.classList.remove('visible');
            }

            // Update select all checkbox state
            if (selectAllCheckbox) {
                if (count === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (count === clientPlans.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }

            // Update card visual states
            clientPlans.forEach(plan => {
                const card = document.getElementById(`plan-card-${plan.id}`);
                const checkbox = document.getElementById(`checkbox-${plan.id}`);
                if (card) {
                    if (selectedPlans.has(plan.id)) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                }
                if (checkbox) {
                    checkbox.checked = selectedPlans.has(plan.id);
                }
            });
        }

        async function deleteSelectedPlans() {
            const count = selectedPlans.size;
            if (count === 0) return;

            const confirmMsg = count === 1
                ? 'Are you sure you want to delete this meal plan? This action cannot be undone.'
                : `Are you sure you want to delete ${count} meal plans? This action cannot be undone.`;

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                // Get session for authentication
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    alert('Session expired. Please log in again.');
                    window.location.href = 'login.html';
                    return;
                }

                // Show loading state on delete button
                const deleteBtn = document.getElementById('deleteSelectedBtn');
                const originalText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = ' Deleting...';
                deleteBtn.disabled = true;

                // Delete all selected plans
                const deletePromises = Array.from(selectedPlans).map(planId =>
                    fetch(`${DELETE_PLAN_ENDPOINT}?planId=${planId}&coachId=${currentUser.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${session.access_token}`
                        }
                    })
                );

                const results = await Promise.all(deletePromises);

                // Check for any failures
                const failures = results.filter(r => !r.ok);
                if (failures.length > 0) {
                    console.error(`${failures.length} plan(s) failed to delete`);
                }

                console.log(`${count - failures.length} plan(s) deleted successfully`);

                // Reset button state
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;

                // Clear selections and reload plans
                selectedPlans.clear();
                await loadPlans(currentClient.id);

                if (failures.length > 0) {
                    alert(`${count - failures.length} plan(s) deleted. ${failures.length} failed to delete.`);
                }

            } catch (error) {
                console.error('Error deleting plans:', error);
                alert('Failed to delete some plans. Please try again.');

                // Reset button state
                const deleteBtn = document.getElementById('deleteSelectedBtn');
                deleteBtn.innerHTML = ' Delete Selected';
                deleteBtn.disabled = false;
            }
        }

        // ========== PROGRESS PHOTOS FUNCTIONS ==========

        async function loadPhotos(clientId) {
            try {
                const response = await fetch(`${GET_PHOTOS_ENDPOINT}?clientId=${clientId}&coachId=${currentUser.id}`);

                if (!response.ok) throw new Error('Failed to load photos');

                const data = await response.json();
                clientPhotos = data.photos || [];
                displayPhotos();

            } catch (error) {
                console.error('Error loading photos:', error);
                document.getElementById('photosContainer').innerHTML = `
                    <div class="empty-state">
                        <p>Unable to load photos</p>
                    </div>
                `;
            }
        }

        function displayPhotos() {
            const container = document.getElementById('photosContainer');

            if (clientPhotos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No progress photos yet</p>
                        <p style="color: #999; font-size: 14px; margin-top: 8px;">Click "Add Photo" to upload the first one</p>
                    </div>
                `;
                return;
            }

            const photoTypeLabels = {
                'front': 'Front',
                'side': 'Side',
                'back': 'Back',
                'progress': 'Progress'
            };

            container.innerHTML = `
                <div class="photo-carousel-wrapper">
                    <button class="carousel-nav prev" onclick="scrollCarousel(-1)"></button>
                    <div class="photo-carousel" id="photoCarousel">
                        ${clientPhotos.map(photo => `
                            <div class="photo-card" onclick="openLightbox('${photo.photo_url}')">
                                <img src="${photo.photo_url}" alt="Progress photo" loading="lazy">
                                <div class="photo-overlay">
                                    <div class="photo-type">${photoTypeLabels[photo.photo_type] || photo.photo_type}</div>
                                    <div class="photo-date">${new Date(photo.taken_date).toLocaleDateString()}</div>
                                    ${photo.notes ? `<div class="photo-notes-text">${photo.notes}</div>` : ''}
                                </div>
                                <button class="photo-delete" onclick="event.stopPropagation(); deletePhoto(${photo.id})" title="Delete"></button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="carousel-nav next" onclick="scrollCarousel(1)"></button>
                </div>
            `;
        }

        function scrollCarousel(direction) {
            const carousel = document.getElementById('photoCarousel');
            const scrollAmount = 200;
            carousel.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
        }

        function openUploadModal() {
            const modal = document.getElementById('photoUploadModal');
            modal.style.display = 'flex';

            // Set default date to today
            document.getElementById('photoDate').value = new Date().toISOString().split('T')[0];

            // Reset form
            document.getElementById('photoType').value = 'progress';
            document.getElementById('photoNotes').value = '';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('uploadArea').style.display = 'flex';
            document.getElementById('uploadBtn').disabled = true;
            selectedPhotoFile = null;

            // Setup drag and drop
            setupDragAndDrop();
        }

        function closeUploadModal() {
            document.getElementById('photoUploadModal').style.display = 'none';
            selectedPhotoFile = null;
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#0d9488';
                uploadArea.style.background = '#f0fdfa';
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.background = '#fafafa';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.background = '#fafafa';

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    processFile(files[0]);
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }

            selectedPhotoFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('photoPreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('uploadBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        async function uploadPhoto() {
            if (!selectedPhotoFile || !currentClient) return;

            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.textContent;
            uploadBtn.textContent = 'Uploading...';
            uploadBtn.disabled = true;

            try {
                // Convert file to base64
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(selectedPhotoFile);
                });

                const response = await fetch(UPLOAD_PHOTO_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clientId: currentClient.id,
                        coachId: currentUser.id,
                        photoData: base64Data,
                        photoType: document.getElementById('photoType').value,
                        notes: document.getElementById('photoNotes').value || null,
                        takenDate: document.getElementById('photoDate').value
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Upload failed');
                }

                console.log('Photo uploaded successfully');
                closeUploadModal();
                await loadPhotos(currentClient.id);

            } catch (error) {
                console.error('Error uploading photo:', error);
                alert('Failed to upload photo: ' + error.message);
                uploadBtn.textContent = originalText;
                uploadBtn.disabled = false;
            }
        }

        async function deletePhoto(photoId) {
            if (!confirm('Are you sure you want to delete this photo?')) {
                return;
            }

            try {
                const response = await fetch(`${DELETE_PHOTO_ENDPOINT}?photoId=${photoId}&coachId=${currentUser.id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete photo');
                }

                console.log('Photo deleted successfully');
                await loadPhotos(currentClient.id);

            } catch (error) {
                console.error('Error deleting photo:', error);
                alert('Failed to delete photo. Please try again.');
            }
        }

        function openLightbox(imageUrl) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightboxImage');
            lightboxImg.src = imageUrl;
            lightbox.style.display = 'flex';
        }

        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
        }

        // Close lightbox with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLightbox();
                closeUploadModal();
                closeMeasurementModal();
            }
        });

        // ========== MEASUREMENTS FUNCTIONS ==========

        async function loadMeasurements(clientId) {
            try {
                const response = await fetch(`${GET_MEASUREMENTS_ENDPOINT}?clientId=${clientId}`);

                if (!response.ok) throw new Error('Failed to load measurements');

                const data = await response.json();
                clientMeasurements = data.measurements || [];
                displayMeasurements(data.stats);

            } catch (error) {
                console.error('Error loading measurements:', error);
                document.getElementById('measurementsContainer').innerHTML = `
                    <div class="empty-state">
                        <p>Unable to load measurements</p>
                    </div>
                `;
            }
        }

        function displayMeasurements(stats) {
            const container = document.getElementById('measurementsContainer');

            if (clientMeasurements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No measurements logged yet</p>
                        <p style="color: #999; font-size: 14px; margin-top: 8px;">Click "Log Measurement" to track progress</p>
                    </div>
                `;
                return;
            }

            // Find most recent measurements with actual data
            const latestWithWeight = clientMeasurements.find(m => m.weight);
            const latestWithWaist = clientMeasurements.find(m => m.waist);
            const latestWithBodyFat = clientMeasurements.find(m => m.body_fat_percentage);
            const latestWithChest = clientMeasurements.find(m => m.chest);
            const latestWithArms = clientMeasurements.find(m => m.left_arm || m.right_arm);
            const latestWithHips = clientMeasurements.find(m => m.hips);

            // Calculate changes
            const weightChange = stats?.weightChange;
            const waistChange = stats?.waistChange;

            container.innerHTML = `
                <div class="measurements-grid">
                    ${latestWithWeight ? `
                        <div class="measurement-card">
                            <div class="measurement-value">${latestWithWeight.weight}</div>
                            <div class="measurement-label">${latestWithWeight.weight_unit || 'lbs'}</div>
                            ${weightChange !== null ? `
                                <div class="measurement-change ${weightChange > 0 ? 'positive' : 'negative'}">
                                    ${weightChange > 0 ? '+' : ''}${weightChange} ${latestWithWeight.weight_unit || 'lbs'}
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="measurement-card">
                            <div class="measurement-value">-</div>
                            <div class="measurement-label">Weight</div>
                        </div>
                    `}
                    ${latestWithBodyFat ? `
                        <div class="measurement-card">
                            <div class="measurement-value">${latestWithBodyFat.body_fat_percentage}%</div>
                            <div class="measurement-label">Body Fat</div>
                        </div>
                    ` : ''}
                    ${latestWithWaist ? `
                        <div class="measurement-card">
                            <div class="measurement-value">${latestWithWaist.waist}"</div>
                            <div class="measurement-label">Waist</div>
                            ${waistChange !== null ? `
                                <div class="measurement-change ${waistChange > 0 ? 'positive' : 'negative'}">
                                    ${waistChange > 0 ? '+' : ''}${waistChange}"
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    ${latestWithChest ? `
                        <div class="measurement-card">
                            <div class="measurement-value">${latestWithChest.chest}"</div>
                            <div class="measurement-label">Chest</div>
                        </div>
                    ` : ''}
                    ${latestWithArms ? `
                        <div class="measurement-card">
                            <div class="measurement-value">${latestWithArms.left_arm || latestWithArms.right_arm}"</div>
                            <div class="measurement-label">Arms</div>
                        </div>
                    ` : ''}
                    ${latestWithHips ? `
                        <div class="measurement-card">
                            <div class="measurement-value">${latestWithHips.hips}"</div>
                            <div class="measurement-label">Hips</div>
                        </div>
                    ` : ''}
                </div>

                <div class="charts-section">
                    <div class="chart-tabs">
                        <button class="chart-tab active" data-chart="weight">Weight</button>
                        <button class="chart-tab" data-chart="waist">Waist</button>
                        <button class="chart-tab" data-chart="arms">Arms</button>
                        <button class="chart-tab" data-chart="chest">Chest</button>
                        <button class="chart-tab" data-chart="hips">Hips</button>
                        <button class="chart-tab" data-chart="thighs">Thighs</button>
                        <button class="chart-tab" data-chart="bodyfat">Body Fat</button>
                    </div>
                    <div class="chart-container" id="chart-weight">
                        <h4>Weight Progress</h4>
                        <canvas id="weightChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container" id="chart-waist" style="display:none;">
                        <h4>Waist Progress</h4>
                        <canvas id="waistChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container" id="chart-arms" style="display:none;">
                        <h4>Arms Progress</h4>
                        <canvas id="armsChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container" id="chart-chest" style="display:none;">
                        <h4>Chest Progress</h4>
                        <canvas id="chestChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container" id="chart-hips" style="display:none;">
                        <h4>Hips Progress</h4>
                        <canvas id="hipsChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container" id="chart-thighs" style="display:none;">
                        <h4>Thighs Progress</h4>
                        <canvas id="thighsChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container" id="chart-bodyfat" style="display:none;">
                        <h4>Body Fat % Progress</h4>
                        <canvas id="bodyfatChart" class="chart-canvas"></canvas>
                    </div>
                </div>

                <div class="measurements-history">
                    <h4 class="history-title" style="margin-bottom: 12px;">History</h4>
                    ${clientMeasurements.slice(0, 5).map(m => {
                        let valuesHTML = '';
                        if (m.weight) valuesHTML += `<span class="history-value"> ${m.weight} ${m.weight_unit || 'lbs'}</span>`;
                        if (m.waist) valuesHTML += `<span class="history-value"> ${m.waist}"</span>`;
                        if (m.body_fat_percentage) valuesHTML += `<span class="history-value"> ${m.body_fat_percentage}%</span>`;
                        if (m.chest) valuesHTML += `<span class="history-value"> ${m.chest}"</span>`;
                        if (m.left_arm || m.right_arm) valuesHTML += `<span class="history-value"> ${m.left_arm || m.right_arm}"</span>`;
                        if (m.hips) valuesHTML += `<span class="history-value"> ${m.hips}"</span>`;

                        // If no data recorded, show placeholder
                        if (!valuesHTML) {
                            valuesHTML = '<span class="history-value" style="color: #94a3b8; font-style: italic;">No data recorded</span>';
                        }

                        return `
                            <div class="history-entry">
                                <span class="history-date">${new Date(m.measured_date).toLocaleDateString()}</span>
                                <div class="history-values">${valuesHTML}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            // Setup chart tabs
            setupChartTabs();

            // Render all charts
            renderAllCharts();
        }

        function setupChartTabs() {
            const tabs = document.querySelectorAll('.chart-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.charts-section .chart-container').forEach(c => c.style.display = 'none');

                    tab.classList.add('active');
                    const chartType = tab.dataset.chart;
                    const chartContainer = document.getElementById(`chart-${chartType}`);
                    if (chartContainer) {
                        chartContainer.style.display = 'block';
                    }
                });
            });
        }

        function renderAllCharts() {
            renderMeasurementChart('weightChart', 'weight', 'weight_unit', 'lbs', '#0d9488');
            renderMeasurementChart('waistChart', 'waist', null, '"', '#0284c7');
            renderMeasurementChart('armsChart', ['left_arm', 'right_arm'], null, '"', '#7c3aed');
            renderMeasurementChart('chestChart', 'chest', null, '"', '#dc2626');
            renderMeasurementChart('hipsChart', 'hips', null, '"', '#ea580c');
            renderMeasurementChart('thighsChart', ['left_thigh', 'right_thigh'], null, '"', '#16a34a');
            renderMeasurementChart('bodyfatChart', 'body_fat_percentage', null, '%', '#0891b2');
        }

        function renderMeasurementChart(canvasId, field, unitField, defaultUnit, color) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            let measurements;
            if (Array.isArray(field)) {
                measurements = [...clientMeasurements].reverse().filter(m => m[field[0]] || m[field[1]]);
                measurements = measurements.map(m => ({
                    ...m,
                    _chartValue: m[field[0]] || m[field[1]]
                }));
            } else {
                measurements = [...clientMeasurements].reverse().filter(m => m[field]);
                measurements = measurements.map(m => ({
                    ...m,
                    _chartValue: m[field]
                }));
            }

            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = rect.height;

            if (measurements.length < 2) {
                ctx.clearRect(0, 0, width, height);
                ctx.font = '14px Inter, -apple-system, sans-serif';
                ctx.fillStyle = '#94a3b8';
                ctx.textAlign = 'center';
                ctx.fillText('Need at least 2 entries to show chart', width / 2, height / 2);
                return;
            }

            const padding = { top: 20, right: 20, bottom: 40, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            const values = measurements.map(m => parseFloat(m._chartValue));
            const minVal = Math.floor(Math.min(...values) - 2);
            const maxVal = Math.ceil(Math.max(...values) + 2);
            const valRange = maxVal - minVal || 1;

            ctx.clearRect(0, 0, width, height);

            ctx.strokeStyle = '#e2e8f0';
            ctx.fillStyle = '#718096';
            ctx.font = '11px Inter, -apple-system, sans-serif';
            ctx.textAlign = 'right';

            const numGridLines = 5;
            for (let i = 0; i <= numGridLines; i++) {
                const y = padding.top + (chartHeight * i / numGridLines);
                const val = maxVal - (valRange * i / numGridLines);

                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();

                const unit = unitField ? (measurements[0][unitField] || defaultUnit) : defaultUnit;
                ctx.fillText(val.toFixed(1) + unit, padding.left - 8, y + 4);
            }

            const points = measurements.map((m, i) => ({
                x: padding.left + (chartWidth * i / (measurements.length - 1)),
                y: padding.top + chartHeight - ((parseFloat(m._chartValue) - minVal) / valRange * chartHeight),
                date: m.measured_date,
                value: m._chartValue
            }));

            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            points.forEach((p, i) => {
                if (i === 0) ctx.moveTo(p.x, p.y);
                else ctx.lineTo(p.x, p.y);
            });
            ctx.stroke();

            ctx.beginPath();
            ctx.fillStyle = color + '1a';
            ctx.moveTo(points[0].x, padding.top + chartHeight);
            points.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.lineTo(points[points.length - 1].x, padding.top + chartHeight);
            ctx.closePath();
            ctx.fill();

            points.forEach(p => {
                ctx.beginPath();
                ctx.fillStyle = color;
                ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                ctx.fill();

                ctx.beginPath();
                ctx.fillStyle = 'white';
                ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                ctx.fill();
            });

            ctx.fillStyle = '#718096';
            ctx.font = '10px Inter, -apple-system, sans-serif';
            ctx.textAlign = 'center';

            const labelInterval = Math.ceil(points.length / 6);
            points.forEach((p, i) => {
                if (i % labelInterval === 0 || i === points.length - 1) {
                    const date = new Date(p.date);
                    const label = `${date.getMonth() + 1}/${date.getDate()}`;
                    ctx.fillText(label, p.x, height - padding.bottom + 20);
                }
            });
        }

        function openMeasurementModal() {
            const modal = document.getElementById('measurementModal');
            modal.style.display = 'block';

            // Set default date to today
            document.getElementById('measurementDate').value = new Date().toISOString().split('T')[0];

            // Clear form
            document.getElementById('measurementWeight').value = '';
            document.getElementById('measurementBodyFat').value = '';
            document.getElementById('measurementWaist').value = '';
            document.getElementById('measurementChest').value = '';
            document.getElementById('measurementHips').value = '';
            document.getElementById('measurementLeftArm').value = '';
            document.getElementById('measurementRightArm').value = '';
            document.getElementById('measurementLeftThigh').value = '';
            document.getElementById('measurementRightThigh').value = '';
            document.getElementById('measurementNotes').value = '';
        }

        function closeMeasurementModal() {
            document.getElementById('measurementModal').style.display = 'none';
        }

        async function saveMeasurement() {
            const btn = document.getElementById('saveMeasurementBtn');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                const response = await fetch(SAVE_MEASUREMENT_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientId: currentClient.id,
                        coachId: currentUser.id,
                        measuredDate: document.getElementById('measurementDate').value,
                        weight: document.getElementById('measurementWeight').value || null,
                        weightUnit: document.getElementById('weightUnit').value,
                        bodyFatPercentage: document.getElementById('measurementBodyFat').value || null,
                        waist: document.getElementById('measurementWaist').value || null,
                        chest: document.getElementById('measurementChest').value || null,
                        hips: document.getElementById('measurementHips').value || null,
                        leftArm: document.getElementById('measurementLeftArm').value || null,
                        rightArm: document.getElementById('measurementRightArm').value || null,
                        leftThigh: document.getElementById('measurementLeftThigh').value || null,
                        rightThigh: document.getElementById('measurementRightThigh').value || null,
                        notes: document.getElementById('measurementNotes').value || null
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save');
                }

                console.log('Measurement saved successfully');
                closeMeasurementModal();
                await loadMeasurements(currentClient.id);

            } catch (error) {
                console.error('Error saving measurement:', error);
                alert('Failed to save measurement: ' + error.message);
            } finally {
                btn.textContent = 'Save Measurement';
                btn.disabled = false;
            }
        }

        // Handle window resize for chart
        window.addEventListener('resize', () => {
            if (clientMeasurements.length > 0) {
                renderAllCharts();
            }
        });

        // ========== CHECK-INS FUNCTIONS ==========

        async function loadCheckins(clientId) {
            try {
                const response = await fetch(`${CHECKIN_ENDPOINT}?clientId=${clientId}&limit=10`);

                if (!response.ok) throw new Error('Failed to load check-ins');

                const data = await response.json();
                clientCheckins = data.checkins || [];
                displayCheckins();

                // Scroll to specific check-in if URL has a hash (e.g., #checkin-123)
                if (window.location.hash && window.location.hash.startsWith('#checkin-')) {
                    const checkinElement = document.querySelector(window.location.hash);
                    if (checkinElement) {
                        // Small delay to ensure DOM is fully rendered
                        setTimeout(() => {
                            checkinElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Add highlight effect
                            checkinElement.style.boxShadow = '0 0 0 3px #3182ce';
                            setTimeout(() => {
                                checkinElement.style.boxShadow = '';
                            }, 3000);
                        }, 100);
                    }
                }

            } catch (error) {
                console.error('Error loading check-ins:', error);
                document.getElementById('checkinsContainer').innerHTML = `
                    <div class="empty-state">
                        <p>Unable to load check-ins</p>
                    </div>
                `;
            }
        }

        function displayCheckins() {
            const container = document.getElementById('checkinsContainer');

            if (clientCheckins.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="color: #718096;">No check-ins submitted yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = clientCheckins.map(c => {
                const needsResponse = !c.coach_feedback && !c.coach_responded_at;
                const hasDietRequest = c.request_new_diet === true;

                return `
                    <div class="checkin-card ${needsResponse ? 'needs-response' : ''} ${hasDietRequest ? 'diet-request' : ''}" id="checkin-${c.id}" style="${hasDietRequest ? 'border-left: 4px solid #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);' : ''}">
                        <div class="checkin-card-header">
                            <span class="checkin-date">${new Date(c.checkin_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
                            <div>
                                ${hasDietRequest ? `<span class="checkin-badge" style="background: #f59e0b; color: white;"> Diet Requested</span>` : ''}
                                ${c.meal_plan_adherence !== null ? `<span class="checkin-badge adherence">${c.meal_plan_adherence}% adherence</span>` : ''}
                                ${needsResponse ? `<span class="checkin-badge pending">Needs Response</span>` : ''}
                            </div>
                        </div>

                        ${hasDietRequest ? `
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">Client wants a new meal plan</div>
                                ${c.diet_request_reason ? `<div style="color: #78350f; font-size: 14px;">"${c.diet_request_reason}"</div>` : '<div style="color: #a16207; font-size: 14px; font-style: italic;">No reason provided</div>'}
                                <a href="planner.html?clientId=${c.client_id}" style="display: inline-block; margin-top: 10px; background: #f59e0b; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 600;">Create New Plan</a>
                            </div>
                        ` : ''}

                        <div class="checkin-ratings">
                            ${c.energy_level ? `
                                <div class="checkin-rating-item">
                                    <div class="checkin-rating-value">${c.energy_level}/5</div>
                                    <div class="checkin-rating-label">Energy</div>
                                </div>
                            ` : ''}
                            ${c.sleep_quality ? `
                                <div class="checkin-rating-item">
                                    <div class="checkin-rating-value">${c.sleep_quality}/5</div>
                                    <div class="checkin-rating-label">Sleep</div>
                                </div>
                            ` : ''}
                            ${c.hunger_level ? `
                                <div class="checkin-rating-item">
                                    <div class="checkin-rating-value">${c.hunger_level}/5</div>
                                    <div class="checkin-rating-label">Hunger</div>
                                </div>
                            ` : ''}
                            ${c.stress_level ? `
                                <div class="checkin-rating-item">
                                    <div class="checkin-rating-value">${c.stress_level}/5</div>
                                    <div class="checkin-rating-label">Stress</div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="checkin-feedback">
                            ${c.wins ? `
                                <div class="checkin-feedback-item">
                                    <div class="checkin-feedback-label"> Wins</div>
                                    <div class="checkin-feedback-text">${c.wins}</div>
                                </div>
                            ` : ''}
                            ${c.challenges ? `
                                <div class="checkin-feedback-item">
                                    <div class="checkin-feedback-label"> Challenges</div>
                                    <div class="checkin-feedback-text">${c.challenges}</div>
                                </div>
                            ` : ''}
                            ${c.questions ? `
                                <div class="checkin-feedback-item">
                                    <div class="checkin-feedback-label"> Questions</div>
                                    <div class="checkin-feedback-text">${c.questions}</div>
                                </div>
                            ` : ''}
                        </div>

                        ${c.coach_feedback ? `
                            <div class="coach-existing-response">
                                <div class="coach-existing-response-label">Your Response:</div>
                                <div class="coach-existing-response-text">${c.coach_feedback}</div>
                            </div>
                        ` : `
                            <div class="coach-response-form">
                                <textarea id="response-${c.id}" placeholder="Write a response to encourage and guide your client..."></textarea>
                                <button class="btn btn-primary" onclick="submitCoachResponse(${c.id})" style="width: 100%;">Send Response</button>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        async function submitCoachResponse(checkinId) {
            const textarea = document.getElementById(`response-${checkinId}`);
            const feedback = textarea.value.trim();

            if (!feedback) {
                alert('Please enter a response');
                return;
            }

            const btn = textarea.nextElementSibling;
            btn.textContent = 'Sending...';
            btn.disabled = true;

            try {
                const response = await fetch(RESPOND_CHECKIN_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        checkinId: checkinId,
                        coachId: currentUser.id,
                        feedback: feedback
                    })
                });

                if (!response.ok) throw new Error('Failed to send response');

                console.log('Response sent successfully');
                await loadCheckins(currentClient.id);

            } catch (error) {
                console.error('Error sending response:', error);
                alert('Failed to send response. Please try again.');
                btn.textContent = 'Send Response';
                btn.disabled = false;
            }
        }

        // ========== FAVORITES FUNCTIONS ==========

        async function loadFavorites(clientId) {
            try {
                const response = await fetch(`${FAVORITES_ENDPOINT}?clientId=${clientId}`);

                if (!response.ok) throw new Error('Failed to load favorites');

                const data = await response.json();
                clientFavorites = data.favorites || [];
                updateFavoritesStats();
                displayFavorites();

            } catch (error) {
                console.error('Error loading favorites:', error);
                document.getElementById('favoritesContainer').innerHTML = `
                    <div class="empty-favorites">
                        <p>Unable to load favorites</p>
                    </div>
                `;
            }
        }

        function updateFavoritesStats() {
            const statsBar = document.getElementById('favoritesStatsBar');
            const filterBar = document.getElementById('favoritesFilterBar');

            if (clientFavorites.length === 0) {
                statsBar.style.display = 'none';
                filterBar.style.display = 'none';
                return;
            }

            statsBar.style.display = 'flex';
            filterBar.style.display = 'flex';

            document.getElementById('favoritesTotalCount').textContent = clientFavorites.length;

            const avgCal = Math.round(clientFavorites.reduce((sum, f) => sum + (f.calories || 0), 0) / clientFavorites.length);
            const avgPro = Math.round(clientFavorites.reduce((sum, f) => sum + (f.protein || 0), 0) / clientFavorites.length);

            document.getElementById('favoritesAvgCalories').textContent = avgCal;
            document.getElementById('favoritesAvgProtein').textContent = avgPro;
        }

        function displayFavorites() {
            const container = document.getElementById('favoritesContainer');

            let filtered = clientFavorites;
            if (currentFavoritesFilter !== 'all') {
                filtered = clientFavorites.filter(f => f.meal_type === currentFavoritesFilter);
            }

            if (filtered.length === 0) {
                if (clientFavorites.length === 0) {
                    container.innerHTML = `
                        <div class="empty-favorites">
                            <div class="empty-favorites-icon"></div>
                            <h3 style="color: #333; margin-bottom: 8px;">No Favorites Yet</h3>
                            <p>This client hasn't favorited any meals yet.<br>They can tap the heart icon on meals they love!</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-favorites">
                            <div class="empty-favorites-icon"></div>
                            <h3 style="color: #333; margin-bottom: 8px;">No ${currentFavoritesFilter} favorites</h3>
                            <p>No ${currentFavoritesFilter} meals have been favorited yet.</p>
                        </div>
                    `;
                }
                return;
            }

            const mealTypeLabels = {
                'breakfast': 'Breakfast',
                'lunch': 'Lunch',
                'dinner': 'Dinner',
                'snack': 'Snack'
            };

            container.innerHTML = `
                <div class="favorites-grid">
                    ${filtered.map(fav => `
                        <div class="favorite-card">
                            <span class="favorite-meal-type-badge">${mealTypeLabels[fav.meal_type] || fav.meal_type || 'Meal'}</span>
                            <div class="favorite-meal-name">${fav.meal_name}</div>
                            <div class="favorite-macros-grid">
                                <div class="favorite-macro-item">
                                    <div class="favorite-macro-label">Cal</div>
                                    <div class="favorite-macro-value calories">${fav.calories || '-'}</div>
                                </div>
                                <div class="favorite-macro-item">
                                    <div class="favorite-macro-label">Protein</div>
                                    <div class="favorite-macro-value protein">${fav.protein ? fav.protein + 'g' : '-'}</div>
                                </div>
                                <div class="favorite-macro-item">
                                    <div class="favorite-macro-label">Carbs</div>
                                    <div class="favorite-macro-value carbs">${fav.carbs ? fav.carbs + 'g' : '-'}</div>
                                </div>
                                <div class="favorite-macro-item">
                                    <div class="favorite-macro-label">Fat</div>
                                    <div class="favorite-macro-value fat">${fav.fat ? fav.fat + 'g' : '-'}</div>
                                </div>
                            </div>
                            <div class="favorite-date">Saved ${formatFavoriteDate(fav.created_at)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function formatFavoriteDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function filterFavorites(filter, btn) {
            currentFavoritesFilter = filter;

            // Update button styles
            document.querySelectorAll('.favorites-filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            displayFavorites();
        }

        // ============ FOOD DIARY FUNCTIONS ============
        let currentDiaryDate = new Date().toISOString().split('T')[0];

        async function loadFoodDiary(clientId) {
            const container = document.getElementById('diaryContainer');
            const summaryEl = document.getElementById('diarySummary');
            const datePicker = document.getElementById('diaryDatePicker');

            // Set the date picker to current diary date
            datePicker.value = currentDiaryDate;

            try {
                container.innerHTML = '<div class="loading">Loading food diary...</div>';

                const response = await fetch(`/.netlify/functions/food-diary?clientId=${clientId}&date=${currentDiaryDate}`);

                if (!response.ok) throw new Error('Failed to load diary');

                const data = await response.json();
                const { mealGroups, totals, goals } = data;

                // Update summary
                document.getElementById('diaryCalories').textContent = totals.calories || 0;
                document.getElementById('diaryProtein').textContent = `${Math.round(totals.protein || 0)}g`;
                document.getElementById('diaryCarbs').textContent = `${Math.round(totals.carbs || 0)}g`;
                document.getElementById('diaryFat').textContent = `${Math.round(totals.fat || 0)}g`;
                summaryEl.style.display = 'grid';

                // Render meals
                renderDiaryMeals(mealGroups);

            } catch (error) {
                console.error('Error loading food diary:', error);
                container.innerHTML = `
                    <div class="diary-empty">
                        <div class="diary-empty-icon"></div>
                        <p>Unable to load food diary</p>
                    </div>
                `;
                summaryEl.style.display = 'none';
            }
        }

        function renderDiaryMeals(mealGroups) {
            const container = document.getElementById('diaryContainer');
            const mealOrder = ['breakfast', 'lunch', 'dinner', 'snack'];
            const mealLabels = {
                breakfast: ' Breakfast',
                lunch: ' Lunch',
                dinner: ' Dinner',
                snack: ' Snacks'
            };

            let hasAnyEntries = false;
            let html = '';

            mealOrder.forEach(mealType => {
                const entries = mealGroups[mealType] || [];
                if (entries.length > 0) {
                    hasAnyEntries = true;
                    html += `
                        <div class="diary-meal-group">
                            <div class="diary-meal-title">${mealLabels[mealType]}</div>
                            ${entries.map(entry => `
                                <div class="diary-food-item">
                                    <div class="diary-food-name">${entry.food_name}</div>
                                    <div class="diary-food-macros">
                                        <span>${entry.calories} cal</span>
                                        <span>${Math.round(entry.protein || 0)}g P</span>
                                        <span>${Math.round(entry.carbs || 0)}g C</span>
                                        <span>${Math.round(entry.fat || 0)}g F</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });

            if (!hasAnyEntries) {
                container.innerHTML = `
                    <div class="diary-empty">
                        <div class="diary-empty-icon"></div>
                        <p>No food logged for this day</p>
                    </div>
                `;
                document.getElementById('diarySummary').style.display = 'none';
            } else {
                container.innerHTML = html;
            }
        }

        function changeDiaryDate(delta) {
            const date = new Date(currentDiaryDate);
            date.setDate(date.getDate() + delta);
            currentDiaryDate = date.toISOString().split('T')[0];
            document.getElementById('diaryDatePicker').value = currentDiaryDate;
            loadFoodDiary(clientId);
        }

        // Update date when picker changes
        document.getElementById('diaryDatePicker')?.addEventListener('change', function() {
            currentDiaryDate = this.value;
            loadFoodDiary(clientId);
        });

        // ============ AI COACH ASSISTANT FUNCTIONS ============
        let currentClientName = '';

        function askQuickQuestion(question) {
            document.getElementById('aiCoachQuestion').value = question;
            askAICoach();
        }

        async function askAICoach() {
            const questionInput = document.getElementById('aiCoachQuestion');
            const question = questionInput.value.trim();

            if (!question) {
                alert('Please enter a question');
                return;
            }

            const responseContainer = document.getElementById('aiResponseContainer');
            const responseText = document.getElementById('aiResponseText');
            const loadingEl = document.getElementById('aiLoading');
            const askBtn = document.getElementById('aiAskBtn');

            // Show loading state
            responseContainer.style.display = 'none';
            loadingEl.style.display = 'flex';
            askBtn.disabled = true;
            askBtn.textContent = 'Analyzing...';

            try {
                const response = await fetch('/.netlify/functions/coach-ai-assistant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientId: clientId,
                        question: question,
                        clientName: currentClientName
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get AI response');
                }

                // Display response
                responseText.textContent = data.response;
                responseContainer.style.display = 'block';

            } catch (error) {
                console.error('AI Coach error:', error);
                responseText.textContent = 'Sorry, I encountered an error analyzing the data. Please try again.';
                responseContainer.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
                askBtn.disabled = false;
                askBtn.textContent = 'Ask AI';
            }
        }

        // Allow Enter key to submit (Shift+Enter for new line)
        document.getElementById('aiCoachQuestion')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                askAICoach();
            }
        });

        // ============ ACTIVITY CALENDAR FUNCTIONS ============

        let acCurrentMonth = new Date().getMonth();
        let acCurrentYear = new Date().getFullYear();
        let acSelectedDate = null;
        let acAssignmentCache = {}; // { 'YYYY-MM-DD': true }
        let acWorkoutLogsCache = {}; // { 'YYYY-MM-DD': true }
        let acCurrentAssignment = null;
        let acExercisesCache = [];
        let acCurrentMuscleFilter = 'all';
        let acModalMode = 'add'; // 'add' or 'swap'
        let acSwapExerciseIndex = -1;
        let acModalSelectedIds = new Set(); // multi-select exercise IDs in add modal
        let acSelectedExercises = new Set(); // multi-select indices
        let acProgramsCache = []; // coach programs
        let acDatePickerCallback = null; // for move/copy date picker
        let acOpenMenuIndex = -1; // track which 3-dot menu is open

        function acFormatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function acChangeMonth(delta) {
            acCurrentMonth += delta;
            if (acCurrentMonth > 11) { acCurrentMonth = 0; acCurrentYear++; }
            if (acCurrentMonth < 0) { acCurrentMonth = 11; acCurrentYear--; }
            acRenderCalendar();
            acLoadMonthData();
        }

        async function acInit() {
            acRenderCalendar();
            await acLoadMonthData();
            const today = acFormatDate(new Date());
            acSelectDay(today);
        }

        function acRenderCalendar() {
            const grid = document.getElementById('acCalendarGrid');
            if (!grid) return;

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('acMonthTitle').textContent = `${monthNames[acCurrentMonth]} ${acCurrentYear}`;

            const dayHeaders = ['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'];
            let html = dayHeaders.map(d => `<div class="ac-day-header">${d}</div>`).join('');

            const firstDay = new Date(acCurrentYear, acCurrentMonth, 1);
            const lastDay = new Date(acCurrentYear, acCurrentMonth + 1, 0);

            let startDow = firstDay.getDay() - 1;
            if (startDow < 0) startDow = 6;

            const prevMonthLast = new Date(acCurrentYear, acCurrentMonth, 0);
            for (let i = startDow - 1; i >= 0; i--) {
                const day = prevMonthLast.getDate() - i;
                const date = new Date(acCurrentYear, acCurrentMonth - 1, day);
                const dateStr = acFormatDate(date);
                html += acRenderDayCell(day, dateStr, true);
            }

            const todayStr = acFormatDate(new Date());
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const date = new Date(acCurrentYear, acCurrentMonth, d);
                const dateStr = acFormatDate(date);
                const isToday = dateStr === todayStr;
                const isSelected = dateStr === acSelectedDate;
                const hasWorkout = acAssignmentCache[dateStr];
                const hasLogged = acWorkoutLogsCache[dateStr];

                let classes = 'ac-day-cell';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';
                if (hasWorkout) classes += ' has-workout';
                if (hasLogged) classes += ' has-logged';

                html += `<div class="${classes}" onclick="acSelectDay('${dateStr}')">
                    <span class="ac-day-number">${d}</span>
                    ${hasWorkout ? '<div class="ac-day-icons"><span class="ac-day-icon">' + (hasLogged ? '&#9989;' : '&#127947;&#65039;') + '</span></div>' : ''}
                </div>`;
            }

            const totalCells = startDow + lastDay.getDate();
            const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 1; i <= remaining; i++) {
                const date = new Date(acCurrentYear, acCurrentMonth + 1, i);
                const dateStr = acFormatDate(date);
                html += acRenderDayCell(i, dateStr, true);
            }

            grid.innerHTML = html;
        }

        function acRenderDayCell(day, dateStr, otherMonth) {
            const hasWorkout = acAssignmentCache[dateStr];
            const hasLogged = acWorkoutLogsCache[dateStr];
            let classes = 'ac-day-cell other-month';
            if (hasWorkout) classes += ' has-workout';
            if (hasLogged) classes += ' has-logged';
            return `<div class="${classes}" onclick="acSelectDay('${dateStr}')">
                <span class="ac-day-number">${day}</span>
            </div>`;
        }

        async function acLoadMonthData() {
            try {
                const res = await fetch(`/.netlify/functions/workout-assignments?clientId=${clientId}&activeOnly=true`);
                const data = await res.json();
                const assignments = data.assignments || [];
                acCurrentAssignment = assignments.find(a => a.is_active) || assignments[0] || null;

                if (acCurrentAssignment) {
                    acAssignmentCache = {};
                    const workoutData = acCurrentAssignment.workout_data || {};
                    const days = workoutData.days || [];
                    const schedule = workoutData.schedule || {};
                    const selectedDays = schedule.selectedDays || ['mon', 'tue', 'wed', 'thu', 'fri'];
                    const dateOverrides = workoutData.date_overrides || {};
                    const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];

                    const firstDay = new Date(acCurrentYear, acCurrentMonth, 1);
                    const lastDay = new Date(acCurrentYear, acCurrentMonth + 1, 0);

                    for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                        const dateStr = acFormatDate(d);
                        const dayName = dayNames[d.getDay()];
                        const override = dateOverrides[dateStr];

                        if (override) {
                            if (!override.isRest && override.dayIndex !== undefined) {
                                acAssignmentCache[dateStr] = true;
                            }
                        } else if (selectedDays.includes(dayName) && days.length > 0) {
                            acAssignmentCache[dateStr] = true;
                        }
                    }
                }

                const feedRes = await fetch(`/.netlify/functions/coach-workout-feed?coachId=${window.coachUserId || ''}&clientId=${clientId}&limit=100`);
                const feedData = await feedRes.json();
                const feed = feedData.feed || feedData.workouts || [];
                acWorkoutLogsCache = {};
                feed.forEach(w => {
                    if (w.workoutDate) acWorkoutLogsCache[w.workoutDate] = true;
                });

                try {
                    const adhocRes = await fetch(`/.netlify/functions/adhoc-workouts?clientId=${clientId}`);
                    const adhocData = await adhocRes.json();
                    (adhocData.workouts || []).forEach(w => {
                        if (w.workout_date) acAssignmentCache[w.workout_date] = true;
                    });
                } catch (e) { /* ignore */ }

            } catch (err) {
                console.error('Error loading calendar data:', err);
            }

            acRenderCalendar();
        }

        async function acSelectDay(dateStr) {
            acSelectedDate = dateStr;
            acSelectedExercises.clear();
            acRenderCalendar();

            const headerEl = document.getElementById('acDetailDate');
            const bodyEl = document.getElementById('acDetailBody');

            const dateObj = new Date(dateStr + 'T12:00:00');
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            headerEl.textContent = `${dayNames[dateObj.getDay()]} ${dateObj.getDate()} ${monthNames[dateObj.getMonth()]}`;

            bodyEl.innerHTML = '<div class="ac-loading"><div class="ac-spinner"></div></div>';

            try {
                // Fetch assigned workout for this date
                const res = await fetch(`/.netlify/functions/workout-assignments?clientId=${clientId}&date=${dateStr}`);
                const data = await res.json();
                const assignments = data.assignments || [];
                let workout = assignments[0] || null;

                // Also check for adhoc workout
                if (!workout || !workout.workout_data) {
                    try {
                        const adhocRes = await fetch(`/.netlify/functions/adhoc-workouts?clientId=${clientId}&date=${dateStr}`);
                        const adhocData = await adhocRes.json();
                        const adhocWorkout = (adhocData.workouts || [])[0];
                        if (adhocWorkout) {
                            workout = {
                                id: adhocWorkout.id,
                                name: adhocWorkout.name || 'Custom Workout',
                                workout_data: adhocWorkout.workout_data || { exercises: [] },
                                is_adhoc: true,
                                day_index: 0
                            };
                        }
                    } catch (e) { /* ignore */ }
                }

                if (workout && workout.workout_data) {
                    acRenderDayDetail(workout, dateStr);
                } else {
                    bodyEl.innerHTML = `
                        <div class="ac-detail-empty">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 12H4m8-8v16"/>
                            </svg>
                            <p>Rest day - no workout assigned</p>
                        </div>
                        <div class="ac-detail-actions" style="justify-content: center; margin-top: 12px;">
                            <button class="ac-action-btn" onclick="acOpenAddWorkout('${dateStr}')">
                                + Add Workout
                            </button>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error loading day detail:', err);
                bodyEl.innerHTML = '<p style="color: #ef4444; padding: 12px; text-align: center;">Failed to load workout data</p>';
            }
        }

        function acRenderDayDetail(workout, dateStr) {
            const bodyEl = document.getElementById('acDetailBody');
            const exercises = workout.workout_data.exercises || [];
            const workoutName = workout.name || 'Workout';
            const isAdhoc = !!workout.is_adhoc;
            const assignmentId = workout.id;
            const dayIndex = workout.day_index !== undefined ? workout.day_index : 0;

            let html = `<div class="ac-detail-workout-name">${escapeHtml(workoutName)}</div>`;

            // Bulk action bar (hidden until selections made)
            html += `<div class="ac-bulk-bar" id="acBulkBar">
                <span class="ac-bulk-count" id="acBulkCount">0 selected</span>
                <button class="ac-bulk-btn" onclick="acBulkCheckDone()">&#9745; Check done</button>
                <button class="ac-bulk-btn" onclick="acBulkUncheckDone()">&#9744; Uncheck</button>
                <button class="ac-bulk-btn danger" onclick="acBulkDelete()">&#128465; Delete</button>
                <button class="ac-bulk-btn" onclick="acBulkMoveTo()">&#9999; Move to</button>
                <button class="ac-bulk-btn" onclick="acBulkCopyTo()">&#128203; Copy to</button>
            </div>`;

            // Action buttons
            html += `<div class="ac-detail-actions">
                <button class="ac-action-btn" onclick="acOpenAddExercise('${assignmentId}', ${dayIndex}, ${isAdhoc}, '${dateStr}')">+ Add Exercise</button>
                <button class="ac-action-btn" onclick="acOpenAddWorkout('${dateStr}')">+ Add Workout</button>
                <button class="ac-action-btn danger" onclick="acDeleteWorkout('${assignmentId}', ${isAdhoc}, '${dateStr}')">Delete Workout</button>
            </div>`;

            // Select all checkbox
            if (exercises.length > 0) {
                html += `<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px; padding:4px 0;">
                    <input type="checkbox" class="ac-exercise-checkbox" id="acSelectAll" onchange="acToggleSelectAll(this.checked)">
                    <label for="acSelectAll" style="font-size:12px; color:#64748b; font-weight:600; cursor:pointer;">Select All</label>
                </div>`;
            }

            // Exercise list
            if (exercises.length === 0) {
                html += '<p style="text-align: center; color: #94a3b8; padding: 20px;">No exercises in this workout</p>';
            } else {
                exercises.forEach((ex, idx) => {
                    const thumb = ex.thumbnail_url || ex.animation_url || '';
                    const sets = ex.sets || 0;
                    const reps = ex.reps || '0';
                    const restSec = ex.restSeconds || 0;
                    const trackingType = ex.trackingType || 'reps';
                    const isChecked = acSelectedExercises.has(idx);
                    const isDone = ex._done;

                    // Build sets display
                    let setsHtml = '';
                    if (ex.setsData && Array.isArray(ex.setsData)) {
                        setsHtml = ex.setsData.map(s =>
                            `<span class="ac-set-pill${s._completed ? ' completed' : ''}">${s.reps || 0}${s.weight ? 'x' + s.weight + (s.weightUnit || 'lbs') : ''}</span>`
                        ).join('');
                    } else if (sets > 0) {
                        setsHtml = `<span class="ac-set-pill">${sets} sets x ${reps} ${trackingType === 'time' ? 'sec' : 'reps'}</span>`;
                    }
                    if (restSec > 0) {
                        setsHtml += `<span class="ac-set-pill">Rest: ${restSec}s</span>`;
                    }

                    html += `
                        <div class="ac-exercise-item${isChecked ? ' checked' : ''}" data-ex-index="${idx}">
                            <div class="ac-exercise-header">
                                <input type="checkbox" class="ac-exercise-checkbox" ${isChecked ? 'checked' : ''} onchange="acToggleExerciseSelect(${idx}, this.checked)">
                                ${thumb ? `<img class="ac-exercise-thumb" src="${thumb}" alt="" onerror="this.style.display='none'" onclick="acOpenExerciseDetail(${idx}, '${assignmentId}', ${dayIndex}, ${isAdhoc}, '${dateStr}')" style="cursor:pointer">` : `<div class="ac-exercise-thumb" style="display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer" onclick="acOpenExerciseDetail(${idx}, '${assignmentId}', ${dayIndex}, ${isAdhoc}, '${dateStr}')">&#127947;&#65039;</div>`}
                                <div class="ac-exercise-info" onclick="acOpenExerciseDetail(${idx}, '${assignmentId}', ${dayIndex}, ${isAdhoc}, '${dateStr}')" style="cursor:pointer">
                                    <div class="ac-exercise-name">${escapeHtml(ex.name || '')}${isDone ? ' &#9989;' : ''}</div>
                                    <div class="ac-exercise-meta">${ex.muscle_group || ''} ${ex.equipment ? '&middot; ' + ex.equipment : ''}</div>
                                </div>
                                <button class="ac-dot-menu-btn" onclick="acToggleDotMenu(event, ${idx}, '${assignmentId}', ${dayIndex}, ${isAdhoc}, '${dateStr}')">&#8942;</button>
                                <div class="ac-dot-menu" id="acDotMenu_${idx}">
                                    <button class="ac-dot-menu-item" onclick="acDotAction('checkDone', ${idx})">&#9745; ${isDone ? 'Uncheck done' : 'Check as done'}</button>
                                    <button class="ac-dot-menu-item" onclick="acDotAction('edit', ${idx})">&#9998; Edit sets</button>
                                    <button class="ac-dot-menu-item" onclick="acDotAction('swap', ${idx})">&#8644; Swap exercise</button>
                                    <button class="ac-dot-menu-item" onclick="acDotAction('moveTo', ${idx})">&#8599; Move to</button>
                                    <button class="ac-dot-menu-item" onclick="acDotAction('copyTo', ${idx})">&#128203; Copy to</button>
                                    <button class="ac-dot-menu-item danger" onclick="acDotAction('delete', ${idx})">&#128465; Delete</button>
                                </div>
                            </div>
                            <div class="ac-sets-grid" onclick="acOpenExerciseDetail(${idx}, '${assignmentId}', ${dayIndex}, ${isAdhoc}, '${dateStr}')" style="cursor:pointer">${setsHtml}</div>
                            <div id="acSetEditor_${idx}"></div>
                        </div>
                    `;
                });
            }

            bodyEl.innerHTML = html;
            bodyEl.dataset.workout = JSON.stringify(workout);
            bodyEl.dataset.dateStr = dateStr;
        }

        // ---- Close any open dot menu on click outside ----
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.ac-dot-menu-btn') && !e.target.closest('.ac-dot-menu')) {
                document.querySelectorAll('.ac-dot-menu.open').forEach(m => m.classList.remove('open'));
                acOpenMenuIndex = -1;
            }
        });

        // ---- 3-Dot Menu ----
        function acToggleDotMenu(event, idx, assignmentId, dayIndex, isAdhoc, dateStr) {
            event.stopPropagation();
            document.querySelectorAll('.ac-dot-menu.open').forEach(m => m.classList.remove('open'));

            const menu = document.getElementById(`acDotMenu_${idx}`);
            if (acOpenMenuIndex === idx) {
                acOpenMenuIndex = -1;
                return;
            }
            acOpenMenuIndex = idx;
            menu.dataset.assignmentId = assignmentId;
            menu.dataset.dayIndex = dayIndex;
            menu.dataset.isAdhoc = isAdhoc;
            menu.dataset.dateStr = dateStr;
            menu.classList.add('open');
        }

        function acDotAction(action, idx) {
            const menu = document.getElementById(`acDotMenu_${idx}`);
            const assignmentId = menu.dataset.assignmentId;
            const dayIndex = parseInt(menu.dataset.dayIndex);
            const isAdhoc = menu.dataset.isAdhoc === 'true';
            const dateStr = menu.dataset.dateStr;

            menu.classList.remove('open');
            acOpenMenuIndex = -1;

            switch(action) {
                case 'checkDone':
                    acToggleExerciseDone(idx, assignmentId, dayIndex, isAdhoc, dateStr);
                    break;
                case 'edit':
                    acEditSets(idx, assignmentId, dayIndex, isAdhoc, dateStr);
                    break;
                case 'swap':
                    acSwapExercise(idx, assignmentId, dayIndex, isAdhoc, dateStr);
                    break;
                case 'moveTo':
                    acMoveExercise([idx], assignmentId, dayIndex, isAdhoc, dateStr);
                    break;
                case 'copyTo':
                    acCopyExercise([idx], assignmentId, dayIndex, isAdhoc, dateStr);
                    break;
                case 'delete':
                    acDeleteExercise(idx, assignmentId, dayIndex, isAdhoc, dateStr);
                    break;
            }
        }

        // ---- Multi-Select ----
        function acToggleExerciseSelect(idx, checked) {
            if (checked) {
                acSelectedExercises.add(idx);
            } else {
                acSelectedExercises.delete(idx);
            }
            acUpdateBulkBar();
            const item = document.querySelector(`.ac-exercise-item[data-ex-index="${idx}"]`);
            if (item) item.classList.toggle('checked', checked);
        }

        function acToggleSelectAll(checked) {
            const bodyEl = document.getElementById('acDetailBody');
            const workout = JSON.parse(bodyEl.dataset.workout || '{}');
            const exercises = workout.workout_data?.exercises || [];

            acSelectedExercises.clear();
            if (checked) {
                exercises.forEach((_, i) => acSelectedExercises.add(i));
            }

            document.querySelectorAll('.ac-exercise-item .ac-exercise-checkbox').forEach((cb) => {
                cb.checked = checked;
                cb.closest('.ac-exercise-item')?.classList.toggle('checked', checked);
            });
            acUpdateBulkBar();
        }

        function acUpdateBulkBar() {
            const bar = document.getElementById('acBulkBar');
            const count = document.getElementById('acBulkCount');
            if (!bar || !count) return;

            if (acSelectedExercises.size > 0) {
                bar.classList.add('visible');
                count.textContent = `${acSelectedExercises.size} selected`;
            } else {
                bar.classList.remove('visible');
            }
        }

        // ---- Bulk Actions ----
        function acGetBulkContext() {
            const bodyEl = document.getElementById('acDetailBody');
            const workout = JSON.parse(bodyEl.dataset.workout || '{}');
            const dateStr = bodyEl.dataset.dateStr;
            return { workout, dateStr, assignmentId: workout.id, dayIndex: workout.day_index || 0, isAdhoc: !!workout.is_adhoc };
        }

        async function acBulkCheckDone() {
            const { workout, dateStr, assignmentId, dayIndex, isAdhoc } = acGetBulkContext();
            const exercises = workout.workout_data?.exercises || [];
            acSelectedExercises.forEach(idx => {
                if (exercises[idx]) exercises[idx]._done = true;
            });
            await acSaveExercises(exercises, assignmentId, dayIndex, isAdhoc, dateStr);
        }

        async function acBulkUncheckDone() {
            const { workout, dateStr, assignmentId, dayIndex, isAdhoc } = acGetBulkContext();
            const exercises = workout.workout_data?.exercises || [];
            acSelectedExercises.forEach(idx => {
                if (exercises[idx]) exercises[idx]._done = false;
            });
            await acSaveExercises(exercises, assignmentId, dayIndex, isAdhoc, dateStr);
        }

        async function acBulkDelete() {
            if (!confirm(`Delete ${acSelectedExercises.size} selected exercise(s)?`)) return;
            const { workout, dateStr, assignmentId, dayIndex, isAdhoc } = acGetBulkContext();
            const exercises = (workout.workout_data?.exercises || []).filter((_, i) => !acSelectedExercises.has(i));
            acSelectedExercises.clear();
            await acSaveExercises(exercises, assignmentId, dayIndex, isAdhoc, dateStr);
        }

        function acBulkMoveTo() {
            const { assignmentId, dayIndex, isAdhoc, dateStr } = acGetBulkContext();
            acMoveExercise([...acSelectedExercises], assignmentId, dayIndex, isAdhoc, dateStr);
        }

        function acBulkCopyTo() {
            const { assignmentId, dayIndex, isAdhoc, dateStr } = acGetBulkContext();
            acCopyExercise([...acSelectedExercises], assignmentId, dayIndex, isAdhoc, dateStr);
        }

        // ---- Toggle Exercise Done ----
        async function acToggleExerciseDone(idx, assignmentId, dayIndex, isAdhoc, dateStr) {
            const bodyEl = document.getElementById('acDetailBody');
            const workout = JSON.parse(bodyEl.dataset.workout || '{}');
            const exercises = workout.workout_data?.exercises || [];
            if (exercises[idx]) {
                exercises[idx]._done = !exercises[idx]._done;
            }
            await acSaveExercises(exercises, assignmentId, dayIndex, isAdhoc, dateStr);
        }

        // ---- Move Exercise(s) to another date ----
        function acMoveExercise(indices, assignmentId, dayIndex, isAdhoc, dateStr) {
            acOpenDatePicker('Move to date', async function(targetDate) {
                if (!targetDate || targetDate === dateStr) return;
                const bodyEl = document.getElementById('acDetailBody');
                const workout = JSON.parse(bodyEl.dataset.workout || '{}');
                const exercises = workout.workout_data?.exercises || [];
                const movedExercises = indices.map(i => exercises[i]).filter(Boolean);

                const remaining = exercises.filter((_, i) => !indices.includes(i));
                await acSaveExercises(remaining, assignmentId, dayIndex, isAdhoc, dateStr);
                await acAddExercisesToDate(targetDate, movedExercises);
                acSelectedExercises.clear();
            });
        }

        // ---- Copy Exercise(s) to another date ----
        function acCopyExercise(indices, assignmentId, dayIndex, isAdhoc, dateStr) {
            acOpenDatePicker('Copy to date', async function(targetDate) {
                if (!targetDate) return;
                const bodyEl = document.getElementById('acDetailBody');
                const workout = JSON.parse(bodyEl.dataset.workout || '{}');
                const exercises = workout.workout_data?.exercises || [];
                const copiedExercises = indices.map(i => ({...exercises[i]})).filter(Boolean);
                await acAddExercisesToDate(targetDate, copiedExercises);
                acSelectedExercises.clear();
            });
        }

        async function acAddExercisesToDate(targetDate, exercisesToAdd) {
            try {
                const res = await fetch(`/.netlify/functions/workout-assignments?clientId=${clientId}&date=${targetDate}`);
                const data = await res.json();
                const assignment = (data.assignments || [])[0];

                if (assignment && assignment.workout_data) {
                    const exercises = assignment.workout_data.exercises || [];
                    exercises.push(...exercisesToAdd);
                    await acSaveExercises(exercises, assignment.id, assignment.day_index || 0, !!assignment.is_adhoc, targetDate);
                } else {
                    const adhocRes = await fetch(`/.netlify/functions/adhoc-workouts?clientId=${clientId}&date=${targetDate}`);
                    const adhocData = await adhocRes.json();
                    const adhocWorkout = (adhocData.workouts || [])[0];

                    if (adhocWorkout) {
                        const exercises = (adhocWorkout.workout_data || {}).exercises || [];
                        exercises.push(...exercisesToAdd);
                        await fetch('/.netlify/functions/adhoc-workouts', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ workoutId: adhocWorkout.id, workoutData: { exercises } })
                        });
                    } else {
                        await fetch('/.netlify/functions/adhoc-workouts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                clientId,
                                workoutDate: targetDate,
                                name: 'Workout',
                                workoutData: { exercises: exercisesToAdd }
                            })
                        });
                    }
                }
                acAssignmentCache[targetDate] = true;
                acRenderCalendar();
            } catch (err) {
                console.error('Error adding exercises to date:', err);
                alert('Failed to add exercises to target date');
            }
        }

        // ---- Date Picker (Mini Calendar) ----
        let acDpMonth = new Date().getMonth();
        let acDpYear = new Date().getFullYear();
        let acDpSelectedDate = null;

        function acOpenDatePicker(title, callback) {
            document.getElementById('acDatePickerTitle').textContent = title;
            acDpMonth = new Date().getMonth();
            acDpYear = new Date().getFullYear();
            acDpSelectedDate = null;
            acDatePickerCallback = callback;
            acRenderDpCalendar();
            document.getElementById('acDatePickerModal').classList.add('active');
        }

        function acDpNavMonth(dir) {
            acDpMonth += dir;
            if (acDpMonth > 11) { acDpMonth = 0; acDpYear++; }
            if (acDpMonth < 0) { acDpMonth = 11; acDpYear--; }
            acRenderDpCalendar();
        }

        function acRenderDpCalendar() {
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            document.getElementById('acDpMonthLabel').textContent = `${months[acDpMonth]} ${acDpYear}`;

            const firstDay = new Date(acDpYear, acDpMonth, 1);
            const lastDay = new Date(acDpYear, acDpMonth + 1, 0);
            let startDow = firstDay.getDay() || 7; // Monday=1
            const daysInMonth = lastDay.getDate();
            const prevLast = new Date(acDpYear, acDpMonth, 0).getDate();

            const todayStr = new Date().toISOString().split('T')[0];
            let html = '';

            // Previous month's trailing days
            for (let i = startDow - 1; i >= 1; i--) {
                const d = prevLast - i + 1;
                const dt = new Date(acDpYear, acDpMonth - 1, d);
                const ds = dt.toISOString().split('T')[0];
                html += `<div class="ac-dp-day other-month" data-date="${ds}" onclick="acDpSelectDay(this, '${ds}')">${d}</div>`;
            }

            // Current month days
            for (let d = 1; d <= daysInMonth; d++) {
                const dt = new Date(acDpYear, acDpMonth, d);
                const ds = dt.toISOString().split('T')[0];
                let cls = 'ac-dp-day';
                if (ds === todayStr) cls += ' today';
                if (ds === acDpSelectedDate) cls += ' selected';
                html += `<div class="${cls}" data-date="${ds}" onclick="acDpSelectDay(this, '${ds}')">${d}</div>`;
            }

            // Next month's leading days
            const totalCells = Math.ceil((startDow - 1 + daysInMonth) / 7) * 7;
            const remaining = totalCells - (startDow - 1 + daysInMonth);
            for (let d = 1; d <= remaining; d++) {
                const dt = new Date(acDpYear, acDpMonth + 1, d);
                const ds = dt.toISOString().split('T')[0];
                html += `<div class="ac-dp-day other-month" data-date="${ds}" onclick="acDpSelectDay(this, '${ds}')">${d}</div>`;
            }

            document.getElementById('acDpDays').innerHTML = html;
        }

        function acDpSelectDay(el, dateStr) {
            acDpSelectedDate = dateStr;
            document.querySelectorAll('#acDpDays .ac-dp-day').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
        }

        function acCloseDatePicker() {
            document.getElementById('acDatePickerModal').classList.remove('active');
            acDatePickerCallback = null;
            acDpSelectedDate = null;
        }

        async function acConfirmDatePicker() {
            if (!acDpSelectedDate) { alert('Please select a date'); return; }
            document.getElementById('acDatePickerModal').classList.remove('active');
            if (acDatePickerCallback) {
                await acDatePickerCallback(acDpSelectedDate);
                acDatePickerCallback = null;
            }
            acDpSelectedDate = null;
        }

        // ---- Save Exercises Helper ----
        async function acSaveExercises(exercises, assignmentId, dayIndex, isAdhoc, dateStr) {
            try {
                if (isAdhoc) {
                    await fetch('/.netlify/functions/adhoc-workouts', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ workoutId: assignmentId, workoutData: { exercises } })
                    });
                } else {
                    await fetch('/.netlify/functions/client-workout-log', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ assignmentId, dayIndex, workout_data: { exercises } })
                    });
                }
                acSelectDay(dateStr);
            } catch (err) {
                console.error('Error saving exercises:', err);
                alert('Failed to save changes');
            }
        }

        // ---- Set Editing ----
        function acEditSets(exIndex, assignmentId, dayIndex, isAdhoc, dateStr) {
            const bodyEl = document.getElementById('acDetailBody');
            const workout = JSON.parse(bodyEl.dataset.workout || '{}');
            const exercises = workout.workout_data?.exercises || [];
            const exercise = exercises[exIndex];
            if (!exercise) return;

            const editorEl = document.getElementById(`acSetEditor_${exIndex}`);

            let setsData = [];
            if (exercise.setsData && Array.isArray(exercise.setsData)) {
                setsData = exercise.setsData.map(s => ({ reps: s.reps || 0, weight: s.weight || 0, weightUnit: s.weightUnit || 'lbs' }));
            } else {
                const numSets = exercise.sets || 3;
                const reps = parseInt(exercise.reps) || 10;
                for (let i = 0; i < numSets; i++) {
                    setsData.push({ reps, weight: 0, weightUnit: 'lbs' });
                }
            }

            let html = '<div class="ac-set-editor">';
            html += '<div class="ac-set-row"><span class="ac-set-label">Set</span><span class="ac-set-label">Reps</span><span class="ac-set-label">Weight</span><span></span></div>';

            setsData.forEach((s, i) => {
                html += `<div class="ac-set-row">
                    <span class="ac-set-label">${i + 1}</span>
                    <input class="ac-set-input" type="number" value="${s.reps}" data-field="reps" min="0">
                    <input class="ac-set-input" type="number" value="${s.weight}" data-field="weight" min="0" step="0.5">
                    <button class="ac-set-remove" onclick="this.closest('.ac-set-row').remove()">&times;</button>
                </div>`;
            });

            html += `<button class="ac-set-add-btn" onclick="acAddSetRow(this)">+ Add Set</button>`;
            html += `<button class="ac-set-save-btn" onclick="acSaveSets(${exIndex}, '${assignmentId}', ${dayIndex}, ${isAdhoc}, '${dateStr}')">Save Changes</button>`;
            html += '</div>';

            editorEl.innerHTML = html;
        }

        function acAddSetRow(btn) {
            const editor = btn.closest('.ac-set-editor');
            const rows = editor.querySelectorAll('.ac-set-row');
            const num = rows.length;
            const row = document.createElement('div');
            row.className = 'ac-set-row';
            row.innerHTML = `
                <span class="ac-set-label">${num}</span>
                <input class="ac-set-input" type="number" value="10" data-field="reps" min="0">
                <input class="ac-set-input" type="number" value="0" data-field="weight" min="0" step="0.5">
                <button class="ac-set-remove" onclick="this.closest('.ac-set-row').remove()">&times;</button>
            `;
            btn.before(row);
        }

        async function acSaveSets(exIndex, assignmentId, dayIndex, isAdhoc, dateStr) {
            const editorEl = document.getElementById(`acSetEditor_${exIndex}`);
            const rows = editorEl.querySelectorAll('.ac-set-row');
            const newSetsData = [];

            rows.forEach((row, i) => {
                if (i === 0) return;
                const repsInput = row.querySelector('[data-field="reps"]');
                const weightInput = row.querySelector('[data-field="weight"]');
                if (repsInput && weightInput) {
                    newSetsData.push({
                        setNumber: newSetsData.length + 1,
                        reps: parseInt(repsInput.value) || 0,
                        weight: parseFloat(weightInput.value) || 0,
                        weightUnit: 'lbs'
                    });
                }
            });

            const bodyEl = document.getElementById('acDetailBody');
            const workout = JSON.parse(bodyEl.dataset.workout || '{}');
            const exercises = workout.workout_data?.exercises || [];

            if (exercises[exIndex]) {
                exercises[exIndex].sets = newSetsData.length;
                exercises[exIndex].reps = newSetsData[0]?.reps?.toString() || '0';
                exercises[exIndex].setsData = newSetsData;
            }

            const saveBtn = editorEl.querySelector('.ac-set-save-btn');
            if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; }

            await acSaveExercises(exercises, assignmentId, dayIndex, isAdhoc, dateStr);
        }

        // ---- Delete Exercise ----
        async function acDeleteExercise(exIndex, assignmentId, dayIndex, isAdhoc, dateStr) {
            if (!confirm('Delete this exercise from the workout?')) return;
            const bodyEl = document.getElementById('acDetailBody');
            const workout = JSON.parse(bodyEl.dataset.workout || '{}');
            const exercises = (workout.workout_data?.exercises || []).filter((_, i) => i !== exIndex);
            await acSaveExercises(exercises, assignmentId, dayIndex, isAdhoc, dateStr);
        }

        // ---- Swap Exercise ----
        function acSwapExercise(exIndex, assignmentId, dayIndex, isAdhoc, dateStr) {
            acModalMode = 'swap';
            acSwapExerciseIndex = exIndex;
            acModalSelectedIds.clear();
            document.getElementById('acModalTitle').textContent = 'Swap Exercise';

            const modal = document.getElementById('acExerciseModal');
            modal.dataset.assignmentId = assignmentId;
            modal.dataset.dayIndex = dayIndex;
            modal.dataset.isAdhoc = isAdhoc;
            modal.dataset.dateStr = dateStr;

            document.getElementById('acModalFooter').style.display = 'none';

            modal.classList.add('active');
            acLoadExercises();
        }

        // ---- Add Exercise ----
        function acOpenAddExercise(assignmentId, dayIndex, isAdhoc, dateStr) {
            acModalMode = 'add';
            acModalSelectedIds.clear();
            document.getElementById('acModalTitle').textContent = 'Add Exercises';

            const modal = document.getElementById('acExerciseModal');
            modal.dataset.assignmentId = assignmentId;
            modal.dataset.dayIndex = dayIndex;
            modal.dataset.isAdhoc = isAdhoc;
            modal.dataset.dateStr = dateStr;

            document.getElementById('acModalFooter').style.display = 'flex';
            acUpdateAddSelectedBtn();

            modal.classList.add('active');
            acLoadExercises();
        }

        function acCloseExerciseModal() {
            document.getElementById('acExerciseModal').classList.remove('active');
            acModalSelectedIds.clear();
        }

        async function acLoadExercises() {
            const listEl = document.getElementById('acExerciseList');
            listEl.innerHTML = '<div class="ac-loading"><div class="ac-spinner"></div></div>';

            try {
                const params = new URLSearchParams({ coachId: window.coachUserId || '', limit: '100' });
                if (acCurrentMuscleFilter && acCurrentMuscleFilter !== 'all') {
                    params.set('muscleGroup', acCurrentMuscleFilter);
                }
                const searchVal = document.getElementById('acExerciseSearch')?.value?.trim();
                if (searchVal) {
                    params.set('search', searchVal);
                }

                const res = await fetch(`/.netlify/functions/exercises?${params.toString()}`);
                const data = await res.json();
                acExercisesCache = data.exercises || [];

                acRenderExerciseList();
            } catch (err) {
                console.error('Error loading exercises:', err);
                listEl.innerHTML = '<p style="color: #ef4444;">Failed to load exercises</p>';
            }
        }

        function acRenderExerciseList() {
            const listEl = document.getElementById('acExerciseList');
            if (acExercisesCache.length === 0) {
                listEl.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No exercises found</p>';
                return;
            }

            const isAddMode = acModalMode === 'add';
            listEl.innerHTML = acExercisesCache.map(ex => {
                const thumb = ex.thumbnail_url || ex.animation_url || '';
                const exId = String(ex.id);
                const isSelected = acModalSelectedIds.has(exId);
                return `<div class="ac-exercise-option${isSelected ? ' selected' : ''}" onclick="acSelectExercise('${exId}')">
                    ${isAddMode ? `<input type="checkbox" class="ac-modal-checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); acSelectExercise('${exId}')">` : ''}
                    ${thumb ? `<img src="${thumb}" alt="" onerror="this.style.display='none'">` : '<div style="width:48px;height:48px;border-radius:8px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-size:20px;">&#127947;&#65039;</div>'}
                    <div class="ac-exercise-option-info">
                        <h4>${escapeHtml(ex.name || '')}</h4>
                        <span>${ex.muscle_group || ''} ${ex.equipment ? '&middot; ' + ex.equipment : ''}</span>
                    </div>
                </div>`;
            }).join('');
        }

        let acSearchTimeout = null;
        function acSearchExercises() {
            clearTimeout(acSearchTimeout);
            acSearchTimeout = setTimeout(() => acLoadExercises(), 300);
        }

        function acFilterMuscle(muscle, btn) {
            acCurrentMuscleFilter = muscle;
            document.querySelectorAll('#acMuscleFilters .ac-filter-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            acLoadExercises();
        }

        function acSelectExercise(exerciseId) {
            const exId = String(exerciseId);

            // In swap mode, immediately swap and close
            if (acModalMode === 'swap') {
                const exercise = acExercisesCache.find(e => String(e.id) === exId);
                if (!exercise) return;

                const modal = document.getElementById('acExerciseModal');
                const assignmentId = modal.dataset.assignmentId;
                const dayIndex = parseInt(modal.dataset.dayIndex);
                const isAdhoc = modal.dataset.isAdhoc === 'true';
                const dateStr = modal.dataset.dateStr;

                const bodyEl = document.getElementById('acDetailBody');
                const workout = JSON.parse(bodyEl.dataset.workout || '{}');
                const exercises = workout.workout_data?.exercises || [];

                const newExercise = {
                    id: exercise.id,
                    name: exercise.name,
                    muscle_group: exercise.muscle_group,
                    equipment: exercise.equipment,
                    thumbnail_url: exercise.thumbnail_url,
                    animation_url: exercise.animation_url,
                    video_url: exercise.video_url,
                    sets: 3,
                    reps: '10',
                    restSeconds: 60,
                    trackingType: 'reps'
                };

                if (acSwapExerciseIndex >= 0 && acSwapExerciseIndex < exercises.length) {
                    const old = exercises[acSwapExerciseIndex];
                    newExercise.sets = old.sets || 3;
                    newExercise.reps = old.reps || '10';
                    newExercise.restSeconds = old.restSeconds || 60;
                    newExercise.setsData = old.setsData;
                    exercises[acSwapExerciseIndex] = newExercise;
                }

                acCloseExerciseModal();
                acSaveExercises(exercises, assignmentId, dayIndex, isAdhoc, dateStr);
                return;
            }

            // In add mode, toggle multi-select
            if (acModalSelectedIds.has(exId)) {
                acModalSelectedIds.delete(exId);
            } else {
                acModalSelectedIds.add(exId);
            }
            acRenderExerciseList();
            acUpdateAddSelectedBtn();
        }

        function acUpdateAddSelectedBtn() {
            const count = acModalSelectedIds.size;
            const btn = document.getElementById('acAddSelectedBtn');
            btn.textContent = `Add Selected (${count})`;
            btn.disabled = count === 0;
        }

        async function acAddSelectedExercises() {
            if (acModalSelectedIds.size === 0) return;

            const modal = document.getElementById('acExerciseModal');
            const assignmentId = modal.dataset.assignmentId;
            const dayIndex = parseInt(modal.dataset.dayIndex);
            const isAdhoc = modal.dataset.isAdhoc === 'true';
            const dateStr = modal.dataset.dateStr;

            const bodyEl = document.getElementById('acDetailBody');
            const workout = JSON.parse(bodyEl.dataset.workout || '{}');
            const exercises = workout.workout_data?.exercises || [];

            for (const exId of acModalSelectedIds) {
                const exercise = acExercisesCache.find(e => String(e.id) === exId);
                if (!exercise) continue;

                exercises.push({
                    id: exercise.id,
                    name: exercise.name,
                    muscle_group: exercise.muscle_group,
                    equipment: exercise.equipment,
                    thumbnail_url: exercise.thumbnail_url,
                    animation_url: exercise.animation_url,
                    video_url: exercise.video_url,
                    sets: 3,
                    reps: '10',
                    restSeconds: 60,
                    trackingType: 'reps'
                });
            }

            acModalSelectedIds.clear();
            acCloseExerciseModal();
            await acSaveExercises(exercises, assignmentId, dayIndex, isAdhoc, dateStr);
        }

        // ============ ADD WORKOUT (Program Picker) ============

        function acOpenAddWorkout(dateStr) {
            const modal = document.getElementById('acAddWorkoutModal');
            modal.dataset.dateStr = dateStr;
            document.getElementById('acAddWorkoutTitle').textContent = 'Add Workout';

            document.getElementById('acAddWorkoutBody').innerHTML = `
                <div class="ac-add-workout-options">
                    <div class="ac-add-workout-option" onclick="acShowCustomWorkoutForm('${dateStr}')">
                        <div class="ac-add-workout-icon">&#10010;</div>
                        <div class="ac-add-workout-info">
                            <h4>Custom Workout</h4>
                            <span>Create a blank workout and add exercises</span>
                        </div>
                    </div>
                    <div class="ac-add-workout-option" onclick="acShowProgramPicker('${dateStr}')">
                        <div class="ac-add-workout-icon">&#128218;</div>
                        <div class="ac-add-workout-info">
                            <h4>From Program Library</h4>
                            <span>Assign a workout from your saved programs</span>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function acShowCustomWorkoutForm(dateStr) {
            const body = document.getElementById('acAddWorkoutBody');
            body.innerHTML = `
                <div style="padding: 8px 0;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; color:#334155; font-size:14px;">Workout Name</label>
                    <input type="text" id="acCustomWorkoutName" value="Custom Workout" placeholder="Enter workout name..."
                        style="width:100%; padding:12px 14px; border:1px solid #e2e8f0; border-radius:10px; font-size:14px; box-sizing:border-box; outline:none;">
                    <button onclick="acCreateCustomWorkout('${dateStr}')"
                        style="width:100%; margin-top:16px; padding:14px; background:#3b82f6; color:#fff; border:none; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer;">
                        Create Workout
                    </button>
                </div>
            `;
            setTimeout(() => {
                const inp = document.getElementById('acCustomWorkoutName');
                if (inp) { inp.focus(); inp.select(); }
            }, 100);
        }

        function acCloseAddWorkoutModal() {
            document.getElementById('acAddWorkoutModal').classList.remove('active');
        }

        async function acCreateCustomWorkout(dateStr) {
            const nameInput = document.getElementById('acCustomWorkoutName');
            const name = (nameInput?.value || '').trim() || 'Custom Workout';
            acCloseAddWorkoutModal();

            try {
                const res = await fetch('/.netlify/functions/adhoc-workouts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientId,
                        workoutDate: dateStr,
                        name,
                        workoutData: { exercises: [] }
                    })
                });
                const data = await res.json();

                acAssignmentCache[dateStr] = true;
                acRenderCalendar();
                await acSelectDay(dateStr);

                // Automatically open the exercise picker so the user can add exercises
                const bodyEl = document.getElementById('acDetailBody');
                const workout = JSON.parse(bodyEl.dataset.workout || '{}');
                if (workout.id) {
                    acOpenAddExercise(workout.id, workout.day_index || 0, true, dateStr);
                }
            } catch (err) {
                console.error('Error creating custom workout:', err);
                alert('Failed to create workout');
            }
        }

        async function acShowProgramPicker(dateStr) {
            const body = document.getElementById('acAddWorkoutBody');
            body.innerHTML = '<div class="ac-loading"><div class="ac-spinner"></div></div>';

            try {
                if (acProgramsCache.length === 0) {
                    const res = await fetch(`/.netlify/functions/workout-programs?coachId=${window.coachUserId || ''}`);
                    const data = await res.json();
                    acProgramsCache = data.programs || [];
                }

                if (acProgramsCache.length === 0) {
                    body.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:30px;">No programs found in your library. Create programs in the Workout Builder first.</p>';
                    return;
                }

                let html = '<input type="text" class="ac-modal-search" placeholder="Search programs..." oninput="acFilterPrograms(this.value)">';
                html += '<div class="ac-program-list" id="acProgramList">';
                html += acRenderProgramList(acProgramsCache, dateStr);
                html += '</div>';

                body.innerHTML = html;
            } catch (err) {
                console.error('Error loading programs:', err);
                body.innerHTML = '<p style="color:#ef4444; padding:20px; text-align:center;">Failed to load programs</p>';
            }
        }

        function acRenderProgramList(programs, dateStr) {
            return programs.map(p => {
                const imgUrl = p.program_data?.image_url || '';
                const daysCount = (p.program_data?.days || []).length;
                return `<div class="ac-program-item" onclick="acSelectProgram(${p.id}, '${dateStr}')">
                    ${imgUrl ? `<img src="${imgUrl}" alt="" onerror="this.style.display='none'">` : '<div style="width:48px;height:48px;border-radius:8px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-size:18px;">&#128218;</div>'}
                    <div class="ac-program-item-info">
                        <h4>${escapeHtml(p.name || 'Untitled')}</h4>
                        <span>${daysCount} day${daysCount !== 1 ? 's' : ''} &middot; ${p.difficulty || 'Any level'} &middot; ${p.program_type || 'General'}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function acFilterPrograms(search) {
            const filtered = acProgramsCache.filter(p =>
                (p.name || '').toLowerCase().includes(search.toLowerCase())
            );
            const dateStr = document.getElementById('acAddWorkoutModal').dataset.dateStr;
            document.getElementById('acProgramList').innerHTML = acRenderProgramList(filtered, dateStr);
        }

        async function acSelectProgram(programId, dateStr) {
            const program = acProgramsCache.find(p => p.id === programId);
            if (!program) return;

            const days = program.program_data?.days || [];

            if (days.length === 0) {
                alert('This program has no workout days defined.');
                return;
            }

            if (days.length === 1) {
                await acAddProgramDayToDate(program, 0, dateStr);
                return;
            }

            const body = document.getElementById('acAddWorkoutBody');
            let html = `<p style="padding:12px; font-weight:600; color:#334155;">Select a workout day from "${escapeHtml(program.name)}":</p>`;
            html += '<div class="ac-program-day-picker">';
            days.forEach((day, i) => {
                html += `<button class="ac-day-pick-btn" onclick="acAddProgramDayToDate(acProgramsCache.find(p=>p.id===${programId}), ${i}, '${dateStr}')">
                    ${escapeHtml(day.name || 'Day ' + (i + 1))}
                    <br><span style="font-size:11px; color:#64748b;">${(day.exercises || []).length} exercises</span>
                </button>`;
            });
            html += '</div>';
            body.innerHTML = html;
        }

        async function acAddProgramDayToDate(program, dayIndex, dateStr) {
            acCloseAddWorkoutModal();

            const day = program.program_data.days[dayIndex];
            if (!day) return;

            const exercises = (day.exercises || []).map(ex => ({
                id: ex.id,
                name: ex.name,
                muscle_group: ex.muscle_group,
                equipment: ex.equipment,
                thumbnail_url: ex.thumbnail_url,
                animation_url: ex.animation_url,
                video_url: ex.video_url,
                sets: ex.sets || 3,
                reps: ex.reps || '10',
                restSeconds: ex.restSeconds || 60,
                trackingType: ex.trackingType || 'reps',
                notes: ex.notes || ''
            }));

            const name = `${program.name} - ${day.name || 'Day ' + (dayIndex + 1)}`;

            try {
                await fetch('/.netlify/functions/adhoc-workouts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientId,
                        workoutDate: dateStr,
                        name,
                        workoutData: { exercises }
                    })
                });

                acAssignmentCache[dateStr] = true;
                acRenderCalendar();
                acSelectDay(dateStr);
            } catch (err) {
                console.error('Error adding program workout:', err);
                alert('Failed to add workout from program');
            }
        }

        // ============ EXERCISE DETAIL MODAL ============

        function acOpenExerciseDetail(exIndex, assignmentId, dayIndex, isAdhoc, dateStr) {
            const bodyEl = document.getElementById('acDetailBody');
            const workout = JSON.parse(bodyEl.dataset.workout || '{}');
            const exercises = workout.workout_data?.exercises || [];
            const ex = exercises[exIndex];
            if (!ex) return;

            const modal = document.getElementById('acExerciseDetailModal');
            modal.dataset.exIndex = exIndex;
            modal.dataset.assignmentId = assignmentId;
            modal.dataset.dayIndex = dayIndex;
            modal.dataset.isAdhoc = isAdhoc;
            modal.dataset.dateStr = dateStr;

            document.getElementById('acExdTitle').textContent = ex.name || 'Exercise';

            const imgSrc = ex.animation_url || ex.video_url || ex.thumbnail_url || '';
            const trackingType = ex.trackingType || 'reps';

            let setsData = [];
            if (ex.setsData && Array.isArray(ex.setsData)) {
                setsData = ex.setsData;
            } else {
                const numSets = ex.sets || 3;
                const reps = parseInt(ex.reps) || 10;
                for (let i = 0; i < numSets; i++) {
                    setsData.push({ reps, weight: 0, weightUnit: 'lbs' });
                }
            }

            let html = '';

            if (imgSrc) {
                html += `<div class="ac-exd-video-area">
                    <img src="${imgSrc}" alt="${escapeHtml(ex.name || '')}" onerror="this.parentElement.style.display='none'">
                </div>`;
            }

            html += `<div class="ac-exd-tracking-toggle">
                <label><input type="radio" name="acExdTracking" value="reps" ${trackingType === 'reps' ? 'checked' : ''} onchange="acUpdateTrackingType('reps')"> Repetition-based</label>
                <label><input type="radio" name="acExdTracking" value="time" ${trackingType === 'time' ? 'checked' : ''} onchange="acUpdateTrackingType('time')"> Time-based</label>
            </div>`;

            const repsLabel = trackingType === 'time' ? 'Duration (s)' : 'Reps (x)';
            html += `<div class="ac-exd-sets-area" id="acExdSetsArea">`;

            html += `<div style="margin-bottom:8px;">
                <label style="font-size:13px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">${repsLabel}</label>
                <div style="display:flex; gap:6px; flex-wrap:wrap;" id="acExdRepsRow">`;
            for (let i = 0; i < Math.max(setsData.length, 1); i++) {
                html += `<input class="ac-exd-set-input" type="number" value="${setsData[i]?.reps || 0}" style="width:60px;" data-set="${i}" data-field="reps" min="0">`;
            }
            for (let i = setsData.length; i < 10; i++) {
                html += `<input class="ac-exd-set-input" type="number" value="0" style="width:60px; opacity:0.4;" data-set="${i}" data-field="reps" min="0" onfocus="this.style.opacity=1" onblur="if(!this.value||this.value==='0')this.style.opacity=0.4">`;
            }
            html += `</div></div>`;

            html += `<div style="margin-bottom:8px;">
                <label style="font-size:13px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">Weight (lbs)</label>
                <div style="display:flex; gap:6px; flex-wrap:wrap;" id="acExdWeightRow">`;
            for (let i = 0; i < Math.max(setsData.length, 1); i++) {
                html += `<input class="ac-exd-set-input" type="number" value="${setsData[i]?.weight || ''}" style="width:60px;" data-set="${i}" data-field="weight" min="0" step="0.5" placeholder="">`;
            }
            for (let i = setsData.length; i < 10; i++) {
                html += `<input class="ac-exd-set-input" type="number" value="" style="width:60px; opacity:0.4;" data-set="${i}" data-field="weight" min="0" step="0.5" placeholder="" onfocus="this.style.opacity=1" onblur="if(!this.value)this.style.opacity=0.4">`;
            }
            html += `</div></div>`;

            html += '</div>';

            html += `<div class="ac-exd-calories">
                <label>Calories (Kcal)</label>
                <input class="ac-exd-set-input" type="number" id="acExdCalories" value="${ex.calories || ''}" style="width:80px;" min="0">
            </div>`;

            html += `<div class="ac-exd-tabs">
                <button class="ac-exd-tab active" onclick="acExdSwitchTab('progress', this)">Progress</button>
                <button class="ac-exd-tab" onclick="acExdSwitchTab('history', this)">History</button>
                <button class="ac-exd-tab" onclick="acExdSwitchTab('instructions', this)">Instructions</button>
                <button class="ac-exd-tab" onclick="acExdSwitchTab('details', this)">Details</button>
            </div>`;

            html += `<div class="ac-exd-tab-content" id="acExdTabContent">
                <p style="color:#94a3b8; text-align:center; padding:16px;">Loading progress data...</p>
            </div>`;

            html += `<div class="ac-exd-actions">
                <button class="ac-action-btn" onclick="acCloseExerciseDetail()">Cancel</button>
                <button class="ac-set-save-btn" style="width:auto; margin:0; flex:1;" onclick="acSaveExerciseDetail()">Save Changes</button>
            </div>`;

            document.getElementById('acExdBody').innerHTML = html;
            modal.classList.add('active');

            acLoadExerciseHistory(ex.id || ex.name);
        }

        function acCloseExerciseDetail() {
            document.getElementById('acExerciseDetailModal').classList.remove('active');
        }

        function acUpdateTrackingType(type) {
            const label = type === 'time' ? 'Duration (s)' : 'Reps (x)';
            const setsArea = document.getElementById('acExdSetsArea');
            if (setsArea) {
                const firstLabel = setsArea.querySelector('label');
                if (firstLabel) firstLabel.textContent = label;
            }
        }

        function acExdSwitchTab(tab, btn) {
            document.querySelectorAll('.ac-exd-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');

            const content = document.getElementById('acExdTabContent');
            const modal = document.getElementById('acExerciseDetailModal');
            const bodyEl = document.getElementById('acDetailBody');
            const workout = JSON.parse(bodyEl.dataset.workout || '{}');
            const exIndex = parseInt(modal.dataset.exIndex);
            const ex = (workout.workout_data?.exercises || [])[exIndex];

            switch(tab) {
                case 'progress':
                    content.innerHTML = '<p style="color:#94a3b8; text-align:center; padding:16px;">Loading...</p>';
                    if (ex) acLoadExerciseHistory(ex.id || ex.name);
                    break;
                case 'history':
                    content.innerHTML = '<div class="ac-loading"><div class="ac-spinner"></div></div>';
                    if (ex) acLoadExerciseHistory(ex.id || ex.name);
                    break;
                case 'instructions':
                    content.innerHTML = `<div style="padding:8px;">
                        <textarea style="width:100%; min-height:80px; padding:10px; border:1px solid #e2e8f0; border-radius:8px; font-size:13px; resize:vertical;"
                            id="acExdInstructions" placeholder="Add exercise instructions or notes...">${escapeHtml(ex?.notes || '')}</textarea>
                    </div>`;
                    break;
                case 'details':
                    content.innerHTML = `<div style="padding:8px; font-size:13px; color:#64748b;">
                        <p><strong>Muscle Group:</strong> ${ex?.muscle_group || 'N/A'}</p>
                        <p><strong>Equipment:</strong> ${ex?.equipment || 'N/A'}</p>
                        <p><strong>Rest Time:</strong> ${ex?.restSeconds || 60}s</p>
                        <div style="margin-top:12px;">
                            <label style="font-weight:600;">Rest (seconds):</label>
                            <input class="ac-exd-set-input" type="number" id="acExdRestTime" value="${ex?.restSeconds || 60}" style="width:80px; margin-left:8px;" min="0">
                        </div>
                    </div>`;
                    break;
            }
        }

        async function acLoadExerciseHistory(exerciseIdOrName) {
            try {
                const res = await fetch(`/.netlify/functions/workout-logs?clientId=${clientId}&limit=30`);
                const data = await res.json();
                const logs = data.workouts || data.logs || [];

                const history = [];
                logs.forEach(log => {
                    (log.exercises || []).forEach(ex => {
                        const nameMatch = (ex.exercise_name || '').toLowerCase() === (exerciseIdOrName || '').toLowerCase() ||
                                          ex.exercise_id === exerciseIdOrName;
                        if (nameMatch) {
                            history.push({
                                date: log.workout_date,
                                sets: ex.sets_data || [],
                                maxWeight: ex.max_weight || 0,
                                totalVolume: ex.total_volume || 0
                            });
                        }
                    });
                });

                const content = document.getElementById('acExdTabContent');
                if (!content) return;

                if (history.length === 0) {
                    content.innerHTML = '<p style="color:#94a3b8; text-align:center; padding:16px;">No history found for this exercise yet.</p>';
                    return;
                }

                let html = '';
                history.slice(0, 10).forEach(h => {
                    const dateStr = new Date(h.date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const setsStr = (h.sets || []).map(s => `${s.reps || 0}x${s.weight || 0}`).join(', ');
                    html += `<div class="ac-exd-history-item">
                        <span style="font-weight:600; color:#334155;">${dateStr}</span>
                        <span style="color:#64748b;">${setsStr || 'No data'}</span>
                        <span style="color:#0369a1; font-weight:600;">${h.maxWeight ? h.maxWeight + ' lbs max' : ''}</span>
                    </div>`;
                });

                content.innerHTML = html;
            } catch (err) {
                console.error('Error loading exercise history:', err);
            }
        }

        async function acSaveExerciseDetail() {
            const modal = document.getElementById('acExerciseDetailModal');
            const exIndex = parseInt(modal.dataset.exIndex);
            const assignmentId = modal.dataset.assignmentId;
            const dayIndex = parseInt(modal.dataset.dayIndex);
            const isAdhoc = modal.dataset.isAdhoc === 'true';
            const dateStr = modal.dataset.dateStr;

            const bodyEl = document.getElementById('acDetailBody');
            const workout = JSON.parse(bodyEl.dataset.workout || '{}');
            const exercises = workout.workout_data?.exercises || [];
            const ex = exercises[exIndex];
            if (!ex) return;

            const repsInputs = document.querySelectorAll('#acExdRepsRow input');
            const weightInputs = document.querySelectorAll('#acExdWeightRow input');
            const newSetsData = [];

            repsInputs.forEach((input, i) => {
                const reps = parseInt(input.value) || 0;
                const weight = parseFloat(weightInputs[i]?.value) || 0;
                if (reps > 0 || weight > 0) {
                    newSetsData.push({
                        setNumber: newSetsData.length + 1,
                        reps,
                        weight,
                        weightUnit: 'lbs'
                    });
                }
            });

            const trackingRadio = document.querySelector('input[name="acExdTracking"]:checked');
            ex.trackingType = trackingRadio ? trackingRadio.value : 'reps';

            ex.sets = newSetsData.length || ex.sets;
            ex.reps = (newSetsData[0]?.reps || ex.reps || 0).toString();
            ex.setsData = newSetsData.length > 0 ? newSetsData : ex.setsData;

            const caloriesInput = document.getElementById('acExdCalories');
            if (caloriesInput) ex.calories = parseInt(caloriesInput.value) || 0;

            const instructionsInput = document.getElementById('acExdInstructions');
            if (instructionsInput) ex.notes = instructionsInput.value;

            const restInput = document.getElementById('acExdRestTime');
            if (restInput) ex.restSeconds = parseInt(restInput.value) || 60;

            exercises[exIndex] = ex;

            acCloseExerciseDetail();
            await acSaveExercises(exercises, assignmentId, dayIndex, isAdhoc, dateStr);
        }

        // ---- Delete Workout from Date ----
        async function acDeleteWorkout(assignmentId, isAdhoc, dateStr) {
            if (!confirm('Delete this workout from ' + dateStr + '?')) return;

            try {
                if (isAdhoc) {
                    await fetch(`/.netlify/functions/adhoc-workouts?workoutId=${assignmentId}`, {
                        method: 'DELETE'
                    });
                } else {
                    await fetch('/.netlify/functions/client-workout-log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            assignmentId,
                            action: 'skip',
                            targetDate: dateStr
                        })
                    });
                }

                delete acAssignmentCache[dateStr];
                acRenderCalendar();
                acSelectDay(dateStr);
            } catch (err) {
                console.error('Error deleting workout:', err);
                alert('Failed to delete workout');
            }
        }

        // Initialize the activity calendar when data loads
        if (clientId) {
            setTimeout(() => acInit(), 500);
        }

        // ============ WORKOUT PROGRESS FUNCTIONS ============

        // --- Client Notes & Voice Notes Section ---
        async function loadClientNotes(cId) {
            if (!cId) return;
            const container = document.getElementById('clientNotesContainer');
            if (!container) return;

            try {
                const res = await fetch(`/.netlify/functions/coach-workout-feed?coachId=${window.coachUserId || ''}&clientId=${cId}&limit=100`);
                const data = await res.json();
                const workouts = data.feed || [];

                // Collect all notes (text and voice) across all workouts
                const notes = [];
                workouts.forEach(w => {
                    (w.exercises || []).forEach(ex => {
                        if (ex.clientNotes || ex.clientVoiceNotePath) {
                            notes.push({
                                exerciseName: ex.exerciseName || 'Exercise',
                                workoutName: w.workoutName || 'Workout',
                                workoutDate: w.workoutDate,
                                clientNotes: ex.clientNotes,
                                clientVoiceNotePath: ex.clientVoiceNotePath
                            });
                        }
                    });
                });

                if (notes.length === 0) {
                    container.innerHTML = `
                        <div class="cn-empty">
                            <div class="cn-empty-icon"></div>
                            <p>No client notes yet</p>
                            <span style="font-size: 13px;">When your client leaves text or voice notes during workouts, they'll appear here.</span>
                        </div>`;
                    return;
                }

                // Fetch signed URLs for all voice notes
                const voicePaths = notes.filter(n => n.clientVoiceNotePath).map(n => n.clientVoiceNotePath);
                let voiceUrls = {};
                if (voicePaths.length > 0) {
                    try {
                        const urlRes = await fetch('/.netlify/functions/get-signed-urls', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filePaths: voicePaths, coachId: window.coachUserId || '' })
                        });
                        const urlData = await urlRes.json();
                        voiceUrls = urlData.signedUrls || {};
                    } catch (e) {
                        console.warn('Could not fetch voice URLs for notes section:', e);
                    }
                }

                // Render notes
                container.innerHTML = notes.map(note => {
                    const dateStr = note.workoutDate
                        ? new Date(note.workoutDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                        : '';

                    let textHtml = '';
                    if (note.clientNotes && note.clientNotes.trim()) {
                        textHtml = `<div class="cn-text-note"> ${escapeHtml(note.clientNotes)}</div>`;
                    }

                    let voiceHtml = '';
                    if (note.clientVoiceNotePath) {
                        const url = voiceUrls[note.clientVoiceNotePath];
                        voiceHtml = url
                            ? `<div class="cn-voice-note">
                                <span class="cn-voice-label"> Voice Note</span>
                                <audio controls preload="metadata" src="${url}"></audio>
                              </div>`
                            : `<div class="cn-voice-note">
                                <span class="cn-voice-label"> Voice Note</span>
                                <em style="color: #94a3b8; font-size: 13px;">Unable to load</em>
                              </div>`;
                    }

                    const badges = [];
                    if (note.clientVoiceNotePath) badges.push('<span class="cn-badge cn-badge--voice"> Voice</span>');
                    if (note.clientNotes && note.clientNotes.trim()) badges.push('<span class="cn-badge cn-badge--text"> Text</span>');

                    return `
                        <div class="cn-note-card">
                            <div class="cn-note-header">
                                <span class="cn-note-exercise">${escapeHtml(note.exerciseName)}</span>
                                <span class="cn-note-meta">${dateStr}</span>
                            </div>
                            <div class="cn-note-workout">${escapeHtml(note.workoutName)} ${badges.join(' ')}</div>
                            ${textHtml}
                            ${voiceHtml}
                        </div>`;
                }).join('');

            } catch (err) {
                console.error('Error loading client notes:', err);
                container.innerHTML = '<p style="color: #ef4444; padding: 12px;">Failed to load notes</p>';
            }
        }

        let workoutDateOffset = 0;
        let allFeedWorkouts = []; // cache all fetched workouts for cross-week comparison

        function changeWorkoutDateRange(days) {
            workoutDateOffset += days;
            loadWorkoutLogs(clientId);
        }

        async function loadWorkoutLogs(clientId) {
            if (!clientId) return;
            const container = document.getElementById('workoutLogsContainer');
            const emptyState = document.getElementById('workoutEmptyState');
            const dateLabel = document.getElementById('workoutDateRange');
            const summaryEl = document.getElementById('workoutWeeklySummary');
            const fatigueEl = document.getElementById('workoutFatigueAlert');
            const missedEl = document.getElementById('workoutMissedDays');

            // Calculate date range
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + workoutDateOffset);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 6);

            const startStr = startDate.toISOString().split('T')[0];
            const endStr = endDate.toISOString().split('T')[0];

            dateLabel.textContent = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;

            container.innerHTML = '<div class="loading skeleton-loading"><div class="skeleton" style="height: 80px; margin-bottom: 12px; border-radius: 10px;"></div></div>';
            emptyState.style.display = 'none';
            summaryEl.innerHTML = '';
            fatigueEl.innerHTML = '';
            missedEl.innerHTML = '';

            try {
                const res = await fetch(`/.netlify/functions/coach-workout-feed?coachId=${window.coachUserId || ''}&clientId=${clientId}&limit=50`);
                const data = await res.json();

                allFeedWorkouts = data.feed || data.workouts || [];
                if (allFeedWorkouts.length === 0) {
                    container.innerHTML = '';
                    emptyState.style.display = 'flex';
                    return;
                }

                // Current week workouts
                const workouts = allFeedWorkouts.filter(w => w.workoutDate >= startStr && w.workoutDate <= endStr);

                // Previous week for comparison
                const prevEnd = new Date(startDate);
                prevEnd.setDate(prevEnd.getDate() - 1);
                const prevStart = new Date(prevEnd);
                prevStart.setDate(prevStart.getDate() - 6);
                const prevStartStr = prevStart.toISOString().split('T')[0];
                const prevEndStr = prevEnd.toISOString().split('T')[0];
                const prevWorkouts = allFeedWorkouts.filter(w => w.workoutDate >= prevStartStr && w.workoutDate <= prevEndStr);

                // Build previous week exercise map for comparison
                const prevExerciseMap = {};
                prevWorkouts.forEach(w => {
                    (w.exercises || []).forEach(ex => {
                        const name = (ex.exerciseName || '').toLowerCase();
                        if (!prevExerciseMap[name]) prevExerciseMap[name] = { maxWeight: 0, totalVolume: 0, sets: [] };
                        if (ex.maxWeight > prevExerciseMap[name].maxWeight) prevExerciseMap[name].maxWeight = ex.maxWeight;
                        prevExerciseMap[name].totalVolume += (ex.totalVolume || 0);
                        const sd = typeof ex.setsData === 'string' ? JSON.parse(ex.setsData) : (ex.setsData || []);
                        prevExerciseMap[name].sets.push(...sd);
                    });
                });

                // Render weekly summary
                summaryEl.innerHTML = renderWeeklySummary(workouts, prevWorkouts, startDate, endDate);

                // Render fatigue indicator
                fatigueEl.innerHTML = renderFatigueAlert(workouts);

                // Fetch missed workouts from assignments
                missedEl.innerHTML = await renderMissedWorkouts(clientId, startDate, endDate, workouts);

                if (workouts.length === 0) {
                    container.innerHTML = '';
                    emptyState.style.display = 'flex';
                    return;
                }

                emptyState.style.display = 'none';

                // Resolve voice note signed URLs
                const voicePaths = [];
                workouts.forEach(w => {
                    (w.exercises || []).forEach(ex => {
                        if (ex.clientVoiceNotePath) voicePaths.push(ex.clientVoiceNotePath);
                    });
                });
                let voiceUrls = {};
                if (voicePaths.length > 0) {
                    try {
                        const urlRes = await fetch('/.netlify/functions/get-signed-urls', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filePaths: voicePaths, coachId: window.coachUserId || '' })
                        });
                        const urlData = await urlRes.json();
                        voiceUrls = urlData.signedUrls || {};
                    } catch (e) {
                        console.error('Error fetching voice URLs:', e);
                    }
                }

                container.innerHTML = workouts.map(w => renderWorkoutCard(w, voiceUrls, prevExerciseMap)).join('');

            } catch (err) {
                console.error('Error loading workout logs:', err);
                container.innerHTML = '<p style="color: #ef4444; padding: 12px;">Failed to load workout data</p>';
            }
        }

        // ---- Weekly Summary Banner ----
        function renderWeeklySummary(workouts, prevWorkouts, startDate, endDate) {
            const totalWorkouts = workouts.length;
            const totalVolume = workouts.reduce((s, w) => s + (w.totalVolume || 0), 0);
            const totalSets = workouts.reduce((s, w) => s + (w.totalSets || 0), 0);
            const prevVolume = prevWorkouts.reduce((s, w) => s + (w.totalVolume || 0), 0);

            // Average RPE across all sets
            let rpeSum = 0, rpeCount = 0;
            workouts.forEach(w => {
                (w.exercises || []).forEach(ex => {
                    const sd = typeof ex.setsData === 'string' ? JSON.parse(ex.setsData) : (ex.setsData || []);
                    sd.forEach(s => { if (s.rpe) { rpeSum += s.rpe; rpeCount++; } });
                });
            });
            const avgRpe = rpeCount > 0 ? (rpeSum / rpeCount).toFixed(1) : '';
            const rpeClass = avgRpe === '' ? '' : (avgRpe <= 6 ? 'good' : avgRpe <= 8 ? 'warning' : 'danger');

            // Volume change vs previous week
            let volChangeHtml = '';
            if (prevVolume > 0 && totalVolume > 0) {
                const pct = (((totalVolume - prevVolume) / prevVolume) * 100).toFixed(1);
                const cls = pct > 0 ? 'good' : 'danger';
                const sign = pct > 0 ? '+' : '';
                volChangeHtml = `<span class="wp-summary-value ${cls}" style="font-size:14px;">${sign}${pct}%</span>`;
            }

            // Workout streak (consecutive days from today backwards with a logged workout)
            const workoutDates = new Set(workouts.map(w => w.workoutDate));
            const allDates = new Set(allFeedWorkouts.map(w => w.workoutDate));
            let streak = 0;
            const checkDate = new Date();
            for (let i = 0; i < 30; i++) {
                const ds = checkDate.toISOString().split('T')[0];
                if (allDates.has(ds)) { streak++; } else if (i > 0) { break; }
                checkDate.setDate(checkDate.getDate() - 1);
            }

            // 7-day dot visualization
            let dotsHtml = '';
            for (let i = 6; i >= 0; i--) {
                const d = new Date(startDate);
                d.setDate(d.getDate() + (6 - i));
                const ds = d.toISOString().split('T')[0];
                const cls = workoutDates.has(ds) ? 'active' : '';
                dotsHtml += `<span class="wp-streak-dot ${cls}"></span>`;
            }

            // Client notes count
            let notesCount = 0;
            workouts.forEach(w => (w.exercises || []).forEach(ex => {
                if (ex.clientNotes || ex.clientVoiceNotePath) notesCount++;
            }));

            // Adherence percentage
            const adherencePct = totalWorkouts > 0 ? Math.min(100, Math.round((totalWorkouts / 7) * 100)) : 0;
            const adhCls = adherencePct >= 70 ? 'good' : adherencePct >= 40 ? 'ok' : 'low';

            return `
                <div class="wp-weekly-summary">
                    <div class="wp-summary-stat">
                        <span class="wp-summary-value">${totalWorkouts}</span>
                        <span class="wp-summary-label">Workouts</span>
                        <div class="wp-streak-dots">${dotsHtml}</div>
                    </div>
                    <div class="wp-summary-stat">
                        <span class="wp-summary-value">${Number(totalVolume).toLocaleString()}</span>
                        <span class="wp-summary-label">Total Vol (kg)</span>
                        ${volChangeHtml}
                    </div>
                    <div class="wp-summary-stat">
                        <span class="wp-summary-value">${totalSets}</span>
                        <span class="wp-summary-label">Total Sets</span>
                    </div>
                    <div class="wp-summary-stat">
                        <span class="wp-summary-value ${rpeClass}">${avgRpe}</span>
                        <span class="wp-summary-label">Avg RPE</span>
                    </div>
                    <div class="wp-summary-stat">
                        <span class="wp-summary-value">${streak}</span>
                        <span class="wp-summary-label">Day Streak</span>
                    </div>
                    ${notesCount > 0 ? `<div class="wp-summary-stat"><span class="wp-summary-value" style="color:#7c3aed;">${notesCount}</span><span class="wp-summary-label">Client Notes</span></div>` : ''}
                </div>
            `;
        }

        // ---- Fatigue / Readiness Alert ----
        function renderFatigueAlert(workouts) {
            if (workouts.length < 2) return '';

            let rpeValues = [];
            let volumes = [];
            workouts.forEach(w => {
                let wRpe = [];
                (w.exercises || []).forEach(ex => {
                    const sd = typeof ex.setsData === 'string' ? JSON.parse(ex.setsData) : (ex.setsData || []);
                    sd.forEach(s => { if (s.rpe) wRpe.push(s.rpe); });
                });
                if (wRpe.length > 0) rpeValues.push(wRpe.reduce((a, b) => a + b, 0) / wRpe.length);
                volumes.push(w.totalVolume || 0);
            });

            if (rpeValues.length < 2) return '';

            const avgRpe = rpeValues.reduce((a, b) => a + b, 0) / rpeValues.length;
            const lastVol = volumes[0] || 0;
            const prevVol = volumes[1] || 0;
            const volumeDropping = prevVol > 0 && lastVol < prevVol * 0.85;

            // High RPE + dropping volume = fatigue
            if (avgRpe >= 8.5 && volumeDropping) {
                return `<div class="wp-fatigue-alert high"> <strong>High fatigue detected</strong>  Avg RPE ${avgRpe.toFixed(1)} with declining volume. Consider a deload or recovery focus.</div>`;
            }
            if (avgRpe >= 7.5) {
                return `<div class="wp-fatigue-alert moderate"> <strong>Moderate load</strong>  Avg RPE ${avgRpe.toFixed(1)}. Client is pushing hard. Monitor for overreaching.</div>`;
            }
            if (avgRpe <= 5.5 && avgRpe > 0) {
                return `<div class="wp-fatigue-alert fresh"> <strong>Fresh & recovered</strong>  Avg RPE ${avgRpe.toFixed(1)}. Client has room to push harder.</div>`;
            }
            return '';
        }

        // ---- Missed Workout Alerts ----
        async function renderMissedWorkouts(clientId, startDate, endDate, workouts) {
            try {
                const res = await fetch(`/.netlify/functions/workout-assignments?clientId=${clientId}&date=${startDate.toISOString().split('T')[0]}`);
                const data = await res.json();
                const assignment = data?.assignments?.[0];
                if (!assignment?.workout_data) return '';

                const schedule = assignment.workout_data.schedule || {};
                const scheduledDays = schedule.days || schedule.scheduleDays || [];
                if (scheduledDays.length === 0) return '';

                // Map day names to day numbers (0=Sun, 1=Mon, etc.)
                const dayMap = { sunday: 0, monday: 1, tuesday: 2, wednesday: 3, thursday: 4, friday: 5, saturday: 6 };
                const scheduledDayNums = scheduledDays.map(d => dayMap[d.toLowerCase()] ?? -1).filter(n => n >= 0);

                const workoutDates = new Set(workouts.map(w => w.workoutDate));
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const missed = [];

                for (let d = new Date(startDate); d <= endDate && d <= today; d.setDate(d.getDate() + 1)) {
                    const dayNum = d.getDay();
                    const dateStr = d.toISOString().split('T')[0];
                    if (scheduledDayNums.includes(dayNum) && !workoutDates.has(dateStr)) {
                        missed.push(d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }));
                    }
                }

                if (missed.length === 0) return '';
                return `<div class="wp-missed-workouts">${missed.map(d =>
                    `<div class="wp-missed-day"> Missed scheduled workout: <strong>${d}</strong></div>`
                ).join('')}</div>`;
            } catch (err) {
                console.error('Error checking missed workouts:', err);
                return '';
            }
        }

        // ---- Workout Card ----
        function renderWorkoutCard(workout, voiceUrls, prevExerciseMap) {
            const dateObj = new Date(workout.workoutDate + 'T12:00:00');
            const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const vol = workout.totalVolume ? Number(workout.totalVolume).toLocaleString() : '0';
            const improvements = workout.improvements || {};

            let improvementHtml = '';
            if (improvements.volumeChange != null && improvements.volumeChange !== 0) {
                const cls = improvements.volumeChange > 0 ? 'improvement-positive' : 'improvement-negative';
                const sign = improvements.volumeChange > 0 ? '+' : '';
                improvementHtml += `<span class="${cls}">${sign}${improvements.volumeChange}% volume</span>`;
            }
            if (improvements.newPRs > 0) {
                improvementHtml += `<span class="improvement-positive"> ${improvements.newPRs} PR${improvements.newPRs > 1 ? 's' : ''}</span>`;
            }

            const hasNotes = workout.hasClientNotes;

            // Calculate average RPE for this workout
            let rpeSum = 0, rpeCount = 0;
            (workout.exercises || []).forEach(ex => {
                const sd = typeof ex.setsData === 'string' ? JSON.parse(ex.setsData) : (ex.setsData || []);
                sd.forEach(s => { if (s.rpe) { rpeSum += s.rpe; rpeCount++; } });
            });
            let avgRpeHtml = '';
            if (rpeCount > 0) {
                const avg = (rpeSum / rpeCount).toFixed(1);
                const cls = avg <= 6 ? 'low' : avg <= 8 ? 'moderate' : 'high';
                avgRpeHtml = `<span class="wp-avg-rpe ${cls}">RPE ${avg}</span>`;
            }

            const exercisesHtml = (workout.exercises || []).map(ex => {
                const setsData = typeof ex.setsData === 'string' ? JSON.parse(ex.setsData) : (ex.setsData || []);

                let setsHtml = '';
                if (setsData.length > 0) {
                    setsHtml = '<div class="wp-sets">' + setsData.map(s => {
                        const label = s.isTimeBased
                            ? `${s.reps || 0}s`
                            : `${s.reps || 0}${s.weight || 0}${s.weightUnit || 'kg'}`;
                        const rpe = s.rpe ? `<span class="wp-rpe">RPE ${s.rpe}</span>` : '';
                        return `<span class="wp-set-pill">${label}${rpe}</span>`;
                    }).join('') + '</div>';
                }

                // Exercise comparison vs previous week
                let comparisonHtml = '';
                const name = (ex.exerciseName || '').toLowerCase();
                const prev = prevExerciseMap[name];
                if (prev && prev.maxWeight > 0) {
                    const diff = (ex.maxWeight || 0) - prev.maxWeight;
                    if (diff > 0) {
                        comparisonHtml = `<div class="wp-exercise-comparison"><span class="wp-compare-up"> +${diff} kg vs last week</span></div>`;
                    } else if (diff < 0) {
                        comparisonHtml = `<div class="wp-exercise-comparison"><span class="wp-compare-down"> ${diff} kg vs last week</span></div>`;
                    } else {
                        comparisonHtml = `<div class="wp-exercise-comparison"><span class="wp-compare-same"> Same weight as last week</span></div>`;
                    }
                }

                let noteHtml = '';
                if (ex.clientNotes) {
                    noteHtml = `<div class="wp-client-note"> ${escapeHtml(ex.clientNotes)}</div>`;
                }

                let voiceHtml = '';
                if (ex.clientVoiceNotePath) {
                    const url = voiceUrls[ex.clientVoiceNotePath];
                    voiceHtml = url
                        ? `<div class="wp-voice-note"> <audio controls src="${url}" preload="metadata" style="height: 32px; width: 100%; max-width: 250px;"></audio></div>`
                        : `<div class="wp-voice-note"> <em style="color: #6b7280;">Voice note</em></div>`;
                }

                const prBadge = ex.isPr ? '<span class="wp-pr-badge">PR</span>' : '';
                const maxW = ex.maxWeight > 0 ? `<span class="wp-max-weight">${ex.maxWeight} kg max</span>` : '';

                return `
                    <div class="wp-exercise">
                        <div class="wp-exercise-header">
                            <span class="wp-exercise-name">${escapeHtml(ex.exerciseName || '')}</span>
                            <div class="wp-exercise-badges">${maxW}${prBadge}</div>
                        </div>
                        ${setsHtml}
                        ${comparisonHtml}
                        ${noteHtml}
                        ${voiceHtml}
                    </div>
                `;
            }).join('');

            return `
                <div class="wp-card">
                    <div class="wp-card-header">
                        <div class="wp-card-date">${dateStr}</div>
                        <div class="wp-card-stats">
                            ${avgRpeHtml}
                            <span>${vol} kg vol</span>
                            <span>${workout.totalSets || 0} sets</span>
                            ${hasNotes ? '<span class="wp-has-notes"> Notes</span>' : ''}
                        </div>
                    </div>
                    ${improvementHtml ? `<div class="wp-improvements">${improvementHtml}</div>` : ''}
                    <div class="wp-exercises">${exercisesHtml}</div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // AI Workout Insights
        function askWorkoutQuickQuestion(question) {
            document.getElementById('workoutAiQuestion').value = question;
            askWorkoutAI();
        }

        async function askWorkoutAI() {
            const questionInput = document.getElementById('workoutAiQuestion');
            const question = questionInput.value.trim();
            if (!question) return;

            const responseContainer = document.getElementById('workoutAiResponseContainer');
            const responseText = document.getElementById('workoutAiResponseText');
            const loadingEl = document.getElementById('workoutAiLoading');
            const askBtn = document.getElementById('workoutAiAskBtn');

            responseContainer.style.display = 'none';
            loadingEl.style.display = 'flex';
            askBtn.disabled = true;
            askBtn.textContent = 'Analyzing...';

            try {
                const response = await fetch('/.netlify/functions/coach-workout-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientId: clientId,
                        question: question,
                        clientName: currentClientName
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to get AI response');

                responseText.textContent = data.response;
                responseContainer.style.display = 'block';
            } catch (error) {
                console.error('Workout AI error:', error);
                responseText.textContent = 'Sorry, I encountered an error analyzing the workout data. Please try again.';
                responseContainer.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
                askBtn.disabled = false;
                askBtn.textContent = 'Ask AI';
            }
        }

        // ============ WORKOUT CALENDAR FUNCTIONS ============
        let calendarMonth = new Date().getMonth();
        let calendarYear = new Date().getFullYear();
        let calendarWorkoutData = {}; // { 'YYYY-MM-DD': { status, exercises, workoutName } }
        let calendarAssignment = null;
        let selectedCalendarDate = null;

        function changeCalendarMonth(delta) {
            calendarMonth += delta;
            if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
            if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
            loadWorkoutCalendar(clientId);
        }

        async function loadWorkoutCalendar(cId) {
            if (!cId) return;

            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            document.getElementById('calendarMonthLabel').textContent = `${monthNames[calendarMonth]} ${calendarYear}`;

            // Get first and last day of month
            const firstDay = new Date(calendarYear, calendarMonth, 1);
            const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
            const startStr = firstDay.toISOString().split('T')[0];
            const endStr = lastDay.toISOString().split('T')[0];

            try {
                // Fetch workout logs and assignments in parallel
                const coachId = window.coachUserId || currentUser?.id;
                const [logsRes, assignRes] = await Promise.all([
                    fetch(`/.netlify/functions/coach-workout-feed?coachId=${coachId}&clientId=${cId}&limit=100`),
                    fetch(`/.netlify/functions/workout-assignments?clientId=${cId}&activeOnly=true`)
                ]);

                const logsData = await logsRes.json();
                const assignData = await assignRes.json();

                const workouts = logsData.feed || logsData.workouts || [];
                calendarAssignment = (assignData.assignments || [])[0] || null;

                // Build workout data map
                calendarWorkoutData = {};
                workouts.forEach(w => {
                    const date = w.workoutDate || w.workout_date;
                    if (date) {
                        calendarWorkoutData[date] = {
                            status: w.status || 'completed',
                            exercises: w.exercises || [],
                            workoutName: w.workoutName || w.workout_name || 'Workout',
                            totalVolume: w.totalVolume || w.total_volume || 0,
                            totalSets: w.totalSets || w.total_sets || 0,
                            duration: w.durationMinutes || w.duration_minutes || 0
                        };
                    }
                });

                // Determine scheduled days from assignment
                if (calendarAssignment?.workout_data?.schedule) {
                    const schedule = calendarAssignment.workout_data.schedule;
                    const scheduledDays = schedule.days || schedule.selectedDays || [];
                    const dayMap = { 'sun': 0, 'mon': 1, 'tue': 2, 'wed': 3, 'thu': 4, 'fri': 5, 'sat': 6 };

                    const today = new Date();
                    today.setHours(0,0,0,0);

                    for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                        const dateStr = d.toISOString().split('T')[0];
                        const dayOfWeek = d.getDay();
                        const isScheduled = scheduledDays.some(sd => dayMap[sd.toLowerCase()] === dayOfWeek);

                        if (isScheduled && !calendarWorkoutData[dateStr]) {
                            if (d < today) {
                                calendarWorkoutData[dateStr] = { status: 'missed', exercises: [], workoutName: 'Missed' };
                            } else {
                                calendarWorkoutData[dateStr] = { status: 'scheduled', exercises: [], workoutName: 'Scheduled' };
                            }
                        }
                    }
                }

                renderCalendar();
            } catch (err) {
                console.error('Error loading workout calendar:', err);
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const firstDay = new Date(calendarYear, calendarMonth, 1);
            const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
            const startDayOfWeek = firstDay.getDay(); // 0=Sun
            const today = new Date();
            today.setHours(0,0,0,0);

            // Day headers
            let html = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map(d =>
                `<div class="wc-day-header">${d}</div>`
            ).join('');

            // Adjust for Monday start (0=Mon)
            const adjustedStart = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;

            // Empty cells before first day
            for (let i = 0; i < adjustedStart; i++) {
                html += '<div class="wc-day empty"></div>';
            }

            // Days of the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateObj = new Date(calendarYear, calendarMonth, day);
                const dateStr = dateObj.toISOString().split('T')[0];
                const isToday = dateObj.getTime() === today.getTime();
                const isSelected = selectedCalendarDate === dateStr;
                const data = calendarWorkoutData[dateStr];

                let classes = 'wc-day';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';

                let indicators = '';
                if (data) {
                    indicators = `<div class="wc-day-indicators"><span class="wc-indicator ${data.status}"></span></div>`;
                }

                html += `<div class="${classes}" onclick="selectCalendarDay('${dateStr}')">
                    <span class="wc-day-num">${day}</span>
                    ${indicators}
                </div>`;
            }

            grid.innerHTML = html;
        }

        function selectCalendarDay(dateStr) {
            selectedCalendarDate = dateStr;
            renderCalendar();

            const detailEl = document.getElementById('calendarDayDetail');
            const data = calendarWorkoutData[dateStr];
            const dateObj = new Date(dateStr + 'T12:00:00');
            const dateLabel = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

            if (!data) {
                detailEl.innerHTML = `
                    <div class="wc-day-detail">
                        <div class="wc-detail-header">
                            <span class="wc-detail-date">${dateLabel}</span>
                            <span class="wc-detail-status rest">Rest Day</span>
                        </div>
                        <div class="wc-detail-empty">No workout scheduled or logged for this day.</div>
                    </div>`;
                return;
            }

            const statusLabel = { completed: 'Completed', scheduled: 'Scheduled', missed: 'Missed', in_progress: 'In Progress' };
            const statusClass = data.status === 'in_progress' ? 'scheduled' : data.status;

            let exercisesHtml = '';
            if (data.exercises && data.exercises.length > 0) {
                exercisesHtml = '<div class="wc-detail-exercises">' + data.exercises.map(ex => {
                    const name = ex.exerciseName || ex.exercise_name || ex.name || 'Exercise';
                    const setsData = typeof ex.setsData === 'string' ? JSON.parse(ex.setsData) : (ex.sets_data ? (typeof ex.sets_data === 'string' ? JSON.parse(ex.sets_data) : ex.sets_data) : (ex.setsData || []));
                    const setCount = setsData.length || ex.totalSets || ex.total_sets || 0;
                    const maxW = ex.maxWeight || ex.max_weight || 0;
                    const info = maxW > 0 ? `${setCount} sets - ${maxW} kg max` : `${setCount} sets`;
                    return `<div class="wc-detail-exercise"><span class="wc-detail-ex-name">${escapeHtml(name)}</span><span class="wc-detail-ex-info">${info}</span></div>`;
                }).join('') + '</div>';
            } else if (data.status === 'scheduled') {
                // Try to show planned exercises from the assignment
                exercisesHtml = '<div class="wc-detail-empty">Workout scheduled - not yet started.</div>';
                if (calendarAssignment?.workout_data?.days) {
                    const planned = getPlannedExercisesForDate(dateStr);
                    if (planned && planned.length > 0) {
                        exercisesHtml = '<div class="wc-detail-exercises">' + planned.map(ex => {
                            const sets = ex.sets || 3;
                            const reps = ex.reps || 10;
                            return `<div class="wc-detail-exercise"><span class="wc-detail-ex-name">${escapeHtml(ex.name || 'Exercise')}</span><span class="wc-detail-ex-info">${sets} x ${reps}</span></div>`;
                        }).join('') + '</div>';
                    }
                }
            } else if (data.status === 'missed') {
                exercisesHtml = '<div class="wc-detail-empty">This workout was scheduled but not logged.</div>';
            }

            let statsHtml = '';
            if (data.status === 'completed' || data.status === 'in_progress') {
                const vol = data.totalVolume ? Number(data.totalVolume).toLocaleString() : '0';
                const dur = data.duration ? `${data.duration} min` : '';
                statsHtml = `<div style="display:flex;gap:12px;margin-bottom:10px;font-size:12px;color:#64748b;">
                    <span>${vol} kg volume</span>
                    <span>${data.totalSets || 0} sets</span>
                    ${dur ? `<span>${dur}</span>` : ''}
                </div>`;
            }

            detailEl.innerHTML = `
                <div class="wc-day-detail">
                    <div class="wc-detail-header">
                        <span class="wc-detail-date">${dateLabel}</span>
                        <span class="wc-detail-status ${statusClass}">${statusLabel[data.status] || data.status}</span>
                    </div>
                    ${data.workoutName && data.status !== 'missed' ? `<div style="font-weight:600;font-size:14px;color:#475569;margin-bottom:8px;">${escapeHtml(data.workoutName)}</div>` : ''}
                    ${statsHtml}
                    ${exercisesHtml}
                </div>`;
        }

        function getPlannedExercisesForDate(dateStr) {
            if (!calendarAssignment?.workout_data?.days) return [];
            const schedule = calendarAssignment.workout_data.schedule || {};
            const scheduledDays = schedule.days || schedule.selectedDays || [];
            const dayMap = { 'sun': 0, 'mon': 1, 'tue': 2, 'wed': 3, 'thu': 4, 'fri': 5, 'sat': 6 };
            const startDate = new Date(calendarAssignment.start_date + 'T12:00:00');
            const targetDate = new Date(dateStr + 'T12:00:00');

            // Count workout days from start to target
            let workoutDayCount = 0;
            for (let d = new Date(startDate); d < targetDate; d.setDate(d.getDate() + 1)) {
                const dow = d.getDay();
                if (scheduledDays.some(sd => dayMap[sd.toLowerCase()] === dow)) {
                    workoutDayCount++;
                }
            }

            const days = calendarAssignment.workout_data.days || [];
            if (days.length === 0) return [];
            const dayIndex = workoutDayCount % days.length;
            return days[dayIndex]?.exercises || [];
        }

        // ============ WORKOUT PROGRAMS FUNCTIONS ============
        let coachPrograms = [];
        let clientActiveAssignment = null;

        async function loadWorkoutPrograms(cId) {
            if (!cId || !currentUser) return;

            try {
                const coachId = currentUser.id;
                // Fetch programs and current assignment in parallel
                const [progsRes, assignRes] = await Promise.all([
                    fetch(`/.netlify/functions/workout-programs?coachId=${coachId}`),
                    fetch(`/.netlify/functions/workout-assignments?clientId=${cId}&activeOnly=true`)
                ]);

                const progsData = await progsRes.json();
                const assignData = await assignRes.json();

                coachPrograms = progsData.programs || [];
                clientActiveAssignment = (assignData.assignments || [])[0] || null;

                renderActiveAssignment();
                renderProgramsList();
            } catch (err) {
                console.error('Error loading workout programs:', err);
                document.getElementById('programsListContainer').innerHTML = '<div class="wpr-no-programs">Failed to load programs.</div>';
            }
        }

        function renderActiveAssignment() {
            const container = document.getElementById('activeAssignmentContainer');
            if (!clientActiveAssignment) {
                container.innerHTML = `<div style="padding:16px;text-align:center;color:#94a3b8;font-size:14px;background:#f8fafc;border-radius:10px;border:1px solid #e2e8f0;">
                    No active workout program assigned to this client.
                </div>`;
                return;
            }

            const a = clientActiveAssignment;
            const days = a.workout_data?.days || [];
            const schedule = a.workout_data?.schedule || {};
            const scheduledDays = schedule.days || schedule.selectedDays || [];
            const startDate = a.start_date ? new Date(a.start_date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
            const endDate = a.end_date ? new Date(a.end_date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Ongoing';

            const daysChips = days.map((d, i) => `<button class="wpr-day-chip" onclick="event.stopPropagation(); toggleProgramDay(${i})" data-day-index="${i}">${d.name || 'Day ' + (i+1)}</button>`).join('');

            const daysExercises = days.map((d, i) => {
                const exercises = (d.exercises || []).map((ex, ei) => {
                    const sets = ex.sets || 3;
                    const reps = ex.reps || 10;
                    const weight = ex.weight ? `${ex.weight} kg` : '';
                    return `<div class="wpr-exercise-row">
                        <span class="wpr-ex-name">${escapeHtml(ex.name || 'Exercise')}</span>
                        <span class="wpr-ex-detail">${sets} x ${reps}${weight ? ' @ ' + weight : ''}</span>
                        <div class="wpr-ex-actions">
                            <button class="wpr-ex-btn" onclick="event.stopPropagation(); editExerciseInProgram(${i}, ${ei})" title="Edit"></button>
                            <button class="wpr-ex-btn delete" onclick="event.stopPropagation(); removeExerciseFromProgram(${i}, ${ei})" title="Remove"></button>
                        </div>
                    </div>`;
                }).join('');

                return `<div class="wpr-day-exercises" id="programDay${i}">
                    ${exercises || '<div style="color:#94a3b8;font-size:13px;text-align:center;padding:10px;">No exercises</div>'}
                    <div style="margin-top:8px;text-align:center;">
                        <button class="wpr-btn" onclick="event.stopPropagation(); addExerciseToProgram(${i})" style="font-size:11px;">+ Add Exercise</button>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = `
                <div class="wpr-active-assignment">
                    <span class="wpr-active-badge">Active Program</span>
                    <div class="wpr-active-name">${escapeHtml(a.name || 'Workout Program')}</div>
                    <div class="wpr-active-meta">
                        <span>${days.length} days/week</span>
                        <span>${startDate}  ${endDate}</span>
                        ${scheduledDays.length > 0 ? `<span>Schedule: ${scheduledDays.map(d => d.charAt(0).toUpperCase() + d.slice(1,3)).join(', ')}</span>` : ''}
                    </div>
                    <div class="wpr-active-actions">
                        <button class="wpr-btn" onclick="event.stopPropagation(); editAssignmentSchedule()">Edit Schedule</button>
                        <button class="wpr-btn danger" onclick="event.stopPropagation(); unassignProgram()">Unassign</button>
                    </div>
                    <div class="wpr-active-days">${daysChips}</div>
                    ${daysExercises}
                </div>`;
        }

        function toggleProgramDay(dayIndex) {
            const el = document.getElementById(`programDay${dayIndex}`);
            const chip = document.querySelector(`[data-day-index="${dayIndex}"]`);
            if (el) {
                const isShowing = el.classList.contains('show');
                // Close all first
                document.querySelectorAll('.wpr-day-exercises').forEach(e => e.classList.remove('show'));
                document.querySelectorAll('.wpr-day-chip').forEach(c => c.classList.remove('expanded'));
                if (!isShowing) {
                    el.classList.add('show');
                    if (chip) chip.classList.add('expanded');
                }
            }
        }

        function renderProgramsList() {
            const container = document.getElementById('programsListContainer');

            if (coachPrograms.length === 0) {
                container.innerHTML = `<div class="wpr-no-programs">
                    <p>No workout programs created yet.</p>
                    <a href="coach-workouts.html" class="wpr-btn primary" style="display:inline-block;margin-top:8px;text-decoration:none;">Create a Program</a>
                </div>`;
                return;
            }

            const isAssigned = clientActiveAssignment?.program_id;

            container.innerHTML = '<div class="wpr-programs-list">' + coachPrograms.map(p => {
                const isActive = isAssigned && isAssigned === p.id;
                const days = p.program_data?.days?.length || p.days_per_week || 0;
                const typeLabel = p.program_type ? p.program_type.charAt(0).toUpperCase() + p.program_type.slice(1) : '';
                const diffLabel = p.difficulty ? p.difficulty.charAt(0).toUpperCase() + p.difficulty.slice(1) : '';

                return `<div class="wpr-program-card" ${isActive ? 'style="border-color:#22c55e;background:#f0fdf4;"' : ''}>
                    <div class="wpr-program-info">
                        <div class="wpr-program-name">${escapeHtml(p.name || 'Untitled')} ${isActive ? '<span style="color:#16a34a;font-size:11px;font-weight:700;">ACTIVE</span>' : ''}</div>
                        <div class="wpr-program-meta">${[typeLabel, diffLabel, days + ' days/wk'].filter(Boolean).join('  ')}</div>
                    </div>
                    <div class="wpr-program-actions">
                        ${!isActive ? `<button class="wpr-btn primary" onclick="event.stopPropagation(); assignProgram('${p.id}')">Assign</button>` : ''}
                        <button class="wpr-btn danger" onclick="event.stopPropagation(); deleteProgram('${p.id}', '${escapeHtml(p.name || '')}')">Delete</button>
                    </div>
                </div>`;
            }).join('') + '</div>';
        }

        async function assignProgram(programId) {
            const program = coachPrograms.find(p => p.id === programId);
            if (!program) return;

            // If there's already an active assignment, confirm
            if (clientActiveAssignment) {
                if (!confirm(`This client already has an active program "${clientActiveAssignment.name}". Assigning a new one will deactivate it. Continue?`)) return;

                // Deactivate current
                try {
                    await fetch('/.netlify/functions/workout-assignments', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ assignmentId: clientActiveAssignment.id, isActive: false })
                    });
                } catch (e) { console.error('Error deactivating old assignment:', e); }
            }

            // Show schedule picker modal
            showScheduleModal(program);
        }

        function showScheduleModal(program) {
            const dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            const dayKeys = ['mon','tue','wed','thu','fri','sat','sun'];
            const daysPerWeek = program.program_data?.days?.length || program.days_per_week || 3;

            const modal = document.getElementById('workoutModalContainer');
            modal.innerHTML = `
                <div class="wpr-modal-overlay" onclick="closeWorkoutModal(event)">
                    <div class="wpr-modal" onclick="event.stopPropagation()">
                        <div class="wpr-modal-title">Assign: ${escapeHtml(program.name)}</div>
                        <div class="wpr-form-group">
                            <label class="wpr-form-label">Start Date</label>
                            <input type="date" class="wpr-form-input" id="assignStartDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="wpr-form-group">
                            <label class="wpr-form-label">Schedule Days (select ${daysPerWeek})</label>
                            <div class="wpr-schedule-days" id="assignScheduleDays">
                                ${dayNames.map((name, i) => `<div class="wpr-schedule-day" data-day="${dayKeys[i]}" onclick="toggleScheduleDay(this)">${name}</div>`).join('')}
                            </div>
                        </div>
                        <div class="wpr-modal-actions">
                            <button class="wpr-btn" onclick="closeWorkoutModal()">Cancel</button>
                            <button class="wpr-btn primary" onclick="confirmAssignProgram('${program.id}')">Assign</button>
                        </div>
                    </div>
                </div>`;
        }

        function toggleScheduleDay(el) {
            el.classList.toggle('active');
        }

        async function confirmAssignProgram(programId) {
            const program = coachPrograms.find(p => p.id === programId);
            if (!program) return;

            const startDate = document.getElementById('assignStartDate').value;
            const selectedDays = Array.from(document.querySelectorAll('.wpr-schedule-day.active')).map(el => el.dataset.day);

            if (!startDate) { alert('Please select a start date.'); return; }
            if (selectedDays.length === 0) { alert('Please select at least one schedule day.'); return; }

            try {
                const res = await fetch('/.netlify/functions/workout-assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientId: clientId,
                        coachId: currentUser.id,
                        programId: programId,
                        name: program.name,
                        workoutData: program.program_data,
                        schedule: { days: selectedDays },
                        startDate: startDate
                    })
                });

                if (!res.ok) throw new Error('Failed to assign program');

                closeWorkoutModal();
                await loadWorkoutPrograms(clientId);
                await loadWorkoutCalendar(clientId);
            } catch (err) {
                console.error('Error assigning program:', err);
                alert('Failed to assign program. Please try again.');
            }
        }

        async function unassignProgram() {
            if (!clientActiveAssignment) return;
            if (!confirm(`Remove "${clientActiveAssignment.name}" from this client?`)) return;

            try {
                const res = await fetch('/.netlify/functions/workout-assignments', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assignmentId: clientActiveAssignment.id, isActive: false })
                });

                if (!res.ok) throw new Error('Failed to unassign');
                await loadWorkoutPrograms(clientId);
                await loadWorkoutCalendar(clientId);
            } catch (err) {
                console.error('Error unassigning program:', err);
                alert('Failed to unassign program.');
            }
        }

        async function deleteProgram(programId, programName) {
            if (!confirm(`Delete program "${programName}"? This cannot be undone.`)) return;

            try {
                const res = await fetch(`/.netlify/functions/workout-programs?programId=${programId}`, {
                    method: 'DELETE'
                });

                if (!res.ok) throw new Error('Failed to delete');
                await loadWorkoutPrograms(clientId);
            } catch (err) {
                console.error('Error deleting program:', err);
                alert('Failed to delete program.');
            }
        }

        function showAssignProgramModal() {
            if (coachPrograms.length === 0) {
                alert('No programs available. Create one first in the Workout Editor.');
                return;
            }

            const modal = document.getElementById('workoutModalContainer');
            const programCards = coachPrograms.map(p => {
                const days = p.program_data?.days?.length || p.days_per_week || 0;
                const typeLabel = p.program_type ? p.program_type.charAt(0).toUpperCase() + p.program_type.slice(1) : '';
                return `<div class="wpr-assign-card" onclick="assignProgram('${p.id}')">
                    <div>
                        <div class="wpr-program-name">${escapeHtml(p.name || 'Untitled')}</div>
                        <div class="wpr-program-meta">${[typeLabel, days + ' days/wk'].filter(Boolean).join('  ')}</div>
                    </div>
                    <span style="color:#3b82f6;font-weight:600;font-size:13px;">Select </span>
                </div>`;
            }).join('');

            modal.innerHTML = `
                <div class="wpr-modal-overlay" onclick="closeWorkoutModal(event)">
                    <div class="wpr-modal" onclick="event.stopPropagation()">
                        <div class="wpr-modal-title">Assign Workout Program</div>
                        <div class="wpr-assign-programs">${programCards}</div>
                        <div class="wpr-modal-actions">
                            <button class="wpr-btn" onclick="closeWorkoutModal()">Cancel</button>
                            <a href="coach-workouts.html" class="wpr-btn primary" style="text-decoration:none;">Create New Program</a>
                        </div>
                    </div>
                </div>`;
        }

        // ============ WORKOUT EDITING FUNCTIONS ============

        let editSearchTimeout = null;

        function editExerciseInProgram(dayIndex, exerciseIndex) {
            if (!clientActiveAssignment?.workout_data?.days) return;
            const day = clientActiveAssignment.workout_data.days[dayIndex];
            const exercise = day?.exercises?.[exerciseIndex];
            if (!exercise) return;

            const modal = document.getElementById('workoutModalContainer');
            modal.innerHTML = `
                <div class="wpr-modal-overlay" onclick="closeWorkoutModal(event)">
                    <div class="wpr-modal" onclick="event.stopPropagation()">
                        <div class="wpr-modal-title">Edit Exercise</div>
                        <div class="wpr-form-group">
                            <label class="wpr-form-label">Exercise Name</label>
                            <input type="text" class="wpr-form-input" id="editExName" value="${escapeHtml(exercise.name || '')}">
                        </div>
                        <div class="wpr-form-row">
                            <div class="wpr-form-group">
                                <label class="wpr-form-label">Sets</label>
                                <input type="number" class="wpr-form-input" id="editExSets" value="${exercise.sets || 3}" min="1" max="20">
                            </div>
                            <div class="wpr-form-group">
                                <label class="wpr-form-label">Reps</label>
                                <input type="number" class="wpr-form-input" id="editExReps" value="${exercise.reps || 10}" min="1" max="100">
                            </div>
                        </div>
                        <div class="wpr-form-row">
                            <div class="wpr-form-group">
                                <label class="wpr-form-label">Weight (kg)</label>
                                <input type="number" class="wpr-form-input" id="editExWeight" value="${exercise.weight || ''}" min="0" step="0.5">
                            </div>
                            <div class="wpr-form-group">
                                <label class="wpr-form-label">Rest (sec)</label>
                                <input type="number" class="wpr-form-input" id="editExRest" value="${exercise.rest_seconds || exercise.restSeconds || 60}" min="0" step="15">
                            </div>
                        </div>
                        <div class="wpr-form-group">
                            <label class="wpr-form-label">Notes</label>
                            <input type="text" class="wpr-form-input" id="editExNotes" value="${escapeHtml(exercise.notes || '')}">
                        </div>
                        <div class="wpr-modal-actions">
                            <button class="wpr-btn" onclick="closeWorkoutModal()">Cancel</button>
                            <button class="wpr-btn primary" onclick="saveExerciseEdit(${dayIndex}, ${exerciseIndex})">Save</button>
                        </div>
                    </div>
                </div>`;
        }

        async function saveExerciseEdit(dayIndex, exerciseIndex) {
            const name = document.getElementById('editExName').value.trim();
            const sets = parseInt(document.getElementById('editExSets').value) || 3;
            const reps = parseInt(document.getElementById('editExReps').value) || 10;
            const weight = parseFloat(document.getElementById('editExWeight').value) || 0;
            const rest = parseInt(document.getElementById('editExRest').value) || 60;
            const notes = document.getElementById('editExNotes').value.trim();

            if (!name) { alert('Exercise name is required.'); return; }

            const updatedData = JSON.parse(JSON.stringify(clientActiveAssignment.workout_data));
            const exercise = updatedData.days[dayIndex].exercises[exerciseIndex];
            exercise.name = name;
            exercise.sets = sets;
            exercise.reps = reps;
            exercise.weight = weight;
            exercise.rest_seconds = rest;
            exercise.restSeconds = rest;
            exercise.notes = notes;

            try {
                const res = await fetch('/.netlify/functions/workout-assignments', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assignmentId: clientActiveAssignment.id,
                        workoutData: updatedData
                    })
                });

                if (!res.ok) throw new Error('Failed to update');
                closeWorkoutModal();
                await loadWorkoutPrograms(clientId);
            } catch (err) {
                console.error('Error saving exercise edit:', err);
                alert('Failed to save changes.');
            }
        }

        async function removeExerciseFromProgram(dayIndex, exerciseIndex) {
            if (!clientActiveAssignment?.workout_data?.days) return;
            const exercise = clientActiveAssignment.workout_data.days[dayIndex]?.exercises?.[exerciseIndex];
            if (!confirm(`Remove "${exercise?.name || 'this exercise'}" from the program?`)) return;

            const updatedData = JSON.parse(JSON.stringify(clientActiveAssignment.workout_data));
            updatedData.days[dayIndex].exercises.splice(exerciseIndex, 1);

            try {
                const res = await fetch('/.netlify/functions/workout-assignments', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assignmentId: clientActiveAssignment.id,
                        workoutData: updatedData
                    })
                });

                if (!res.ok) throw new Error('Failed to update');
                await loadWorkoutPrograms(clientId);
            } catch (err) {
                console.error('Error removing exercise:', err);
                alert('Failed to remove exercise.');
            }
        }

        function addExerciseToProgram(dayIndex) {
            const modal = document.getElementById('workoutModalContainer');
            modal.innerHTML = `
                <div class="wpr-modal-overlay" onclick="closeWorkoutModal(event)">
                    <div class="wpr-modal" onclick="event.stopPropagation()">
                        <div class="wpr-modal-title">Add Exercise to Day ${dayIndex + 1}</div>
                        <div class="wpr-form-group">
                            <label class="wpr-form-label">Search Exercises</label>
                            <input type="text" class="wpr-form-input" id="exerciseSearchInput" placeholder="Type to search..." oninput="searchExercisesForAdd(this.value, ${dayIndex})">
                            <div id="exerciseSearchResults" class="wpr-exercise-search-results" style="display:none;"></div>
                        </div>
                        <div style="text-align:center;color:#94a3b8;font-size:12px;margin:10px 0;"> or add manually </div>
                        <div class="wpr-form-group">
                            <label class="wpr-form-label">Exercise Name</label>
                            <input type="text" class="wpr-form-input" id="addExName" placeholder="e.g. Barbell Bench Press">
                        </div>
                        <div class="wpr-form-row">
                            <div class="wpr-form-group">
                                <label class="wpr-form-label">Sets</label>
                                <input type="number" class="wpr-form-input" id="addExSets" value="3" min="1" max="20">
                            </div>
                            <div class="wpr-form-group">
                                <label class="wpr-form-label">Reps</label>
                                <input type="number" class="wpr-form-input" id="addExReps" value="10" min="1" max="100">
                            </div>
                        </div>
                        <div class="wpr-form-row">
                            <div class="wpr-form-group">
                                <label class="wpr-form-label">Weight (kg)</label>
                                <input type="number" class="wpr-form-input" id="addExWeight" min="0" step="0.5">
                            </div>
                            <div class="wpr-form-group">
                                <label class="wpr-form-label">Rest (sec)</label>
                                <input type="number" class="wpr-form-input" id="addExRest" value="60" min="0" step="15">
                            </div>
                        </div>
                        <div class="wpr-modal-actions">
                            <button class="wpr-btn" onclick="closeWorkoutModal()">Cancel</button>
                            <button class="wpr-btn primary" onclick="confirmAddExercise(${dayIndex})">Add</button>
                        </div>
                    </div>
                </div>`;
        }

        async function searchExercisesForAdd(query, dayIndex) {
            clearTimeout(editSearchTimeout);
            const resultsEl = document.getElementById('exerciseSearchResults');

            if (query.length < 2) {
                resultsEl.style.display = 'none';
                return;
            }

            editSearchTimeout = setTimeout(async () => {
                try {
                    const coachId = currentUser?.id || '';
                    const res = await fetch(`/.netlify/functions/exercises?coachId=${coachId}&search=${encodeURIComponent(query)}&limit=10`);
                    const data = await res.json();
                    const exercises = data.exercises || [];

                    if (exercises.length === 0) {
                        resultsEl.innerHTML = '<div style="padding:10px;color:#94a3b8;font-size:13px;text-align:center;">No exercises found</div>';
                    } else {
                        resultsEl.innerHTML = exercises.map(ex => {
                            const meta = [ex.muscle_group, ex.equipment].filter(Boolean).join('  ');
                            return `<div class="wpr-search-result" onclick="selectSearchExercise('${escapeHtml(ex.name)}', '${ex.id}')">
                                <div class="wpr-search-result-name">${escapeHtml(ex.name)}</div>
                                <div class="wpr-search-result-meta">${meta}</div>
                            </div>`;
                        }).join('');
                    }
                    resultsEl.style.display = 'block';
                } catch (err) {
                    console.error('Error searching exercises:', err);
                }
            }, 300);
        }

        function selectSearchExercise(name, id) {
            document.getElementById('addExName').value = name;
            document.getElementById('exerciseSearchResults').style.display = 'none';
            document.getElementById('exerciseSearchInput').value = '';
        }

        async function confirmAddExercise(dayIndex) {
            const name = document.getElementById('addExName').value.trim();
            const sets = parseInt(document.getElementById('addExSets').value) || 3;
            const reps = parseInt(document.getElementById('addExReps').value) || 10;
            const weight = parseFloat(document.getElementById('addExWeight').value) || 0;
            const rest = parseInt(document.getElementById('addExRest').value) || 60;

            if (!name) { alert('Please enter an exercise name.'); return; }
            if (!clientActiveAssignment?.workout_data?.days) { alert('No active assignment.'); return; }

            const updatedData = JSON.parse(JSON.stringify(clientActiveAssignment.workout_data));
            updatedData.days[dayIndex].exercises.push({
                name: name,
                sets: sets,
                reps: reps,
                weight: weight,
                rest_seconds: rest,
                restSeconds: rest
            });

            try {
                const res = await fetch('/.netlify/functions/workout-assignments', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assignmentId: clientActiveAssignment.id,
                        workoutData: updatedData
                    })
                });

                if (!res.ok) throw new Error('Failed to update');
                closeWorkoutModal();
                await loadWorkoutPrograms(clientId);
            } catch (err) {
                console.error('Error adding exercise:', err);
                alert('Failed to add exercise.');
            }
        }

        function editAssignmentSchedule() {
            if (!clientActiveAssignment) return;
            const schedule = clientActiveAssignment.workout_data?.schedule || {};
            const currentDays = schedule.days || schedule.selectedDays || [];
            const dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            const dayKeys = ['mon','tue','wed','thu','fri','sat','sun'];

            const modal = document.getElementById('workoutModalContainer');
            modal.innerHTML = `
                <div class="wpr-modal-overlay" onclick="closeWorkoutModal(event)">
                    <div class="wpr-modal" onclick="event.stopPropagation()">
                        <div class="wpr-modal-title">Edit Schedule</div>
                        <div class="wpr-form-group">
                            <label class="wpr-form-label">Active Days</label>
                            <div class="wpr-schedule-days" id="editScheduleDays">
                                ${dayNames.map((name, i) => `<div class="wpr-schedule-day ${currentDays.includes(dayKeys[i]) ? 'active' : ''}" data-day="${dayKeys[i]}" onclick="toggleScheduleDay(this)">${name}</div>`).join('')}
                            </div>
                        </div>
                        <div class="wpr-form-group">
                            <label class="wpr-form-label">Start Date</label>
                            <input type="date" class="wpr-form-input" id="editStartDate" value="${clientActiveAssignment.start_date || ''}">
                        </div>
                        <div class="wpr-form-group">
                            <label class="wpr-form-label">End Date (optional)</label>
                            <input type="date" class="wpr-form-input" id="editEndDate" value="${clientActiveAssignment.end_date || ''}">
                        </div>
                        <div class="wpr-modal-actions">
                            <button class="wpr-btn" onclick="closeWorkoutModal()">Cancel</button>
                            <button class="wpr-btn primary" onclick="saveScheduleEdit()">Save</button>
                        </div>
                    </div>
                </div>`;
        }

        async function saveScheduleEdit() {
            const selectedDays = Array.from(document.querySelectorAll('#editScheduleDays .wpr-schedule-day.active')).map(el => el.dataset.day);
            const startDate = document.getElementById('editStartDate').value;
            const endDate = document.getElementById('editEndDate').value;

            if (selectedDays.length === 0) { alert('Please select at least one day.'); return; }

            const updatedData = JSON.parse(JSON.stringify(clientActiveAssignment.workout_data));
            updatedData.schedule = { days: selectedDays };

            const updatePayload = {
                assignmentId: clientActiveAssignment.id,
                workoutData: updatedData
            };
            if (startDate) updatePayload.startDate = startDate;
            if (endDate) updatePayload.endDate = endDate;

            try {
                const res = await fetch('/.netlify/functions/workout-assignments', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatePayload)
                });

                if (!res.ok) throw new Error('Failed to update');
                closeWorkoutModal();
                await loadWorkoutPrograms(clientId);
                await loadWorkoutCalendar(clientId);
            } catch (err) {
                console.error('Error saving schedule:', err);
                alert('Failed to save schedule.');
            }
        }

        function closeWorkoutModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('workoutModalContainer').innerHTML = '';
        }

        // ============ SUPPLEMENT PROTOCOL FUNCTIONS ============

        async function loadProtocols(clientId) {
            if (!clientId || !currentUser) return;

            try {
                const response = await fetch(`${CLIENT_PROTOCOLS_ENDPOINT}?clientId=${clientId}&coachId=${currentUser.id}`);

                if (!response.ok) {
                    throw new Error('Failed to fetch protocols');
                }

                const data = await response.json();
                clientProtocols = data.protocols || [];

                if (clientProtocols.length > 0) {
                    displayProtocols();
                } else {
                    document.getElementById('protocolsContainer').innerHTML = '<div class="no-protocols" style="text-align:center;padding:30px;color:#64748b;">No supplement protocols assigned yet.</div>';
                }
            } catch (error) {
                console.error('Error loading protocols:', error);
            }
        }

        function displayProtocols() {
            const container = document.getElementById('protocolsContainer');

            if (clientProtocols.length === 0) {
                container.innerHTML = '<div class="no-protocols">No supplement protocols assigned yet.</div>';
                return;
            }

            const timingLabels = {
                'morning': 'Morning',
                'pre_workout': 'Pre-Workout',
                'post_workout': 'Post-Workout',
                'bedtime': 'Bedtime',
                'with_meals': 'With Meals',
                'custom': 'Custom'
            };

            const timingIcons = {
                'morning': '',
                'pre_workout': '',
                'post_workout': '',
                'bedtime': '',
                'with_meals': '',
                'custom': ''
            };

            let html = '';

            clientProtocols.forEach(protocol => {
                const icon = timingIcons[protocol.timing] || '';
                const timingText = protocol.timing === 'custom' && protocol.timing_custom
                    ? protocol.timing_custom
                    : timingLabels[protocol.timing] || protocol.timing;

                html += `<div class="protocol-card">`;
                html += `<div class="protocol-name">${icon} ${protocol.name}</div>`;
                html += `<div class="protocol-timing"><strong>Timing:</strong> ${timingText}</div>`;

                // Show dose or schedule
                if (protocol.has_schedule && protocol.schedule && protocol.schedule.length > 0) {
                    html += `<div class="protocol-timing"><strong> Scheduled:</strong></div>`;
                    html += `<ul class="protocol-schedule">`;
                    protocol.schedule.forEach(phase => {
                        html += `<li>Week ${phase.weekStart}-${phase.weekEnd}: ${phase.dose}</li>`;
                    });
                    html += `</ul>`;
                    if (protocol.start_date) {
                        const startDate = new Date(protocol.start_date).toLocaleDateString();
                        html += `<div class="protocol-timing"><strong>Start Date:</strong> ${startDate}</div>`;
                    }
                } else if (protocol.dose) {
                    html += `<div class="protocol-timing"><strong>Dose:</strong> ${protocol.dose}</div>`;
                }

                // Show public notes (not private_notes - those are coach only)
                if (protocol.notes) {
                    html += `<div class="protocol-notes"> ${protocol.notes}</div>`;
                }

                // Show private notes for coach
                if (protocol.private_notes) {
                    html += `<div class="protocol-notes" style="background: #fef3c7; color: #92400e;"> Coach Note: ${protocol.private_notes}</div>`;
                }

                // Add edit and delete buttons for coach
                html += `<div class="protocol-actions">`;
                html += `<button class="protocol-btn protocol-btn-edit" onclick="openEditProtocolModal(${protocol.id})"> Edit</button>`;
                html += `<button class="protocol-btn protocol-btn-delete" onclick="deleteProtocol(${protocol.id}, '${protocol.name.replace(/'/g, "\\'")}')"> Delete</button>`;
                html += `</div>`;

                html += `</div>`;
            });

            container.innerHTML = html;
        }

        // ============ PROTOCOL EDIT FUNCTIONS ============

        let editingProtocolId = null;

        function openEditProtocolModal(protocolId) {
            const protocol = clientProtocols.find(p => p.id === protocolId);
            if (!protocol) return;

            editingProtocolId = protocolId;

            // Fill form with current values
            document.getElementById('editProtocolId').value = protocolId;
            document.getElementById('editProtocolName').value = protocol.name || '';
            document.getElementById('editProtocolTiming').value = protocol.timing || 'morning';
            document.getElementById('editProtocolTimingCustom').value = protocol.timing_custom || '';
            document.getElementById('editProtocolDose').value = protocol.dose || '';
            document.getElementById('editProtocolNotes').value = protocol.notes || '';

            // Toggle custom timing visibility
            toggleEditCustomTiming();

            // Show modal
            document.getElementById('protocolEditModal').classList.add('active');
        }

        function closeEditProtocolModal() {
            document.getElementById('protocolEditModal').classList.remove('active');
            editingProtocolId = null;
        }

        function toggleEditCustomTiming() {
            const timing = document.getElementById('editProtocolTiming').value;
            const customGroup = document.getElementById('editCustomTimingGroup');
            customGroup.style.display = timing === 'custom' ? 'block' : 'none';
        }

        async function saveProtocolEdit() {
            if (!editingProtocolId || !currentUser) {
                alert('Error: No protocol selected');
                return;
            }

            const name = document.getElementById('editProtocolName').value.trim();
            if (!name) {
                alert('Please enter a supplement name.');
                return;
            }

            const protocol = clientProtocols.find(p => p.id === editingProtocolId);
            if (!protocol) {
                alert('Protocol not found.');
                return;
            }

            const timing = document.getElementById('editProtocolTiming').value;
            const timingCustom = document.getElementById('editProtocolTimingCustom').value.trim();
            const dose = document.getElementById('editProtocolDose').value.trim();
            const notes = document.getElementById('editProtocolNotes').value.trim();

            const payload = {
                protocolId: editingProtocolId,
                coachId: currentUser.id,
                clientId: parseInt(clientId),
                name,
                timing,
                timingCustom: timing === 'custom' ? timingCustom : null,
                dose: protocol.has_schedule ? null : dose,
                hasSchedule: protocol.has_schedule,
                schedule: protocol.schedule,
                startDate: protocol.start_date,
                notes,
                privateNotes: protocol.private_notes // Preserve coach's private notes
            };

            try {
                const response = await fetch(CLIENT_PROTOCOLS_ENDPOINT, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                closeEditProtocolModal();
                await loadProtocols(clientId);
                alert('Supplement updated!');

            } catch (error) {
                console.error('Error updating protocol:', error);
                alert('Failed to update supplement: ' + error.message);
            }
        }

        // Delete protocol
        async function deleteProtocol(protocolId, protocolName) {
            if (!confirm(`Are you sure you want to delete "${protocolName}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`${CLIENT_PROTOCOLS_ENDPOINT}?protocolId=${protocolId}&coachId=${currentUser.id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                await loadProtocols(clientId);
                alert('Supplement deleted successfully!');

            } catch (error) {
                console.error('Error deleting protocol:', error);
                alert('Failed to delete supplement: ' + error.message);
            }
        }

        // =============================================
        // Reminder Status Functions
        // =============================================

        let clientReminderPrefs = null;

        async function loadReminderStatus(clientId) {
            try {
                const response = await fetch(`/.netlify/functions/reminder-settings?clientId=${clientId}`);
                const data = await response.json();

                if (data.needsMigration) {
                    // Feature not yet available - hide the section
                    return;
                }

                clientReminderPrefs = data.preferences;
                updateReminderStatusDisplay();
                document.getElementById('reminderStatusSection').style.display = 'flex';

            } catch (error) {
                console.error('Error loading reminder status:', error);
                // Don't show the section if there's an error
            }
        }

        function updateReminderStatusDisplay() {
            const badge = document.getElementById('reminderStatusBadge');
            const lastSent = document.getElementById('reminderLastSent');
            const toggleBtn = document.getElementById('reminderToggleBtn');

            if (!clientReminderPrefs || clientReminderPrefs.is_default) {
                badge.className = 'reminder-status-badge no-prefs';
                badge.textContent = 'Using defaults';
                lastSent.textContent = '';
                toggleBtn.className = 'reminder-toggle-btn disable';
                toggleBtn.textContent = 'Disable Reminders';
                return;
            }

            const enabled = clientReminderPrefs.reminders_enabled !== false;

            if (enabled) {
                badge.className = 'reminder-status-badge enabled';
                badge.textContent = 'Enabled';
                toggleBtn.className = 'reminder-toggle-btn disable';
                toggleBtn.textContent = 'Disable Reminders';
            } else {
                badge.className = 'reminder-status-badge disabled';
                badge.textContent = 'Disabled by client';
                toggleBtn.className = 'reminder-toggle-btn enable';
                toggleBtn.textContent = 'Enable Reminders';
            }

            // Show last reminder sent time
            if (clientReminderPrefs.last_reminder_sent_at) {
                const lastSentDate = new Date(clientReminderPrefs.last_reminder_sent_at);
                lastSent.textContent = `Last sent: ${formatTimeAgo(lastSentDate)}`;
            } else {
                lastSent.textContent = 'No reminders sent yet';
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;

            return date.toLocaleDateString();
        }

        async function toggleClientReminders() {
            if (!clientReminderPrefs) return;

            const currentState = clientReminderPrefs.reminders_enabled !== false;
            const newState = !currentState;

            const toggleBtn = document.getElementById('reminderToggleBtn');
            toggleBtn.disabled = true;
            toggleBtn.textContent = 'Saving...';

            try {
                const response = await fetch('/.netlify/functions/reminder-settings/client', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientId: clientId,
                        coachId: currentUser.id,
                        remindersEnabled: newState,
                        emailReminders: newState,
                        inappReminders: newState
                    })
                });

                const data = await response.json();

                if (data.success) {
                    clientReminderPrefs = data.preferences;
                    updateReminderStatusDisplay();
                } else {
                    throw new Error(data.error || 'Failed to update');
                }

            } catch (error) {
                console.error('Error toggling reminders:', error);
                alert('Failed to update reminder settings: ' + error.message);
            } finally {
                toggleBtn.disabled = false;
                updateReminderStatusDisplay();
            }
        }
        // Mobile menu toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        });

        document.getElementById('sidebarOverlay').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        });
    </script>
        </div>
    </main>
    <!-- PWA Install Prompt -->
    <script src="/js/pwa-install-prompt.js"></script>
</body>
</html>
