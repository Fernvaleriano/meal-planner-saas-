<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Builder - Zique Fitness</title>
    <script src="/js/theme.js"></script>
    <script src="/js/gym-features.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-primary: #0d9488;
            --brand-secondary: #0284c7;
            --brand-gradient: linear-gradient(135deg, #0d9488 0%, #0284c7 100%);
            --purple-gradient: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(13, 148, 136, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(2, 132, 199, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.05) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        /* Navigation */
        .top-nav {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.95) 0%, rgba(2, 132, 199, 0.95) 100%);
            backdrop-filter: blur(20px);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nav-back {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .nav-back:hover { opacity: 1; }

        .nav-title {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.15);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .btn-ai-generate {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-ai-generate:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            transform: translateY(-1px);
        }

        .btn-ai-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-ai-generate .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .btn-primary {
            background: white;
            color: var(--brand-primary);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Main Layout */
        .main-content {
            display: flex;
            min-height: calc(100vh - 68px);
            position: relative;
            z-index: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 68px;
            height: calc(100vh - 68px);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 16px;
        }

        .sidebar-search {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .sidebar-search:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }

        .sidebar-search::placeholder {
            color: var(--text-muted);
        }

        /* Program List */
        .program-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .program-item {
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            background: var(--bg-tertiary);
        }

        .program-item:hover {
            transform: translateX(4px);
            border-color: var(--border-color);
        }

        .program-item.active {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.15) 0%, rgba(2, 132, 199, 0.15) 100%);
            border-color: var(--brand-primary);
        }

        .program-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .program-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .program-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Program Item Actions (Delete/Duplicate) */
        .program-item {
            position: relative;
        }

        .program-item-content {
            flex: 1;
            min-width: 0;
        }

        .program-item-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .program-item:hover .program-item-actions {
            opacity: 1;
        }

        .program-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .program-action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .program-action-btn.delete-btn:hover {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .program-action-btn.duplicate-btn:hover {
            background: rgba(13, 148, 136, 0.15);
            color: var(--brand-primary);
        }

        /* Sidebar Filters */
        .sidebar-filters {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .sidebar-filter-select {
            flex: 1;
            min-width: 80px;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
        }

        .sidebar-filter-select:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        /* Voice Notes Styles */
        .voice-note-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .voice-note-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .voice-note-btn:hover {
            background: var(--brand-primary);
            color: white;
        }

        .voice-note-btn.recording {
            background: var(--danger);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .voice-note-btn.has-audio {
            background: var(--brand-primary);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .voice-note-player {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 20px;
        }

        .voice-note-player audio {
            height: 24px;
            flex: 1;
        }

        .voice-note-delete {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .voice-note-delete:hover {
            background: var(--danger);
            color: white;
        }

        /* Confirm Modal */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .confirm-modal-overlay.active .confirm-modal {
            transform: scale(1);
        }

        .confirm-modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .confirm-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
        }

        .confirm-modal-message {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 24px;
            font-size: 0.9rem;
        }

        .confirm-modal-actions {
            display: flex;
            gap: 12px;
        }

        .confirm-modal-actions .btn {
            flex: 1;
            justify-content: center;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Recommended Swaps Styles */
        .recommended-swaps-btn {
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
            position: relative;
        }

        .recommended-swaps-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            color: #c4b5fd;
        }

        .recommended-swaps-btn .swap-count {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 16px;
            height: 16px;
            background: #8b5cf6;
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommended-swaps-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .recommended-swap-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .recommended-swap-item .swap-thumb {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-secondary);
        }

        .recommended-swap-item .swap-info {
            flex: 1;
            min-width: 0;
        }

        .recommended-swap-item .swap-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .recommended-swap-item .swap-muscle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .recommended-swap-item .remove-swap-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommended-swap-item .remove-swap-btn:hover {
            background: var(--danger);
            color: white;
        }

        .add-recommended-section {
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
        }

        .add-recommended-section h4 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .recommended-exercise-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .recommended-exercise-option:hover {
            background: var(--bg-tertiary);
        }

        .recommended-exercise-option.selected {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid #8b5cf6;
        }

        .recommended-exercise-option .option-thumb {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
        }

        .recommended-exercise-option .option-info {
            flex: 1;
        }

        .recommended-exercise-option .option-name {
            font-size: 13px;
            font-weight: 500;
        }

        .recommended-exercise-option .option-equipment {
            font-size: 11px;
            color: var(--text-muted);
        }

        .exercise-has-swaps {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #a78bfa;
            margin-top: 4px;
        }

        .exercise-has-swaps svg {
            width: 12px;
            height: 12px;
        }

        /* Custom Video Upload Styles */
        .custom-video-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }

        .custom-video-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-video-btn:hover {
            background: var(--brand-primary);
            color: white;
            border-color: var(--brand-primary);
        }

        .custom-video-btn.recording {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
            animation: pulse 1.5s infinite;
        }

        .custom-video-btn.has-video {
            background: rgba(13, 148, 136, 0.15);
            color: var(--brand-primary);
            border-color: var(--brand-primary);
        }

        .custom-video-preview {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .custom-video-preview video {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        .custom-video-preview .video-info {
            flex: 1;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .custom-video-preview .video-label {
            color: var(--brand-primary);
            font-weight: 500;
        }

        .custom-video-delete {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .custom-video-delete:hover {
            background: var(--danger);
            color: white;
        }

        .video-upload-input {
            display: none;
        }

        .video-recording-timer {
            font-size: 12px;
            font-weight: 600;
            color: var(--danger);
            min-width: 40px;
        }

        .sidebar-actions {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 14px 16px;
            border-radius: var(--radius-md);
            border: 2px dashed var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .sidebar-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.05);
        }

        .sidebar-btn.ai-btn {
            background: var(--purple-gradient);
            border: none;
            color: white;
        }

        .sidebar-btn.ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        /* Builder Area */
        .builder-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            max-width: 900px;
        }

        .builder-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .builder-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .builder-title svg {
            color: var(--brand-primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Hero Image Upload */
        .hero-image-upload {
            margin-top: 8px;
        }

        .hero-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 24px;
            text-align: center;
            background: var(--bg-tertiary);
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .hero-upload-area:hover {
            border-color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.05);
        }

        .hero-upload-area svg {
            color: var(--text-muted);
        }

        .hero-upload-area span {
            font-weight: 500;
            color: var(--text-primary);
        }

        .hero-upload-area .upload-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin: 0;
        }

        .hero-upload-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 8px;
        }

        .hero-upload-buttons .or-divider {
            color: var(--text-muted);
            font-size: 12px;
        }

        .hero-preview {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
            max-height: 200px;
        }

        .hero-preview img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: var(--radius-md);
        }

        .remove-hero-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .remove-hero-btn:hover {
            background: rgba(239, 68, 68, 0.9);
        }

        .remove-hero-btn svg {
            color: white;
        }

        /* Workout Days */
        .workout-day {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .workout-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .day-name-input {
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            padding: 8px 0;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .day-name-input:focus {
            outline: none;
            border-bottom-color: var(--brand-primary);
        }

        .workout-day-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            border: none;
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--danger);
            color: white;
        }

        .exercise-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .swap-btn:hover {
            background: var(--brand-primary) !important;
            color: white;
        }

        /* Exercise Item */
        .exercise-item {
            display: flex;
            gap: 16px;
            align-items: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .exercise-item:hover {
            border-color: var(--brand-primary);
            box-shadow: var(--shadow-sm);
        }

        .exercise-drag {
            color: var(--text-muted);
            cursor: grab;
            font-size: 1.2rem;
        }

        .exercise-thumb-wrap {
            position: relative;
            flex-shrink: 0;
        }

        .exercise-thumb {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            object-fit: cover;
            flex-shrink: 0;
        }

        .video-badge {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .video-badge svg {
            width: 10px;
            height: 10px;
        }

        .exercise-info {
            flex: 1;
            min-width: 0;
        }

        .exercise-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .exercise-config {
            display: flex;
            gap: 12px;
        }

        .config-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .config-input {
            width: 60px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            text-align: center;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .config-input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .config-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .config-label.clickable {
            cursor: pointer;
            transition: color 0.2s;
        }

        .config-label.clickable:hover {
            color: var(--brand-primary);
        }

        .tracking-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 2px 8px;
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
            transition: all 0.2s;
        }

        .tracking-toggle-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        .tracking-toggle-btn.time-active {
            background: rgba(20, 184, 166, 0.15);
            border-color: rgba(20, 184, 166, 0.4);
            color: var(--brand-primary);
        }

        .tracking-toggle-btn .toggle-icon {
            font-size: 10px;
        }

        .exercise-notes {
            margin-top: 8px;
        }

        .notes-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .notes-input::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .add-exercise-btn {
            width: 100%;
            padding: 16px;
            background: transparent;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .add-exercise-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.05);
        }

        .add-day-btn {
            width: 100%;
            padding: 16px;
            background: var(--brand-gradient);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: inherit;
            margin-top: 16px;
        }

        .add-day-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(13, 148, 136, 0.3);
        }

        /* Assign Section */
        .assign-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .assign-btn {
            width: 100%;
            padding: 16px 24px;
            background: var(--brand-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .assign-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(13, 148, 136, 0.3);
        }

        .assign-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Assign Modal Styles */
        .assign-modal {
            max-width: 500px;
            width: 95%;
        }

        .assign-modal .modal-body {
            padding: 0;
        }

        .assign-modal .form-input {
            margin: 16px;
            width: calc(100% - 32px);
        }

        .client-select-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .client-select-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .client-select-item:hover {
            background: var(--bg-tertiary);
        }

        .client-select-item.selected {
            background: rgba(13, 148, 136, 0.1);
        }

        .client-select-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--brand-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .client-select-info {
            flex: 1;
            min-width: 0;
        }

        .client-select-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .client-select-email {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .client-select-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .client-select-check svg {
            opacity: 0;
            color: white;
        }

        .client-select-item.selected .client-select-check {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
        }

        .client-select-item.selected .client-select-check svg {
            opacity: 1;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        .modal-footer .btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .modal-footer .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modal-footer .btn-primary {
            background: var(--brand-gradient);
            color: white;
            border: none;
        }

        .modal-footer .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Schedule Modal */
        .schedule-row {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .schedule-row:last-child {
            border-bottom: none;
        }

        .schedule-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .schedule-row .form-input {
            margin: 0;
            width: 100%;
        }

        .selected-clients-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .selected-client-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
        }

        .selected-client-chip img,
        .selected-client-chip .chip-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--brand-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .days-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .day-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .day-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--brand-primary);
        }

        .day-checkbox span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Legacy client card styles - keeping for backward compatibility */
        .client-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .client-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .client-card:hover {
            border-color: var(--border-color);
        }

        .client-card.selected {
            border-color: var(--brand-primary);
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.1) 0%, rgba(2, 132, 199, 0.1) 100%);
        }

        .client-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .client-check svg {
            opacity: 0;
            color: white;
            transition: opacity 0.2s;
        }

        .client-card.selected .client-check {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
        }

        .client-card.selected .client-check svg {
            opacity: 1;
        }

        .client-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--brand-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .client-info {
            flex: 1;
            min-width: 0;
        }

        .client-name {
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .client-email {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px 28px;
        }

        /* Swap Exercise List */
        .swap-exercise-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .swap-exercise-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .swap-exercise-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--brand-primary);
        }

        .swap-exercise-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-tertiary);
        }

        .swap-exercise-info {
            flex: 1;
        }

        .swap-exercise-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .swap-exercise-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Exercise Badges for Superset, Warm-up, Stretch */
        .exercise-name-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .exercise-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .exercise-badge {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .superset-badge {
            background: linear-gradient(135deg, #8B5CF6, #6366F1);
            color: white;
        }

        .warmup-badge {
            background: linear-gradient(135deg, #F59E0B, #EF4444);
            color: white;
        }

        .stretch-badge {
            background: linear-gradient(135deg, #10B981, #14B8A6);
            color: white;
        }

        /* Highlight superset exercises */
        .superset-exercise {
            border-left: 3px solid #8B5CF6;
            padding-left: 12px;
            margin-left: -15px;
        }

        .warmup-exercise {
            border-left: 3px solid #F59E0B;
            padding-left: 12px;
            margin-left: -15px;
        }

        .stretch-exercise {
            border-left: 3px solid #10B981;
            padding-left: 12px;
            margin-left: -15px;
        }

        .modal-footer {
            padding: 20px 28px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Exercise Grid in Modal */
        .exercise-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .filter-chip:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        .filter-chip.active {
            background: var(--brand-gradient);
            border-color: transparent;
            color: white;
        }

        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }

        .exercise-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .exercise-card:hover {
            border-color: var(--brand-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .exercise-card .video-indicator {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .exercise-card-thumb {
            width: 100%;
            height: 100px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            background: var(--bg-secondary);
            margin-bottom: 12px;
        }

        .exercise-card-thumb-video {
            width: 100%;
            height: 100px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            background: var(--bg-secondary);
            margin-bottom: 12px;
        }

        .exercise-thumb-video {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            object-fit: cover;
        }

        .exercise-card-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .exercise-card-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .exercise-card-secondary {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 4px;
            opacity: 0.8;
        }

        .exercise-library-modal {
            max-width: 700px;
            max-height: 90vh;
        }

        .exercise-library-modal .modal-body {
            max-height: calc(90vh - 80px);
            overflow-y: auto;
        }

        .exercise-thumb-container {
            position: relative;
        }

        .edit-thumb-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
        }

        .exercise-card:hover .edit-thumb-btn {
            opacity: 1;
        }

        .edit-thumb-btn:hover {
            background: rgba(13, 148, 136, 0.9);
        }

        .edit-thumb-btn.no-thumb {
            opacity: 1;
            background: rgba(239, 68, 68, 0.8);
            animation: pulse-thumb 2s infinite;
        }

        @keyframes pulse-thumb {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .edit-thumb-btn.no-thumb:hover {
            background: rgba(13, 148, 136, 0.9);
            animation: none;
        }

        /* AI Modal Specific */
        .ai-form-group {
            margin-bottom: 20px;
        }

        .ai-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .ai-form-group input,
        .ai-form-group select,
        .ai-form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .ai-form-group input:focus,
        .ai-form-group select:focus,
        .ai-form-group textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .ai-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .equipment-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .equipment-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .equipment-item:has(input:checked) {
            background: rgba(13, 148, 136, 0.15);
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        .equipment-item input {
            accent-color: var(--brand-primary);
        }

        .ai-btn {
            padding: 14px 28px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .ai-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .ai-btn-cancel:hover {
            background: var(--border-color);
        }

        .ai-btn-generate {
            background: var(--purple-gradient);
            color: white;
        }

        .ai-btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .ai-btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .generating-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            animation: toastSlideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Custom Exercise Modal Styles */
        .custom-exercise-modal {
            max-width: 600px;
            max-height: 90vh;
        }

        .custom-exercise-modal .modal-body {
            max-height: calc(90vh - 140px);
            overflow-y: auto;
            padding: 24px;
        }

        .custom-exercise-form-group {
            margin-bottom: 20px;
        }

        .custom-exercise-form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .custom-exercise-form-group label .required {
            color: var(--danger);
        }

        .custom-exercise-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .video-upload-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .video-upload-section h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .video-upload-options {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .video-upload-option {
            flex: 1;
            padding: 16px;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .video-upload-option:hover {
            border-color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.05);
        }

        .video-upload-option.active {
            border-color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.1);
        }

        .video-upload-option svg {
            width: 32px;
            height: 32px;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .video-upload-option:hover svg,
        .video-upload-option.active svg {
            color: var(--brand-primary);
        }

        .video-upload-option span {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .custom-video-preview-container {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            display: none;
        }

        .custom-video-preview-container.visible {
            display: block;
        }

        .custom-video-preview-container video {
            width: 100%;
            max-height: 200px;
            border-radius: var(--radius-sm);
            background: #000;
        }

        .custom-video-preview-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
        }

        .custom-video-preview-info span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .create-exercise-header-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(13, 148, 136, 0.15);
            color: var(--brand-primary);
            border: 1px solid var(--brand-primary);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .create-exercise-header-btn:hover {
            background: var(--brand-primary);
            color: white;
        }

        .custom-exercise-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Recording indicator for custom exercise */
        .ce-recording-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: var(--radius-md);
            color: var(--danger);
            margin-top: 12px;
        }

        .ce-recording-indicator .recording-dot {
            width: 10px;
            height: 10px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .ce-recording-indicator .recording-timer {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .ce-recording-indicator .recording-text {
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 250px;
                position: relative;
                top: 0;
                height: auto;
            }

            .builder-area {
                max-width: 100%;
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .ai-form-row {
                grid-template-columns: 1fr;
            }

            .custom-exercise-form-row {
                grid-template-columns: 1fr;
            }

            .video-upload-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <a href="dashboard.html" class="nav-back">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Dashboard
        </a>
        <span class="nav-title">Workout Builder</span>
        <div class="nav-actions">
            <button class="btn btn-primary" onclick="saveProgram()">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Save Program
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Your Programs</div>
                <input type="text" class="sidebar-search" id="programSearchInput" placeholder="Search programs..." oninput="filterPrograms()">
                <div class="sidebar-filters">
                    <select class="sidebar-filter-select" id="programTypeFilter" onchange="filterPrograms()">
                        <option value="">All Types</option>
                        <option value="strength">Strength</option>
                        <option value="hypertrophy">Hypertrophy</option>
                        <option value="endurance">Endurance</option>
                        <option value="weight_loss">Weight Loss</option>
                        <option value="general">General</option>
                    </select>
                    <select class="sidebar-filter-select" id="programDifficultyFilter" onchange="filterPrograms()">
                        <option value="">All Levels</option>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                    <select class="sidebar-filter-select" id="programDaysFilter" onchange="filterPrograms()">
                        <option value="">All Days</option>
                        <option value="1">1 day</option>
                        <option value="2">2 days</option>
                        <option value="3">3 days</option>
                        <option value="4">4 days</option>
                        <option value="5">5 days</option>
                        <option value="6">6 days</option>
                    </select>
                </div>
            </div>
            <div class="program-list" id="programList">
                <div class="empty-state">
                    <div class="empty-icon"></div>
                    <div class="empty-title">No programs yet</div>
                    <p>Create your first workout program</p>
                </div>
            </div>
            <div class="sidebar-actions">
                <button class="sidebar-btn" onclick="createNewProgram()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Program
                </button>
                <button class="sidebar-btn ai-btn" onclick="openAIModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    AI Generate
                </button>
            </div>
        </div>

        <!-- Builder Area -->
        <div class="builder-area">
            <!-- Program Details -->
            <div class="builder-card">
                <h2 class="builder-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Program Details
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Program Name</label>
                        <input type="text" class="form-input" id="programName" placeholder="e.g., 4-Week Hypertrophy Program">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Program Type</label>
                        <select class="form-select" id="programType">
                            <option value="strength">Strength</option>
                            <option value="hypertrophy" selected>Hypertrophy</option>
                            <option value="endurance">Endurance</option>
                            <option value="weight_loss">Weight Loss</option>
                            <option value="general">General Fitness</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Difficulty</label>
                        <select class="form-select" id="programDifficulty">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate" selected>Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Days Per Week</label>
                        <select class="form-select" id="daysPerWeek">
                            <option value="1">1 day</option>
                            <option value="2">2 days</option>
                            <option value="3">3 days</option>
                            <option value="4" selected>4 days</option>
                            <option value="5">5 days</option>
                            <option value="6">6 days</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="programDescription" placeholder="Describe the program goals and structure..."></textarea>
                </div>

                <!-- Hero Image Upload -->
                <div class="form-group">
                    <label class="form-label">Cover Image</label>
                    <div class="hero-image-upload">
                        <div id="heroImagePreview" class="hero-preview" style="display: none;">
                            <img id="heroPreviewImg" src="" alt="Cover preview">
                            <button type="button" class="remove-hero-btn" onclick="removeHeroImage()" title="Remove image">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div id="heroUploadArea" class="hero-upload-area">
                            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <span>Upload cover image</span>
                            <p class="upload-hint">This image will appear at the top of the workout for clients</p>
                            <input type="file" id="heroFileInput" accept="image/*" onchange="previewHeroImage(event)" style="display: none;">
                            <div class="hero-upload-buttons">
                                <button type="button" class="btn-secondary" onclick="document.getElementById('heroFileInput').click()">
                                    Choose File
                                </button>
                                <span class="or-divider">or</span>
                                <button type="button" class="btn-secondary" onclick="showHeroUrlInput()">
                                    Paste URL
                                </button>
                                <span class="or-divider">or</span>
                                <button type="button" class="btn-ai-generate" id="aiCoverBtn" onclick="generateAICoverImage()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                    AI Generate
                                </button>
                            </div>
                            <div id="heroUrlInputContainer" style="display: none; margin-top: 12px; width: 100%;">
                                <input type="text" id="heroUrlInput" class="form-input" placeholder="https://example.com/image.jpg" style="width: 100%;">
                                <button type="button" class="btn-primary" onclick="applyHeroUrl()" style="margin-top: 8px;">Apply URL</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="heroImageUrl" value="">
                </div>
            </div>

            <!-- Workout Days -->
            <div class="builder-card">
                <h2 class="builder-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Workout Days
                </h2>
                <div id="workoutDays">
                    <!-- Days will be rendered here -->
                </div>
                <button class="add-day-btn" onclick="addWorkoutDay()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Workout Day
                </button>
            </div>

            <!-- Assign to Clients -->
            <div class="builder-card">
                <h2 class="builder-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    Assign Program
                </h2>
                <p class="assign-description">Save your program first, then assign it to one or more clients with a schedule.</p>
                <button class="assign-btn" onclick="openAssignModal()" id="assignBtn" disabled>
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    Assign to Clients
                </button>
            </div>
        </div>
    </div>

    <!-- Client Selection Modal (Step 1) -->
    <div class="modal-overlay" id="clientSelectModal">
        <div class="modal assign-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Select Clients
                </h3>
                <button class="modal-close" onclick="closeClientSelectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-input" id="clientSearchInput" placeholder="Search client name..." oninput="filterClients(this.value)">
                <div class="client-select-list" id="clientSelectList">
                    <!-- Clients rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeClientSelectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="proceedToSchedule()" id="continueBtn" disabled>
                    Continue
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Schedule Assignment Modal (Step 2) -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal assign-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Assign Workout
                </h3>
                <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="schedule-row">
                    <label class="schedule-label">Clients</label>
                    <div class="selected-clients-display" id="selectedClientsDisplay">
                        <!-- Selected clients shown here -->
                    </div>
                </div>
                <div class="schedule-row">
                    <label class="schedule-label">Start date</label>
                    <input type="date" class="form-input" id="startDate">
                </div>
                <div class="schedule-row">
                    <label class="schedule-label">Amount of weeks</label>
                    <input type="number" class="form-input" id="weeksAmount" value="4" min="1" max="52">
                </div>
                <div class="schedule-row">
                    <label class="schedule-label">Select days</label>
                    <div class="days-selector">
                        <label class="day-checkbox"><input type="checkbox" value="mon" checked><span>Mon</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="tue" checked><span>Tue</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="wed"><span>Wed</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="thu" checked><span>Thu</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="fri" checked><span>Fri</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="sat"><span>Sat</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="sun"><span>Sun</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="backToClientSelect()">Cancel</button>
                <button class="btn btn-primary" onclick="assignWorkout()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Assign
                </button>
            </div>
        </div>
    </div>

    <!-- Exercise Library Modal -->
    <!-- Swap Exercise Modal -->
    <div class="modal-overlay" id="swapModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                    </svg>
                    Swap Exercise
                </h3>
                <button class="modal-close" onclick="closeSwapModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="swapCurrentExercise" style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                    <p style="margin: 0 0 4px 0; color: var(--text-muted); font-size: 12px;">Current exercise:</p>
                    <p style="margin: 0; font-weight: 600;" id="swapCurrentName">-</p>
                </div>
                <div style="margin-bottom: 12px;">
                    <input type="text" id="swapSearchInput" class="form-input" placeholder="Search for alternative exercises..." oninput="filterSwapExercises(this.value)">
                </div>
                <div id="swapExerciseList" class="swap-exercise-list" style="max-height: 400px; overflow-y: auto;">
                    <!-- Exercise options will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Recommended Swaps Modal -->
    <div class="modal-overlay" id="recommendedSwapsModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                    </svg>
                    Recommended Swaps
                </h3>
                <button class="modal-close" onclick="closeRecommendedSwapsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                    <p style="margin: 0 0 4px 0; color: var(--text-muted); font-size: 12px;">Configure swaps for:</p>
                    <p style="margin: 0; font-weight: 600;" id="recommendedCurrentName">-</p>
                </div>

                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                    Select exercises you recommend as alternatives. These will appear first when your client tries to swap this exercise.
                </p>

                <!-- Current Recommended Swaps -->
                <div id="currentRecommendedSwaps" class="recommended-swaps-list">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Add More Section -->
                <div class="add-recommended-section">
                    <h4>Add Recommended Swaps</h4>
                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                        Search any exercise by name, muscle group, or equipment (e.g., "adduction", "dumbbell", "chest")
                    </p>
                    <div style="margin-bottom: 12px;">
                        <input type="text" id="recommendedSearchInput" class="form-input" placeholder="Search all exercises..." oninput="filterRecommendedExercises(this.value)">
                    </div>
                    <div id="recommendedExerciseOptions" style="max-height: 250px; overflow-y: auto;">
                        <!-- Exercise options will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRecommendedSwapsModal()" style="background: var(--bg-tertiary); color: var(--text-primary);">Done</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="exerciseModal">
        <div class="modal exercise-library-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    Add Exercise
                </h3>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="create-exercise-header-btn" onclick="openCustomExerciseModal()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Create Custom
                    </button>
                    <button class="modal-close" onclick="closeExerciseModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <input type="text" class="form-input" id="exerciseSearchInput" placeholder="Search exercises (e.g., tricep, bench press...)" oninput="searchExercises(this.value)" style="margin-bottom: 16px;">

                <!-- Muscle Group Pills -->
                <div class="exercise-filters">
                    <button class="filter-chip active" onclick="filterExercises('all', this)">All</button>
                    <button class="filter-chip" onclick="filterExercises('chest', this)">Chest</button>
                    <button class="filter-chip" onclick="filterExercises('back', this)">Back</button>
                    <button class="filter-chip" onclick="filterExercises('shoulders', this)">Shoulders</button>
                    <button class="filter-chip" onclick="filterExercises('legs', this)">Legs</button>
                    <button class="filter-chip" onclick="filterExercises('arms', this)">Arms</button>
                    <button class="filter-chip" onclick="filterExercises('core', this)">Core</button>
                </div>

                <!-- Advanced Filters Row -->
                <div class="advanced-filters-row" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                    <div class="filter-dropdown-group" style="flex: 1; min-width: 140px;">
                        <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">Equipment</label>
                        <select id="equipmentFilter" class="form-input" onchange="applyFilters()" style="width: 100%;">
                            <option value="">All Equipment</option>
                            <option value="barbell">Barbell</option>
                            <option value="dumbbell">Dumbbell</option>
                            <option value="cable">Cable</option>
                            <option value="machine">Machine</option>
                            <option value="bodyweight">Bodyweight</option>
                            <option value="kettlebell">Kettlebell</option>
                            <option value="resistance band">Resistance Band</option>
                            <option value="smith machine">Smith Machine</option>
                            <option value="ez bar">EZ Bar</option>
                        </select>
                    </div>
                    <div class="filter-dropdown-group" style="flex: 1; min-width: 140px;">
                        <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">Difficulty</label>
                        <select id="difficultyFilter" class="form-input" onchange="applyFilters()" style="width: 100%;">
                            <option value="">All Levels</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="filter-dropdown-group" style="flex: 1; min-width: 140px;">
                        <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">Type</label>
                        <select id="exerciseTypeFilter" class="form-input" onchange="applyFilters()" style="width: 100%;">
                            <option value="">All Types</option>
                            <option value="strength">Strength</option>
                            <option value="cardio">Cardio</option>
                            <option value="flexibility">Flexibility</option>
                            <option value="plyometric">Plyometric</option>
                        </select>
                    </div>
                </div>

                <!-- Results count -->
                <div id="exerciseResultsCount" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Loading exercises...</div>

                <div class="exercise-grid" id="exerciseGrid">
                    <!-- Exercises loaded here -->
                </div>

                <!-- Load More Button -->
                <button id="loadMoreBtn" class="btn-secondary" onclick="loadMoreExercises()" style="width: 100%; margin-top: 16px; display: none;">
                    Load More Exercises
                </button>
            </div>
        </div>
    </div>

    <!-- Thumbnail Upload Modal -->
    <div class="modal-overlay" id="thumbnailModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Upload Thumbnail
                </h3>
                <button class="modal-close" onclick="closeThumbnailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="thumbnailExerciseName" style="font-weight: 600; margin-bottom: 16px; color: var(--text-primary);"></div>

                <div id="thumbnailPreviewContainer" style="margin-bottom: 16px; text-align: center; display: none;">
                    <img id="thumbnailPreview" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color);">
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <button class="btn-secondary" onclick="document.getElementById('thumbnailFileInput').click()" style="flex: 1;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Upload Image
                    </button>
                    <input type="file" id="thumbnailFileInput" accept="image/*" onchange="previewThumbnail(event)" style="display: none;">
                </div>

                <div style="text-align: center; color: var(--text-muted); margin-bottom: 16px;">or</div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">Paste Image URL</label>
                    <input type="text" id="thumbnailUrlInput" class="form-input" placeholder="https://example.com/image.jpg" oninput="previewThumbnailUrl(this.value)">
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px;">
                <button class="btn-secondary" onclick="closeThumbnailModal()">Cancel</button>
                <button class="btn-primary" id="saveThumbnailBtn" onclick="saveThumbnail()" disabled>
                    Save Thumbnail
                </button>
            </div>
        </div>
    </div>

    <!-- Exercise Preview Modal -->
    <div class="modal-overlay" id="exercisePreviewModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="previewExerciseName">Exercise Preview</h3>
                <button class="modal-close" onclick="closeExercisePreview()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div id="previewVideoContainer" style="width: 100%; aspect-ratio: 16/9; background: #000; display: flex; align-items: center; justify-content: center; position: relative;">
                    <div id="videoLoader" style="position: absolute; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                        <div style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span style="color: #fff; font-size: 14px;">Loading video...</span>
                    </div>
                    <video id="previewVideo" controls loop muted playsinline preload="auto" style="width: 100%; height: 100%; object-fit: contain;"></video>
                </div>
                <style>
                    @keyframes spin { to { transform: rotate(360deg); } }
                </style>
                <div style="padding: 20px;">
                    <div id="previewExerciseMeta" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;"></div>
                    <button class="btn btn-primary" onclick="addExerciseFromPreview()" style="width: 100%;">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add to Workout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Generate Modal -->
    <div class="modal-overlay" id="aiModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    AI Workout Generator
                </h3>
                <button class="modal-close" onclick="closeAIModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ai-form-group">
                    <label>Client Name (optional)</label>
                    <input type="text" id="aiClientName" placeholder="e.g., John Smith">
                </div>
                <div class="ai-form-row">
                    <div class="ai-form-group">
                        <label>Training Goal</label>
                        <select id="aiGoal">
                            <option value="strength">Strength</option>
                            <option value="hypertrophy" selected>Hypertrophy (Muscle Building)</option>
                            <option value="fat_loss">Fat Loss</option>
                            <option value="general_fitness">General Fitness</option>
                        </select>
                    </div>
                    <div class="ai-form-group">
                        <label>Experience Level</label>
                        <select id="aiExperience">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate" selected>Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </div>
                <div class="ai-form-row">
                    <div class="ai-form-group">
                        <label>Days Per Week</label>
                        <select id="aiDaysPerWeek">
                            <option value="1">1 day</option>
                            <option value="2">2 days</option>
                            <option value="3">3 days</option>
                            <option value="4" selected>4 days</option>
                            <option value="5">5 days</option>
                            <option value="6">6 days</option>
                        </select>
                    </div>
                    <div class="ai-form-group">
                        <label>Program Duration</label>
                        <select id="aiDuration">
                            <option value="4" selected>4 weeks</option>
                            <option value="6">6 weeks</option>
                            <option value="8">8 weeks</option>
                        </select>
                    </div>
                </div>
                <div class="ai-form-row">
                    <div class="ai-form-group">
                        <label>Workout Split</label>
                        <select id="aiSplit">
                            <option value="auto" selected>Auto (AI decides)</option>
                            <option value="push_pull_legs">Push/Pull/Legs</option>
                            <option value="upper_lower">Upper/Lower</option>
                            <option value="full_body">Full Body</option>
                            <option value="bro_split">Bro Split (1 muscle/day)</option>
                            <option value="push_pull">Push/Pull (2-day)</option>
                        </select>
                    </div>
                    <div class="ai-form-group">
                        <label>Session Duration</label>
                        <select id="aiSessionDuration">
                            <option value="30">~30 minutes</option>
                            <option value="45">~45 minutes</option>
                            <option value="60" selected>~60 minutes</option>
                            <option value="90">~90 minutes</option>
                        </select>
                    </div>
                </div>
                <div class="ai-form-row">
                    <div class="ai-form-group">
                        <label>Training Style</label>
                        <select id="aiTrainingStyle">
                            <option value="straight_sets" selected>Straight Sets</option>
                            <option value="supersets">Supersets</option>
                            <option value="circuits">Circuits</option>
                            <option value="mixed">Mixed</option>
                        </select>
                    </div>
                    <div class="ai-form-group">
                        <label>Exercises Per Workout</label>
                        <select id="aiExerciseCount">
                            <option value="4-5">4-5 (Quick)</option>
                            <option value="5-6" selected>5-6 (Standard)</option>
                            <option value="6-8">6-8 (Comprehensive)</option>
                            <option value="8-10">8-10 (High Volume)</option>
                        </select>
                    </div>
                </div>
                <div class="ai-form-group">
                    <label>Focus Areas (optional)</label>
                    <div class="equipment-grid">
                        <label class="equipment-item">
                            <input type="checkbox" name="focusArea" value="chest"> Chest
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="focusArea" value="back"> Back
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="focusArea" value="shoulders"> Shoulders
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="focusArea" value="arms"> Arms
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="focusArea" value="legs"> Legs
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="focusArea" value="core"> Core
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="focusArea" value="glutes"> Glutes
                        </label>
                    </div>
                </div>
                <div class="ai-form-group">
                    <label>Available Equipment</label>
                    <div class="equipment-grid">
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="barbell" checked> Barbell
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="dumbbell" checked> Dumbbells
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="cable" checked> Cables
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="machine" checked> Machines
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="bodyweight" checked> Bodyweight
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="kettlebell"> Kettlebells
                        </label>
                    </div>
                </div>
                <div class="ai-form-group">
                    <label>Injuries or Limitations (optional)</label>
                    <input type="text" id="aiInjuries" placeholder="e.g., Lower back pain, avoid overhead pressing">
                </div>
                <div class="ai-form-group">
                    <label>Additional Preferences (optional)</label>
                    <textarea id="aiPreferences" rows="2" placeholder="e.g., Include stretching, prefer compound movements"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="ai-btn ai-btn-cancel" onclick="closeAIModal()">Cancel</button>
                <button class="ai-btn ai-btn-generate" id="aiGenerateBtn" onclick="generateAIWorkout()">
                    Generate Program
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="confirm-modal-overlay" id="confirmDeleteModal">
        <div class="confirm-modal">
            <div class="confirm-modal-icon">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            </div>
            <div class="confirm-modal-title">Delete Program</div>
            <div class="confirm-modal-message" id="confirmDeleteMessage">Are you sure you want to delete this program? This action cannot be undone.</div>
            <div class="confirm-modal-actions">
                <button class="btn btn-secondary" onclick="closeConfirmDeleteModal()" style="background: var(--bg-tertiary); color: var(--text-primary);">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteProgram()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Create Custom Exercise Modal -->
    <div class="modal-overlay" id="customExerciseModal">
        <div class="modal custom-exercise-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Create Custom Exercise
                </h3>
                <button class="modal-close" onclick="closeCustomExerciseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="custom-exercise-form-group">
                    <label>Exercise Name <span class="required">*</span></label>
                    <input type="text" class="form-input" id="ceExerciseName" placeholder="e.g., Single Arm Cable Row">
                </div>

                <div class="custom-exercise-form-row">
                    <div class="custom-exercise-form-group">
                        <label>Muscle Group <span class="required">*</span></label>
                        <select class="form-input" id="ceMuscleGroup">
                            <option value="">Select muscle group</option>
                            <option value="chest">Chest</option>
                            <option value="back">Back</option>
                            <option value="shoulders">Shoulders</option>
                            <option value="biceps">Biceps</option>
                            <option value="triceps">Triceps</option>
                            <option value="forearms">Forearms</option>
                            <option value="core">Core</option>
                            <option value="quadriceps">Quadriceps</option>
                            <option value="hamstrings">Hamstrings</option>
                            <option value="glutes">Glutes</option>
                            <option value="calves">Calves</option>
                            <option value="full body">Full Body</option>
                        </select>
                    </div>
                    <div class="custom-exercise-form-group">
                        <label>Equipment</label>
                        <select class="form-input" id="ceEquipment">
                            <option value="">Select equipment</option>
                            <option value="barbell">Barbell</option>
                            <option value="dumbbell">Dumbbell</option>
                            <option value="cable">Cable</option>
                            <option value="machine">Machine</option>
                            <option value="bodyweight">Bodyweight</option>
                            <option value="kettlebell">Kettlebell</option>
                            <option value="resistance band">Resistance Band</option>
                            <option value="smith machine">Smith Machine</option>
                            <option value="ez bar">EZ Bar</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="custom-exercise-form-row">
                    <div class="custom-exercise-form-group">
                        <label>Difficulty</label>
                        <select class="form-input" id="ceDifficulty">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate" selected>Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="custom-exercise-form-group">
                        <label>Exercise Type</label>
                        <select class="form-input" id="ceExerciseType">
                            <option value="strength" selected>Strength</option>
                            <option value="cardio">Cardio</option>
                            <option value="flexibility">Flexibility</option>
                            <option value="plyometric">Plyometric</option>
                        </select>
                    </div>
                </div>

                <div class="custom-exercise-form-group">
                    <label>Instructions (optional)</label>
                    <textarea class="form-textarea" id="ceInstructions" placeholder="Describe how to perform this exercise correctly..." rows="3"></textarea>
                </div>

                <!-- Video Upload Section -->
                <div class="video-upload-section">
                    <h4>
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        Demo Video (optional)
                    </h4>
                    <div class="video-upload-options">
                        <div class="video-upload-option" onclick="triggerCEVideoUpload()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                            </svg>
                            <span>Upload Video</span>
                        </div>
                        <div class="video-upload-option" onclick="startCEVideoRecording()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            <span>Record Video</span>
                        </div>
                    </div>
                    <input type="file" id="ceVideoFileInput" accept="video/*" onchange="handleCEVideoUpload(event)" style="display: none;">

                    <!-- Recording indicator -->
                    <div class="ce-recording-indicator" id="ceRecordingIndicator" style="display: none;">
                        <div class="recording-dot"></div>
                        <span class="recording-timer" id="ceRecordingTimer">0:00</span>
                        <span class="recording-text">Recording... (max 20 sec)</span>
                        <button class="btn btn-secondary" onclick="stopCEVideoRecording()" style="margin-left: auto; padding: 6px 12px; font-size: 12px;">Stop</button>
                    </div>

                    <!-- Video Preview -->
                    <div class="custom-video-preview-container" id="ceVideoPreview">
                        <video id="cePreviewVideo" controls muted playsinline></video>
                        <div class="custom-video-preview-info">
                            <span id="ceVideoSize">Video ready</span>
                            <button class="btn btn-secondary" onclick="removeCEVideo()" style="padding: 6px 12px; font-size: 12px; background: rgba(239, 68, 68, 0.1); color: var(--danger);">
                                Remove Video
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; padding: 16px 24px; border-top: 1px solid var(--border-color);">
                <button class="btn btn-secondary" onclick="closeCustomExerciseModal()" style="background: var(--bg-tertiary); color: var(--text-primary);">Cancel</button>
                <button class="btn btn-primary" id="saveCustomExerciseBtn" onclick="saveCustomExercise()" style="background: var(--brand-gradient); color: white;">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Create Exercise
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase (for auth only)
        const SUPABASE_URL = 'https://qewqcjzlfqamqwbccapr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFld3FjanpsZnFhbXF3YmNjYXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2OTg0NzAsImV4cCI6MjA3OTI3NDQ3MH0.mQnMC33O88oLkLLGWD2oG-oaSHGI-NfHmtQCZxnxSLs';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let currentCoachId = null;
        let currentAccessToken = null;
        let currentProgramId = null;
        let programs = [];
        let exercises = [];
        let clients = [];
        let workoutDays = [];
        let selectedClients = new Set();
        let currentDayIndex = null;
        let currentExerciseFilter = 'all';
        let currentSearchTerm = '';
        let currentEquipmentFilter = '';
        let currentDifficultyFilter = '';
        let currentExerciseTypeFilter = '';
        let displayedExerciseCount = 0;
        const EXERCISES_PER_PAGE = 50;
        let currentThumbnailExercise = null;
        let pendingThumbnailData = null;
        let pendingDeleteProgramId = null;

        // Voice recording state
        let mediaRecorder = null;
        let audioChunks = [];
        let currentRecordingExercise = null;

        // Custom exercise state
        let ceVideoRecorder = null;
        let ceVideoChunks = [];
        let ceVideoData = null;
        let ceRecordingInterval = null;

        // Helper for authenticated API calls
        async function apiCall(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...(currentAccessToken && { 'Authorization': `Bearer ${currentAccessToken}` }),
                ...options.headers
            };
            const response = await fetch(url, { ...options, headers });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || data.message || 'API request failed');
            }
            return data;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
        });

        // Auth check
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentCoachId = session.user.id;
            currentAccessToken = session.access_token;

            // Check gym features
            const enabled = await initGymFeatures({ email: session.user.email });
            if (!enabled) {
                showToast('Gym features not enabled for your account', 'error');
                setTimeout(() => window.location.href = 'dashboard.html', 2000);
                return;
            }

            // Load data
            await Promise.all([
                loadPrograms(),
                loadExercises(),
                loadClients()
            ]);

            // Add initial day
            if (workoutDays.length === 0) {
                addWorkoutDay();
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${type === 'success'
                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'}
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Load programs
        async function loadPrograms() {
            try {
                const result = await apiCall(`/.netlify/functions/workout-programs?coachId=${currentCoachId}`);
                programs = result.programs || [];
                renderProgramList();
            } catch (err) {
                console.error('Error loading programs:', err);
                programs = [];
                renderProgramList();
            }
        }

        // Render program list
        function renderProgramList() {
            const container = document.getElementById('programList');
            if (programs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <div class="empty-title">No programs yet</div>
                        <p>Create your first workout program</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = programs.map(p => `
                <div class="program-item ${p.id === currentProgramId ? 'active' : ''}" onclick="selectProgram(${p.id})">
                    <div class="program-item-content">
                        <div class="program-name">${p.name}</div>
                        <div class="program-meta">
                            <span>${p.difficulty || 'Intermediate'}</span>
                            <span></span>
                            <span>${p.days_per_week || 3} days/week</span>
                        </div>
                    </div>
                    <div class="program-item-actions">
                        <button class="program-action-btn duplicate-btn" onclick="event.stopPropagation(); duplicateProgram(${p.id})" title="Duplicate program">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                        <button class="program-action-btn delete-btn" onclick="event.stopPropagation(); openDeleteConfirm(${p.id}, '${p.name.replace(/'/g, "\\'")}')" title="Delete program">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Select program
        function selectProgram(programId) {
            currentProgramId = programId;
            const program = programs.find(p => p.id === programId);
            if (program) {
                document.getElementById('programName').value = program.name || '';
                document.getElementById('programType').value = program.program_type || 'strength';
                document.getElementById('programDifficulty').value = program.difficulty || 'intermediate';
                document.getElementById('daysPerWeek').value = program.days_per_week || 3;
                document.getElementById('programDescription').value = program.description || '';

                // Load hero image if exists (from program_data.image_url)
                const heroUrl = program.program_data?.image_url || null;
                setHeroImage(heroUrl);
                pendingHeroImageData = null;

                workoutDays = program.program_data?.days || [];
                renderWorkoutDays();
                enableAssignButton(); // Enable assign button for existing program
            }
            renderProgramList();
        }

        // Create new program
        function createNewProgram() {
            currentProgramId = null;
            document.getElementById('programName').value = '';
            document.getElementById('programType').value = 'hypertrophy';
            document.getElementById('programDifficulty').value = 'intermediate';
            document.getElementById('daysPerWeek').value = '4';
            document.getElementById('programDescription').value = '';

            // Reset hero image
            removeHeroImage();

            workoutDays = [];
            selectedClients.clear();
            addWorkoutDay();
            renderProgramList();
            // Disable assign button until program is saved
            const btn = document.getElementById('assignBtn');
            if (btn) btn.disabled = true;
        }

        // Add workout day
        function addWorkoutDay() {
            const dayNum = workoutDays.length + 1;
            workoutDays.push({
                name: `Day ${dayNum}`,
                exercises: []
            });
            renderWorkoutDays();
        }

        // Render workout days
        function renderWorkoutDays() {
            const container = document.getElementById('workoutDays');
            if (workoutDays.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Add your first workout day</p></div>';
                return;
            }

            container.innerHTML = workoutDays.map((day, dayIndex) => `
                <div class="workout-day">
                    <div class="workout-day-header">
                        <input type="text" class="day-name-input" value="${day.name}" onchange="updateDayName(${dayIndex}, this.value)">
                        <div class="workout-day-actions">
                            <button class="icon-btn" onclick="removeWorkoutDay(${dayIndex})" title="Remove day">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="exercise-list">
                        ${day.exercises.map((ex, exIndex) => renderExerciseItem(ex, dayIndex, exIndex)).join('')}
                    </div>
                    <button class="add-exercise-btn" onclick="openExerciseModal(${dayIndex})">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Exercise
                    </button>
                </div>
            `).join('');
        }

        // Render single exercise item
        function renderExerciseItem(exercise, dayIndex, exIndex) {
            const hasVideo = exercise.video_url || exercise.animation_url;
            const videoSrc = exercise.video_url || exercise.animation_url;
            const thumbHtml = hasVideo
                ? `<video class="exercise-thumb-video" src="${videoSrc}" muted loop playsinline preload="metadata" onmouseenter="this.play()" onmouseleave="this.pause()"></video>`
                : `<img class="exercise-thumb" src="${exercise.thumbnail_url || '/img/exercise-placeholder.svg'}" alt="${exercise.name}" onerror="this.src='/img/exercise-placeholder.svg'">`;

            // Build badges for superset, warmup, stretch
            let badges = '';
            if (exercise.isSuperset && exercise.supersetGroup) {
                badges += `<span class="exercise-badge superset-badge">Superset ${exercise.supersetGroup}</span>`;
            }
            if (exercise.isWarmup) {
                badges += `<span class="exercise-badge warmup-badge">Warm-up</span>`;
            }
            if (exercise.isStretch) {
                badges += `<span class="exercise-badge stretch-badge">Stretch</span>`;
            }

            return `
                <div class="exercise-item ${exercise.isSuperset ? 'superset-exercise' : ''} ${exercise.isWarmup ? 'warmup-exercise' : ''} ${exercise.isStretch ? 'stretch-exercise' : ''}">
                    <div class="exercise-drag"></div>
                    <div class="exercise-thumb-wrap">
                        ${thumbHtml}
                        ${hasVideo ? '<div class="video-badge"><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>' : ''}
                    </div>
                    <div class="exercise-info">
                        <div class="exercise-name-row">
                            <div class="exercise-name">${exercise.name}</div>
                            ${badges ? `<div class="exercise-badges">${badges}</div>` : ''}
                        </div>
                        <div class="exercise-config">
                            <div class="config-group">
                                <input type="number" class="config-input" value="${exercise.sets || 3}" onchange="updateExercise(${dayIndex}, ${exIndex}, 'sets', this.value)">
                                <span class="config-label">Sets</span>
                            </div>
                            <div class="config-group">
                                ${exercise.trackingType === 'time'
                                    ? `<input type="number" class="config-input" value="${exercise.duration || 30}" onchange="updateExercise(${dayIndex}, ${exIndex}, 'duration', this.value)" style="width:70px">`
                                    : `<input type="text" class="config-input" value="${exercise.reps || '10'}" onchange="updateExercise(${dayIndex}, ${exIndex}, 'reps', this.value)" style="width:70px">`
                                }
                                <button class="tracking-toggle-btn ${exercise.trackingType === 'time' ? 'time-active' : ''}" onclick="toggleTrackingType(${dayIndex}, ${exIndex})" title="Toggle between reps and time">
                                    <span class="toggle-icon">${exercise.trackingType === 'time' ? '' : '#'}</span>
                                    ${exercise.trackingType === 'time' ? 'Secs' : 'Reps'}
                                </button>
                            </div>
                            <div class="config-group">
                                <input type="number" class="config-input" value="${exercise.restSeconds || 90}" onchange="updateExercise(${dayIndex}, ${exIndex}, 'restSeconds', this.value)">
                                <span class="config-label">Rest</span>
                            </div>
                        </div>
                        <div class="exercise-notes">
                            <input type="text" class="notes-input" value="${exercise.notes || ''}" placeholder="Add notes (e.g., tempo, form tips...)" onchange="updateExercise(${dayIndex}, ${exIndex}, 'notes', this.value)">
                        </div>
                        <div class="voice-note-container" id="voiceNote-${dayIndex}-${exIndex}">
                            ${exercise.voiceNoteUrl ? `
                                <div class="voice-note-player">
                                    <audio controls src="${exercise.voiceNoteUrl}" style="height: 28px; width: 100%;"></audio>
                                    <button class="voice-note-delete" onclick="deleteVoiceNote(${dayIndex}, ${exIndex})" title="Delete voice note"></button>
                                </div>
                            ` : `
                                <button class="voice-note-btn" id="voiceBtn-${dayIndex}-${exIndex}" onclick="toggleVoiceRecording(${dayIndex}, ${exIndex})" title="Record voice note">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                                    </svg>
                                </button>
                                <span style="font-size: 11px; color: var(--text-muted);">Add voice tip for client</span>
                            `}
                        </div>
                        <div class="custom-video-container" id="customVideo-${dayIndex}-${exIndex}">
                            ${exercise.customVideoUrl ? `
                                <div class="custom-video-preview">
                                    <video src="${exercise.customVideoUrl}" muted></video>
                                    <div class="video-info">
                                        <span class="video-label">Custom Demo</span><br>
                                        Your video will show to client
                                    </div>
                                    <button class="custom-video-delete" onclick="deleteCustomVideo(${dayIndex}, ${exIndex})" title="Delete video"></button>
                                </div>
                            ` : `
                                <button class="custom-video-btn" id="videoRecordBtn-${dayIndex}-${exIndex}" onclick="startVideoRecording(${dayIndex}, ${exIndex})" title="Record custom demo">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                    Record Demo
                                </button>
                                <span style="font-size: 11px; color: var(--text-muted);">or</span>
                                <label class="custom-video-btn" style="margin: 0;">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                    </svg>
                                    Upload
                                    <input type="file" class="video-upload-input" accept="video/*" onchange="handleVideoUpload(event, ${dayIndex}, ${exIndex})">
                                </label>
                            `}
                        </div>
                        ${exercise.recommendedSwaps && exercise.recommendedSwaps.length > 0 ? `
                            <div class="exercise-has-swaps">
                                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                                ${exercise.recommendedSwaps.length} recommended swap${exercise.recommendedSwaps.length > 1 ? 's' : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="exercise-actions">
                        <button class="icon-btn recommended-swaps-btn" onclick="openRecommendedSwapsModal(${dayIndex}, ${exIndex})" title="Manage recommended swaps">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                            ${exercise.recommendedSwaps && exercise.recommendedSwaps.length > 0 ? `<span class="swap-count">${exercise.recommendedSwaps.length}</span>` : ''}
                        </button>
                        <button class="icon-btn swap-btn" onclick="openSwapModal(${dayIndex}, ${exIndex})" title="Swap exercise">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="removeExercise(${dayIndex}, ${exIndex})" title="Remove exercise">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // Update functions
        function updateDayName(dayIndex, name) {
            workoutDays[dayIndex].name = name;
        }

        function updateExercise(dayIndex, exIndex, field, value) {
            if (field === 'sets' || field === 'restSeconds' || field === 'duration') {
                workoutDays[dayIndex].exercises[exIndex][field] = parseInt(value) || 0;
            } else {
                workoutDays[dayIndex].exercises[exIndex][field] = value;
            }
        }

        function toggleTrackingType(dayIndex, exIndex) {
            const exercise = workoutDays[dayIndex].exercises[exIndex];
            if (exercise.trackingType === 'time') {
                exercise.trackingType = 'reps';
            } else {
                exercise.trackingType = 'time';
                if (!exercise.duration) {
                    exercise.duration = 30;
                }
            }
            renderWorkoutDays();
        }

        function removeWorkoutDay(dayIndex) {
            if (confirm('Remove this workout day?')) {
                workoutDays.splice(dayIndex, 1);
                renderWorkoutDays();
            }
        }

        function removeExercise(dayIndex, exIndex) {
            workoutDays[dayIndex].exercises.splice(exIndex, 1);
            renderWorkoutDays();
        }

        // ============ SWAP EXERCISE FUNCTIONS ============
        let swapDayIndex = null;
        let swapExIndex = null;
        let swapExerciseCache = [];

        function openSwapModal(dayIndex, exIndex) {
            swapDayIndex = dayIndex;
            swapExIndex = exIndex;

            const currentExercise = workoutDays[dayIndex].exercises[exIndex];
            document.getElementById('swapCurrentName').textContent = currentExercise.name;
            document.getElementById('swapSearchInput').value = '';

            // Filter exercises by same muscle group
            const muscleGroup = currentExercise.muscle_group || currentExercise.muscleGroup || '';

            // Get exercises from the same muscle group (excluding current)
            swapExerciseCache = exercises.filter(ex => {
                const exMuscle = ex.muscle_group || '';
                const isMatch = exMuscle.toLowerCase() === muscleGroup.toLowerCase() ||
                    (ex.secondary_muscles && ex.secondary_muscles.some(m =>
                        m.toLowerCase() === muscleGroup.toLowerCase()));
                return isMatch && ex.id !== currentExercise.id;
            });

            renderSwapExerciseList(swapExerciseCache);
            document.getElementById('swapModal').classList.add('active');
        }

        function closeSwapModal() {
            document.getElementById('swapModal').classList.remove('active');
            swapDayIndex = null;
            swapExIndex = null;
        }

        function filterSwapExercises(query) {
            const filtered = query
                ? swapExerciseCache.filter(ex =>
                    ex.name.toLowerCase().includes(query.toLowerCase()))
                : swapExerciseCache;
            renderSwapExerciseList(filtered);
        }

        function renderSwapExerciseList(exerciseList) {
            const container = document.getElementById('swapExerciseList');

            if (exerciseList.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No alternative exercises found</div>';
                return;
            }

            container.innerHTML = exerciseList.slice(0, 50).map(ex => {
                const hasVideo = ex.video_url || ex.animation_url;
                const videoSrc = ex.video_url || ex.animation_url;
                const thumbHtml = hasVideo
                    ? `<video class="swap-exercise-thumb" src="${videoSrc}" muted loop playsinline preload="metadata" onmouseenter="this.play()" onmouseleave="this.pause()"></video>`
                    : `<img class="swap-exercise-thumb" src="${ex.thumbnail_url || '/img/exercise-placeholder.svg'}" alt="${ex.name}" onerror="this.src='/img/exercise-placeholder.svg'">`;
                return `
                    <div class="swap-exercise-item" onclick="selectSwapExercise('${ex.id}')">
                        ${thumbHtml}
                        <div class="swap-exercise-info">
                            <div class="swap-exercise-name">${ex.name}</div>
                            <div class="swap-exercise-meta">${ex.muscle_group || ''} ${ex.equipment ? ' ' + ex.equipment : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectSwapExercise(exerciseId) {
            const newExercise = exercises.find(ex => String(ex.id) === String(exerciseId));
            if (!newExercise || swapDayIndex === null || swapExIndex === null) return;

            // Keep the existing sets/reps/rest config
            const oldExercise = workoutDays[swapDayIndex].exercises[swapExIndex];

            workoutDays[swapDayIndex].exercises[swapExIndex] = {
                id: newExercise.id,
                name: newExercise.name,
                video_url: newExercise.video_url,
                animation_url: newExercise.animation_url,
                thumbnail_url: newExercise.thumbnail_url || newExercise.video_url,
                muscle_group: newExercise.muscle_group,
                equipment: newExercise.equipment,
                instructions: newExercise.instructions,
                sets: oldExercise.sets || 3,
                reps: oldExercise.reps || '8-12',
                restSeconds: oldExercise.restSeconds || 90,
                notes: oldExercise.notes || ''
            };

            renderWorkoutDays();
            closeSwapModal();
            showToast(`Swapped to ${newExercise.name}`, 'success');
        }

        // Load exercises
        async function loadExercises() {
            try {
                // Fetch exercises in batches to handle large exercise libraries
                const batchSize = 1000;
                let allExercises = [];
                let offset = 0;
                let hasMore = true;

                while (hasMore) {
                    const result = await apiCall(`/.netlify/functions/exercises?coachId=${currentCoachId}&limit=${batchSize}&offset=${offset}`);
                    const batch = result.exercises || [];
                    allExercises = allExercises.concat(batch);

                    // Check if there are more exercises to fetch
                    if (batch.length < batchSize || allExercises.length >= result.total) {
                        hasMore = false;
                    } else {
                        offset += batchSize;
                    }
                }

                exercises = allExercises;
                console.log(`Loaded ${exercises.length} exercises total`);
            } catch (err) {
                console.error('Error loading exercises:', err);
                // Fallback exercises
                exercises = [
                    { id: 1, name: 'Bench Press', muscle_group: 'chest', equipment: 'barbell' },
                    { id: 2, name: 'Squat', muscle_group: 'legs', equipment: 'barbell' },
                    { id: 3, name: 'Deadlift', muscle_group: 'back', equipment: 'barbell' },
                    { id: 4, name: 'Overhead Press', muscle_group: 'shoulders', equipment: 'barbell' },
                    { id: 5, name: 'Barbell Row', muscle_group: 'back', equipment: 'barbell' },
                    { id: 6, name: 'Pull-ups', muscle_group: 'back', equipment: 'bodyweight' },
                    { id: 7, name: 'Dips', muscle_group: 'chest', equipment: 'bodyweight' },
                    { id: 8, name: 'Lunges', muscle_group: 'legs', equipment: 'bodyweight' },
                ];
            }
        }

        // Exercise modal
        function openExerciseModal(dayIndex) {
            currentDayIndex = dayIndex;
            resetExerciseFilters();
            document.getElementById('exerciseModal').classList.add('active');
            renderExerciseGrid();
        }

        function closeExerciseModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        function filterExercises(muscle, btn) {
            currentExerciseFilter = muscle;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            displayedExerciseCount = 0;
            renderExerciseGrid();
        }

        function searchExercises(term) {
            currentSearchTerm = term.toLowerCase();
            displayedExerciseCount = 0;
            renderExerciseGrid();
        }

        function applyFilters() {
            currentEquipmentFilter = document.getElementById('equipmentFilter').value;
            currentDifficultyFilter = document.getElementById('difficultyFilter').value;
            currentExerciseTypeFilter = document.getElementById('exerciseTypeFilter').value;
            displayedExerciseCount = 0;
            renderExerciseGrid();
        }

        function getFilteredExercises() {
            let filtered = exercises;

            // Filter by muscle group (including secondary muscles)
            if (currentExerciseFilter !== 'all') {
                filtered = filtered.filter(e => {
                    const primaryMatch = e.muscle_group?.toLowerCase() === currentExerciseFilter ||
                        e.primary_muscles?.toLowerCase().includes(currentExerciseFilter);

                    // Check secondary muscles (can be array or string)
                    let secondaryMatch = false;
                    if (e.secondary_muscles) {
                        if (Array.isArray(e.secondary_muscles)) {
                            secondaryMatch = e.secondary_muscles.some(m =>
                                m.toLowerCase().includes(currentExerciseFilter)
                            );
                        } else if (typeof e.secondary_muscles === 'string') {
                            secondaryMatch = e.secondary_muscles.toLowerCase().includes(currentExerciseFilter);
                        }
                    }

                    // Special handling for "arms" to include biceps and triceps
                    if (currentExerciseFilter === 'arms') {
                        const armMuscles = ['biceps', 'triceps', 'forearms', 'arms'];
                        const armPrimaryMatch = armMuscles.some(m =>
                            e.muscle_group?.toLowerCase().includes(m) ||
                            e.primary_muscles?.toLowerCase().includes(m)
                        );
                        const armSecondaryMatch = e.secondary_muscles && (
                            Array.isArray(e.secondary_muscles)
                                ? e.secondary_muscles.some(sm => armMuscles.some(m => sm.toLowerCase().includes(m)))
                                : armMuscles.some(m => e.secondary_muscles.toLowerCase().includes(m))
                        );
                        return armPrimaryMatch || armSecondaryMatch;
                    }

                    return primaryMatch || secondaryMatch;
                });
            }

            // Filter by equipment
            if (currentEquipmentFilter) {
                filtered = filtered.filter(e =>
                    e.equipment?.toLowerCase() === currentEquipmentFilter.toLowerCase()
                );
            }

            // Filter by difficulty
            if (currentDifficultyFilter) {
                filtered = filtered.filter(e =>
                    e.difficulty?.toLowerCase() === currentDifficultyFilter.toLowerCase()
                );
            }

            // Filter by exercise type
            if (currentExerciseTypeFilter) {
                filtered = filtered.filter(e =>
                    e.exercise_type?.toLowerCase() === currentExerciseTypeFilter.toLowerCase()
                );
            }

            // Search filter (includes name, muscle_group, and secondary_muscles)
            if (currentSearchTerm) {
                filtered = filtered.filter(e => {
                    const nameMatch = e.name.toLowerCase().includes(currentSearchTerm);
                    const muscleMatch = e.muscle_group?.toLowerCase().includes(currentSearchTerm);
                    const primaryMatch = e.primary_muscles?.toLowerCase().includes(currentSearchTerm);

                    // Check secondary muscles for search
                    let secondaryMatch = false;
                    if (e.secondary_muscles) {
                        if (Array.isArray(e.secondary_muscles)) {
                            secondaryMatch = e.secondary_muscles.some(m =>
                                m.toLowerCase().includes(currentSearchTerm)
                            );
                        } else if (typeof e.secondary_muscles === 'string') {
                            secondaryMatch = e.secondary_muscles.toLowerCase().includes(currentSearchTerm);
                        }
                    }

                    return nameMatch || muscleMatch || primaryMatch || secondaryMatch;
                });
            }

            return filtered;
        }

        function renderExerciseGrid(append = false) {
            const container = document.getElementById('exerciseGrid');
            const countDisplay = document.getElementById('exerciseResultsCount');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            const filtered = getFilteredExercises();
            const totalCount = filtered.length;

            // Update results count
            countDisplay.textContent = `${totalCount} exercise${totalCount !== 1 ? 's' : ''} found`;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No exercises found</p><span style="color: var(--text-secondary); font-size: 13px;">Try adjusting your filters or search term</span></div>';
                loadMoreBtn.style.display = 'none';
                return;
            }

            // Determine how many to show
            const endIndex = append ? displayedExerciseCount + EXERCISES_PER_PAGE : EXERCISES_PER_PAGE;
            const exercisesToShow = filtered.slice(0, endIndex);
            displayedExerciseCount = exercisesToShow.length;

            // Show/hide load more button
            if (displayedExerciseCount < totalCount) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.textContent = `Load More (${displayedExerciseCount} of ${totalCount})`;
            } else {
                loadMoreBtn.style.display = 'none';
            }

            const exerciseHTML = exercisesToShow.map(ex => {
                const hasVideo = ex.video_url || ex.animation_url;
                // Determine what to display: prefer thumbnail_url (image), then try video sources
                const thumbnailImg = ex.thumbnail_url;
                const videoSrc = ex.animation_url || ex.video_url;
                const hasThumbnail = thumbnailImg && !thumbnailImg.includes('placeholder');
                const secondaryMuscles = ex.secondary_muscles
                    ? (Array.isArray(ex.secondary_muscles) ? ex.secondary_muscles.slice(0, 2).join(', ') : ex.secondary_muscles)
                    : '';

                // Determine media element - use img for images, video for mp4s
                let mediaElement;
                if (thumbnailImg) {
                    // Has a proper thumbnail image
                    mediaElement = `<img class="exercise-card-thumb" src="${thumbnailImg}" alt="${ex.name}" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='block';" loading="lazy"><video class="exercise-card-thumb" src="${videoSrc || ''}" muted playsinline preload="metadata" style="display:none;"></video>`;
                } else if (videoSrc) {
                    // No thumbnail, but has video - show video first frame
                    mediaElement = `<video class="exercise-card-thumb" src="${videoSrc}" muted playsinline preload="metadata"></video>`;
                } else {
                    // No media at all
                    mediaElement = `<img class="exercise-card-thumb" src="/img/exercise-placeholder.svg" alt="${ex.name}">`;
                }

                return `
                <div class="exercise-card" onclick='openExercisePreview(${JSON.stringify(ex).replace(/'/g, "\\'")})'>
                    <div class="exercise-thumb-container">
                        ${mediaElement}
                        ${hasVideo ? '<div class="video-indicator"></div>' : ''}
                        <button class="edit-thumb-btn ${hasThumbnail ? '' : 'no-thumb'}" onclick="event.stopPropagation(); openThumbnailModal(${JSON.stringify(ex).replace(/"/g, '&quot;')})" title="${hasThumbnail ? 'Change thumbnail' : 'Add thumbnail'}">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="exercise-card-name">
                        ${ex.name}
                        ${ex.is_custom ? '<span class="custom-exercise-badge">Custom</span>' : ''}
                    </div>
                    <div class="exercise-card-meta">${ex.muscle_group || ex.primary_muscles || 'General'}${ex.equipment ? '  ' + ex.equipment : ''}</div>
                    ${secondaryMuscles ? `<div class="exercise-card-secondary">Also: ${secondaryMuscles}</div>` : ''}
                </div>
            `}).join('');

            if (append) {
                container.innerHTML += exerciseHTML;
            } else {
                container.innerHTML = exerciseHTML;
            }
        }

        function loadMoreExercises() {
            renderExerciseGrid(true);
        }

        function resetExerciseFilters() {
            currentExerciseFilter = 'all';
            currentSearchTerm = '';
            currentEquipmentFilter = '';
            currentDifficultyFilter = '';
            currentExerciseTypeFilter = '';
            displayedExerciseCount = 0;

            // Reset UI
            document.querySelectorAll('.filter-chip').forEach((c, i) => {
                c.classList.toggle('active', i === 0);
            });
            document.getElementById('exerciseSearchInput').value = '';
            document.getElementById('equipmentFilter').value = '';
            document.getElementById('difficultyFilter').value = '';
            document.getElementById('exerciseTypeFilter').value = '';
        }

        // ============ THUMBNAIL UPLOAD FUNCTIONS ============

        function openThumbnailModal(exercise) {
            currentThumbnailExercise = exercise;
            pendingThumbnailData = null;
            document.getElementById('thumbnailExerciseName').textContent = exercise.name;
            document.getElementById('thumbnailPreviewContainer').style.display = 'none';
            document.getElementById('thumbnailPreview').src = '';
            document.getElementById('thumbnailUrlInput').value = '';
            document.getElementById('thumbnailFileInput').value = '';
            document.getElementById('saveThumbnailBtn').disabled = true;
            document.getElementById('thumbnailModal').classList.add('active');
        }

        function closeThumbnailModal() {
            document.getElementById('thumbnailModal').classList.remove('active');
            currentThumbnailExercise = null;
            pendingThumbnailData = null;
        }

        function previewThumbnail(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('thumbnailPreview').src = e.target.result;
                document.getElementById('thumbnailPreviewContainer').style.display = 'block';
                document.getElementById('thumbnailUrlInput').value = '';
                document.getElementById('saveThumbnailBtn').disabled = false;
                pendingThumbnailData = {
                    type: 'file',
                    base64: e.target.result,
                    name: file.name
                };
            };
            reader.readAsDataURL(file);
        }

        function previewThumbnailUrl(url) {
            if (!url.trim()) {
                document.getElementById('thumbnailPreviewContainer').style.display = 'none';
                document.getElementById('saveThumbnailBtn').disabled = true;
                pendingThumbnailData = null;
                return;
            }

            // Show preview
            document.getElementById('thumbnailPreview').src = url;
            document.getElementById('thumbnailPreviewContainer').style.display = 'block';
            document.getElementById('thumbnailFileInput').value = '';
            document.getElementById('saveThumbnailBtn').disabled = false;
            pendingThumbnailData = {
                type: 'url',
                url: url
            };
        }

        async function saveThumbnail() {
            if (!currentThumbnailExercise || !pendingThumbnailData) return;

            const saveBtn = document.getElementById('saveThumbnailBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                let payload = { exerciseId: currentThumbnailExercise.id };

                if (pendingThumbnailData.type === 'url') {
                    payload.thumbnailUrl = pendingThumbnailData.url;
                } else if (pendingThumbnailData.type === 'file') {
                    payload.imageBase64 = pendingThumbnailData.base64;
                    payload.imageName = pendingThumbnailData.name;
                }

                const result = await apiCall('/.netlify/functions/upload-exercise-thumbnail', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (result.success) {
                    // Update the exercise in our local array
                    const exerciseIndex = exercises.findIndex(e => e.id === currentThumbnailExercise.id);
                    if (exerciseIndex !== -1) {
                        exercises[exerciseIndex].thumbnail_url = result.exercise.thumbnail_url;
                    }

                    showToast('Thumbnail updated successfully!');
                    closeThumbnailModal();
                    renderExerciseGrid(); // Refresh the grid to show new thumbnail
                } else {
                    throw new Error(result.error || 'Failed to save thumbnail');
                }
            } catch (err) {
                console.error('Error saving thumbnail:', err);
                showToast('Error saving thumbnail: ' + err.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Thumbnail';
            }
        }

        // ============ HERO IMAGE UPLOAD ============

        let pendingHeroImageData = null;

        function previewHeroImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('heroPreviewImg').src = e.target.result;
                document.getElementById('heroImagePreview').style.display = 'block';
                document.getElementById('heroUploadArea').style.display = 'none';

                pendingHeroImageData = {
                    type: 'file',
                    base64: e.target.result,
                    name: file.name
                };

                // Store temporary marker in hidden field
                document.getElementById('heroImageUrl').value = '__pending_upload__';
            };
            reader.readAsDataURL(file);
        }

        function showHeroUrlInput() {
            document.getElementById('heroUrlInputContainer').style.display = 'block';
        }

        function applyHeroUrl() {
            const url = document.getElementById('heroUrlInput').value.trim();
            if (!url) {
                showToast('Please enter a valid URL', 'error');
                return;
            }

            document.getElementById('heroPreviewImg').src = url;
            document.getElementById('heroImagePreview').style.display = 'block';
            document.getElementById('heroUploadArea').style.display = 'none';
            document.getElementById('heroImageUrl').value = url;
            pendingHeroImageData = { type: 'url', url: url };
        }

        function removeHeroImage() {
            document.getElementById('heroPreviewImg').src = '';
            document.getElementById('heroImagePreview').style.display = 'none';
            document.getElementById('heroUploadArea').style.display = 'flex';
            document.getElementById('heroFileInput').value = '';
            document.getElementById('heroUrlInput').value = '';
            document.getElementById('heroUrlInputContainer').style.display = 'none';
            document.getElementById('heroImageUrl').value = '';
            pendingHeroImageData = null;
        }

        function setHeroImage(url) {
            if (url) {
                document.getElementById('heroPreviewImg').src = url;
                document.getElementById('heroImagePreview').style.display = 'block';
                document.getElementById('heroUploadArea').style.display = 'none';
                document.getElementById('heroImageUrl').value = url;
            } else {
                removeHeroImage();
            }
        }

        async function uploadHeroImageIfNeeded() {
            // If there's a pending file upload, upload it now
            if (pendingHeroImageData && pendingHeroImageData.type === 'file' && currentProgramId) {
                try {
                    const result = await apiCall('/.netlify/functions/upload-program-hero', {
                        method: 'POST',
                        body: JSON.stringify({
                            programId: currentProgramId,
                            imageBase64: pendingHeroImageData.base64,
                            imageName: pendingHeroImageData.name
                        })
                    });

                    if (result.success) {
                        document.getElementById('heroImageUrl').value = result.program.hero_image_url;
                        pendingHeroImageData = null;
                        return result.program.hero_image_url;
                    }
                } catch (err) {
                    console.error('Error uploading hero image:', err);
                    showToast('Warning: Hero image upload failed', 'error');
                }
            }

            return document.getElementById('heroImageUrl').value || null;
        }

        // AI Cover Image Generation
        async function generateAICoverImage() {
            const btn = document.getElementById('aiCoverBtn');
            const originalHtml = btn.innerHTML;

            // Get program info for context
            const programName = document.getElementById('programName').value || 'Workout Program';
            const programType = document.getElementById('programType').value || 'general_fitness';
            const daysPerWeek = document.getElementById('daysPerWeek').value || '4';

            // Build a descriptive prompt based on program type
            const typeDescriptions = {
                'strength': 'strength training with heavy weights, power, determination',
                'hypertrophy': 'muscle building, bodybuilding, fitness model physique',
                'fat_loss': 'high intensity workout, cardio, athletic training',
                'general_fitness': 'general fitness, healthy lifestyle, wellness'
            };
            const typeDesc = typeDescriptions[programType] || typeDescriptions['general_fitness'];

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Generating...';

            try {
                const response = await fetch('/.netlify/functions/workout-cover-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        programName,
                        programType,
                        daysPerWeek,
                        description: typeDesc
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to generate cover image');
                }

                // Apply the generated image
                setHeroImage(result.imageUrl);
                showToast('Cover image generated!', 'success');

            } catch (error) {
                console.error('AI cover generation error:', error);
                showToast(error.message || 'Failed to generate cover image', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        // ============ EXERCISE PREVIEW FUNCTIONS ============
        let currentPreviewExercise = null;

        function openExercisePreview(exercise) {
            currentPreviewExercise = exercise;
            document.getElementById('previewExerciseName').textContent = exercise.name;

            const videoUrl = exercise.video_url || exercise.animation_url;
            const video = document.getElementById('previewVideo');
            const loader = document.getElementById('videoLoader');

            // Show loader, hide video initially
            loader.style.display = 'flex';
            video.style.opacity = '0';

            if (videoUrl) {
                // Clear old event listeners by cloning
                const newVideo = video.cloneNode(true);
                video.parentNode.replaceChild(newVideo, video);

                // Set up event handlers for loading states
                newVideo.oncanplay = () => {
                    loader.style.display = 'none';
                    newVideo.style.opacity = '1';
                    newVideo.play().catch(() => {});
                };
                newVideo.onwaiting = () => {
                    loader.style.display = 'flex';
                };
                newVideo.onplaying = () => {
                    loader.style.display = 'none';
                };
                newVideo.onerror = () => {
                    loader.innerHTML = '<span style="color: #f66;">Failed to load video</span>';
                };

                newVideo.src = videoUrl;
                newVideo.load();
            } else {
                loader.innerHTML = '<span style="color: #888;">No video available</span>';
            }

            const meta = [];
            if (exercise.muscle_group) meta.push(exercise.muscle_group);
            if (exercise.equipment) meta.push(exercise.equipment);
            if (exercise.difficulty) meta.push(exercise.difficulty);
            document.getElementById('previewExerciseMeta').textContent = meta.join('  ') || 'No details available';

            document.getElementById('exercisePreviewModal').classList.add('active');
        }

        function closeExercisePreview() {
            document.getElementById('exercisePreviewModal').classList.remove('active');
            const video = document.getElementById('previewVideo');
            video.pause();
            video.removeAttribute('src');
            video.load(); // Reset the video element
            // Reset loader for next time
            document.getElementById('videoLoader').innerHTML = `
                <div style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span style="color: #fff; font-size: 14px;">Loading video...</span>
            `;
            currentPreviewExercise = null;
        }

        function addExerciseFromPreview() {
            if (currentPreviewExercise) {
                addExerciseToDay(currentPreviewExercise);
                closeExercisePreview();
            }
        }

        function addExerciseToDay(exercise) {
            workoutDays[currentDayIndex].exercises.push({
                id: exercise.id,
                name: exercise.name,
                video_url: exercise.video_url,
                animation_url: exercise.animation_url,
                thumbnail_url: exercise.thumbnail_url || exercise.video_url,
                muscle_group: exercise.muscle_group,
                equipment: exercise.equipment,
                instructions: exercise.instructions,
                sets: 3,
                reps: '8-12',
                restSeconds: 90
            });
            renderWorkoutDays();
            closeExerciseModal();
            showToast(`Added ${exercise.name}`);
        }

        // Load clients
        async function loadClients() {
            try {
                const result = await apiCall(`/.netlify/functions/get-clients?coachId=${currentCoachId}`);
                clients = result.clients || [];
                console.log('Loaded clients:', clients.length);
            } catch (err) {
                console.error('Error loading clients:', err);
                clients = [];
            }
        }

        // ============ ASSIGNMENT MODAL FLOW ============

        // Open client selection modal (Step 1)
        function openAssignModal() {
            if (!currentProgramId) {
                showToast('Please save the program first', 'error');
                return;
            }
            selectedClients.clear();
            renderClientSelectList();
            document.getElementById('clientSelectModal').style.display = 'flex';
            setupClientSelectListener();
        }

        function closeClientSelectModal() {
            document.getElementById('clientSelectModal').style.display = 'none';
        }

        // Render client list in modal
        function renderClientSelectList(filter = '') {
            const container = document.getElementById('clientSelectList');
            const filtered = filter
                ? clients.filter(c => (c.client_name || '').toLowerCase().includes(filter.toLowerCase()))
                : clients;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-secondary);">No clients found</div>';
                return;
            }

            container.innerHTML = filtered.map(client => `
                <div class="client-select-item ${selectedClients.has(String(client.id)) ? 'selected' : ''}" data-client-id="${client.id}">
                    <div class="client-select-avatar">${(client.client_name || 'C')[0].toUpperCase()}</div>
                    <div class="client-select-info">
                        <div class="client-select-name">${client.client_name || 'Unnamed'}</div>
                        <div class="client-select-email">${client.email || 'No email'}</div>
                    </div>
                    <div class="client-select-check">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                </div>
            `).join('');
        }

        // Filter clients in modal
        function filterClients(query) {
            renderClientSelectList(query);
        }

        // Setup click listener for client selection in modal
        let clientSelectListenerAttached = false;
        function setupClientSelectListener() {
            if (clientSelectListenerAttached) return;
            const container = document.getElementById('clientSelectList');
            if (!container) return;

            container.addEventListener('click', function(e) {
                const item = e.target.closest('.client-select-item');
                if (item && item.dataset.clientId) {
                    const clientId = item.dataset.clientId;
                    if (selectedClients.has(clientId)) {
                        selectedClients.delete(clientId);
                    } else {
                        selectedClients.add(clientId);
                    }
                    renderClientSelectList(document.getElementById('clientSearchInput').value);
                    updateContinueButton();
                }
            });
            clientSelectListenerAttached = true;
        }

        function updateContinueButton() {
            const btn = document.getElementById('continueBtn');
            btn.disabled = selectedClients.size === 0;
        }

        // Proceed to schedule modal (Step 2)
        function proceedToSchedule() {
            if (selectedClients.size === 0) {
                showToast('Please select at least one client', 'error');
                return;
            }
            closeClientSelectModal();

            // Show selected clients
            const display = document.getElementById('selectedClientsDisplay');
            display.innerHTML = Array.from(selectedClients).map(clientId => {
                const client = clients.find(c => String(c.id) === String(clientId));
                return `
                    <div class="selected-client-chip">
                        <div class="chip-avatar">${(client?.client_name || 'C')[0].toUpperCase()}</div>
                        <span>${client?.client_name || 'Client'}</span>
                    </div>
                `;
            }).join('');

            // Set default start date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;

            document.getElementById('scheduleModal').style.display = 'flex';
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'none';
        }

        function backToClientSelect() {
            closeScheduleModal();
            openAssignModal();
        }

        // Final assignment
        async function assignWorkout() {
            const startDate = document.getElementById('startDate').value;
            const weeksAmount = parseInt(document.getElementById('weeksAmount').value) || 4;

            // Get selected days
            const selectedDays = [];
            document.querySelectorAll('.days-selector input:checked').forEach(cb => {
                selectedDays.push(cb.value);
            });

            if (!startDate) {
                showToast('Please select a start date', 'error');
                return;
            }

            if (selectedDays.length === 0) {
                showToast('Please select at least one day', 'error');
                return;
            }

            const programName = document.getElementById('programName').value.trim();
            const heroImageUrl = document.getElementById('heroImageUrl').value;

            try {
                showToast('Assigning workout...', 'success');

                for (const clientId of selectedClients) {
                    await apiCall('/.netlify/functions/workout-assignments', {
                        method: 'POST',
                        body: JSON.stringify({
                            clientId,
                            coachId: currentCoachId,
                            programId: currentProgramId,
                            name: programName,
                            workoutData: {
                                days: workoutDays,
                                image_url: heroImageUrl || null
                            },
                            schedule: {
                                startDate,
                                weeksAmount,
                                selectedDays
                            }
                        })
                    });
                }

                closeScheduleModal();
                showToast(`Workout assigned to ${selectedClients.size} client(s)!`, 'success');
                selectedClients.clear();

            } catch (err) {
                console.error('Assignment error:', err);
                showToast('Failed to assign workout: ' + err.message, 'error');
            }
        }

        // Enable assign button after program is saved
        function enableAssignButton() {
            const btn = document.getElementById('assignBtn');
            if (btn) btn.disabled = false;
        }

        // Save program
        async function saveProgram() {
            const name = document.getElementById('programName').value.trim();
            if (!name) {
                showToast('Please enter a program name', 'error');
                return;
            }

            if (workoutDays.length === 0) {
                showToast('Please add at least one workout day', 'error');
                return;
            }

            try {
                let result;

                // Get hero image URL (direct URL, not pending upload)
                let heroImageUrl = document.getElementById('heroImageUrl').value;
                if (heroImageUrl === '__pending_upload__') {
                    heroImageUrl = null; // Will upload after save
                }

                if (currentProgramId) {
                    // Update existing program
                    result = await apiCall('/.netlify/functions/workout-programs', {
                        method: 'PUT',
                        body: JSON.stringify({
                            programId: currentProgramId,
                            name,
                            description: document.getElementById('programDescription').value,
                            programType: document.getElementById('programType').value,
                            difficulty: document.getElementById('programDifficulty').value,
                            daysPerWeek: parseInt(document.getElementById('daysPerWeek').value),
                            programData: { days: workoutDays },
                            heroImageUrl: heroImageUrl || undefined
                        })
                    });

                    // Upload pending hero image if any
                    await uploadHeroImageIfNeeded();

                } else {
                    // Create new program (without hero image first, will add after)
                    result = await apiCall('/.netlify/functions/workout-programs', {
                        method: 'POST',
                        body: JSON.stringify({
                            coachId: currentCoachId,
                            name,
                            description: document.getElementById('programDescription').value,
                            programType: document.getElementById('programType').value,
                            difficulty: document.getElementById('programDifficulty').value,
                            daysPerWeek: parseInt(document.getElementById('daysPerWeek').value),
                            programData: { days: workoutDays },
                            heroImageUrl: heroImageUrl || undefined
                        })
                    });
                    currentProgramId = result.program?.id;

                    // Upload pending hero image if any (now we have program ID)
                    await uploadHeroImageIfNeeded();
                }

                showToast('Program saved! You can now assign it to clients.');
                enableAssignButton();
                await loadPrograms();
            } catch (err) {
                console.error('Error saving program:', err);
                showToast('Error saving program: ' + err.message, 'error');
            }
        }

        // Search and filter programs (advanced filtering)
        function filterPrograms() {
            const searchTerm = document.getElementById('programSearchInput')?.value?.toLowerCase() || '';
            const typeFilter = document.getElementById('programTypeFilter')?.value || '';
            const difficultyFilter = document.getElementById('programDifficultyFilter')?.value || '';
            const daysFilter = document.getElementById('programDaysFilter')?.value || '';

            const filtered = programs.filter(p => {
                // Search by name
                if (searchTerm && !p.name.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                // Filter by type
                if (typeFilter && p.program_type !== typeFilter) {
                    return false;
                }
                // Filter by difficulty
                if (difficultyFilter && p.difficulty !== difficultyFilter) {
                    return false;
                }
                // Filter by days per week
                if (daysFilter && String(p.days_per_week) !== daysFilter) {
                    return false;
                }
                return true;
            });

            const container = document.getElementById('programList');
            if (filtered.length === 0) {
                const hasFilters = searchTerm || typeFilter || difficultyFilter || daysFilter;
                container.innerHTML = `<div class="empty-state"><p>${hasFilters ? 'No programs match your filters' : 'No programs found'}</p></div>`;
                return;
            }

            container.innerHTML = filtered.map(p => `
                <div class="program-item ${p.id === currentProgramId ? 'active' : ''}" onclick="selectProgram(${p.id})">
                    <div class="program-item-content">
                        <div class="program-name">${p.name}</div>
                        <div class="program-meta">
                            <span>${p.difficulty || 'Intermediate'}</span>
                            <span></span>
                            <span>${p.days_per_week || 3} days/week</span>
                        </div>
                    </div>
                    <div class="program-item-actions">
                        <button class="program-action-btn duplicate-btn" onclick="event.stopPropagation(); duplicateProgram(${p.id})" title="Duplicate program">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                        <button class="program-action-btn delete-btn" onclick="event.stopPropagation(); openDeleteConfirm(${p.id}, '${p.name.replace(/'/g, "\\'")}')" title="Delete program">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Legacy function - redirect to new filter function
        function searchPrograms(term) {
            if (document.getElementById('programSearchInput')) {
                document.getElementById('programSearchInput').value = term || '';
            }
            filterPrograms();
        }

        // ============ DELETE PROGRAM FUNCTIONS ============
        function openDeleteConfirm(programId, programName) {
            pendingDeleteProgramId = programId;
            document.getElementById('confirmDeleteMessage').textContent =
                `Are you sure you want to delete "${programName}"? This action cannot be undone.`;
            document.getElementById('confirmDeleteModal').classList.add('active');
        }

        function closeConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').classList.remove('active');
            pendingDeleteProgramId = null;
        }

        async function confirmDeleteProgram() {
            if (!pendingDeleteProgramId) return;

            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.textContent = 'Deleting...';

            try {
                const response = await fetch(`/.netlify/functions/workout-programs?programId=${pendingDeleteProgramId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to delete program');
                }

                showToast('Program deleted successfully', 'success');

                // If we deleted the currently selected program, clear selection
                if (currentProgramId === pendingDeleteProgramId) {
                    currentProgramId = null;
                    createNewProgram();
                }

                // Reload programs
                await loadPrograms();
            } catch (err) {
                console.error('Error deleting program:', err);
                showToast('Error deleting program: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Delete';
                closeConfirmDeleteModal();
            }
        }

        // ============ DUPLICATE PROGRAM FUNCTIONS ============
        async function duplicateProgram(programId) {
            const program = programs.find(p => p.id === programId);
            if (!program) {
                showToast('Program not found', 'error');
                return;
            }

            try {
                showToast('Duplicating program...', 'success');

                const response = await fetch('/.netlify/functions/workout-programs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        coachId: currentCoachId,
                        name: `${program.name} (Copy)`,
                        description: program.description,
                        programType: program.program_type,
                        difficulty: program.difficulty,
                        durationWeeks: program.duration_weeks,
                        daysPerWeek: program.days_per_week,
                        programData: program.program_data,
                        isTemplate: program.is_template,
                        isPublished: false,
                        heroImageUrl: program.program_data?.image_url
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to duplicate program');
                }

                showToast('Program duplicated successfully', 'success');

                // Reload programs and select the new one
                await loadPrograms();
                if (result.program) {
                    selectProgram(result.program.id);
                }
            } catch (err) {
                console.error('Error duplicating program:', err);
                showToast('Error duplicating program: ' + err.message, 'error');
            }
        }

        // ============ VOICE NOTE RECORDING FUNCTIONS ============
        async function toggleVoiceRecording(dayIndex, exIndex) {
            const btn = document.getElementById(`voiceBtn-${dayIndex}-${exIndex}`);

            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // Stop recording
                mediaRecorder.stop();
                btn.classList.remove('recording');
                return;
            }

            // Start recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                currentRecordingExercise = { dayIndex, exIndex };

                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());

                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await uploadVoiceNote(dayIndex, exIndex, audioBlob);
                    mediaRecorder = null;
                    audioChunks = [];
                    currentRecordingExercise = null;
                };

                mediaRecorder.start();
                btn.classList.add('recording');
                showToast('Recording... Click again to stop', 'success');

            } catch (err) {
                console.error('Error accessing microphone:', err);
                showToast('Could not access microphone. Please check permissions.', 'error');
            }
        }

        async function uploadVoiceNote(dayIndex, exIndex, audioBlob) {
            try {
                showToast('Saving voice note...', 'success');

                const contentType = 'audio/webm';
                const fileName = `voice-note-${Date.now()}.webm`;

                // Step 1: Get a signed upload URL
                const uploadUrlResult = await apiCall('/.netlify/functions/get-video-upload-url', {
                    method: 'POST',
                    body: JSON.stringify({
                        coachId: currentCoachId,
                        fileName,
                        contentType,
                        folder: 'voice-notes'
                    })
                });

                if (!uploadUrlResult.success) {
                    throw new Error(uploadUrlResult.error || 'Failed to get upload URL');
                }

                // Step 2: Upload directly to Supabase
                const uploadResponse = await fetch(uploadUrlResult.uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': contentType
                    },
                    body: audioBlob
                });

                if (!uploadResponse.ok) {
                    throw new Error('Failed to upload voice note to storage');
                }

                // Step 3: Get a signed view URL
                const signedUrlResult = await apiCall('/.netlify/functions/get-signed-video-url', {
                    method: 'POST',
                    body: JSON.stringify({
                        filePath: uploadUrlResult.filePath
                    })
                });

                if (signedUrlResult.success) {
                    // Store both URL and file path (path used to refresh signed URLs)
                    workoutDays[dayIndex].exercises[exIndex].voiceNoteUrl = signedUrlResult.url;
                    workoutDays[dayIndex].exercises[exIndex].voiceNotePath = uploadUrlResult.filePath;
                    renderWorkoutDays();
                    showToast('Voice note saved!', 'success');
                } else {
                    throw new Error('Failed to get voice note URL');
                }
            } catch (err) {
                console.error('Error uploading voice note:', err);
                showToast(err.message || 'Error saving voice note', 'error');
            }
        }

        function deleteVoiceNote(dayIndex, exIndex) {
            if (confirm('Delete this voice note?')) {
                workoutDays[dayIndex].exercises[exIndex].voiceNoteUrl = null;
                renderWorkoutDays();
                showToast('Voice note deleted', 'success');
            }
        }

        // ============ CUSTOM VIDEO FUNCTIONS ============
        let videoMediaRecorder = null;
        let videoChunks = [];
        let videoRecordingExercise = null;
        let videoRecordingTimer = null;
        let videoRecordingSeconds = 0;
        const MAX_VIDEO_SECONDS = 20;

        async function startVideoRecording(dayIndex, exIndex) {
            const btn = document.getElementById(`videoRecordBtn-${dayIndex}-${exIndex}`);

            // If already recording, stop
            if (videoMediaRecorder && videoMediaRecorder.state === 'recording') {
                stopVideoRecording();
                return;
            }

            try {
                // Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 720 }, height: { ideal: 480 } },
                    audio: false
                });

                videoMediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                videoChunks = [];
                videoRecordingExercise = { dayIndex, exIndex };
                videoRecordingSeconds = 0;

                videoMediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        videoChunks.push(e.data);
                    }
                };

                videoMediaRecorder.onstop = async () => {
                    clearInterval(videoRecordingTimer);
                    stream.getTracks().forEach(track => track.stop());

                    const videoBlob = new Blob(videoChunks, { type: 'video/webm' });
                    await uploadCustomVideo(dayIndex, exIndex, videoBlob);

                    videoMediaRecorder = null;
                    videoChunks = [];
                    videoRecordingExercise = null;
                };

                videoMediaRecorder.start(100);
                btn.classList.add('recording');
                btn.innerHTML = `
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                        <rect x="6" y="6" width="12" height="12" rx="2"/>
                    </svg>
                    <span class="video-recording-timer">0:00</span>
                    Stop
                `;

                // Start timer - auto-stop at MAX_VIDEO_SECONDS
                videoRecordingTimer = setInterval(() => {
                    videoRecordingSeconds++;
                    const mins = Math.floor(videoRecordingSeconds / 60);
                    const secs = videoRecordingSeconds % 60;
                    const timerEl = btn.querySelector('.video-recording-timer');
                    if (timerEl) {
                        timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                    }

                    if (videoRecordingSeconds >= MAX_VIDEO_SECONDS) {
                        showToast(`Max ${MAX_VIDEO_SECONDS} seconds reached`, 'success');
                        stopVideoRecording();
                    }
                }, 1000);

                showToast(`Recording... (max ${MAX_VIDEO_SECONDS}s)`, 'success');

            } catch (err) {
                console.error('Error accessing camera:', err);
                showToast('Could not access camera. Please check permissions.', 'error');
            }
        }

        function stopVideoRecording() {
            if (videoMediaRecorder && videoMediaRecorder.state === 'recording') {
                videoMediaRecorder.stop();
            }
        }

        async function handleVideoUpload(event, dayIndex, exIndex) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 50MB)
            if (file.size > 50 * 1024 * 1024) {
                showToast('Video too large. Max 50MB.', 'error');
                return;
            }

            // Check video duration
            const video = document.createElement('video');
            video.preload = 'metadata';

            video.onloadedmetadata = async () => {
                window.URL.revokeObjectURL(video.src);

                if (video.duration > MAX_VIDEO_SECONDS) {
                    showToast(`Video too long. Max ${MAX_VIDEO_SECONDS} seconds.`, 'error');
                    return;
                }

                await uploadCustomVideo(dayIndex, exIndex, file);
            };

            video.src = URL.createObjectURL(file);
        }

        async function uploadCustomVideo(dayIndex, exIndex, videoBlob) {
            try {
                showToast('Uploading video...', 'success');

                // Determine content type
                const isWebm = videoBlob.type.includes('webm');
                const contentType = isWebm ? 'video/webm' : 'video/mp4';
                const extension = isWebm ? 'webm' : 'mp4';
                const fileName = `custom-video-${Date.now()}.${extension}`;

                // Step 1: Get a signed upload URL
                const uploadUrlResult = await apiCall('/.netlify/functions/get-video-upload-url', {
                    method: 'POST',
                    body: JSON.stringify({
                        coachId: currentCoachId,
                        fileName,
                        contentType,
                        folder: 'exercise-videos'
                    })
                });

                if (!uploadUrlResult.success) {
                    throw new Error(uploadUrlResult.error || 'Failed to get upload URL');
                }

                // Step 2: Upload directly to Supabase
                const uploadResponse = await fetch(uploadUrlResult.uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': contentType
                    },
                    body: videoBlob
                });

                if (!uploadResponse.ok) {
                    throw new Error('Failed to upload video to storage');
                }

                // Step 3: Get a signed view URL
                const signedUrlResult = await apiCall('/.netlify/functions/get-signed-video-url', {
                    method: 'POST',
                    body: JSON.stringify({
                        filePath: uploadUrlResult.filePath
                    })
                });

                if (signedUrlResult.success) {
                    // Store both URL and file path (path used to refresh signed URLs)
                    workoutDays[dayIndex].exercises[exIndex].customVideoUrl = signedUrlResult.url;
                    workoutDays[dayIndex].exercises[exIndex].customVideoPath = uploadUrlResult.filePath;
                    renderWorkoutDays();
                    showToast('Custom video saved!', 'success');
                } else {
                    throw new Error('Failed to get video URL');
                }
            } catch (err) {
                console.error('Error uploading video:', err);
                showToast(err.message || 'Error saving video', 'error');
            }
        }

        function deleteCustomVideo(dayIndex, exIndex) {
            if (confirm('Delete this custom video?')) {
                workoutDays[dayIndex].exercises[exIndex].customVideoUrl = null;
                renderWorkoutDays();
                showToast('Custom video deleted', 'success');
            }
        }

        // ============ RECOMMENDED SWAPS FUNCTIONS ============
        let recommendedSwapsDayIndex = null;
        let recommendedSwapsExIndex = null;
        let recommendedSwapsCache = [];

        function openRecommendedSwapsModal(dayIndex, exIndex) {
            recommendedSwapsDayIndex = dayIndex;
            recommendedSwapsExIndex = exIndex;

            const currentExercise = workoutDays[dayIndex].exercises[exIndex];
            document.getElementById('recommendedCurrentName').textContent = currentExercise.name;
            document.getElementById('recommendedSearchInput').value = '';

            // Use ALL exercises (excluding current) - coaches can recommend any exercise
            recommendedSwapsCache = exercises.filter(ex => ex.id !== currentExercise.id);

            // Initially show same muscle group exercises as suggestions, but search will access all
            const muscleGroup = currentExercise.muscle_group || currentExercise.muscleGroup || '';
            const sameMuscleExercises = recommendedSwapsCache.filter(ex => {
                const exMuscle = ex.muscle_group || '';
                return exMuscle.toLowerCase() === muscleGroup.toLowerCase() ||
                    (ex.secondary_muscles && ex.secondary_muscles.some(m =>
                        m.toLowerCase() === muscleGroup.toLowerCase()));
            });

            renderCurrentRecommendedSwaps();
            // Show same muscle group by default, but all are available via search
            renderRecommendedExerciseOptions(sameMuscleExercises.length > 0 ? sameMuscleExercises : recommendedSwapsCache.slice(0, 20));
            document.getElementById('recommendedSwapsModal').classList.add('active');
        }

        function closeRecommendedSwapsModal() {
            document.getElementById('recommendedSwapsModal').classList.remove('active');
            recommendedSwapsDayIndex = null;
            recommendedSwapsExIndex = null;
            renderWorkoutDays(); // Re-render to show updated swap counts
        }

        function renderCurrentRecommendedSwaps() {
            const container = document.getElementById('currentRecommendedSwaps');
            const exercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];
            const swaps = exercise.recommendedSwaps || [];

            if (swaps.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">No recommended swaps yet. Add some below!</p>';
                return;
            }

            container.innerHTML = swaps.map((swap, idx) => `
                <div class="recommended-swap-item">
                    <img class="swap-thumb" src="${swap.thumbnail_url || swap.animation_url || '/img/exercise-placeholder.svg'}"
                         alt="${swap.name}" onerror="this.src='/img/exercise-placeholder.svg'">
                    <div class="swap-info">
                        <div class="swap-name">${swap.name}</div>
                        <div class="swap-muscle">${swap.equipment || swap.muscle_group || ''}</div>
                    </div>
                    <button class="remove-swap-btn" onclick="removeRecommendedSwap(${idx})" title="Remove">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function renderRecommendedExerciseOptions(exerciseList) {
            const container = document.getElementById('recommendedExerciseOptions');
            const exercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];
            const currentSwapIds = (exercise.recommendedSwaps || []).map(s => s.id);

            // Filter out already recommended exercises
            const available = exerciseList.filter(ex => !currentSwapIds.includes(ex.id));

            if (available.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">No more exercises available for this muscle group.</p>';
                return;
            }

            container.innerHTML = available.slice(0, 20).map(ex => `
                <div class="recommended-exercise-option" onclick="addRecommendedSwap(${ex.id})">
                    <img class="option-thumb" src="${ex.thumbnail_url || ex.animation_url || '/img/exercise-placeholder.svg'}"
                         alt="${ex.name}" onerror="this.src='/img/exercise-placeholder.svg'">
                    <div class="option-info">
                        <div class="option-name">${ex.name}</div>
                        <div class="option-equipment">${ex.equipment || ex.muscle_group || ''}</div>
                    </div>
                    <svg width="20" height="20" fill="none" stroke="var(--brand-primary)" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </div>
            `).join('');
        }

        function filterRecommendedExercises(query) {
            const currentExercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];
            const muscleGroup = currentExercise.muscle_group || currentExercise.muscleGroup || '';

            if (!query) {
                // No search - show same muscle group exercises as default
                const sameMuscle = recommendedSwapsCache.filter(ex => {
                    const exMuscle = ex.muscle_group || '';
                    return exMuscle.toLowerCase() === muscleGroup.toLowerCase();
                });
                renderRecommendedExerciseOptions(sameMuscle.length > 0 ? sameMuscle : recommendedSwapsCache.slice(0, 20));
                return;
            }

            // Search through ALL exercises by name, equipment, or muscle group
            const filtered = recommendedSwapsCache.filter(ex =>
                ex.name.toLowerCase().includes(query.toLowerCase()) ||
                (ex.equipment && ex.equipment.toLowerCase().includes(query.toLowerCase())) ||
                (ex.muscle_group && ex.muscle_group.toLowerCase().includes(query.toLowerCase()))
            );
            renderRecommendedExerciseOptions(filtered);
        }

        function addRecommendedSwap(exerciseId) {
            const exerciseToAdd = exercises.find(ex => ex.id === exerciseId);
            if (!exerciseToAdd) return;

            const currentExercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];

            // Initialize array if needed
            if (!currentExercise.recommendedSwaps) {
                currentExercise.recommendedSwaps = [];
            }

            // Check if already added
            if (currentExercise.recommendedSwaps.some(s => s.id === exerciseId)) {
                showToast('This exercise is already recommended', 'error');
                return;
            }

            // Add the swap recommendation
            currentExercise.recommendedSwaps.push({
                id: exerciseToAdd.id,
                name: exerciseToAdd.name,
                thumbnail_url: exerciseToAdd.thumbnail_url,
                animation_url: exerciseToAdd.animation_url,
                muscle_group: exerciseToAdd.muscle_group,
                equipment: exerciseToAdd.equipment
            });

            showToast(`Added "${exerciseToAdd.name}" as recommended swap`, 'success');
            renderCurrentRecommendedSwaps();
            renderRecommendedExerciseOptions(recommendedSwapsCache);
        }

        function removeRecommendedSwap(swapIndex) {
            const currentExercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];
            const removed = currentExercise.recommendedSwaps.splice(swapIndex, 1);
            showToast(`Removed "${removed[0].name}" from recommendations`, 'success');
            renderCurrentRecommendedSwaps();
            renderRecommendedExerciseOptions(recommendedSwapsCache);
        }

        // AI Modal
        function openAIModal() {
            document.getElementById('aiModal').classList.add('active');
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.remove('active');
        }

        async function generateAIWorkout() {
            const btn = document.getElementById('aiGenerateBtn');
            const originalText = btn.innerHTML;

            // Get form values
            const clientName = document.getElementById('aiClientName').value || 'Client';
            const goal = document.getElementById('aiGoal').value;
            const experience = document.getElementById('aiExperience').value;
            const daysPerWeek = parseInt(document.getElementById('aiDaysPerWeek').value);
            const duration = parseInt(document.getElementById('aiDuration').value);
            const split = document.getElementById('aiSplit').value;
            const sessionDuration = parseInt(document.getElementById('aiSessionDuration').value);
            const trainingStyle = document.getElementById('aiTrainingStyle').value;
            const exerciseCount = document.getElementById('aiExerciseCount').value;
            const injuries = document.getElementById('aiInjuries').value;
            const preferences = document.getElementById('aiPreferences').value;

            const equipment = Array.from(document.querySelectorAll('input[name="equipment"]:checked'))
                .map(cb => cb.value);

            const focusAreas = Array.from(document.querySelectorAll('input[name="focusArea"]:checked'))
                .map(cb => cb.value);

            if (equipment.length === 0) {
                showToast('Please select at least one equipment type', 'error');
                return;
            }

            // Show loading
            btn.disabled = true;
            btn.innerHTML = '<span class="generating-text"><span class="spinner"></span>Generating...</span>';

            try {
                const response = await fetch('/.netlify/functions/generate-workout-claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientName,
                        goal,
                        experience,
                        daysPerWeek,
                        duration,
                        split,
                        sessionDuration,
                        trainingStyle,
                        exerciseCount,
                        focusAreas,
                        equipment,
                        injuries,
                        preferences
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to generate workout');
                }

                // Populate program
                const program = result.program;
                document.getElementById('programName').value = program.programName || `${goal} Program`;
                document.getElementById('programType').value = goal;
                document.getElementById('programDifficulty').value = experience;
                document.getElementById('daysPerWeek').value = daysPerWeek;
                document.getElementById('programDescription').value = program.description || '';

                // Convert to workout days
                workoutDays = [];
                if (program.weeks && program.weeks[0]?.workouts) {
                    program.weeks[0].workouts.forEach(workout => {
                        workoutDays.push({
                            name: workout.name,
                            exercises: (workout.exercises || []).map(ex => ({
                                // Include database fields if exercise was matched
                                id: ex.id,
                                name: ex.name,
                                video_url: ex.video_url,
                                animation_url: ex.animation_url,
                                thumbnail_url: ex.thumbnail_url,
                                muscle_group: ex.muscle_group || ex.muscleGroup,
                                equipment: ex.equipment,
                                instructions: ex.instructions,
                                sets: ex.sets || 3,
                                reps: ex.reps || '8-12',
                                restSeconds: ex.restSeconds || 90,
                                notes: ex.notes || '',
                                matched: ex.matched, // Track if this was matched to database
                                // Superset and warmup/stretch indicators
                                isSuperset: ex.isSuperset || false,
                                supersetGroup: ex.supersetGroup || null,
                                isWarmup: ex.isWarmup || false,
                                isStretch: ex.isStretch || false
                            }))
                        });
                    });
                }

                renderWorkoutDays();
                closeAIModal();
                showToast('Workout program generated!');

            } catch (error) {
                console.error('AI generation error:', error);
                showToast(error.message || 'Failed to generate workout', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Generate Program';
            }
        }

        // ============================================
        // Custom Exercise Functions
        // ============================================

        function openCustomExerciseModal() {
            // Reset form
            document.getElementById('ceExerciseName').value = '';
            document.getElementById('ceMuscleGroup').value = '';
            document.getElementById('ceEquipment').value = '';
            document.getElementById('ceDifficulty').value = 'intermediate';
            document.getElementById('ceExerciseType').value = 'strength';
            document.getElementById('ceInstructions').value = '';

            // Reset video state
            ceVideoData = null;
            document.getElementById('ceVideoPreview').classList.remove('visible');
            document.getElementById('cePreviewVideo').src = '';
            document.getElementById('ceRecordingIndicator').style.display = 'none';

            document.getElementById('customExerciseModal').classList.add('active');
        }

        function closeCustomExerciseModal() {
            // Stop any active recording
            if (ceVideoRecorder && ceVideoRecorder.state === 'recording') {
                ceVideoRecorder.stop();
            }
            if (ceRecordingInterval) {
                clearInterval(ceRecordingInterval);
                ceRecordingInterval = null;
            }

            document.getElementById('customExerciseModal').classList.remove('active');
        }

        function triggerCEVideoUpload() {
            document.getElementById('ceVideoFileInput').click();
        }

        async function handleCEVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 50MB)
            if (file.size > 50 * 1024 * 1024) {
                showToast('Video too large. Max 50MB', 'error');
                return;
            }

            // Convert to base64
            const reader = new FileReader();
            reader.onload = function(e) {
                ceVideoData = e.target.result;

                // Show preview
                document.getElementById('cePreviewVideo').src = ceVideoData;
                document.getElementById('ceVideoSize').textContent = `Video ready (${(file.size / 1024 / 1024).toFixed(1)}MB)`;
                document.getElementById('ceVideoPreview').classList.add('visible');
            };
            reader.readAsDataURL(file);

            // Reset file input
            event.target.value = '';
        }

        async function startCEVideoRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });

                ceVideoChunks = [];
                ceVideoRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

                ceVideoRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        ceVideoChunks.push(e.data);
                    }
                };

                ceVideoRecorder.onstop = async () => {
                    stream.getTracks().forEach(track => track.stop());

                    const blob = new Blob(ceVideoChunks, { type: 'video/webm' });

                    // Convert to base64
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        ceVideoData = reader.result;

                        // Show preview
                        document.getElementById('cePreviewVideo').src = ceVideoData;
                        document.getElementById('ceVideoSize').textContent = `Video ready (${(blob.size / 1024 / 1024).toFixed(1)}MB)`;
                        document.getElementById('ceVideoPreview').classList.add('visible');
                    };
                    reader.readAsDataURL(blob);

                    document.getElementById('ceRecordingIndicator').style.display = 'none';
                };

                ceVideoRecorder.start();

                // Show recording indicator
                document.getElementById('ceRecordingIndicator').style.display = 'flex';

                // Timer (max 20 seconds)
                let seconds = 0;
                ceRecordingInterval = setInterval(() => {
                    seconds++;
                    document.getElementById('ceRecordingTimer').textContent = `0:${seconds.toString().padStart(2, '0')}`;

                    if (seconds >= 20) {
                        stopCEVideoRecording();
                    }
                }, 1000);

            } catch (err) {
                console.error('Error starting video recording:', err);
                showToast('Could not access camera. Please allow camera permissions.', 'error');
            }
        }

        function stopCEVideoRecording() {
            if (ceVideoRecorder && ceVideoRecorder.state === 'recording') {
                ceVideoRecorder.stop();
            }
            if (ceRecordingInterval) {
                clearInterval(ceRecordingInterval);
                ceRecordingInterval = null;
            }
        }

        function removeCEVideo() {
            ceVideoData = null;
            document.getElementById('ceVideoPreview').classList.remove('visible');
            document.getElementById('cePreviewVideo').src = '';
        }

        async function saveCustomExercise() {
            const name = document.getElementById('ceExerciseName').value.trim();
            const muscleGroup = document.getElementById('ceMuscleGroup').value;
            const equipment = document.getElementById('ceEquipment').value;
            const difficulty = document.getElementById('ceDifficulty').value;
            const exerciseType = document.getElementById('ceExerciseType').value;
            const instructions = document.getElementById('ceInstructions').value.trim();

            // Validation
            if (!name) {
                showToast('Please enter an exercise name', 'error');
                return;
            }
            if (!muscleGroup) {
                showToast('Please select a muscle group', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveCustomExerciseBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner"></span> Creating...';

            try {
                let videoUrl = null;
                let videoFilePath = null;

                // Upload video if provided (using direct upload to Supabase)
                if (ceVideoData) {
                    saveBtn.innerHTML = '<span class="spinner"></span> Uploading video...';

                    // Determine file extension and content type
                    const isWebm = ceVideoData.includes('video/webm');
                    const contentType = isWebm ? 'video/webm' : 'video/mp4';
                    const extension = isWebm ? 'webm' : 'mp4';
                    const fileName = `custom-${Date.now()}.${extension}`;

                    // Step 1: Get a signed upload URL
                    const uploadUrlResult = await apiCall('/.netlify/functions/get-video-upload-url', {
                        method: 'POST',
                        body: JSON.stringify({
                            coachId: currentCoachId,
                            fileName,
                            contentType,
                            folder: 'exercise-videos'
                        })
                    });

                    if (!uploadUrlResult.success) {
                        throw new Error(uploadUrlResult.error || 'Failed to get upload URL');
                    }

                    // Step 2: Convert base64 to blob
                    const base64Data = ceVideoData.split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: contentType });

                    // Step 3: Upload directly to Supabase
                    const uploadResponse = await fetch(uploadUrlResult.uploadUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': contentType
                        },
                        body: blob
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Failed to upload video to storage');
                    }

                    // Step 4: Get a signed view URL
                    const signedUrlResult = await apiCall('/.netlify/functions/get-signed-video-url', {
                        method: 'POST',
                        body: JSON.stringify({
                            filePath: uploadUrlResult.filePath
                        })
                    });

                    if (signedUrlResult.success) {
                        videoUrl = signedUrlResult.url;
                        videoFilePath = uploadUrlResult.filePath;
                    }

                    saveBtn.innerHTML = '<span class="spinner"></span> Creating exercise...';
                }

                // Create the exercise
                const result = await apiCall('/.netlify/functions/exercises', {
                    method: 'POST',
                    body: JSON.stringify({
                        coachId: currentCoachId,
                        name,
                        muscleGroup,
                        equipment: equipment || null,
                        difficulty,
                        exerciseType,
                        instructions: instructions || null,
                        animationUrl: videoUrl,
                        thumbnailUrl: null // Could add thumbnail support later
                    })
                });

                if (result.success && result.exercise) {
                    // Add to local exercises array
                    exercises.push({
                        ...result.exercise,
                        is_custom: true,
                        // Store video file path for signed URL refresh
                        video_file_path: videoFilePath
                    });

                    showToast(`Custom exercise "${name}" created!`);
                    closeCustomExerciseModal();

                    // Refresh exercise grid if the modal is open
                    if (document.getElementById('exerciseModal').classList.contains('active')) {
                        renderExerciseGrid();
                    }
                } else {
                    throw new Error('Failed to create exercise');
                }

            } catch (err) {
                console.error('Error creating custom exercise:', err);
                showToast(err.message || 'Failed to create exercise', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = `
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Create Exercise
                `;
            }
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
