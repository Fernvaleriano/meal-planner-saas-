<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Builder - Zique Fitness</title>
    <script src="/js/theme.js"></script>
    <script src="/js/gym-features.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-primary: #0d9488;
            --brand-secondary: #0284c7;
            --brand-gradient: linear-gradient(135deg, #0d9488 0%, #0284c7 100%);
            --purple-gradient: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(13, 148, 136, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(2, 132, 199, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.05) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        /* Navigation */
        .top-nav {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.95) 0%, rgba(2, 132, 199, 0.95) 100%);
            backdrop-filter: blur(20px);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nav-back {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .nav-back:hover { opacity: 1; }

        .nav-title {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.15);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: white;
            color: var(--brand-primary);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Main Layout */
        .main-content {
            display: flex;
            min-height: calc(100vh - 68px);
            position: relative;
            z-index: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 68px;
            height: calc(100vh - 68px);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 16px;
        }

        .sidebar-search {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .sidebar-search:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }

        .sidebar-search::placeholder {
            color: var(--text-muted);
        }

        /* Program List */
        .program-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .program-item {
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            background: var(--bg-tertiary);
        }

        .program-item:hover {
            transform: translateX(4px);
            border-color: var(--border-color);
        }

        .program-item.active {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.15) 0%, rgba(2, 132, 199, 0.15) 100%);
            border-color: var(--brand-primary);
        }

        .program-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .program-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .program-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sidebar-actions {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 14px 16px;
            border-radius: var(--radius-md);
            border: 2px dashed var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .sidebar-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.05);
        }

        .sidebar-btn.ai-btn {
            background: var(--purple-gradient);
            border: none;
            color: white;
        }

        .sidebar-btn.ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        /* Builder Area */
        .builder-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            max-width: 900px;
        }

        .builder-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .builder-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .builder-title svg {
            color: var(--brand-primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Workout Days */
        .workout-day {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .workout-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .day-name-input {
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            padding: 8px 0;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .day-name-input:focus {
            outline: none;
            border-bottom-color: var(--brand-primary);
        }

        .workout-day-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            border: none;
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* Exercise Item */
        .exercise-item {
            display: flex;
            gap: 16px;
            align-items: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .exercise-item:hover {
            border-color: var(--brand-primary);
            box-shadow: var(--shadow-sm);
        }

        .exercise-drag {
            color: var(--text-muted);
            cursor: grab;
            font-size: 1.2rem;
        }

        .exercise-thumb {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            object-fit: cover;
            flex-shrink: 0;
        }

        .exercise-info {
            flex: 1;
            min-width: 0;
        }

        .exercise-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .exercise-config {
            display: flex;
            gap: 12px;
        }

        .config-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .config-input {
            width: 60px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            text-align: center;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .config-input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .config-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .add-exercise-btn {
            width: 100%;
            padding: 16px;
            background: transparent;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .add-exercise-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.05);
        }

        .add-day-btn {
            width: 100%;
            padding: 16px;
            background: var(--brand-gradient);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: inherit;
            margin-top: 16px;
        }

        .add-day-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(13, 148, 136, 0.3);
        }

        /* Client Assignment */
        .client-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .client-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .client-card:hover {
            border-color: var(--border-color);
        }

        .client-card.selected {
            border-color: var(--brand-primary);
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.1) 0%, rgba(2, 132, 199, 0.1) 100%);
        }

        .client-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--brand-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .client-info {
            flex: 1;
            min-width: 0;
        }

        .client-name {
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .client-email {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px 28px;
        }

        .modal-footer {
            padding: 20px 28px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Exercise Grid in Modal */
        .exercise-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .filter-chip:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        .filter-chip.active {
            background: var(--brand-gradient);
            border-color: transparent;
            color: white;
        }

        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }

        .exercise-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .exercise-card:hover {
            border-color: var(--brand-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .exercise-card-thumb {
            width: 100%;
            height: 100px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            background: var(--bg-secondary);
            margin-bottom: 12px;
        }

        .exercise-card-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .exercise-card-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* AI Modal Specific */
        .ai-form-group {
            margin-bottom: 20px;
        }

        .ai-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .ai-form-group input,
        .ai-form-group select,
        .ai-form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .ai-form-group input:focus,
        .ai-form-group select:focus,
        .ai-form-group textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .ai-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .equipment-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .equipment-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .equipment-item:has(input:checked) {
            background: rgba(13, 148, 136, 0.15);
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        .equipment-item input {
            accent-color: var(--brand-primary);
        }

        .ai-btn {
            padding: 14px 28px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .ai-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .ai-btn-cancel:hover {
            background: var(--border-color);
        }

        .ai-btn-generate {
            background: var(--purple-gradient);
            color: white;
        }

        .ai-btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .ai-btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .generating-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            animation: toastSlideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 250px;
                position: relative;
                top: 0;
                height: auto;
            }

            .builder-area {
                max-width: 100%;
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .ai-form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <a href="dashboard.html" class="nav-back">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Dashboard
        </a>
        <span class="nav-title">Workout Builder</span>
        <div class="nav-actions">
            <button class="btn btn-primary" onclick="saveProgram()">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Save Program
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Your Programs</div>
                <input type="text" class="sidebar-search" placeholder="Search programs..." oninput="searchPrograms(this.value)">
            </div>
            <div class="program-list" id="programList">
                <div class="empty-state">
                    <div class="empty-icon">ðŸ“‹</div>
                    <div class="empty-title">No programs yet</div>
                    <p>Create your first workout program</p>
                </div>
            </div>
            <div class="sidebar-actions">
                <button class="sidebar-btn" onclick="createNewProgram()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Program
                </button>
                <button class="sidebar-btn ai-btn" onclick="openAIModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    AI Generate
                </button>
            </div>
        </div>

        <!-- Builder Area -->
        <div class="builder-area">
            <!-- Program Details -->
            <div class="builder-card">
                <h2 class="builder-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Program Details
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Program Name</label>
                        <input type="text" class="form-input" id="programName" placeholder="e.g., 4-Week Hypertrophy Program">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Program Type</label>
                        <select class="form-select" id="programType">
                            <option value="strength">Strength</option>
                            <option value="hypertrophy" selected>Hypertrophy</option>
                            <option value="endurance">Endurance</option>
                            <option value="weight_loss">Weight Loss</option>
                            <option value="general">General Fitness</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Difficulty</label>
                        <select class="form-select" id="programDifficulty">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate" selected>Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Days Per Week</label>
                        <select class="form-select" id="daysPerWeek">
                            <option value="2">2 days</option>
                            <option value="3">3 days</option>
                            <option value="4" selected>4 days</option>
                            <option value="5">5 days</option>
                            <option value="6">6 days</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="programDescription" placeholder="Describe the program goals and structure..."></textarea>
                </div>
            </div>

            <!-- Workout Days -->
            <div class="builder-card">
                <h2 class="builder-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Workout Days
                </h2>
                <div id="workoutDays">
                    <!-- Days will be rendered here -->
                </div>
                <button class="add-day-btn" onclick="addWorkoutDay()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Workout Day
                </button>
            </div>

            <!-- Assign to Clients -->
            <div class="builder-card">
                <h2 class="builder-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    Assign to Clients
                </h2>
                <div class="client-grid" id="clientList">
                    <div class="empty-state">
                        <p>Loading clients...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exercise Library Modal -->
    <div class="modal-overlay" id="exerciseModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    Add Exercise
                </h3>
                <button class="modal-close" onclick="closeExerciseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-input" placeholder="Search exercises..." oninput="searchExercises(this.value)" style="margin-bottom: 16px;">
                <div class="exercise-filters">
                    <button class="filter-chip active" onclick="filterExercises('all', this)">All</button>
                    <button class="filter-chip" onclick="filterExercises('chest', this)">Chest</button>
                    <button class="filter-chip" onclick="filterExercises('back', this)">Back</button>
                    <button class="filter-chip" onclick="filterExercises('shoulders', this)">Shoulders</button>
                    <button class="filter-chip" onclick="filterExercises('legs', this)">Legs</button>
                    <button class="filter-chip" onclick="filterExercises('arms', this)">Arms</button>
                    <button class="filter-chip" onclick="filterExercises('core', this)">Core</button>
                </div>
                <div class="exercise-grid" id="exerciseGrid">
                    <!-- Exercises loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- AI Generate Modal -->
    <div class="modal-overlay" id="aiModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    AI Workout Generator
                </h3>
                <button class="modal-close" onclick="closeAIModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ai-form-group">
                    <label>Client Name (optional)</label>
                    <input type="text" id="aiClientName" placeholder="e.g., John Smith">
                </div>
                <div class="ai-form-row">
                    <div class="ai-form-group">
                        <label>Training Goal</label>
                        <select id="aiGoal">
                            <option value="strength">Strength</option>
                            <option value="hypertrophy" selected>Hypertrophy (Muscle Building)</option>
                            <option value="fat_loss">Fat Loss</option>
                            <option value="general_fitness">General Fitness</option>
                        </select>
                    </div>
                    <div class="ai-form-group">
                        <label>Experience Level</label>
                        <select id="aiExperience">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate" selected>Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </div>
                <div class="ai-form-row">
                    <div class="ai-form-group">
                        <label>Days Per Week</label>
                        <select id="aiDaysPerWeek">
                            <option value="3">3 days</option>
                            <option value="4" selected>4 days</option>
                            <option value="5">5 days</option>
                            <option value="6">6 days</option>
                        </select>
                    </div>
                    <div class="ai-form-group">
                        <label>Program Duration</label>
                        <select id="aiDuration">
                            <option value="4" selected>4 weeks</option>
                            <option value="6">6 weeks</option>
                            <option value="8">8 weeks</option>
                        </select>
                    </div>
                </div>
                <div class="ai-form-group">
                    <label>Available Equipment</label>
                    <div class="equipment-grid">
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="barbell" checked> Barbell
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="dumbbell" checked> Dumbbells
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="cable" checked> Cables
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="machine" checked> Machines
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="bodyweight" checked> Bodyweight
                        </label>
                        <label class="equipment-item">
                            <input type="checkbox" name="equipment" value="kettlebell"> Kettlebells
                        </label>
                    </div>
                </div>
                <div class="ai-form-group">
                    <label>Injuries or Limitations (optional)</label>
                    <input type="text" id="aiInjuries" placeholder="e.g., Lower back pain, avoid overhead pressing">
                </div>
                <div class="ai-form-group">
                    <label>Additional Preferences (optional)</label>
                    <textarea id="aiPreferences" rows="2" placeholder="e.g., Include stretching, prefer compound movements"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="ai-btn ai-btn-cancel" onclick="closeAIModal()">Cancel</button>
                <button class="ai-btn ai-btn-generate" id="aiGenerateBtn" onclick="generateAIWorkout()">
                    Generate Program
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://qewqcjzlfqamqwbccapr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFld3FjanpsZnFhbXF3YmNjYXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4NTA1ODcsImV4cCI6MjA2MDQyNjU4N30.api2M4E4Ah3V2WnxPRVDMq6yoGLPzjsB8qECLO7mK8U';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let currentCoachId = null;
        let currentProgramId = null;
        let programs = [];
        let exercises = [];
        let clients = [];
        let workoutDays = [];
        let selectedClients = new Set();
        let currentDayIndex = null;
        let currentExerciseFilter = 'all';
        let currentSearchTerm = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
        });

        // Auth check
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentCoachId = session.user.id;

            // Check gym features
            const enabled = await initGymFeatures({ email: session.user.email });
            if (!enabled) {
                showToast('Gym features not enabled for your account', 'error');
                setTimeout(() => window.location.href = 'dashboard.html', 2000);
                return;
            }

            // Load data
            await Promise.all([
                loadPrograms(),
                loadExercises(),
                loadClients()
            ]);

            // Add initial day
            if (workoutDays.length === 0) {
                addWorkoutDay();
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${type === 'success'
                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'}
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Load programs
        async function loadPrograms() {
            try {
                const { data, error } = await supabase
                    .from('workout_programs')
                    .select('*')
                    .eq('coach_id', currentCoachId)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                programs = data || [];
                renderProgramList();
            } catch (err) {
                console.error('Error loading programs:', err);
            }
        }

        // Render program list
        function renderProgramList() {
            const container = document.getElementById('programList');
            if (programs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“‹</div>
                        <div class="empty-title">No programs yet</div>
                        <p>Create your first workout program</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = programs.map(p => `
                <div class="program-item ${p.id === currentProgramId ? 'active' : ''}" onclick="selectProgram(${p.id})">
                    <div class="program-name">${p.name}</div>
                    <div class="program-meta">
                        <span>${p.difficulty || 'Intermediate'}</span>
                        <span>â€¢</span>
                        <span>${p.days_per_week || 3} days/week</span>
                    </div>
                </div>
            `).join('');
        }

        // Select program
        function selectProgram(programId) {
            currentProgramId = programId;
            const program = programs.find(p => p.id === programId);
            if (program) {
                document.getElementById('programName').value = program.name || '';
                document.getElementById('programType').value = program.program_type || 'strength';
                document.getElementById('programDifficulty').value = program.difficulty || 'intermediate';
                document.getElementById('daysPerWeek').value = program.days_per_week || 3;
                document.getElementById('programDescription').value = program.description || '';

                workoutDays = program.program_data?.days || [];
                renderWorkoutDays();
            }
            renderProgramList();
        }

        // Create new program
        function createNewProgram() {
            currentProgramId = null;
            document.getElementById('programName').value = '';
            document.getElementById('programType').value = 'hypertrophy';
            document.getElementById('programDifficulty').value = 'intermediate';
            document.getElementById('daysPerWeek').value = '4';
            document.getElementById('programDescription').value = '';
            workoutDays = [];
            selectedClients.clear();
            addWorkoutDay();
            renderProgramList();
            renderClientList();
        }

        // Add workout day
        function addWorkoutDay() {
            const dayNum = workoutDays.length + 1;
            const dayNames = ['Push Day', 'Pull Day', 'Legs Day', 'Upper Body', 'Lower Body', 'Full Body'];
            workoutDays.push({
                name: dayNames[workoutDays.length % dayNames.length] || `Day ${dayNum}`,
                exercises: []
            });
            renderWorkoutDays();
        }

        // Render workout days
        function renderWorkoutDays() {
            const container = document.getElementById('workoutDays');
            if (workoutDays.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Add your first workout day</p></div>';
                return;
            }

            container.innerHTML = workoutDays.map((day, dayIndex) => `
                <div class="workout-day">
                    <div class="workout-day-header">
                        <input type="text" class="day-name-input" value="${day.name}" onchange="updateDayName(${dayIndex}, this.value)">
                        <div class="workout-day-actions">
                            <button class="icon-btn" onclick="removeWorkoutDay(${dayIndex})" title="Remove day">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="exercise-list">
                        ${day.exercises.map((ex, exIndex) => renderExerciseItem(ex, dayIndex, exIndex)).join('')}
                    </div>
                    <button class="add-exercise-btn" onclick="openExerciseModal(${dayIndex})">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Exercise
                    </button>
                </div>
            `).join('');
        }

        // Render single exercise item
        function renderExerciseItem(exercise, dayIndex, exIndex) {
            const thumbUrl = exercise.thumbnailUrl || exercise.video_url || '/img/exercise-placeholder.svg';
            return `
                <div class="exercise-item">
                    <div class="exercise-drag">â‹®â‹®</div>
                    <img class="exercise-thumb" src="${thumbUrl}" alt="${exercise.name}" onerror="this.src='/img/exercise-placeholder.svg'">
                    <div class="exercise-info">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="exercise-config">
                            <div class="config-group">
                                <input type="number" class="config-input" value="${exercise.sets || 3}" onchange="updateExercise(${dayIndex}, ${exIndex}, 'sets', this.value)">
                                <span class="config-label">Sets</span>
                            </div>
                            <div class="config-group">
                                <input type="text" class="config-input" value="${exercise.reps || '10'}" onchange="updateExercise(${dayIndex}, ${exIndex}, 'reps', this.value)" style="width:70px">
                                <span class="config-label">Reps</span>
                            </div>
                            <div class="config-group">
                                <input type="number" class="config-input" value="${exercise.restSeconds || 90}" onchange="updateExercise(${dayIndex}, ${exIndex}, 'restSeconds', this.value)">
                                <span class="config-label">Rest</span>
                            </div>
                        </div>
                    </div>
                    <button class="icon-btn" onclick="removeExercise(${dayIndex}, ${exIndex})" title="Remove exercise">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;
        }

        // Update functions
        function updateDayName(dayIndex, name) {
            workoutDays[dayIndex].name = name;
        }

        function updateExercise(dayIndex, exIndex, field, value) {
            if (field === 'sets' || field === 'restSeconds') {
                workoutDays[dayIndex].exercises[exIndex][field] = parseInt(value) || 0;
            } else {
                workoutDays[dayIndex].exercises[exIndex][field] = value;
            }
        }

        function removeWorkoutDay(dayIndex) {
            if (confirm('Remove this workout day?')) {
                workoutDays.splice(dayIndex, 1);
                renderWorkoutDays();
            }
        }

        function removeExercise(dayIndex, exIndex) {
            workoutDays[dayIndex].exercises.splice(exIndex, 1);
            renderWorkoutDays();
        }

        // Load exercises
        async function loadExercises() {
            try {
                const { data, error } = await supabase
                    .from('exercises')
                    .select('*')
                    .or(`coach_id.is.null,coach_id.eq.${currentCoachId}`)
                    .order('name')
                    .limit(200);

                if (error) throw error;
                exercises = data || [];
            } catch (err) {
                console.error('Error loading exercises:', err);
                // Fallback exercises
                exercises = [
                    { id: 1, name: 'Bench Press', muscle_group: 'chest', equipment: 'barbell' },
                    { id: 2, name: 'Squat', muscle_group: 'legs', equipment: 'barbell' },
                    { id: 3, name: 'Deadlift', muscle_group: 'back', equipment: 'barbell' },
                    { id: 4, name: 'Overhead Press', muscle_group: 'shoulders', equipment: 'barbell' },
                    { id: 5, name: 'Barbell Row', muscle_group: 'back', equipment: 'barbell' },
                    { id: 6, name: 'Pull-ups', muscle_group: 'back', equipment: 'bodyweight' },
                    { id: 7, name: 'Dips', muscle_group: 'chest', equipment: 'bodyweight' },
                    { id: 8, name: 'Lunges', muscle_group: 'legs', equipment: 'bodyweight' },
                ];
            }
        }

        // Exercise modal
        function openExerciseModal(dayIndex) {
            currentDayIndex = dayIndex;
            document.getElementById('exerciseModal').classList.add('active');
            renderExerciseGrid();
        }

        function closeExerciseModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        function filterExercises(muscle, btn) {
            currentExerciseFilter = muscle;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            renderExerciseGrid();
        }

        function searchExercises(term) {
            currentSearchTerm = term.toLowerCase();
            renderExerciseGrid();
        }

        function renderExerciseGrid() {
            const container = document.getElementById('exerciseGrid');
            let filtered = exercises;

            if (currentExerciseFilter !== 'all') {
                filtered = filtered.filter(e =>
                    e.muscle_group?.toLowerCase() === currentExerciseFilter ||
                    e.primary_muscles?.toLowerCase().includes(currentExerciseFilter)
                );
            }

            if (currentSearchTerm) {
                filtered = filtered.filter(e =>
                    e.name.toLowerCase().includes(currentSearchTerm)
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No exercises found</p></div>';
                return;
            }

            container.innerHTML = filtered.slice(0, 50).map(ex => `
                <div class="exercise-card" onclick='addExerciseToDay(${JSON.stringify(ex).replace(/'/g, "\\'")})'>
                    <img class="exercise-card-thumb" src="${ex.video_url || ex.thumbnail_url || '/img/exercise-placeholder.svg'}" alt="${ex.name}" onerror="this.src='/img/exercise-placeholder.svg'">
                    <div class="exercise-card-name">${ex.name}</div>
                    <div class="exercise-card-meta">${ex.muscle_group || ex.primary_muscles || 'General'}</div>
                </div>
            `).join('');
        }

        function addExerciseToDay(exercise) {
            workoutDays[currentDayIndex].exercises.push({
                id: exercise.id,
                name: exercise.name,
                thumbnailUrl: exercise.video_url || exercise.thumbnail_url,
                muscleGroup: exercise.muscle_group,
                sets: 3,
                reps: '8-12',
                restSeconds: 90
            });
            renderWorkoutDays();
            closeExerciseModal();
            showToast(`Added ${exercise.name}`);
        }

        // Load clients
        async function loadClients() {
            try {
                const { data, error } = await supabase
                    .from('clients')
                    .select('id, client_name, email')
                    .eq('coach_id', currentCoachId)
                    .eq('is_archived', false)
                    .order('client_name');

                if (error) throw error;
                clients = data || [];
                renderClientList();
            } catch (err) {
                console.error('Error loading clients:', err);
            }
        }

        function renderClientList() {
            const container = document.getElementById('clientList');
            if (clients.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No clients yet</p></div>';
                return;
            }

            container.innerHTML = clients.map(client => `
                <div class="client-card ${selectedClients.has(client.id) ? 'selected' : ''}" onclick="toggleClient(${client.id})">
                    <div class="client-avatar">${(client.client_name || 'C')[0].toUpperCase()}</div>
                    <div class="client-info">
                        <div class="client-name">${client.client_name || 'Unnamed'}</div>
                        <div class="client-email">${client.email || 'No email'}</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleClient(clientId) {
            if (selectedClients.has(clientId)) {
                selectedClients.delete(clientId);
            } else {
                selectedClients.add(clientId);
            }
            renderClientList();
        }

        // Save program
        async function saveProgram() {
            const name = document.getElementById('programName').value.trim();
            if (!name) {
                showToast('Please enter a program name', 'error');
                return;
            }

            if (workoutDays.length === 0) {
                showToast('Please add at least one workout day', 'error');
                return;
            }

            const programData = {
                coach_id: currentCoachId,
                name,
                description: document.getElementById('programDescription').value,
                program_type: document.getElementById('programType').value,
                difficulty: document.getElementById('programDifficulty').value,
                days_per_week: parseInt(document.getElementById('daysPerWeek').value),
                program_data: { days: workoutDays }
            };

            try {
                let result;
                if (currentProgramId) {
                    const { data, error } = await supabase
                        .from('workout_programs')
                        .update(programData)
                        .eq('id', currentProgramId)
                        .select()
                        .single();
                    if (error) throw error;
                    result = data;
                } else {
                    const { data, error } = await supabase
                        .from('workout_programs')
                        .insert([programData])
                        .select()
                        .single();
                    if (error) throw error;
                    result = data;
                    currentProgramId = result.id;
                }

                // Assign to clients
                for (const clientId of selectedClients) {
                    await supabase
                        .from('client_workout_assignments')
                        .upsert({
                            client_id: clientId,
                            coach_id: currentCoachId,
                            program_id: currentProgramId,
                            name: programData.name,
                            workout_data: { days: workoutDays },
                            is_active: true
                        }, { onConflict: 'client_id,is_active' });
                }

                showToast('Program saved successfully!');
                await loadPrograms();
            } catch (err) {
                console.error('Error saving program:', err);
                showToast('Error saving program: ' + err.message, 'error');
            }
        }

        // Search programs
        function searchPrograms(term) {
            const filtered = term
                ? programs.filter(p => p.name.toLowerCase().includes(term.toLowerCase()))
                : programs;

            const container = document.getElementById('programList');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No programs found</p></div>';
                return;
            }

            container.innerHTML = filtered.map(p => `
                <div class="program-item ${p.id === currentProgramId ? 'active' : ''}" onclick="selectProgram(${p.id})">
                    <div class="program-name">${p.name}</div>
                    <div class="program-meta">
                        <span>${p.difficulty || 'Intermediate'}</span>
                        <span>â€¢</span>
                        <span>${p.days_per_week || 3} days/week</span>
                    </div>
                </div>
            `).join('');
        }

        // AI Modal
        function openAIModal() {
            document.getElementById('aiModal').classList.add('active');
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.remove('active');
        }

        async function generateAIWorkout() {
            const btn = document.getElementById('aiGenerateBtn');
            const originalText = btn.innerHTML;

            // Get form values
            const clientName = document.getElementById('aiClientName').value || 'Client';
            const goal = document.getElementById('aiGoal').value;
            const experience = document.getElementById('aiExperience').value;
            const daysPerWeek = parseInt(document.getElementById('aiDaysPerWeek').value);
            const duration = parseInt(document.getElementById('aiDuration').value);
            const injuries = document.getElementById('aiInjuries').value;
            const preferences = document.getElementById('aiPreferences').value;

            const equipment = Array.from(document.querySelectorAll('input[name="equipment"]:checked'))
                .map(cb => cb.value);

            if (equipment.length === 0) {
                showToast('Please select at least one equipment type', 'error');
                return;
            }

            // Show loading
            btn.disabled = true;
            btn.innerHTML = '<span class="generating-text"><span class="spinner"></span>Generating...</span>';

            try {
                const response = await fetch('/.netlify/functions/generate-workout-claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientName,
                        goal,
                        experience,
                        daysPerWeek,
                        duration,
                        equipment,
                        injuries,
                        preferences
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to generate workout');
                }

                // Populate program
                const program = result.program;
                document.getElementById('programName').value = program.programName || `${goal} Program`;
                document.getElementById('programType').value = goal;
                document.getElementById('programDifficulty').value = experience;
                document.getElementById('daysPerWeek').value = daysPerWeek;
                document.getElementById('programDescription').value = program.description || '';

                // Convert to workout days
                workoutDays = [];
                if (program.weeks && program.weeks[0]?.workouts) {
                    program.weeks[0].workouts.forEach(workout => {
                        workoutDays.push({
                            name: workout.name,
                            exercises: (workout.exercises || []).map(ex => ({
                                name: ex.name,
                                muscleGroup: ex.muscleGroup,
                                sets: ex.sets || 3,
                                reps: ex.reps || '8-12',
                                restSeconds: ex.restSeconds || 90
                            }))
                        });
                    });
                }

                renderWorkoutDays();
                closeAIModal();
                showToast('Workout program generated!');

            } catch (error) {
                console.error('AI generation error:', error);
                showToast(error.message || 'Failed to generate workout', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Generate Program';
            }
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
