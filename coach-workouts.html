<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Builder - Zique Fitness</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <script src="/js/theme.js"></script>
    <script src="/js/gym-features.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-primary: #0d9488;
            --brand-secondary: #0284c7;
            --brand-gradient: linear-gradient(135deg, #0d9488 0%, #0284c7 100%);
            --purple-gradient: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(13, 148, 136, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(2, 132, 199, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.05) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        /* Navigation */
        .top-nav {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.95) 0%, rgba(2, 132, 199, 0.95) 100%);
            backdrop-filter: blur(20px);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nav-back {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .nav-back:hover { opacity: 1; }

        .nav-title {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.15);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .btn-ai-generate {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-ai-generate:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            transform: translateY(-1px);
        }

        .btn-ai-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-ai-generate .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .btn-primary {
            background: white;
            color: var(--brand-primary);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Main Layout */
        .main-content {
            display: flex;
            min-height: calc(100vh - 68px);
            position: relative;
            z-index: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 68px;
            height: calc(100vh - 68px);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 16px;
        }

        .sidebar-search {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .sidebar-search:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }

        .sidebar-search::placeholder {
            color: var(--text-muted);
        }

        /* Program List */
        .program-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .program-item {
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            background: var(--bg-tertiary);
        }

        .program-item:hover {
            transform: translateX(4px);
            border-color: var(--border-color);
        }

        .program-item.active {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.15) 0%, rgba(2, 132, 199, 0.15) 100%);
            border-color: var(--brand-primary);
        }

        .program-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .program-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .program-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Program Item Actions (Delete/Duplicate) */
        .program-item {
            position: relative;
        }

        .program-item-content {
            flex: 1;
            min-width: 0;
        }

        .program-item-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .program-item:hover .program-item-actions {
            opacity: 1;
        }

        .program-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .program-action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .program-action-btn.delete-btn:hover {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .program-action-btn.duplicate-btn:hover {
            background: rgba(13, 148, 136, 0.15);
            color: var(--brand-primary);
        }

        /* Sidebar Filters */
        .sidebar-filters {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .sidebar-filter-select {
            flex: 1;
            min-width: 80px;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
        }

        .sidebar-filter-select:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        /* Voice Notes Styles */
        .voice-note-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .voice-note-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .voice-note-btn:hover {
            background: var(--brand-primary);
            color: white;
        }

        .voice-note-btn.recording {
            background: var(--danger);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .voice-note-btn.has-audio {
            background: var(--brand-primary);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .voice-note-player {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 20px;
        }

        .voice-note-player audio {
            height: 24px;
            flex: 1;
        }

        .voice-note-delete {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .voice-note-delete:hover {
            background: var(--danger);
            color: white;
        }

        /* Save Dropdown */
        .save-dropdown {
            position: relative;
            display: inline-flex;
        }

        .save-dropdown .btn-save-main {
            border-radius: var(--radius-md) 0 0 var(--radius-md);
            padding-right: 16px;
        }

        .save-dropdown .btn-save-toggle {
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            padding: 10px 8px;
            border-left: 1px solid rgba(13, 148, 136, 0.3);
            background: white;
            color: var(--brand-primary);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            border: none;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
        }

        .save-dropdown .btn-save-toggle:hover {
            background: #f1f5f9;
        }

        .save-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 260px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s ease;
        }

        .save-dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .save-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 2px;
            transition: background 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        .save-dropdown-item:first-child {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .save-dropdown-item:last-child {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .save-dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .save-dropdown-item + .save-dropdown-item {
            border-top: 1px solid var(--border-color);
        }

        .save-dropdown-item-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .save-dropdown-item-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .save-dropdown-item .client-count-badge {
            display: inline-block;
            background: var(--brand-primary);
            color: white;
            font-size: 0.7rem;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: 600;
        }

        /* Update Clients Confirm Modal */
        .update-clients-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 12px 0;
            text-align: left;
        }

        .update-clients-list-item {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            margin-bottom: 4px;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border: none;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        /* Confirm Modal */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .confirm-modal-overlay.active .confirm-modal {
            transform: scale(1);
        }

        .confirm-modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .confirm-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
        }

        .confirm-modal-message {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 24px;
            font-size: 0.9rem;
        }

        .confirm-modal-actions {
            display: flex;
            gap: 12px;
        }

        .confirm-modal-actions .btn {
            flex: 1;
            justify-content: center;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Recommended Swaps Styles */
        .recommended-swaps-btn {
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
            position: relative;
        }

        .recommended-swaps-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            color: #c4b5fd;
        }

        .recommended-swaps-btn .swap-count {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 16px;
            height: 16px;
            background: #8b5cf6;
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommended-swaps-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .recommended-swap-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .recommended-swap-item .swap-thumb {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-secondary);
        }

        .recommended-swap-item .swap-info {
            flex: 1;
            min-width: 0;
        }

        .recommended-swap-item .swap-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .recommended-swap-item .swap-muscle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .recommended-swap-item .remove-swap-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommended-swap-item .remove-swap-btn:hover {
            background: var(--danger);
            color: white;
        }

        .add-recommended-section {
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
        }

        .add-recommended-section h4 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .recommended-exercise-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .recommended-exercise-option:hover {
            background: var(--bg-tertiary);
        }

        .recommended-exercise-option.selected {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid #8b5cf6;
        }

        .recommended-exercise-option .option-thumb {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
        }

        .recommended-exercise-option .option-info {
            flex: 1;
        }

        .recommended-exercise-option .option-name {
            font-size: 13px;
            font-weight: 500;
        }

        .recommended-exercise-option .option-equipment {
            font-size: 11px;
            color: var(--text-muted);
        }

        .exercise-has-swaps {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #a78bfa;
            margin-top: 4px;
        }

        .exercise-has-swaps svg {
            width: 12px;
            height: 12px;
        }

        /* Custom Video Upload Styles */
        .custom-video-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }

        .custom-video-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-video-btn:hover {
            background: var(--brand-primary);
            color: white;
            border-color: var(--brand-primary);
        }

        .custom-video-btn.recording {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
            animation: pulse 1.5s infinite;
        }

        .custom-video-btn.has-video {
            background: rgba(13, 148, 136, 0.15);
            color: var(--brand-primary);
            border-color: var(--brand-primary);
        }

        .custom-video-preview {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .custom-video-preview video {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        .custom-video-preview .video-info {
            flex: 1;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .custom-video-preview .video-label {
            color: var(--brand-primary);
            font-weight: 500;
        }

        .custom-video-delete {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .custom-video-delete:hover {
            background: var(--danger);
            color: white;
        }

        .video-upload-input {
            display: none;
        }

        /* Reference Links */
        .reference-links-container {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }

        .reference-links-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .reference-links-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 6px;
        }

        .reference-link-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 12px;
        }

        .reference-link-item .link-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .reference-link-item .link-icon.youtube {
            background: rgba(255, 0, 0, 0.15);
            color: #ff0000;
        }

        .reference-link-item .link-icon.instagram {
            background: rgba(225, 48, 108, 0.15);
            color: #e1306c;
        }

        .reference-link-item .link-icon.generic {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .reference-link-item .link-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-primary);
        }

        .reference-link-item .link-delete {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .reference-link-item .link-delete:hover {
            background: var(--danger);
            color: white;
        }

        .add-reference-link-row {
            display: flex;
            gap: 6px;
        }

        .add-reference-link-row input {
            flex: 1;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 12px;
            outline: none;
        }

        .add-reference-link-row input:focus {
            border-color: var(--brand-primary);
        }

        .add-reference-link-row input::placeholder {
            color: var(--text-muted);
        }

        .add-link-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--brand-primary);
            background: rgba(13, 148, 136, 0.15);
            color: var(--brand-primary);
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .add-link-btn:hover {
            background: var(--brand-primary);
            color: white;
        }

        .video-recording-timer {
            font-size: 12px;
            font-weight: 600;
            color: var(--danger);
            min-width: 40px;
        }

        .sidebar-actions {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 14px 16px;
            border-radius: var(--radius-md);
            border: 2px dashed var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .sidebar-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.05);
        }

        .sidebar-btn.ai-btn {
            background: var(--purple-gradient);
            border: none;
            color: white;
        }

        .sidebar-btn.ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .sidebar-btn.import-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            color: white;
        }

        .sidebar-btn.import-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }

        .sidebar-btn.videos-btn {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            border: none;
            color: white;
        }

        .sidebar-btn.videos-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.4);
        }

        /* My Videos Modal */
        .my-videos-modal {
            width: 95%;
            max-width: 900px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .my-videos-toolbar {
            display: flex;
            gap: 10px;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            flex-wrap: wrap;
        }

        .my-videos-search {
            flex: 1;
            min-width: 180px;
            padding: 8px 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .my-videos-count {
            color: var(--text-secondary);
            font-size: 13px;
            white-space: nowrap;
        }

        .my-videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .my-video-card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .my-video-card:hover {
            border-color: var(--brand-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .my-video-preview {
            width: 100%;
            aspect-ratio: 16/9;
            background: #0a0a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
        }

        .my-video-preview video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .my-video-play-btn {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            transition: background 0.2s;
        }

        .my-video-play-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        .my-video-play-btn svg {
            width: 36px;
            height: 36px;
            fill: white;
            opacity: 0.9;
        }

        .my-video-card.playing .my-video-play-btn {
            display: none;
        }

        .my-video-info {
            padding: 10px 12px;
        }

        .my-video-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .my-video-meta {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .my-video-actions {
            display: flex;
            gap: 6px;
            padding: 0 12px 10px;
        }

        .my-video-actions button {
            flex: 1;
            padding: 6px 0;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .my-video-actions .replace-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.08);
        }

        .my-video-actions .delete-btn:hover {
            border-color: #ef4444;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.08);
        }

        .my-videos-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .my-videos-empty svg {
            margin-bottom: 12px;
            opacity: 0.4;
        }

        .my-videos-loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        /* Import Modal Styles */
        .import-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 40px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-tertiary);
            margin-bottom: 16px;
        }

        .import-drop-zone:hover,
        .import-drop-zone.dragover {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.05);
        }

        .import-drop-zone-icon {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.6;
        }

        .import-drop-zone-text {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }

        .import-drop-zone-text strong {
            color: var(--warning);
            display: block;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .import-or-divider {
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
            margin: 16px 0;
            position: relative;
        }

        .import-or-divider::before,
        .import-or-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: calc(50% - 20px);
            height: 1px;
            background: var(--border-color);
        }

        .import-or-divider::before { left: 0; }
        .import-or-divider::after { right: 0; }

        .import-paste-area {
            width: 100%;
            min-height: 150px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: 'Inter', monospace;
            font-size: 13px;
            padding: 12px;
            resize: vertical;
        }

        .import-paste-area::placeholder {
            color: var(--text-muted);
        }

        .import-paste-area:focus {
            outline: none;
            border-color: var(--warning);
        }

        .import-file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: var(--radius-sm);
            margin-top: 12px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .import-file-info svg {
            flex-shrink: 0;
            color: var(--warning);
        }

        .import-file-info .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .import-file-info .file-remove {
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px;
        }

        .import-file-info .file-remove:hover {
            color: var(--danger);
        }

        .import-match-stats {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 16px;
        }

        .import-match-stats h4 {
            margin-bottom: 12px;
            color: var(--text-primary);
            font-size: 15px;
        }

        .import-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .import-stat-row:last-child {
            border-bottom: none;
        }

        .import-stat-label {
            color: var(--text-secondary);
        }

        .import-stat-value {
            font-weight: 600;
        }

        .import-stat-value.matched {
            color: var(--success);
        }

        .import-stat-value.unmatched {
            color: var(--warning);
        }

        .import-unmatched-list {
            margin-top: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .import-unmatched-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .import-unmatched-item .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--warning);
            flex-shrink: 0;
        }

        .import-filter-toggle {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .import-filter-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .import-filter-btn:hover {
            border-color: var(--text-muted);
        }

        .import-filter-btn.active {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .import-filter-btn.active-warning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .import-progress {
            text-align: center;
            padding: 40px 20px;
        }

        .import-progress .spinner-large {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--warning);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        .import-progress p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Builder Area */
        .builder-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            max-width: 900px;
        }

        .builder-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .builder-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .builder-title svg {
            color: var(--brand-primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Hero Image Upload */
        .hero-image-upload {
            margin-top: 8px;
        }

        .hero-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 24px;
            text-align: center;
            background: var(--bg-tertiary);
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .hero-upload-area:hover {
            border-color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.05);
        }

        .hero-upload-area svg {
            color: var(--text-muted);
        }

        .hero-upload-area span {
            font-weight: 500;
            color: var(--text-primary);
        }

        .hero-upload-area .upload-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin: 0;
        }

        .hero-upload-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 8px;
        }

        .hero-upload-buttons .or-divider {
            color: var(--text-muted);
            font-size: 12px;
        }

        .hero-preview {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
            max-height: 200px;
        }

        .hero-preview img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: var(--radius-md);
        }

        .remove-hero-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .remove-hero-btn:hover {
            background: rgba(239, 68, 68, 0.9);
        }

        .remove-hero-btn svg {
            color: white;
        }

        /* Workout Days */
        .workout-day {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .workout-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .day-name-input {
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            padding: 8px 0;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .day-name-input:focus {
            outline: none;
            border-bottom-color: var(--brand-primary);
        }

        .workout-day-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            border: none;
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--danger);
            color: white;
        }

        .exercise-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .swap-btn:hover {
            background: var(--brand-primary) !important;
            color: white;
        }

        /* Exercise Item */
        .exercise-item {
            display: flex;
            gap: 16px;
            align-items: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .exercise-item:hover {
            border-color: var(--brand-primary);
            box-shadow: var(--shadow-sm);
        }

        .exercise-drag {
            color: var(--text-muted);
            cursor: grab;
            font-size: 1.2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .exercise-drag:active {
            cursor: grabbing;
        }

        .exercise-item.dragging {
            opacity: 0.4;
            background: var(--bg-tertiary);
        }

        .exercise-item.drag-over {
            border-top: 2px solid var(--brand-primary);
        }

        .exercise-move-btns {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .exercise-move-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            line-height: 1;
            font-size: 14px;
            transition: color 0.15s;
        }

        .exercise-move-btn:hover {
            color: var(--brand-primary);
        }

        .exercise-move-btn:disabled {
            opacity: 0.2;
            cursor: default;
        }

        .exercise-thumb-wrap {
            position: relative;
            flex-shrink: 0;
        }

        .exercise-thumb {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            object-fit: cover;
            flex-shrink: 0;
        }

        .video-badge {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .video-badge svg {
            width: 10px;
            height: 10px;
        }

        .exercise-info {
            flex: 1;
            min-width: 0;
        }

        .exercise-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .exercise-config {
            display: flex;
            gap: 12px;
        }

        .superset-warning {
            font-size: 11px;
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.25);
            border-radius: 6px;
            padding: 4px 10px;
            margin-top: 4px;
        }

        .config-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .config-input {
            width: 60px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            text-align: center;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .config-input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .config-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .config-label.clickable {
            cursor: pointer;
            transition: color 0.2s;
        }

        .config-label.clickable:hover {
            color: var(--brand-primary);
        }

        .tracking-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 2px 8px;
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
            transition: all 0.2s;
        }

        .tracking-toggle-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        .tracking-toggle-btn.time-active {
            background: rgba(20, 184, 166, 0.15);
            border-color: rgba(20, 184, 166, 0.4);
            color: var(--brand-primary);
        }

        .tracking-toggle-btn .toggle-icon {
            font-size: 10px;
        }

        .exercise-notes {
            margin-top: 8px;
        }

        .notes-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .notes-input::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .add-exercise-btn {
            width: 100%;
            padding: 16px;
            background: transparent;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .add-exercise-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.05);
        }

        .add-day-btn {
            width: 100%;
            padding: 16px;
            background: var(--brand-gradient);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: inherit;
            margin-top: 16px;
        }

        .add-day-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(13, 148, 136, 0.3);
        }

        /* Assign Section */
        .assign-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .assign-btn {
            width: 100%;
            padding: 16px 24px;
            background: var(--brand-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .assign-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(13, 148, 136, 0.3);
        }

        .assign-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Assign Modal Styles */
        .assign-modal {
            max-width: 500px;
            width: 95%;
        }

        .assign-modal .modal-body {
            padding: 0;
        }

        .assign-modal .form-input {
            margin: 16px;
            width: calc(100% - 32px);
        }

        .client-select-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .client-select-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .client-select-item:hover {
            background: var(--bg-tertiary);
        }

        .client-select-item.selected {
            background: rgba(13, 148, 136, 0.1);
        }

        .client-select-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--brand-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .client-select-info {
            flex: 1;
            min-width: 0;
        }

        .client-select-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .client-select-email {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .client-select-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .client-select-check svg {
            opacity: 0;
            color: white;
        }

        .client-select-item.selected .client-select-check {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
        }

        .client-select-item.selected .client-select-check svg {
            opacity: 1;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        .modal-footer .btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .modal-footer .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modal-footer .btn-primary {
            background: var(--brand-gradient);
            color: white;
            border: none;
        }

        .modal-footer .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Schedule Modal */
        .schedule-row {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .schedule-row:last-child {
            border-bottom: none;
        }

        .schedule-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .schedule-row .form-input {
            margin: 0;
            width: 100%;
        }

        .selected-clients-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .selected-client-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
        }

        .selected-client-chip img,
        .selected-client-chip .chip-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--brand-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .days-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .day-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .day-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--brand-primary);
        }

        .day-checkbox span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Legacy client card styles - keeping for backward compatibility */
        .client-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .client-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .client-card:hover {
            border-color: var(--border-color);
        }

        .client-card.selected {
            border-color: var(--brand-primary);
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.1) 0%, rgba(2, 132, 199, 0.1) 100%);
        }

        .client-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .client-check svg {
            opacity: 0;
            color: white;
            transition: opacity 0.2s;
        }

        .client-card.selected .client-check {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
        }

        .client-card.selected .client-check svg {
            opacity: 1;
        }

        .client-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--brand-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .client-info {
            flex: 1;
            min-width: 0;
        }

        .client-name {
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .client-email {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px 28px;
        }

        /* Swap Exercise List */
        .swap-exercise-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .swap-exercise-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .swap-exercise-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--brand-primary);
        }

        .swap-exercise-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-tertiary);
        }

        .swap-exercise-info {
            flex: 1;
        }

        .swap-exercise-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .swap-exercise-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Exercise Badges for Superset, Warm-up, Stretch */
        .exercise-name-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .exercise-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .exercise-badge {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .superset-badge {
            background: linear-gradient(135deg, #8B5CF6, #6366F1);
            color: white;
        }

        .warmup-badge {
            background: linear-gradient(135deg, #F59E0B, #EF4444);
            color: white;
        }

        .stretch-badge {
            background: linear-gradient(135deg, #10B981, #14B8A6);
            color: white;
        }

        /* Highlight superset exercises */
        .superset-exercise {
            border-left: 3px solid #8B5CF6;
            padding-left: 12px;
            margin-left: -15px;
        }

        .warmup-exercise {
            border-left: 3px solid #F59E0B;
            padding-left: 12px;
            margin-left: -15px;
        }

        .stretch-exercise {
            border-left: 3px solid #10B981;
            padding-left: 12px;
            margin-left: -15px;
        }

        /* Exercise Label Selector */
        .exercise-label-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
        }

        .exercise-label-select {
            background: var(--card-bg, #1e293b);
            color: var(--text-color, #e2e8f0);
            border: 1px solid var(--border-color, #334155);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s;
        }

        .exercise-label-select:hover {
            border-color: var(--primary, #6366f1);
        }

        .exercise-label-select:focus {
            border-color: var(--primary, #6366f1);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .label-hint {
            font-size: 0.65rem;
            color: var(--text-muted, #94a3b8);
        }

        .modal-footer {
            padding: 20px 28px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Exercise Grid in Modal */
        .exercise-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .filter-chip:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        .filter-chip.active {
            background: var(--brand-gradient);
            border-color: transparent;
            color: white;
        }

        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }

        .exercise-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .exercise-card:hover {
            border-color: var(--brand-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .exercise-card.selected {
            border-color: var(--brand-primary);
            background: rgba(139, 92, 246, 0.08);
        }

        .exercise-card-check {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            transition: all 0.15s;
        }

        .exercise-card-check svg {
            display: none;
            width: 14px;
            height: 14px;
            stroke: #fff;
        }

        .exercise-card.selected .exercise-card-check {
            background: var(--brand-primary, #8b5cf6);
            border-color: var(--brand-primary, #8b5cf6);
        }

        .exercise-card.selected .exercise-card-check svg {
            display: block;
        }

        /* Floating multi-select action bar */
        .exercise-select-bar {
            display: none;
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--brand-primary, #8b5cf6);
            color: #fff;
            padding: 12px 20px;
            border-radius: 12px;
            margin-top: 12px;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            box-shadow: 0 -4px 20px rgba(139, 92, 246, 0.4);
            z-index: 10;
        }

        .exercise-select-bar.visible {
            display: flex;
        }

        .exercise-select-bar-count {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .exercise-select-bar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .exercise-select-bar-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
        }

        .exercise-select-bar-btn--add {
            background: #fff;
            color: var(--brand-primary, #8b5cf6);
        }

        .exercise-select-bar-btn--add:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
        }

        .exercise-select-bar-btn--clear {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .exercise-select-bar-btn--clear:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .exercise-card .video-indicator {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .exercise-card-thumb {
            width: 100%;
            height: 100px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            background: var(--bg-secondary);
            margin-bottom: 12px;
        }

        .exercise-card-thumb-video {
            width: 100%;
            height: 100px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            background: var(--bg-secondary);
            margin-bottom: 12px;
        }

        .exercise-thumb-video {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            object-fit: cover;
        }

        .exercise-card-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .exercise-card-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .exercise-card-secondary {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 4px;
            opacity: 0.8;
        }

        .exercise-library-modal {
            max-width: 700px;
            max-height: 90vh;
        }

        .exercise-library-modal .modal-body {
            max-height: calc(90vh - 80px);
            overflow-y: auto;
        }

        .exercise-thumb-container {
            position: relative;
        }

        .edit-thumb-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
        }

        .exercise-card:hover .edit-thumb-btn {
            opacity: 1;
        }

        .edit-thumb-btn:hover {
            background: rgba(13, 148, 136, 0.9);
        }

        .edit-thumb-btn.no-thumb {
            opacity: 1;
            background: rgba(239, 68, 68, 0.8);
            animation: pulse-thumb 2s infinite;
        }

        @keyframes pulse-thumb {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .edit-thumb-btn.no-thumb:hover {
            background: rgba(13, 148, 136, 0.9);
            animation: none;
        }

        /* AI Modal Specific */
        .ai-form-group {
            margin-bottom: 20px;
        }

        .ai-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .ai-form-group input,
        .ai-form-group select,
        .ai-form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .ai-form-group input:focus,
        .ai-form-group select:focus,
        .ai-form-group textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .ai-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .equipment-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .equipment-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .equipment-item:has(input:checked) {
            background: rgba(13, 148, 136, 0.15);
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        .equipment-item input {
            accent-color: var(--brand-primary);
        }

        .ai-btn {
            padding: 14px 28px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .ai-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .ai-btn-cancel:hover {
            background: var(--border-color);
        }

        .ai-btn-generate {
            background: var(--purple-gradient);
            color: white;
        }

        .ai-btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .ai-btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Mode selection cards */
        .ai-mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .ai-mode-card {
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .ai-mode-card:hover {
            border-color: var(--brand-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
        }

        .ai-mode-card.selected {
            border-color: var(--brand-primary);
            background: rgba(139, 92, 246, 0.08);
        }

        .ai-mode-icon {
            font-size: 1.75rem;
            margin-bottom: 8px;
        }

        .ai-mode-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .ai-mode-desc {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .ai-form-section {
            display: none;
        }

        .ai-form-section.active {
            display: block;
        }

        .generating-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            animation: toastSlideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Custom Exercise Modal Styles */
        .custom-exercise-modal {
            max-width: 600px;
            max-height: 90vh;
        }

        .custom-exercise-modal .modal-body {
            max-height: calc(90vh - 140px);
            overflow-y: auto;
            padding: 24px;
        }

        .custom-exercise-form-group {
            margin-bottom: 20px;
        }

        .custom-exercise-form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .custom-exercise-form-group label .required {
            color: var(--danger);
        }

        .custom-exercise-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .video-upload-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .video-upload-section h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .video-upload-options {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .video-upload-option {
            flex: 1;
            padding: 16px;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .video-upload-option:hover {
            border-color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.05);
        }

        .video-upload-option.active {
            border-color: var(--brand-primary);
            background: rgba(13, 148, 136, 0.1);
        }

        .video-upload-option svg {
            width: 32px;
            height: 32px;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .video-upload-option:hover svg,
        .video-upload-option.active svg {
            color: var(--brand-primary);
        }

        .video-upload-option span {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .custom-video-preview-container {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            display: none;
        }

        .custom-video-preview-container.visible {
            display: block;
        }

        .custom-video-preview-container video {
            width: 100%;
            max-height: 200px;
            border-radius: var(--radius-sm);
            background: #000;
        }

        .custom-video-preview-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
        }

        .custom-video-preview-info span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .create-exercise-header-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(13, 148, 136, 0.15);
            color: var(--brand-primary);
            border: 1px solid var(--brand-primary);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .create-exercise-header-btn:hover {
            background: var(--brand-primary);
            color: white;
        }

        .custom-exercise-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Recording indicator for custom exercise */
        .ce-recording-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: var(--radius-md);
            color: var(--danger);
            margin-top: 12px;
        }

        .ce-recording-indicator .recording-dot {
            width: 10px;
            height: 10px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .ce-recording-indicator .recording-timer {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .ce-recording-indicator .recording-text {
            font-size: 0.85rem;
        }

        /* Responsive - Tablet */
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: relative;
                top: 0;
                height: auto;
                max-height: none;
                overflow: visible;
                display: none;
            }

            .sidebar.mobile-open {
                display: flex;
            }

            .sidebar-header {
                padding: 16px;
            }

            .sidebar-actions {
                flex-direction: row;
                flex-wrap: wrap;
                padding: 12px;
                gap: 8px;
            }

            .sidebar-actions .sidebar-btn {
                flex: 1 1 calc(50% - 4px);
                min-width: 0;
                padding: 12px 10px;
                font-size: 0.8rem;
            }

            .program-list {
                max-height: 200px;
                padding: 12px;
            }

            .mobile-sidebar-toggle {
                display: flex;
            }

            .builder-area {
                max-width: 100%;
                padding: 16px;
            }

            .builder-card {
                padding: 20px;
                margin-bottom: 16px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .ai-form-row {
                grid-template-columns: 1fr;
            }

            .custom-exercise-form-row {
                grid-template-columns: 1fr;
            }

            .video-upload-options {
                flex-direction: column;
            }

            .ai-mode-selector {
                grid-template-columns: 1fr;
            }

            /* Modal adjustments for tablet */
            .modal {
                max-width: 95%;
                max-height: 90vh;
                border-radius: var(--radius-lg);
            }

            .modal-overlay {
                padding: 12px;
            }

            .modal-header {
                padding: 16px 20px;
            }

            .modal-body {
                padding: 16px 20px;
            }

            .modal-footer {
                padding: 14px 20px;
            }
        }

        /* Responsive - Mobile phone */
        @media (max-width: 600px) {
            /* Top nav */
            .top-nav {
                padding: 10px 12px;
                gap: 8px;
            }

            .nav-back {
                font-size: 0.8rem;
                gap: 4px;
                flex-shrink: 0;
            }

            .nav-back svg {
                width: 16px;
                height: 16px;
            }

            .nav-title {
                font-size: 1rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex-shrink: 1;
                min-width: 0;
            }

            .nav-actions {
                gap: 6px;
                flex-shrink: 0;
            }

            .nav-actions .btn {
                padding: 8px 12px;
                font-size: 0.75rem;
                gap: 4px;
            }

            .nav-actions .btn svg {
                width: 14px;
                height: 14px;
            }

            /* Save dropdown adjustments */
            .save-dropdown .btn-save-main {
                padding: 8px 12px;
                font-size: 0.75rem;
                gap: 4px;
            }

            .save-dropdown .btn-save-main svg {
                width: 14px;
                height: 14px;
            }

            .save-dropdown-menu {
                min-width: 220px;
                right: -8px;
            }

            /* Sidebar mobile toggle */
            .mobile-sidebar-toggle {
                display: flex;
            }

            /* Builder area */
            .builder-area {
                padding: 12px;
            }

            .builder-card {
                padding: 16px;
                margin-bottom: 12px;
                border-radius: var(--radius-md);
            }

            .builder-title {
                font-size: 1rem;
                margin-bottom: 16px;
                gap: 8px;
            }

            .builder-title svg {
                width: 20px;
                height: 20px;
            }

            /* Form fields */
            .form-group {
                margin-bottom: 14px;
            }

            .form-input, .form-select, .form-textarea {
                padding: 12px 14px;
                font-size: 0.9rem;
            }

            .form-label {
                font-size: 0.7rem;
                margin-bottom: 6px;
            }

            /* Hero upload section */
            .hero-upload-area {
                padding: 16px;
            }

            .hero-upload-area svg {
                width: 24px;
                height: 24px;
            }

            .hero-upload-buttons {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                width: 100%;
            }

            .hero-upload-buttons .or-divider {
                text-align: center;
                margin: -4px 0;
            }

            .hero-upload-buttons .btn-secondary,
            .hero-upload-buttons .btn-ai-generate {
                width: 100%;
                justify-content: center;
                padding: 10px 16px;
            }

            /* Workout days */
            .workout-day {
                padding: 14px;
                margin-bottom: 12px;
            }

            .workout-day-header {
                margin-bottom: 12px;
            }

            .day-name-input {
                font-size: 0.9rem;
                max-width: calc(100% - 50px);
            }

            /* Exercise items - stack layout */
            .exercise-item {
                flex-wrap: wrap;
                gap: 10px;
                padding: 12px;
            }

            .exercise-drag {
                order: -1;
            }

            .exercise-thumb-wrap {
                flex-shrink: 0;
            }

            .exercise-thumb,
            .exercise-thumb-video {
                width: 48px;
                height: 48px;
            }

            .exercise-info {
                flex: 1;
                min-width: 0;
                width: calc(100% - 80px);
            }

            .exercise-name {
                font-size: 0.85rem;
                white-space: normal;
                overflow: visible;
                text-overflow: initial;
            }

            .exercise-config {
                width: 100%;
                flex-basis: 100%;
                justify-content: flex-start;
                gap: 8px;
                padding-left: 0;
                flex-wrap: wrap;
            }

            .config-input {
                width: 52px;
                padding: 6px 4px;
                font-size: 0.8rem;
            }

            .config-label {
                font-size: 0.6rem;
            }

            .exercise-actions {
                gap: 4px;
            }

            .exercise-actions .icon-btn {
                width: 32px;
                height: 32px;
            }

            .exercise-actions .icon-btn svg {
                width: 14px;
                height: 14px;
            }

            .exercise-notes .notes-input {
                padding: 8px 10px;
                font-size: 0.8rem;
            }

            /* Exercise badges */
            .exercise-name-row {
                gap: 4px;
            }

            .exercise-badge {
                font-size: 0.6rem;
                padding: 1px 5px;
            }

            /* Add buttons */
            .add-exercise-btn {
                padding: 12px;
                font-size: 0.85rem;
            }

            .add-day-btn {
                padding: 14px;
                font-size: 0.9rem;
            }

            /* Assign section */
            .assign-description {
                font-size: 0.85rem;
            }

            .assign-btn {
                padding: 14px 20px;
                font-size: 0.9rem;
            }

            /* Modals - near full screen on mobile */
            .modal-overlay {
                padding: 8px;
                align-items: flex-end;
            }

            .modal {
                max-width: 100%;
                max-height: 92vh;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
                width: 100%;
            }

            .modal-header {
                padding: 14px 16px;
            }

            .modal-title {
                font-size: 1rem;
                gap: 8px;
            }

            .modal-title svg {
                width: 20px;
                height: 20px;
            }

            .modal-close {
                width: 34px;
                height: 34px;
                font-size: 1.2rem;
            }

            .modal-body {
                padding: 14px 16px;
            }

            .modal-footer {
                padding: 12px 16px;
            }

            .modal-footer .btn {
                padding: 10px 14px;
                font-size: 0.85rem;
            }

            /* Exercise library modal */
            .exercise-library-modal {
                max-height: 92vh;
            }

            .exercise-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
            }

            .exercise-card {
                padding: 10px;
            }

            .exercise-card-thumb,
            .exercise-card-thumb-video {
                height: 80px;
                margin-bottom: 8px;
            }

            .exercise-card-name {
                font-size: 0.8rem;
            }

            .exercise-card-meta {
                font-size: 0.7rem;
            }

            .exercise-filters {
                gap: 6px;
                margin-bottom: 12px;
            }

            .filter-chip {
                padding: 6px 12px;
                font-size: 0.75rem;
            }

            /* Exercise select bar */
            .exercise-select-bar {
                padding: 10px 14px;
                border-radius: 10px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .exercise-select-bar-count {
                font-size: 0.8rem;
            }

            .exercise-select-bar-btn {
                padding: 6px 14px;
                font-size: 0.8rem;
            }

            /* Assign modal */
            .assign-modal {
                max-width: 100%;
            }

            .client-select-list {
                max-height: 300px;
            }

            /* AI modal */
            .ai-mode-selector {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .ai-mode-card {
                padding: 14px;
            }

            .ai-mode-icon {
                font-size: 1.5rem;
            }

            .ai-mode-title {
                font-size: 0.9rem;
            }

            .ai-mode-desc {
                font-size: 0.75rem;
            }

            .ai-btn {
                padding: 12px 20px;
                font-size: 0.875rem;
            }

            /* Swap modal */
            .swap-exercise-thumb {
                width: 48px;
                height: 48px;
            }

            .swap-exercise-name {
                font-size: 0.85rem;
            }

            .swap-exercise-meta {
                font-size: 0.7rem;
            }

            /* Recommended swaps */
            .recommended-swap-item {
                gap: 8px;
                padding: 10px;
            }

            .recommended-swap-item .swap-thumb {
                width: 40px;
                height: 40px;
            }

            /* Schedule modal */
            .days-selector {
                gap: 6px;
            }

            .day-checkbox span {
                font-size: 0.75rem;
            }

            /* Custom exercise modal */
            .custom-exercise-modal {
                max-width: 100%;
            }

            .custom-exercise-modal .modal-body {
                padding: 16px;
            }

            /* Toast notification */
            .toast {
                left: 12px;
                right: 12px;
                bottom: 12px;
                padding: 12px 16px;
                font-size: 0.85rem;
            }

            /* Confirm modal */
            .confirm-modal {
                padding: 20px;
                width: 95%;
            }

            .confirm-modal-title {
                font-size: 1rem;
            }

            .confirm-modal-message {
                font-size: 0.85rem;
            }

            /* Club workout toggle */
            .form-group[style*="display: flex"] {
                padding: 10px 12px !important;
            }

            /* My videos modal */
            .my-videos-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
                padding: 12px;
            }

            .my-videos-toolbar {
                padding: 10px 12px;
                gap: 8px;
            }

            /* Empty state */
            .empty-state {
                padding: 40px 16px;
            }

            .empty-icon {
                font-size: 3rem;
            }

            .empty-title {
                font-size: 1rem;
            }

            /* Superset/warmup/stretch border adjustments */
            .superset-exercise,
            .warmup-exercise,
            .stretch-exercise {
                margin-left: -12px;
                padding-left: 10px;
            }
        }

        /* Mobile sidebar toggle button */
        .mobile-sidebar-toggle {
            display: none;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .mobile-sidebar-toggle:hover {
            background: rgba(255,255,255,0.25);
        }

        .mobile-sidebar-toggle .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 16px;
            height: 16px;
            background: var(--warning);
            color: white;
            font-size: 10px;
            font-weight: 700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Quick Actions Bar */
        .mobile-quick-actions {
            display: none;
            overflow-x: auto;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .mobile-quick-actions::-webkit-scrollbar {
            display: none;
        }

        @media (max-width: 900px) {
            .mobile-quick-actions {
                display: flex;
            }
        }

        .mobile-quick-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
            font-family: inherit;
            transition: all 0.2s;
        }

        .mobile-quick-btn:active {
            transform: scale(0.96);
        }

        .mobile-quick-btn.ai {
            background: var(--purple-gradient);
            border: none;
            color: white;
        }

        .mobile-quick-btn.import {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            color: white;
        }

        .mobile-quick-btn.videos {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            border: none;
            color: white;
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <a href="dashboard.html" class="nav-back">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Dashboard
        </a>
        <span class="nav-title">Workout Builder</span>
        <div class="nav-actions">
            <button class="mobile-sidebar-toggle" onclick="toggleMobileSidebar()" title="Programs" style="position:relative;">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                </svg>
            </button>
            <!-- Simple save button (shown for new programs) -->
            <button class="btn btn-primary" id="simpleSaveBtn" onclick="saveProgram()" style="display: inline-flex;">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Save Program
            </button>
            <!-- Dropdown save button (shown when editing existing program) -->
            <div class="save-dropdown" id="saveDropdown" style="display: none;">
                <button class="btn btn-primary btn-save-main" onclick="saveProgram()">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Save Program
                </button>
                <button class="btn-save-toggle" onclick="toggleSaveDropdown(event)" title="More save options">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="save-dropdown-menu" id="saveDropdownMenu">
                    <button class="save-dropdown-item" onclick="saveProgram(); closeSaveDropdown();">
                        <span class="save-dropdown-item-title">Save Program Only</span>
                        <span class="save-dropdown-item-desc">Update the template without affecting current clients</span>
                    </button>
                    <button class="save-dropdown-item" onclick="saveProgramAndUpdateClients(); closeSaveDropdown();">
                        <span class="save-dropdown-item-title">Save & Update Clients <span class="client-count-badge" id="activeClientCount" style="display:none;">0</span></span>
                        <span class="save-dropdown-item-desc">Save changes and apply them to all clients using this program</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Your Programs</div>
                <input type="text" class="sidebar-search" id="programSearchInput" placeholder="Search programs..." oninput="filterPrograms()">
                <div class="sidebar-filters">
                    <select class="sidebar-filter-select" id="programTypeFilter" onchange="filterPrograms()">
                        <option value="">All Types</option>
                        <option value="strength">Strength</option>
                        <option value="hypertrophy">Hypertrophy</option>
                        <option value="endurance">Endurance</option>
                        <option value="weight_loss">Weight Loss</option>
                        <option value="general">General</option>
                    </select>
                    <select class="sidebar-filter-select" id="programDifficultyFilter" onchange="filterPrograms()">
                        <option value="">All Levels</option>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                    <select class="sidebar-filter-select" id="programDaysFilter" onchange="filterPrograms()">
                        <option value="">All Days</option>
                        <option value="1">1 day</option>
                        <option value="2">2 days</option>
                        <option value="3">3 days</option>
                        <option value="4">4 days</option>
                        <option value="5">5 days</option>
                        <option value="6">6 days</option>
                    </select>
                </div>
            </div>
            <div class="program-list" id="programList">
                <div class="empty-state">
                    <div class="empty-icon"></div>
                    <div class="empty-title">No programs yet</div>
                    <p>Create your first workout program</p>
                </div>
            </div>
            <div class="sidebar-actions">
                <button class="sidebar-btn" onclick="createNewProgram()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Program
                </button>
                <button class="sidebar-btn ai-btn" onclick="openAIModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    AI Generate
                </button>
                <button class="sidebar-btn import-btn" onclick="openImportModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Import Program
                </button>
                <button class="sidebar-btn videos-btn" onclick="openMyVideosModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    My Videos
                </button>
            </div>
        </div>

        <!-- Mobile Quick Actions (visible only on mobile) -->
        <div class="mobile-quick-actions">
            <button class="mobile-quick-btn" onclick="createNewProgram()">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                New
            </button>
            <button class="mobile-quick-btn ai" onclick="openAIModal()">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                AI Generate
            </button>
            <button class="mobile-quick-btn import" onclick="openImportModal()">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                Import
            </button>
            <button class="mobile-quick-btn videos" onclick="openMyVideosModal()">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                Videos
            </button>
        </div>

        <!-- Builder Area -->
        <div class="builder-area">
            <!-- Program Details -->
            <div class="builder-card">
                <h2 class="builder-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Program Details
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Program Name</label>
                        <input type="text" class="form-input" id="programName" placeholder="e.g., 4-Week Hypertrophy Program">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Program Type</label>
                        <select class="form-select" id="programType">
                            <option value="strength">Strength</option>
                            <option value="hypertrophy" selected>Hypertrophy</option>
                            <option value="endurance">Endurance</option>
                            <option value="weight_loss">Weight Loss</option>
                            <option value="general">General Fitness</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Difficulty</label>
                        <select class="form-select" id="programDifficulty">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate" selected>Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Days Per Week</label>
                        <select class="form-select" id="daysPerWeek">
                            <option value="1">1 day</option>
                            <option value="2">2 days</option>
                            <option value="3">3 days</option>
                            <option value="4" selected>4 days</option>
                            <option value="5">5 days</option>
                            <option value="6">6 days</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="programDescription" placeholder="Describe the program goals and structure..."></textarea>
                </div>

                <!-- Club Workout Toggle -->
                <div class="form-group" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(139, 92, 246, 0.08); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 10px;">
                    <label class="toggle-switch" style="position: relative; width: 44px; height: 24px; flex-shrink: 0;">
                        <input type="checkbox" id="isClubWorkout" style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #334155; border-radius: 24px; transition: 0.3s;"></span>
                    </label>
                    <div>
                        <div style="font-weight: 600; color: #f8fafc; font-size: 14px;">Club Workout</div>
                        <div style="font-size: 12px; color: #94a3b8;">Visible to all your clients  they can browse and start this workout anytime</div>
                    </div>
                </div>

                <style>
                    .toggle-switch input:checked + span {
                        background: #8b5cf6 !important;
                    }
                    .toggle-switch span::before {
                        content: "";
                        position: absolute;
                        height: 18px;
                        width: 18px;
                        left: 3px;
                        bottom: 3px;
                        background: white;
                        border-radius: 50%;
                        transition: 0.3s;
                    }
                    .toggle-switch input:checked + span::before {
                        transform: translateX(20px);
                    }
                </style>

                <!-- Hero Image Upload -->
                <div class="form-group">
                    <label class="form-label">Cover Image</label>
                    <div class="hero-image-upload">
                        <div id="heroImagePreview" class="hero-preview" style="display: none;">
                            <img id="heroPreviewImg" src="" alt="Cover preview">
                            <button type="button" class="remove-hero-btn" onclick="removeHeroImage()" title="Remove image">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div id="heroUploadArea" class="hero-upload-area">
                            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <span>Upload cover image</span>
                            <p class="upload-hint">This image will appear at the top of the workout for clients</p>
                            <input type="file" id="heroFileInput" accept="image/*" onchange="previewHeroImage(event)" style="display: none;">
                            <div class="hero-upload-buttons">
                                <button type="button" class="btn-secondary" onclick="document.getElementById('heroFileInput').click()">
                                    Choose File
                                </button>
                                <span class="or-divider">or</span>
                                <button type="button" class="btn-secondary" onclick="showHeroUrlInput()">
                                    Paste URL
                                </button>
                                <span class="or-divider">or</span>
                                <button type="button" class="btn-ai-generate" id="aiCoverBtn" onclick="generateAICoverImage()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                    AI Generate
                                </button>
                            </div>
                            <div id="heroUrlInputContainer" style="display: none; margin-top: 12px; width: 100%;">
                                <input type="text" id="heroUrlInput" class="form-input" placeholder="https://example.com/image.jpg" style="width: 100%;">
                                <button type="button" class="btn-primary" onclick="applyHeroUrl()" style="margin-top: 8px;">Apply URL</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="heroImageUrl" value="">
                </div>
            </div>

            <!-- Workout Days -->
            <div class="builder-card">
                <h2 class="builder-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Workout Days
                </h2>
                <div id="workoutDays">
                    <!-- Days will be rendered here -->
                </div>
                <button class="add-day-btn" onclick="addWorkoutDay()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Workout Day
                </button>
            </div>

            <!-- Assign to Clients -->
            <div class="builder-card">
                <h2 class="builder-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    Assign Program
                </h2>
                <p class="assign-description">Save your program first, then assign it to one or more clients with a schedule.</p>
                <button class="assign-btn" onclick="openAssignModal()" id="assignBtn" disabled>
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    Assign to Clients
                </button>
            </div>
        </div>
    </div>

    <!-- Client Selection Modal (Step 1) -->
    <div class="modal-overlay" id="clientSelectModal">
        <div class="modal assign-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Select Clients
                </h3>
                <button class="modal-close" onclick="closeClientSelectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-input" id="clientSearchInput" placeholder="Search client name..." oninput="filterClients(this.value)">
                <div class="client-select-list" id="clientSelectList">
                    <!-- Clients rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeClientSelectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="proceedToSchedule()" id="continueBtn" disabled>
                    Continue
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Schedule Assignment Modal (Step 2) -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal assign-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Assign Workout
                </h3>
                <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="schedule-row">
                    <label class="schedule-label">Clients</label>
                    <div class="selected-clients-display" id="selectedClientsDisplay">
                        <!-- Selected clients shown here -->
                    </div>
                </div>
                <div class="schedule-row">
                    <label class="schedule-label">Start date</label>
                    <input type="date" class="form-input" id="startDate">
                </div>
                <div class="schedule-row">
                    <label class="schedule-label">Amount of weeks</label>
                    <input type="number" class="form-input" id="weeksAmount" value="4" min="1" max="52">
                </div>
                <div class="schedule-row">
                    <label class="schedule-label">Select days</label>
                    <div class="days-selector">
                        <label class="day-checkbox"><input type="checkbox" value="mon" checked><span>Mon</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="tue" checked><span>Tue</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="wed"><span>Wed</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="thu" checked><span>Thu</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="fri" checked><span>Fri</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="sat"><span>Sat</span></label>
                        <label class="day-checkbox"><input type="checkbox" value="sun"><span>Sun</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="backToClientSelect()">Cancel</button>
                <button class="btn btn-primary" onclick="assignWorkout()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Assign
                </button>
            </div>
        </div>
    </div>

    <!-- Exercise Library Modal -->
    <!-- Swap Exercise Modal -->
    <div class="modal-overlay" id="swapModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                    </svg>
                    Swap Exercise
                </h3>
                <button class="modal-close" onclick="closeSwapModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="swapCurrentExercise" style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                    <p style="margin: 0 0 4px 0; color: var(--text-muted); font-size: 12px;">Current exercise:</p>
                    <p style="margin: 0; font-weight: 600;" id="swapCurrentName">-</p>
                </div>

                <!-- AI Smart Suggestions -->
                <div id="swapAISuggestionsSection" style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 13px; color: #10b981; display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Smart Suggestions
                    </h4>
                    <div id="swapAISuggestionsList">
                        <div style="padding: 16px; text-align: center; color: var(--text-muted); font-size: 13px;">
                            <div class="spinner" style="margin: 0 auto 8px; width: 24px; height: 24px; border: 2px solid var(--border-color); border-top-color: #10b981; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                            Finding best alternatives...
                        </div>
                    </div>
                </div>

                <!-- Browse All Section -->
                <div style="border-top: 1px solid var(--border-color); padding-top: 12px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 13px; color: var(--text-secondary);">Browse All</h4>
                    <div style="margin-bottom: 12px;">
                        <input type="text" id="swapSearchInput" class="form-input" placeholder="Search exercises..." oninput="filterSwapExercises(this.value)">
                    </div>
                    <div id="swapExerciseList" class="swap-exercise-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- Exercise options will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommended Swaps Modal -->
    <div class="modal-overlay" id="recommendedSwapsModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                    </svg>
                    Recommended Swaps
                </h3>
                <button class="modal-close" onclick="closeRecommendedSwapsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                    <p style="margin: 0 0 4px 0; color: var(--text-muted); font-size: 12px;">Configure swaps for:</p>
                    <p style="margin: 0; font-weight: 600;" id="recommendedCurrentName">-</p>
                </div>

                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                    Select exercises you recommend as alternatives. These will appear first when your client tries to swap this exercise.
                </p>

                <!-- Current Recommended Swaps -->
                <div id="currentRecommendedSwaps" class="recommended-swaps-list">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- AI-Powered Suggestions Section -->
                <div class="ai-swap-suggestions-section" style="margin-bottom: 20px; border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 16px; background: rgba(16, 185, 129, 0.05);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <h4 style="margin: 0; display: flex; align-items: center; gap: 8px; color: #10b981; font-size: 14px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            AI Suggested Swaps
                        </h4>
                        <button class="btn btn-sm" onclick="fetchAISwapSuggestions()" id="aiSwapFetchBtn"
                            style="background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Get AI Suggestions
                        </button>
                    </div>
                    <p style="font-size: 12px; color: var(--text-muted); margin: 0 0 12px 0;">
                        AI analyzes movement patterns, muscle groups, and biomechanics to suggest the best alternatives. Click to add any suggestion.
                    </p>
                    <div id="aiSwapSuggestionsContainer" style="min-height: 40px;">
                        <p style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 12px 0;">Click "Get AI Suggestions" to see smart alternatives</p>
                    </div>
                </div>

                <!-- Add More Section -->
                <div class="add-recommended-section">
                    <h4>Add Recommended Swaps</h4>
                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                        Search any exercise by name, muscle group, or equipment (e.g., "adduction", "dumbbell", "chest")
                    </p>
                    <div style="margin-bottom: 12px;">
                        <input type="text" id="recommendedSearchInput" class="form-input" placeholder="Search all exercises..." oninput="filterRecommendedExercises(this.value)">
                    </div>
                    <div id="recommendedExerciseOptions" style="max-height: 250px; overflow-y: auto;">
                        <!-- Exercise options will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRecommendedSwapsModal()" style="background: var(--bg-tertiary); color: var(--text-primary);">Done</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="exerciseModal">
        <div class="modal exercise-library-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    Add Exercise
                </h3>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="create-exercise-header-btn" onclick="openCustomExerciseModal()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Create Custom
                    </button>
                    <button class="modal-close" onclick="closeExerciseModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <input type="text" class="form-input" id="exerciseSearchInput" placeholder="Search exercises (e.g., tricep, bench press...)" oninput="searchExercises(this.value)" style="margin-bottom: 16px;">

                <!-- Muscle Group Pills -->
                <div class="exercise-filters">
                    <button class="filter-chip active" onclick="filterExercises('all', this)">All</button>
                    <button class="filter-chip" onclick="filterExercises('chest', this)">Chest</button>
                    <button class="filter-chip" onclick="filterExercises('back', this)">Back</button>
                    <button class="filter-chip" onclick="filterExercises('shoulders', this)">Shoulders</button>
                    <button class="filter-chip" onclick="filterExercises('legs', this)">Legs</button>
                    <button class="filter-chip" onclick="filterExercises('arms', this)">Arms</button>
                    <button class="filter-chip" onclick="filterExercises('core', this)">Core</button>
                    <button class="filter-chip" style="background: rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.3); color: #10b981;" onclick="filterExercises('warmup', this)">Warm-up</button>
                    <button class="filter-chip" style="background: rgba(139, 92, 246, 0.15); border-color: rgba(139, 92, 246, 0.3); color: #8b5cf6;" onclick="filterExercises('stretches', this)">Stretches</button>
                </div>

                <!-- Advanced Filters Row -->
                <div class="advanced-filters-row" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                    <div class="filter-dropdown-group" style="flex: 1; min-width: 140px;">
                        <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">Equipment</label>
                        <select id="equipmentFilter" class="form-input" onchange="applyFilters()" style="width: 100%;">
                            <option value="">All Equipment</option>
                            <option value="barbell">Barbell</option>
                            <option value="dumbbell">Dumbbell</option>
                            <option value="cable">Cable</option>
                            <option value="machine">Machine</option>
                            <option value="bodyweight">Bodyweight</option>
                            <option value="kettlebell">Kettlebell</option>
                            <option value="resistance band">Resistance Band</option>
                            <option value="smith machine">Smith Machine</option>
                            <option value="ez bar">EZ Bar</option>
                        </select>
                    </div>
                    <div class="filter-dropdown-group" style="flex: 1; min-width: 140px;">
                        <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">Difficulty</label>
                        <select id="difficultyFilter" class="form-input" onchange="applyFilters()" style="width: 100%;">
                            <option value="">All Levels</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="filter-dropdown-group" style="flex: 1; min-width: 140px;">
                        <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">Type</label>
                        <select id="exerciseTypeFilter" class="form-input" onchange="applyFilters()" style="width: 100%;">
                            <option value="">All Types</option>
                            <option value="strength">Strength</option>
                            <option value="cardio">Cardio</option>
                            <option value="flexibility">Flexibility</option>
                            <option value="plyometric">Plyometric</option>
                        </select>
                    </div>
                </div>

                <!-- Results count -->
                <div id="exerciseResultsCount" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Loading exercises...</div>

                <div class="exercise-grid" id="exerciseGrid">
                    <!-- Exercises loaded here -->
                </div>

                <!-- Load More Button -->
                <button id="loadMoreBtn" class="btn-secondary" onclick="loadMoreExercises()" style="width: 100%; margin-top: 16px; display: none;">
                    Load More Exercises
                </button>

                <!-- Multi-select action bar -->
                <div class="exercise-select-bar" id="exerciseSelectBar">
                    <span class="exercise-select-bar-count" id="exerciseSelectCount">0 selected</span>
                    <div class="exercise-select-bar-actions">
                        <button class="exercise-select-bar-btn exercise-select-bar-btn--clear" onclick="clearExerciseSelection()">Clear</button>
                        <button class="exercise-select-bar-btn exercise-select-bar-btn--add" onclick="addSelectedExercises()">Add Selected</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Thumbnail Upload Modal -->
    <div class="modal-overlay" id="thumbnailModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Upload Thumbnail
                </h3>
                <button class="modal-close" onclick="closeThumbnailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="thumbnailExerciseName" style="font-weight: 600; margin-bottom: 16px; color: var(--text-primary);"></div>

                <div id="thumbnailPreviewContainer" style="margin-bottom: 16px; text-align: center; display: none;">
                    <img id="thumbnailPreview" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color);">
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <button class="btn-secondary" onclick="document.getElementById('thumbnailFileInput').click()" style="flex: 1;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Upload Image
                    </button>
                    <input type="file" id="thumbnailFileInput" accept="image/*" onchange="previewThumbnail(event)" style="display: none;">
                </div>

                <div style="text-align: center; color: var(--text-muted); margin-bottom: 16px;">or</div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">Paste Image URL</label>
                    <input type="text" id="thumbnailUrlInput" class="form-input" placeholder="https://example.com/image.jpg" oninput="previewThumbnailUrl(this.value)">
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px;">
                <button class="btn-secondary" onclick="closeThumbnailModal()">Cancel</button>
                <button class="btn-primary" id="saveThumbnailBtn" onclick="saveThumbnail()" disabled>
                    Save Thumbnail
                </button>
            </div>
        </div>
    </div>

    <!-- Exercise Preview Modal -->
    <div class="modal-overlay" id="exercisePreviewModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="previewExerciseName">Exercise Preview</h3>
                <button class="modal-close" onclick="closeExercisePreview()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div id="previewVideoContainer" style="width: 100%; aspect-ratio: 16/9; background: #000; display: flex; align-items: center; justify-content: center; position: relative;">
                    <div id="videoLoader" style="position: absolute; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                        <div style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span style="color: #fff; font-size: 14px;">Loading video...</span>
                    </div>
                    <video id="previewVideo" controls loop muted playsinline preload="auto" style="width: 100%; height: 100%; object-fit: contain;"></video>
                </div>
                <style>
                    @keyframes spin { to { transform: rotate(360deg); } }
                </style>
                <div style="padding: 20px;">
                    <div id="previewExerciseMeta" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;"></div>
                    <button class="btn btn-primary" onclick="addExerciseFromPreview()" style="width: 100%;">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add to Workout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Generate Modal -->
    <div class="modal-overlay" id="aiModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    AI Workout Generator
                </h3>
                <button class="modal-close" onclick="closeAIModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Mode Selection -->
                <div class="ai-mode-selector" id="aiModeSelector">
                    <div class="ai-mode-card" onclick="selectAIMode('single')" id="modeSingle">
                        <div class="ai-mode-icon">
                            <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M3 12h18M12 3v18"/></svg>
                        </div>
                        <div class="ai-mode-title">Single Workout</div>
                        <div class="ai-mode-desc">One session for a specific body part</div>
                    </div>
                    <div class="ai-mode-card" onclick="selectAIMode('program')" id="modeProgram">
                        <div class="ai-mode-icon">
                            <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                        </div>
                        <div class="ai-mode-title">Full Program</div>
                        <div class="ai-mode-desc">Multi-day/week training program</div>
                    </div>
                </div>

                <!-- Shared Fields -->
                <div class="ai-form-section" id="aiSharedFields">
                    <div class="ai-form-group">
                        <label>Client Name (optional)</label>
                        <input type="text" id="aiClientName" placeholder="e.g., John Smith">
                    </div>
                    <div class="ai-form-row">
                        <div class="ai-form-group">
                            <label>Training Goal</label>
                            <select id="aiGoal">
                                <option value="strength">Strength</option>
                                <option value="hypertrophy" selected>Hypertrophy (Muscle Building)</option>
                                <option value="fat_loss">Fat Loss</option>
                                <option value="general_fitness">General Fitness</option>
                            </select>
                        </div>
                        <div class="ai-form-group">
                            <label>Experience Level</label>
                            <select id="aiExperience">
                                <option value="beginner">Beginner</option>
                                <option value="intermediate" selected>Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Single Workout Fields -->
                <div class="ai-form-section" id="aiSingleFields">
                    <div class="ai-form-row">
                        <div class="ai-form-group">
                            <label>Target Muscle Group</label>
                            <select id="aiTargetMuscle">
                                <option value="chest">Chest</option>
                                <option value="back">Back</option>
                                <option value="shoulders">Shoulders</option>
                                <option value="arms">Arms (Biceps & Triceps)</option>
                                <option value="legs">Legs</option>
                                <option value="glutes">Glutes & Hamstrings</option>
                                <option value="core">Core</option>
                                <option value="upper_body">Upper Body</option>
                                <option value="lower_body">Lower Body</option>
                                <option value="full_body">Full Body</option>
                            </select>
                        </div>
                        <div class="ai-form-group">
                            <label>Session Duration</label>
                            <select id="aiSingleSessionDuration">
                                <option value="30">~30 minutes</option>
                                <option value="45">~45 minutes</option>
                                <option value="60" selected>~60 minutes</option>
                                <option value="90">~90 minutes</option>
                            </select>
                        </div>
                    </div>
                    <div class="ai-form-row">
                        <div class="ai-form-group">
                            <label>Training Style</label>
                            <select id="aiSingleTrainingStyle">
                                <option value="straight_sets" selected>Straight Sets</option>
                                <option value="supersets">Supersets</option>
                                <option value="circuits">Circuits</option>
                                <option value="mixed">Mixed</option>
                            </select>
                        </div>
                        <div class="ai-form-group">
                            <label>Exercises Per Workout</label>
                            <select id="aiSingleExerciseCount">
                                <option value="4-5">4-5 (Quick)</option>
                                <option value="5-6" selected>5-6 (Standard)</option>
                                <option value="6-8">6-8 (Comprehensive)</option>
                                <option value="8-10">8-10 (High Volume)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Program Fields -->
                <div class="ai-form-section" id="aiProgramFields">
                    <div class="ai-form-row">
                        <div class="ai-form-group">
                            <label>Days Per Week</label>
                            <select id="aiDaysPerWeek">
                                <option value="2">2 days</option>
                                <option value="3">3 days</option>
                                <option value="4" selected>4 days</option>
                                <option value="5">5 days</option>
                                <option value="6">6 days</option>
                            </select>
                        </div>
                        <div class="ai-form-group">
                            <label>Program Duration</label>
                            <select id="aiDuration">
                                <option value="4" selected>4 weeks</option>
                                <option value="6">6 weeks</option>
                                <option value="8">8 weeks</option>
                            </select>
                        </div>
                    </div>
                    <div class="ai-form-row">
                        <div class="ai-form-group">
                            <label>Workout Split</label>
                            <select id="aiSplit">
                                <option value="auto" selected>Auto (AI decides)</option>
                                <option value="push_pull_legs">Push/Pull/Legs</option>
                                <option value="upper_lower">Upper/Lower</option>
                                <option value="full_body">Full Body</option>
                                <option value="bro_split">Bro Split (1 muscle/day)</option>
                                <option value="push_pull">Push/Pull (2-day)</option>
                            </select>
                        </div>
                        <div class="ai-form-group">
                            <label>Session Duration</label>
                            <select id="aiSessionDuration">
                                <option value="30">~30 minutes</option>
                                <option value="45">~45 minutes</option>
                                <option value="60" selected>~60 minutes</option>
                                <option value="90">~90 minutes</option>
                            </select>
                        </div>
                    </div>
                    <div class="ai-form-row">
                        <div class="ai-form-group">
                            <label>Training Style</label>
                            <select id="aiTrainingStyle">
                                <option value="straight_sets" selected>Straight Sets</option>
                                <option value="supersets">Supersets</option>
                                <option value="circuits">Circuits</option>
                                <option value="mixed">Mixed</option>
                            </select>
                        </div>
                        <div class="ai-form-group">
                            <label>Exercises Per Workout</label>
                            <select id="aiExerciseCount">
                                <option value="4-5">4-5 (Quick)</option>
                                <option value="5-6" selected>5-6 (Standard)</option>
                                <option value="6-8">6-8 (Comprehensive)</option>
                                <option value="8-10">8-10 (High Volume)</option>
                            </select>
                        </div>
                    </div>
                    <div class="ai-form-group">
                        <label>Focus Areas (optional)</label>
                        <div class="equipment-grid">
                            <label class="equipment-item">
                                <input type="checkbox" name="focusArea" value="chest"> Chest
                            </label>
                            <label class="equipment-item">
                                <input type="checkbox" name="focusArea" value="back"> Back
                            </label>
                            <label class="equipment-item">
                                <input type="checkbox" name="focusArea" value="shoulders"> Shoulders
                            </label>
                            <label class="equipment-item">
                                <input type="checkbox" name="focusArea" value="arms"> Arms
                            </label>
                            <label class="equipment-item">
                                <input type="checkbox" name="focusArea" value="legs"> Legs
                            </label>
                            <label class="equipment-item">
                                <input type="checkbox" name="focusArea" value="core"> Core
                            </label>
                            <label class="equipment-item">
                                <input type="checkbox" name="focusArea" value="glutes"> Glutes
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Shared bottom fields (equipment, injuries, preferences) -->
                <div class="ai-form-section" id="aiBottomFields">
                    <div class="ai-form-group">
                        <label>Available Equipment</label>
                        <div class="equipment-grid">
                            <label class="equipment-item">
                                <input type="checkbox" name="equipment" value="barbell" checked> Barbell
                            </label>
                            <label class="equipment-item">
                                <input type="checkbox" name="equipment" value="dumbbell" checked> Dumbbells
                            </label>
                            <label class="equipment-item">
                                <input type="checkbox" name="equipment" value="cable" checked> Cables
                            </label>
                            <label class="equipment-item">
                                <input type="checkbox" name="equipment" value="machine" checked> Machines
                            </label>
                            <label class="equipment-item">
                                <input type="checkbox" name="equipment" value="bodyweight" checked> Bodyweight
                            </label>
                            <label class="equipment-item">
                                <input type="checkbox" name="equipment" value="kettlebell"> Kettlebells
                            </label>
                        </div>
                    </div>
                    <div class="ai-form-group">
                        <label>Injuries or Limitations (optional)</label>
                        <input type="text" id="aiInjuries" placeholder="e.g., Lower back pain, avoid overhead pressing">
                    </div>
                    <div class="ai-form-group">
                        <label>Additional Preferences (optional)</label>
                        <textarea id="aiPreferences" rows="2" placeholder="e.g., Include stretching, prefer compound movements"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="aiModalFooter" style="display:none;">
                <button class="ai-btn ai-btn-cancel" onclick="closeAIModal()">Cancel</button>
                <button class="ai-btn ai-btn-generate" id="aiGenerateBtn" onclick="generateAIWorkout()">
                    Generate Program
                </button>
            </div>
        </div>
    </div>

    <!-- Import Program Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Import Workout Program
                </h3>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body" id="importModalBody">
                <!-- Step 1: Upload/Paste -->
                <div id="importStep1">
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px; line-height: 1.5;">
                        Upload a workout program file or paste the text. The AI will extract exercises, sets, reps, and notes, then match them against your exercise database.
                    </p>

                    <div class="import-drop-zone" id="importDropZone" onclick="document.getElementById('importFileInput').click()">
                        <div class="import-drop-zone-icon">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="opacity: 0.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div class="import-drop-zone-text">
                            <strong>Drop your file here or click to browse</strong>
                            Supports .txt, .csv, and .pdf files
                        </div>
                    </div>
                    <input type="file" id="importFileInput" accept=".txt,.csv,.pdf,.text" style="display:none" onchange="handleImportFile(event)">

                    <div id="importFileInfo" style="display: none;"></div>

                    <div class="import-or-divider">or paste text</div>

                    <textarea class="import-paste-area" id="importPasteArea" placeholder="Paste your workout program text here...&#10;&#10;Example:&#10;Day 1: Chest & Triceps&#10;Bench press - Barbell | 4 sets | 8-10 reps | 90s rest&#10;Bench press inclined - DBs | 3 sets | 10-12 reps | 75s rest&#10;..." rows="8"></textarea>
                </div>

                <!-- Step 2: Processing -->
                <div id="importStep2" style="display: none;">
                    <div class="import-progress">
                        <div class="spinner-large"></div>
                        <p id="importProgressText">Parsing your workout program...</p>
                    </div>
                </div>

                <!-- Step 3: Results -->
                <div id="importStep3" style="display: none;">
                    <div class="import-match-stats">
                        <h4>Match Results</h4>
                        <div class="import-stat-row">
                            <span class="import-stat-label">Total exercises found</span>
                            <span class="import-stat-value" id="importStatTotal">0</span>
                        </div>
                        <div class="import-stat-row">
                            <span class="import-stat-label">Matched to your database</span>
                            <span class="import-stat-value matched" id="importStatMatched">0</span>
                        </div>
                        <div class="import-stat-row">
                            <span class="import-stat-label">Not found in database</span>
                            <span class="import-stat-value unmatched" id="importStatUnmatched">0</span>
                        </div>
                    </div>

                    <div class="import-filter-toggle">
                        <button class="import-filter-btn active" id="importFilterAll" onclick="setImportFilter('all')">
                            Import All
                        </button>
                        <button class="import-filter-btn" id="importFilterMatched" onclick="setImportFilter('matched')">
                            Matched Only
                        </button>
                    </div>

                    <div id="importUnmatchedSection" style="margin-top: 16px;">
                        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 8px;">Unmatched exercises (will be imported without video/thumbnail):</p>
                        <div class="import-unmatched-list" id="importUnmatchedList"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="importModalFooter">
                <button class="ai-btn ai-btn-cancel" onclick="closeImportModal()">Cancel</button>
                <button class="ai-btn ai-btn-generate" id="importBtn" onclick="startImport()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    Import Program
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="confirm-modal-overlay" id="confirmDeleteModal">
        <div class="confirm-modal">
            <div class="confirm-modal-icon">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            </div>
            <div class="confirm-modal-title">Delete Program</div>
            <div class="confirm-modal-message" id="confirmDeleteMessage">Are you sure you want to delete this program? This action cannot be undone.</div>
            <div class="confirm-modal-actions">
                <button class="btn btn-secondary" onclick="closeConfirmDeleteModal()" style="background: var(--bg-tertiary); color: var(--text-primary);">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteProgram()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Confirm Update Clients Modal -->
    <div class="confirm-modal-overlay" id="confirmUpdateClientsModal">
        <div class="confirm-modal" style="max-width: 450px;">
            <div class="confirm-modal-icon" style="background: rgba(16, 185, 129, 0.15); color: var(--success);">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
            </div>
            <div class="confirm-modal-title">Save & Update Clients</div>
            <div class="confirm-modal-message" id="updateClientsMessage">
                This will save the program and update all clients currently using it.
            </div>
            <div class="update-clients-list" id="updateClientsList"></div>
            <div class="confirm-modal-actions">
                <button class="btn btn-secondary" onclick="closeUpdateClientsModal()" style="background: var(--bg-tertiary); color: var(--text-primary);">Cancel</button>
                <button class="btn btn-success" id="confirmUpdateClientsBtn" onclick="confirmSaveAndUpdateClients()">Save & Update</button>
            </div>
        </div>
    </div>

    <!-- Create Custom Exercise Modal -->
    <div class="modal-overlay" id="customExerciseModal">
        <div class="modal custom-exercise-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Create Custom Exercise
                </h3>
                <button class="modal-close" onclick="closeCustomExerciseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="custom-exercise-form-group">
                    <label>Exercise Name <span class="required">*</span></label>
                    <input type="text" class="form-input" id="ceExerciseName" placeholder="e.g., Single Arm Cable Row">
                </div>

                <div class="custom-exercise-form-row">
                    <div class="custom-exercise-form-group">
                        <label>Muscle Group <span class="required">*</span></label>
                        <select class="form-input" id="ceMuscleGroup">
                            <option value="">Select muscle group</option>
                            <option value="chest">Chest</option>
                            <option value="back">Back</option>
                            <option value="shoulders">Shoulders</option>
                            <option value="biceps">Biceps</option>
                            <option value="triceps">Triceps</option>
                            <option value="forearms">Forearms</option>
                            <option value="core">Core</option>
                            <option value="quadriceps">Quadriceps</option>
                            <option value="hamstrings">Hamstrings</option>
                            <option value="glutes">Glutes</option>
                            <option value="calves">Calves</option>
                            <option value="full body">Full Body</option>
                        </select>
                    </div>
                    <div class="custom-exercise-form-group">
                        <label>Equipment</label>
                        <select class="form-input" id="ceEquipment">
                            <option value="">Select equipment</option>
                            <option value="barbell">Barbell</option>
                            <option value="dumbbell">Dumbbell</option>
                            <option value="cable">Cable</option>
                            <option value="machine">Machine</option>
                            <option value="bodyweight">Bodyweight</option>
                            <option value="kettlebell">Kettlebell</option>
                            <option value="resistance band">Resistance Band</option>
                            <option value="smith machine">Smith Machine</option>
                            <option value="ez bar">EZ Bar</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="custom-exercise-form-row">
                    <div class="custom-exercise-form-group">
                        <label>Difficulty</label>
                        <select class="form-input" id="ceDifficulty">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate" selected>Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="custom-exercise-form-group">
                        <label>Exercise Type</label>
                        <select class="form-input" id="ceExerciseType">
                            <option value="strength" selected>Strength</option>
                            <option value="cardio">Cardio</option>
                            <option value="flexibility">Flexibility</option>
                            <option value="plyometric">Plyometric</option>
                        </select>
                    </div>
                </div>

                <div class="custom-exercise-form-group">
                    <label>Instructions (optional)</label>
                    <textarea class="form-textarea" id="ceInstructions" placeholder="Describe how to perform this exercise correctly..." rows="3"></textarea>
                </div>

                <!-- Reference Links Section -->
                <div class="custom-exercise-form-group">
                    <label>Reference Links (optional)</label>
                    <p style="font-size: 12px; color: var(--text-muted); margin: 0 0 8px 0;">Add YouTube, Instagram, or any URL for exercise demos and form guides</p>
                    <div id="ceReferenceLinksContainer">
                        <div id="ceReferenceLinksList"></div>
                        <div class="add-reference-link-row">
                            <input type="text" id="ceReferenceLinkInput" class="form-input" placeholder="Paste a URL (YouTube, Instagram, etc.)" style="font-size: 13px;" onkeydown="if(event.key==='Enter'){event.preventDefault();addCEReferenceLink()}">
                            <button type="button" class="add-link-btn" onclick="addCEReferenceLink()">
                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                Add
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Video Upload Section -->
                <div class="video-upload-section">
                    <h4>
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        Demo Video (optional)
                    </h4>
                    <div class="video-upload-options">
                        <div class="video-upload-option" onclick="triggerCEVideoUpload()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                            </svg>
                            <span>Upload Video</span>
                        </div>
                        <div class="video-upload-option" onclick="startCEVideoRecording()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            <span>Record Video</span>
                        </div>
                    </div>
                    <input type="file" id="ceVideoFileInput" accept="video/*" onchange="handleCEVideoUpload(event)" style="display: none;">

                    <!-- Recording indicator -->
                    <div class="ce-recording-indicator" id="ceRecordingIndicator" style="display: none;">
                        <div class="recording-dot"></div>
                        <span class="recording-timer" id="ceRecordingTimer">0:00</span>
                        <span class="recording-text">Recording... (max 20 sec)</span>
                        <button class="btn btn-secondary" onclick="stopCEVideoRecording()" style="margin-left: auto; padding: 6px 12px; font-size: 12px;">Stop</button>
                    </div>

                    <!-- Video Preview -->
                    <div class="custom-video-preview-container" id="ceVideoPreview">
                        <video id="cePreviewVideo" controls muted playsinline></video>
                        <div class="custom-video-preview-info">
                            <span id="ceVideoSize">Video ready</span>
                            <button class="btn btn-secondary" onclick="removeCEVideo()" style="padding: 6px 12px; font-size: 12px; background: rgba(239, 68, 68, 0.1); color: var(--danger);">
                                Remove Video
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; padding: 16px 24px; border-top: 1px solid var(--border-color);">
                <button class="btn btn-secondary" onclick="closeCustomExerciseModal()" style="background: var(--bg-tertiary); color: var(--text-primary);">Cancel</button>
                <button class="btn btn-primary" id="saveCustomExerciseBtn" onclick="saveCustomExercise()" style="background: var(--brand-gradient); color: white;">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Create Exercise
                </button>
            </div>
        </div>
    </div>

    <!-- My Videos Modal -->
    <div class="modal-overlay" id="myVideosModal">
        <div class="modal my-videos-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    My Videos
                </h3>
                <button class="modal-close" onclick="closeMyVideosModal()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="my-videos-toolbar">
                <input type="text" class="my-videos-search" id="myVideosSearch" placeholder="Search videos..." oninput="filterMyVideos()">
                <span class="my-videos-count" id="myVideosCount"></span>
            </div>
            <div class="my-videos-grid" id="myVideosGrid">
                <div class="my-videos-loading">Loading videos...</div>
            </div>
        </div>
    </div>
    <input type="file" id="replaceVideoInput" accept="video/*" style="display:none">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Mobile sidebar toggle
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // Initialize Supabase (for auth only)
        const SUPABASE_URL = 'https://qewqcjzlfqamqwbccapr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFld3FjanpsZnFhbXF3YmNjYXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2OTg0NzAsImV4cCI6MjA3OTI3NDQ3MH0.mQnMC33O88oLkLLGWD2oG-oaSHGI-NfHmtQCZxnxSLs';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let currentCoachId = null;
        let currentAccessToken = null;
        let currentProgramId = null;
        let programs = [];
        let exercises = [];
        let clients = [];
        let workoutDays = [];
        let selectedClients = new Set();
        let currentDayIndex = null;
        let currentExerciseFilter = 'all';
        let currentSearchTerm = '';
        let currentEquipmentFilter = '';
        let currentDifficultyFilter = '';
        let currentExerciseTypeFilter = '';
        let displayedExerciseCount = 0;
        const EXERCISES_PER_PAGE = 50;
        let currentThumbnailExercise = null;
        let pendingThumbnailData = null;
        let pendingDeleteProgramId = null;

        // Voice recording state
        let mediaRecorder = null;
        let audioChunks = [];
        let currentRecordingExercise = null;

        // Custom exercise state
        let ceVideoRecorder = null;
        let ceVideoChunks = [];
        let ceVideoData = null;
        let ceVideoBlob = null;
        let ceRecordingInterval = null;

        // Helper for authenticated API calls
        async function apiCall(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...(currentAccessToken && { 'Authorization': `Bearer ${currentAccessToken}` }),
                ...options.headers
            };
            const response = await fetch(url, { ...options, headers });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || data.message || 'API request failed');
            }
            return data;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
        });

        // Auth check
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentCoachId = session.user.id;
            currentAccessToken = session.access_token;

            // Initialize gym features (enabled for all coaches)
            await initGymFeatures({ email: session.user.email });

            // Load data
            await Promise.all([
                loadPrograms(),
                loadExercises(),
                loadClients()
            ]);

            // Add initial day
            if (workoutDays.length === 0) {
                addWorkoutDay();
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${type === 'success'
                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'}
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Load programs
        async function loadPrograms() {
            try {
                const result = await apiCall(`/.netlify/functions/workout-programs?coachId=${currentCoachId}`);
                programs = result.programs || [];
                renderProgramList();
            } catch (err) {
                console.error('Error loading programs:', err);
                programs = [];
                renderProgramList();
            }
        }

        // Render program list
        function renderProgramList() {
            const container = document.getElementById('programList');
            if (programs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <div class="empty-title">No programs yet</div>
                        <p>Create your first workout program</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = programs.map(p => `
                <div class="program-item ${p.id === currentProgramId ? 'active' : ''}" onclick="selectProgram(${p.id})">
                    <div class="program-item-content">
                        <div class="program-name">${p.name}${p.is_club_workout ? ' <span style="font-size:10px;background:rgba(139,92,246,0.2);color:#c4b5fd;padding:2px 6px;border-radius:4px;font-weight:600;vertical-align:middle;margin-left:4px;">CLUB</span>' : ''}</div>
                        <div class="program-meta">
                            <span>${p.difficulty || 'Intermediate'}</span>
                            <span></span>
                            <span>${p.days_per_week || 3} days/week</span>
                        </div>
                    </div>
                    <div class="program-item-actions">
                        <button class="program-action-btn duplicate-btn" onclick="event.stopPropagation(); duplicateProgram(${p.id})" title="Duplicate program">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                        <button class="program-action-btn delete-btn" onclick="event.stopPropagation(); openDeleteConfirm(${p.id}, '${p.name.replace(/'/g, "\\'")}')" title="Delete program">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Enrich workout day exercises with fresh video URLs from the database
        async function enrichWorkoutDaysWithVideos(days) {
            if (!days || days.length === 0) return;
            // Collect all unique exercise IDs
            const allIds = new Set();
            days.forEach(day => {
                (day.exercises || []).forEach(ex => {
                    if (ex.id && typeof ex.id === 'number') allIds.add(ex.id);
                });
            });
            if (allIds.size === 0) return;
            try {
                const result = await apiCall(`/.netlify/functions/exercises?ids=${[...allIds].join(',')}`);
                const freshMap = new Map((result.exercises || []).map(ex => [ex.id, ex]));
                days.forEach(day => {
                    (day.exercises || []).forEach((ex, i) => {
                        if (!ex.id || !freshMap.has(ex.id)) return;
                        const fresh = freshMap.get(ex.id);
                        if (fresh.video_url && !ex.video_url) day.exercises[i].video_url = fresh.video_url;
                        if (fresh.animation_url && !ex.animation_url) day.exercises[i].animation_url = fresh.animation_url;
                        if (fresh.thumbnail_url && !ex.thumbnail_url) day.exercises[i].thumbnail_url = fresh.thumbnail_url;
                    });
                });
            } catch (err) {
                console.warn('Could not enrich exercises with video URLs:', err);
            }
        }

        // Select program
        async function selectProgram(programId) {
            currentProgramId = programId;
            const program = programs.find(p => p.id === programId);
            if (program) {
                document.getElementById('programName').value = program.name || '';
                document.getElementById('programType').value = program.program_type || 'strength';
                document.getElementById('programDifficulty').value = program.difficulty || 'intermediate';
                document.getElementById('daysPerWeek').value = program.days_per_week || 3;
                document.getElementById('programDescription').value = program.description || '';

                // Load hero image if exists (from program_data.image_url)
                const heroUrl = program.program_data?.image_url || null;
                setHeroImage(heroUrl);
                pendingHeroImageData = null;

                workoutDays = program.program_data?.days || [];
                // Enrich exercises with fresh video URLs from the database
                await enrichWorkoutDaysWithVideos(workoutDays);
                document.getElementById('isClubWorkout').checked = !!program.is_club_workout;
                renderWorkoutDays();
                // Check superset consistency for loaded program
                workoutDays.forEach((_, d) => checkSupersetWarnings(d));
                enableAssignButton(); // Enable assign button for existing program
            }
            renderProgramList();
            updateSaveButtonMode();
        }

        // Create new program
        function createNewProgram() {
            currentProgramId = null;
            document.getElementById('programName').value = '';
            document.getElementById('programType').value = 'hypertrophy';
            document.getElementById('programDifficulty').value = 'intermediate';
            document.getElementById('daysPerWeek').value = '4';
            document.getElementById('programDescription').value = '';
            document.getElementById('isClubWorkout').checked = false;

            // Reset hero image
            removeHeroImage();

            workoutDays = [];
            selectedClients.clear();
            addWorkoutDay();
            renderProgramList();
            // Disable assign button until program is saved
            const btn = document.getElementById('assignBtn');
            if (btn) btn.disabled = true;
            updateSaveButtonMode();
        }

        // Add workout day
        function addWorkoutDay() {
            const dayNum = workoutDays.length + 1;
            workoutDays.push({
                name: `Day ${dayNum}`,
                exercises: []
            });
            renderWorkoutDays();
        }

        // Render workout days
        function sortExercisesByStructure(exercises) {
            // Enforce warm-up  main workout  stretching order
            const warmups = exercises.filter(ex => ex.isWarmup);
            const stretches = exercises.filter(ex => ex.isStretch);
            const main = exercises.filter(ex => !ex.isWarmup && !ex.isStretch);
            return [...warmups, ...main, ...stretches];
        }

        function renderWorkoutDays() {
            const container = document.getElementById('workoutDays');
            if (workoutDays.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Add your first workout day</p></div>';
                return;
            }

            container.innerHTML = workoutDays.map((day, dayIndex) => `
                <div class="workout-day">
                    <div class="workout-day-header">
                        <input type="text" class="day-name-input" value="${day.name}" onchange="updateDayName(${dayIndex}, this.value)">
                        <div class="workout-day-actions">
                            <button class="icon-btn" onclick="removeWorkoutDay(${dayIndex})" title="Remove day">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="exercise-list">
                        ${day.exercises.map((ex, exIndex) => renderExerciseItem(ex, dayIndex, exIndex)).join('')}
                    </div>
                    <button class="add-exercise-btn" onclick="openExerciseModal(${dayIndex})">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Exercise
                    </button>
                </div>
            `).join('');
        }

        // Render single exercise item
        function renderExerciseItem(exercise, dayIndex, exIndex) {
            const hasVideo = exercise.video_url || exercise.animation_url;
            const videoSrc = exercise.video_url || exercise.animation_url;
            // Use <video> with poster for hover-to-play preview; fall back to <img> if no video
            let thumbHtml;
            if (hasVideo) {
                const posterAttr = exercise.thumbnail_url ? ` poster="${exercise.thumbnail_url}"` : '';
                thumbHtml = `<video class="exercise-thumb-video" src="${videoSrc}" muted loop playsinline preload="metadata"${posterAttr} onmouseenter="this.play().catch(()=>{})" onmouseleave="this.pause();this.currentTime=0" onerror="this.outerHTML='<img class=\\'exercise-thumb\\' src=\\'${exercise.thumbnail_url || '/img/exercise-placeholder.svg'}\\' alt=\\'exercise\\'>'"></video>`;
            } else if (exercise.thumbnail_url) {
                thumbHtml = `<img class="exercise-thumb" src="${exercise.thumbnail_url}" alt="${exercise.name}" onerror="this.src='/img/exercise-placeholder.svg'">`;
            } else {
                thumbHtml = `<img class="exercise-thumb" src="/img/exercise-placeholder.svg" alt="${exercise.name}">`;
            }

            // Build badges for superset, warmup, stretch
            let badges = '';
            if (exercise.isSuperset && exercise.supersetGroup) {
                badges += `<span class="exercise-badge superset-badge">Superset ${exercise.supersetGroup}</span>`;
            }
            if (exercise.isWarmup) {
                badges += `<span class="exercise-badge warmup-badge">Warm-up</span>`;
            }
            if (exercise.isStretch) {
                badges += `<span class="exercise-badge stretch-badge">Stretch</span>`;
            }

            const totalExercises = workoutDays[dayIndex].exercises.length;
            return `
                <div id="exercise-card-${dayIndex}-${exIndex}" class="exercise-item ${exercise.isSuperset ? 'superset-exercise' : ''} ${exercise.isWarmup ? 'warmup-exercise' : ''} ${exercise.isStretch ? 'stretch-exercise' : ''}" draggable="true" data-day="${dayIndex}" data-index="${exIndex}" ondragstart="onExDragStart(event)" ondragover="onExDragOver(event)" ondrop="onExDrop(event)" ondragend="onExDragEnd(event)" ondragleave="onExDragLeave(event)">
                    <div class="exercise-drag">
                        
                        <div class="exercise-move-btns">
                            <button class="exercise-move-btn" onclick="moveExerciseToTop(${dayIndex}, ${exIndex})" title="Move to top" ${exIndex === 0 ? 'disabled' : ''}></button>
                            <button class="exercise-move-btn" onclick="moveExercise(${dayIndex}, ${exIndex}, -1)" title="Move up" ${exIndex === 0 ? 'disabled' : ''}></button>
                            <button class="exercise-move-btn" onclick="moveExercise(${dayIndex}, ${exIndex}, 1)" title="Move down" ${exIndex === totalExercises - 1 ? 'disabled' : ''}></button>
                            <button class="exercise-move-btn" onclick="moveExerciseToBottom(${dayIndex}, ${exIndex})" title="Move to bottom" ${exIndex === totalExercises - 1 ? 'disabled' : ''}></button>
                        </div>
                    </div>
                    <div class="exercise-thumb-wrap">
                        ${thumbHtml}
                        ${hasVideo ? '<div class="video-badge"><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>' : ''}
                    </div>
                    <div class="exercise-info">
                        <div class="exercise-name-row">
                            <div class="exercise-name">${exercise.name}</div>
                            ${badges ? `<div class="exercise-badges">${badges}</div>` : ''}
                        </div>
                        <div class="exercise-config">
                            <div class="config-group">
                                <input type="number" class="config-input" value="${exercise.sets || 3}" onchange="updateExercise(${dayIndex}, ${exIndex}, 'sets', this.value)">
                                <span class="config-label">Sets</span>
                            </div>
                            <div class="config-group">
                                ${exercise.trackingType === 'time'
                                    ? `<input type="number" class="config-input" value="${exercise.duration || 30}" onchange="updateExercise(${dayIndex}, ${exIndex}, 'duration', this.value)" style="width:70px">`
                                    : `<input type="text" class="config-input" value="${exercise.reps || '10'}" onchange="updateExercise(${dayIndex}, ${exIndex}, 'reps', this.value)" style="width:70px">`
                                }
                                <button class="tracking-toggle-btn ${exercise.trackingType === 'time' ? 'time-active' : ''}" onclick="toggleTrackingType(${dayIndex}, ${exIndex})" title="Toggle between reps and time">
                                    <span class="toggle-icon">${exercise.trackingType === 'time' ? '' : '#'}</span>
                                    ${exercise.trackingType === 'time' ? 'Secs' : 'Reps'}
                                </button>
                            </div>
                            <div class="config-group">
                                <input type="number" class="config-input" value="${exercise.restSeconds != null ? exercise.restSeconds : 90}" onchange="updateExercise(${dayIndex}, ${exIndex}, 'restSeconds', this.value)">
                                <span class="config-label">Rest</span>
                            </div>
                        </div>
                        <div class="exercise-notes">
                            <input type="text" class="notes-input" value="${exercise.notes || ''}" placeholder="Add notes (e.g., tempo, form tips...)" onchange="updateExercise(${dayIndex}, ${exIndex}, 'notes', this.value)">
                        </div>
                        <div class="exercise-label-row">
                            <select class="exercise-label-select" onchange="updateExerciseLabel(${dayIndex}, ${exIndex}, this.value)">
                                <option value="none" ${!exercise.isWarmup && !exercise.isStretch && !exercise.isSuperset ? 'selected' : ''}>No Label</option>
                                <option value="warmup" ${exercise.isWarmup ? 'selected' : ''}> Warm-up</option>
                                <option value="stretch" ${exercise.isStretch ? 'selected' : ''}> Stretch</option>
                                <option value="supersetA" ${exercise.isSuperset && exercise.supersetGroup === 'A' ? 'selected' : ''}> Superset A</option>
                                <option value="supersetB" ${exercise.isSuperset && exercise.supersetGroup === 'B' ? 'selected' : ''}> Superset B</option>
                                <option value="supersetC" ${exercise.isSuperset && exercise.supersetGroup === 'C' ? 'selected' : ''}> Superset C</option>
                            </select>
                            <span class="label-hint">Label</span>
                        </div>
                        <div class="voice-note-container" id="voiceNote-${dayIndex}-${exIndex}">
                            ${exercise.voiceNoteUrl ? `
                                <div class="voice-note-player">
                                    <audio controls src="${exercise.voiceNoteUrl}" style="height: 28px; width: 100%;"></audio>
                                    <button class="voice-note-delete" onclick="deleteVoiceNote(${dayIndex}, ${exIndex})" title="Delete voice note"></button>
                                </div>
                            ` : `
                                <button class="voice-note-btn" id="voiceBtn-${dayIndex}-${exIndex}" onclick="toggleVoiceRecording(${dayIndex}, ${exIndex})" title="Record voice note">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                                    </svg>
                                </button>
                                <span style="font-size: 11px; color: var(--text-muted);">Add voice tip for client</span>
                            `}
                        </div>
                        <div class="custom-video-container" id="customVideo-${dayIndex}-${exIndex}">
                            ${exercise.customVideoUrl ? `
                                <div class="custom-video-preview">
                                    <video src="${exercise.customVideoUrl}" muted></video>
                                    <div class="video-info">
                                        <span class="video-label">Custom Demo</span><br>
                                        Your video will show to client
                                    </div>
                                    <button class="custom-video-delete" onclick="deleteCustomVideo(${dayIndex}, ${exIndex})" title="Delete video"></button>
                                </div>
                            ` : `
                                <button class="custom-video-btn" id="videoRecordBtn-${dayIndex}-${exIndex}" onclick="startVideoRecording(${dayIndex}, ${exIndex})" title="Record custom demo">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                    Record Demo
                                </button>
                                <span style="font-size: 11px; color: var(--text-muted);">or</span>
                                <label class="custom-video-btn" style="margin: 0;">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                    </svg>
                                    Upload
                                    <input type="file" class="video-upload-input" accept="video/*" onchange="handleVideoUpload(event, ${dayIndex}, ${exIndex})">
                                </label>
                            `}
                        </div>
                        <div class="reference-links-container" id="refLinks-${dayIndex}-${exIndex}">
                            <div class="reference-links-header">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                                Reference Links
                            </div>
                            ${(exercise.reference_links && exercise.reference_links.length > 0) ? `
                                <div class="reference-links-list">
                                    ${exercise.reference_links.map((link, linkIdx) => `
                                        <div class="reference-link-item">
                                            <span class="link-icon ${detectLinkType(link.url)}">${getLinkTypeIcon(detectLinkType(link.url))}</span>
                                            <span class="link-title" title="${escapeHtml(link.url)}">${escapeHtml(link.title || link.url)}</span>
                                            <button class="link-delete" onclick="removeReferenceLink(${dayIndex}, ${exIndex}, ${linkIdx})" title="Remove link"></button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="add-reference-link-row">
                                <input type="text" id="refLinkInput-${dayIndex}-${exIndex}" placeholder="Paste YouTube, Instagram, or any URL..." onkeydown="if(event.key==='Enter'){addReferenceLink(${dayIndex}, ${exIndex})}">
                                <button class="add-link-btn" onclick="addReferenceLink(${dayIndex}, ${exIndex})">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                    Add
                                </button>
                            </div>
                        </div>
                        ${exercise.recommendedSwaps && exercise.recommendedSwaps.length > 0 ? `
                            <div class="exercise-has-swaps">
                                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                                ${exercise.recommendedSwaps.length} recommended swap${exercise.recommendedSwaps.length > 1 ? 's' : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="exercise-actions">
                        <button class="icon-btn recommended-swaps-btn" onclick="openRecommendedSwapsModal(${dayIndex}, ${exIndex})" title="Manage recommended swaps">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                            ${exercise.recommendedSwaps && exercise.recommendedSwaps.length > 0 ? `<span class="swap-count">${exercise.recommendedSwaps.length}</span>` : ''}
                        </button>
                        <button class="icon-btn swap-btn" onclick="openSwapModal(${dayIndex}, ${exIndex})" title="Swap exercise">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="removeExercise(${dayIndex}, ${exIndex})" title="Remove exercise">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // Update functions
        function updateDayName(dayIndex, name) {
            workoutDays[dayIndex].name = name;
        }

        function updateExercise(dayIndex, exIndex, field, value) {
            if (field === 'sets' || field === 'restSeconds' || field === 'duration') {
                workoutDays[dayIndex].exercises[exIndex][field] = parseInt(value) || 0;
            } else {
                workoutDays[dayIndex].exercises[exIndex][field] = value;
            }
            // Re-check superset warnings when sets change
            if (field === 'sets') {
                checkSupersetWarnings(dayIndex);
            }
        }

        // --- Reference Links helpers ---
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function detectLinkType(url) {
            if (!url) return 'generic';
            const lower = url.toLowerCase();
            if (lower.includes('youtube.com') || lower.includes('youtu.be')) return 'youtube';
            if (lower.includes('instagram.com')) return 'instagram';
            return 'generic';
        }

        function getLinkTypeIcon(type) {
            if (type === 'youtube') return '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>';
            if (type === 'instagram') return '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>';
            return '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>';
        }

        function getTitleFromUrl(url) {
            const type = detectLinkType(url);
            if (type === 'youtube') return 'YouTube Video';
            if (type === 'instagram') return 'Instagram Post';
            try {
                return new URL(url).hostname.replace('www.', '');
            } catch {
                return url;
            }
        }

        function addReferenceLink(dayIndex, exIndex) {
            const input = document.getElementById(`refLinkInput-${dayIndex}-${exIndex}`);
            const url = (input.value || '').trim();
            if (!url) return;

            // Basic URL validation
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showToast('Please enter a valid URL starting with http:// or https://', 'error');
                return;
            }

            const exercise = workoutDays[dayIndex].exercises[exIndex];
            if (!exercise.reference_links) exercise.reference_links = [];

            exercise.reference_links.push({
                url: url,
                title: getTitleFromUrl(url),
                type: detectLinkType(url)
            });

            input.value = '';
            renderWorkoutDays();
            showToast('Reference link added');
        }

        function removeReferenceLink(dayIndex, exIndex, linkIndex) {
            const exercise = workoutDays[dayIndex].exercises[exIndex];
            if (exercise.reference_links) {
                exercise.reference_links.splice(linkIndex, 1);
                renderWorkoutDays();
            }
        }

        function updateExerciseLabel(dayIndex, exIndex, labelValue) {
            const exercise = workoutDays[dayIndex].exercises[exIndex];
            // Reset all label flags
            exercise.isWarmup = false;
            exercise.isStretch = false;
            exercise.isSuperset = false;
            exercise.supersetGroup = null;
            exercise.phase = 'main';

            if (labelValue === 'warmup') {
                exercise.isWarmup = true;
                exercise.phase = 'warmup';
            } else if (labelValue === 'stretch') {
                exercise.isStretch = true;
                exercise.phase = 'cooldown';
            } else if (labelValue.startsWith('superset')) {
                exercise.isSuperset = true;
                exercise.supersetGroup = labelValue.replace('superset', '');
                exercise.phase = 'main';
            }
            renderWorkoutDays();
            // Show warning if superset sets don't match
            checkSupersetWarnings(dayIndex);
        }

        // Check superset groups for mismatched set counts and show inline warnings
        function checkSupersetWarnings(dayIndex) {
            const exercises = workoutDays[dayIndex].exercises;
            const groups = {};
            exercises.forEach((ex, idx) => {
                if (ex.isSuperset && ex.supersetGroup) {
                    if (!groups[ex.supersetGroup]) groups[ex.supersetGroup] = [];
                    groups[ex.supersetGroup].push({ idx, sets: ex.sets || 3, name: ex.name });
                }
            });

            // Clear existing warnings for this day
            document.querySelectorAll(`.superset-warning[data-day="${dayIndex}"]`).forEach(el => el.remove());

            Object.entries(groups).forEach(([groupKey, members]) => {
                if (members.length < 2) return;
                const setCounts = members.map(m => m.sets);
                const allMatch = setCounts.every(s => s === setCounts[0]);
                if (allMatch) return;

                // Show warning on each mismatched exercise
                members.forEach(member => {
                    const container = document.querySelector(`#exercise-card-${dayIndex}-${member.idx} .exercise-config`);
                    if (!container) return;
                    const existing = container.querySelector('.superset-warning');
                    if (existing) existing.remove();
                    const warning = document.createElement('div');
                    warning.className = 'superset-warning';
                    warning.setAttribute('data-day', dayIndex);
                    warning.innerHTML = ` Superset ${groupKey}: sets don't match (${setCounts.join(' vs ')})`;
                    container.after(warning);
                });
            });
        }

        // Validate all superset groups across all days  returns true if valid
        function validateSupersets() {
            for (let d = 0; d < workoutDays.length; d++) {
                const exercises = workoutDays[d].exercises;
                const groups = {};
                exercises.forEach(ex => {
                    if (ex.isSuperset && ex.supersetGroup) {
                        if (!groups[ex.supersetGroup]) groups[ex.supersetGroup] = [];
                        groups[ex.supersetGroup].push(ex);
                    }
                });
                for (const [groupKey, members] of Object.entries(groups)) {
                    if (members.length < 2) continue;
                    const setCounts = members.map(m => m.sets || 3);
                    if (new Set(setCounts).size > 1) {
                        const dayName = workoutDays[d].name || `Day ${d + 1}`;
                        const names = members.map(m => m.name).join(', ');
                        showToast(`Superset ${groupKey} in "${dayName}" has mismatched sets (${setCounts.join(' vs ')}). All exercises in a superset must have the same number of sets. (${names})`, 'error');
                        return false;
                    }
                }
            }
            return true;
        }

        function toggleTrackingType(dayIndex, exIndex) {
            const exercise = workoutDays[dayIndex].exercises[exIndex];
            if (exercise.trackingType === 'time') {
                exercise.trackingType = 'reps';
            } else {
                exercise.trackingType = 'time';
                if (!exercise.duration) {
                    exercise.duration = 30;
                }
            }
            renderWorkoutDays();
        }

        function removeWorkoutDay(dayIndex) {
            if (confirm('Remove this workout day?')) {
                workoutDays.splice(dayIndex, 1);
                renderWorkoutDays();
            }
        }

        function removeExercise(dayIndex, exIndex) {
            workoutDays[dayIndex].exercises.splice(exIndex, 1);
            renderWorkoutDays();
        }

        // ============ DRAG & DROP REORDER ============
        let dragSrcDayIndex = null;
        let dragSrcExIndex = null;

        function onExDragStart(e) {
            const item = e.target.closest('.exercise-item');
            dragSrcDayIndex = parseInt(item.dataset.day);
            dragSrcExIndex = parseInt(item.dataset.index);
            item.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', ''); // Required for Firefox
        }

        function onExDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const item = e.target.closest('.exercise-item');
            if (item) {
                // Remove drag-over from all items first
                document.querySelectorAll('.exercise-item.drag-over').forEach(el => el.classList.remove('drag-over'));
                item.classList.add('drag-over');
            }
        }

        function onExDragLeave(e) {
            const item = e.target.closest('.exercise-item');
            if (item) item.classList.remove('drag-over');
        }

        function onExDrop(e) {
            e.preventDefault();
            const item = e.target.closest('.exercise-item');
            if (!item) return;

            const destDayIndex = parseInt(item.dataset.day);
            const destExIndex = parseInt(item.dataset.index);

            // Only allow reorder within the same day
            if (dragSrcDayIndex !== destDayIndex || dragSrcExIndex === destExIndex) {
                onExDragEnd(e);
                return;
            }

            const exercises = workoutDays[destDayIndex].exercises;
            const [moved] = exercises.splice(dragSrcExIndex, 1);
            exercises.splice(destExIndex, 0, moved);

            dragSrcDayIndex = null;
            dragSrcExIndex = null;
            renderWorkoutDays();
        }

        function onExDragEnd(e) {
            document.querySelectorAll('.exercise-item.dragging').forEach(el => el.classList.remove('dragging'));
            document.querySelectorAll('.exercise-item.drag-over').forEach(el => el.classList.remove('drag-over'));
            dragSrcDayIndex = null;
            dragSrcExIndex = null;
        }

        function moveExercise(dayIndex, exIndex, direction) {
            const exercises = workoutDays[dayIndex].exercises;
            const newIndex = exIndex + direction;
            if (newIndex < 0 || newIndex >= exercises.length) return;

            const [moved] = exercises.splice(exIndex, 1);
            exercises.splice(newIndex, 0, moved);
            renderWorkoutDays();
        }

        function moveExerciseToTop(dayIndex, exIndex) {
            if (exIndex === 0) return;
            const exercises = workoutDays[dayIndex].exercises;
            const [moved] = exercises.splice(exIndex, 1);
            exercises.unshift(moved);
            renderWorkoutDays();
        }

        function moveExerciseToBottom(dayIndex, exIndex) {
            const exercises = workoutDays[dayIndex].exercises;
            if (exIndex === exercises.length - 1) return;
            const [moved] = exercises.splice(exIndex, 1);
            exercises.push(moved);
            renderWorkoutDays();
        }

        // ============ SWAP EXERCISE FUNCTIONS ============
        let swapDayIndex = null;
        let swapExIndex = null;
        let swapExerciseCache = [];

        function openSwapModal(dayIndex, exIndex) {
            swapDayIndex = dayIndex;
            swapExIndex = exIndex;

            const currentExercise = workoutDays[dayIndex].exercises[exIndex];
            document.getElementById('swapCurrentName').textContent = currentExercise.name;
            document.getElementById('swapSearchInput').value = '';

            // Filter exercises by same muscle group for browse section
            const muscleGroup = currentExercise.muscle_group || currentExercise.muscleGroup || '';

            swapExerciseCache = exercises.filter(ex => {
                const exMuscle = ex.muscle_group || '';
                const isMatch = exMuscle.toLowerCase() === muscleGroup.toLowerCase() ||
                    (ex.secondary_muscles && ex.secondary_muscles.some(m =>
                        m.toLowerCase() === muscleGroup.toLowerCase()));
                return isMatch && ex.id !== currentExercise.id;
            });

            renderSwapExerciseList(swapExerciseCache);

            // Show loading state for AI suggestions
            const aiContainer = document.getElementById('swapAISuggestionsList');
            aiContainer.innerHTML = `
                <div style="padding: 16px; text-align: center; color: var(--text-muted); font-size: 13px;">
                    <div style="margin: 0 auto 8px; width: 24px; height: 24px; border: 2px solid var(--border-color); border-top-color: #10b981; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                    Finding best alternatives...
                </div>`;

            document.getElementById('swapModal').classList.add('active');

            // Fetch AI-powered swap suggestions
            fetchSwapAISuggestions(currentExercise, dayIndex);
        }

        async function fetchSwapAISuggestions(currentExercise, dayIndex) {
            const aiContainer = document.getElementById('swapAISuggestionsList');

            try {
                // Gather other exercises in this workout day to exclude them
                const workoutExercises = (workoutDays[dayIndex]?.exercises || []).map(ex => ({
                    id: ex.id,
                    name: ex.name
                }));

                const response = await fetch('/.netlify/functions/ai-swap-exercise', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAccessToken}`
                    },
                    body: JSON.stringify({
                        exercise: {
                            id: currentExercise.id,
                            name: currentExercise.name,
                            muscle_group: currentExercise.muscle_group || currentExercise.muscleGroup || '',
                            equipment: currentExercise.equipment || '',
                            secondary_muscles: currentExercise.secondary_muscles || [],
                            difficulty: currentExercise.difficulty || '',
                            exercise_type: currentExercise.exercise_type || ''
                        },
                        workoutExercises: workoutExercises,
                        coachId: currentCoachId
                    })
                });

                const data = await response.json();

                // Check if modal is still open (user may have closed it)
                if (swapDayIndex === null) return;

                if (data.suggestions && data.suggestions.length > 0) {
                    aiContainer.innerHTML = data.suggestions.map(ex => {
                        const hasVideo = ex.video_url || ex.animation_url;
                        const videoSrc = ex.video_url || ex.animation_url;
                        const thumbHtml = hasVideo
                            ? `<video class="swap-exercise-thumb" src="${videoSrc}" muted loop playsinline preload="metadata" onmouseenter="this.play().catch(()=>{})" onmouseleave="this.pause()"></video>`
                            : `<img class="swap-exercise-thumb" src="${ex.thumbnail_url || '/img/exercise-placeholder.svg'}" alt="${ex.name}" onerror="this.src='/img/exercise-placeholder.svg'">`;
                        return `
                            <div class="swap-exercise-item" onclick="selectSwapExercise('${ex.id}')" style="border-left: 3px solid #10b981;">
                                ${thumbHtml}
                                <div class="swap-exercise-info">
                                    <div class="swap-exercise-name">${ex.name}</div>
                                    <div class="swap-exercise-meta">${ex.muscle_group || ''} ${ex.equipment ? ' ' + ex.equipment : ''}</div>
                                    ${ex.ai_reason ? `<div style="font-size: 11px; color: #10b981; margin-top: 2px;">${ex.ai_reason}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    aiContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 13px;">No AI suggestions available</div>';
                }
            } catch (err) {
                console.error('Swap AI suggestions error:', err);
                aiContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 13px;">Could not load suggestions</div>';
            }
        }

        function closeSwapModal() {
            document.getElementById('swapModal').classList.remove('active');
            swapDayIndex = null;
            swapExIndex = null;
        }

        function filterSwapExercises(query) {
            const filtered = query
                ? swapExerciseCache.filter(ex =>
                    ex.name.toLowerCase().includes(query.toLowerCase()))
                : swapExerciseCache;
            renderSwapExerciseList(filtered);
        }

        function renderSwapExerciseList(exerciseList) {
            const container = document.getElementById('swapExerciseList');

            if (exerciseList.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No alternative exercises found</div>';
                return;
            }

            container.innerHTML = exerciseList.slice(0, 50).map(ex => {
                const hasVideo = ex.video_url || ex.animation_url;
                const videoSrc = ex.video_url || ex.animation_url;
                const thumbHtml = hasVideo
                    ? `<video class="swap-exercise-thumb" src="${videoSrc}" muted loop playsinline preload="metadata" onmouseenter="this.play().catch(()=>{})" onmouseleave="this.pause()"></video>`
                    : `<img class="swap-exercise-thumb" src="${ex.thumbnail_url || '/img/exercise-placeholder.svg'}" alt="${ex.name}" onerror="this.src='/img/exercise-placeholder.svg'">`;
                return `
                    <div class="swap-exercise-item" onclick="selectSwapExercise('${ex.id}')">
                        ${thumbHtml}
                        <div class="swap-exercise-info">
                            <div class="swap-exercise-name">${ex.name}</div>
                            <div class="swap-exercise-meta">${ex.muscle_group || ''} ${ex.equipment ? ' ' + ex.equipment : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectSwapExercise(exerciseId) {
            const newExercise = exercises.find(ex => String(ex.id) === String(exerciseId));
            if (!newExercise || swapDayIndex === null || swapExIndex === null) return;

            // Keep the existing sets/reps/rest config
            const oldExercise = workoutDays[swapDayIndex].exercises[swapExIndex];

            workoutDays[swapDayIndex].exercises[swapExIndex] = {
                id: newExercise.id,
                name: newExercise.name,
                video_url: newExercise.video_url,
                animation_url: newExercise.animation_url,
                thumbnail_url: newExercise.thumbnail_url || newExercise.video_url,
                muscle_group: newExercise.muscle_group,
                equipment: newExercise.equipment,
                instructions: newExercise.instructions,
                sets: oldExercise.sets || 3,
                reps: oldExercise.reps || '8-12',
                restSeconds: oldExercise.restSeconds || 90,
                notes: oldExercise.notes || ''
            };

            renderWorkoutDays();
            closeSwapModal();
            showToast(`Swapped to ${newExercise.name}`, 'success');
        }

        // Load exercises
        async function loadExercises() {
            try {
                // Fetch exercises in batches to handle large exercise libraries
                const batchSize = 1000;
                let allExercises = [];
                let offset = 0;
                let hasMore = true;

                while (hasMore) {
                    const result = await apiCall(`/.netlify/functions/exercises?coachId=${currentCoachId}&limit=${batchSize}&offset=${offset}`);
                    const batch = result.exercises || [];
                    allExercises = allExercises.concat(batch);

                    // Check if there are more exercises to fetch
                    if (batch.length < batchSize || allExercises.length >= result.total) {
                        hasMore = false;
                    } else {
                        offset += batchSize;
                    }
                }

                exercises = allExercises;
                console.log(`Loaded ${exercises.length} exercises total`);
            } catch (err) {
                console.error('Error loading exercises:', err);
                // Fallback exercises
                exercises = [
                    { id: 1, name: 'Bench Press', muscle_group: 'chest', equipment: 'barbell' },
                    { id: 2, name: 'Squat', muscle_group: 'legs', equipment: 'barbell' },
                    { id: 3, name: 'Deadlift', muscle_group: 'back', equipment: 'barbell' },
                    { id: 4, name: 'Overhead Press', muscle_group: 'shoulders', equipment: 'barbell' },
                    { id: 5, name: 'Barbell Row', muscle_group: 'back', equipment: 'barbell' },
                    { id: 6, name: 'Pull-ups', muscle_group: 'back', equipment: 'bodyweight' },
                    { id: 7, name: 'Dips', muscle_group: 'chest', equipment: 'bodyweight' },
                    { id: 8, name: 'Lunges', muscle_group: 'legs', equipment: 'bodyweight' },
                ];
            }
        }

        // Exercise modal
        // Multi-select state for exercise browser
        const selectedExercises = new Map(); // key: id or name, value: exercise object

        function toggleExerciseSelection(exercise) {
            const key = exercise.id || exercise.name;
            if (selectedExercises.has(key)) {
                selectedExercises.delete(key);
            } else {
                selectedExercises.set(key, exercise);
            }
            // Update card visual state without full re-render
            const cards = document.querySelectorAll('.exercise-card');
            cards.forEach(card => {
                const cardId = card.dataset.exerciseId || card.dataset.exerciseName;
                const cardName = card.dataset.exerciseName;
                if (cardId === String(key) || cardName === String(key)) {
                    card.classList.toggle('selected', selectedExercises.has(key));
                }
            });
            updateSelectBar();
        }

        function updateSelectBar() {
            const bar = document.getElementById('exerciseSelectBar');
            const count = document.getElementById('exerciseSelectCount');
            const n = selectedExercises.size;
            if (n > 0) {
                bar.classList.add('visible');
                count.textContent = `${n} exercise${n !== 1 ? 's' : ''} selected`;
            } else {
                bar.classList.remove('visible');
            }
        }

        function clearExerciseSelection() {
            selectedExercises.clear();
            document.querySelectorAll('.exercise-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            updateSelectBar();
        }

        function addSelectedExercises() {
            if (selectedExercises.size === 0) return;
            const exercises = Array.from(selectedExercises.values());
            exercises.forEach(exercise => {
                const { isWarmup, isStretch } = detectExerciseType(exercise);
                workoutDays[currentDayIndex].exercises.push({
                    id: exercise.id,
                    name: exercise.name,
                    video_url: exercise.video_url,
                    animation_url: exercise.animation_url,
                    thumbnail_url: exercise.thumbnail_url || exercise.video_url,
                    muscle_group: exercise.muscle_group,
                    equipment: exercise.equipment,
                    instructions: exercise.instructions,
                    sets: isWarmup ? 1 : isStretch ? 1 : 3,
                    reps: isWarmup ? '10-15' : isStretch ? '30s hold' : '8-12',
                    restSeconds: isWarmup ? 30 : isStretch ? 0 : 90,
                    isWarmup,
                    isStretch,
                    reference_links: exercise.reference_links || []
                });
            });
            renderWorkoutDays();
            const count = exercises.length;
            showToast(`Added ${count} exercise${count !== 1 ? 's' : ''}`);
            clearExerciseSelection();
            closeExerciseModal();
        }

        function openExerciseModal(dayIndex) {
            currentDayIndex = dayIndex;
            clearExerciseSelection();
            resetExerciseFilters();
            document.getElementById('exerciseModal').classList.add('active');
            renderExerciseGrid();
        }

        function closeExerciseModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        function filterExercises(muscle, btn) {
            currentExerciseFilter = muscle;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            displayedExerciseCount = 0;
            renderExerciseGrid();
        }

        function searchExercises(term) {
            currentSearchTerm = term.toLowerCase();
            displayedExerciseCount = 0;
            renderExerciseGrid();
        }

        function applyFilters() {
            currentEquipmentFilter = document.getElementById('equipmentFilter').value;
            currentDifficultyFilter = document.getElementById('difficultyFilter').value;
            currentExerciseTypeFilter = document.getElementById('exerciseTypeFilter').value;
            displayedExerciseCount = 0;
            renderExerciseGrid();
        }

        // Keywords for category-based filtering
        // NOTE: Many exercises have "stretch" in their name and match automatically.
        // Only add keywords here for stretch exercises that do NOT contain "stretch" in their name.
        const STRETCH_KEYWORDS = [
            'stretch', 'yoga', 'cool down', 'cooldown', 'cool-down',
            'flexibility', 'static hold', 'foam roll', 'foam roller',
            'fist against chin', '90 to 90', '90/90',
            'child pose', 'childs pose', "child's pose",
            'pigeon glute', 'double pigeon',
            'downward dog toe to heel', 'downward dog with fingers',
            'cobra stretch', 'cobra side ab', 'cobra yoga pose', 'spinal twist',
            'cat cow', 'cat stretch',
            'scorpion', 'pretzel',
            'butterfly yoga', 'crescent moon pose',
            'dead hang',
            'side lying floor',
            'knee to chest', 'knee hug',
            'ceiling look', 'neck tilt', 'neck turn', 'neck rotation',
            'middle back rotation',
            'easy pose',
            'back slaps wrap',
            'cable lat prayer', 'armless prayer',
            'alternating leg downward dog',
            'all fours quad'
        ];

        const WARMUP_KEYWORDS = [
            'warm up', 'warmup', 'warm-up',
            'dynamic stretch', 'activation', 'mobility', 'light cardio',
            // Cardio machines
            'elliptical', 'treadmill', 'rowing machine', 'stationary bike',
            'exercise bike', 'assault airbike', 'air bike', 'recumbent',
            'stair climb', 'spin bike',
            // Jump rope
            'jump rope', 'skipping rope',
            // Classic warm-up movements
            'jumping jack', 'high knee', 'butt kick', 'butt kicks',
            'mountain climber', 'bear crawl', 'inchworm',
            'burpee', 'half burpee',
            'arm circle', 'arm swing', 'leg swing', 'hip circle', 'torso twist',
            'march', 'air punches march',
            'jogging', 'jog in place', 'running in place',
            // Jumps / plyo
            'box jump', 'squat jump', 'tuck jump', 'broad jump',
            'star jump', 'seal jack', 'jump squat', 'plyo',
            'lateral box jump', 'kneeling squat jump',
            // Agility
            'agility ladder', 'lateral shuffle', 'carioca',
            'a skip', 'b skip', 'power skip',
            // Battle ropes
            'battle rope',
            // Rebounder
            'rebounder',
            // Sprint drills
            'sprinter lunge', 'downward dog sprint',
            // Step ups (bodyweight)
            'step up'
        ];

        function isStretchExercise(e) {
            const nameLower = (e.name || '').toLowerCase();
            const typeLower = (e.exercise_type || '').toLowerCase();
            const catLower = (e.category || '').toLowerCase();
            return typeLower === 'flexibility' ||
                catLower === 'stretching' || catLower === 'flexibility' || catLower === 'stretch' ||
                STRETCH_KEYWORDS.some(kw => nameLower.includes(kw));
        }

        function isWarmupExercise(e) {
            const nameLower = (e.name || '').toLowerCase();
            return WARMUP_KEYWORDS.some(kw => nameLower.includes(kw));
        }

        function getFilteredExercises() {
            let filtered = exercises;

            // Filter by muscle group (including secondary muscles) or category
            if (currentExerciseFilter !== 'all') {
                // Handle special category filters
                if (currentExerciseFilter === 'stretches') {
                    filtered = filtered.filter(e => isStretchExercise(e));
                } else if (currentExerciseFilter === 'warmup') {
                    filtered = filtered.filter(e => isWarmupExercise(e));
                } else {
                filtered = filtered.filter(e => {
                    const primaryMatch = e.muscle_group?.toLowerCase() === currentExerciseFilter ||
                        e.primary_muscles?.toLowerCase().includes(currentExerciseFilter);

                    // Check secondary muscles (can be array or string)
                    let secondaryMatch = false;
                    if (e.secondary_muscles) {
                        if (Array.isArray(e.secondary_muscles)) {
                            secondaryMatch = e.secondary_muscles.some(m =>
                                m.toLowerCase().includes(currentExerciseFilter)
                            );
                        } else if (typeof e.secondary_muscles === 'string') {
                            secondaryMatch = e.secondary_muscles.toLowerCase().includes(currentExerciseFilter);
                        }
                    }

                    // Special handling for "arms" to include biceps and triceps
                    if (currentExerciseFilter === 'arms') {
                        const armMuscles = ['biceps', 'triceps', 'forearms', 'arms'];
                        const armPrimaryMatch = armMuscles.some(m =>
                            e.muscle_group?.toLowerCase().includes(m) ||
                            e.primary_muscles?.toLowerCase().includes(m)
                        );
                        const armSecondaryMatch = e.secondary_muscles && (
                            Array.isArray(e.secondary_muscles)
                                ? e.secondary_muscles.some(sm => armMuscles.some(m => sm.toLowerCase().includes(m)))
                                : armMuscles.some(m => e.secondary_muscles.toLowerCase().includes(m))
                        );
                        return armPrimaryMatch || armSecondaryMatch;
                    }

                    // Special handling for broad categories that include specific muscle groups
                    const categoryMap = {
                        'legs': ['legs', 'quads', 'quadriceps', 'hamstrings', 'hamstring', 'glutes', 'calves', 'calf', 'hip flexors', 'adductors', 'abductors', 'thighs'],
                        'back': ['back', 'lats', 'latissimus', 'rhomboids', 'traps', 'trapezius', 'rear delt', 'erector', 'lower back', 'upper back'],
                        'shoulders': ['shoulders', 'delts', 'deltoids', 'front delt', 'side delt', 'rear delt', 'lateral delt', 'rotator cuff'],
                        'chest': ['chest', 'pecs', 'pectorals', 'upper chest', 'lower chest'],
                        'core': ['core', 'abs', 'abdominals', 'obliques', 'lower back', 'transverse']
                    };
                    const expandedMuscles = categoryMap[currentExerciseFilter];
                    if (expandedMuscles) {
                        const catPrimaryMatch = expandedMuscles.some(m =>
                            e.muscle_group?.toLowerCase().includes(m) ||
                            e.primary_muscles?.toLowerCase().includes(m) ||
                            e.name?.toLowerCase().includes(m)
                        );
                        const catSecondaryMatch = e.secondary_muscles && (
                            Array.isArray(e.secondary_muscles)
                                ? e.secondary_muscles.some(sm => expandedMuscles.some(m => sm.toLowerCase().includes(m)))
                                : expandedMuscles.some(m => e.secondary_muscles.toLowerCase().includes(m))
                        );
                        return catPrimaryMatch || catSecondaryMatch;
                    }

                    return primaryMatch || secondaryMatch;
                });
                }
            }

            // Filter by equipment
            if (currentEquipmentFilter) {
                filtered = filtered.filter(e =>
                    e.equipment?.toLowerCase() === currentEquipmentFilter.toLowerCase()
                );
            }

            // Filter by difficulty
            if (currentDifficultyFilter) {
                filtered = filtered.filter(e =>
                    e.difficulty?.toLowerCase() === currentDifficultyFilter.toLowerCase()
                );
            }

            // Filter by exercise type
            if (currentExerciseTypeFilter) {
                filtered = filtered.filter(e =>
                    e.exercise_type?.toLowerCase() === currentExerciseTypeFilter.toLowerCase()
                );
            }

            // Search filter (includes name, muscle_group, and secondary_muscles)
            if (currentSearchTerm) {
                filtered = filtered.filter(e => {
                    const nameMatch = e.name.toLowerCase().includes(currentSearchTerm);
                    const muscleMatch = e.muscle_group?.toLowerCase().includes(currentSearchTerm);
                    const primaryMatch = e.primary_muscles?.toLowerCase().includes(currentSearchTerm);

                    // Check secondary muscles for search
                    let secondaryMatch = false;
                    if (e.secondary_muscles) {
                        if (Array.isArray(e.secondary_muscles)) {
                            secondaryMatch = e.secondary_muscles.some(m =>
                                m.toLowerCase().includes(currentSearchTerm)
                            );
                        } else if (typeof e.secondary_muscles === 'string') {
                            secondaryMatch = e.secondary_muscles.toLowerCase().includes(currentSearchTerm);
                        }
                    }

                    return nameMatch || muscleMatch || primaryMatch || secondaryMatch;
                });
            }

            return filtered;
        }

        function renderExerciseGrid(append = false) {
            const container = document.getElementById('exerciseGrid');
            const countDisplay = document.getElementById('exerciseResultsCount');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            const filtered = getFilteredExercises();
            const totalCount = filtered.length;

            // Update results count
            countDisplay.textContent = `${totalCount} exercise${totalCount !== 1 ? 's' : ''} found`;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No exercises found</p><span style="color: var(--text-secondary); font-size: 13px;">Try adjusting your filters or search term</span></div>';
                loadMoreBtn.style.display = 'none';
                return;
            }

            // Determine how many to show
            const endIndex = append ? displayedExerciseCount + EXERCISES_PER_PAGE : EXERCISES_PER_PAGE;
            const exercisesToShow = filtered.slice(0, endIndex);
            displayedExerciseCount = exercisesToShow.length;

            // Show/hide load more button
            if (displayedExerciseCount < totalCount) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.textContent = `Load More (${displayedExerciseCount} of ${totalCount})`;
            } else {
                loadMoreBtn.style.display = 'none';
            }

            const exerciseHTML = exercisesToShow.map(ex => {
                const hasVideo = ex.video_url || ex.animation_url;
                // Determine what to display: prefer thumbnail_url (image), then try video sources
                const thumbnailImg = ex.thumbnail_url;
                const videoSrc = ex.animation_url || ex.video_url;
                const hasThumbnail = thumbnailImg && !thumbnailImg.includes('placeholder');
                const secondaryMuscles = ex.secondary_muscles
                    ? (Array.isArray(ex.secondary_muscles) ? ex.secondary_muscles.slice(0, 2).join(', ') : ex.secondary_muscles)
                    : '';

                // Determine media element - use img for images, video for mp4s
                let mediaElement;
                if (thumbnailImg) {
                    // Has a proper thumbnail image
                    mediaElement = `<img class="exercise-card-thumb" src="${thumbnailImg}" alt="${ex.name}" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='block';" loading="lazy"><video class="exercise-card-thumb" src="${videoSrc || ''}" muted playsinline preload="metadata" style="display:none;"></video>`;
                } else if (videoSrc) {
                    // No thumbnail, but has video - show video first frame
                    mediaElement = `<video class="exercise-card-thumb" src="${videoSrc}" muted playsinline preload="metadata"></video>`;
                } else {
                    // No media at all
                    mediaElement = `<img class="exercise-card-thumb" src="/img/exercise-placeholder.svg" alt="${ex.name}">`;
                }

                const isSelected = selectedExercises.has(ex.id || ex.name);
                return `
                <div class="exercise-card${isSelected ? ' selected' : ''}" data-exercise-id="${ex.id || ''}" data-exercise-name="${ex.name}" onclick='toggleExerciseSelection(${JSON.stringify(ex).replace(/'/g, "\\'")})'>
                    <div class="exercise-card-check">
                        <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 6l3 3 5-5"/></svg>
                    </div>
                    <div class="exercise-thumb-container" onclick="event.stopPropagation(); openExercisePreview(${JSON.stringify(ex).replace(/'/g, "\\'")})">
                        ${mediaElement}
                        ${hasVideo ? '<div class="video-indicator"></div>' : ''}
                        <button class="edit-thumb-btn ${hasThumbnail ? '' : 'no-thumb'}" onclick="event.stopPropagation(); openThumbnailModal(${JSON.stringify(ex).replace(/"/g, '&quot;')})" title="${hasThumbnail ? 'Change thumbnail' : 'Add thumbnail'}">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="exercise-card-name">
                        ${ex.name}
                        ${ex.is_custom ? '<span class="custom-exercise-badge">Custom</span>' : ''}
                    </div>
                    <div class="exercise-card-meta">${ex.muscle_group || ex.primary_muscles || 'General'}${ex.equipment ? '  ' + ex.equipment : ''}</div>
                    ${secondaryMuscles ? `<div class="exercise-card-secondary">Also: ${secondaryMuscles}</div>` : ''}
                </div>
            `}).join('');

            if (append) {
                container.innerHTML += exerciseHTML;
            } else {
                container.innerHTML = exerciseHTML;
            }
        }

        function loadMoreExercises() {
            renderExerciseGrid(true);
        }

        function resetExerciseFilters() {
            currentExerciseFilter = 'all';
            currentSearchTerm = '';
            currentEquipmentFilter = '';
            currentDifficultyFilter = '';
            currentExerciseTypeFilter = '';
            displayedExerciseCount = 0;

            // Reset UI
            document.querySelectorAll('.filter-chip').forEach((c, i) => {
                c.classList.toggle('active', i === 0);
            });
            document.getElementById('exerciseSearchInput').value = '';
            document.getElementById('equipmentFilter').value = '';
            document.getElementById('difficultyFilter').value = '';
            document.getElementById('exerciseTypeFilter').value = '';
        }

        // ============ THUMBNAIL UPLOAD FUNCTIONS ============

        function openThumbnailModal(exercise) {
            currentThumbnailExercise = exercise;
            pendingThumbnailData = null;
            document.getElementById('thumbnailExerciseName').textContent = exercise.name;
            document.getElementById('thumbnailPreviewContainer').style.display = 'none';
            document.getElementById('thumbnailPreview').src = '';
            document.getElementById('thumbnailUrlInput').value = '';
            document.getElementById('thumbnailFileInput').value = '';
            document.getElementById('saveThumbnailBtn').disabled = true;
            document.getElementById('thumbnailModal').classList.add('active');
        }

        function closeThumbnailModal() {
            document.getElementById('thumbnailModal').classList.remove('active');
            currentThumbnailExercise = null;
            pendingThumbnailData = null;
        }

        function previewThumbnail(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('thumbnailPreview').src = e.target.result;
                document.getElementById('thumbnailPreviewContainer').style.display = 'block';
                document.getElementById('thumbnailUrlInput').value = '';
                document.getElementById('saveThumbnailBtn').disabled = false;
                pendingThumbnailData = {
                    type: 'file',
                    base64: e.target.result,
                    name: file.name
                };
            };
            reader.readAsDataURL(file);
        }

        function previewThumbnailUrl(url) {
            if (!url.trim()) {
                document.getElementById('thumbnailPreviewContainer').style.display = 'none';
                document.getElementById('saveThumbnailBtn').disabled = true;
                pendingThumbnailData = null;
                return;
            }

            // Show preview
            document.getElementById('thumbnailPreview').src = url;
            document.getElementById('thumbnailPreviewContainer').style.display = 'block';
            document.getElementById('thumbnailFileInput').value = '';
            document.getElementById('saveThumbnailBtn').disabled = false;
            pendingThumbnailData = {
                type: 'url',
                url: url
            };
        }

        async function saveThumbnail() {
            if (!currentThumbnailExercise || !pendingThumbnailData) return;

            const saveBtn = document.getElementById('saveThumbnailBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                let payload = { exerciseId: currentThumbnailExercise.id };

                if (pendingThumbnailData.type === 'url') {
                    payload.thumbnailUrl = pendingThumbnailData.url;
                } else if (pendingThumbnailData.type === 'file') {
                    payload.imageBase64 = pendingThumbnailData.base64;
                    payload.imageName = pendingThumbnailData.name;
                }

                const result = await apiCall('/.netlify/functions/upload-exercise-thumbnail', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (result.success) {
                    // Update the exercise in our local array
                    const exerciseIndex = exercises.findIndex(e => e.id === currentThumbnailExercise.id);
                    if (exerciseIndex !== -1) {
                        exercises[exerciseIndex].thumbnail_url = result.exercise.thumbnail_url;
                    }

                    showToast('Thumbnail updated successfully!');
                    closeThumbnailModal();
                    renderExerciseGrid(); // Refresh the grid to show new thumbnail
                } else {
                    throw new Error(result.error || 'Failed to save thumbnail');
                }
            } catch (err) {
                console.error('Error saving thumbnail:', err);
                showToast('Error saving thumbnail: ' + err.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Thumbnail';
            }
        }

        // ============ HERO IMAGE UPLOAD ============

        let pendingHeroImageData = null;

        function previewHeroImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('heroPreviewImg').src = e.target.result;
                document.getElementById('heroImagePreview').style.display = 'block';
                document.getElementById('heroUploadArea').style.display = 'none';

                pendingHeroImageData = {
                    type: 'file',
                    base64: e.target.result,
                    name: file.name
                };

                // Store temporary marker in hidden field
                document.getElementById('heroImageUrl').value = '__pending_upload__';
            };
            reader.readAsDataURL(file);
        }

        function showHeroUrlInput() {
            document.getElementById('heroUrlInputContainer').style.display = 'block';
        }

        function applyHeroUrl() {
            const url = document.getElementById('heroUrlInput').value.trim();
            if (!url) {
                showToast('Please enter a valid URL', 'error');
                return;
            }

            document.getElementById('heroPreviewImg').src = url;
            document.getElementById('heroImagePreview').style.display = 'block';
            document.getElementById('heroUploadArea').style.display = 'none';
            document.getElementById('heroImageUrl').value = url;
            pendingHeroImageData = { type: 'url', url: url };
        }

        function removeHeroImage() {
            document.getElementById('heroPreviewImg').src = '';
            document.getElementById('heroImagePreview').style.display = 'none';
            document.getElementById('heroUploadArea').style.display = 'flex';
            document.getElementById('heroFileInput').value = '';
            document.getElementById('heroUrlInput').value = '';
            document.getElementById('heroUrlInputContainer').style.display = 'none';
            document.getElementById('heroImageUrl').value = '';
            pendingHeroImageData = null;
        }

        function setHeroImage(url) {
            if (url) {
                document.getElementById('heroPreviewImg').src = url;
                document.getElementById('heroImagePreview').style.display = 'block';
                document.getElementById('heroUploadArea').style.display = 'none';
                document.getElementById('heroImageUrl').value = url;
            } else {
                removeHeroImage();
            }
        }

        async function uploadHeroImageIfNeeded() {
            // If there's a pending file upload, upload it now
            if (pendingHeroImageData && pendingHeroImageData.type === 'file' && currentProgramId) {
                try {
                    const result = await apiCall('/.netlify/functions/upload-program-hero', {
                        method: 'POST',
                        body: JSON.stringify({
                            programId: currentProgramId,
                            imageBase64: pendingHeroImageData.base64,
                            imageName: pendingHeroImageData.name
                        })
                    });

                    if (result.success) {
                        document.getElementById('heroImageUrl').value = result.program.hero_image_url;
                        pendingHeroImageData = null;
                        return result.program.hero_image_url;
                    }
                } catch (err) {
                    console.error('Error uploading hero image:', err);
                    showToast('Warning: Hero image upload failed', 'error');
                }
            }

            return document.getElementById('heroImageUrl').value || null;
        }

        // AI Cover Image Generation
        async function generateAICoverImage() {
            const btn = document.getElementById('aiCoverBtn');
            const originalHtml = btn.innerHTML;

            // Get program info for context
            const programName = document.getElementById('programName').value || 'Workout Program';
            const programType = document.getElementById('programType').value || 'general_fitness';
            const daysPerWeek = document.getElementById('daysPerWeek').value || '4';

            // Build a descriptive prompt based on program type
            const typeDescriptions = {
                'strength': 'strength training with heavy weights, power, determination',
                'hypertrophy': 'muscle building, bodybuilding, fitness model physique',
                'fat_loss': 'high intensity workout, cardio, athletic training',
                'general_fitness': 'general fitness, healthy lifestyle, wellness'
            };
            const typeDesc = typeDescriptions[programType] || typeDescriptions['general_fitness'];

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Generating...';

            try {
                const response = await fetch('/.netlify/functions/workout-cover-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        programName,
                        programType,
                        daysPerWeek,
                        description: typeDesc
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to generate cover image');
                }

                // Apply the generated image
                setHeroImage(result.imageUrl);
                showToast('Cover image generated!', 'success');

            } catch (error) {
                console.error('AI cover generation error:', error);
                showToast(error.message || 'Failed to generate cover image', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        // ============ EXERCISE PREVIEW FUNCTIONS ============
        let currentPreviewExercise = null;

        function openExercisePreview(exercise) {
            currentPreviewExercise = exercise;
            document.getElementById('previewExerciseName').textContent = exercise.name;

            const videoUrl = exercise.video_url || exercise.animation_url;
            const video = document.getElementById('previewVideo');
            const loader = document.getElementById('videoLoader');

            // Show loader, hide video initially
            loader.style.display = 'flex';
            video.style.opacity = '0';

            if (videoUrl) {
                // Clear old event listeners by cloning
                const newVideo = video.cloneNode(true);
                video.parentNode.replaceChild(newVideo, video);

                // Set up event handlers for loading states
                newVideo.oncanplay = () => {
                    loader.style.display = 'none';
                    newVideo.style.opacity = '1';
                    newVideo.play().catch(() => {});
                };
                newVideo.onwaiting = () => {
                    loader.style.display = 'flex';
                };
                newVideo.onplaying = () => {
                    loader.style.display = 'none';
                };
                newVideo.onerror = () => {
                    loader.innerHTML = '<span style="color: #f66;">Failed to load video</span>';
                };

                newVideo.src = videoUrl;
                newVideo.load();
            } else {
                loader.innerHTML = '<span style="color: #888;">No video available</span>';
            }

            const meta = [];
            if (exercise.muscle_group) meta.push(exercise.muscle_group);
            if (exercise.equipment) meta.push(exercise.equipment);
            if (exercise.difficulty) meta.push(exercise.difficulty);
            document.getElementById('previewExerciseMeta').textContent = meta.join('  ') || 'No details available';

            document.getElementById('exercisePreviewModal').classList.add('active');
        }

        function closeExercisePreview() {
            document.getElementById('exercisePreviewModal').classList.remove('active');
            const video = document.getElementById('previewVideo');
            video.pause();
            video.removeAttribute('src');
            video.load(); // Reset the video element
            // Reset loader for next time
            document.getElementById('videoLoader').innerHTML = `
                <div style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span style="color: #fff; font-size: 14px;">Loading video...</span>
            `;
            currentPreviewExercise = null;
        }

        function addExerciseFromPreview() {
            if (currentPreviewExercise) {
                addExerciseToDay(currentPreviewExercise);
                closeExercisePreview();
            }
        }

        function detectExerciseType(exercise) {
            const name = (exercise.name || '').toLowerCase();
            const group = (exercise.muscle_group || '').toLowerCase();
            const isWarmup = group === 'cardio' || group === 'warmup' || group === 'warm-up' || group === 'mobility' ||
                /warm.?up|activation|dynamic stretch|jumping jack|high knee|butt kick|arm circle|leg swing|hip circle|jog/i.test(name);
            const isStretch = /stretch|yoga|cool.?down|flexibility|cat.?cow|spinal twist|foam roll/i.test(name) ||
                group === 'stretching' || group === 'flexibility';
            return { isWarmup: isWarmup && !isStretch, isStretch };
        }

        function addExerciseToDay(exercise) {
            const { isWarmup, isStretch } = detectExerciseType(exercise);
            const newExercise = {
                id: exercise.id,
                name: exercise.name,
                video_url: exercise.video_url,
                animation_url: exercise.animation_url,
                thumbnail_url: exercise.thumbnail_url || exercise.video_url,
                muscle_group: exercise.muscle_group,
                equipment: exercise.equipment,
                instructions: exercise.instructions,
                sets: isWarmup ? 1 : isStretch ? 1 : 3,
                reps: isWarmup ? '10-15' : isStretch ? '30s hold' : '8-12',
                restSeconds: isWarmup ? 30 : isStretch ? 0 : 90,
                isWarmup,
                isStretch,
                reference_links: exercise.reference_links || []
            };

            const dayExercises = workoutDays[currentDayIndex].exercises;

            if (isWarmup) {
                // Insert warmups at the top (after any existing warmups)
                const lastWarmupIndex = dayExercises.reduce((last, ex, i) => ex.isWarmup ? i : last, -1);
                dayExercises.splice(lastWarmupIndex + 1, 0, newExercise);
            } else if (isStretch) {
                // Stretches go at the very end (already default behavior)
                dayExercises.push(newExercise);
            } else {
                // Regular exercises: insert before any stretches at the end
                const firstStretchIndex = dayExercises.findIndex(ex => ex.isStretch);
                if (firstStretchIndex !== -1) {
                    dayExercises.splice(firstStretchIndex, 0, newExercise);
                } else {
                    dayExercises.push(newExercise);
                }
            }

            renderWorkoutDays();
            closeExerciseModal();
            showToast(`Added ${exercise.name}`);
        }

        // Load clients
        async function loadClients() {
            try {
                const result = await apiCall(`/.netlify/functions/get-clients?coachId=${currentCoachId}`);
                clients = result.clients || [];
                console.log('Loaded clients:', clients.length);
            } catch (err) {
                console.error('Error loading clients:', err);
                clients = [];
            }
        }

        // ============ ASSIGNMENT MODAL FLOW ============

        // Open client selection modal (Step 1)
        function openAssignModal() {
            if (!currentProgramId) {
                showToast('Please save the program first', 'error');
                return;
            }
            selectedClients.clear();
            renderClientSelectList();
            document.getElementById('clientSelectModal').style.display = 'flex';
            setupClientSelectListener();
        }

        function closeClientSelectModal() {
            document.getElementById('clientSelectModal').style.display = 'none';
        }

        // Render client list in modal
        function renderClientSelectList(filter = '') {
            const container = document.getElementById('clientSelectList');
            const filtered = filter
                ? clients.filter(c => (c.client_name || '').toLowerCase().includes(filter.toLowerCase()))
                : clients;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-secondary);">No clients found</div>';
                return;
            }

            container.innerHTML = filtered.map(client => `
                <div class="client-select-item ${selectedClients.has(String(client.id)) ? 'selected' : ''}" data-client-id="${client.id}">
                    <div class="client-select-avatar">${(client.client_name || 'C')[0].toUpperCase()}</div>
                    <div class="client-select-info">
                        <div class="client-select-name">${client.client_name || 'Unnamed'}</div>
                        <div class="client-select-email">${client.email || 'No email'}</div>
                    </div>
                    <div class="client-select-check">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                </div>
            `).join('');
        }

        // Filter clients in modal
        function filterClients(query) {
            renderClientSelectList(query);
        }

        // Setup click listener for client selection in modal
        let clientSelectListenerAttached = false;
        function setupClientSelectListener() {
            if (clientSelectListenerAttached) return;
            const container = document.getElementById('clientSelectList');
            if (!container) return;

            container.addEventListener('click', function(e) {
                const item = e.target.closest('.client-select-item');
                if (item && item.dataset.clientId) {
                    const clientId = item.dataset.clientId;
                    if (selectedClients.has(clientId)) {
                        selectedClients.delete(clientId);
                    } else {
                        selectedClients.add(clientId);
                    }
                    renderClientSelectList(document.getElementById('clientSearchInput').value);
                    updateContinueButton();
                }
            });
            clientSelectListenerAttached = true;
        }

        function updateContinueButton() {
            const btn = document.getElementById('continueBtn');
            btn.disabled = selectedClients.size === 0;
        }

        // Proceed to schedule modal (Step 2)
        function proceedToSchedule() {
            if (selectedClients.size === 0) {
                showToast('Please select at least one client', 'error');
                return;
            }
            closeClientSelectModal();

            // Show selected clients
            const display = document.getElementById('selectedClientsDisplay');
            display.innerHTML = Array.from(selectedClients).map(clientId => {
                const client = clients.find(c => String(c.id) === String(clientId));
                return `
                    <div class="selected-client-chip">
                        <div class="chip-avatar">${(client?.client_name || 'C')[0].toUpperCase()}</div>
                        <span>${client?.client_name || 'Client'}</span>
                    </div>
                `;
            }).join('');

            // Set default start date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;

            document.getElementById('scheduleModal').style.display = 'flex';
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'none';
        }

        function backToClientSelect() {
            closeScheduleModal();
            openAssignModal();
        }

        // Final assignment
        async function assignWorkout() {
            const startDate = document.getElementById('startDate').value;
            const weeksAmount = parseInt(document.getElementById('weeksAmount').value) || 4;

            // Get selected days
            const selectedDays = [];
            document.querySelectorAll('.days-selector input:checked').forEach(cb => {
                selectedDays.push(cb.value);
            });

            if (!startDate) {
                showToast('Please select a start date', 'error');
                return;
            }

            if (selectedDays.length === 0) {
                showToast('Please select at least one day', 'error');
                return;
            }

            const programName = document.getElementById('programName').value.trim();
            const heroImageUrl = document.getElementById('heroImageUrl').value;

            try {
                showToast('Assigning workout...', 'success');

                for (const clientId of selectedClients) {
                    await apiCall('/.netlify/functions/workout-assignments', {
                        method: 'POST',
                        body: JSON.stringify({
                            clientId,
                            coachId: currentCoachId,
                            programId: currentProgramId,
                            name: programName,
                            workoutData: {
                                days: workoutDays,
                                image_url: heroImageUrl || null
                            },
                            schedule: {
                                startDate,
                                weeksAmount,
                                selectedDays
                            }
                        })
                    });
                }

                closeScheduleModal();
                showToast(`Workout assigned to ${selectedClients.size} client(s)!`, 'success');
                selectedClients.clear();

            } catch (err) {
                console.error('Assignment error:', err);
                showToast('Failed to assign workout: ' + err.message, 'error');
            }
        }

        // Enable assign button after program is saved
        function enableAssignButton() {
            const btn = document.getElementById('assignBtn');
            if (btn) btn.disabled = false;
        }

        // Save program
        async function saveProgram() {
            const name = document.getElementById('programName').value.trim();
            if (!name) {
                showToast('Please enter a program name', 'error');
                return;
            }

            if (workoutDays.length === 0) {
                showToast('Please add at least one workout day', 'error');
                return;
            }

            // Validate superset set counts match
            if (!validateSupersets()) return;

            try {
                let result;

                // Get hero image URL (direct URL, not pending upload)
                let heroImageUrl = document.getElementById('heroImageUrl').value;

                if (currentProgramId) {
                    // For existing programs, upload pending hero image FIRST so we can include the URL in the save
                    if (heroImageUrl === '__pending_upload__') {
                        const uploadedUrl = await uploadHeroImageIfNeeded();
                        heroImageUrl = uploadedUrl || null;
                    }

                    // Update existing program
                    result = await apiCall('/.netlify/functions/workout-programs', {
                        method: 'PUT',
                        body: JSON.stringify({
                            programId: currentProgramId,
                            name,
                            description: document.getElementById('programDescription').value,
                            programType: document.getElementById('programType').value,
                            difficulty: document.getElementById('programDifficulty').value,
                            daysPerWeek: parseInt(document.getElementById('daysPerWeek').value),
                            programData: { days: workoutDays },
                            heroImageUrl: heroImageUrl || undefined,
                            isClubWorkout: document.getElementById('isClubWorkout').checked
                        })
                    });

                } else {
                    // Create new program (need program ID first for image upload)
                    if (heroImageUrl === '__pending_upload__') {
                        heroImageUrl = null;
                    }
                    result = await apiCall('/.netlify/functions/workout-programs', {
                        method: 'POST',
                        body: JSON.stringify({
                            coachId: currentCoachId,
                            name,
                            description: document.getElementById('programDescription').value,
                            programType: document.getElementById('programType').value,
                            difficulty: document.getElementById('programDifficulty').value,
                            daysPerWeek: parseInt(document.getElementById('daysPerWeek').value),
                            programData: { days: workoutDays },
                            heroImageUrl: heroImageUrl || undefined,
                            isClubWorkout: document.getElementById('isClubWorkout').checked
                        })
                    });
                    currentProgramId = result.program?.id;

                    // Upload pending hero image if any (now we have program ID)
                    await uploadHeroImageIfNeeded();
                }

                showToast('Program saved! You can now assign it to clients.');
                enableAssignButton();
                await loadPrograms();
                updateSaveButtonMode();
            } catch (err) {
                console.error('Error saving program:', err);
                showToast('Error saving program: ' + err.message, 'error');
            }
        }

        // Toggle between simple save and dropdown save based on whether we're editing an existing program
        async function updateSaveButtonMode() {
            const simpleBtn = document.getElementById('simpleSaveBtn');
            const dropdown = document.getElementById('saveDropdown');
            const badge = document.getElementById('activeClientCount');

            if (currentProgramId) {
                // Editing existing program - show dropdown
                simpleBtn.style.display = 'none';
                dropdown.style.display = 'inline-flex';

                // Fetch active client count for this program
                try {
                    const result = await apiCall(`/.netlify/functions/workout-assignments?coachId=${currentCoachId}`);
                    const activeForProgram = (result.assignments || []).filter(
                        a => a.program_id === currentProgramId && a.is_active
                    );
                    if (activeForProgram.length > 0) {
                        badge.textContent = activeForProgram.length;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                } catch (e) {
                    badge.style.display = 'none';
                }
            } else {
                // New program - show simple save
                simpleBtn.style.display = 'inline-flex';
                dropdown.style.display = 'none';
            }
        }

        // Save dropdown toggle
        function toggleSaveDropdown(e) {
            e.stopPropagation();
            const menu = document.getElementById('saveDropdownMenu');
            menu.classList.toggle('active');
        }

        function closeSaveDropdown() {
            const menu = document.getElementById('saveDropdownMenu');
            menu.classList.remove('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('saveDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                closeSaveDropdown();
            }
        });

        // Save program AND update all active client assignments
        async function saveProgramAndUpdateClients() {
            if (!currentProgramId) {
                showToast('Please save the program first before updating clients.', 'error');
                return;
            }

            // Fetch affected clients to show in confirmation
            try {
                const result = await apiCall(`/.netlify/functions/workout-assignments?coachId=${currentCoachId}`);
                const activeForProgram = (result.assignments || []).filter(
                    a => a.program_id === currentProgramId && a.is_active
                );

                if (activeForProgram.length === 0) {
                    // No clients using this program, just do a normal save
                    showToast('No clients are currently assigned this program. Saving program only.');
                    await saveProgram();
                    return;
                }

                // Show confirmation modal with client list
                const listEl = document.getElementById('updateClientsList');
                const msgEl = document.getElementById('updateClientsMessage');
                msgEl.textContent = `This will save the program and update ${activeForProgram.length} client${activeForProgram.length > 1 ? 's' : ''} currently using it. Their schedules and workout history will be preserved.`;

                listEl.innerHTML = activeForProgram.map(a => {
                    const clientName = a.clients?.client_name || a.clients?.email || 'Unknown Client';
                    return `<div class="update-clients-list-item">${clientName}</div>`;
                }).join('');

                document.getElementById('confirmUpdateClientsModal').classList.add('active');
            } catch (err) {
                console.error('Error checking assignments:', err);
                showToast('Error checking client assignments: ' + err.message, 'error');
            }
        }

        function closeUpdateClientsModal() {
            document.getElementById('confirmUpdateClientsModal').classList.remove('active');
        }

        async function confirmSaveAndUpdateClients() {
            closeUpdateClientsModal();

            const name = document.getElementById('programName').value.trim();
            if (!name) {
                showToast('Please enter a program name', 'error');
                return;
            }

            if (workoutDays.length === 0) {
                showToast('Please add at least one workout day', 'error');
                return;
            }

            try {
                // Upload pending hero image FIRST so it's included in save + propagation
                let heroImageUrl = document.getElementById('heroImageUrl').value;
                if (heroImageUrl === '__pending_upload__') {
                    const uploadedUrl = await uploadHeroImageIfNeeded();
                    heroImageUrl = uploadedUrl || null;
                }

                const result = await apiCall('/.netlify/functions/workout-programs', {
                    method: 'PUT',
                    body: JSON.stringify({
                        programId: currentProgramId,
                        name,
                        description: document.getElementById('programDescription').value,
                        programType: document.getElementById('programType').value,
                        difficulty: document.getElementById('programDifficulty').value,
                        daysPerWeek: parseInt(document.getElementById('daysPerWeek').value),
                        programData: { days: workoutDays },
                        heroImageUrl: heroImageUrl || undefined,
                        isClubWorkout: document.getElementById('isClubWorkout').checked,
                        updateClientAssignments: true
                    })
                });

                const count = result.updatedAssignments || 0;
                const total = result.totalActiveAssignments || 0;
                if (count > 0) {
                    showToast(`Program saved and ${count} client${count !== 1 ? 's' : ''} updated!`);
                } else if (total === 0) {
                    showToast('Program saved. No active client assignments found for this program.');
                } else {
                    showToast(`Program saved but failed to update ${total} client assignment(s). Check console for details.`, 'error');
                }
                enableAssignButton();
                await loadPrograms();
                updateSaveButtonMode();
            } catch (err) {
                console.error('Error saving and updating clients:', err);
                showToast('Error: ' + err.message, 'error');
            }
        }

        // Search and filter programs (advanced filtering)
        function filterPrograms() {
            const searchTerm = document.getElementById('programSearchInput')?.value?.toLowerCase() || '';
            const typeFilter = document.getElementById('programTypeFilter')?.value || '';
            const difficultyFilter = document.getElementById('programDifficultyFilter')?.value || '';
            const daysFilter = document.getElementById('programDaysFilter')?.value || '';

            const filtered = programs.filter(p => {
                // Search by name
                if (searchTerm && !p.name.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                // Filter by type
                if (typeFilter && p.program_type !== typeFilter) {
                    return false;
                }
                // Filter by difficulty
                if (difficultyFilter && p.difficulty !== difficultyFilter) {
                    return false;
                }
                // Filter by days per week
                if (daysFilter && String(p.days_per_week) !== daysFilter) {
                    return false;
                }
                return true;
            });

            const container = document.getElementById('programList');
            if (filtered.length === 0) {
                const hasFilters = searchTerm || typeFilter || difficultyFilter || daysFilter;
                container.innerHTML = `<div class="empty-state"><p>${hasFilters ? 'No programs match your filters' : 'No programs found'}</p></div>`;
                return;
            }

            container.innerHTML = filtered.map(p => `
                <div class="program-item ${p.id === currentProgramId ? 'active' : ''}" onclick="selectProgram(${p.id})">
                    <div class="program-item-content">
                        <div class="program-name">${p.name}</div>
                        <div class="program-meta">
                            <span>${p.difficulty || 'Intermediate'}</span>
                            <span></span>
                            <span>${p.days_per_week || 3} days/week</span>
                        </div>
                    </div>
                    <div class="program-item-actions">
                        <button class="program-action-btn duplicate-btn" onclick="event.stopPropagation(); duplicateProgram(${p.id})" title="Duplicate program">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                        <button class="program-action-btn delete-btn" onclick="event.stopPropagation(); openDeleteConfirm(${p.id}, '${p.name.replace(/'/g, "\\'")}')" title="Delete program">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Legacy function - redirect to new filter function
        function searchPrograms(term) {
            if (document.getElementById('programSearchInput')) {
                document.getElementById('programSearchInput').value = term || '';
            }
            filterPrograms();
        }

        // ============ DELETE PROGRAM FUNCTIONS ============
        function openDeleteConfirm(programId, programName) {
            pendingDeleteProgramId = programId;
            document.getElementById('confirmDeleteMessage').textContent =
                `Are you sure you want to delete "${programName}"? This action cannot be undone.`;
            document.getElementById('confirmDeleteModal').classList.add('active');
        }

        function closeConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').classList.remove('active');
            pendingDeleteProgramId = null;
        }

        async function confirmDeleteProgram() {
            if (!pendingDeleteProgramId) return;

            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.textContent = 'Deleting...';

            try {
                const response = await fetch(`/.netlify/functions/workout-programs?programId=${pendingDeleteProgramId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to delete program');
                }

                showToast('Program deleted successfully', 'success');

                // If we deleted the currently selected program, clear selection
                if (currentProgramId === pendingDeleteProgramId) {
                    currentProgramId = null;
                    createNewProgram();
                }

                // Reload programs
                await loadPrograms();
            } catch (err) {
                console.error('Error deleting program:', err);
                showToast('Error deleting program: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Delete';
                closeConfirmDeleteModal();
            }
        }

        // ============ DUPLICATE PROGRAM FUNCTIONS ============
        async function duplicateProgram(programId) {
            const program = programs.find(p => p.id === programId);
            if (!program) {
                showToast('Program not found', 'error');
                return;
            }

            try {
                showToast('Duplicating program...', 'success');

                const response = await fetch('/.netlify/functions/workout-programs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        coachId: currentCoachId,
                        name: `${program.name} (Copy)`,
                        description: program.description,
                        programType: program.program_type,
                        difficulty: program.difficulty,
                        durationWeeks: program.duration_weeks,
                        daysPerWeek: program.days_per_week,
                        programData: program.program_data,
                        isTemplate: program.is_template,
                        isPublished: false,
                        heroImageUrl: program.program_data?.image_url
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to duplicate program');
                }

                showToast('Program duplicated successfully', 'success');

                // Reload programs and select the new one
                await loadPrograms();
                if (result.program) {
                    selectProgram(result.program.id);
                }
            } catch (err) {
                console.error('Error duplicating program:', err);
                showToast('Error duplicating program: ' + err.message, 'error');
            }
        }

        // ============ VOICE NOTE RECORDING FUNCTIONS ============
        async function toggleVoiceRecording(dayIndex, exIndex) {
            const btn = document.getElementById(`voiceBtn-${dayIndex}-${exIndex}`);

            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // Stop recording
                mediaRecorder.stop();
                btn.classList.remove('recording');
                return;
            }

            // Start recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                currentRecordingExercise = { dayIndex, exIndex };

                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());

                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await uploadVoiceNote(dayIndex, exIndex, audioBlob);
                    mediaRecorder = null;
                    audioChunks = [];
                    currentRecordingExercise = null;
                };

                mediaRecorder.start();
                btn.classList.add('recording');
                showToast('Recording... Click again to stop', 'success');

            } catch (err) {
                console.error('Error accessing microphone:', err);
                showToast('Could not access microphone. Please check permissions.', 'error');
            }
        }

        async function uploadVoiceNote(dayIndex, exIndex, audioBlob) {
            try {
                showToast('Saving voice note...', 'success');

                const contentType = 'audio/webm';
                const fileName = `voice-note-${Date.now()}.webm`;

                // Step 1: Get a signed upload URL
                const uploadUrlResult = await apiCall('/.netlify/functions/get-video-upload-url', {
                    method: 'POST',
                    body: JSON.stringify({
                        coachId: currentCoachId,
                        fileName,
                        contentType,
                        folder: 'voice-notes'
                    })
                });

                if (!uploadUrlResult.success) {
                    throw new Error(uploadUrlResult.error || 'Failed to get upload URL');
                }

                // Step 2: Upload directly to Supabase
                const uploadResponse = await fetch(uploadUrlResult.uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': contentType
                    },
                    body: audioBlob
                });

                if (!uploadResponse.ok) {
                    throw new Error('Failed to upload voice note to storage');
                }

                // Step 3: Get a signed view URL
                const signedUrlResult = await apiCall('/.netlify/functions/get-signed-video-url', {
                    method: 'POST',
                    body: JSON.stringify({
                        filePath: uploadUrlResult.filePath
                    })
                });

                if (signedUrlResult.success) {
                    // Store both URL and file path (path used to refresh signed URLs)
                    workoutDays[dayIndex].exercises[exIndex].voiceNoteUrl = signedUrlResult.url;
                    workoutDays[dayIndex].exercises[exIndex].voiceNotePath = uploadUrlResult.filePath;
                    renderWorkoutDays();
                    showToast('Voice note saved!', 'success');
                } else {
                    throw new Error('Failed to get voice note URL');
                }
            } catch (err) {
                console.error('Error uploading voice note:', err);
                showToast(err.message || 'Error saving voice note', 'error');
            }
        }

        function deleteVoiceNote(dayIndex, exIndex) {
            if (confirm('Delete this voice note?')) {
                workoutDays[dayIndex].exercises[exIndex].voiceNoteUrl = null;
                renderWorkoutDays();
                showToast('Voice note deleted', 'success');
            }
        }

        // ============ VIDEO COMPRESSION ============
        // Compresses video to 720p before upload to prevent large file playback issues
        async function compressVideo(file) {
            const MAX_WIDTH = 720;
            const TARGET_BITRATE = 1500000; // 1.5 Mbps
            const COMPRESS_THRESHOLD = 2 * 1024 * 1024; // 2MB

            // Skip compression if small enough
            if (file.size <= COMPRESS_THRESHOLD) {
                return file;
            }

            // Check browser support
            if (typeof MediaRecorder === 'undefined' || !document.createElement('canvas').captureStream) {
                console.warn('Browser does not support video compression, uploading original');
                return file;
            }

            return new Promise((resolve) => {
                const video = document.createElement('video');
                video.muted = true;
                video.playsInline = true;
                video.preload = 'auto';
                const objectUrl = URL.createObjectURL(file);
                let resolved = false;

                function finish(result) {
                    if (resolved) return;
                    resolved = true;
                    clearTimeout(safetyTimeout);
                    URL.revokeObjectURL(objectUrl);
                    resolve(result);
                }

                // Safety timeout: 60s max for compression
                const safetyTimeout = setTimeout(() => finish(file), 60000);

                video.onloadedmetadata = () => {
                    let width = video.videoWidth;
                    let height = video.videoHeight;

                    // Skip if already small resolution
                    if (width <= MAX_WIDTH && file.size <= COMPRESS_THRESHOLD) {
                        finish(file);
                        return;
                    }

                    if (width > MAX_WIDTH) {
                        const ratio = MAX_WIDTH / width;
                        height = Math.round(height * ratio);
                        width = MAX_WIDTH;
                    }
                    // Even dimensions (required by codecs)
                    width = Math.round(width / 2) * 2;
                    height = Math.round(height / 2) * 2;

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    const stream = canvas.captureStream(24);

                    // Pick best available codec
                    let mimeType = 'video/webm';
                    for (const candidate of ['video/webm;codecs=vp9', 'video/webm;codecs=vp8', 'video/webm']) {
                        if (MediaRecorder.isTypeSupported(candidate)) {
                            mimeType = candidate;
                            break;
                        }
                    }

                    let recorder;
                    try {
                        recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: TARGET_BITRATE });
                    } catch (e) {
                        try { recorder = new MediaRecorder(stream); } catch (e2) { finish(file); return; }
                    }

                    const chunks = [];
                    recorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
                    recorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        console.log(`Video compressed: ${(file.size/1024/1024).toFixed(1)}MB  ${(blob.size/1024/1024).toFixed(1)}MB (${width}x${height})`);
                        finish(blob);
                    };

                    video.onended = () => {
                        if (recorder.state === 'recording') recorder.stop();
                    };

                    // Start recording frames  must begin draw loop AFTER play starts
                    recorder.start();
                    function drawFrame() {
                        if (video.paused || video.ended) return;
                        ctx.drawImage(video, 0, 0, width, height);
                        requestAnimationFrame(drawFrame);
                    }
                    video.play().then(() => drawFrame()).catch(() => finish(file));
                };

                video.onerror = () => finish(file);
                video.src = objectUrl;
            });
        }

        // ============ CUSTOM VIDEO FUNCTIONS ============
        let videoMediaRecorder = null;
        let videoChunks = [];
        let videoRecordingExercise = null;
        let videoRecordingTimer = null;
        let videoRecordingSeconds = 0;
        const MAX_VIDEO_SECONDS = 20;

        async function startVideoRecording(dayIndex, exIndex) {
            const btn = document.getElementById(`videoRecordBtn-${dayIndex}-${exIndex}`);

            // If already recording, stop
            if (videoMediaRecorder && videoMediaRecorder.state === 'recording') {
                stopVideoRecording();
                return;
            }

            try {
                // Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 720 }, height: { ideal: 480 } },
                    audio: false
                });

                videoMediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                videoChunks = [];
                videoRecordingExercise = { dayIndex, exIndex };
                videoRecordingSeconds = 0;

                videoMediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        videoChunks.push(e.data);
                    }
                };

                videoMediaRecorder.onstop = async () => {
                    clearInterval(videoRecordingTimer);
                    stream.getTracks().forEach(track => track.stop());

                    const videoBlob = new Blob(videoChunks, { type: 'video/webm' });
                    await uploadCustomVideo(dayIndex, exIndex, videoBlob);

                    videoMediaRecorder = null;
                    videoChunks = [];
                    videoRecordingExercise = null;
                };

                videoMediaRecorder.start(100);
                btn.classList.add('recording');
                btn.innerHTML = `
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                        <rect x="6" y="6" width="12" height="12" rx="2"/>
                    </svg>
                    <span class="video-recording-timer">0:00</span>
                    Stop
                `;

                // Start timer - auto-stop at MAX_VIDEO_SECONDS
                videoRecordingTimer = setInterval(() => {
                    videoRecordingSeconds++;
                    const mins = Math.floor(videoRecordingSeconds / 60);
                    const secs = videoRecordingSeconds % 60;
                    const timerEl = btn.querySelector('.video-recording-timer');
                    if (timerEl) {
                        timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                    }

                    if (videoRecordingSeconds >= MAX_VIDEO_SECONDS) {
                        showToast(`Max ${MAX_VIDEO_SECONDS} seconds reached`, 'success');
                        stopVideoRecording();
                    }
                }, 1000);

                showToast(`Recording... (max ${MAX_VIDEO_SECONDS}s)`, 'success');

            } catch (err) {
                console.error('Error accessing camera:', err);
                showToast('Could not access camera. Please check permissions.', 'error');
            }
        }

        function stopVideoRecording() {
            if (videoMediaRecorder && videoMediaRecorder.state === 'recording') {
                videoMediaRecorder.stop();
            }
        }

        async function handleVideoUpload(event, dayIndex, exIndex) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 50MB)
            if (file.size > 50 * 1024 * 1024) {
                showToast('Video too large. Max 50MB.', 'error');
                return;
            }

            // Check video duration
            const video = document.createElement('video');
            video.preload = 'metadata';

            video.onloadedmetadata = async () => {
                window.URL.revokeObjectURL(video.src);

                if (video.duration > MAX_VIDEO_SECONDS) {
                    showToast(`Video too long. Max ${MAX_VIDEO_SECONDS} seconds.`, 'error');
                    return;
                }

                // Compress video before uploading (reduces 4K/large files to 720p)
                let videoToUpload = file;
                if (file.size > 2 * 1024 * 1024) {
                    showToast('Compressing video for optimal playback...', 'success');
                    videoToUpload = await compressVideo(file);
                    if (videoToUpload !== file) {
                        showToast(`Compressed: ${(file.size/1024/1024).toFixed(1)}MB  ${(videoToUpload.size/1024/1024).toFixed(1)}MB`, 'success');
                    }
                }

                await uploadCustomVideo(dayIndex, exIndex, videoToUpload);
            };

            video.src = URL.createObjectURL(file);
        }

        async function uploadCustomVideo(dayIndex, exIndex, videoBlob) {
            try {
                showToast('Uploading video...', 'success');

                // Determine content type
                const isWebm = videoBlob.type.includes('webm');
                const contentType = isWebm ? 'video/webm' : 'video/mp4';
                const extension = isWebm ? 'webm' : 'mp4';
                const fileName = `custom-video-${Date.now()}.${extension}`;

                // Step 1: Get a signed upload URL
                const uploadUrlResult = await apiCall('/.netlify/functions/get-video-upload-url', {
                    method: 'POST',
                    body: JSON.stringify({
                        coachId: currentCoachId,
                        fileName,
                        contentType,
                        folder: 'exercise-videos'
                    })
                });

                if (!uploadUrlResult.success) {
                    throw new Error(uploadUrlResult.error || 'Failed to get upload URL');
                }

                // Step 2: Upload directly to Supabase
                const uploadResponse = await fetch(uploadUrlResult.uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': contentType
                    },
                    body: videoBlob
                });

                if (!uploadResponse.ok) {
                    throw new Error('Failed to upload video to storage');
                }

                // Step 3: Get a signed view URL
                const signedUrlResult = await apiCall('/.netlify/functions/get-signed-video-url', {
                    method: 'POST',
                    body: JSON.stringify({
                        filePath: uploadUrlResult.filePath
                    })
                });

                if (signedUrlResult.success) {
                    // Store both URL and file path (path used to refresh signed URLs)
                    workoutDays[dayIndex].exercises[exIndex].customVideoUrl = signedUrlResult.url;
                    workoutDays[dayIndex].exercises[exIndex].customVideoPath = uploadUrlResult.filePath;
                    renderWorkoutDays();
                    showToast('Custom video saved!', 'success');
                } else {
                    throw new Error('Failed to get video URL');
                }
            } catch (err) {
                console.error('Error uploading video:', err);
                showToast(err.message || 'Error saving video', 'error');
            }
        }

        function deleteCustomVideo(dayIndex, exIndex) {
            if (confirm('Delete this custom video?')) {
                workoutDays[dayIndex].exercises[exIndex].customVideoUrl = null;
                renderWorkoutDays();
                showToast('Custom video deleted', 'success');
            }
        }

        // ============ RECOMMENDED SWAPS FUNCTIONS ============
        let recommendedSwapsDayIndex = null;
        let recommendedSwapsExIndex = null;
        let recommendedSwapsCache = [];

        function openRecommendedSwapsModal(dayIndex, exIndex) {
            recommendedSwapsDayIndex = dayIndex;
            recommendedSwapsExIndex = exIndex;

            const currentExercise = workoutDays[dayIndex].exercises[exIndex];
            document.getElementById('recommendedCurrentName').textContent = currentExercise.name;
            document.getElementById('recommendedSearchInput').value = '';

            // Use ALL exercises (excluding current) - coaches can recommend any exercise
            recommendedSwapsCache = exercises.filter(ex => ex.id !== currentExercise.id);

            // Initially show same muscle group exercises as suggestions, but search will access all
            const muscleGroup = currentExercise.muscle_group || currentExercise.muscleGroup || '';
            const sameMuscleExercises = recommendedSwapsCache.filter(ex => {
                const exMuscle = ex.muscle_group || '';
                return exMuscle.toLowerCase() === muscleGroup.toLowerCase() ||
                    (ex.secondary_muscles && ex.secondary_muscles.some(m =>
                        m.toLowerCase() === muscleGroup.toLowerCase()));
            });

            renderCurrentRecommendedSwaps();
            // Show same muscle group by default, but all are available via search
            renderRecommendedExerciseOptions(sameMuscleExercises.length > 0 ? sameMuscleExercises : recommendedSwapsCache.slice(0, 20));
            document.getElementById('recommendedSwapsModal').classList.add('active');
        }

        function closeRecommendedSwapsModal() {
            document.getElementById('recommendedSwapsModal').classList.remove('active');
            recommendedSwapsDayIndex = null;
            recommendedSwapsExIndex = null;
            renderWorkoutDays(); // Re-render to show updated swap counts
        }

        function renderCurrentRecommendedSwaps() {
            const container = document.getElementById('currentRecommendedSwaps');
            const exercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];
            const swaps = exercise.recommendedSwaps || [];

            if (swaps.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">No recommended swaps yet. Add some below!</p>';
                return;
            }

            container.innerHTML = swaps.map((swap, idx) => `
                <div class="recommended-swap-item">
                    <img class="swap-thumb" src="${swap.thumbnail_url || swap.animation_url || '/img/exercise-placeholder.svg'}"
                         alt="${swap.name}" onerror="this.src='/img/exercise-placeholder.svg'">
                    <div class="swap-info">
                        <div class="swap-name">${swap.name}</div>
                        <div class="swap-muscle">${swap.equipment || swap.muscle_group || ''}</div>
                    </div>
                    <button class="remove-swap-btn" onclick="removeRecommendedSwap(${idx})" title="Remove">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function renderRecommendedExerciseOptions(exerciseList) {
            const container = document.getElementById('recommendedExerciseOptions');
            const exercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];
            const currentSwapIds = (exercise.recommendedSwaps || []).map(s => s.id);

            // Filter out already recommended exercises
            const available = exerciseList.filter(ex => !currentSwapIds.includes(ex.id));

            if (available.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">No more exercises available for this muscle group.</p>';
                return;
            }

            container.innerHTML = available.slice(0, 20).map(ex => `
                <div class="recommended-exercise-option" onclick="addRecommendedSwap(${ex.id})">
                    <img class="option-thumb" src="${ex.thumbnail_url || ex.animation_url || '/img/exercise-placeholder.svg'}"
                         alt="${ex.name}" onerror="this.src='/img/exercise-placeholder.svg'">
                    <div class="option-info">
                        <div class="option-name">${ex.name}</div>
                        <div class="option-equipment">${ex.equipment || ex.muscle_group || ''}</div>
                    </div>
                    <svg width="20" height="20" fill="none" stroke="var(--brand-primary)" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </div>
            `).join('');
        }

        function filterRecommendedExercises(query) {
            const currentExercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];
            const muscleGroup = currentExercise.muscle_group || currentExercise.muscleGroup || '';

            if (!query) {
                // No search - show same muscle group exercises as default
                const sameMuscle = recommendedSwapsCache.filter(ex => {
                    const exMuscle = ex.muscle_group || '';
                    return exMuscle.toLowerCase() === muscleGroup.toLowerCase();
                });
                renderRecommendedExerciseOptions(sameMuscle.length > 0 ? sameMuscle : recommendedSwapsCache.slice(0, 20));
                return;
            }

            // Search through ALL exercises by name, equipment, or muscle group
            const filtered = recommendedSwapsCache.filter(ex =>
                ex.name.toLowerCase().includes(query.toLowerCase()) ||
                (ex.equipment && ex.equipment.toLowerCase().includes(query.toLowerCase())) ||
                (ex.muscle_group && ex.muscle_group.toLowerCase().includes(query.toLowerCase()))
            );
            renderRecommendedExerciseOptions(filtered);
        }

        function addRecommendedSwap(exerciseId) {
            const exerciseToAdd = exercises.find(ex => ex.id === exerciseId);
            if (!exerciseToAdd) return;

            const currentExercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];

            // Initialize array if needed
            if (!currentExercise.recommendedSwaps) {
                currentExercise.recommendedSwaps = [];
            }

            // Check if already added
            if (currentExercise.recommendedSwaps.some(s => s.id === exerciseId)) {
                showToast('This exercise is already recommended', 'error');
                return;
            }

            // Add the swap recommendation
            currentExercise.recommendedSwaps.push({
                id: exerciseToAdd.id,
                name: exerciseToAdd.name,
                thumbnail_url: exerciseToAdd.thumbnail_url,
                animation_url: exerciseToAdd.animation_url,
                muscle_group: exerciseToAdd.muscle_group,
                equipment: exerciseToAdd.equipment
            });

            showToast(`Added "${exerciseToAdd.name}" as recommended swap`, 'success');
            renderCurrentRecommendedSwaps();
            renderRecommendedExerciseOptions(recommendedSwapsCache);
        }

        function removeRecommendedSwap(swapIndex) {
            const currentExercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];
            const removed = currentExercise.recommendedSwaps.splice(swapIndex, 1);
            showToast(`Removed "${removed[0].name}" from recommendations`, 'success');
            renderCurrentRecommendedSwaps();
            renderRecommendedExerciseOptions(recommendedSwapsCache);
        }

        // AI-Powered Swap Suggestions for Coach
        async function fetchAISwapSuggestions() {
            if (recommendedSwapsDayIndex === null || recommendedSwapsExIndex === null) return;

            const currentExercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];
            const container = document.getElementById('aiSwapSuggestionsContainer');
            const btn = document.getElementById('aiSwapFetchBtn');

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = `<svg width="14" height="14" class="spin-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Analyzing...`;
            container.innerHTML = '<div style="text-align: center; padding: 16px;"><div class="loading-spinner" style="border: 2px solid rgba(16,185,129,0.2); border-top: 2px solid #10b981; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto 8px;"></div><p style="color: var(--text-muted); font-size: 13px; margin: 0;">AI is analyzing movement patterns...</p></div>';

            try {
                // Get all exercises currently in the workout day
                const workoutExercises = workoutDays[recommendedSwapsDayIndex].exercises.map(ex => ({
                    id: ex.id,
                    name: ex.name
                }));

                const response = await fetch('/.netlify/functions/ai-swap-exercise', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAccessToken}`
                    },
                    body: JSON.stringify({
                        exercise: {
                            id: currentExercise.id,
                            name: currentExercise.name,
                            muscle_group: currentExercise.muscle_group || currentExercise.muscleGroup || '',
                            equipment: currentExercise.equipment || '',
                            secondary_muscles: currentExercise.secondary_muscles || [],
                            difficulty: currentExercise.difficulty || '',
                            exercise_type: currentExercise.exercise_type || ''
                        },
                        workoutExercises: workoutExercises
                    })
                });

                const data = await response.json();

                if (data.suggestions && data.suggestions.length > 0) {
                    const currentSwapIds = (currentExercise.recommendedSwaps || []).map(s => s.id);
                    const filteredSuggestions = data.suggestions.filter(s => !currentSwapIds.includes(s.id));

                    if (filteredSuggestions.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 12px 0;">All AI suggestions are already in your recommended swaps!</p>';
                    } else {
                        container.innerHTML = filteredSuggestions.map(ex => `
                            <div class="recommended-exercise-option" onclick="addRecommendedSwapFromAI(${ex.id}, '${(ex.name || '').replace(/'/g, "\\'")}', '${(ex.thumbnail_url || '').replace(/'/g, "\\'")}', '${(ex.animation_url || '').replace(/'/g, "\\'")}', '${(ex.muscle_group || '').replace(/'/g, "\\'")}', '${(ex.equipment || '').replace(/'/g, "\\'")}')" style="cursor: pointer;">
                                <img class="option-thumb" src="${ex.thumbnail_url || ex.animation_url || '/img/exercise-placeholder.svg'}"
                                     alt="${ex.name}" onerror="this.src='/img/exercise-placeholder.svg'">
                                <div class="option-info">
                                    <div class="option-name">${ex.name}</div>
                                    <div class="option-equipment">${ex.equipment || ex.muscle_group || ''}</div>
                                    ${ex.ai_reason ? `<div style="font-size: 11px; color: #10b981; margin-top: 2px;">${ex.ai_reason}</div>` : ''}
                                </div>
                                <svg width="20" height="20" fill="none" stroke="var(--brand-primary)" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                            </div>
                        `).join('');
                    }
                } else {
                    container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 12px 0;">No AI suggestions available for this exercise.</p>';
                }
            } catch (err) {
                console.error('AI swap suggestions error:', err);
                container.innerHTML = '<p style="color: #ef4444; font-size: 13px; text-align: center; padding: 12px 0;">Failed to get AI suggestions. Try again.</p>';
            }

            // Reset button
            btn.disabled = false;
            btn.innerHTML = `<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Refresh Suggestions`;
        }

        function addRecommendedSwapFromAI(id, name, thumbnailUrl, animationUrl, muscleGroup, equipment) {
            const currentExercise = workoutDays[recommendedSwapsDayIndex].exercises[recommendedSwapsExIndex];

            if (!currentExercise.recommendedSwaps) {
                currentExercise.recommendedSwaps = [];
            }

            if (currentExercise.recommendedSwaps.some(s => s.id === id)) {
                showToast('This exercise is already recommended', 'error');
                return;
            }

            currentExercise.recommendedSwaps.push({
                id: id,
                name: name,
                thumbnail_url: thumbnailUrl,
                animation_url: animationUrl,
                muscle_group: muscleGroup,
                equipment: equipment
            });

            showToast(`Added "${name}" as recommended swap`, 'success');
            renderCurrentRecommendedSwaps();
            // Refresh AI suggestions to remove the one just added
            fetchAISwapSuggestions();
        }

        // AI Modal
        let aiMode = null; // 'single' or 'program'

        function openAIModal() {
            // Reset to mode selection
            aiMode = null;
            document.getElementById('modeSingle').classList.remove('selected');
            document.getElementById('modeProgram').classList.remove('selected');
            document.getElementById('aiSharedFields').classList.remove('active');
            document.getElementById('aiSingleFields').classList.remove('active');
            document.getElementById('aiProgramFields').classList.remove('active');
            document.getElementById('aiBottomFields').classList.remove('active');
            document.getElementById('aiModalFooter').style.display = 'none';
            document.getElementById('aiModeSelector').style.display = '';
            document.getElementById('aiModal').classList.add('active');
        }

        function selectAIMode(mode) {
            aiMode = mode;
            // Update card selection
            document.getElementById('modeSingle').classList.toggle('selected', mode === 'single');
            document.getElementById('modeProgram').classList.toggle('selected', mode === 'program');

            // Show shared fields
            document.getElementById('aiSharedFields').classList.add('active');
            document.getElementById('aiBottomFields').classList.add('active');
            document.getElementById('aiModalFooter').style.display = '';

            // Toggle mode-specific fields
            document.getElementById('aiSingleFields').classList.toggle('active', mode === 'single');
            document.getElementById('aiProgramFields').classList.toggle('active', mode === 'program');

            // Update button text
            const btn = document.getElementById('aiGenerateBtn');
            btn.innerHTML = mode === 'single' ? 'Generate Workout' : 'Generate Program';
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.remove('active');
        }

        async function generateAIWorkout() {
            const btn = document.getElementById('aiGenerateBtn');
            const originalText = btn.innerHTML;
            const isSingle = aiMode === 'single';

            // Get shared form values
            const clientName = document.getElementById('aiClientName').value || 'Client';
            const goal = document.getElementById('aiGoal').value;
            const experience = document.getElementById('aiExperience').value;
            const injuries = document.getElementById('aiInjuries').value;
            const preferences = document.getElementById('aiPreferences').value;

            const equipment = Array.from(document.querySelectorAll('input[name="equipment"]:checked'))
                .map(cb => cb.value);

            if (equipment.length === 0) {
                showToast('Please select at least one equipment type', 'error');
                return;
            }

            // Build request body based on mode
            let requestBody;
            if (isSingle) {
                const targetMuscle = document.getElementById('aiTargetMuscle').value;
                const sessionDuration = parseInt(document.getElementById('aiSingleSessionDuration').value);
                const trainingStyle = document.getElementById('aiSingleTrainingStyle').value;
                const exerciseCount = document.getElementById('aiSingleExerciseCount').value;

                requestBody = {
                    mode: 'single',
                    clientName,
                    goal,
                    experience,
                    targetMuscle,
                    daysPerWeek: 1,
                    duration: 1,
                    split: 'auto',
                    sessionDuration,
                    trainingStyle,
                    exerciseCount,
                    focusAreas: [targetMuscle],
                    equipment,
                    injuries,
                    preferences
                };
            } else {
                const daysPerWeek = parseInt(document.getElementById('aiDaysPerWeek').value);
                const duration = parseInt(document.getElementById('aiDuration').value);
                const split = document.getElementById('aiSplit').value;
                const sessionDuration = parseInt(document.getElementById('aiSessionDuration').value);
                const trainingStyle = document.getElementById('aiTrainingStyle').value;
                const exerciseCount = document.getElementById('aiExerciseCount').value;
                const focusAreas = Array.from(document.querySelectorAll('input[name="focusArea"]:checked'))
                    .map(cb => cb.value);

                requestBody = {
                    mode: 'program',
                    clientName,
                    goal,
                    experience,
                    daysPerWeek,
                    duration,
                    split,
                    sessionDuration,
                    trainingStyle,
                    exerciseCount,
                    focusAreas,
                    equipment,
                    injuries,
                    preferences
                };
            }

            // Show loading
            btn.disabled = true;
            btn.innerHTML = '<span class="generating-text"><span class="spinner"></span>Generating...</span>';

            try {
                const response = await fetch('/.netlify/functions/generate-workout-claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to generate workout');
                }

                // Populate program
                const program = result.program;
                const programGoal = requestBody.goal;

                if (isSingle) {
                    const targetLabel = document.getElementById('aiTargetMuscle').selectedOptions[0]?.text || requestBody.targetMuscle;
                    document.getElementById('programName').value = program.programName || `${targetLabel} Workout`;
                } else {
                    document.getElementById('programName').value = program.programName || `${programGoal} Program`;
                }
                document.getElementById('programType').value = programGoal;
                document.getElementById('programDifficulty').value = experience;
                document.getElementById('daysPerWeek').value = requestBody.daysPerWeek;
                document.getElementById('programDescription').value = program.description || '';

                // Convert to workout days
                workoutDays = [];
                if (program.weeks && program.weeks[0]?.workouts) {
                    program.weeks[0].workouts.forEach(workout => {
                        workoutDays.push({
                            name: workout.name,
                            exercises: (workout.exercises || []).map(ex => ({
                                id: ex.id,
                                name: ex.name,
                                video_url: ex.video_url,
                                animation_url: ex.animation_url,
                                thumbnail_url: ex.thumbnail_url,
                                muscle_group: ex.muscle_group || ex.muscleGroup,
                                equipment: ex.equipment,
                                instructions: ex.instructions,
                                sets: ex.isWarmup ? (ex.sets || 1) : ex.isStretch ? (ex.sets || 1) : (ex.sets || 3),
                                reps: ex.isWarmup ? (ex.reps || '10-15') : ex.isStretch ? (ex.reps || '30s hold') : (ex.reps || '8-12'),
                                restSeconds: ex.isWarmup ? (ex.restSeconds != null ? ex.restSeconds : 30) : ex.isStretch ? (ex.restSeconds != null ? ex.restSeconds : 0) : (ex.restSeconds || 90),
                                notes: ex.notes || '',
                                matched: ex.matched,
                                isSuperset: ex.isSuperset || false,
                                supersetGroup: ex.supersetGroup || null,
                                isWarmup: ex.isWarmup || false,
                                isStretch: ex.isStretch || false
                            }))
                        });
                    });
                }

                renderWorkoutDays();
                closeAIModal();
                showToast(isSingle ? 'Workout generated!' : 'Workout program generated!');

            } catch (error) {
                console.error('AI generation error:', error);
                showToast(error.message || 'Failed to generate workout', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = isSingle ? 'Generate Workout' : 'Generate Program';
            }
        }

        // ============================================
        // Custom Exercise Functions
        // ============================================

        function openCustomExerciseModal() {
            // Reset form
            document.getElementById('ceExerciseName').value = '';
            document.getElementById('ceMuscleGroup').value = '';
            document.getElementById('ceEquipment').value = '';
            document.getElementById('ceDifficulty').value = 'intermediate';
            document.getElementById('ceExerciseType').value = 'strength';
            document.getElementById('ceInstructions').value = '';

            // Reset video state
            ceVideoData = null;
            ceVideoBlob = null;
            const openPreviewEl = document.getElementById('cePreviewVideo');
            if (openPreviewEl.src && openPreviewEl.src.startsWith('blob:')) {
                URL.revokeObjectURL(openPreviewEl.src);
            }
            document.getElementById('ceVideoPreview').classList.remove('visible');
            openPreviewEl.src = '';
            document.getElementById('ceRecordingIndicator').style.display = 'none';

            document.getElementById('customExerciseModal').classList.add('active');
        }

        function closeCustomExerciseModal() {
            // Stop any active recording
            if (ceVideoRecorder && ceVideoRecorder.state === 'recording') {
                ceVideoRecorder.stop();
            }
            if (ceRecordingInterval) {
                clearInterval(ceRecordingInterval);
                ceRecordingInterval = null;
            }

            document.getElementById('customExerciseModal').classList.remove('active');

            // Reset reference links
            ceReferenceLinks = [];
            const linksListEl = document.getElementById('ceReferenceLinksList');
            if (linksListEl) linksListEl.innerHTML = '';
            const linkInputEl = document.getElementById('ceReferenceLinkInput');
            if (linkInputEl) linkInputEl.value = '';
        }

        function triggerCEVideoUpload() {
            document.getElementById('ceVideoFileInput').click();
        }

        async function handleCEVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 50MB)
            if (file.size > 50 * 1024 * 1024) {
                showToast('Video too large. Max 50MB', 'error');
                return;
            }

            // Compress video before storing (reduces 4K/large files to 720p)
            let videoFile = file;
            if (file.size > 2 * 1024 * 1024) {
                showToast('Compressing video for optimal playback...', 'success');
                videoFile = await compressVideo(file);
                if (videoFile !== file) {
                    showToast(`Compressed: ${(file.size/1024/1024).toFixed(1)}MB  ${(videoFile.size/1024/1024).toFixed(1)}MB`, 'success');
                }
            }

            // Store blob directly (avoids memory-intensive base64 conversion)
            ceVideoBlob = videoFile;
            ceVideoData = videoFile.type || 'video/webm';

            // Revoke previous object URL if any
            const previewEl = document.getElementById('cePreviewVideo');
            if (previewEl.src && previewEl.src.startsWith('blob:')) {
                URL.revokeObjectURL(previewEl.src);
            }

            // Show preview using efficient object URL
            previewEl.src = URL.createObjectURL(videoFile);
            document.getElementById('ceVideoSize').textContent = `Video ready (${(videoFile.size / 1024 / 1024).toFixed(1)}MB)`;
            document.getElementById('ceVideoPreview').classList.add('visible');

            // Reset file input
            event.target.value = '';
        }

        async function startCEVideoRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });

                ceVideoChunks = [];
                ceVideoRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

                ceVideoRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        ceVideoChunks.push(e.data);
                    }
                };

                ceVideoRecorder.onstop = async () => {
                    stream.getTracks().forEach(track => track.stop());

                    const blob = new Blob(ceVideoChunks, { type: 'video/webm' });

                    // Store blob directly (avoids memory-intensive base64 conversion)
                    ceVideoBlob = blob;
                    ceVideoData = 'video/webm';

                    // Revoke previous object URL if any
                    const previewEl = document.getElementById('cePreviewVideo');
                    if (previewEl.src && previewEl.src.startsWith('blob:')) {
                        URL.revokeObjectURL(previewEl.src);
                    }

                    // Show preview using efficient object URL
                    previewEl.src = URL.createObjectURL(blob);
                    document.getElementById('ceVideoSize').textContent = `Video ready (${(blob.size / 1024 / 1024).toFixed(1)}MB)`;
                    document.getElementById('ceVideoPreview').classList.add('visible');

                    document.getElementById('ceRecordingIndicator').style.display = 'none';
                };

                ceVideoRecorder.start();

                // Show recording indicator
                document.getElementById('ceRecordingIndicator').style.display = 'flex';

                // Timer (max 20 seconds)
                let seconds = 0;
                ceRecordingInterval = setInterval(() => {
                    seconds++;
                    document.getElementById('ceRecordingTimer').textContent = `0:${seconds.toString().padStart(2, '0')}`;

                    if (seconds >= 20) {
                        stopCEVideoRecording();
                    }
                }, 1000);

            } catch (err) {
                console.error('Error starting video recording:', err);
                showToast('Could not access camera. Please allow camera permissions.', 'error');
            }
        }

        function stopCEVideoRecording() {
            if (ceVideoRecorder && ceVideoRecorder.state === 'recording') {
                ceVideoRecorder.stop();
            }
            if (ceRecordingInterval) {
                clearInterval(ceRecordingInterval);
                ceRecordingInterval = null;
            }
        }

        function removeCEVideo() {
            ceVideoData = null;
            ceVideoBlob = null;
            const removePreviewEl = document.getElementById('cePreviewVideo');
            if (removePreviewEl.src && removePreviewEl.src.startsWith('blob:')) {
                URL.revokeObjectURL(removePreviewEl.src);
            }
            document.getElementById('ceVideoPreview').classList.remove('visible');
            removePreviewEl.src = '';
        }

        // Custom exercise reference links (temporary storage during creation)
        let ceReferenceLinks = [];

        function addCEReferenceLink() {
            const input = document.getElementById('ceReferenceLinkInput');
            const url = (input.value || '').trim();
            if (!url) return;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showToast('Please enter a valid URL starting with http:// or https://', 'error');
                return;
            }
            ceReferenceLinks.push({
                url: url,
                title: getTitleFromUrl(url),
                type: detectLinkType(url)
            });
            input.value = '';
            renderCEReferenceLinks();
        }

        function removeCEReferenceLink(index) {
            ceReferenceLinks.splice(index, 1);
            renderCEReferenceLinks();
        }

        function renderCEReferenceLinks() {
            const container = document.getElementById('ceReferenceLinksList');
            if (!container) return;
            if (ceReferenceLinks.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = `<div class="reference-links-list">${ceReferenceLinks.map((link, idx) => `
                <div class="reference-link-item">
                    <span class="link-icon ${link.type}">${getLinkTypeIcon(link.type)}</span>
                    <span class="link-title" title="${escapeHtml(link.url)}">${escapeHtml(link.title || link.url)}</span>
                    <button class="link-delete" onclick="removeCEReferenceLink(${idx})" title="Remove link"></button>
                </div>
            `).join('')}</div>`;
        }

        async function saveCustomExercise() {
            const name = document.getElementById('ceExerciseName').value.trim();
            const muscleGroup = document.getElementById('ceMuscleGroup').value;
            const equipment = document.getElementById('ceEquipment').value;
            const difficulty = document.getElementById('ceDifficulty').value;
            const exerciseType = document.getElementById('ceExerciseType').value;
            const instructions = document.getElementById('ceInstructions').value.trim();

            // Validation
            if (!name) {
                showToast('Please enter an exercise name', 'error');
                return;
            }
            if (!muscleGroup) {
                showToast('Please select a muscle group', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveCustomExerciseBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner"></span> Creating...';

            try {
                let videoUrl = null;
                let videoFilePath = null;

                // Upload video if provided (using direct upload to Supabase)
                if (ceVideoBlob) {
                    saveBtn.innerHTML = '<span class="spinner"></span> Uploading video...';

                    // Determine file extension and content type from the blob
                    const blobType = ceVideoBlob.type || ceVideoData || 'video/webm';
                    const isWebm = blobType.includes('webm');
                    const contentType = isWebm ? 'video/webm' : 'video/mp4';
                    const extension = isWebm ? 'webm' : 'mp4';
                    const fileName = `custom-${Date.now()}.${extension}`;

                    // Step 1: Get a signed upload URL
                    const uploadUrlResult = await apiCall('/.netlify/functions/get-video-upload-url', {
                        method: 'POST',
                        body: JSON.stringify({
                            coachId: currentCoachId,
                            fileName,
                            contentType,
                            folder: 'exercise-videos'
                        })
                    });

                    if (!uploadUrlResult.success) {
                        throw new Error(uploadUrlResult.error || 'Failed to get upload URL');
                    }

                    // Step 2: Upload blob directly to Supabase (no base64 conversion needed)
                    const uploadResponse = await fetch(uploadUrlResult.uploadUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': contentType
                        },
                        body: ceVideoBlob
                    });

                    if (!uploadResponse.ok) {
                        const errText = await uploadResponse.text().catch(() => '');
                        throw new Error(`Failed to upload video to storage${errText ? ': ' + errText : ''}`);
                    }

                    // Step 3: Get a signed view URL
                    const signedUrlResult = await apiCall('/.netlify/functions/get-signed-video-url', {
                        method: 'POST',
                        body: JSON.stringify({
                            filePath: uploadUrlResult.filePath
                        })
                    });

                    if (signedUrlResult.success) {
                        videoUrl = signedUrlResult.url;
                        videoFilePath = uploadUrlResult.filePath;
                    }

                    saveBtn.innerHTML = '<span class="spinner"></span> Creating exercise...';
                }

                // Create the exercise
                const result = await apiCall('/.netlify/functions/exercises', {
                    method: 'POST',
                    body: JSON.stringify({
                        coachId: currentCoachId,
                        name,
                        muscleGroup,
                        equipment: equipment || null,
                        difficulty,
                        exerciseType,
                        instructions: instructions || null,
                        animationUrl: videoUrl,
                        thumbnailUrl: null,
                        referenceLinks: ceReferenceLinks.length > 0 ? ceReferenceLinks : []
                    })
                });

                if (result.success && result.exercise) {
                    // Add to local exercises array
                    exercises.push({
                        ...result.exercise,
                        is_custom: true,
                        // Store video file path for signed URL refresh
                        video_file_path: videoFilePath
                    });

                    showToast(`Custom exercise "${name}" created!`);
                    closeCustomExerciseModal();

                    // Refresh exercise grid if the modal is open
                    if (document.getElementById('exerciseModal').classList.contains('active')) {
                        renderExerciseGrid();
                    }
                } else {
                    throw new Error('Failed to create exercise');
                }

            } catch (err) {
                console.error('Error creating custom exercise:', err);
                showToast(err.message || 'Failed to create exercise', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = `
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Create Exercise
                `;
            }
        }

        // ============================================
        // Import Program Functions
        // ============================================

        let importedProgramData = null;
        let importFilter = 'all'; // 'all' or 'matched'
        let importFileContent = null;

        function openImportModal() {
            // Reset state
            importedProgramData = null;
            importFilter = 'all';
            importFileContent = null;
            document.getElementById('importStep1').style.display = '';
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importStep3').style.display = 'none';
            document.getElementById('importPasteArea').value = '';
            document.getElementById('importFileInfo').style.display = 'none';
            document.getElementById('importFileInput').value = '';
            document.getElementById('importBtn').innerHTML = 'Import Program';
            document.getElementById('importBtn').onclick = startImport;
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const infoEl = document.getElementById('importFileInfo');

            // Show file info
            infoEl.innerHTML = `
                <div class="import-file-info">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="file-name">${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <span class="file-remove" onclick="removeImportFile()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </span>
                </div>
            `;
            infoEl.style.display = '';

            const isPDF = file.name.toLowerCase().endsWith('.pdf');

            if (isPDF && window.pdfjsLib) {
                // Extract text from PDF using pdf.js
                try {
                    infoEl.querySelector('.file-name').textContent = `${file.name} - Extracting text...`;
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n\n';
                    }

                    importFileContent = fullText.trim();
                    document.getElementById('importPasteArea').value = importFileContent;
                    infoEl.querySelector('.file-name').textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB) - ${pdf.numPages} pages extracted`;
                } catch (err) {
                    console.error('PDF extraction error:', err);
                    showToast('Could not read PDF. Please copy/paste the text instead.', 'error');
                    infoEl.style.display = 'none';
                }
            } else {
                // Read as plain text for .txt, .csv files
                const reader = new FileReader();
                reader.onload = (e) => {
                    importFileContent = e.target.result;
                    document.getElementById('importPasteArea').value = importFileContent;
                };
                reader.readAsText(file);
            }
        }

        function removeImportFile() {
            importFileContent = null;
            document.getElementById('importFileInfo').style.display = 'none';
            document.getElementById('importFileInput').value = '';
            document.getElementById('importPasteArea').value = '';
        }

        // Set up drag & drop
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('importDropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) {
                        const input = document.getElementById('importFileInput');
                        const dt = new DataTransfer();
                        dt.items.add(file);
                        input.files = dt.files;
                        handleImportFile({ target: input });
                    }
                });
            }
        });

        async function startImport() {
            const textContent = document.getElementById('importPasteArea').value.trim() || (importFileContent || '').trim();

            if (!textContent || textContent.length < 20) {
                showToast('Please upload a file or paste your workout program text', 'error');
                return;
            }

            // Show processing step
            document.getElementById('importStep1').style.display = 'none';
            document.getElementById('importStep2').style.display = '';
            document.getElementById('importStep3').style.display = 'none';
            document.getElementById('importProgressText').textContent = 'Parsing your workout program...';

            const btn = document.getElementById('importBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="generating-text"><span class="spinner"></span>Processing...</span>';

            try {
                const response = await fetch('/.netlify/functions/import-workout-program', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileContent: textContent })
                });

                // Handle timeout/server errors that return HTML instead of JSON
                const contentType = response.headers.get('content-type') || '';
                if (!contentType.includes('application/json')) {
                    if (response.status === 504) {
                        throw new Error('The server timed out processing your request. Try pasting a shorter section of the program, or paste the text from just one or two days at a time.');
                    }
                    throw new Error(`Server error (${response.status}). Please try again.`);
                }

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to parse workout program');
                }

                importedProgramData = result;

                // Show results
                document.getElementById('importStep2').style.display = 'none';
                document.getElementById('importStep3').style.display = '';

                const stats = result.matchStats;
                document.getElementById('importStatTotal').textContent = stats.total;
                document.getElementById('importStatMatched').textContent = stats.matched;
                document.getElementById('importStatUnmatched').textContent = stats.unmatched;

                // Show unmatched exercises
                const unmatchedList = document.getElementById('importUnmatchedList');
                const unmatchedSection = document.getElementById('importUnmatchedSection');

                if (stats.unmatchedExercises && stats.unmatchedExercises.length > 0) {
                    unmatchedSection.style.display = '';
                    unmatchedList.innerHTML = stats.unmatchedExercises.map(ex =>
                        `<div class="import-unmatched-item">
                            <span class="dot"></span>
                            <span>${ex.original} <span style="color:var(--text-muted);">(${ex.day})</span></span>
                        </div>`
                    ).join('');
                } else {
                    unmatchedSection.style.display = 'none';
                }

                // Update button to "Apply to Builder"
                btn.disabled = false;
                btn.innerHTML = 'Apply to Builder';
                btn.onclick = applyImportedProgram;

                // Reset filter
                importFilter = 'all';
                document.getElementById('importFilterAll').classList.add('active');
                document.getElementById('importFilterMatched').classList.remove('active', 'active-warning');

            } catch (error) {
                console.error('Import error:', error);
                showToast(error.message || 'Failed to import workout program', 'error');

                // Go back to step 1
                document.getElementById('importStep1').style.display = '';
                document.getElementById('importStep2').style.display = 'none';
                document.getElementById('importStep3').style.display = 'none';
                btn.disabled = false;
                btn.innerHTML = 'Import Program';
                btn.onclick = startImport;
            }
        }

        function setImportFilter(filter) {
            importFilter = filter;
            document.getElementById('importFilterAll').classList.toggle('active', filter === 'all');
            document.getElementById('importFilterMatched').classList.toggle('active-warning', filter === 'matched');
            document.getElementById('importFilterAll').classList.remove('active-warning');
            document.getElementById('importFilterMatched').classList.remove('active');
        }

        // Detect if a reps value like "3 min", "30s" is time-based
        // Returns { isTime, durationSeconds }
        function detectTimedRepsValue(repsValue) {
            if (!repsValue || typeof repsValue !== 'string') return { isTime: false };
            const str = repsValue.trim().toLowerCase();
            const minMatch = str.match(/^(\d+(?:\.\d+)?)\s*(?:min(?:utes?|s)?)\b/);
            if (minMatch) return { isTime: true, durationSeconds: Math.round(parseFloat(minMatch[1]) * 60) };
            const secMatch = str.match(/^(\d+)\s*(?:s(?:ec(?:onds?)?)?)\b/);
            if (secMatch) return { isTime: true, durationSeconds: parseInt(secMatch[1], 10) };
            return { isTime: false };
        }

        function applyImportedProgram() {
            if (!importedProgramData || !importedProgramData.program) {
                showToast('No imported data available', 'error');
                return;
            }

            const program = importedProgramData.program;

            // Populate program details
            document.getElementById('programName').value = program.programName || 'Imported Program';
            document.getElementById('programType').value = program.goal || 'hypertrophy';
            document.getElementById('programDifficulty').value = program.difficulty || 'intermediate';
            document.getElementById('daysPerWeek').value = program.daysPerWeek || program.days.length;
            document.getElementById('programDescription').value = program.description || '';

            // Convert to workoutDays format
            workoutDays = [];
            currentProgramId = null;

            for (const day of program.days) {
                let exercises = day.exercises || [];

                // Apply filter
                if (importFilter === 'matched') {
                    exercises = exercises.filter(ex => ex.matched);
                }

                workoutDays.push({
                    name: day.name,
                    exercises: exercises.map(ex => {
                        const repsVal = ex.reps || '8-12';
                        // Use trackingType from import if set, otherwise detect from reps value
                        let trackingType = ex.trackingType || 'reps';
                        let duration = ex.duration;
                        if (!ex.trackingType) {
                            const timedCheck = detectTimedRepsValue(repsVal);
                            if (timedCheck.isTime) {
                                trackingType = 'time';
                                duration = timedCheck.durationSeconds;
                            }
                        }
                        return {
                            id: ex.id || null,
                            name: ex.name,
                            video_url: ex.video_url || null,
                            animation_url: ex.animation_url || null,
                            thumbnail_url: ex.thumbnail_url || null,
                            muscle_group: ex.muscle_group || ex.muscleGroup,
                            equipment: ex.equipment || null,
                            instructions: ex.instructions || null,
                            sets: ex.sets || 3,
                            reps: repsVal,
                            restSeconds: ex.restSeconds != null ? ex.restSeconds : 90,
                            notes: ex.notes || '',
                            matched: ex.matched || false,
                            isSuperset: ex.isSuperset || false,
                            supersetGroup: ex.supersetGroup || null,
                            isWarmup: ex.isWarmup || false,
                            isStretch: ex.isStretch || false,
                            trackingType: trackingType,
                            duration: duration
                        };
                    })
                });
            }

            renderWorkoutDays();
            // Check superset consistency for imported program
            workoutDays.forEach((_, d) => checkSupersetWarnings(d));
            closeImportModal();
            updateSaveButtonMode();

            const stats = importedProgramData.matchStats;
            if (importFilter === 'matched') {
                showToast(`Program imported! ${stats.matched} matched exercises loaded.`);
            } else {
                showToast(`Program imported! ${stats.matched} matched, ${stats.unmatched} unmatched exercises.`);
            }
        }

        // ============ MY VIDEOS MANAGEMENT ============
        let myVideosCache = [];

        function openMyVideosModal() {
            document.getElementById('myVideosModal').classList.add('active');
            document.getElementById('myVideosSearch').value = '';
            loadMyVideos();
        }

        function closeMyVideosModal() {
            document.getElementById('myVideosModal').classList.remove('active');
            // Pause any playing videos
            document.querySelectorAll('#myVideosGrid video').forEach(v => v.pause());
        }

        async function loadMyVideos() {
            const grid = document.getElementById('myVideosGrid');
            grid.innerHTML = '<div class="my-videos-loading"><span class="spinner"></span> Loading videos...</div>';
            document.getElementById('myVideosCount').textContent = '';

            try {
                const result = await apiCall('/.netlify/functions/list-coach-videos', {
                    method: 'POST',
                    body: JSON.stringify({ coachId: currentCoachId })
                });

                myVideosCache = result.videos || [];
                renderMyVideos(myVideosCache);
            } catch (err) {
                console.error('Failed to load videos:', err);
                grid.innerHTML = '<div class="my-videos-empty"><p>Failed to load videos</p></div>';
            }
        }

        function filterMyVideos() {
            const query = document.getElementById('myVideosSearch').value.toLowerCase().trim();
            if (!query) {
                renderMyVideos(myVideosCache);
                return;
            }
            const filtered = myVideosCache.filter(v => v.name.toLowerCase().includes(query));
            renderMyVideos(filtered);
        }

        function renderMyVideos(videos) {
            const grid = document.getElementById('myVideosGrid');
            document.getElementById('myVideosCount').textContent = `${videos.length} video${videos.length !== 1 ? 's' : ''}`;

            if (videos.length === 0) {
                grid.innerHTML = `
                    <div class="my-videos-empty">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        <p>No custom videos found</p>
                        <p style="font-size:12px;margin-top:4px">Upload videos from the workout builder using "Record Demo" or "Upload"</p>
                    </div>`;
                return;
            }

            grid.innerHTML = videos.map((v, i) => {
                const sizeMB = v.size ? (v.size / 1024 / 1024).toFixed(1) + ' MB' : '';
                const date = v.createdAt ? new Date(v.createdAt).toLocaleDateString() : '';
                const displayName = v.name.replace(/^custom-video-\d+-?/, '').replace(/\.\w+$/, '') || v.name;
                return `
                    <div class="my-video-card" id="my-video-${i}">
                        <div class="my-video-preview" onclick="toggleMyVideoPlay(${i})">
                            ${v.signedUrl
                                ? `<video src="${v.signedUrl}" muted loop playsinline preload="metadata"></video>
                                   <div class="my-video-play-btn"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>`
                                : `<svg width="32" height="32" fill="none" stroke="#666" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`
                            }
                        </div>
                        <div class="my-video-info">
                            <div class="my-video-name" title="${v.name}">${displayName || v.name}</div>
                            <div class="my-video-meta">
                                <span>${sizeMB}</span>
                                <span>${date}</span>
                            </div>
                        </div>
                        <div class="my-video-actions">
                            <button class="replace-btn" onclick="replaceMyVideo(${i})" title="Replace with a new video">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                                Replace
                            </button>
                            <button class="delete-btn" onclick="deleteMyVideo(${i})" title="Delete this video">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                Delete
                            </button>
                        </div>
                    </div>`;
            }).join('');
        }

        function toggleMyVideoPlay(index) {
            const card = document.getElementById(`my-video-${index}`);
            const video = card?.querySelector('video');
            if (!video) return;

            if (video.paused) {
                // Pause all other videos first
                document.querySelectorAll('#myVideosGrid video').forEach(v => {
                    v.pause();
                    v.closest('.my-video-card')?.classList.remove('playing');
                });
                video.play();
                card.classList.add('playing');
            } else {
                video.pause();
                card.classList.remove('playing');
            }
        }

        async function deleteMyVideo(index) {
            const video = myVideosCache[index];
            if (!video) return;

            if (!confirm(`Delete "${video.name}"?\n\nThis will permanently remove the video file. Any exercises using this video will no longer show it.`)) {
                return;
            }

            try {
                showToast('Deleting video...', 'success');
                await apiCall('/.netlify/functions/delete-coach-video', {
                    method: 'POST',
                    body: JSON.stringify({ coachId: currentCoachId, filePath: video.filePath })
                });

                myVideosCache.splice(index, 1);
                filterMyVideos();
                showToast('Video deleted', 'success');
            } catch (err) {
                console.error('Failed to delete video:', err);
                showToast('Failed to delete video', 'error');
            }
        }

        let replaceVideoIndex = null;

        function replaceMyVideo(index) {
            replaceVideoIndex = index;
            document.getElementById('replaceVideoInput').click();
        }

        document.getElementById('replaceVideoInput')?.addEventListener('change', async function(e) {
            const file = e.target.files?.[0];
            this.value = '';
            if (!file || replaceVideoIndex === null) return;

            const video = myVideosCache[replaceVideoIndex];
            if (!video) return;

            if (file.size > 50 * 1024 * 1024) {
                showToast('Video must be under 50MB', 'error');
                return;
            }

            try {
                showToast('Compressing & uploading...', 'success');

                // Compress if needed
                let videoToUpload = file;
                if (file.size > 2 * 1024 * 1024) {
                    videoToUpload = await compressVideo(file);
                }

                // Delete old file
                await apiCall('/.netlify/functions/delete-coach-video', {
                    method: 'POST',
                    body: JSON.stringify({ coachId: currentCoachId, filePath: video.filePath })
                });

                // Upload new file with same naming convention
                const ext = videoToUpload.type?.includes('webm') ? 'webm' : 'mp4';
                const newFileName = `custom-video-${Date.now()}.${ext}`;

                const uploadUrlResult = await apiCall('/.netlify/functions/get-video-upload-url', {
                    method: 'POST',
                    body: JSON.stringify({
                        coachId: currentCoachId,
                        fileName: newFileName,
                        contentType: videoToUpload.type || 'video/webm',
                        folder: 'exercise-videos'
                    })
                });

                if (!uploadUrlResult.success) {
                    throw new Error(uploadUrlResult.error || 'Failed to get upload URL');
                }

                const replaceResponse = await fetch(uploadUrlResult.uploadUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': videoToUpload.type || 'video/webm' },
                    body: videoToUpload
                });

                if (!replaceResponse.ok) {
                    throw new Error('Failed to upload replacement video');
                }

                showToast('Video replaced!', 'success');
                loadMyVideos(); // Refresh the list
            } catch (err) {
                console.error('Failed to replace video:', err);
                showToast('Failed to replace video', 'error');
            }
        });

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
