<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0d9488">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zique Fitness">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/logo.png">
    <title>My Workouts - Zique Fitness</title>
    <script src="/js/theme.js"></script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-primary: #0d9488;
            --brand-secondary: #0284c7;
            --brand-gradient: linear-gradient(135deg, #0d9488 0%, #0284c7 100%);
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --gray-50: #0f172a;
            --gray-100: #1e293b;
            --gray-200: #334155;
            --gray-300: #475569;
            --gray-400: #64748b;
            --gray-500: #94a3b8;
            --gray-600: #cbd5e1;
            --gray-700: #e2e8f0;
            --gray-800: #f1f5f9;
            --gray-900: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* Top Navigation */
        .top-nav {
            background: var(--brand-gradient);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-back {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .nav-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .nav-action {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Today's Workout Card */
        .workout-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
        }

        [data-theme="dark"] .workout-card {
            background: var(--gray-100);
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .workout-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .workout-meta {
            display: flex;
            gap: 16px;
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .workout-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--brand-gradient);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--brand-primary);
        }

        /* Exercise List */
        .exercise-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .exercise-item {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            gap: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        [data-theme="dark"] .exercise-item {
            background: var(--gray-200);
        }

        .exercise-item:active {
            transform: scale(0.98);
        }

        .exercise-item.completed {
            opacity: 0.7;
        }

        .exercise-item.completed .exercise-name {
            text-decoration: line-through;
        }

        .exercise-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--gray-200);
        }

        .exercise-info {
            flex: 1;
        }

        .exercise-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .exercise-details {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .exercise-sets {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .set-bubble {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        .set-bubble.completed {
            background: var(--brand-primary);
            color: white;
        }

        .exercise-check {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-200);
            color: var(--gray-400);
        }

        .exercise-check.completed {
            background: #10b981;
            color: white;
        }

        /* Start Workout Button */
        .start-workout-btn {
            width: 100%;
            padding: 16px;
            background: var(--brand-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 20px;
            background: var(--gray-100);
            color: var(--gray-600);
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        [data-theme="dark"] .tab {
            background: var(--gray-200);
        }

        .tab.active {
            background: var(--brand-gradient);
            color: white;
        }

        /* History Section */
        .history-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
        }

        [data-theme="dark"] .history-item {
            background: var(--gray-100);
        }

        .history-date {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .history-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .history-stats {
            display: flex;
            gap: 16px;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* Exercise Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .exercise-modal {
            background: white;
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px;
        }

        [data-theme="dark"] .exercise-modal {
            background: var(--gray-100);
        }

        .modal-handle {
            width: 40px;
            height: 4px;
            background: var(--gray-300);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        .modal-exercise-header {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .modal-thumbnail {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            object-fit: cover;
            background: var(--gray-200);
        }

        .modal-exercise-info h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .modal-exercise-info p {
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        /* Set Logging */
        .sets-container {
            margin-top: 20px;
        }

        .set-row {
            display: grid;
            grid-template-columns: 50px 1fr 1fr 1fr 40px;
            gap: 8px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .set-row-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .set-number {
            font-weight: 700;
            color: var(--gray-900);
        }

        .set-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            background: var(--gray-50);
            color: var(--gray-900);
        }

        [data-theme="dark"] .set-input {
            background: var(--gray-200);
            border-color: var(--gray-300);
        }

        .set-check {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .set-check.completed {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .add-set-btn {
            width: 100%;
            padding: 12px;
            background: var(--gray-100);
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            color: var(--gray-600);
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        /* Rest Timer */
        .rest-timer {
            background: var(--gray-900);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .rest-timer.active {
            display: block;
        }

        .rest-timer-time {
            font-size: 3rem;
            font-weight: 800;
        }

        .rest-timer-label {
            font-size: 0.875rem;
            opacity: 0.7;
        }

        .rest-timer-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 16px;
        }

        .rest-timer-btn {
            padding: 8px 20px;
            border-radius: 20px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        .rest-timer-btn.skip {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .rest-timer-btn.add {
            background: var(--brand-primary);
            color: white;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid var(--gray-200);
            z-index: 100;
        }

        [data-theme="dark"] .bottom-nav {
            background: #1e293b;
            border-color: #334155;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--gray-500);
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .bottom-nav-item.active {
            color: var(--brand-primary);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .empty-text {
            color: var(--gray-500);
            margin-bottom: 24px;
        }

        /* PR Badge */
        .pr-badge {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 8px;
        }

        @media (min-width: 768px) {
            .bottom-nav {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <a href="client-dashboard.html" class="nav-back">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <span class="nav-title">My Workouts</span>
        <button class="nav-action" onclick="showHistory()">History</button>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('today')">Today</button>
            <button class="tab" onclick="showTab('schedule')">Schedule</button>
            <button class="tab" onclick="showTab('history')">History</button>
            <button class="tab" onclick="showTab('exercises')">Exercises</button>
        </div>

        <!-- Today's Workout -->
        <div id="todayTab">
            <div class="workout-card" id="todayWorkout">
                <div class="workout-header">
                    <div>
                        <div class="workout-title" id="workoutName">Loading...</div>
                        <div class="workout-meta">
                            <span id="workoutDuration">0 min</span>
                            <span id="workoutExercises">0 exercises</span>
                        </div>
                    </div>
                </div>

                <div class="workout-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="workoutProgressBar" style="width: 0%"></div>
                    </div>
                    <span class="progress-text" id="workoutProgressText">0/0</span>
                </div>

                <div class="exercise-list" id="exerciseList">
                    <!-- Exercise items will be populated here -->
                </div>

                <button class="start-workout-btn" id="startWorkoutBtn" onclick="startWorkout()">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    Start Workout
                </button>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="noWorkoutState" style="display: none;">
                <div class="empty-icon">üí™</div>
                <div class="empty-title">No Workout Scheduled</div>
                <div class="empty-text">Your coach hasn't assigned a workout for today yet.</div>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div id="scheduleTab" style="display: none;">
            <div class="empty-state">
                <div class="empty-icon">üìÖ</div>
                <div class="empty-title">Your Workout Schedule</div>
                <div class="empty-text">Weekly workout schedule coming soon.</div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" style="display: none;">
            <div id="historyList">
                <!-- History items will be populated here -->
            </div>
            <div class="empty-state" id="noHistoryState" style="display: none;">
                <div class="empty-icon">üìä</div>
                <div class="empty-title">No Workout History</div>
                <div class="empty-text">Complete your first workout to see it here.</div>
            </div>
        </div>

        <!-- Exercises Tab -->
        <div id="exercisesTab" style="display: none;">
            <div class="empty-state">
                <div class="empty-icon">üèãÔ∏è</div>
                <div class="empty-title">Exercise Library</div>
                <div class="empty-text">Browse all exercises coming soon.</div>
            </div>
        </div>
    </div>

    <!-- Exercise Detail Modal -->
    <div class="modal-overlay" id="exerciseModal">
        <div class="exercise-modal">
            <div class="modal-handle"></div>

            <div class="modal-exercise-header">
                <img class="modal-thumbnail" id="modalThumbnail" src="" alt="">
                <div class="modal-exercise-info">
                    <h3 id="modalExerciseName">Exercise Name</h3>
                    <p id="modalExerciseDetails">3 sets √ó 10 reps</p>
                </div>
            </div>

            <!-- Rest Timer -->
            <div class="rest-timer" id="restTimer">
                <div class="rest-timer-label">Rest Time</div>
                <div class="rest-timer-time" id="restTimerDisplay">1:30</div>
                <div class="rest-timer-controls">
                    <button class="rest-timer-btn skip" onclick="skipRest()">Skip</button>
                    <button class="rest-timer-btn add" onclick="addRestTime(30)">+30s</button>
                </div>
            </div>

            <!-- Sets -->
            <div class="sets-container">
                <div class="set-row set-row-header">
                    <div>Set</div>
                    <div>Previous</div>
                    <div>Weight</div>
                    <div>Reps</div>
                    <div></div>
                </div>
                <div id="setsContainer">
                    <!-- Set rows will be populated here -->
                </div>
                <button class="add-set-btn" onclick="addSet()">+ Add Set</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="client-dashboard.html" class="bottom-nav-item">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            <span>Home</span>
        </a>
        <a href="client-diary.html" class="bottom-nav-item">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <span>Diary</span>
        </a>
        <a href="client-workouts.html" class="bottom-nav-item active">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
            </svg>
            <span>Workouts</span>
        </a>
        <a href="client-settings.html" class="bottom-nav-item">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            <span>Profile</span>
        </a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://qewqcjzlfqamqwbccapr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFld3Fjanpsb5FhbXF3YmNjYXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4NTA1ODcsImV4cCI6MjA2MDQyNjU4N30.api2M4E4Ah3V2WnxPRVDMq6yoGLPzjsB8qECLO7mK8U';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let currentClientId = null;
        let currentCoachId = null;
        let currentWorkout = null;
        let currentExerciseIndex = 0;
        let workoutInProgress = false;
        let restTimerInterval = null;
        let restTimeRemaining = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadTodaysWorkout();
            await loadWorkoutHistory();
        });

        // Check authentication
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                window.location.href = 'client-login.html';
                return;
            }

            // Get client info
            const { data: client } = await supabase
                .from('clients')
                .select('id, coach_id, client_name')
                .eq('user_id', session.user.id)
                .single();

            if (client) {
                currentClientId = client.id;
                currentCoachId = client.coach_id;
            }
        }

        // Tab switching
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all tabs
            document.getElementById('todayTab').style.display = 'none';
            document.getElementById('scheduleTab').style.display = 'none';
            document.getElementById('historyTab').style.display = 'none';
            document.getElementById('exercisesTab').style.display = 'none';

            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }

        // Load today's workout
        async function loadTodaysWorkout() {
            if (!currentClientId) return;

            try {
                // Get active workout assignment
                const response = await fetch(`/.netlify/functions/workout-assignments?clientId=${currentClientId}&activeOnly=true`);
                const data = await response.json();

                if (data.assignments && data.assignments.length > 0) {
                    const assignment = data.assignments[0];
                    currentWorkout = assignment.workout_data;

                    document.getElementById('workoutName').textContent = assignment.name || 'Today\'s Workout';
                    renderExerciseList(currentWorkout);
                    document.getElementById('todayWorkout').style.display = 'block';
                    document.getElementById('noWorkoutState').style.display = 'none';
                } else {
                    document.getElementById('todayWorkout').style.display = 'none';
                    document.getElementById('noWorkoutState').style.display = 'block';
                }
            } catch (err) {
                console.error('Error loading workout:', err);
                document.getElementById('todayWorkout').style.display = 'none';
                document.getElementById('noWorkoutState').style.display = 'block';
            }
        }

        // Render exercise list
        function renderExerciseList(workoutData) {
            const container = document.getElementById('exerciseList');
            const exercises = workoutData.exercises || [];

            if (exercises.length === 0) {
                container.innerHTML = '<div class="empty-text">No exercises in this workout</div>';
                return;
            }

            document.getElementById('workoutExercises').textContent = `${exercises.length} exercises`;

            container.innerHTML = exercises.map((exercise, index) => `
                <div class="exercise-item ${exercise.completed ? 'completed' : ''}" onclick="openExercise(${index})">
                    <img class="exercise-thumbnail" src="${exercise.thumbnailUrl || '/img/exercise-placeholder.png'}" alt="${exercise.name}">
                    <div class="exercise-info">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="exercise-details">${exercise.sets?.length || 3} sets √ó ${exercise.targetReps || 10} reps</div>
                        <div class="exercise-sets">
                            ${(exercise.sets || [{},{},{}]).map((set, i) => `
                                <div class="set-bubble ${set.completed ? 'completed' : ''}">${i + 1}</div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="exercise-check ${exercise.completed ? 'completed' : ''}">
                        ${exercise.completed ? '‚úì' : ''}
                    </div>
                </div>
            `).join('');

            updateProgress();
        }

        // Update workout progress
        function updateProgress() {
            if (!currentWorkout || !currentWorkout.exercises) return;

            const total = currentWorkout.exercises.length;
            const completed = currentWorkout.exercises.filter(e => e.completed).length;
            const percent = total > 0 ? (completed / total) * 100 : 0;

            document.getElementById('workoutProgressBar').style.width = `${percent}%`;
            document.getElementById('workoutProgressText').textContent = `${completed}/${total}`;
        }

        // Start workout
        function startWorkout() {
            workoutInProgress = true;
            document.getElementById('startWorkoutBtn').textContent = 'Workout In Progress';
            document.getElementById('startWorkoutBtn').disabled = true;

            // Open first exercise
            if (currentWorkout && currentWorkout.exercises && currentWorkout.exercises.length > 0) {
                openExercise(0);
            }
        }

        // Open exercise modal
        function openExercise(index) {
            currentExerciseIndex = index;
            const exercise = currentWorkout.exercises[index];

            document.getElementById('modalExerciseName').textContent = exercise.name;
            document.getElementById('modalExerciseDetails').textContent =
                `${exercise.sets?.length || 3} sets √ó ${exercise.targetReps || 10} reps`;
            document.getElementById('modalThumbnail').src = exercise.thumbnailUrl || '/img/exercise-placeholder.png';

            // Render sets
            renderSets(exercise);

            document.getElementById('exerciseModal').classList.add('active');
        }

        // Render sets in modal
        function renderSets(exercise) {
            const container = document.getElementById('setsContainer');
            const sets = exercise.sets || [{}, {}, {}];

            container.innerHTML = sets.map((set, index) => `
                <div class="set-row">
                    <div class="set-number">${index + 1}</div>
                    <div class="set-previous">${set.previous || '-'}</div>
                    <input type="number" class="set-input" placeholder="lbs"
                        value="${set.weight || ''}"
                        onchange="updateSet(${index}, 'weight', this.value)">
                    <input type="number" class="set-input" placeholder="reps"
                        value="${set.reps || ''}"
                        onchange="updateSet(${index}, 'reps', this.value)">
                    <button class="set-check ${set.completed ? 'completed' : ''}"
                        onclick="completeSet(${index})">
                        ${set.completed ? '‚úì' : ''}
                    </button>
                </div>
            `).join('');
        }

        // Update set data
        function updateSet(setIndex, field, value) {
            if (!currentWorkout.exercises[currentExerciseIndex].sets) {
                currentWorkout.exercises[currentExerciseIndex].sets = [{}, {}, {}];
            }
            currentWorkout.exercises[currentExerciseIndex].sets[setIndex][field] = value;
        }

        // Complete a set
        function completeSet(setIndex) {
            const exercise = currentWorkout.exercises[currentExerciseIndex];
            if (!exercise.sets) exercise.sets = [{}, {}, {}];

            exercise.sets[setIndex].completed = !exercise.sets[setIndex].completed;

            // Check if all sets completed
            const allSetsCompleted = exercise.sets.every(s => s.completed);
            if (allSetsCompleted) {
                exercise.completed = true;
                // Start rest timer
                startRestTimer(exercise.restSeconds || 90);
            }

            renderSets(exercise);
            renderExerciseList(currentWorkout);
        }

        // Add a set
        function addSet() {
            if (!currentWorkout.exercises[currentExerciseIndex].sets) {
                currentWorkout.exercises[currentExerciseIndex].sets = [{}, {}, {}];
            }
            currentWorkout.exercises[currentExerciseIndex].sets.push({});
            renderSets(currentWorkout.exercises[currentExerciseIndex]);
        }

        // Rest timer
        function startRestTimer(seconds) {
            restTimeRemaining = seconds;
            document.getElementById('restTimer').classList.add('active');
            updateRestTimerDisplay();

            restTimerInterval = setInterval(() => {
                restTimeRemaining--;
                updateRestTimerDisplay();

                if (restTimeRemaining <= 0) {
                    clearInterval(restTimerInterval);
                    document.getElementById('restTimer').classList.remove('active');
                    // Vibrate if supported
                    if (navigator.vibrate) navigator.vibrate(200);
                }
            }, 1000);
        }

        function updateRestTimerDisplay() {
            const mins = Math.floor(restTimeRemaining / 60);
            const secs = restTimeRemaining % 60;
            document.getElementById('restTimerDisplay').textContent =
                `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function skipRest() {
            clearInterval(restTimerInterval);
            document.getElementById('restTimer').classList.remove('active');
        }

        function addRestTime(seconds) {
            restTimeRemaining += seconds;
            updateRestTimerDisplay();
        }

        // Close modal
        document.getElementById('exerciseModal').addEventListener('click', (e) => {
            if (e.target.id === 'exerciseModal') {
                document.getElementById('exerciseModal').classList.remove('active');
            }
        });

        // Load workout history
        async function loadWorkoutHistory() {
            if (!currentClientId) return;

            try {
                const response = await fetch(`/.netlify/functions/workout-logs?clientId=${currentClientId}&limit=20`);
                const data = await response.json();

                const container = document.getElementById('historyList');
                const workouts = data.workouts || [];

                if (workouts.length === 0) {
                    container.style.display = 'none';
                    document.getElementById('noHistoryState').style.display = 'block';
                    return;
                }

                container.innerHTML = workouts.map(workout => `
                    <div class="history-item">
                        <div class="history-date">${formatDate(workout.workout_date)}</div>
                        <div class="history-name">${workout.workout_name || 'Workout'}</div>
                        <div class="history-stats">
                            <span>${workout.duration_minutes || 0} min</span>
                            <span>${workout.total_sets || 0} sets</span>
                            <span>${formatVolume(workout.total_volume)} lbs</span>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Error loading history:', err);
            }
        }

        // Helper functions
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (dateStr === today.toISOString().split('T')[0]) return 'Today';
            if (dateStr === yesterday.toISOString().split('T')[0]) return 'Yesterday';

            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        function formatVolume(vol) {
            if (!vol) return '0';
            if (vol >= 1000) return (vol / 1000).toFixed(1) + 'k';
            return Math.round(vol).toLocaleString();
        }

        function showHistory() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.tab:nth-child(3)').classList.add('active');
            showTab('history');
        }
    </script>
    <!-- PWA Install Prompt -->
    <script src="/js/pwa-install-prompt.js"></script>
</body>
</html>
